# Comparing `tmp/skypilot_nightly-1.0.0.dev20240504.tar.gz` & `tmp/skypilot_nightly-1.0.0.dev20240505.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "skypilot_nightly-1.0.0.dev20240504.tar", last modified: Sat May  4 10:38:00 2024, max compression
+gzip compressed data, was "skypilot_nightly-1.0.0.dev20240505.tar", last modified: Sun May  5 10:38:13 2024, max compression
```

## Comparing `skypilot_nightly-1.0.0.dev20240504.tar` & `skypilot_nightly-1.0.0.dev20240505.tar`

### file list

```diff
@@ -1,338 +1,338 @@
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-04 10:38:00.106641 skypilot_nightly-1.0.0.dev20240504/
--rw-r--r--   0 runner    (1001) docker     (127)    12170 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/LICENSE
--rw-r--r--   0 runner    (1001) docker     (127)      718 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/MANIFEST.in
--rw-r--r--   0 runner    (1001) docker     (127)    18140 2024-05-04 10:38:00.106641 skypilot_nightly-1.0.0.dev20240504/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (127)    12079 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/README.md
--rw-r--r--   0 runner    (1001) docker     (127)      640 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/pyproject.toml
--rw-r--r--   0 runner    (1001) docker     (127)       38 2024-05-04 10:38:00.106641 skypilot_nightly-1.0.0.dev20240504/setup.cfg
--rw-r--r--   0 runner    (1001) docker     (127)    12055 2024-05-04 10:37:57.000000 skypilot_nightly-1.0.0.dev20240504/setup.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-04 10:38:00.046641 skypilot_nightly-1.0.0.dev20240504/sky/
--rw-r--r--   0 runner    (1001) docker     (127)     5588 2024-05-04 10:37:59.000000 skypilot_nightly-1.0.0.dev20240504/sky/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-04 10:38:00.050641 skypilot_nightly-1.0.0.dev20240504/sky/adaptors/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/adaptors/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     6863 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/adaptors/aws.py
--rw-r--r--   0 runner    (1001) docker     (127)     2291 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/adaptors/azure.py
--rw-r--r--   0 runner    (1001) docker     (127)     7542 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/adaptors/cloudflare.py
--rw-r--r--   0 runner    (1001) docker     (127)     2354 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/adaptors/common.py
--rw-r--r--   0 runner    (1001) docker     (127)      239 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/adaptors/cudo.py
--rw-r--r--   0 runner    (1001) docker     (127)      468 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/adaptors/docker.py
--rw-r--r--   0 runner    (1001) docker     (127)     3097 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/adaptors/gcp.py
--rw-r--r--   0 runner    (1001) docker     (127)     4906 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/adaptors/ibm.py
--rw-r--r--   0 runner    (1001) docker     (127)     3875 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/adaptors/kubernetes.py
--rw-r--r--   0 runner    (1001) docker     (127)     1480 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/adaptors/oci.py
--rw-r--r--   0 runner    (1001) docker     (127)      225 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/adaptors/runpod.py
--rw-r--r--   0 runner    (1001) docker     (127)     2129 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/adaptors/vsphere.py
--rw-r--r--   0 runner    (1001) docker     (127)    21410 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/authentication.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-04 10:38:00.050641 skypilot_nightly-1.0.0.dev20240504/sky/backends/
--rw-r--r--   0 runner    (1001) docker     (127)      536 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/backends/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     5932 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/backends/backend.py
--rw-r--r--   0 runner    (1001) docker     (127)   119254 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/backends/backend_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)   223223 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/backends/cloud_vm_ray_backend.py
--rw-r--r--   0 runner    (1001) docker     (127)     8358 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/backends/docker_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    16741 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/backends/local_docker_backend.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-04 10:38:00.050641 skypilot_nightly-1.0.0.dev20240504/sky/backends/monkey_patches/
--rw-r--r--   0 runner    (1001) docker     (127)     3450 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/backends/monkey_patches/monkey_patch_ray_up.py
--rw-r--r--   0 runner    (1001) docker     (127)     7297 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/backends/wheel_utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-04 10:38:00.050641 skypilot_nightly-1.0.0.dev20240504/sky/benchmark/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/benchmark/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     8723 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/benchmark/benchmark_state.py
--rw-r--r--   0 runner    (1001) docker     (127)    26440 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/benchmark/benchmark_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     5908 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/check.py
--rw-r--r--   0 runner    (1001) docker     (127)   186846 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/cli.py
--rw-r--r--   0 runner    (1001) docker     (127)    11806 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/cloud_stores.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-04 10:38:00.054641 skypilot_nightly-1.0.0.dev20240504/sky/clouds/
--rw-r--r--   0 runner    (1001) docker     (127)     1310 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/clouds/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    44034 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/clouds/aws.py
--rw-r--r--   0 runner    (1001) docker     (127)    31006 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/clouds/azure.py
--rw-r--r--   0 runner    (1001) docker     (127)    31670 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/clouds/cloud.py
--rw-r--r--   0 runner    (1001) docker     (127)      955 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/clouds/cloud_registry.py
--rw-r--r--   0 runner    (1001) docker     (127)    12036 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/clouds/cudo.py
--rw-r--r--   0 runner    (1001) docker     (127)    12647 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/clouds/fluidstack.py
--rw-r--r--   0 runner    (1001) docker     (127)    47961 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/clouds/gcp.py
--rw-r--r--   0 runner    (1001) docker     (127)    21044 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/clouds/ibm.py
--rw-r--r--   0 runner    (1001) docker     (127)    18717 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/clouds/kubernetes.py
--rw-r--r--   0 runner    (1001) docker     (127)    12157 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/clouds/lambda_cloud.py
--rw-r--r--   0 runner    (1001) docker     (127)    25299 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/clouds/oci.py
--rw-r--r--   0 runner    (1001) docker     (127)    10561 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/clouds/paperspace.py
--rw-r--r--   0 runner    (1001) docker     (127)    11166 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/clouds/runpod.py
--rw-r--r--   0 runner    (1001) docker     (127)    15546 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/clouds/scp.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-04 10:38:00.058641 skypilot_nightly-1.0.0.dev20240504/sky/clouds/service_catalog/
--rw-r--r--   0 runner    (1001) docker     (127)    12771 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/clouds/service_catalog/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    12550 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/clouds/service_catalog/aws_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     7289 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/clouds/service_catalog/azure_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)    26837 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/clouds/service_catalog/common.py
--rw-r--r--   0 runner    (1001) docker     (127)     1793 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/clouds/service_catalog/config.py
--rw-r--r--   0 runner    (1001) docker     (127)      411 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/clouds/service_catalog/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)     4335 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/clouds/service_catalog/cudo_catalog.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-04 10:38:00.058641 skypilot_nightly-1.0.0.dev20240504/sky/clouds/service_catalog/data_fetchers/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/clouds/service_catalog/data_fetchers/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    22424 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/clouds/service_catalog/data_fetchers/fetch_aws.py
--rw-r--r--   0 runner    (1001) docker     (127)    11477 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/clouds/service_catalog/data_fetchers/fetch_azure.py
--rw-r--r--   0 runner    (1001) docker     (127)     5072 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/clouds/service_catalog/data_fetchers/fetch_cudo.py
--rw-r--r--   0 runner    (1001) docker     (127)     3895 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/clouds/service_catalog/data_fetchers/fetch_fluidstack.py
--rw-r--r--   0 runner    (1001) docker     (127)    22243 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/clouds/service_catalog/data_fetchers/fetch_gcp.py
--rw-r--r--   0 runner    (1001) docker     (127)     4297 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/clouds/service_catalog/data_fetchers/fetch_lambda_cloud.py
--rw-r--r--   0 runner    (1001) docker     (127)    21462 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/clouds/service_catalog/data_fetchers/fetch_vsphere.py
--rw-r--r--   0 runner    (1001) docker     (127)     5038 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/clouds/service_catalog/fluidstack_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)    24120 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/clouds/service_catalog/gcp_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     4472 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/clouds/service_catalog/ibm_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     4240 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/clouds/service_catalog/kubernetes_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     5082 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/clouds/service_catalog/lambda_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     7542 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/clouds/service_catalog/oci_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     3768 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/clouds/service_catalog/paperspace_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     4184 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/clouds/service_catalog/runpod_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     5174 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/clouds/service_catalog/scp_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     4391 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/clouds/service_catalog/vsphere_catalog.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-04 10:38:00.058641 skypilot_nightly-1.0.0.dev20240504/sky/clouds/utils/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/clouds/utils/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     6968 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/clouds/utils/gcp_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     9991 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/clouds/utils/lambda_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     4482 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/clouds/utils/oci_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    15781 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/clouds/utils/scp_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    11969 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/clouds/vsphere.py
--rw-r--r--   0 runner    (1001) docker     (127)    32991 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/core.py
--rw-r--r--   0 runner    (1001) docker     (127)     2529 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/dag.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-04 10:38:00.058641 skypilot_nightly-1.0.0.dev20240504/sky/data/
--rw-r--r--   0 runner    (1001) docker     (127)      184 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/data/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     7346 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/data/data_transfer.py
--rw-r--r--   0 runner    (1001) docker     (127)    21664 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/data/data_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     8226 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/data/mounting_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)   118872 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/data/storage.py
--rw-r--r--   0 runner    (1001) docker     (127)     6867 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/data/storage_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     8213 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/exceptions.py
--rw-r--r--   0 runner    (1001) docker     (127)    24916 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/execution.py
--rw-r--r--   0 runner    (1001) docker     (127)    28681 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/global_user_state.py
--rw-r--r--   0 runner    (1001) docker     (127)    54101 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/optimizer.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-04 10:38:00.062641 skypilot_nightly-1.0.0.dev20240504/sky/provision/
--rw-r--r--   0 runner    (1001) docker     (127)     4907 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/provision/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-04 10:38:00.062641 skypilot_nightly-1.0.0.dev20240504/sky/provision/aws/
--rw-r--r--   0 runner    (1001) docker     (127)      782 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/provision/aws/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    22092 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/provision/aws/config.py
--rw-r--r--   0 runner    (1001) docker     (127)    36603 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/provision/aws/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)     3238 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/provision/aws/utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-04 10:38:00.062641 skypilot_nightly-1.0.0.dev20240504/sky/provision/azure/
--rw-r--r--   0 runner    (1001) docker     (127)      199 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/provision/azure/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     4398 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/provision/azure/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)     8561 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/provision/common.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-04 10:38:00.062641 skypilot_nightly-1.0.0.dev20240504/sky/provision/cudo/
--rw-r--r--   0 runner    (1001) docker     (127)      676 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/provision/cudo/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)      327 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/provision/cudo/config.py
--rw-r--r--   0 runner    (1001) docker     (127)      696 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/provision/cudo/cudo_machine_type.py
--rw-r--r--   0 runner    (1001) docker     (127)     4046 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/provision/cudo/cudo_wrapper.py
--rw-r--r--   0 runner    (1001) docker     (127)     8202 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/provision/cudo/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)    16782 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/provision/docker_utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-04 10:38:00.062641 skypilot_nightly-1.0.0.dev20240504/sky/provision/fluidstack/
--rw-r--r--   0 runner    (1001) docker     (127)      592 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/provision/fluidstack/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)      326 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/provision/fluidstack/config.py
--rw-r--r--   0 runner    (1001) docker     (127)     8262 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/provision/fluidstack/fluidstack_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    14870 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/provision/fluidstack/instance.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-04 10:38:00.062641 skypilot_nightly-1.0.0.dev20240504/sky/provision/gcp/
--rw-r--r--   0 runner    (1001) docker     (127)      579 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/provision/gcp/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    32964 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/provision/gcp/config.py
--rw-r--r--   0 runner    (1001) docker     (127)     7234 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/provision/gcp/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)    24482 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/provision/gcp/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)    59069 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/provision/gcp/instance_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    22258 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/provision/instance_setup.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-04 10:38:00.066641 skypilot_nightly-1.0.0.dev20240504/sky/provision/kubernetes/
--rw-r--r--   0 runner    (1001) docker     (127)      653 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/provision/kubernetes/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    17388 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/provision/kubernetes/config.py
--rw-r--r--   0 runner    (1001) docker     (127)    32841 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/provision/kubernetes/instance.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-04 10:38:00.066641 skypilot_nightly-1.0.0.dev20240504/sky/provision/kubernetes/manifests/
--rw-r--r--   0 runner    (1001) docker     (127)      229 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/provision/kubernetes/manifests/smarter-device-manager-configmap.yaml
--rw-r--r--   0 runner    (1001) docker     (127)     1939 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/provision/kubernetes/manifests/smarter-device-manager-daemonset.yaml
--rw-r--r--   0 runner    (1001) docker     (127)    10501 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/provision/kubernetes/network.py
--rw-r--r--   0 runner    (1001) docker     (127)     9035 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/provision/kubernetes/network_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    55170 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/provision/kubernetes/utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     2103 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/provision/logging.py
--rw-r--r--   0 runner    (1001) docker     (127)     4013 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/provision/metadata_utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-04 10:38:00.066641 skypilot_nightly-1.0.0.dev20240504/sky/provision/paperspace/
--rw-r--r--   0 runner    (1001) docker     (127)      598 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/provision/paperspace/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     1541 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/provision/paperspace/config.py
--rw-r--r--   0 runner    (1001) docker     (127)      802 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/provision/paperspace/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)    11985 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/provision/paperspace/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)     9428 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/provision/paperspace/utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    25255 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/provision/provisioner.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-04 10:38:00.066641 skypilot_nightly-1.0.0.dev20240504/sky/provision/runpod/
--rw-r--r--   0 runner    (1001) docker     (127)      502 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/provision/runpod/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)      321 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/provision/runpod/config.py
--rw-r--r--   0 runner    (1001) docker     (127)     7849 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/provision/runpod/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)     4648 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/provision/runpod/utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-04 10:38:00.066641 skypilot_nightly-1.0.0.dev20240504/sky/provision/vsphere/
--rw-r--r--   0 runner    (1001) docker     (127)      788 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/provision/vsphere/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-04 10:38:00.070641 skypilot_nightly-1.0.0.dev20240504/sky/provision/vsphere/common/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/provision/vsphere/common/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     4167 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/provision/vsphere/common/cls_api_client.py
--rw-r--r--   0 runner    (1001) docker     (127)    14096 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/provision/vsphere/common/cls_api_helper.py
--rw-r--r--   0 runner    (1001) docker     (127)      481 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/provision/vsphere/common/custom_script.py
--rw-r--r--   0 runner    (1001) docker     (127)      303 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/provision/vsphere/common/id_generator.py
--rw-r--r--   0 runner    (1001) docker     (127)      914 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/provision/vsphere/common/metadata_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     1817 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/provision/vsphere/common/service_manager.py
--rw-r--r--   0 runner    (1001) docker     (127)      544 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/provision/vsphere/common/service_manager_factory.py
--rw-r--r--   0 runner    (1001) docker     (127)      795 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/provision/vsphere/common/ssl_helper.py
--rw-r--r--   0 runner    (1001) docker     (127)     2932 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/provision/vsphere/common/vapiconnect.py
--rw-r--r--   0 runner    (1001) docker     (127)    17877 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/provision/vsphere/common/vim_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)      504 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/provision/vsphere/config.py
--rw-r--r--   0 runner    (1001) docker     (127)    24476 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/provision/vsphere/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)    15151 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/provision/vsphere/vsphere_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    64485 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/resources.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-04 10:38:00.070641 skypilot_nightly-1.0.0.dev20240504/sky/serve/
--rw-r--r--   0 runner    (1001) docker     (127)     1661 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/serve/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    30137 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/serve/autoscalers.py
--rw-r--r--   0 runner    (1001) docker     (127)     3732 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/serve/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)     7571 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/serve/controller.py
--rw-r--r--   0 runner    (1001) docker     (127)    28185 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/serve/core.py
--rw-r--r--   0 runner    (1001) docker     (127)     4689 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/serve/load_balancer.py
--rw-r--r--   0 runner    (1001) docker     (127)     2047 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/serve/load_balancing_policies.py
--rw-r--r--   0 runner    (1001) docker     (127)    55738 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/serve/replica_managers.py
--rw-r--r--   0 runner    (1001) docker     (127)    18830 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/serve/serve_state.py
--rw-r--r--   0 runner    (1001) docker     (127)    36837 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/serve/serve_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    10931 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/serve/service.py
--rw-r--r--   0 runner    (1001) docker     (127)    13803 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/serve/service_spec.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-04 10:38:00.070641 skypilot_nightly-1.0.0.dev20240504/sky/setup_files/
--rw-r--r--   0 runner    (1001) docker     (127)      718 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/setup_files/MANIFEST.in
--rw-r--r--   0 runner    (1001) docker     (127)    12055 2024-05-04 10:37:57.000000 skypilot_nightly-1.0.0.dev20240504/sky/setup_files/setup.py
--rw-r--r--   0 runner    (1001) docker     (127)     4000 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/sky_logging.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-04 10:38:00.074641 skypilot_nightly-1.0.0.dev20240504/sky/skylet/
--rw-r--r--   0 runner    (1001) docker     (127)    12381 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/skylet/LICENSE
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/skylet/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     1963 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/skylet/attempt_skylet.py
--rw-r--r--   0 runner    (1001) docker     (127)     4293 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/skylet/autostop_lib.py
--rw-r--r--   0 runner    (1001) docker     (127)     1887 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/skylet/configs.py
--rw-r--r--   0 runner    (1001) docker     (127)     9964 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/skylet/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)    11564 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/skylet/events.py
--rw-r--r--   0 runner    (1001) docker     (127)    35167 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/skylet/job_lib.py
--rw-r--r--   0 runner    (1001) docker     (127)    18788 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/skylet/log_lib.py
--rw-r--r--   0 runner    (1001) docker     (127)     4292 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/skylet/log_lib.pyi
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-04 10:38:00.074641 skypilot_nightly-1.0.0.dev20240504/sky/skylet/providers/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/skylet/providers/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-04 10:38:00.074641 skypilot_nightly-1.0.0.dev20240504/sky/skylet/providers/azure/
--rw-r--r--   0 runner    (1001) docker     (127)       97 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/skylet/providers/azure/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     4344 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/skylet/providers/azure/azure-config-template.json
--rw-r--r--   0 runner    (1001) docker     (127)    10901 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/skylet/providers/azure/azure-vm-template.json
--rw-r--r--   0 runner    (1001) docker     (127)     6203 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/skylet/providers/azure/config.py
--rw-r--r--   0 runner    (1001) docker     (127)    18812 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/skylet/providers/azure/node_provider.py
--rw-r--r--   0 runner    (1001) docker     (127)    16355 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/skylet/providers/command_runner.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-04 10:38:00.074641 skypilot_nightly-1.0.0.dev20240504/sky/skylet/providers/ibm/
--rw-r--r--   0 runner    (1001) docker     (127)       94 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/skylet/providers/ibm/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    38280 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/skylet/providers/ibm/node_provider.py
--rw-r--r--   0 runner    (1001) docker     (127)     1292 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/skylet/providers/ibm/utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    34630 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/skylet/providers/ibm/vpc_provider.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-04 10:38:00.074641 skypilot_nightly-1.0.0.dev20240504/sky/skylet/providers/lambda_cloud/
--rw-r--r--   0 runner    (1001) docker     (127)      112 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/skylet/providers/lambda_cloud/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    13992 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/skylet/providers/lambda_cloud/node_provider.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-04 10:38:00.078641 skypilot_nightly-1.0.0.dev20240504/sky/skylet/providers/oci/
--rw-r--r--   0 runner    (1001) docker     (127)       91 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/skylet/providers/oci/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    20492 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/skylet/providers/oci/node_provider.py
--rw-r--r--   0 runner    (1001) docker     (127)    17202 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/skylet/providers/oci/query_helper.py
--rw-r--r--   0 runner    (1001) docker     (127)      508 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/skylet/providers/oci/utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-04 10:38:00.078641 skypilot_nightly-1.0.0.dev20240504/sky/skylet/providers/scp/
--rw-r--r--   0 runner    (1001) docker     (127)       91 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/skylet/providers/scp/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     4683 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/skylet/providers/scp/config.py
--rw-r--r--   0 runner    (1001) docker     (127)    22411 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/skylet/providers/scp/node_provider.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-04 10:38:00.078641 skypilot_nightly-1.0.0.dev20240504/sky/skylet/ray_patches/
--rw-r--r--   0 runner    (1001) docker     (127)     2761 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/skylet/ray_patches/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)      291 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/skylet/ray_patches/autoscaler.py.patch
--rw-r--r--   0 runner    (1001) docker     (127)      349 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/skylet/ray_patches/cli.py.patch
--rw-r--r--   0 runner    (1001) docker     (127)      224 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/skylet/ray_patches/command_runner.py.patch
--rw-r--r--   0 runner    (1001) docker     (127)      531 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/skylet/ray_patches/log_monitor.py.patch
--rw-r--r--   0 runner    (1001) docker     (127)      658 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/skylet/ray_patches/resource_demand_scheduler.py.patch
--rw-r--r--   0 runner    (1001) docker     (127)      289 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/skylet/ray_patches/updater.py.patch
--rw-r--r--   0 runner    (1001) docker     (127)      565 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/skylet/ray_patches/worker.py.patch
--rw-r--r--   0 runner    (1001) docker     (127)     1144 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/skylet/skylet.py
--rw-r--r--   0 runner    (1001) docker     (127)     1348 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/skylet/subprocess_daemon.py
--rw-r--r--   0 runner    (1001) docker     (127)     5586 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/skypilot_config.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-04 10:38:00.078641 skypilot_nightly-1.0.0.dev20240504/sky/spot/
--rw-r--r--   0 runner    (1001) docker     (127)     1561 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/spot/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     1117 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/spot/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)    25830 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/spot/controller.py
--rw-r--r--   0 runner    (1001) docker     (127)    13078 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/spot/core.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-04 10:38:00.078641 skypilot_nightly-1.0.0.dev20240504/sky/spot/dashboard/
--rw-r--r--   0 runner    (1001) docker     (127)     2294 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/spot/dashboard/dashboard.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-04 10:38:00.078641 skypilot_nightly-1.0.0.dev20240504/sky/spot/dashboard/static/
--rw-r--r--   0 runner    (1001) docker     (127)    15086 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/spot/dashboard/static/favicon.ico
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-04 10:38:00.082641 skypilot_nightly-1.0.0.dev20240504/sky/spot/dashboard/templates/
--rw-r--r--   0 runner    (1001) docker     (127)     6247 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/spot/dashboard/templates/index.html
--rw-r--r--   0 runner    (1001) docker     (127)    25656 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/spot/recovery_strategy.py
--rw-r--r--   0 runner    (1001) docker     (127)    22487 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/spot/spot_state.py
--rw-r--r--   0 runner    (1001) docker     (127)    31559 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/spot/spot_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     1457 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/status_lib.py
--rw-r--r--   0 runner    (1001) docker     (127)    47239 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/task.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-04 10:38:00.082641 skypilot_nightly-1.0.0.dev20240504/sky/templates/
--rw-r--r--   0 runner    (1001) docker     (127)     7320 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/templates/aws-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     9037 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/templates/azure-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     3435 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/templates/cudo-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     3465 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/templates/fluidstack-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     8880 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/templates/gcp-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     6607 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/templates/ibm-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     1095 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/templates/kubernetes-ingress.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)      376 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/templates/kubernetes-loadbalancer.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     2547 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/templates/kubernetes-port-forward-proxy-command.sh.j2
--rw-r--r--   0 runner    (1001) docker     (127)    11034 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/templates/kubernetes-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     2747 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/templates/kubernetes-ssh-jump.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     5676 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/templates/lambda-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     1185 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/templates/local-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     6970 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/templates/oci-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     3898 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/templates/paperspace-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     3496 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/templates/runpod-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     5546 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/templates/scp-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     1148 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/templates/sky-serve-controller.yaml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     1218 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/templates/spot-controller.yaml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     3474 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/templates/vsphere-ray.yml.j2
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-04 10:38:00.086641 skypilot_nightly-1.0.0.dev20240504/sky/usage/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/usage/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)      590 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/usage/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)    17601 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/usage/usage_lib.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-04 10:38:00.086641 skypilot_nightly-1.0.0.dev20240504/sky/utils/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/utils/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     3798 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/utils/accelerator_registry.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-04 10:38:00.086641 skypilot_nightly-1.0.0.dev20240504/sky/utils/cli_utils/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/utils/cli_utils/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    11032 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/utils/cli_utils/status_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)      849 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/utils/cluster_yaml_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    18805 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/utils/command_runner.py
--rw-r--r--   0 runner    (1001) docker     (127)     3485 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/utils/command_runner.pyi
--rw-r--r--   0 runner    (1001) docker     (127)    22547 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/utils/common_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    28619 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/utils/controller_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     6260 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/utils/dag_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     2786 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/utils/db_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)      852 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/utils/env_options.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-04 10:38:00.090641 skypilot_nightly-1.0.0.dev20240504/sky/utils/kubernetes/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/utils/kubernetes/__init__.py
--rwxr-xr-x   0 runner    (1001) docker     (127)     9667 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/utils/kubernetes/create_cluster.sh
--rwxr-xr-x   0 runner    (1001) docker     (127)      927 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/utils/kubernetes/delete_cluster.sh
--rw-r--r--   0 runner    (1001) docker     (127)     3187 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/utils/kubernetes/generate_kind_config.py
--rw-r--r--   0 runner    (1001) docker     (127)     6960 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/utils/kubernetes/gpu_labeler.py
--rw-r--r--   0 runner    (1001) docker     (127)     1186 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/utils/kubernetes/k8s_gpu_labeler_job.yaml
--rw-r--r--   0 runner    (1001) docker     (127)     3812 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/utils/kubernetes/k8s_gpu_labeler_setup.yaml
--rw-r--r--   0 runner    (1001) docker     (127)     6560 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/utils/kubernetes/ssh_jump_lifecycle_manager.py
--rw-r--r--   0 runner    (1001) docker     (127)     1193 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/utils/kubernetes_enums.py
--rw-r--r--   0 runner    (1001) docker     (127)     8139 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/utils/log_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     5540 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/utils/resources_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     1581 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/utils/rich_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    20167 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/utils/schemas.py
--rw-r--r--   0 runner    (1001) docker     (127)     6509 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/utils/subprocess_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     3936 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/utils/timeline.py
--rw-r--r--   0 runner    (1001) docker     (127)     3264 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/utils/ux_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)      701 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/sky/utils/validator.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-04 10:38:00.094641 skypilot_nightly-1.0.0.dev20240504/skypilot_nightly.egg-info/
--rw-r--r--   0 runner    (1001) docker     (127)    18140 2024-05-04 10:38:00.000000 skypilot_nightly-1.0.0.dev20240504/skypilot_nightly.egg-info/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (127)     9308 2024-05-04 10:38:00.000000 skypilot_nightly-1.0.0.dev20240504/skypilot_nightly.egg-info/SOURCES.txt
--rw-r--r--   0 runner    (1001) docker     (127)        1 2024-05-04 10:38:00.000000 skypilot_nightly-1.0.0.dev20240504/skypilot_nightly.egg-info/dependency_links.txt
--rw-r--r--   0 runner    (1001) docker     (127)       36 2024-05-04 10:38:00.000000 skypilot_nightly-1.0.0.dev20240504/skypilot_nightly.egg-info/entry_points.txt
--rw-r--r--   0 runner    (1001) docker     (127)     2270 2024-05-04 10:38:00.000000 skypilot_nightly-1.0.0.dev20240504/skypilot_nightly.egg-info/requires.txt
--rw-r--r--   0 runner    (1001) docker     (127)        4 2024-05-04 10:38:00.000000 skypilot_nightly-1.0.0.dev20240504/skypilot_nightly.egg-info/top_level.txt
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-04 10:38:00.094641 skypilot_nightly-1.0.0.dev20240504/tests/
--rw-r--r--   0 runner    (1001) docker     (127)      171 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/tests/test_api.py
--rw-r--r--   0 runner    (1001) docker     (127)     3618 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/tests/test_cli.py
--rw-r--r--   0 runner    (1001) docker     (127)     9592 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/tests/test_config.py
--rw-r--r--   0 runner    (1001) docker     (127)      267 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/tests/test_global_user_state.py
--rw-r--r--   0 runner    (1001) docker     (127)     8789 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/tests/test_jobs.py
--rw-r--r--   0 runner    (1001) docker     (127)     3718 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/tests/test_list_accelerators.py
--rw-r--r--   0 runner    (1001) docker     (127)    27759 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/tests/test_optimizer_dryruns.py
--rw-r--r--   0 runner    (1001) docker     (127)     6996 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/tests/test_optimizer_random_dag.py
--rw-r--r--   0 runner    (1001) docker     (127)     1102 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/tests/test_serve_autoscaler.py
--rw-r--r--   0 runner    (1001) docker     (127)   215427 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/tests/test_smoke.py
--rw-r--r--   0 runner    (1001) docker     (127)    17581 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/tests/test_spot_serve.py
--rw-r--r--   0 runner    (1001) docker     (127)     4048 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/tests/test_storage.py
--rw-r--r--   0 runner    (1001) docker     (127)     1070 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/tests/test_wheels.py
--rw-r--r--   0 runner    (1001) docker     (127)     3915 2024-05-04 10:37:55.000000 skypilot_nightly-1.0.0.dev20240504/tests/test_yaml_parser.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 10:38:13.693166 skypilot_nightly-1.0.0.dev20240505/
+-rw-r--r--   0 runner    (1001) docker     (127)    12170 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/LICENSE
+-rw-r--r--   0 runner    (1001) docker     (127)      718 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/MANIFEST.in
+-rw-r--r--   0 runner    (1001) docker     (127)    18140 2024-05-05 10:38:13.693166 skypilot_nightly-1.0.0.dev20240505/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (127)    12079 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/README.md
+-rw-r--r--   0 runner    (1001) docker     (127)      640 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/pyproject.toml
+-rw-r--r--   0 runner    (1001) docker     (127)       38 2024-05-05 10:38:13.693166 skypilot_nightly-1.0.0.dev20240505/setup.cfg
+-rw-r--r--   0 runner    (1001) docker     (127)    12055 2024-05-05 10:38:10.000000 skypilot_nightly-1.0.0.dev20240505/setup.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 10:38:13.629166 skypilot_nightly-1.0.0.dev20240505/sky/
+-rw-r--r--   0 runner    (1001) docker     (127)     5588 2024-05-05 10:38:13.000000 skypilot_nightly-1.0.0.dev20240505/sky/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 10:38:13.629166 skypilot_nightly-1.0.0.dev20240505/sky/adaptors/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/adaptors/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6863 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/adaptors/aws.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2291 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/adaptors/azure.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7542 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/adaptors/cloudflare.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2354 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/adaptors/common.py
+-rw-r--r--   0 runner    (1001) docker     (127)      239 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/adaptors/cudo.py
+-rw-r--r--   0 runner    (1001) docker     (127)      468 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/adaptors/docker.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3097 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/adaptors/gcp.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4906 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/adaptors/ibm.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3875 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/adaptors/kubernetes.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1480 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/adaptors/oci.py
+-rw-r--r--   0 runner    (1001) docker     (127)      225 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/adaptors/runpod.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2129 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/adaptors/vsphere.py
+-rw-r--r--   0 runner    (1001) docker     (127)    21410 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/authentication.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 10:38:13.633166 skypilot_nightly-1.0.0.dev20240505/sky/backends/
+-rw-r--r--   0 runner    (1001) docker     (127)      536 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/backends/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5932 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/backends/backend.py
+-rw-r--r--   0 runner    (1001) docker     (127)   119850 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/backends/backend_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)   223596 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/backends/cloud_vm_ray_backend.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8358 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/backends/docker_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    16741 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/backends/local_docker_backend.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 10:38:13.633166 skypilot_nightly-1.0.0.dev20240505/sky/backends/monkey_patches/
+-rw-r--r--   0 runner    (1001) docker     (127)     3450 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/backends/monkey_patches/monkey_patch_ray_up.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7297 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/backends/wheel_utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 10:38:13.633166 skypilot_nightly-1.0.0.dev20240505/sky/benchmark/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/benchmark/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8723 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/benchmark/benchmark_state.py
+-rw-r--r--   0 runner    (1001) docker     (127)    26440 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/benchmark/benchmark_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5908 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/check.py
+-rw-r--r--   0 runner    (1001) docker     (127)   191563 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/cli.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11806 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/cloud_stores.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 10:38:13.637166 skypilot_nightly-1.0.0.dev20240505/sky/clouds/
+-rw-r--r--   0 runner    (1001) docker     (127)     1310 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/clouds/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    44034 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/clouds/aws.py
+-rw-r--r--   0 runner    (1001) docker     (127)    31006 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/clouds/azure.py
+-rw-r--r--   0 runner    (1001) docker     (127)    31745 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/clouds/cloud.py
+-rw-r--r--   0 runner    (1001) docker     (127)      955 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/clouds/cloud_registry.py
+-rw-r--r--   0 runner    (1001) docker     (127)    12036 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/clouds/cudo.py
+-rw-r--r--   0 runner    (1001) docker     (127)    12647 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/clouds/fluidstack.py
+-rw-r--r--   0 runner    (1001) docker     (127)    48019 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/clouds/gcp.py
+-rw-r--r--   0 runner    (1001) docker     (127)    21044 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/clouds/ibm.py
+-rw-r--r--   0 runner    (1001) docker     (127)    18717 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/clouds/kubernetes.py
+-rw-r--r--   0 runner    (1001) docker     (127)    12157 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/clouds/lambda_cloud.py
+-rw-r--r--   0 runner    (1001) docker     (127)    25299 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/clouds/oci.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10561 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/clouds/paperspace.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11166 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/clouds/runpod.py
+-rw-r--r--   0 runner    (1001) docker     (127)    15546 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/clouds/scp.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 10:38:13.637166 skypilot_nightly-1.0.0.dev20240505/sky/clouds/service_catalog/
+-rw-r--r--   0 runner    (1001) docker     (127)    12771 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/clouds/service_catalog/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    12550 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/clouds/service_catalog/aws_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7289 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/clouds/service_catalog/azure_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)    26837 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/clouds/service_catalog/common.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1793 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/clouds/service_catalog/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)      411 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/clouds/service_catalog/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4335 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/clouds/service_catalog/cudo_catalog.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 10:38:13.641166 skypilot_nightly-1.0.0.dev20240505/sky/clouds/service_catalog/data_fetchers/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/clouds/service_catalog/data_fetchers/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    22424 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/clouds/service_catalog/data_fetchers/fetch_aws.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11477 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/clouds/service_catalog/data_fetchers/fetch_azure.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5072 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/clouds/service_catalog/data_fetchers/fetch_cudo.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3895 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/clouds/service_catalog/data_fetchers/fetch_fluidstack.py
+-rw-r--r--   0 runner    (1001) docker     (127)    22243 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/clouds/service_catalog/data_fetchers/fetch_gcp.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4297 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/clouds/service_catalog/data_fetchers/fetch_lambda_cloud.py
+-rw-r--r--   0 runner    (1001) docker     (127)    21462 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/clouds/service_catalog/data_fetchers/fetch_vsphere.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5038 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/clouds/service_catalog/fluidstack_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)    24120 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/clouds/service_catalog/gcp_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4472 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/clouds/service_catalog/ibm_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4240 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/clouds/service_catalog/kubernetes_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5082 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/clouds/service_catalog/lambda_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7542 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/clouds/service_catalog/oci_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3768 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/clouds/service_catalog/paperspace_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4184 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/clouds/service_catalog/runpod_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5174 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/clouds/service_catalog/scp_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4391 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/clouds/service_catalog/vsphere_catalog.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 10:38:13.641166 skypilot_nightly-1.0.0.dev20240505/sky/clouds/utils/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/clouds/utils/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6968 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/clouds/utils/gcp_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9991 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/clouds/utils/lambda_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4482 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/clouds/utils/oci_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    15781 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/clouds/utils/scp_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11969 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/clouds/vsphere.py
+-rw-r--r--   0 runner    (1001) docker     (127)    32857 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/core.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2529 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/dag.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 10:38:13.641166 skypilot_nightly-1.0.0.dev20240505/sky/data/
+-rw-r--r--   0 runner    (1001) docker     (127)      184 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/data/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7346 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/data/data_transfer.py
+-rw-r--r--   0 runner    (1001) docker     (127)    21664 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/data/data_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8226 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/data/mounting_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)   118872 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/data/storage.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6867 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/data/storage_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8230 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/exceptions.py
+-rw-r--r--   0 runner    (1001) docker     (127)    24917 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/execution.py
+-rw-r--r--   0 runner    (1001) docker     (127)    28681 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/global_user_state.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 10:38:13.645166 skypilot_nightly-1.0.0.dev20240505/sky/jobs/
+-rw-r--r--   0 runner    (1001) docker     (127)     1398 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/jobs/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1350 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/jobs/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)    26607 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/jobs/controller.py
+-rw-r--r--   0 runner    (1001) docker     (127)    13430 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/jobs/core.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 10:38:13.645166 skypilot_nightly-1.0.0.dev20240505/sky/jobs/dashboard/
+-rw-r--r--   0 runner    (1001) docker     (127)     3050 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/jobs/dashboard/dashboard.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 10:38:13.645166 skypilot_nightly-1.0.0.dev20240505/sky/jobs/dashboard/static/
+-rw-r--r--   0 runner    (1001) docker     (127)    15086 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/jobs/dashboard/static/favicon.ico
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 10:38:13.645166 skypilot_nightly-1.0.0.dev20240505/sky/jobs/dashboard/templates/
+-rw-r--r--   0 runner    (1001) docker     (127)     9837 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/jobs/dashboard/templates/index.html
+-rw-r--r--   0 runner    (1001) docker     (127)    25556 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/jobs/recovery_strategy.py
+-rw-r--r--   0 runner    (1001) docker     (127)    23041 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/jobs/state.py
+-rw-r--r--   0 runner    (1001) docker     (127)    33067 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/jobs/utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    54188 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/optimizer.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 10:38:13.645166 skypilot_nightly-1.0.0.dev20240505/sky/provision/
+-rw-r--r--   0 runner    (1001) docker     (127)     4907 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/provision/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 10:38:13.645166 skypilot_nightly-1.0.0.dev20240505/sky/provision/aws/
+-rw-r--r--   0 runner    (1001) docker     (127)      782 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/provision/aws/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    22092 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/provision/aws/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)    36608 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/provision/aws/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3238 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/provision/aws/utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 10:38:13.649166 skypilot_nightly-1.0.0.dev20240505/sky/provision/azure/
+-rw-r--r--   0 runner    (1001) docker     (127)      199 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/provision/azure/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4398 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/provision/azure/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8561 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/provision/common.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 10:38:13.649166 skypilot_nightly-1.0.0.dev20240505/sky/provision/cudo/
+-rw-r--r--   0 runner    (1001) docker     (127)      676 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/provision/cudo/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)      327 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/provision/cudo/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)      696 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/provision/cudo/cudo_machine_type.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4046 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/provision/cudo/cudo_wrapper.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8202 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/provision/cudo/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)    16782 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/provision/docker_utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 10:38:13.649166 skypilot_nightly-1.0.0.dev20240505/sky/provision/fluidstack/
+-rw-r--r--   0 runner    (1001) docker     (127)      592 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/provision/fluidstack/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)      326 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/provision/fluidstack/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8262 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/provision/fluidstack/fluidstack_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    14870 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/provision/fluidstack/instance.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 10:38:13.649166 skypilot_nightly-1.0.0.dev20240505/sky/provision/gcp/
+-rw-r--r--   0 runner    (1001) docker     (127)      579 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/provision/gcp/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    32964 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/provision/gcp/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7234 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/provision/gcp/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)    24482 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/provision/gcp/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)    59069 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/provision/gcp/instance_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    22258 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/provision/instance_setup.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 10:38:13.653166 skypilot_nightly-1.0.0.dev20240505/sky/provision/kubernetes/
+-rw-r--r--   0 runner    (1001) docker     (127)      653 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/provision/kubernetes/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    17388 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/provision/kubernetes/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)    32841 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/provision/kubernetes/instance.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 10:38:13.653166 skypilot_nightly-1.0.0.dev20240505/sky/provision/kubernetes/manifests/
+-rw-r--r--   0 runner    (1001) docker     (127)      229 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/provision/kubernetes/manifests/smarter-device-manager-configmap.yaml
+-rw-r--r--   0 runner    (1001) docker     (127)     1939 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/provision/kubernetes/manifests/smarter-device-manager-daemonset.yaml
+-rw-r--r--   0 runner    (1001) docker     (127)    10501 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/provision/kubernetes/network.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9035 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/provision/kubernetes/network_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    55170 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/provision/kubernetes/utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2103 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/provision/logging.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4013 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/provision/metadata_utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 10:38:13.653166 skypilot_nightly-1.0.0.dev20240505/sky/provision/paperspace/
+-rw-r--r--   0 runner    (1001) docker     (127)      598 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/provision/paperspace/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1541 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/provision/paperspace/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)      802 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/provision/paperspace/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11985 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/provision/paperspace/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9428 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/provision/paperspace/utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    25255 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/provision/provisioner.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 10:38:13.653166 skypilot_nightly-1.0.0.dev20240505/sky/provision/runpod/
+-rw-r--r--   0 runner    (1001) docker     (127)      502 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/provision/runpod/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)      321 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/provision/runpod/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7849 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/provision/runpod/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4648 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/provision/runpod/utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 10:38:13.653166 skypilot_nightly-1.0.0.dev20240505/sky/provision/vsphere/
+-rw-r--r--   0 runner    (1001) docker     (127)      788 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/provision/vsphere/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 10:38:13.657166 skypilot_nightly-1.0.0.dev20240505/sky/provision/vsphere/common/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/provision/vsphere/common/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4167 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/provision/vsphere/common/cls_api_client.py
+-rw-r--r--   0 runner    (1001) docker     (127)    14096 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/provision/vsphere/common/cls_api_helper.py
+-rw-r--r--   0 runner    (1001) docker     (127)      481 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/provision/vsphere/common/custom_script.py
+-rw-r--r--   0 runner    (1001) docker     (127)      303 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/provision/vsphere/common/id_generator.py
+-rw-r--r--   0 runner    (1001) docker     (127)      914 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/provision/vsphere/common/metadata_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1817 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/provision/vsphere/common/service_manager.py
+-rw-r--r--   0 runner    (1001) docker     (127)      544 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/provision/vsphere/common/service_manager_factory.py
+-rw-r--r--   0 runner    (1001) docker     (127)      795 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/provision/vsphere/common/ssl_helper.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2932 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/provision/vsphere/common/vapiconnect.py
+-rw-r--r--   0 runner    (1001) docker     (127)    17877 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/provision/vsphere/common/vim_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)      504 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/provision/vsphere/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)    24476 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/provision/vsphere/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)    15151 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/provision/vsphere/vsphere_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    65346 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/resources.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 10:38:13.657166 skypilot_nightly-1.0.0.dev20240505/sky/serve/
+-rw-r--r--   0 runner    (1001) docker     (127)     1661 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/serve/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    30136 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/serve/autoscalers.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3746 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/serve/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7571 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/serve/controller.py
+-rw-r--r--   0 runner    (1001) docker     (127)    28265 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/serve/core.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4689 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/serve/load_balancer.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2047 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/serve/load_balancing_policies.py
+-rw-r--r--   0 runner    (1001) docker     (127)    55738 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/serve/replica_managers.py
+-rw-r--r--   0 runner    (1001) docker     (127)    18830 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/serve/serve_state.py
+-rw-r--r--   0 runner    (1001) docker     (127)    36837 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/serve/serve_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10931 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/serve/service.py
+-rw-r--r--   0 runner    (1001) docker     (127)    13803 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/serve/service_spec.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 10:38:13.661166 skypilot_nightly-1.0.0.dev20240505/sky/setup_files/
+-rw-r--r--   0 runner    (1001) docker     (127)      718 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/setup_files/MANIFEST.in
+-rw-r--r--   0 runner    (1001) docker     (127)    12055 2024-05-05 10:38:10.000000 skypilot_nightly-1.0.0.dev20240505/sky/setup_files/setup.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4000 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/sky_logging.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 10:38:13.661166 skypilot_nightly-1.0.0.dev20240505/sky/skylet/
+-rw-r--r--   0 runner    (1001) docker     (127)    12381 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/skylet/LICENSE
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/skylet/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1963 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/skylet/attempt_skylet.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4293 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/skylet/autostop_lib.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1887 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/skylet/configs.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9977 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/skylet/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11596 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/skylet/events.py
+-rw-r--r--   0 runner    (1001) docker     (127)    35202 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/skylet/job_lib.py
+-rw-r--r--   0 runner    (1001) docker     (127)    18824 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/skylet/log_lib.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4295 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/skylet/log_lib.pyi
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 10:38:13.661166 skypilot_nightly-1.0.0.dev20240505/sky/skylet/providers/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/skylet/providers/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 10:38:13.661166 skypilot_nightly-1.0.0.dev20240505/sky/skylet/providers/azure/
+-rw-r--r--   0 runner    (1001) docker     (127)       97 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/skylet/providers/azure/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4344 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/skylet/providers/azure/azure-config-template.json
+-rw-r--r--   0 runner    (1001) docker     (127)    10901 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/skylet/providers/azure/azure-vm-template.json
+-rw-r--r--   0 runner    (1001) docker     (127)     6203 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/skylet/providers/azure/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)    18812 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/skylet/providers/azure/node_provider.py
+-rw-r--r--   0 runner    (1001) docker     (127)    16355 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/skylet/providers/command_runner.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 10:38:13.665166 skypilot_nightly-1.0.0.dev20240505/sky/skylet/providers/ibm/
+-rw-r--r--   0 runner    (1001) docker     (127)       94 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/skylet/providers/ibm/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    38280 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/skylet/providers/ibm/node_provider.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1292 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/skylet/providers/ibm/utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    34630 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/skylet/providers/ibm/vpc_provider.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 10:38:13.665166 skypilot_nightly-1.0.0.dev20240505/sky/skylet/providers/lambda_cloud/
+-rw-r--r--   0 runner    (1001) docker     (127)      112 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/skylet/providers/lambda_cloud/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    13992 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/skylet/providers/lambda_cloud/node_provider.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 10:38:13.665166 skypilot_nightly-1.0.0.dev20240505/sky/skylet/providers/oci/
+-rw-r--r--   0 runner    (1001) docker     (127)       91 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/skylet/providers/oci/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    20492 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/skylet/providers/oci/node_provider.py
+-rw-r--r--   0 runner    (1001) docker     (127)    17202 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/skylet/providers/oci/query_helper.py
+-rw-r--r--   0 runner    (1001) docker     (127)      508 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/skylet/providers/oci/utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 10:38:13.665166 skypilot_nightly-1.0.0.dev20240505/sky/skylet/providers/scp/
+-rw-r--r--   0 runner    (1001) docker     (127)       91 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/skylet/providers/scp/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4683 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/skylet/providers/scp/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)    22411 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/skylet/providers/scp/node_provider.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 10:38:13.669166 skypilot_nightly-1.0.0.dev20240505/sky/skylet/ray_patches/
+-rw-r--r--   0 runner    (1001) docker     (127)     2761 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/skylet/ray_patches/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)      291 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/skylet/ray_patches/autoscaler.py.patch
+-rw-r--r--   0 runner    (1001) docker     (127)      349 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/skylet/ray_patches/cli.py.patch
+-rw-r--r--   0 runner    (1001) docker     (127)      224 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/skylet/ray_patches/command_runner.py.patch
+-rw-r--r--   0 runner    (1001) docker     (127)      531 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/skylet/ray_patches/log_monitor.py.patch
+-rw-r--r--   0 runner    (1001) docker     (127)      658 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/skylet/ray_patches/resource_demand_scheduler.py.patch
+-rw-r--r--   0 runner    (1001) docker     (127)      289 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/skylet/ray_patches/updater.py.patch
+-rw-r--r--   0 runner    (1001) docker     (127)      565 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/skylet/ray_patches/worker.py.patch
+-rw-r--r--   0 runner    (1001) docker     (127)     1153 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/skylet/skylet.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1348 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/skylet/subprocess_daemon.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5586 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/skypilot_config.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1457 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/status_lib.py
+-rw-r--r--   0 runner    (1001) docker     (127)    47130 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/task.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 10:38:13.669166 skypilot_nightly-1.0.0.dev20240505/sky/templates/
+-rw-r--r--   0 runner    (1001) docker     (127)     7320 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/templates/aws-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     9037 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/templates/azure-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     3435 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/templates/cudo-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     3465 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/templates/fluidstack-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     8880 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/templates/gcp-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     6607 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/templates/ibm-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     1343 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/templates/jobs-controller.yaml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     1095 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/templates/kubernetes-ingress.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)      376 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/templates/kubernetes-loadbalancer.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     2547 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/templates/kubernetes-port-forward-proxy-command.sh.j2
+-rw-r--r--   0 runner    (1001) docker     (127)    11034 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/templates/kubernetes-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     2747 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/templates/kubernetes-ssh-jump.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     5676 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/templates/lambda-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     1185 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/templates/local-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     6970 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/templates/oci-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     3898 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/templates/paperspace-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     3496 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/templates/runpod-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     5546 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/templates/scp-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     1148 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/templates/sky-serve-controller.yaml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     3474 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/templates/vsphere-ray.yml.j2
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 10:38:13.673166 skypilot_nightly-1.0.0.dev20240505/sky/usage/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/usage/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)      590 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/usage/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)    17601 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/usage/usage_lib.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 10:38:13.677166 skypilot_nightly-1.0.0.dev20240505/sky/utils/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/utils/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3798 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/utils/accelerator_registry.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 10:38:13.677166 skypilot_nightly-1.0.0.dev20240505/sky/utils/cli_utils/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/utils/cli_utils/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11032 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/utils/cli_utils/status_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)      849 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/utils/cluster_yaml_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    18805 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/utils/command_runner.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3485 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/utils/command_runner.pyi
+-rw-r--r--   0 runner    (1001) docker     (127)    22833 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/utils/common_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    32523 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/utils/controller_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5731 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/utils/dag_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2786 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/utils/db_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)      861 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/utils/env_options.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 10:38:13.677166 skypilot_nightly-1.0.0.dev20240505/sky/utils/kubernetes/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/utils/kubernetes/__init__.py
+-rwxr-xr-x   0 runner    (1001) docker     (127)     9667 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/utils/kubernetes/create_cluster.sh
+-rwxr-xr-x   0 runner    (1001) docker     (127)      927 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/utils/kubernetes/delete_cluster.sh
+-rw-r--r--   0 runner    (1001) docker     (127)     3187 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/utils/kubernetes/generate_kind_config.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6960 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/utils/kubernetes/gpu_labeler.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1186 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/utils/kubernetes/k8s_gpu_labeler_job.yaml
+-rw-r--r--   0 runner    (1001) docker     (127)     3812 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/utils/kubernetes/k8s_gpu_labeler_setup.yaml
+-rw-r--r--   0 runner    (1001) docker     (127)     6560 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/utils/kubernetes/ssh_jump_lifecycle_manager.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1193 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/utils/kubernetes_enums.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8139 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/utils/log_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5540 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/utils/resources_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1581 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/utils/rich_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    20702 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/utils/schemas.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6509 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/utils/subprocess_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3936 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/utils/timeline.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3264 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/utils/ux_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)      701 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/sky/utils/validator.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 10:38:13.681166 skypilot_nightly-1.0.0.dev20240505/skypilot_nightly.egg-info/
+-rw-r--r--   0 runner    (1001) docker     (127)    18140 2024-05-05 10:38:13.000000 skypilot_nightly-1.0.0.dev20240505/skypilot_nightly.egg-info/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (127)     9302 2024-05-05 10:38:13.000000 skypilot_nightly-1.0.0.dev20240505/skypilot_nightly.egg-info/SOURCES.txt
+-rw-r--r--   0 runner    (1001) docker     (127)        1 2024-05-05 10:38:13.000000 skypilot_nightly-1.0.0.dev20240505/skypilot_nightly.egg-info/dependency_links.txt
+-rw-r--r--   0 runner    (1001) docker     (127)       36 2024-05-05 10:38:13.000000 skypilot_nightly-1.0.0.dev20240505/skypilot_nightly.egg-info/entry_points.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     2270 2024-05-05 10:38:13.000000 skypilot_nightly-1.0.0.dev20240505/skypilot_nightly.egg-info/requires.txt
+-rw-r--r--   0 runner    (1001) docker     (127)        4 2024-05-05 10:38:13.000000 skypilot_nightly-1.0.0.dev20240505/skypilot_nightly.egg-info/top_level.txt
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 10:38:13.681166 skypilot_nightly-1.0.0.dev20240505/tests/
+-rw-r--r--   0 runner    (1001) docker     (127)      171 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/tests/test_api.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3618 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/tests/test_cli.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9592 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/tests/test_config.py
+-rw-r--r--   0 runner    (1001) docker     (127)      267 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/tests/test_global_user_state.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8789 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/tests/test_jobs.py
+-rw-r--r--   0 runner    (1001) docker     (127)    17529 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/tests/test_jobs_and_serve.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3718 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/tests/test_list_accelerators.py
+-rw-r--r--   0 runner    (1001) docker     (127)    27759 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/tests/test_optimizer_dryruns.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6996 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/tests/test_optimizer_random_dag.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1102 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/tests/test_serve_autoscaler.py
+-rw-r--r--   0 runner    (1001) docker     (127)   215124 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/tests/test_smoke.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4048 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/tests/test_storage.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1070 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/tests/test_wheels.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3915 2024-05-05 10:38:06.000000 skypilot_nightly-1.0.0.dev20240505/tests/test_yaml_parser.py
```

### Comparing `skypilot_nightly-1.0.0.dev20240504/LICENSE` & `skypilot_nightly-1.0.0.dev20240505/LICENSE`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/MANIFEST.in` & `skypilot_nightly-1.0.0.dev20240505/MANIFEST.in`

 * *Files 2% similar despite different names*

```diff
@@ -9,12 +9,12 @@
 include sky/skylet/providers/ibm/*
 include sky/skylet/providers/kubernetes/*
 include sky/skylet/providers/lambda_cloud/*
 include sky/skylet/providers/oci/*
 include sky/skylet/providers/scp/*
 include sky/skylet/providers/*.py
 include sky/skylet/ray_patches/*.patch
-include sky/spot/dashboard/*
-include sky/spot/dashboard/templates/*
-include sky/spot/dashboard/static/*
+include sky/jobs/dashboard/*
+include sky/jobs/dashboard/templates/*
+include sky/jobs/dashboard/static/*
 include sky/templates/*
 include sky/utils/kubernetes/*
```

### Comparing `skypilot_nightly-1.0.0.dev20240504/PKG-INFO` & `skypilot_nightly-1.0.0.dev20240505/PKG-INFO`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: skypilot-nightly
-Version: 1.0.0.dev20240504
+Version: 1.0.0.dev20240505
 Summary: SkyPilot: An intercloud broker for the clouds
 Author: SkyPilot Team
 License: Apache 2.0
 Project-URL: Homepage, https://github.com/skypilot-org/skypilot
 Project-URL: Issues, https://github.com/skypilot-org/skypilot/issues
 Project-URL: Discussion, https://github.com/skypilot-org/skypilot/discussions
 Project-URL: Documentation, https://skypilot.readthedocs.io/en/latest/
```

### Comparing `skypilot_nightly-1.0.0.dev20240504/README.md` & `skypilot_nightly-1.0.0.dev20240505/README.md`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/pyproject.toml` & `skypilot_nightly-1.0.0.dev20240505/pyproject.toml`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/setup.py` & `skypilot_nightly-1.0.0.dev20240505/setup.py`

 * *Files 0% similar despite different names*

```diff
@@ -186,15 +186,15 @@
     # https://github.com/ray-project/ray/blob/ray-2.9.3/python/setup.py#L343
     'protobuf >= 3.15.3, != 3.19.5',
     # Some pydantic versions are not compatible with ray. Adopted from ray's
     # setup.py: https://github.com/ray-project/ray/blob/ray-2.9.3/python/setup.py#L254
     'pydantic!=2.0.*,!=2.1.*,!=2.2.*,!=2.3.*,!=2.4.*,<3',
 ]
 
-# NOTE: Change the templates/spot-controller.yaml.j2 file if any of the
+# NOTE: Change the templates/jobs-controller.yaml.j2 file if any of the
 # following packages dependencies are changed.
 aws_dependencies = [
     # botocore does not work with urllib3>=2.0.0, according to https://github.com/boto/botocore/issues/2926
     # We have to explicitly pin the version to optimize the time for
     # poetry install. See https://github.com/orgs/python-poetry/discussions/7937
     'urllib3<2',
     # NOTE: this installs CLI V1. To use AWS SSO (e.g., `aws sso login`), users
```

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/__init__.py` & `skypilot_nightly-1.0.0.dev20240505/sky/__init__.py`

 * *Files 7% similar despite different names*

```diff
@@ -1,15 +1,15 @@
 """The SkyPilot package."""
 import os
 import subprocess
 from typing import Optional
 import urllib.request
 
 # Replaced with the current commit when building the wheels.
-_SKYPILOT_COMMIT_SHA = 'e0d04d399138c1f0aa4554be8bf9f962f3506be5'
+_SKYPILOT_COMMIT_SHA = '015061ec581855c5a57b7dab434a68dc893f76c9'
 
 
 def _get_git_commit():
     if 'SKYPILOT_COMMIT_SHA' not in _SKYPILOT_COMMIT_SHA:
         # This is a release build, so we don't need to get the commit hash from
         # git, as it's already been set.
         return _SKYPILOT_COMMIT_SHA
@@ -31,15 +31,15 @@
             commit_hash += '-dirty'
         return commit_hash
     except Exception:  # pylint: disable=broad-except
         return _SKYPILOT_COMMIT_SHA
 
 
 __commit__ = _get_git_commit()
-__version__ = '1.0.0.dev20240504'
+__version__ = '1.0.0.dev20240505'
 __root_dir__ = os.path.dirname(os.path.abspath(__file__))
 
 
 # ---------------------- Proxy Configuration ---------------------- #
 def _set_http_proxy_env_vars() -> None:
     urllib_proxies = dict(urllib.request.getproxies())
 
@@ -98,24 +98,24 @@
 from sky.core import tail_logs
 from sky.dag import Dag
 from sky.data import Storage
 from sky.data import StorageMode
 from sky.data import StoreType
 from sky.execution import exec  # pylint: disable=redefined-builtin
 from sky.execution import launch
+# TODO (zhwu): These imports are for backward compatibility, and spot APIs
+# should be called with `sky.spot.xxx` instead. Remove in release 0.8.0
+from sky.jobs.core import spot_cancel
+from sky.jobs.core import spot_launch
+from sky.jobs.core import spot_queue
+from sky.jobs.core import spot_tail_logs
 from sky.optimizer import Optimizer
 from sky.optimizer import OptimizeTarget
 from sky.resources import Resources
 from sky.skylet.job_lib import JobStatus
-# TODO (zhwu): These imports are for backward compatibility, and spot APIs
-# should be called with `sky.spot.xxx` instead. Remove in release 0.7.0
-from sky.spot.core import spot_cancel
-from sky.spot.core import spot_launch
-from sky.spot.core import spot_queue
-from sky.spot.core import spot_tail_logs
 from sky.status_lib import ClusterStatus
 from sky.task import Task
 
 # Aliases.
 IBM = clouds.IBM
 AWS = clouds.AWS
 Azure = clouds.Azure
```

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/adaptors/aws.py` & `skypilot_nightly-1.0.0.dev20240505/sky/adaptors/aws.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/adaptors/azure.py` & `skypilot_nightly-1.0.0.dev20240505/sky/adaptors/azure.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/adaptors/cloudflare.py` & `skypilot_nightly-1.0.0.dev20240505/sky/adaptors/cloudflare.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/adaptors/common.py` & `skypilot_nightly-1.0.0.dev20240505/sky/adaptors/common.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/adaptors/gcp.py` & `skypilot_nightly-1.0.0.dev20240505/sky/adaptors/gcp.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/adaptors/ibm.py` & `skypilot_nightly-1.0.0.dev20240505/sky/adaptors/ibm.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/adaptors/kubernetes.py` & `skypilot_nightly-1.0.0.dev20240505/sky/adaptors/kubernetes.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/adaptors/oci.py` & `skypilot_nightly-1.0.0.dev20240505/sky/adaptors/oci.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/adaptors/vsphere.py` & `skypilot_nightly-1.0.0.dev20240505/sky/adaptors/vsphere.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/authentication.py` & `skypilot_nightly-1.0.0.dev20240505/sky/authentication.py`

 * *Files 1% similar despite different names*

```diff
@@ -11,15 +11,15 @@
    content, i.e., `configure_ssh_info`.
 2. Setup the `authorized_keys` on the remote VM with the public key content,
    by cloud-init or directly using cloud provider's API.
 
 The local machine's public key should not be uploaded to the
 `~/.ssh/sky-key.pub` on the remote VM, because it will cause private/public
 key pair mismatch when the user tries to launch new VM from that remote VM
-using SkyPilot, e.g., the node is used as a spot controller. (Lambda cloud
+using SkyPilot, e.g., the node is used as a jobs controller. (Lambda cloud
 is an exception, due to the limitation of the cloud provider. See the
 comments in setup_lambda_authentication)
 """
 import base64
 import copy
 import functools
 import os
```

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/backends/__init__.py` & `skypilot_nightly-1.0.0.dev20240505/sky/backends/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/backends/backend.py` & `skypilot_nightly-1.0.0.dev20240505/sky/backends/backend.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/backends/backend_utils.py` & `skypilot_nightly-1.0.0.dev20240505/sky/backends/backend_utils.py`

 * *Files 1% similar despite different names*

```diff
@@ -6223,1232 +6223,1269 @@
 000184e0: 650a 0a0a 2320 544f 444f 2874 6961 6e29  e...# TODO(tian)
 000184f0: 3a20 5265 6661 6374 6f72 2074 6f20 636f  : Refactor to co
 00018500: 6e74 726f 6c6c 6572 5f75 7469 6c73 2e20  ntroller_utils. 
 00018510: 4375 7272 656e 7420 626c 6f63 6b65 723a  Current blocker:
 00018520: 2063 6972 6375 6c61 7220 696d 706f 7274   circular import
 00018530: 2e0a 6465 6620 6973 5f63 6f6e 7472 6f6c  ..def is_control
 00018540: 6c65 725f 6163 6365 7373 6962 6c65 280a  ler_accessible(.
-00018550: 2020 2020 636f 6e74 726f 6c6c 6572 5f74      controller_t
-00018560: 7970 653a 2063 6f6e 7472 6f6c 6c65 725f  ype: controller_
-00018570: 7574 696c 732e 436f 6e74 726f 6c6c 6572  utils.Controller
-00018580: 732c 0a20 2020 2073 746f 7070 6564 5f6d  s,.    stopped_m
-00018590: 6573 7361 6765 3a20 7374 722c 0a20 2020  essage: str,.   
-000185a0: 206e 6f6e 5f65 7869 7374 656e 745f 6d65   non_existent_me
-000185b0: 7373 6167 653a 204f 7074 696f 6e61 6c5b  ssage: Optional[
-000185c0: 7374 725d 203d 204e 6f6e 652c 0a20 2020  str] = None,.   
-000185d0: 2065 7869 745f 6966 5f6e 6f74 5f61 6363   exit_if_not_acc
-000185e0: 6573 7369 626c 653a 2062 6f6f 6c20 3d20  essible: bool = 
-000185f0: 4661 6c73 652c 0a29 202d 3e20 2762 6163  False,.) -> 'bac
-00018600: 6b65 6e64 732e 436c 6f75 6456 6d52 6179  kends.CloudVmRay
-00018610: 5265 736f 7572 6365 4861 6e64 6c65 273a  ResourceHandle':
-00018620: 0a20 2020 2022 2222 4368 6563 6b20 6966  .    """Check if
-00018630: 2074 6865 2073 706f 742f 7365 7276 6520   the spot/serve 
-00018640: 636f 6e74 726f 6c6c 6572 2069 7320 7570  controller is up
-00018650: 2e0a 0a20 2020 2054 6865 2063 6f6e 7472  ...    The contr
-00018660: 6f6c 6c65 7220 6973 2061 6363 6573 7369  oller is accessi
-00018670: 626c 6520 7768 656e 2069 7420 6973 2069  ble when it is i
-00018680: 6e20 5550 206f 7220 494e 4954 2073 7461  n UP or INIT sta
-00018690: 7465 2c20 616e 6420 7468 6520 7373 680a  te, and the ssh.
-000186a0: 2020 2020 636f 6e6e 6563 7469 6f6e 2069      connection i
-000186b0: 7320 7375 6363 6573 7366 756c 2e0a 0a20  s successful... 
-000186c0: 2020 2049 7420 6361 6e20 6265 2075 7365     It can be use
-000186d0: 6420 746f 2063 6865 636b 2069 6620 7468  d to check if th
-000186e0: 6520 636f 6e74 726f 6c6c 6572 2069 7320  e controller is 
-000186f0: 6163 6365 7373 6962 6c65 2028 7369 6e63  accessible (sinc
-00018700: 6520 7468 6520 6175 746f 7374 6f70 0a20  e the autostop. 
-00018710: 2020 2069 7320 7365 7420 666f 7220 7468     is set for th
-00018720: 6520 636f 6e74 726f 6c6c 6572 2920 6265  e controller) be
-00018730: 666f 7265 2074 6865 2073 706f 742f 7365  fore the spot/se
-00018740: 7276 6520 636f 6d6d 616e 6473 2069 6e74  rve commands int
-00018750: 6572 6163 7420 7769 7468 2074 6865 0a20  eract with the. 
-00018760: 2020 2063 6f6e 7472 6f6c 6c65 722e 0a0a     controller...
-00018770: 2020 2020 436c 7573 7465 724e 6f74 5570      ClusterNotUp
-00018780: 4572 726f 7220 7769 6c6c 2062 6520 7261  Error will be ra
-00018790: 6973 6564 2077 6865 6e65 7665 7220 7468  ised whenever th
-000187a0: 6520 636f 6e74 726f 6c6c 6572 2063 616e  e controller can
-000187b0: 6e6f 7420 6265 2061 6363 6573 7365 642e  not be accessed.
-000187c0: 0a0a 2020 2020 4172 6773 3a0a 2020 2020  ..    Args:.    
-000187d0: 2020 2020 7479 7065 3a20 5479 7065 206f      type: Type o
-000187e0: 6620 7468 6520 636f 6e74 726f 6c6c 6572  f the controller
-000187f0: 2e0a 2020 2020 2020 2020 7374 6f70 7065  ..        stoppe
-00018800: 645f 6d65 7373 6167 653a 204d 6573 7361  d_message: Messa
-00018810: 6765 2074 6f20 7072 696e 7420 6966 2074  ge to print if t
-00018820: 6865 2063 6f6e 7472 6f6c 6c65 7220 6973  he controller is
-00018830: 2053 544f 5050 4544 2e0a 2020 2020 2020   STOPPED..      
-00018840: 2020 6e6f 6e5f 6578 6973 7465 6e74 5f6d    non_existent_m
-00018850: 6573 7361 6765 3a20 4d65 7373 6167 6520  essage: Message 
-00018860: 746f 2073 686f 7720 6966 2074 6865 2063  to show if the c
-00018870: 6f6e 7472 6f6c 6c65 7220 646f 6573 206e  ontroller does n
-00018880: 6f74 2065 7869 7374 2e0a 2020 2020 2020  ot exist..      
-00018890: 2020 6578 6974 5f69 665f 6e6f 745f 6163    exit_if_not_ac
-000188a0: 6365 7373 6962 6c65 3a20 5768 6574 6865  cessible: Whethe
-000188b0: 7220 746f 2065 7869 7420 6469 7265 6374  r to exit direct
-000188c0: 6c79 2069 6620 7468 6520 636f 6e74 726f  ly if the contro
-000188d0: 6c6c 6572 2069 7320 6e6f 740a 2020 2020  ller is not.    
-000188e0: 2020 2020 2020 6163 6365 7373 6962 6c65        accessible
-000188f0: 2e20 4966 2046 616c 7365 2c20 7468 6520  . If False, the 
-00018900: 6675 6e63 7469 6f6e 2077 696c 6c20 7261  function will ra
-00018910: 6973 6520 436c 7573 7465 724e 6f74 5570  ise ClusterNotUp
-00018920: 4572 726f 722e 0a0a 2020 2020 5265 7475  Error...    Retu
-00018930: 726e 733a 0a20 2020 2020 2020 2068 616e  rns:.        han
-00018940: 646c 653a 2054 6865 2052 6573 6f75 7263  dle: The Resourc
-00018950: 6548 616e 646c 6520 6f66 2074 6865 2063  eHandle of the c
-00018960: 6f6e 7472 6f6c 6c65 722e 0a0a 2020 2020  ontroller...    
-00018970: 5261 6973 6573 3a0a 2020 2020 2020 2020  Raises:.        
-00018980: 6578 6365 7074 696f 6e73 2e43 6c75 7374  exceptions.Clust
-00018990: 6572 4f77 6e65 7249 6465 6e74 6974 794d  erOwnerIdentityM
-000189a0: 6973 6d61 7463 6845 7272 6f72 3a20 6966  ismatchError: if
-000189b0: 2074 6865 2063 7572 7265 6e74 2075 7365   the current use
-000189c0: 7220 6973 206e 6f74 0a20 2020 2020 2020  r is not.       
-000189d0: 2020 2074 6865 2073 616d 6520 6173 2074     the same as t
-000189e0: 6865 2075 7365 7220 7768 6f20 6372 6561  he user who crea
-000189f0: 7465 6420 7468 6520 636c 7573 7465 722e  ted the cluster.
-00018a00: 0a20 2020 2020 2020 2065 7863 6570 7469  .        excepti
-00018a10: 6f6e 732e 436c 6f75 6455 7365 7249 6465  ons.CloudUserIde
-00018a20: 6e74 6974 7945 7272 6f72 3a20 6966 2077  ntityError: if w
-00018a30: 6520 6661 696c 2074 6f20 6765 7420 7468  e fail to get th
-00018a40: 6520 6375 7272 656e 7420 7573 6572 0a20  e current user. 
-00018a50: 2020 2020 2020 2020 2069 6465 6e74 6974           identit
-00018a60: 792e 0a20 2020 2020 2020 2065 7863 6570  y..        excep
-00018a70: 7469 6f6e 732e 436c 7573 7465 724e 6f74  tions.ClusterNot
-00018a80: 5570 4572 726f 723a 2069 6620 7468 6520  UpError: if the 
-00018a90: 636f 6e74 726f 6c6c 6572 2069 7320 6e6f  controller is no
-00018aa0: 7420 6163 6365 7373 6962 6c65 2c20 6f72  t accessible, or
-00018ab0: 0a20 2020 2020 2020 2020 2066 6169 6c65  .          faile
-00018ac0: 6420 746f 2062 6520 636f 6e6e 6563 7465  d to be connecte
-00018ad0: 642e 0a20 2020 2022 2222 0a20 2020 2069  d..    """.    i
-00018ae0: 6620 6e6f 6e5f 6578 6973 7465 6e74 5f6d  f non_existent_m
-00018af0: 6573 7361 6765 2069 7320 4e6f 6e65 3a0a  essage is None:.
-00018b00: 2020 2020 2020 2020 6e6f 6e5f 6578 6973          non_exis
-00018b10: 7465 6e74 5f6d 6573 7361 6765 203d 2028  tent_message = (
-00018b20: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
-00018b30: 7472 6f6c 6c65 725f 7479 7065 2e76 616c  troller_type.val
-00018b40: 7565 2e64 6566 6175 6c74 5f68 696e 745f  ue.default_hint_
-00018b50: 6966 5f6e 6f6e 5f65 7869 7374 656e 7429  if_non_existent)
-00018b60: 0a20 2020 2063 6c75 7374 6572 5f6e 616d  .    cluster_nam
-00018b70: 6520 3d20 636f 6e74 726f 6c6c 6572 5f74  e = controller_t
-00018b80: 7970 652e 7661 6c75 652e 636c 7573 7465  ype.value.cluste
-00018b90: 725f 6e61 6d65 0a20 2020 2063 6f6e 7472  r_name.    contr
-00018ba0: 6f6c 6c65 725f 6e61 6d65 203d 2063 6f6e  oller_name = con
-00018bb0: 7472 6f6c 6c65 725f 7479 7065 2e76 616c  troller_type.val
-00018bc0: 7565 2e6e 616d 652e 7265 706c 6163 6528  ue.name.replace(
-00018bd0: 2720 636f 6e74 726f 6c6c 6572 272c 2027  ' controller', '
-00018be0: 2729 0a20 2020 206e 6565 645f 636f 6e6e  ').    need_conn
-00018bf0: 6563 7469 6f6e 5f63 6865 636b 203d 2046  ection_check = F
-00018c00: 616c 7365 0a20 2020 2063 6f6e 7472 6f6c  alse.    control
-00018c10: 6c65 725f 7374 6174 7573 2c20 6861 6e64  ler_status, hand
-00018c20: 6c65 203d 204e 6f6e 652c 204e 6f6e 650a  le = None, None.
-00018c30: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-00018c40: 2023 2053 6574 2066 6f72 6365 5f72 6566   # Set force_ref
-00018c50: 7265 7368 5f73 7461 7475 7365 733d 5b49  resh_statuses=[I
-00018c60: 4e49 545d 2074 6f20 6d61 6b65 2073 7572  NIT] to make sur
-00018c70: 6520 7468 6520 7265 6672 6573 6820 6861  e the refresh ha
-00018c80: 7070 656e 730a 2020 2020 2020 2020 2320  ppens.        # 
-00018c90: 7768 656e 2074 6865 2063 6f6e 7472 6f6c  when the control
-00018ca0: 6c65 7220 6973 2049 4e49 542f 5550 2028  ler is INIT/UP (
-00018cb0: 7472 6967 6765 7265 6420 696e 2074 6865  triggered in the
-00018cc0: 7365 2073 7461 7475 7365 7320 6173 2074  se statuses as t
-00018cd0: 6865 0a20 2020 2020 2020 2023 2061 7574  he.        # aut
-00018ce0: 6f73 746f 7020 6973 2061 6c77 6179 7320  ostop is always 
-00018cf0: 7365 7420 666f 7220 7468 6520 636f 6e74  set for the cont
-00018d00: 726f 6c6c 6572 292e 2054 6865 2063 6f6e  roller). The con
-00018d10: 7472 6f6c 6c65 7220 6361 6e20 6265 2069  troller can be i
-00018d20: 6e0a 2020 2020 2020 2020 2320 666f 6c6c  n.        # foll
-00018d30: 6f77 696e 6720 6361 7365 733a 0a20 2020  owing cases:.   
-00018d40: 2020 2020 2023 202a 2028 5550 2c20 6175       # * (UP, au
-00018d50: 746f 7374 6f70 2073 6574 293a 2069 7420  tostop set): it 
-00018d60: 7769 6c6c 2062 6520 7265 6672 6573 6865  will be refreshe
-00018d70: 6420 7769 7468 6f75 7420 666f 7263 655f  d without force_
-00018d80: 7265 6672 6573 6820 7365 742e 0a20 2020  refresh set..   
-00018d90: 2020 2020 2023 202a 2028 5550 2c20 6e6f       # * (UP, no
-00018da0: 2061 7574 6f73 746f 7029 3a20 7665 7279   autostop): very
-00018db0: 2072 6172 6520 2861 2075 7365 7220 6374   rare (a user ct
-00018dc0: 726c 2d63 2077 6865 6e20 7468 6520 636f  rl-c when the co
-00018dd0: 6e74 726f 6c6c 6572 2069 730a 2020 2020  ntroller is.    
-00018de0: 2020 2020 2320 2020 6c61 756e 6368 696e      #   launchin
-00018df0: 6729 2c20 646f 6573 206e 6f74 206d 6174  g), does not mat
-00018e00: 7465 7220 6966 2072 6566 7265 7368 206f  ter if refresh o
-00018e10: 7220 6e6f 742c 2073 696e 6365 206e 6f20  r not, since no 
-00018e20: 6175 746f 7374 6f70 2e20 5765 0a20 2020  autostop. We.   
-00018e30: 2020 2020 2023 2020 2064 6f6e 2774 2069       #   don't i
-00018e40: 6e63 6c75 6465 2055 5020 696e 2066 6f72  nclude UP in for
-00018e50: 6365 5f72 6566 7265 7368 5f73 7461 7475  ce_refresh_statu
-00018e60: 7365 7320 746f 2061 766f 6964 206f 7665  ses to avoid ove
-00018e70: 7268 6561 6473 2e0a 2020 2020 2020 2020  rheads..        
-00018e80: 2320 2a20 2849 4e49 542c 2061 7574 6f73  # * (INIT, autos
-00018e90: 746f 7020 7365 7429 0a20 2020 2020 2020  top set).       
-00018ea0: 2023 202a 2028 494e 4954 2c20 6e6f 2061   # * (INIT, no a
-00018eb0: 7574 6f73 746f 7029 3a20 7665 7279 2072  utostop): very r
-00018ec0: 6172 6520 285f 7570 6461 7465 5f63 6c75  are (_update_clu
-00018ed0: 7374 6572 5f73 7461 7475 735f 6e6f 5f6c  ster_status_no_l
-00018ee0: 6f63 6b20 6d61 790a 2020 2020 2020 2020  ock may.        
-00018ef0: 2320 2020 7265 7365 7420 6c6f 6361 6c20  #   reset local 
-00018f00: 6175 746f 7374 6f70 2063 6f6e 6669 6729  autostop config)
-00018f10: 2c20 6275 7420 666f 7263 655f 7265 6672  , but force_refr
-00018f20: 6573 6820 7769 6c6c 206d 616b 6520 7375  esh will make su
-00018f30: 7265 0a20 2020 2020 2020 2023 2020 2073  re.        #   s
-00018f40: 7461 7475 7320 6973 2072 6566 7265 7368  tatus is refresh
-00018f50: 6564 2e0a 2020 2020 2020 2020 230a 2020  ed..        #.  
-00018f60: 2020 2020 2020 2320 5765 2061 766f 6964        # We avoid
-00018f70: 7320 756e 6e65 6365 7373 6172 7920 636f  s unnecessary co
-00018f80: 7374 6c79 2072 6566 7265 7368 2077 6865  stly refresh whe
-00018f90: 6e20 7468 6520 636f 6e74 726f 6c6c 6572  n the controller
-00018fa0: 2069 7320 616c 7265 6164 790a 2020 2020   is already.    
-00018fb0: 2020 2020 2320 5354 4f50 5045 442e 2054      # STOPPED. T
-00018fc0: 6869 7320 6f70 7469 6d69 7a61 7469 6f6e  his optimization
-00018fd0: 2069 7320 6261 7365 6420 6f6e 2074 6865   is based on the
-00018fe0: 2061 7373 756d 7074 696f 6e20 7468 6174   assumption that
-00018ff0: 2074 6865 2075 7365 720a 2020 2020 2020   the user.      
-00019000: 2020 2320 7769 6c6c 206e 6f74 2073 7461    # will not sta
-00019010: 7274 2074 6865 2063 6f6e 7472 6f6c 6c65  rt the controlle
-00019020: 7220 6d61 6e75 616c 6c79 2066 726f 6d20  r manually from 
-00019030: 7468 6520 636c 6f75 6420 636f 6e73 6f6c  the cloud consol
-00019040: 652e 0a20 2020 2020 2020 2023 0a20 2020  e..        #.   
-00019050: 2020 2020 2023 2054 6865 2061 6371 7569       # The acqui
-00019060: 7265 5f6c 6f63 6b5f 7469 6d65 6f75 7420  re_lock_timeout 
-00019070: 6973 2073 6574 2074 6f20 3020 746f 2061  is set to 0 to a
-00019080: 766f 6964 2068 616e 6769 6e67 2074 6865  void hanging the
-00019090: 2063 6f6d 6d61 6e64 2077 6865 6e0a 2020   command when.  
-000190a0: 2020 2020 2020 2320 6d75 6c74 6970 6c65        # multiple
-000190b0: 2073 706f 742e 6c61 756e 6368 2063 6f6d   spot.launch com
-000190c0: 6d61 6e64 7320 6172 6520 7275 6e6e 696e  mands are runnin
-000190d0: 6720 6174 2074 6865 2073 616d 6520 7469  g at the same ti
-000190e0: 6d65 2e20 4f75 7220 6c61 7465 720a 2020  me. Our later.  
-000190f0: 2020 2020 2020 2320 636f 6465 2077 696c        # code wil
-00019100: 6c20 6368 6563 6b20 6966 2074 6865 2063  l check if the c
-00019110: 6f6e 7472 6f6c 6c65 7220 6973 2061 6363  ontroller is acc
-00019120: 6573 7369 626c 6520 6279 2064 6972 6563  essible by direc
-00019130: 746c 7920 6368 6563 6b69 6e67 0a20 2020  tly checking.   
-00019140: 2020 2020 2023 2074 6865 2073 7368 2063       # the ssh c
-00019150: 6f6e 6e65 6374 696f 6e20 746f 2074 6865  onnection to the
-00019160: 2063 6f6e 7472 6f6c 6c65 722c 2069 6620   controller, if 
-00019170: 6974 2066 6169 6c73 2074 6f20 6765 7420  it fails to get 
-00019180: 6163 6375 7261 7465 0a20 2020 2020 2020  accurate.       
-00019190: 2023 2073 7461 7475 7320 6f66 2074 6865   # status of the
-000191a0: 2063 6f6e 7472 6f6c 6c65 722e 0a20 2020   controller..   
-000191b0: 2020 2020 2063 6f6e 7472 6f6c 6c65 725f       controller_
-000191c0: 7374 6174 7573 2c20 6861 6e64 6c65 203d  status, handle =
-000191d0: 2072 6566 7265 7368 5f63 6c75 7374 6572   refresh_cluster
-000191e0: 5f73 7461 7475 735f 6861 6e64 6c65 280a  _status_handle(.
-000191f0: 2020 2020 2020 2020 2020 2020 636c 7573              clus
-00019200: 7465 725f 6e61 6d65 2c0a 2020 2020 2020  ter_name,.      
-00019210: 2020 2020 2020 666f 7263 655f 7265 6672        force_refr
-00019220: 6573 685f 7374 6174 7573 6573 3d5b 7374  esh_statuses=[st
-00019230: 6174 7573 5f6c 6962 2e43 6c75 7374 6572  atus_lib.Cluster
-00019240: 5374 6174 7573 2e49 4e49 545d 2c0a 2020  Status.INIT],.  
-00019250: 2020 2020 2020 2020 2020 636c 7573 7465            cluste
-00019260: 725f 7374 6174 7573 5f6c 6f63 6b5f 7469  r_status_lock_ti
-00019270: 6d65 6f75 743d 3029 0a20 2020 2065 7863  meout=0).    exc
-00019280: 6570 7420 6578 6365 7074 696f 6e73 2e43  ept exceptions.C
-00019290: 6c75 7374 6572 5374 6174 7573 4665 7463  lusterStatusFetc
-000192a0: 6869 6e67 4572 726f 7220 6173 2065 3a0a  hingError as e:.
-000192b0: 2020 2020 2020 2020 2320 5765 2064 6f20          # We do 
-000192c0: 6e6f 7420 6361 7463 6820 7468 6520 6578  not catch the ex
-000192d0: 6365 7074 696f 6e73 2072 656c 6174 6564  ceptions related
-000192e0: 2074 6f20 7468 6520 636c 7573 7465 7220   to the cluster 
-000192f0: 6f77 6e65 7220 6964 656e 7469 7479 0a20  owner identity. 
-00019300: 2020 2020 2020 2023 206d 6973 6d61 7463         # mismatc
-00019310: 682c 2070 6c65 6173 6520 7265 6665 7220  h, please refer 
-00019320: 746f 2074 6865 2063 6f6d 6d65 6e74 2069  to the comment i
-00019330: 6e0a 2020 2020 2020 2020 2320 6062 6163  n.        # `bac
-00019340: 6b65 6e64 5f75 7469 6c73 2e63 6865 636b  kend_utils.check
-00019350: 5f63 6c75 7374 6572 5f61 7661 696c 6162  _cluster_availab
-00019360: 6c65 602e 0a20 2020 2020 2020 206c 6f67  le`..        log
-00019370: 6765 722e 7761 726e 696e 6728 0a20 2020  ger.warning(.   
-00019380: 2020 2020 2020 2020 2027 4661 696c 6564           'Failed
-00019390: 2074 6f20 6765 7420 7468 6520 7374 6174   to get the stat
-000193a0: 7573 206f 6620 7468 6520 636f 6e74 726f  us of the contro
-000193b0: 6c6c 6572 2e20 4974 2069 7320 6e6f 7420  ller. It is not 
-000193c0: 270a 2020 2020 2020 2020 2020 2020 6627  '.            f'
-000193d0: 6661 7461 6c2c 2062 7574 207b 636f 6e74  fatal, but {cont
-000193e0: 726f 6c6c 6572 5f6e 616d 657d 2063 6f6d  roller_name} com
-000193f0: 6d61 6e64 732f 6361 6c6c 7320 6d61 7920  mands/calls may 
-00019400: 6861 6e67 206f 7220 7265 7475 726e 2027  hang or return '
-00019410: 0a20 2020 2020 2020 2020 2020 2027 7374  .            'st
-00019420: 616c 6520 696e 666f 726d 6174 696f 6e2c  ale information,
-00019430: 2077 6865 6e20 7468 6520 636f 6e74 726f   when the contro
-00019440: 6c6c 6572 2069 7320 6e6f 7420 7570 2e5c  ller is not up.\
-00019450: 6e27 0a20 2020 2020 2020 2020 2020 2066  n'.            f
-00019460: 2720 2044 6574 6169 6c73 3a20 7b63 6f6d  '  Details: {com
-00019470: 6d6f 6e5f 7574 696c 732e 666f 726d 6174  mon_utils.format
-00019480: 5f65 7863 6570 7469 6f6e 2865 2c20 7573  _exception(e, us
-00019490: 655f 6272 6163 6b65 743d 5472 7565 297d  e_bracket=True)}
-000194a0: 2729 0a20 2020 2020 2020 2072 6563 6f72  ').        recor
-000194b0: 6420 3d20 676c 6f62 616c 5f75 7365 725f  d = global_user_
-000194c0: 7374 6174 652e 6765 745f 636c 7573 7465  state.get_cluste
-000194d0: 725f 6672 6f6d 5f6e 616d 6528 636c 7573  r_from_name(clus
-000194e0: 7465 725f 6e61 6d65 290a 2020 2020 2020  ter_name).      
-000194f0: 2020 6966 2072 6563 6f72 6420 6973 206e    if record is n
-00019500: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-00019510: 2020 2020 2063 6f6e 7472 6f6c 6c65 725f       controller_
-00019520: 7374 6174 7573 2c20 6861 6e64 6c65 203d  status, handle =
-00019530: 2072 6563 6f72 645b 2773 7461 7475 7327   record['status'
-00019540: 5d2c 2072 6563 6f72 645b 2768 616e 646c  ], record['handl
-00019550: 6527 5d0a 2020 2020 2020 2020 2020 2020  e'].            
-00019560: 2320 5765 2063 6865 636b 2074 6865 2063  # We check the c
-00019570: 6f6e 6e65 6374 696f 6e20 6576 656e 2069  onnection even i
-00019580: 6620 7468 6520 636c 7573 7465 7220 6861  f the cluster ha
-00019590: 7320 6120 6361 6368 6564 2073 7461 7475  s a cached statu
-000195a0: 7320 5550 0a20 2020 2020 2020 2020 2020  s UP.           
-000195b0: 2023 2074 6f20 6d61 6b65 2073 7572 6520   # to make sure 
-000195c0: 7468 6520 636f 6e74 726f 6c6c 6572 2069  the controller i
-000195d0: 7320 6163 7475 616c 6c79 2061 6363 6573  s actually acces
-000195e0: 7369 626c 652c 2061 7320 7468 6520 6361  sible, as the ca
-000195f0: 6368 6564 0a20 2020 2020 2020 2020 2020  ched.           
-00019600: 2023 2073 7461 7475 7320 6d69 6768 7420   # status might 
-00019610: 6265 2073 7461 6c65 2e0a 2020 2020 2020  be stale..      
-00019620: 2020 2020 2020 6e65 6564 5f63 6f6e 6e65        need_conne
-00019630: 6374 696f 6e5f 6368 6563 6b20 3d20 5472  ction_check = Tr
-00019640: 7565 0a0a 2020 2020 6572 726f 725f 6d73  ue..    error_ms
-00019650: 6720 3d20 4e6f 6e65 0a20 2020 2069 6620  g = None.    if 
-00019660: 636f 6e74 726f 6c6c 6572 5f73 7461 7475  controller_statu
-00019670: 7320 3d3d 2073 7461 7475 735f 6c69 622e  s == status_lib.
-00019680: 436c 7573 7465 7253 7461 7475 732e 5354  ClusterStatus.ST
-00019690: 4f50 5045 443a 0a20 2020 2020 2020 2065  OPPED:.        e
-000196a0: 7272 6f72 5f6d 7367 203d 2073 746f 7070  rror_msg = stopp
-000196b0: 6564 5f6d 6573 7361 6765 0a20 2020 2065  ed_message.    e
-000196c0: 6c69 6620 636f 6e74 726f 6c6c 6572 5f73  lif controller_s
-000196d0: 7461 7475 7320 6973 204e 6f6e 6520 6f72  tatus is None or
-000196e0: 2068 616e 646c 6520 6973 204e 6f6e 6520   handle is None 
-000196f0: 6f72 2068 616e 646c 652e 6865 6164 5f69  or handle.head_i
-00019700: 7020 6973 204e 6f6e 653a 0a20 2020 2020  p is None:.     
-00019710: 2020 2023 2057 6520 6368 6563 6b20 7468     # We check th
-00019720: 6520 636f 6e74 726f 6c6c 6572 2069 7320  e controller is 
-00019730: 5354 4f50 5045 4420 6265 666f 7265 2074  STOPPED before t
-00019740: 6865 2063 6865 636b 2066 6f72 2068 616e  he check for han
-00019750: 646c 652e 6865 6164 5f69 700a 2020 2020  dle.head_ip.    
-00019760: 2020 2020 2320 4e6f 6e65 2062 6563 6175      # None becau
-00019770: 7365 2077 6865 6e20 7468 6520 636f 6e74  se when the cont
-00019780: 726f 6c6c 6572 2069 7320 5354 4f50 5045  roller is STOPPE
-00019790: 442c 2068 616e 646c 652e 6865 6164 5f69  D, handle.head_i
-000197a0: 7020 6361 6e20 616c 736f 0a20 2020 2020  p can also.     
-000197b0: 2020 2023 2062 6520 4e6f 6e65 2c20 6275     # be None, bu
-000197c0: 7420 7765 206f 6e6c 7920 7761 6e74 2074  t we only want t
-000197d0: 6f20 6361 7463 6820 7468 6520 6361 7365  o catch the case
-000197e0: 2077 6865 6e20 7468 6520 636f 6e74 726f   when the contro
-000197f0: 6c6c 6572 2069 730a 2020 2020 2020 2020  ller is.        
-00019800: 2320 6265 696e 6720 7072 6f76 6973 696f  # being provisio
-00019810: 6e65 6420 6174 2074 6865 2066 6972 7374  ned at the first
-00019820: 2074 696d 6520 616e 6420 6861 7665 206e   time and have n
-00019830: 6f20 6865 6164 5f69 702e 0a20 2020 2020  o head_ip..     
-00019840: 2020 2065 7272 6f72 5f6d 7367 203d 206e     error_msg = n
-00019850: 6f6e 5f65 7869 7374 656e 745f 6d65 7373  on_existent_mess
-00019860: 6167 650a 2020 2020 656c 6966 2028 636f  age.    elif (co
-00019870: 6e74 726f 6c6c 6572 5f73 7461 7475 7320  ntroller_status 
-00019880: 3d3d 2073 7461 7475 735f 6c69 622e 436c  == status_lib.Cl
-00019890: 7573 7465 7253 7461 7475 732e 494e 4954  usterStatus.INIT
-000198a0: 206f 720a 2020 2020 2020 2020 2020 6e65   or.          ne
-000198b0: 6564 5f63 6f6e 6e65 6374 696f 6e5f 6368  ed_connection_ch
-000198c0: 6563 6b29 3a0a 2020 2020 2020 2020 2320  eck):.        # 
-000198d0: 4368 6563 6b20 7373 6820 636f 6e6e 6563  Check ssh connec
-000198e0: 7469 6f6e 2069 6620 2831 2920 636f 6e74  tion if (1) cont
-000198f0: 726f 6c6c 6572 2069 7320 696e 2049 4e49  roller is in INI
-00019900: 5420 7374 6174 652c 206f 7220 2832 2920  T state, or (2) 
-00019910: 7765 2066 6169 6c65 6420 746f 2066 6574  we failed to fet
-00019920: 6368 2074 6865 0a20 2020 2020 2020 2023  ch the.        #
-00019930: 2073 7461 7475 732c 2062 6f74 6820 6f66   status, both of
-00019940: 2077 6869 6368 2063 616e 2068 6170 7065   which can happe
-00019950: 6e20 7768 656e 2063 6f6e 7472 6f6c 6c65  n when controlle
-00019960: 7227 7320 7374 6174 7573 206c 6f63 6b20  r's status lock 
-00019970: 6973 2068 656c 6420 6279 2061 6e6f 7468  is held by anoth
-00019980: 6572 2060 736b 7920 7370 6f74 206c 6175  er `sky spot lau
-00019990: 6e63 6860 206f 720a 2020 2020 2020 2020  nch` or.        
-000199a0: 2320 6073 6b79 2073 6572 7665 2075 7060  # `sky serve up`
-000199b0: 2e20 4966 2077 6520 6861 7665 c2a0 636f  . If we have..co
-000199c0: 6e74 726f 6c6c 6572 2773 2068 6561 645f  ntroller's head_
-000199d0: 6970 2061 7661 696c 6162 6c65 2061 6e64  ip available and
-000199e0: 2069 7420 6973 2073 7368 2d72 6561 6368   it is ssh-reach
-000199f0: 6162 6c65 2c0a 2020 2020 2020 2020 2320  able,.        # 
-00019a00: 7765 2063 616e 2061 6c6c 6f77 2061 6363  we can allow acc
-00019a10: 6573 7320 746f 2074 6865 2063 6f6e 7472  ess to the contr
-00019a20: 6f6c 6c65 722e 0a20 2020 2020 2020 2073  oller..        s
-00019a30: 7368 5f63 7265 6465 6e74 6961 6c73 203d  sh_credentials =
-00019a40: 2073 7368 5f63 7265 6465 6e74 6961 6c5f   ssh_credential_
-00019a50: 6672 6f6d 5f79 616d 6c28 6861 6e64 6c65  from_yaml(handle
-00019a60: 2e63 6c75 7374 6572 5f79 616d 6c2c 0a20  .cluster_yaml,. 
+00018550: 2020 2020 636f 6e74 726f 6c6c 6572 3a20      controller: 
+00018560: 636f 6e74 726f 6c6c 6572 5f75 7469 6c73  controller_utils
+00018570: 2e43 6f6e 7472 6f6c 6c65 7273 2c0a 2020  .Controllers,.  
+00018580: 2020 7374 6f70 7065 645f 6d65 7373 6167    stopped_messag
+00018590: 653a 2073 7472 2c0a 2020 2020 6e6f 6e5f  e: str,.    non_
+000185a0: 6578 6973 7465 6e74 5f6d 6573 7361 6765  existent_message
+000185b0: 3a20 4f70 7469 6f6e 616c 5b73 7472 5d20  : Optional[str] 
+000185c0: 3d20 4e6f 6e65 2c0a 2020 2020 6578 6974  = None,.    exit
+000185d0: 5f69 665f 6e6f 745f 6163 6365 7373 6962  _if_not_accessib
+000185e0: 6c65 3a20 626f 6f6c 203d 2046 616c 7365  le: bool = False
+000185f0: 2c0a 2920 2d3e 2027 6261 636b 656e 6473  ,.) -> 'backends
+00018600: 2e43 6c6f 7564 566d 5261 7952 6573 6f75  .CloudVmRayResou
+00018610: 7263 6548 616e 646c 6527 3a0a 2020 2020  rceHandle':.    
+00018620: 2222 2243 6865 636b 2069 6620 7468 6520  """Check if the 
+00018630: 6a6f 6273 2f73 6572 7665 2063 6f6e 7472  jobs/serve contr
+00018640: 6f6c 6c65 7220 6973 2075 702e 0a0a 2020  oller is up...  
+00018650: 2020 5468 6520 636f 6e74 726f 6c6c 6572    The controller
+00018660: 2069 7320 6163 6365 7373 6962 6c65 2077   is accessible w
+00018670: 6865 6e20 6974 2069 7320 696e 2055 5020  hen it is in UP 
+00018680: 6f72 2049 4e49 5420 7374 6174 652c 2061  or INIT state, a
+00018690: 6e64 2074 6865 2073 7368 0a20 2020 2063  nd the ssh.    c
+000186a0: 6f6e 6e65 6374 696f 6e20 6973 2073 7563  onnection is suc
+000186b0: 6365 7373 6675 6c2e 0a0a 2020 2020 4974  cessful...    It
+000186c0: 2063 616e 2062 6520 7573 6564 2074 6f20   can be used to 
+000186d0: 6368 6563 6b20 6966 2074 6865 2063 6f6e  check if the con
+000186e0: 7472 6f6c 6c65 7220 6973 2061 6363 6573  troller is acces
+000186f0: 7369 626c 6520 2873 696e 6365 2074 6865  sible (since the
+00018700: 2061 7574 6f73 746f 700a 2020 2020 6973   autostop.    is
+00018710: 2073 6574 2066 6f72 2074 6865 2063 6f6e   set for the con
+00018720: 7472 6f6c 6c65 7229 2062 6566 6f72 6520  troller) before 
+00018730: 7468 6520 6a6f 6273 2f73 6572 7665 2063  the jobs/serve c
+00018740: 6f6d 6d61 6e64 7320 696e 7465 7261 6374  ommands interact
+00018750: 2077 6974 6820 7468 650a 2020 2020 636f   with the.    co
+00018760: 6e74 726f 6c6c 6572 2e0a 0a20 2020 2043  ntroller...    C
+00018770: 6c75 7374 6572 4e6f 7455 7045 7272 6f72  lusterNotUpError
+00018780: 2077 696c 6c20 6265 2072 6169 7365 6420   will be raised 
+00018790: 7768 656e 6576 6572 2074 6865 2063 6f6e  whenever the con
+000187a0: 7472 6f6c 6c65 7220 6361 6e6e 6f74 2062  troller cannot b
+000187b0: 6520 6163 6365 7373 6564 2e0a 0a20 2020  e accessed...   
+000187c0: 2041 7267 733a 0a20 2020 2020 2020 2074   Args:.        t
+000187d0: 7970 653a 2054 7970 6520 6f66 2074 6865  ype: Type of the
+000187e0: 2063 6f6e 7472 6f6c 6c65 722e 0a20 2020   controller..   
+000187f0: 2020 2020 2073 746f 7070 6564 5f6d 6573       stopped_mes
+00018800: 7361 6765 3a20 4d65 7373 6167 6520 746f  sage: Message to
+00018810: 2070 7269 6e74 2069 6620 7468 6520 636f   print if the co
+00018820: 6e74 726f 6c6c 6572 2069 7320 5354 4f50  ntroller is STOP
+00018830: 5045 442e 0a20 2020 2020 2020 206e 6f6e  PED..        non
+00018840: 5f65 7869 7374 656e 745f 6d65 7373 6167  _existent_messag
+00018850: 653a 204d 6573 7361 6765 2074 6f20 7368  e: Message to sh
+00018860: 6f77 2069 6620 7468 6520 636f 6e74 726f  ow if the contro
+00018870: 6c6c 6572 2064 6f65 7320 6e6f 7420 6578  ller does not ex
+00018880: 6973 742e 0a20 2020 2020 2020 2065 7869  ist..        exi
+00018890: 745f 6966 5f6e 6f74 5f61 6363 6573 7369  t_if_not_accessi
+000188a0: 626c 653a 2057 6865 7468 6572 2074 6f20  ble: Whether to 
+000188b0: 6578 6974 2064 6972 6563 746c 7920 6966  exit directly if
+000188c0: 2074 6865 2063 6f6e 7472 6f6c 6c65 7220   the controller 
+000188d0: 6973 206e 6f74 0a20 2020 2020 2020 2020  is not.         
+000188e0: 2061 6363 6573 7369 626c 652e 2049 6620   accessible. If 
+000188f0: 4661 6c73 652c 2074 6865 2066 756e 6374  False, the funct
+00018900: 696f 6e20 7769 6c6c 2072 6169 7365 2043  ion will raise C
+00018910: 6c75 7374 6572 4e6f 7455 7045 7272 6f72  lusterNotUpError
+00018920: 2e0a 0a20 2020 2052 6574 7572 6e73 3a0a  ...    Returns:.
+00018930: 2020 2020 2020 2020 6861 6e64 6c65 3a20          handle: 
+00018940: 5468 6520 5265 736f 7572 6365 4861 6e64  The ResourceHand
+00018950: 6c65 206f 6620 7468 6520 636f 6e74 726f  le of the contro
+00018960: 6c6c 6572 2e0a 0a20 2020 2052 6169 7365  ller...    Raise
+00018970: 733a 0a20 2020 2020 2020 2065 7863 6570  s:.        excep
+00018980: 7469 6f6e 732e 436c 7573 7465 724f 776e  tions.ClusterOwn
+00018990: 6572 4964 656e 7469 7479 4d69 736d 6174  erIdentityMismat
+000189a0: 6368 4572 726f 723a 2069 6620 7468 6520  chError: if the 
+000189b0: 6375 7272 656e 7420 7573 6572 2069 7320  current user is 
+000189c0: 6e6f 740a 2020 2020 2020 2020 2020 7468  not.          th
+000189d0: 6520 7361 6d65 2061 7320 7468 6520 7573  e same as the us
+000189e0: 6572 2077 686f 2063 7265 6174 6564 2074  er who created t
+000189f0: 6865 2063 6c75 7374 6572 2e0a 2020 2020  he cluster..    
+00018a00: 2020 2020 6578 6365 7074 696f 6e73 2e43      exceptions.C
+00018a10: 6c6f 7564 5573 6572 4964 656e 7469 7479  loudUserIdentity
+00018a20: 4572 726f 723a 2069 6620 7765 2066 6169  Error: if we fai
+00018a30: 6c20 746f 2067 6574 2074 6865 2063 7572  l to get the cur
+00018a40: 7265 6e74 2075 7365 720a 2020 2020 2020  rent user.      
+00018a50: 2020 2020 6964 656e 7469 7479 2e0a 2020      identity..  
+00018a60: 2020 2020 2020 6578 6365 7074 696f 6e73        exceptions
+00018a70: 2e43 6c75 7374 6572 4e6f 7455 7045 7272  .ClusterNotUpErr
+00018a80: 6f72 3a20 6966 2074 6865 2063 6f6e 7472  or: if the contr
+00018a90: 6f6c 6c65 7220 6973 206e 6f74 2061 6363  oller is not acc
+00018aa0: 6573 7369 626c 652c 206f 720a 2020 2020  essible, or.    
+00018ab0: 2020 2020 2020 6661 696c 6564 2074 6f20        failed to 
+00018ac0: 6265 2063 6f6e 6e65 6374 6564 2e0a 2020  be connected..  
+00018ad0: 2020 2222 220a 2020 2020 6966 206e 6f6e    """.    if non
+00018ae0: 5f65 7869 7374 656e 745f 6d65 7373 6167  _existent_messag
+00018af0: 6520 6973 204e 6f6e 653a 0a20 2020 2020  e is None:.     
+00018b00: 2020 206e 6f6e 5f65 7869 7374 656e 745f     non_existent_
+00018b10: 6d65 7373 6167 6520 3d20 636f 6e74 726f  message = contro
+00018b20: 6c6c 6572 2e76 616c 7565 2e64 6566 6175  ller.value.defau
+00018b30: 6c74 5f68 696e 745f 6966 5f6e 6f6e 5f65  lt_hint_if_non_e
+00018b40: 7869 7374 656e 740a 2020 2020 636c 7573  xistent.    clus
+00018b50: 7465 725f 6e61 6d65 203d 2063 6f6e 7472  ter_name = contr
+00018b60: 6f6c 6c65 722e 7661 6c75 652e 636c 7573  oller.value.clus
+00018b70: 7465 725f 6e61 6d65 0a20 2020 206e 6565  ter_name.    nee
+00018b80: 645f 636f 6e6e 6563 7469 6f6e 5f63 6865  d_connection_che
+00018b90: 636b 203d 2046 616c 7365 0a20 2020 2063  ck = False.    c
+00018ba0: 6f6e 7472 6f6c 6c65 725f 7374 6174 7573  ontroller_status
+00018bb0: 2c20 6861 6e64 6c65 203d 204e 6f6e 652c  , handle = None,
+00018bc0: 204e 6f6e 650a 2020 2020 7472 793a 0a20   None.    try:. 
+00018bd0: 2020 2020 2020 2023 2053 6574 2066 6f72         # Set for
+00018be0: 6365 5f72 6566 7265 7368 5f73 7461 7475  ce_refresh_statu
+00018bf0: 7365 733d 5b49 4e49 545d 2074 6f20 6d61  ses=[INIT] to ma
+00018c00: 6b65 2073 7572 6520 7468 6520 7265 6672  ke sure the refr
+00018c10: 6573 6820 6861 7070 656e 730a 2020 2020  esh happens.    
+00018c20: 2020 2020 2320 7768 656e 2074 6865 2063      # when the c
+00018c30: 6f6e 7472 6f6c 6c65 7220 6973 2049 4e49  ontroller is INI
+00018c40: 542f 5550 2028 7472 6967 6765 7265 6420  T/UP (triggered 
+00018c50: 696e 2074 6865 7365 2073 7461 7475 7365  in these statuse
+00018c60: 7320 6173 2074 6865 0a20 2020 2020 2020  s as the.       
+00018c70: 2023 2061 7574 6f73 746f 7020 6973 2061   # autostop is a
+00018c80: 6c77 6179 7320 7365 7420 666f 7220 7468  lways set for th
+00018c90: 6520 636f 6e74 726f 6c6c 6572 292e 2054  e controller). T
+00018ca0: 6865 2063 6f6e 7472 6f6c 6c65 7220 6361  he controller ca
+00018cb0: 6e20 6265 2069 6e0a 2020 2020 2020 2020  n be in.        
+00018cc0: 2320 666f 6c6c 6f77 696e 6720 6361 7365  # following case
+00018cd0: 733a 0a20 2020 2020 2020 2023 202a 2028  s:.        # * (
+00018ce0: 5550 2c20 6175 746f 7374 6f70 2073 6574  UP, autostop set
+00018cf0: 293a 2069 7420 7769 6c6c 2062 6520 7265  ): it will be re
+00018d00: 6672 6573 6865 6420 7769 7468 6f75 7420  freshed without 
+00018d10: 666f 7263 655f 7265 6672 6573 6820 7365  force_refresh se
+00018d20: 742e 0a20 2020 2020 2020 2023 202a 2028  t..        # * (
+00018d30: 5550 2c20 6e6f 2061 7574 6f73 746f 7029  UP, no autostop)
+00018d40: 3a20 7665 7279 2072 6172 6520 2861 2075  : very rare (a u
+00018d50: 7365 7220 6374 726c 2d63 2077 6865 6e20  ser ctrl-c when 
+00018d60: 7468 6520 636f 6e74 726f 6c6c 6572 2069  the controller i
+00018d70: 730a 2020 2020 2020 2020 2320 2020 6c61  s.        #   la
+00018d80: 756e 6368 696e 6729 2c20 646f 6573 206e  unching), does n
+00018d90: 6f74 206d 6174 7465 7220 6966 2072 6566  ot matter if ref
+00018da0: 7265 7368 206f 7220 6e6f 742c 2073 696e  resh or not, sin
+00018db0: 6365 206e 6f20 6175 746f 7374 6f70 2e20  ce no autostop. 
+00018dc0: 5765 0a20 2020 2020 2020 2023 2020 2064  We.        #   d
+00018dd0: 6f6e 2774 2069 6e63 6c75 6465 2055 5020  on't include UP 
+00018de0: 696e 2066 6f72 6365 5f72 6566 7265 7368  in force_refresh
+00018df0: 5f73 7461 7475 7365 7320 746f 2061 766f  _statuses to avo
+00018e00: 6964 206f 7665 7268 6561 6473 2e0a 2020  id overheads..  
+00018e10: 2020 2020 2020 2320 2a20 2849 4e49 542c        # * (INIT,
+00018e20: 2061 7574 6f73 746f 7020 7365 7429 0a20   autostop set). 
+00018e30: 2020 2020 2020 2023 202a 2028 494e 4954         # * (INIT
+00018e40: 2c20 6e6f 2061 7574 6f73 746f 7029 3a20  , no autostop): 
+00018e50: 7665 7279 2072 6172 6520 285f 7570 6461  very rare (_upda
+00018e60: 7465 5f63 6c75 7374 6572 5f73 7461 7475  te_cluster_statu
+00018e70: 735f 6e6f 5f6c 6f63 6b20 6d61 790a 2020  s_no_lock may.  
+00018e80: 2020 2020 2020 2320 2020 7265 7365 7420        #   reset 
+00018e90: 6c6f 6361 6c20 6175 746f 7374 6f70 2063  local autostop c
+00018ea0: 6f6e 6669 6729 2c20 6275 7420 666f 7263  onfig), but forc
+00018eb0: 655f 7265 6672 6573 6820 7769 6c6c 206d  e_refresh will m
+00018ec0: 616b 6520 7375 7265 0a20 2020 2020 2020  ake sure.       
+00018ed0: 2023 2020 2073 7461 7475 7320 6973 2072   #   status is r
+00018ee0: 6566 7265 7368 6564 2e0a 2020 2020 2020  efreshed..      
+00018ef0: 2020 230a 2020 2020 2020 2020 2320 5765    #.        # We
+00018f00: 2061 766f 6964 7320 756e 6e65 6365 7373   avoids unnecess
+00018f10: 6172 7920 636f 7374 6c79 2072 6566 7265  ary costly refre
+00018f20: 7368 2077 6865 6e20 7468 6520 636f 6e74  sh when the cont
+00018f30: 726f 6c6c 6572 2069 7320 616c 7265 6164  roller is alread
+00018f40: 790a 2020 2020 2020 2020 2320 5354 4f50  y.        # STOP
+00018f50: 5045 442e 2054 6869 7320 6f70 7469 6d69  PED. This optimi
+00018f60: 7a61 7469 6f6e 2069 7320 6261 7365 6420  zation is based 
+00018f70: 6f6e 2074 6865 2061 7373 756d 7074 696f  on the assumptio
+00018f80: 6e20 7468 6174 2074 6865 2075 7365 720a  n that the user.
+00018f90: 2020 2020 2020 2020 2320 7769 6c6c 206e          # will n
+00018fa0: 6f74 2073 7461 7274 2074 6865 2063 6f6e  ot start the con
+00018fb0: 7472 6f6c 6c65 7220 6d61 6e75 616c 6c79  troller manually
+00018fc0: 2066 726f 6d20 7468 6520 636c 6f75 6420   from the cloud 
+00018fd0: 636f 6e73 6f6c 652e 0a20 2020 2020 2020  console..       
+00018fe0: 2023 0a20 2020 2020 2020 2023 2054 6865   #.        # The
+00018ff0: 2061 6371 7569 7265 5f6c 6f63 6b5f 7469   acquire_lock_ti
+00019000: 6d65 6f75 7420 6973 2073 6574 2074 6f20  meout is set to 
+00019010: 3020 746f 2061 766f 6964 2068 616e 6769  0 to avoid hangi
+00019020: 6e67 2074 6865 2063 6f6d 6d61 6e64 2077  ng the command w
+00019030: 6865 6e0a 2020 2020 2020 2020 2320 6d75  hen.        # mu
+00019040: 6c74 6970 6c65 206a 6f62 732e 6c61 756e  ltiple jobs.laun
+00019050: 6368 2063 6f6d 6d61 6e64 7320 6172 6520  ch commands are 
+00019060: 7275 6e6e 696e 6720 6174 2074 6865 2073  running at the s
+00019070: 616d 6520 7469 6d65 2e20 4f75 7220 6c61  ame time. Our la
+00019080: 7465 720a 2020 2020 2020 2020 2320 636f  ter.        # co
+00019090: 6465 2077 696c 6c20 6368 6563 6b20 6966  de will check if
+000190a0: 2074 6865 2063 6f6e 7472 6f6c 6c65 7220   the controller 
+000190b0: 6973 2061 6363 6573 7369 626c 6520 6279  is accessible by
+000190c0: 2064 6972 6563 746c 7920 6368 6563 6b69   directly checki
+000190d0: 6e67 0a20 2020 2020 2020 2023 2074 6865  ng.        # the
+000190e0: 2073 7368 2063 6f6e 6e65 6374 696f 6e20   ssh connection 
+000190f0: 746f 2074 6865 2063 6f6e 7472 6f6c 6c65  to the controlle
+00019100: 722c 2069 6620 6974 2066 6169 6c73 2074  r, if it fails t
+00019110: 6f20 6765 7420 6163 6375 7261 7465 0a20  o get accurate. 
+00019120: 2020 2020 2020 2023 2073 7461 7475 7320         # status 
+00019130: 6f66 2074 6865 2063 6f6e 7472 6f6c 6c65  of the controlle
+00019140: 722e 0a20 2020 2020 2020 2063 6f6e 7472  r..        contr
+00019150: 6f6c 6c65 725f 7374 6174 7573 2c20 6861  oller_status, ha
+00019160: 6e64 6c65 203d 2072 6566 7265 7368 5f63  ndle = refresh_c
+00019170: 6c75 7374 6572 5f73 7461 7475 735f 6861  luster_status_ha
+00019180: 6e64 6c65 280a 2020 2020 2020 2020 2020  ndle(.          
+00019190: 2020 636c 7573 7465 725f 6e61 6d65 2c0a    cluster_name,.
+000191a0: 2020 2020 2020 2020 2020 2020 666f 7263              forc
+000191b0: 655f 7265 6672 6573 685f 7374 6174 7573  e_refresh_status
+000191c0: 6573 3d5b 7374 6174 7573 5f6c 6962 2e43  es=[status_lib.C
+000191d0: 6c75 7374 6572 5374 6174 7573 2e49 4e49  lusterStatus.INI
+000191e0: 545d 2c0a 2020 2020 2020 2020 2020 2020  T],.            
+000191f0: 636c 7573 7465 725f 7374 6174 7573 5f6c  cluster_status_l
+00019200: 6f63 6b5f 7469 6d65 6f75 743d 3029 0a20  ock_timeout=0). 
+00019210: 2020 2065 7863 6570 7420 6578 6365 7074     except except
+00019220: 696f 6e73 2e43 6c75 7374 6572 5374 6174  ions.ClusterStat
+00019230: 7573 4665 7463 6869 6e67 4572 726f 7220  usFetchingError 
+00019240: 6173 2065 3a0a 2020 2020 2020 2020 2320  as e:.        # 
+00019250: 5765 2064 6f20 6e6f 7420 6361 7463 6820  We do not catch 
+00019260: 7468 6520 6578 6365 7074 696f 6e73 2072  the exceptions r
+00019270: 656c 6174 6564 2074 6f20 7468 6520 636c  elated to the cl
+00019280: 7573 7465 7220 6f77 6e65 7220 6964 656e  uster owner iden
+00019290: 7469 7479 0a20 2020 2020 2020 2023 206d  tity.        # m
+000192a0: 6973 6d61 7463 682c 2070 6c65 6173 6520  ismatch, please 
+000192b0: 7265 6665 7220 746f 2074 6865 2063 6f6d  refer to the com
+000192c0: 6d65 6e74 2069 6e0a 2020 2020 2020 2020  ment in.        
+000192d0: 2320 6062 6163 6b65 6e64 5f75 7469 6c73  # `backend_utils
+000192e0: 2e63 6865 636b 5f63 6c75 7374 6572 5f61  .check_cluster_a
+000192f0: 7661 696c 6162 6c65 602e 0a20 2020 2020  vailable`..     
+00019300: 2020 2063 6f6e 7472 6f6c 6c65 725f 6e61     controller_na
+00019310: 6d65 203d 2063 6f6e 7472 6f6c 6c65 722e  me = controller.
+00019320: 7661 6c75 652e 6e61 6d65 2e72 6570 6c61  value.name.repla
+00019330: 6365 2827 2063 6f6e 7472 6f6c 6c65 7227  ce(' controller'
+00019340: 2c20 2727 290a 2020 2020 2020 2020 6c6f  , '').        lo
+00019350: 6767 6572 2e77 6172 6e69 6e67 280a 2020  gger.warning(.  
+00019360: 2020 2020 2020 2020 2020 2746 6169 6c65            'Faile
+00019370: 6420 746f 2067 6574 2074 6865 2073 7461  d to get the sta
+00019380: 7475 7320 6f66 2074 6865 2063 6f6e 7472  tus of the contr
+00019390: 6f6c 6c65 722e 2049 7420 6973 206e 6f74  oller. It is not
+000193a0: 2027 0a20 2020 2020 2020 2020 2020 2066   '.            f
+000193b0: 2766 6174 616c 2c20 6275 7420 7b63 6f6e  'fatal, but {con
+000193c0: 7472 6f6c 6c65 725f 6e61 6d65 7d20 636f  troller_name} co
+000193d0: 6d6d 616e 6473 2f63 616c 6c73 206d 6179  mmands/calls may
+000193e0: 2068 616e 6720 6f72 2072 6574 7572 6e20   hang or return 
+000193f0: 270a 2020 2020 2020 2020 2020 2020 2773  '.            's
+00019400: 7461 6c65 2069 6e66 6f72 6d61 7469 6f6e  tale information
+00019410: 2c20 7768 656e 2074 6865 2063 6f6e 7472  , when the contr
+00019420: 6f6c 6c65 7220 6973 206e 6f74 2075 702e  oller is not up.
+00019430: 5c6e 270a 2020 2020 2020 2020 2020 2020  \n'.            
+00019440: 6627 2020 4465 7461 696c 733a 207b 636f  f'  Details: {co
+00019450: 6d6d 6f6e 5f75 7469 6c73 2e66 6f72 6d61  mmon_utils.forma
+00019460: 745f 6578 6365 7074 696f 6e28 652c 2075  t_exception(e, u
+00019470: 7365 5f62 7261 636b 6574 3d54 7275 6529  se_bracket=True)
+00019480: 7d27 290a 2020 2020 2020 2020 7265 636f  }').        reco
+00019490: 7264 203d 2067 6c6f 6261 6c5f 7573 6572  rd = global_user
+000194a0: 5f73 7461 7465 2e67 6574 5f63 6c75 7374  _state.get_clust
+000194b0: 6572 5f66 726f 6d5f 6e61 6d65 2863 6c75  er_from_name(clu
+000194c0: 7374 6572 5f6e 616d 6529 0a20 2020 2020  ster_name).     
+000194d0: 2020 2069 6620 7265 636f 7264 2069 7320     if record is 
+000194e0: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+000194f0: 2020 2020 2020 636f 6e74 726f 6c6c 6572        controller
+00019500: 5f73 7461 7475 732c 2068 616e 646c 6520  _status, handle 
+00019510: 3d20 7265 636f 7264 5b27 7374 6174 7573  = record['status
+00019520: 275d 2c20 7265 636f 7264 5b27 6861 6e64  '], record['hand
+00019530: 6c65 275d 0a20 2020 2020 2020 2020 2020  le'].           
+00019540: 2023 2057 6520 6368 6563 6b20 7468 6520   # We check the 
+00019550: 636f 6e6e 6563 7469 6f6e 2065 7665 6e20  connection even 
+00019560: 6966 2074 6865 2063 6c75 7374 6572 2068  if the cluster h
+00019570: 6173 2061 2063 6163 6865 6420 7374 6174  as a cached stat
+00019580: 7573 2055 500a 2020 2020 2020 2020 2020  us UP.          
+00019590: 2020 2320 746f 206d 616b 6520 7375 7265    # to make sure
+000195a0: 2074 6865 2063 6f6e 7472 6f6c 6c65 7220   the controller 
+000195b0: 6973 2061 6374 7561 6c6c 7920 6163 6365  is actually acce
+000195c0: 7373 6962 6c65 2c20 6173 2074 6865 2063  ssible, as the c
+000195d0: 6163 6865 640a 2020 2020 2020 2020 2020  ached.          
+000195e0: 2020 2320 7374 6174 7573 206d 6967 6874    # status might
+000195f0: 2062 6520 7374 616c 652e 0a20 2020 2020   be stale..     
+00019600: 2020 2020 2020 206e 6565 645f 636f 6e6e         need_conn
+00019610: 6563 7469 6f6e 5f63 6865 636b 203d 2054  ection_check = T
+00019620: 7275 650a 0a20 2020 2065 7272 6f72 5f6d  rue..    error_m
+00019630: 7367 203d 204e 6f6e 650a 2020 2020 6966  sg = None.    if
+00019640: 2063 6f6e 7472 6f6c 6c65 725f 7374 6174   controller_stat
+00019650: 7573 203d 3d20 7374 6174 7573 5f6c 6962  us == status_lib
+00019660: 2e43 6c75 7374 6572 5374 6174 7573 2e53  .ClusterStatus.S
+00019670: 544f 5050 4544 3a0a 2020 2020 2020 2020  TOPPED:.        
+00019680: 6572 726f 725f 6d73 6720 3d20 7374 6f70  error_msg = stop
+00019690: 7065 645f 6d65 7373 6167 650a 2020 2020  ped_message.    
+000196a0: 656c 6966 2063 6f6e 7472 6f6c 6c65 725f  elif controller_
+000196b0: 7374 6174 7573 2069 7320 4e6f 6e65 206f  status is None o
+000196c0: 7220 6861 6e64 6c65 2069 7320 4e6f 6e65  r handle is None
+000196d0: 206f 7220 6861 6e64 6c65 2e68 6561 645f   or handle.head_
+000196e0: 6970 2069 7320 4e6f 6e65 3a0a 2020 2020  ip is None:.    
+000196f0: 2020 2020 2320 5765 2063 6865 636b 2074      # We check t
+00019700: 6865 2063 6f6e 7472 6f6c 6c65 7220 6973  he controller is
+00019710: 2053 544f 5050 4544 2062 6566 6f72 6520   STOPPED before 
+00019720: 7468 6520 6368 6563 6b20 666f 7220 6861  the check for ha
+00019730: 6e64 6c65 2e68 6561 645f 6970 0a20 2020  ndle.head_ip.   
+00019740: 2020 2020 2023 204e 6f6e 6520 6265 6361       # None beca
+00019750: 7573 6520 7768 656e 2074 6865 2063 6f6e  use when the con
+00019760: 7472 6f6c 6c65 7220 6973 2053 544f 5050  troller is STOPP
+00019770: 4544 2c20 6861 6e64 6c65 2e68 6561 645f  ED, handle.head_
+00019780: 6970 2063 616e 2061 6c73 6f0a 2020 2020  ip can also.    
+00019790: 2020 2020 2320 6265 204e 6f6e 652c 2062      # be None, b
+000197a0: 7574 2077 6520 6f6e 6c79 2077 616e 7420  ut we only want 
+000197b0: 746f 2063 6174 6368 2074 6865 2063 6173  to catch the cas
+000197c0: 6520 7768 656e 2074 6865 2063 6f6e 7472  e when the contr
+000197d0: 6f6c 6c65 7220 6973 0a20 2020 2020 2020  oller is.       
+000197e0: 2023 2062 6569 6e67 2070 726f 7669 7369   # being provisi
+000197f0: 6f6e 6564 2061 7420 7468 6520 6669 7273  oned at the firs
+00019800: 7420 7469 6d65 2061 6e64 2068 6176 6520  t time and have 
+00019810: 6e6f 2068 6561 645f 6970 2e0a 2020 2020  no head_ip..    
+00019820: 2020 2020 6572 726f 725f 6d73 6720 3d20      error_msg = 
+00019830: 6e6f 6e5f 6578 6973 7465 6e74 5f6d 6573  non_existent_mes
+00019840: 7361 6765 0a20 2020 2065 6c69 6620 2863  sage.    elif (c
+00019850: 6f6e 7472 6f6c 6c65 725f 7374 6174 7573  ontroller_status
+00019860: 203d 3d20 7374 6174 7573 5f6c 6962 2e43   == status_lib.C
+00019870: 6c75 7374 6572 5374 6174 7573 2e49 4e49  lusterStatus.INI
+00019880: 5420 6f72 0a20 2020 2020 2020 2020 206e  T or.          n
+00019890: 6565 645f 636f 6e6e 6563 7469 6f6e 5f63  eed_connection_c
+000198a0: 6865 636b 293a 0a20 2020 2020 2020 2023  heck):.        #
+000198b0: 2043 6865 636b 2073 7368 2063 6f6e 6e65   Check ssh conne
+000198c0: 6374 696f 6e20 6966 2028 3129 2063 6f6e  ction if (1) con
+000198d0: 7472 6f6c 6c65 7220 6973 2069 6e20 494e  troller is in IN
+000198e0: 4954 2073 7461 7465 2c20 6f72 2028 3229  IT state, or (2)
+000198f0: 2077 6520 6661 696c 6564 2074 6f20 6665   we failed to fe
+00019900: 7463 6820 7468 650a 2020 2020 2020 2020  tch the.        
+00019910: 2320 7374 6174 7573 2c20 626f 7468 206f  # status, both o
+00019920: 6620 7768 6963 6820 6361 6e20 6861 7070  f which can happ
+00019930: 656e 2077 6865 6e20 636f 6e74 726f 6c6c  en when controll
+00019940: 6572 2773 2073 7461 7475 7320 6c6f 636b  er's status lock
+00019950: 2069 7320 6865 6c64 2062 7920 616e 6f74   is held by anot
+00019960: 6865 7220 6073 6b79 206a 6f62 7320 6c61  her `sky jobs la
+00019970: 756e 6368 6020 6f72 0a20 2020 2020 2020  unch` or.       
+00019980: 2023 2060 736b 7920 7365 7276 6520 7570   # `sky serve up
+00019990: 602e 2049 6620 7765 2068 6176 65c2 a063  `. If we have..c
+000199a0: 6f6e 7472 6f6c 6c65 7227 7320 6865 6164  ontroller's head
+000199b0: 5f69 7020 6176 6169 6c61 626c 6520 616e  _ip available an
+000199c0: 6420 6974 2069 7320 7373 682d 7265 6163  d it is ssh-reac
+000199d0: 6861 626c 652c 0a20 2020 2020 2020 2023  hable,.        #
+000199e0: 2077 6520 6361 6e20 616c 6c6f 7720 6163   we can allow ac
+000199f0: 6365 7373 2074 6f20 7468 6520 636f 6e74  cess to the cont
+00019a00: 726f 6c6c 6572 2e0a 2020 2020 2020 2020  roller..        
+00019a10: 7373 685f 6372 6564 656e 7469 616c 7320  ssh_credentials 
+00019a20: 3d20 7373 685f 6372 6564 656e 7469 616c  = ssh_credential
+00019a30: 5f66 726f 6d5f 7961 6d6c 2868 616e 646c  _from_yaml(handl
+00019a40: 652e 636c 7573 7465 725f 7961 6d6c 2c0a  e.cluster_yaml,.
+00019a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00019a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019aa0: 2020 6861 6e64 6c65 2e64 6f63 6b65 725f    handle.docker_
-00019ab0: 7573 6572 2c0a 2020 2020 2020 2020 2020  user,.          
-00019ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019ae0: 2020 2020 2020 2020 2068 616e 646c 652e           handle.
-00019af0: 7373 685f 7573 6572 290a 0a20 2020 2020  ssh_user)..     
-00019b00: 2020 2072 756e 6e65 7220 3d20 636f 6d6d     runner = comm
-00019b10: 616e 645f 7275 6e6e 6572 2e53 5348 436f  and_runner.SSHCo
-00019b20: 6d6d 616e 6452 756e 6e65 7228 6861 6e64  mmandRunner(hand
-00019b30: 6c65 2e68 6561 645f 6970 2c0a 2020 2020  le.head_ip,.    
-00019b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019b60: 2020 2020 2020 2020 2020 2020 202a 2a73               **s
-00019b70: 7368 5f63 7265 6465 6e74 6961 6c73 2c0a  sh_credentials,.
+00019a80: 2020 2068 616e 646c 652e 646f 636b 6572     handle.docker
+00019a90: 5f75 7365 722c 0a20 2020 2020 2020 2020  _user,.         
+00019aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019ac0: 2020 2020 2020 2020 2020 6861 6e64 6c65            handle
+00019ad0: 2e73 7368 5f75 7365 7229 0a0a 2020 2020  .ssh_user)..    
+00019ae0: 2020 2020 7275 6e6e 6572 203d 2063 6f6d      runner = com
+00019af0: 6d61 6e64 5f72 756e 6e65 722e 5353 4843  mand_runner.SSHC
+00019b00: 6f6d 6d61 6e64 5275 6e6e 6572 2868 616e  ommandRunner(han
+00019b10: 646c 652e 6865 6164 5f69 702c 0a20 2020  dle.head_ip,.   
+00019b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019b40: 2020 2020 2020 2020 2020 2020 2020 2a2a                **
+00019b50: 7373 685f 6372 6564 656e 7469 616c 732c  ssh_credentials,
+00019b60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00019b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019bb0: 2070 6f72 743d 6861 6e64 6c65 2e68 6561   port=handle.hea
-00019bc0: 645f 7373 685f 706f 7274 290a 2020 2020  d_ssh_port).    
-00019bd0: 2020 2020 6966 206e 6f74 2072 756e 6e65      if not runne
-00019be0: 722e 6368 6563 6b5f 636f 6e6e 6563 7469  r.check_connecti
-00019bf0: 6f6e 2829 3a0a 2020 2020 2020 2020 2020  on():.          
-00019c00: 2020 6572 726f 725f 6d73 6720 3d20 636f    error_msg = co
-00019c10: 6e74 726f 6c6c 6572 5f74 7970 652e 7661  ntroller_type.va
-00019c20: 6c75 652e 636f 6e6e 6563 7469 6f6e 5f65  lue.connection_e
-00019c30: 7272 6f72 5f68 696e 740a 2020 2020 656c  rror_hint.    el
-00019c40: 7365 3a0a 2020 2020 2020 2020 6173 7365  se:.        asse
-00019c50: 7274 2063 6f6e 7472 6f6c 6c65 725f 7374  rt controller_st
-00019c60: 6174 7573 203d 3d20 7374 6174 7573 5f6c  atus == status_l
-00019c70: 6962 2e43 6c75 7374 6572 5374 6174 7573  ib.ClusterStatus
-00019c80: 2e55 502c 2068 616e 646c 650a 0a20 2020  .UP, handle..   
-00019c90: 2069 6620 6572 726f 725f 6d73 6720 6973   if error_msg is
-00019ca0: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-00019cb0: 2020 2069 6620 6578 6974 5f69 665f 6e6f     if exit_if_no
-00019cc0: 745f 6163 6365 7373 6962 6c65 3a0a 2020  t_accessible:.  
-00019cd0: 2020 2020 2020 2020 2020 736b 795f 6c6f            sky_lo
-00019ce0: 6767 696e 672e 7072 696e 7428 6572 726f  gging.print(erro
-00019cf0: 725f 6d73 6729 0a20 2020 2020 2020 2020  r_msg).         
-00019d00: 2020 2073 7973 2e65 7869 7428 3129 0a20     sys.exit(1). 
-00019d10: 2020 2020 2020 2077 6974 6820 7578 5f75         with ux_u
-00019d20: 7469 6c73 2e70 7269 6e74 5f65 7863 6570  tils.print_excep
-00019d30: 7469 6f6e 5f6e 6f5f 7472 6163 6562 6163  tion_no_tracebac
-00019d40: 6b28 293a 0a20 2020 2020 2020 2020 2020  k():.           
-00019d50: 2072 6169 7365 2065 7863 6570 7469 6f6e   raise exception
-00019d60: 732e 436c 7573 7465 724e 6f74 5570 4572  s.ClusterNotUpEr
-00019d70: 726f 7228 6572 726f 725f 6d73 672c 0a20  ror(error_msg,. 
-00019d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019da0: 2020 2020 2020 2020 2020 2020 2020 636c                cl
-00019db0: 7573 7465 725f 7374 6174 7573 3d63 6f6e  uster_status=con
-00019dc0: 7472 6f6c 6c65 725f 7374 6174 7573 2c0a  troller_status,.
-00019dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019df0: 2020 2020 2020 2020 2020 2020 2020 2068                 h
-00019e00: 616e 646c 653d 6861 6e64 6c65 290a 2020  andle=handle).  
-00019e10: 2020 6173 7365 7274 2068 616e 646c 6520    assert handle 
-00019e20: 6973 206e 6f74 204e 6f6e 6520 616e 6420  is not None and 
-00019e30: 6861 6e64 6c65 2e68 6561 645f 6970 2069  handle.head_ip i
-00019e40: 7320 6e6f 7420 4e6f 6e65 2c20 280a 2020  s not None, (.  
-00019e50: 2020 2020 2020 6861 6e64 6c65 2c20 636f        handle, co
-00019e60: 6e74 726f 6c6c 6572 5f73 7461 7475 7329  ntroller_status)
-00019e70: 0a20 2020 2072 6574 7572 6e20 6861 6e64  .    return hand
-00019e80: 6c65 0a0a 0a63 6c61 7373 2043 6c6f 7564  le...class Cloud
-00019e90: 4669 6c74 6572 2865 6e75 6d2e 456e 756d  Filter(enum.Enum
-00019ea0: 293a 0a20 2020 2023 2046 696c 7465 7220  ):.    # Filter 
-00019eb0: 666f 7220 616c 6c20 7479 7065 7320 6f66  for all types of
-00019ec0: 2063 6c6f 7564 732e 0a20 2020 2041 4c4c   clouds..    ALL
-00019ed0: 203d 2027 616c 6c27 0a20 2020 2023 2046   = 'all'.    # F
-00019ee0: 696c 7465 7220 666f 7220 536b 7927 7320  ilter for Sky's 
-00019ef0: 6d61 696e 2063 6c6f 7564 7320 2861 7773  main clouds (aws
-00019f00: 2c20 6763 702c 2061 7a75 7265 2c20 646f  , gcp, azure, do
-00019f10: 636b 6572 292e 0a20 2020 2043 4c4f 5544  cker)..    CLOUD
-00019f20: 535f 414e 445f 444f 434b 4552 203d 2027  S_AND_DOCKER = '
-00019f30: 636c 6f75 6473 2d61 6e64 2d64 6f63 6b65  clouds-and-docke
-00019f40: 7227 0a20 2020 2023 2046 696c 7465 7220  r'.    # Filter 
-00019f50: 666f 7220 6f6e 6c79 206c 6f63 616c 2063  for only local c
-00019f60: 6c6f 7564 732e 0a20 2020 204c 4f43 414c  louds..    LOCAL
-00019f70: 203d 2027 6c6f 6361 6c27 0a0a 0a64 6566   = 'local'...def
-00019f80: 2067 6574 5f63 6c75 7374 6572 7328 0a20   get_clusters(. 
-00019f90: 2020 2069 6e63 6c75 6465 5f63 6f6e 7472     include_contr
-00019fa0: 6f6c 6c65 723a 2062 6f6f 6c2c 0a20 2020  oller: bool,.   
-00019fb0: 2072 6566 7265 7368 3a20 626f 6f6c 2c0a   refresh: bool,.
-00019fc0: 2020 2020 636c 7573 7465 725f 6e61 6d65      cluster_name
-00019fd0: 733a 204f 7074 696f 6e61 6c5b 556e 696f  s: Optional[Unio
-00019fe0: 6e5b 7374 722c 204c 6973 745b 7374 725d  n[str, List[str]
-00019ff0: 5d5d 203d 204e 6f6e 652c 0a29 202d 3e20  ]] = None,.) -> 
-0001a000: 4c69 7374 5b44 6963 745b 7374 722c 2041  List[Dict[str, A
-0001a010: 6e79 5d5d 3a0a 2020 2020 2222 2252 6574  ny]]:.    """Ret
-0001a020: 7572 6e73 2061 206c 6973 7420 6f66 2063  urns a list of c
-0001a030: 6163 6865 6420 6f72 206f 7074 696f 6e61  ached or optiona
-0001a040: 6c6c 7920 7265 6672 6573 6865 6420 636c  lly refreshed cl
-0001a050: 7573 7465 7220 7265 636f 7264 732e 0a0a  uster records...
-0001a060: 2020 2020 436f 6d62 7320 7468 726f 7567      Combs throug
-0001a070: 6820 7468 6520 6461 7461 6261 7365 2028  h the database (
-0001a080: 696e 207e 2f2e 736b 792f 7374 6174 652e  in ~/.sky/state.
-0001a090: 6462 2920 746f 2067 6574 2061 206c 6973  db) to get a lis
-0001a0a0: 7420 6f66 2072 6563 6f72 6473 0a20 2020  t of records.   
-0001a0b0: 2063 6f72 7265 7370 6f6e 6469 6e67 2074   corresponding t
-0001a0c0: 6f20 6c61 756e 6368 6564 2063 6c75 7374  o launched clust
-0001a0d0: 6572 7320 2866 696c 7465 7265 6420 6279  ers (filtered by
-0001a0e0: 2060 636c 7573 7465 725f 6e61 6d65 7360   `cluster_names`
-0001a0f0: 2069 6620 6974 2069 730a 2020 2020 7370   if it is.    sp
-0001a100: 6563 6966 6965 6429 2e20 5468 6520 7265  ecified). The re
-0001a110: 6672 6573 6820 666c 6167 2063 616e 2062  fresh flag can b
-0001a120: 6520 7573 6564 2074 6f20 666f 7263 6520  e used to force 
-0001a130: 6120 7265 6672 6573 6820 6f66 2074 6865  a refresh of the
-0001a140: 2073 7461 7475 730a 2020 2020 6f66 2074   status.    of t
-0001a150: 6865 2063 6c75 7374 6572 732e 0a0a 2020  he clusters...  
-0001a160: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
-0001a170: 696e 636c 7564 655f 636f 6e74 726f 6c6c  include_controll
-0001a180: 6572 3a20 5768 6574 6865 7220 746f 2069  er: Whether to i
-0001a190: 6e63 6c75 6465 2063 6f6e 7472 6f6c 6c65  nclude controlle
-0001a1a0: 7273 2c20 652e 672e 2073 706f 7420 636f  rs, e.g. spot co
-0001a1b0: 6e74 726f 6c6c 6572 0a20 2020 2020 2020  ntroller.       
-0001a1c0: 2020 2020 206f 7220 736b 7920 7365 7276       or sky serv
-0001a1d0: 6520 636f 6e74 726f 6c6c 6572 2e0a 2020  e controller..  
-0001a1e0: 2020 2020 2020 7265 6672 6573 683a 2057        refresh: W
-0001a1f0: 6865 7468 6572 2074 6f20 7265 6672 6573  hether to refres
-0001a200: 6820 7468 6520 7374 6174 7573 206f 6620  h the status of 
-0001a210: 7468 6520 636c 7573 7465 7273 2e20 2852  the clusters. (R
-0001a220: 6566 7265 7368 696e 6720 7769 6c6c 0a20  efreshing will. 
-0001a230: 2020 2020 2020 2020 2020 2073 6574 2074             set t
-0001a240: 6865 2073 7461 7475 7320 746f 2053 544f  he status to STO
-0001a250: 5050 4544 2069 6620 7468 6520 636c 7573  PPED if the clus
-0001a260: 7465 7220 6361 6e6e 6f74 2062 6520 7069  ter cannot be pi
-0001a270: 6e67 6564 2e29 0a20 2020 2020 2020 2063  nged.).        c
-0001a280: 6c6f 7564 5f66 696c 7465 723a 2053 6574  loud_filter: Set
-0001a290: 7320 7768 6963 6820 636c 6f75 6473 2074  s which clouds t
-0001a2a0: 6f20 6669 6c65 7220 7468 726f 7567 6820  o filer through 
-0001a2b0: 6672 6f6d 2074 6865 2067 6c6f 6261 6c20  from the global 
-0001a2c0: 7573 6572 0a20 2020 2020 2020 2020 2020  user.           
-0001a2d0: 2073 7461 7465 2e20 5375 7070 6f72 7473   state. Supports
-0001a2e0: 2074 6872 6565 2076 616c 7565 732c 2027   three values, '
-0001a2f0: 616c 6c27 2066 6f72 2061 6c6c 2063 6c6f  all' for all clo
-0001a300: 7564 732c 2027 7075 626c 6963 2720 666f  uds, 'public' fo
-0001a310: 720a 2020 2020 2020 2020 2020 2020 7075  r.            pu
-0001a320: 626c 6963 2063 6c6f 7564 7320 6f6e 6c79  blic clouds only
-0001a330: 2c20 616e 6420 276c 6f63 616c 2720 666f  , and 'local' fo
-0001a340: 7220 6f6e 6c79 206c 6f63 616c 2063 6c6f  r only local clo
-0001a350: 7564 732e 0a20 2020 2020 2020 2063 6c75  uds..        clu
-0001a360: 7374 6572 5f6e 616d 6573 3a20 4966 2070  ster_names: If p
-0001a370: 726f 7669 6465 642c 206f 6e6c 7920 7265  rovided, only re
-0001a380: 7475 726e 2072 6563 6f72 6473 2066 6f72  turn records for
-0001a390: 2074 6865 2067 6976 656e 2063 6c75 7374   the given clust
-0001a3a0: 6572 0a20 2020 2020 2020 2020 2020 206e  er.            n
-0001a3b0: 616d 6573 2e0a 0a20 2020 2052 6574 7572  ames...    Retur
-0001a3c0: 6e73 3a0a 2020 2020 2020 2020 4120 6c69  ns:.        A li
-0001a3d0: 7374 206f 6620 636c 7573 7465 7220 7265  st of cluster re
-0001a3e0: 636f 7264 732e 2049 6620 7468 6520 636c  cords. If the cl
-0001a3f0: 7573 7465 7220 646f 6573 206e 6f74 2065  uster does not e
-0001a400: 7869 7374 206f 7220 6861 7320 6265 656e  xist or has been
-0001a410: 0a20 2020 2020 2020 2074 6572 6d69 6e61  .        termina
-0001a420: 7465 642c 2074 6865 2072 6563 6f72 6420  ted, the record 
-0001a430: 7769 6c6c 2062 6520 6f6d 6974 7465 6420  will be omitted 
-0001a440: 6672 6f6d 2074 6865 2072 6574 7572 6e65  from the returne
-0001a450: 6420 6c69 7374 2e0a 2020 2020 2222 220a  d list..    """.
-0001a460: 2020 2020 7265 636f 7264 7320 3d20 676c      records = gl
-0001a470: 6f62 616c 5f75 7365 725f 7374 6174 652e  obal_user_state.
-0001a480: 6765 745f 636c 7573 7465 7273 2829 0a0a  get_clusters()..
-0001a490: 2020 2020 6966 206e 6f74 2069 6e63 6c75      if not inclu
-0001a4a0: 6465 5f63 6f6e 7472 6f6c 6c65 723a 0a20  de_controller:. 
-0001a4b0: 2020 2020 2020 2072 6563 6f72 6473 203d         records =
-0001a4c0: 205b 0a20 2020 2020 2020 2020 2020 2072   [.            r
-0001a4d0: 6563 6f72 6420 666f 7220 7265 636f 7264  ecord for record
-0001a4e0: 2069 6e20 7265 636f 7264 730a 2020 2020   in records.    
-0001a4f0: 2020 2020 2020 2020 6966 2063 6f6e 7472          if contr
-0001a500: 6f6c 6c65 725f 7574 696c 732e 436f 6e74  oller_utils.Cont
-0001a510: 726f 6c6c 6572 732e 6672 6f6d 5f6e 616d  rollers.from_nam
-0001a520: 6528 7265 636f 7264 5b27 6e61 6d65 275d  e(record['name']
-0001a530: 2920 6973 204e 6f6e 650a 2020 2020 2020  ) is None.      
-0001a540: 2020 5d0a 0a20 2020 2079 656c 6c6f 7720    ]..    yellow 
-0001a550: 3d20 636f 6c6f 7261 6d61 2e46 6f72 652e  = colorama.Fore.
-0001a560: 5945 4c4c 4f57 0a20 2020 2062 7269 6768  YELLOW.    brigh
-0001a570: 7420 3d20 636f 6c6f 7261 6d61 2e53 7479  t = colorama.Sty
-0001a580: 6c65 2e42 5249 4748 540a 2020 2020 7265  le.BRIGHT.    re
-0001a590: 7365 7420 3d20 636f 6c6f 7261 6d61 2e53  set = colorama.S
-0001a5a0: 7479 6c65 2e52 4553 4554 5f41 4c4c 0a0a  tyle.RESET_ALL..
-0001a5b0: 2020 2020 6966 2063 6c75 7374 6572 5f6e      if cluster_n
-0001a5c0: 616d 6573 2069 7320 6e6f 7420 4e6f 6e65  ames is not None
-0001a5d0: 3a0a 2020 2020 2020 2020 6966 2069 7369  :.        if isi
-0001a5e0: 6e73 7461 6e63 6528 636c 7573 7465 725f  nstance(cluster_
-0001a5f0: 6e61 6d65 732c 2073 7472 293a 0a20 2020  names, str):.   
-0001a600: 2020 2020 2020 2020 2063 6c75 7374 6572           cluster
-0001a610: 5f6e 616d 6573 203d 205b 636c 7573 7465  _names = [cluste
-0001a620: 725f 6e61 6d65 735d 0a20 2020 2020 2020  r_names].       
-0001a630: 206e 6577 5f72 6563 6f72 6473 203d 205b   new_records = [
-0001a640: 5d0a 2020 2020 2020 2020 6e6f 745f 6578  ].        not_ex
-0001a650: 6973 745f 636c 7573 7465 725f 6e61 6d65  ist_cluster_name
-0001a660: 7320 3d20 5b5d 0a20 2020 2020 2020 2066  s = [].        f
-0001a670: 6f72 2063 6c75 7374 6572 5f6e 616d 6520  or cluster_name 
-0001a680: 696e 2063 6c75 7374 6572 5f6e 616d 6573  in cluster_names
-0001a690: 3a0a 2020 2020 2020 2020 2020 2020 666f  :.            fo
-0001a6a0: 7220 7265 636f 7264 2069 6e20 7265 636f  r record in reco
-0001a6b0: 7264 733a 0a20 2020 2020 2020 2020 2020  rds:.           
-0001a6c0: 2020 2020 2069 6620 7265 636f 7264 5b27       if record['
-0001a6d0: 6e61 6d65 275d 203d 3d20 636c 7573 7465  name'] == cluste
-0001a6e0: 725f 6e61 6d65 3a0a 2020 2020 2020 2020  r_name:.        
-0001a6f0: 2020 2020 2020 2020 2020 2020 6e65 775f              new_
-0001a700: 7265 636f 7264 732e 6170 7065 6e64 2872  records.append(r
-0001a710: 6563 6f72 6429 0a20 2020 2020 2020 2020  ecord).         
-0001a720: 2020 2020 2020 2020 2020 2062 7265 616b             break
-0001a730: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-0001a740: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0001a750: 2020 206e 6f74 5f65 7869 7374 5f63 6c75     not_exist_clu
-0001a760: 7374 6572 5f6e 616d 6573 2e61 7070 656e  ster_names.appen
-0001a770: 6428 636c 7573 7465 725f 6e61 6d65 290a  d(cluster_name).
-0001a780: 2020 2020 2020 2020 6966 206e 6f74 5f65          if not_e
-0001a790: 7869 7374 5f63 6c75 7374 6572 5f6e 616d  xist_cluster_nam
-0001a7a0: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
-0001a7b0: 636c 7573 7465 7273 5f73 7472 203d 2027  clusters_str = '
-0001a7c0: 2c20 272e 6a6f 696e 286e 6f74 5f65 7869  , '.join(not_exi
-0001a7d0: 7374 5f63 6c75 7374 6572 5f6e 616d 6573  st_cluster_names
-0001a7e0: 290a 2020 2020 2020 2020 2020 2020 6c6f  ).            lo
-0001a7f0: 6767 6572 2e69 6e66 6f28 6627 436c 7573  gger.info(f'Clus
-0001a800: 7465 7228 7329 206e 6f74 2066 6f75 6e64  ter(s) not found
-0001a810: 3a20 7b62 7269 6768 747d 7b63 6c75 7374  : {bright}{clust
-0001a820: 6572 735f 7374 727d 7b72 6573 6574 7d2e  ers_str}{reset}.
-0001a830: 2729 0a20 2020 2020 2020 2072 6563 6f72  ').        recor
-0001a840: 6473 203d 206e 6577 5f72 6563 6f72 6473  ds = new_records
-0001a850: 0a0a 2020 2020 6966 206e 6f74 2072 6566  ..    if not ref
-0001a860: 7265 7368 3a0a 2020 2020 2020 2020 7265  resh:.        re
-0001a870: 7475 726e 2072 6563 6f72 6473 0a0a 2020  turn records..  
-0001a880: 2020 706c 7572 616c 203d 2027 7327 2069    plural = 's' i
-0001a890: 6620 6c65 6e28 7265 636f 7264 7329 203e  f len(records) >
-0001a8a0: 2031 2065 6c73 6520 2727 0a20 2020 2070   1 else ''.    p
-0001a8b0: 726f 6772 6573 7320 3d20 7269 6368 5f70  rogress = rich_p
-0001a8c0: 726f 6772 6573 732e 5072 6f67 7265 7373  rogress.Progress
-0001a8d0: 2874 7261 6e73 6965 6e74 3d54 7275 652c  (transient=True,
-0001a8e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001a8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a900: 2020 2020 2020 2072 6564 6972 6563 745f         redirect_
-0001a910: 7374 646f 7574 3d46 616c 7365 2c0a 2020  stdout=False,.  
-0001a920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a940: 2020 2020 7265 6469 7265 6374 5f73 7464      redirect_std
-0001a950: 6572 723d 4661 6c73 6529 0a20 2020 2074  err=False).    t
-0001a960: 6173 6b20 3d20 7072 6f67 7265 7373 2e61  ask = progress.a
-0001a970: 6464 5f74 6173 6b28 0a20 2020 2020 2020  dd_task(.       
-0001a980: 2066 275b 626f 6c64 2063 7961 6e5d 5265   f'[bold cyan]Re
-0001a990: 6672 6573 6869 6e67 2073 7461 7475 7320  freshing status 
-0001a9a0: 666f 7220 7b6c 656e 2872 6563 6f72 6473  for {len(records
-0001a9b0: 297d 2063 6c75 7374 6572 7b70 6c75 7261  )} cluster{plura
-0001a9c0: 6c7d 5b2f 5d27 2c0a 2020 2020 2020 2020  l}[/]',.        
-0001a9d0: 746f 7461 6c3d 6c65 6e28 7265 636f 7264  total=len(record
-0001a9e0: 7329 290a 0a20 2020 2064 6566 205f 7265  s))..    def _re
-0001a9f0: 6672 6573 685f 636c 7573 7465 7228 636c  fresh_cluster(cl
-0001aa00: 7573 7465 725f 6e61 6d65 293a 0a20 2020  uster_name):.   
-0001aa10: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-0001aa20: 2020 2020 2020 7265 636f 7264 203d 2072        record = r
-0001aa30: 6566 7265 7368 5f63 6c75 7374 6572 5f72  efresh_cluster_r
-0001aa40: 6563 6f72 6428 0a20 2020 2020 2020 2020  ecord(.         
-0001aa50: 2020 2020 2020 2063 6c75 7374 6572 5f6e         cluster_n
-0001aa60: 616d 652c 0a20 2020 2020 2020 2020 2020  ame,.           
-0001aa70: 2020 2020 2066 6f72 6365 5f72 6566 7265       force_refre
-0001aa80: 7368 5f73 7461 7475 7365 733d 7365 7428  sh_statuses=set(
-0001aa90: 7374 6174 7573 5f6c 6962 2e43 6c75 7374  status_lib.Clust
-0001aaa0: 6572 5374 6174 7573 292c 0a20 2020 2020  erStatus),.     
-0001aab0: 2020 2020 2020 2020 2020 2061 6371 7569             acqui
-0001aac0: 7265 5f70 6572 5f63 6c75 7374 6572 5f73  re_per_cluster_s
-0001aad0: 7461 7475 735f 6c6f 636b 3d54 7275 6529  tatus_lock=True)
-0001aae0: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
-0001aaf0: 2865 7863 6570 7469 6f6e 732e 436c 7573  (exceptions.Clus
-0001ab00: 7465 7253 7461 7475 7346 6574 6368 696e  terStatusFetchin
-0001ab10: 6745 7272 6f72 2c0a 2020 2020 2020 2020  gError,.        
-0001ab20: 2020 2020 2020 2020 6578 6365 7074 696f          exceptio
-0001ab30: 6e73 2e43 6c6f 7564 5573 6572 4964 656e  ns.CloudUserIden
-0001ab40: 7469 7479 4572 726f 722c 0a20 2020 2020  tityError,.     
-0001ab50: 2020 2020 2020 2020 2020 2065 7863 6570             excep
-0001ab60: 7469 6f6e 732e 436c 7573 7465 724f 776e  tions.ClusterOwn
-0001ab70: 6572 4964 656e 7469 7479 4d69 736d 6174  erIdentityMismat
-0001ab80: 6368 4572 726f 7229 2061 7320 653a 0a20  chError) as e:. 
-0001ab90: 2020 2020 2020 2020 2020 2023 2044 6f20             # Do 
-0001aba0: 6e6f 7420 6661 696c 2074 6865 2065 6e74  not fail the ent
-0001abb0: 6972 6520 7265 6672 6573 6820 7072 6f63  ire refresh proc
-0001abc0: 6573 732e 2054 6865 2063 616c 6c65 7220  ess. The caller 
-0001abd0: 7769 6c6c 0a20 2020 2020 2020 2020 2020  will.           
-0001abe0: 2023 2068 616e 646c 6520 7468 6520 2755   # handle the 'U
-0001abf0: 4e4b 4e4f 574e 2720 7374 6174 7573 2c20  NKNOWN' status, 
-0001ac00: 616e 6420 636f 6c6c 6563 7420 7468 6520  and collect the 
-0001ac10: 6572 726f 7273 2069 6e74 6f0a 2020 2020  errors into.    
-0001ac20: 2020 2020 2020 2020 2320 6120 7461 626c          # a tabl
-0001ac30: 652e 0a20 2020 2020 2020 2020 2020 2072  e..            r
-0001ac40: 6563 6f72 6420 3d20 7b27 7374 6174 7573  ecord = {'status
-0001ac50: 273a 2027 554e 4b4e 4f57 4e27 2c20 2765  ': 'UNKNOWN', 'e
-0001ac60: 7272 6f72 273a 2065 7d0a 2020 2020 2020  rror': e}.      
-0001ac70: 2020 7072 6f67 7265 7373 2e75 7064 6174    progress.updat
-0001ac80: 6528 7461 736b 2c20 6164 7661 6e63 653d  e(task, advance=
-0001ac90: 3129 0a20 2020 2020 2020 2072 6574 7572  1).        retur
-0001aca0: 6e20 7265 636f 7264 0a0a 2020 2020 636c  n record..    cl
-0001acb0: 7573 7465 725f 6e61 6d65 7320 3d20 5b72  uster_names = [r
-0001acc0: 6563 6f72 645b 276e 616d 6527 5d20 666f  ecord['name'] fo
-0001acd0: 7220 7265 636f 7264 2069 6e20 7265 636f  r record in reco
-0001ace0: 7264 735d 0a20 2020 2077 6974 6820 7072  rds].    with pr
-0001acf0: 6f67 7265 7373 3a0a 2020 2020 2020 2020  ogress:.        
-0001ad00: 7570 6461 7465 645f 7265 636f 7264 7320  updated_records 
-0001ad10: 3d20 7375 6270 726f 6365 7373 5f75 7469  = subprocess_uti
-0001ad20: 6c73 2e72 756e 5f69 6e5f 7061 7261 6c6c  ls.run_in_parall
-0001ad30: 656c 280a 2020 2020 2020 2020 2020 2020  el(.            
-0001ad40: 5f72 6566 7265 7368 5f63 6c75 7374 6572  _refresh_cluster
-0001ad50: 2c20 636c 7573 7465 725f 6e61 6d65 7329  , cluster_names)
-0001ad60: 0a0a 2020 2020 2320 5368 6f77 2069 6e66  ..    # Show inf
-0001ad70: 6f72 6d61 7469 6f6e 2066 6f72 2072 656d  ormation for rem
-0001ad80: 6f76 6564 2063 6c75 7374 6572 732e 0a20  oved clusters.. 
-0001ad90: 2020 206b 6570 745f 7265 636f 7264 7320     kept_records 
-0001ada0: 3d20 5b5d 0a20 2020 2061 7574 6f64 6f77  = [].    autodow
-0001adb0: 6e5f 636c 7573 7465 7273 2c20 7265 6d61  n_clusters, rema
-0001adc0: 696e 696e 675f 636c 7573 7465 7273 2c20  ining_clusters, 
-0001add0: 6661 696c 6564 5f63 6c75 7374 6572 7320  failed_clusters 
-0001ade0: 3d20 5b5d 2c20 5b5d 2c20 5b5d 0a20 2020  = [], [], [].   
-0001adf0: 2066 6f72 2069 2c20 7265 636f 7264 2069   for i, record i
-0001ae00: 6e20 656e 756d 6572 6174 6528 7265 636f  n enumerate(reco
-0001ae10: 7264 7329 3a0a 2020 2020 2020 2020 6966  rds):.        if
-0001ae20: 2075 7064 6174 6564 5f72 6563 6f72 6473   updated_records
-0001ae30: 5b69 5d20 6973 204e 6f6e 653a 0a20 2020  [i] is None:.   
-0001ae40: 2020 2020 2020 2020 2069 6620 7265 636f           if reco
-0001ae50: 7264 5b27 746f 5f64 6f77 6e27 5d3a 0a20  rd['to_down']:. 
-0001ae60: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-0001ae70: 7574 6f64 6f77 6e5f 636c 7573 7465 7273  utodown_clusters
-0001ae80: 2e61 7070 656e 6428 636c 7573 7465 725f  .append(cluster_
-0001ae90: 6e61 6d65 735b 695d 290a 2020 2020 2020  names[i]).      
-0001aea0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0001aeb0: 2020 2020 2020 2020 2020 2020 7265 6d61              rema
-0001aec0: 696e 696e 675f 636c 7573 7465 7273 2e61  ining_clusters.a
-0001aed0: 7070 656e 6428 636c 7573 7465 725f 6e61  ppend(cluster_na
-0001aee0: 6d65 735b 695d 290a 2020 2020 2020 2020  mes[i]).        
-0001aef0: 656c 6966 2075 7064 6174 6564 5f72 6563  elif updated_rec
-0001af00: 6f72 6473 5b69 5d5b 2773 7461 7475 7327  ords[i]['status'
-0001af10: 5d20 3d3d 2027 554e 4b4e 4f57 4e27 3a0a  ] == 'UNKNOWN':.
-0001af20: 2020 2020 2020 2020 2020 2020 6661 696c              fail
-0001af30: 6564 5f63 6c75 7374 6572 732e 6170 7065  ed_clusters.appe
-0001af40: 6e64 280a 2020 2020 2020 2020 2020 2020  nd(.            
-0001af50: 2020 2020 2863 6c75 7374 6572 5f6e 616d      (cluster_nam
-0001af60: 6573 5b69 5d2c 2075 7064 6174 6564 5f72  es[i], updated_r
-0001af70: 6563 6f72 6473 5b69 5d5b 2765 7272 6f72  ecords[i]['error
-0001af80: 275d 2929 0a20 2020 2020 2020 2020 2020  '])).           
-0001af90: 2023 204b 6565 7020 7468 6520 6f72 6967   # Keep the orig
-0001afa0: 696e 616c 2072 6563 6f72 6420 6966 2074  inal record if t
-0001afb0: 6865 2073 7461 7475 7320 6973 2075 6e6b  he status is unk
-0001afc0: 6e6f 776e 2c0a 2020 2020 2020 2020 2020  nown,.          
-0001afd0: 2020 2320 736f 2074 6861 7420 7468 6520    # so that the 
-0001afe0: 7573 6572 2063 616e 2073 7469 6c6c 2073  user can still s
-0001aff0: 6565 2074 6865 2063 6c75 7374 6572 2e0a  ee the cluster..
-0001b000: 2020 2020 2020 2020 2020 2020 6b65 7074              kept
-0001b010: 5f72 6563 6f72 6473 2e61 7070 656e 6428  _records.append(
-0001b020: 7265 636f 7264 290a 2020 2020 2020 2020  record).        
-0001b030: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0001b040: 2020 6b65 7074 5f72 6563 6f72 6473 2e61    kept_records.a
-0001b050: 7070 656e 6428 7570 6461 7465 645f 7265  ppend(updated_re
-0001b060: 636f 7264 735b 695d 290a 0a20 2020 2069  cords[i])..    i
-0001b070: 6620 6175 746f 646f 776e 5f63 6c75 7374  f autodown_clust
-0001b080: 6572 733a 0a20 2020 2020 2020 2070 6c75  ers:.        plu
-0001b090: 7261 6c20 3d20 2773 2720 6966 206c 656e  ral = 's' if len
-0001b0a0: 2861 7574 6f64 6f77 6e5f 636c 7573 7465  (autodown_cluste
-0001b0b0: 7273 2920 3e20 3120 656c 7365 2027 270a  rs) > 1 else ''.
-0001b0c0: 2020 2020 2020 2020 636c 7573 7465 725f          cluster_
-0001b0d0: 7374 7220 3d20 272c 2027 2e6a 6f69 6e28  str = ', '.join(
-0001b0e0: 6175 746f 646f 776e 5f63 6c75 7374 6572  autodown_cluster
-0001b0f0: 7329 0a20 2020 2020 2020 206c 6f67 6765  s).        logge
-0001b100: 722e 696e 666f 2866 2741 7574 6f64 6f77  r.info(f'Autodow
-0001b110: 6e65 6420 636c 7573 7465 727b 706c 7572  ned cluster{plur
-0001b120: 616c 7d3a 2027 0a20 2020 2020 2020 2020  al}: '.         
-0001b130: 2020 2020 2020 2020 2020 2066 277b 6272             f'{br
-0001b140: 6967 6874 7d7b 636c 7573 7465 725f 7374  ight}{cluster_st
-0001b150: 727d 7b72 6573 6574 7d27 290a 2020 2020  r}{reset}').    
-0001b160: 6966 2072 656d 6169 6e69 6e67 5f63 6c75  if remaining_clu
-0001b170: 7374 6572 733a 0a20 2020 2020 2020 2070  sters:.        p
-0001b180: 6c75 7261 6c20 3d20 2773 2720 6966 206c  lural = 's' if l
-0001b190: 656e 2872 656d 6169 6e69 6e67 5f63 6c75  en(remaining_clu
-0001b1a0: 7374 6572 7329 203e 2031 2065 6c73 6520  sters) > 1 else 
-0001b1b0: 2727 0a20 2020 2020 2020 2063 6c75 7374  ''.        clust
-0001b1c0: 6572 5f73 7472 203d 2027 2c20 272e 6a6f  er_str = ', '.jo
-0001b1d0: 696e 286e 616d 6520 666f 7220 6e61 6d65  in(name for name
-0001b1e0: 2069 6e20 7265 6d61 696e 696e 675f 636c   in remaining_cl
-0001b1f0: 7573 7465 7273 290a 2020 2020 2020 2020  usters).        
-0001b200: 6c6f 6767 6572 2e77 6172 6e69 6e67 2866  logger.warning(f
-0001b210: 277b 7965 6c6c 6f77 7d43 6c75 7374 6572  '{yellow}Cluster
-0001b220: 7b70 6c75 7261 6c7d 2074 6572 6d69 6e61  {plural} termina
-0001b230: 7465 6420 6f6e 2027 0a20 2020 2020 2020  ted on '.       
-0001b240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b250: 6627 7468 6520 636c 6f75 643a 207b 7265  f'the cloud: {re
-0001b260: 7365 747d 7b62 7269 6768 747d 7b63 6c75  set}{bright}{clu
-0001b270: 7374 6572 5f73 7472 7d7b 7265 7365 747d  ster_str}{reset}
-0001b280: 2729 0a0a 2020 2020 6966 2066 6169 6c65  ')..    if faile
-0001b290: 645f 636c 7573 7465 7273 3a0a 2020 2020  d_clusters:.    
-0001b2a0: 2020 2020 706c 7572 616c 203d 2027 7327      plural = 's'
-0001b2b0: 2069 6620 6c65 6e28 6661 696c 6564 5f63   if len(failed_c
-0001b2c0: 6c75 7374 6572 7329 203e 2031 2065 6c73  lusters) > 1 els
-0001b2d0: 6520 2727 0a20 2020 2020 2020 206c 6f67  e ''.        log
-0001b2e0: 6765 722e 7761 726e 696e 6728 6627 7b79  ger.warning(f'{y
-0001b2f0: 656c 6c6f 777d 4661 696c 6564 2074 6f20  ellow}Failed to 
-0001b300: 7265 6672 6573 6820 7374 6174 7573 2066  refresh status f
-0001b310: 6f72 2027 0a20 2020 2020 2020 2020 2020  or '.           
-0001b320: 2020 2020 2020 2020 2020 2020 6627 7b6c              f'{l
-0001b330: 656e 2866 6169 6c65 645f 636c 7573 7465  en(failed_cluste
-0001b340: 7273 297d 2063 6c75 7374 6572 7b70 6c75  rs)} cluster{plu
-0001b350: 7261 6c7d 3a7b 7265 7365 747d 2729 0a20  ral}:{reset}'). 
-0001b360: 2020 2020 2020 2066 6f72 2063 6c75 7374         for clust
-0001b370: 6572 5f6e 616d 652c 2065 2069 6e20 6661  er_name, e in fa
-0001b380: 696c 6564 5f63 6c75 7374 6572 733a 0a20  iled_clusters:. 
-0001b390: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
-0001b3a0: 722e 7761 726e 696e 6728 6627 2020 7b62  r.warning(f'  {b
-0001b3b0: 7269 6768 747d 7b63 6c75 7374 6572 5f6e  right}{cluster_n
-0001b3c0: 616d 657d 7b72 6573 6574 7d3a 207b 657d  ame}{reset}: {e}
-0001b3d0: 2729 0a20 2020 2072 6574 7572 6e20 6b65  ').    return ke
-0001b3e0: 7074 5f72 6563 6f72 6473 0a0a 0a40 7479  pt_records...@ty
-0001b3f0: 7069 6e67 2e6f 7665 726c 6f61 640a 6465  ping.overload.de
-0001b400: 6620 6765 745f 6261 636b 656e 645f 6672  f get_backend_fr
-0001b410: 6f6d 5f68 616e 646c 6528 0a20 2020 2068  om_handle(.    h
-0001b420: 616e 646c 653a 2027 636c 6f75 645f 766d  andle: 'cloud_vm
-0001b430: 5f72 6179 5f62 6163 6b65 6e64 2e43 6c6f  _ray_backend.Clo
-0001b440: 7564 566d 5261 7952 6573 6f75 7263 6548  udVmRayResourceH
-0001b450: 616e 646c 6527 0a29 202d 3e20 2763 6c6f  andle'.) -> 'clo
-0001b460: 7564 5f76 6d5f 7261 795f 6261 636b 656e  ud_vm_ray_backen
-0001b470: 642e 436c 6f75 6456 6d52 6179 4261 636b  d.CloudVmRayBack
-0001b480: 656e 6427 3a0a 2020 2020 2e2e 2e0a 0a0a  end':.    ......
-0001b490: 4074 7970 696e 672e 6f76 6572 6c6f 6164  @typing.overload
-0001b4a0: 0a64 6566 2067 6574 5f62 6163 6b65 6e64  .def get_backend
-0001b4b0: 5f66 726f 6d5f 6861 6e64 6c65 280a 2020  _from_handle(.  
-0001b4c0: 2020 6861 6e64 6c65 3a20 276c 6f63 616c    handle: 'local
-0001b4d0: 5f64 6f63 6b65 725f 6261 636b 656e 642e  _docker_backend.
-0001b4e0: 4c6f 6361 6c44 6f63 6b65 7252 6573 6f75  LocalDockerResou
-0001b4f0: 7263 6548 616e 646c 6527 0a29 202d 3e20  rceHandle'.) -> 
-0001b500: 276c 6f63 616c 5f64 6f63 6b65 725f 6261  'local_docker_ba
-0001b510: 636b 656e 642e 4c6f 6361 6c44 6f63 6b65  ckend.LocalDocke
-0001b520: 7242 6163 6b65 6e64 273a 0a20 2020 202e  rBackend':.    .
-0001b530: 2e2e 0a0a 0a40 7479 7069 6e67 2e6f 7665  .....@typing.ove
-0001b540: 726c 6f61 640a 6465 6620 6765 745f 6261  rload.def get_ba
-0001b550: 636b 656e 645f 6672 6f6d 5f68 616e 646c  ckend_from_handl
-0001b560: 6528 0a20 2020 2020 2020 2068 616e 646c  e(.        handl
-0001b570: 653a 2062 6163 6b65 6e64 732e 5265 736f  e: backends.Reso
-0001b580: 7572 6365 4861 6e64 6c65 2920 2d3e 2062  urceHandle) -> b
-0001b590: 6163 6b65 6e64 732e 4261 636b 656e 643a  ackends.Backend:
-0001b5a0: 0a20 2020 202e 2e2e 0a0a 0a64 6566 2067  .    ......def g
-0001b5b0: 6574 5f62 6163 6b65 6e64 5f66 726f 6d5f  et_backend_from_
-0001b5c0: 6861 6e64 6c65 280a 2020 2020 2020 2020  handle(.        
-0001b5d0: 6861 6e64 6c65 3a20 6261 636b 656e 6473  handle: backends
-0001b5e0: 2e52 6573 6f75 7263 6548 616e 646c 6529  .ResourceHandle)
-0001b5f0: 202d 3e20 6261 636b 656e 6473 2e42 6163   -> backends.Bac
-0001b600: 6b65 6e64 3a0a 2020 2020 2222 2247 6574  kend:.    """Get
-0001b610: 7320 6120 4261 636b 656e 6420 6f62 6a65  s a Backend obje
-0001b620: 6374 2063 6f72 7265 7370 6f6e 6469 6e67  ct corresponding
-0001b630: 2074 6f20 6120 6861 6e64 6c65 2e0a 0a20   to a handle... 
-0001b640: 2020 2049 6e73 7065 6374 7320 6861 6e64     Inspects hand
-0001b650: 6c65 2074 7970 6520 746f 2069 6e66 6572  le type to infer
-0001b660: 2074 6865 2062 6163 6b65 6e64 2075 7365   the backend use
-0001b670: 6420 666f 7220 7468 6520 7265 736f 7572  d for the resour
-0001b680: 6365 2e0a 2020 2020 2222 220a 2020 2020  ce..    """.    
-0001b690: 6261 636b 656e 643a 2062 6163 6b65 6e64  backend: backend
-0001b6a0: 732e 4261 636b 656e 640a 2020 2020 6966  s.Backend.    if
-0001b6b0: 2069 7369 6e73 7461 6e63 6528 6861 6e64   isinstance(hand
-0001b6c0: 6c65 2c20 6261 636b 656e 6473 2e43 6c6f  le, backends.Clo
-0001b6d0: 7564 566d 5261 7952 6573 6f75 7263 6548  udVmRayResourceH
-0001b6e0: 616e 646c 6529 3a0a 2020 2020 2020 2020  andle):.        
-0001b6f0: 6261 636b 656e 6420 3d20 6261 636b 656e  backend = backen
-0001b700: 6473 2e43 6c6f 7564 566d 5261 7942 6163  ds.CloudVmRayBac
-0001b710: 6b65 6e64 2829 0a20 2020 2065 6c69 6620  kend().    elif 
-0001b720: 6973 696e 7374 616e 6365 2868 616e 646c  isinstance(handl
-0001b730: 652c 2062 6163 6b65 6e64 732e 4c6f 6361  e, backends.Loca
-0001b740: 6c44 6f63 6b65 7252 6573 6f75 7263 6548  lDockerResourceH
-0001b750: 616e 646c 6529 3a0a 2020 2020 2020 2020  andle):.        
-0001b760: 6261 636b 656e 6420 3d20 6261 636b 656e  backend = backen
-0001b770: 6473 2e4c 6f63 616c 446f 636b 6572 4261  ds.LocalDockerBa
-0001b780: 636b 656e 6428 290a 2020 2020 656c 7365  ckend().    else
-0001b790: 3a0a 2020 2020 2020 2020 7261 6973 6520  :.        raise 
-0001b7a0: 4e6f 7449 6d70 6c65 6d65 6e74 6564 4572  NotImplementedEr
-0001b7b0: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
-0001b7c0: 2066 2748 616e 646c 6520 7479 7065 207b   f'Handle type {
-0001b7d0: 7479 7065 2868 616e 646c 6529 7d20 6973  type(handle)} is
-0001b7e0: 206e 6f74 2073 7570 706f 7274 6564 2079   not supported y
-0001b7f0: 6574 2e27 290a 2020 2020 7265 7475 726e  et.').    return
-0001b800: 2062 6163 6b65 6e64 0a0a 0a64 6566 2067   backend...def g
-0001b810: 6574 5f74 6173 6b5f 6465 6d61 6e64 735f  et_task_demands_
-0001b820: 6469 6374 2874 6173 6b3a 2027 7461 736b  dict(task: 'task
-0001b830: 5f6c 6962 2e54 6173 6b27 2920 2d3e 2044  _lib.Task') -> D
-0001b840: 6963 745b 7374 722c 2066 6c6f 6174 5d3a  ict[str, float]:
-0001b850: 0a20 2020 2022 2222 5265 7475 726e 7320  .    """Returns 
-0001b860: 7468 6520 7265 736f 7572 6365 7320 6469  the resources di
-0001b870: 6374 206f 6620 7468 6520 7461 736b 2e0a  ct of the task..
-0001b880: 0a20 2020 2052 6574 7572 6e73 3a0a 2020  .    Returns:.  
-0001b890: 2020 2020 2020 4120 6469 6374 206f 6620        A dict of 
-0001b8a0: 7468 6520 7265 736f 7572 6365 7320 6f66  the resources of
-0001b8b0: 2074 6865 2074 6173 6b2e 2054 6865 206b   the task. The k
-0001b8c0: 6579 7320 6172 6520 7468 6520 7265 736f  eys are the reso
-0001b8d0: 7572 6365 206e 616d 6573 0a20 2020 2020  urce names.     
-0001b8e0: 2020 2061 6e64 2074 6865 2076 616c 7565     and the value
-0001b8f0: 7320 6172 6520 7468 6520 6e75 6d62 6572  s are the number
-0001b900: 206f 6620 7468 6520 7265 736f 7572 6365   of the resource
-0001b910: 732e 2049 7420 616c 7761 7973 2063 6f6e  s. It always con
-0001b920: 7461 696e 730a 2020 2020 2020 2020 7468  tains.        th
-0001b930: 6520 4350 5520 7265 736f 7572 6365 2028  e CPU resource (
-0001b940: 746f 2063 6f6e 7472 6f6c 2074 6865 206d  to control the m
-0001b950: 6178 696d 756d 206e 756d 6265 7220 6f66  aximum number of
-0001b960: 2074 6173 6b73 292c 2061 6e64 0a20 2020   tasks), and.   
-0001b970: 2020 2020 206f 7074 696f 6e61 6c6c 7920       optionally 
-0001b980: 6163 6365 6c65 7261 746f 7220 6465 6d61  accelerator dema
-0001b990: 6e64 732e 0a20 2020 2022 2222 0a20 2020  nds..    """.   
-0001b9a0: 2023 2054 4f44 4f3a 2043 7573 746f 6d20   # TODO: Custom 
-0001b9b0: 4350 5520 616e 6420 6f74 6865 7220 6d65  CPU and other me
-0001b9c0: 6d6f 7279 2072 6573 6f75 7263 6573 2061  mory resources a
-0001b9d0: 7265 206e 6f74 2073 7570 706f 7274 6564  re not supported
-0001b9e0: 2079 6574 2e0a 2020 2020 2320 466f 7220   yet..    # For 
-0001b9f0: 736b 7920 7370 6f74 2f73 6572 7665 2063  sky spot/serve c
-0001ba00: 6f6e 7472 6f6c 6c65 7220 7461 736b 2c20  ontroller task, 
-0001ba10: 7765 2073 6574 2074 6865 2043 5055 2072  we set the CPU r
-0001ba20: 6573 6f75 7263 6520 746f 2061 2073 6d61  esource to a sma
-0001ba30: 6c6c 6572 0a20 2020 2023 2076 616c 7565  ller.    # value
-0001ba40: 2074 6f20 7375 7070 6f72 7420 6120 6c61   to support a la
-0001ba50: 7267 6572 206e 756d 6265 7220 6f66 2073  rger number of s
-0001ba60: 706f 7420 6a6f 6273 2061 6e64 2073 6572  pot jobs and ser
-0001ba70: 7669 6365 732e 0a20 2020 2072 6573 6f75  vices..    resou
-0001ba80: 7263 6573 5f64 6963 7420 3d20 7b0a 2020  rces_dict = {.  
-0001ba90: 2020 2020 2020 2743 5055 273a 2028 636f        'CPU': (co
-0001baa0: 6e73 7461 6e74 732e 434f 4e54 524f 4c4c  nstants.CONTROLL
-0001bab0: 4552 5f50 524f 4345 5353 5f43 5055 5f44  ER_PROCESS_CPU_D
-0001bac0: 454d 414e 440a 2020 2020 2020 2020 2020  EMAND.          
-0001bad0: 2020 2020 2020 6966 2074 6173 6b2e 6973        if task.is
-0001bae0: 5f63 6f6e 7472 6f6c 6c65 725f 7461 736b  _controller_task
-0001baf0: 2829 2065 6c73 6520 4445 4641 554c 545f  () else DEFAULT_
-0001bb00: 5441 534b 5f43 5055 5f44 454d 414e 4429  TASK_CPU_DEMAND)
-0001bb10: 0a20 2020 207d 0a20 2020 2069 6620 7461  .    }.    if ta
-0001bb20: 736b 2e62 6573 745f 7265 736f 7572 6365  sk.best_resource
-0001bb30: 7320 6973 206e 6f74 204e 6f6e 653a 0a20  s is not None:. 
-0001bb40: 2020 2020 2020 2072 6573 6f75 7263 6573         resources
-0001bb50: 203d 2074 6173 6b2e 6265 7374 5f72 6573   = task.best_res
-0001bb60: 6f75 7263 6573 0a20 2020 2065 6c73 653a  ources.    else:
-0001bb70: 0a20 2020 2020 2020 2023 2054 6173 6b20  .        # Task 
-0001bb80: 6d61 7920 2865 2e67 2e2c 2073 6b79 206c  may (e.g., sky l
-0001bb90: 6175 6e63 6829 206f 7220 6d61 7920 6e6f  aunch) or may no
-0001bba0: 7420 2865 2e67 2e2c 2073 6b79 2065 7865  t (e.g., sky exe
-0001bbb0: 6329 2068 6176 6520 756e 6465 7267 6f6e  c) have undergon
-0001bbc0: 650a 2020 2020 2020 2020 2320 736b 792e  e.        # sky.
-0001bbd0: 6f70 7469 6d69 7a65 2829 2c20 736f 2062  optimize(), so b
-0001bbe0: 6573 745f 7265 736f 7572 6365 7320 6d61  est_resources ma
-0001bbf0: 7920 6265 204e 6f6e 652e 0a20 2020 2020  y be None..     
-0001bc00: 2020 2061 7373 6572 7420 6c65 6e28 7461     assert len(ta
-0001bc10: 736b 2e72 6573 6f75 7263 6573 2920 3d3d  sk.resources) ==
-0001bc20: 2031 2c20 7461 736b 2e72 6573 6f75 7263   1, task.resourc
-0001bc30: 6573 0a20 2020 2020 2020 2072 6573 6f75  es.        resou
-0001bc40: 7263 6573 203d 206c 6973 7428 7461 736b  rces = list(task
-0001bc50: 2e72 6573 6f75 7263 6573 295b 305d 0a20  .resources)[0]. 
-0001bc60: 2020 2069 6620 7265 736f 7572 6365 7320     if resources 
-0001bc70: 6973 206e 6f74 204e 6f6e 6520 616e 6420  is not None and 
-0001bc80: 7265 736f 7572 6365 732e 6163 6365 6c65  resources.accele
-0001bc90: 7261 746f 7273 2069 7320 6e6f 7420 4e6f  rators is not No
-0001bca0: 6e65 3a0a 2020 2020 2020 2020 7265 736f  ne:.        reso
-0001bcb0: 7572 6365 735f 6469 6374 2e75 7064 6174  urces_dict.updat
-0001bcc0: 6528 7265 736f 7572 6365 732e 6163 6365  e(resources.acce
-0001bcd0: 6c65 7261 746f 7273 290a 2020 2020 7265  lerators).    re
-0001bce0: 7475 726e 2072 6573 6f75 7263 6573 5f64  turn resources_d
-0001bcf0: 6963 740a 0a0a 6465 6620 6765 745f 7461  ict...def get_ta
-0001bd00: 736b 5f72 6573 6f75 7263 6573 5f73 7472  sk_resources_str
-0001bd10: 2874 6173 6b3a 2027 7461 736b 5f6c 6962  (task: 'task_lib
-0001bd20: 2e54 6173 6b27 2920 2d3e 2073 7472 3a0a  .Task') -> str:.
-0001bd30: 2020 2020 2222 2252 6574 7572 6e73 2074      """Returns t
-0001bd40: 6865 2072 6573 6f75 7263 6573 2073 7472  he resources str
-0001bd50: 696e 6720 6f66 2074 6865 2074 6173 6b2e  ing of the task.
-0001bd60: 0a0a 2020 2020 5468 6520 7265 736f 7572  ..    The resour
-0001bd70: 6365 7320 7374 7269 6e67 2069 7320 6f6e  ces string is on
-0001bd80: 6c79 2075 7365 6420 6173 2061 2064 6973  ly used as a dis
-0001bd90: 706c 6179 2070 7572 706f 7365 2c20 736f  play purpose, so
-0001bda0: 2077 6520 6f6e 6c79 2073 686f 770a 2020   we only show.  
-0001bdb0: 2020 7468 6520 6163 6365 6c65 7261 746f    the accelerato
-0001bdc0: 7220 6465 6d61 6e64 7320 2869 6620 616e  r demands (if an
-0001bdd0: 7929 2e20 4f74 6865 7277 6973 652c 2074  y). Otherwise, t
-0001bde0: 6865 2043 5055 2064 656d 616e 6420 6973  he CPU demand is
-0001bdf0: 2073 686f 776e 2e0a 2020 2020 2222 220a   shown..    """.
-0001be00: 2020 2020 7461 736b 5f63 7075 5f64 656d      task_cpu_dem
-0001be10: 616e 6420 3d20 2863 6f6e 7374 616e 7473  and = (constants
-0001be20: 2e43 4f4e 5452 4f4c 4c45 525f 5052 4f43  .CONTROLLER_PROC
-0001be30: 4553 535f 4350 555f 4445 4d41 4e44 2069  ESS_CPU_DEMAND i
-0001be40: 660a 2020 2020 2020 2020 2020 2020 2020  f.              
-0001be50: 2020 2020 2020 2020 2074 6173 6b2e 6973           task.is
-0001be60: 5f63 6f6e 7472 6f6c 6c65 725f 7461 736b  _controller_task
-0001be70: 2829 2065 6c73 6520 4445 4641 554c 545f  () else DEFAULT_
-0001be80: 5441 534b 5f43 5055 5f44 454d 414e 4429  TASK_CPU_DEMAND)
-0001be90: 0a20 2020 2069 6620 7461 736b 2e62 6573  .    if task.bes
-0001bea0: 745f 7265 736f 7572 6365 7320 6973 206e  t_resources is n
-0001beb0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-0001bec0: 2061 6363 656c 6572 6174 6f72 5f64 6963   accelerator_dic
-0001bed0: 7420 3d20 7461 736b 2e62 6573 745f 7265  t = task.best_re
-0001bee0: 736f 7572 6365 732e 6163 6365 6c65 7261  sources.accelera
-0001bef0: 746f 7273 0a20 2020 2020 2020 2069 6620  tors.        if 
-0001bf00: 6163 6365 6c65 7261 746f 725f 6469 6374  accelerator_dict
-0001bf10: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-0001bf20: 2020 2020 2020 7265 736f 7572 6365 735f        resources_
-0001bf30: 7374 7220 3d20 6627 4350 553a 7b74 6173  str = f'CPU:{tas
-0001bf40: 6b5f 6370 755f 6465 6d61 6e64 7d27 0a20  k_cpu_demand}'. 
-0001bf50: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0001bf60: 2020 2020 2020 2020 2072 6573 6f75 7263           resourc
-0001bf70: 6573 5f73 7472 203d 2027 2c20 272e 6a6f  es_str = ', '.jo
-0001bf80: 696e 280a 2020 2020 2020 2020 2020 2020  in(.            
-0001bf90: 2020 2020 6627 7b6b 7d3a 7b76 7d27 2066      f'{k}:{v}' f
-0001bfa0: 6f72 206b 2c20 7620 696e 2061 6363 656c  or k, v in accel
-0001bfb0: 6572 6174 6f72 5f64 6963 742e 6974 656d  erator_dict.item
-0001bfc0: 7328 2929 0a20 2020 2065 6c69 6620 6c65  s()).    elif le
-0001bfd0: 6e28 7461 736b 2e72 6573 6f75 7263 6573  n(task.resources
-0001bfe0: 2920 3d3d 2031 3a0a 2020 2020 2020 2020  ) == 1:.        
-0001bff0: 7265 736f 7572 6365 735f 6469 6374 203d  resources_dict =
-0001c000: 206c 6973 7428 7461 736b 2e72 6573 6f75   list(task.resou
-0001c010: 7263 6573 295b 305d 2e61 6363 656c 6572  rces)[0].acceler
-0001c020: 6174 6f72 730a 2020 2020 2020 2020 6966  ators.        if
-0001c030: 2072 6573 6f75 7263 6573 5f64 6963 7420   resources_dict 
-0001c040: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-0001c050: 2020 2020 2072 6573 6f75 7263 6573 5f73       resources_s
-0001c060: 7472 203d 2066 2743 5055 3a7b 7461 736b  tr = f'CPU:{task
-0001c070: 5f63 7075 5f64 656d 616e 647d 270a 2020  _cpu_demand}'.  
-0001c080: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0001c090: 2020 2020 2020 2020 7265 736f 7572 6365          resource
-0001c0a0: 735f 7374 7220 3d20 272c 2027 2e6a 6f69  s_str = ', '.joi
-0001c0b0: 6e28 0a20 2020 2020 2020 2020 2020 2020  n(.             
-0001c0c0: 2020 2066 277b 6b7d 3a7b 767d 2720 666f     f'{k}:{v}' fo
-0001c0d0: 7220 6b2c 2076 2069 6e20 7265 736f 7572  r k, v in resour
-0001c0e0: 6365 735f 6469 6374 2e69 7465 6d73 2829  ces_dict.items()
-0001c0f0: 290a 2020 2020 656c 7365 3a0a 2020 2020  ).    else:.    
-0001c100: 2020 2020 7265 736f 7572 6365 5f61 6363      resource_acc
-0001c110: 656c 6572 6174 6f72 7320 3d20 5b5d 0a20  elerators = []. 
-0001c120: 2020 2020 2020 2066 6f72 2072 6573 6f75         for resou
-0001c130: 7263 6520 696e 2074 6173 6b2e 7265 736f  rce in task.reso
-0001c140: 7572 6365 733a 0a20 2020 2020 2020 2020  urces:.         
-0001c150: 2020 2069 6620 7265 736f 7572 6365 2e61     if resource.a
-0001c160: 6363 656c 6572 6174 6f72 7320 6973 204e  ccelerators is N
-0001c170: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0001c180: 2020 2020 2063 6f6e 7469 6e75 650a 2020       continue.  
-0001c190: 2020 2020 2020 2020 2020 666f 7220 6b2c            for k,
-0001c1a0: 2076 2069 6e20 7265 736f 7572 6365 2e61   v in resource.a
-0001c1b0: 6363 656c 6572 6174 6f72 732e 6974 656d  ccelerators.item
-0001c1c0: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
-0001c1d0: 2020 2020 2072 6573 6f75 7263 655f 6163       resource_ac
-0001c1e0: 6365 6c65 7261 746f 7273 2e61 7070 656e  celerators.appen
-0001c1f0: 6428 6627 7b6b 7d3a 7b76 7d27 290a 0a20  d(f'{k}:{v}').. 
-0001c200: 2020 2020 2020 2069 6620 7265 736f 7572         if resour
-0001c210: 6365 5f61 6363 656c 6572 6174 6f72 733a  ce_accelerators:
-0001c220: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
-0001c230: 6f75 7263 6573 5f73 7472 203d 2027 2c20  ources_str = ', 
-0001c240: 272e 6a6f 696e 2873 6574 2872 6573 6f75  '.join(set(resou
-0001c250: 7263 655f 6163 6365 6c65 7261 746f 7273  rce_accelerators
-0001c260: 2929 0a20 2020 2020 2020 2065 6c73 653a  )).        else:
-0001c270: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
-0001c280: 6f75 7263 6573 5f73 7472 203d 2066 2743  ources_str = f'C
-0001c290: 5055 3a7b 7461 736b 5f63 7075 5f64 656d  PU:{task_cpu_dem
-0001c2a0: 616e 647d 270a 2020 2020 7265 736f 7572  and}'.    resour
-0001c2b0: 6365 735f 7374 7220 3d20 6627 7b74 6173  ces_str = f'{tas
-0001c2c0: 6b2e 6e75 6d5f 6e6f 6465 737d 7820 5b7b  k.num_nodes}x [{
-0001c2d0: 7265 736f 7572 6365 735f 7374 727d 5d27  resources_str}]'
-0001c2e0: 0a20 2020 2072 6574 7572 6e20 7265 736f  .    return reso
-0001c2f0: 7572 6365 735f 7374 720a 0a0a 2320 4861  urces_str...# Ha
-0001c300: 6e64 6c65 2063 7472 6c2d 630a 6465 6620  ndle ctrl-c.def 
-0001c310: 696e 7465 7272 7570 745f 6861 6e64 6c65  interrupt_handle
-0001c320: 7228 7369 676e 756d 2c20 6672 616d 6529  r(signum, frame)
-0001c330: 3a0a 2020 2020 6465 6c20 7369 676e 756d  :.    del signum
-0001c340: 2c20 6672 616d 650a 2020 2020 7375 6270  , frame.    subp
-0001c350: 726f 6365 7373 5f75 7469 6c73 2e6b 696c  rocess_utils.kil
-0001c360: 6c5f 6368 696c 6472 656e 5f70 726f 6365  l_children_proce
-0001c370: 7373 6573 2829 0a20 2020 2023 2041 766f  sses().    # Avo
-0001c380: 6964 2075 7369 6e67 206c 6f67 6765 7220  id using logger 
-0001c390: 6865 7265 2c20 6173 2069 7420 7769 6c6c  here, as it will
-0001c3a0: 2070 7269 6e74 2074 6865 2073 7461 636b   print the stack
-0001c3b0: 2074 7261 6365 2066 6f72 2062 726f 6b65   trace for broke
-0001c3c0: 6e0a 2020 2020 2320 7069 7065 2c20 7768  n.    # pipe, wh
-0001c3d0: 656e 2074 6865 206f 7574 7075 7420 6973  en the output is
-0001c3e0: 2070 6970 6564 2074 6f20 616e 6f74 6865   piped to anothe
-0001c3f0: 7220 7072 6f67 7261 6d2e 0a20 2020 2070  r program..    p
-0001c400: 7269 6e74 2866 277b 636f 6c6f 7261 6d61  rint(f'{colorama
-0001c410: 2e53 7479 6c65 2e44 494d 7d54 6970 3a20  .Style.DIM}Tip: 
-0001c420: 5468 6520 6a6f 6220 7769 6c6c 206b 6565  The job will kee
-0001c430: 7020 270a 2020 2020 2020 2020 2020 6627  p '.          f'
-0001c440: 7275 6e6e 696e 6720 6166 7465 7220 4374  running after Ct
-0001c450: 726c 2d43 2e7b 636f 6c6f 7261 6d61 2e53  rl-C.{colorama.S
-0001c460: 7479 6c65 2e52 4553 4554 5f41 4c4c 7d27  tyle.RESET_ALL}'
-0001c470: 290a 2020 2020 7769 7468 2075 785f 7574  ).    with ux_ut
-0001c480: 696c 732e 7072 696e 745f 6578 6365 7074  ils.print_except
-0001c490: 696f 6e5f 6e6f 5f74 7261 6365 6261 636b  ion_no_traceback
-0001c4a0: 2829 3a0a 2020 2020 2020 2020 7261 6973  ():.        rais
-0001c4b0: 6520 4b65 7962 6f61 7264 496e 7465 7272  e KeyboardInterr
-0001c4c0: 7570 7428 6578 6365 7074 696f 6e73 2e4b  upt(exceptions.K
-0001c4d0: 4559 424f 4152 445f 494e 5445 5252 5550  EYBOARD_INTERRUP
-0001c4e0: 545f 434f 4445 290a 0a0a 2320 4861 6e64  T_CODE)...# Hand
-0001c4f0: 6c65 2063 7472 6c2d 7a0a 6465 6620 7374  le ctrl-z.def st
-0001c500: 6f70 5f68 616e 646c 6572 2873 6967 6e75  op_handler(signu
-0001c510: 6d2c 2066 7261 6d65 293a 0a20 2020 2064  m, frame):.    d
-0001c520: 656c 2073 6967 6e75 6d2c 2066 7261 6d65  el signum, frame
-0001c530: 0a20 2020 2073 7562 7072 6f63 6573 735f  .    subprocess_
-0001c540: 7574 696c 732e 6b69 6c6c 5f63 6869 6c64  utils.kill_child
-0001c550: 7265 6e5f 7072 6f63 6573 7365 7328 290a  ren_processes().
-0001c560: 2020 2020 2320 4176 6f69 6420 7573 696e      # Avoid usin
-0001c570: 6720 6c6f 6767 6572 2068 6572 652c 2061  g logger here, a
-0001c580: 7320 6974 2077 696c 6c20 7072 696e 7420  s it will print 
-0001c590: 7468 6520 7374 6163 6b20 7472 6163 6520  the stack trace 
-0001c5a0: 666f 7220 6272 6f6b 656e 0a20 2020 2023  for broken.    #
-0001c5b0: 2070 6970 652c 2077 6865 6e20 7468 6520   pipe, when the 
-0001c5c0: 6f75 7470 7574 2069 7320 7069 7065 6420  output is piped 
-0001c5d0: 746f 2061 6e6f 7468 6572 2070 726f 6772  to another progr
-0001c5e0: 616d 2e0a 2020 2020 7072 696e 7428 6627  am..    print(f'
-0001c5f0: 7b63 6f6c 6f72 616d 612e 5374 796c 652e  {colorama.Style.
-0001c600: 4449 4d7d 5469 703a 2054 6865 206a 6f62  DIM}Tip: The job
-0001c610: 2077 696c 6c20 6b65 6570 2027 0a20 2020   will keep '.   
-0001c620: 2020 2020 2020 2066 2772 756e 6e69 6e67         f'running
-0001c630: 2061 6674 6572 2043 7472 6c2d 5a2e 7b63   after Ctrl-Z.{c
-0001c640: 6f6c 6f72 616d 612e 5374 796c 652e 5245  olorama.Style.RE
-0001c650: 5345 545f 414c 4c7d 2729 0a20 2020 2077  SET_ALL}').    w
-0001c660: 6974 6820 7578 5f75 7469 6c73 2e70 7269  ith ux_utils.pri
-0001c670: 6e74 5f65 7863 6570 7469 6f6e 5f6e 6f5f  nt_exception_no_
-0001c680: 7472 6163 6562 6163 6b28 293a 0a20 2020  traceback():.   
-0001c690: 2020 2020 2072 6169 7365 204b 6579 626f       raise Keybo
-0001c6a0: 6172 6449 6e74 6572 7275 7074 2865 7863  ardInterrupt(exc
-0001c6b0: 6570 7469 6f6e 732e 5349 4754 5354 505f  eptions.SIGTSTP_
-0001c6c0: 434f 4445 290a 0a0a 6465 6620 7275 6e5f  CODE)...def run_
-0001c6d0: 636f 6d6d 616e 645f 616e 645f 6861 6e64  command_and_hand
-0001c6e0: 6c65 5f73 7368 5f66 6169 6c75 7265 2872  le_ssh_failure(r
-0001c6f0: 756e 6e65 723a 2063 6f6d 6d61 6e64 5f72  unner: command_r
-0001c700: 756e 6e65 722e 5353 4843 6f6d 6d61 6e64  unner.SSHCommand
-0001c710: 5275 6e6e 6572 2c0a 2020 2020 2020 2020  Runner,.        
-0001c720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c730: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0001c740: 6f6d 6d61 6e64 3a20 7374 722c 0a20 2020  ommand: str,.   
-0001c750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c770: 2020 2020 6661 696c 7572 655f 6d65 7373      failure_mess
-0001c780: 6167 653a 2073 7472 2920 2d3e 2073 7472  age: str) -> str
-0001c790: 3a0a 2020 2020 2222 2252 756e 7320 636f  :.    """Runs co
-0001c7a0: 6d6d 616e 6420 7265 6d6f 7465 6c79 2061  mmand remotely a
-0001c7b0: 6e64 2072 6574 7572 6e73 206f 7574 7075  nd returns outpu
-0001c7c0: 7420 7769 7468 2070 726f 7065 7220 6572  t with proper er
-0001c7d0: 726f 7220 6861 6e64 6c69 6e67 2e22 2222  ror handling."""
-0001c7e0: 0a20 2020 2072 632c 2073 7464 6f75 742c  .    rc, stdout,
-0001c7f0: 2073 7464 6572 7220 3d20 7275 6e6e 6572   stderr = runner
-0001c800: 2e72 756e 2863 6f6d 6d61 6e64 2c0a 2020  .run(command,.  
-0001c810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c830: 2020 7265 7175 6972 655f 6f75 7470 7574    require_output
-0001c840: 733d 5472 7565 2c0a 2020 2020 2020 2020  s=True,.        
-0001c850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c860: 2020 2020 2020 2020 2020 2020 7374 7265              stre
-0001c870: 616d 5f6c 6f67 733d 4661 6c73 6529 0a20  am_logs=False). 
-0001c880: 2020 2069 6620 7263 203d 3d20 3235 353a     if rc == 255:
-0001c890: 0a20 2020 2020 2020 2023 2053 5348 2066  .        # SSH f
-0001c8a0: 6169 6c65 640a 2020 2020 2020 2020 7261  ailed.        ra
-0001c8b0: 6973 6520 5275 6e74 696d 6545 7272 6f72  ise RuntimeError
-0001c8c0: 280a 2020 2020 2020 2020 2020 2020 6627  (.            f'
-0001c8d0: 5353 4820 7769 7468 2075 7365 7220 7b72  SSH with user {r
-0001c8e0: 756e 6e65 722e 7373 685f 7573 6572 7d20  unner.ssh_user} 
-0001c8f0: 616e 6420 6b65 7920 7b72 756e 6e65 722e  and key {runner.
-0001c900: 7373 685f 7072 6976 6174 655f 6b65 797d  ssh_private_key}
-0001c910: 2027 0a20 2020 2020 2020 2020 2020 2066   '.            f
-0001c920: 2774 6f20 7b72 756e 6e65 722e 6970 7d20  'to {runner.ip} 
-0001c930: 6661 696c 6564 2e20 5468 6973 2069 7320  failed. This is 
-0001c940: 6d6f 7374 206c 696b 656c 7920 6475 6520  most likely due 
-0001c950: 746f 2069 6e63 6f72 7265 6374 2027 0a20  to incorrect '. 
-0001c960: 2020 2020 2020 2020 2020 2027 6372 6564             'cred
-0001c970: 656e 7469 616c 7320 6f72 2069 6e63 6f72  entials or incor
-0001c980: 7265 6374 2070 6572 6d69 7373 696f 6e73  rect permissions
-0001c990: 2066 6f72 2074 6865 206b 6579 2066 696c   for the key fil
-0001c9a0: 652e 2043 6865 636b 2027 0a20 2020 2020  e. Check '.     
-0001c9b0: 2020 2020 2020 2027 796f 7572 2063 7265         'your cre
-0001c9c0: 6465 6e74 6961 6c73 2061 6e64 2074 7279  dentials and try
-0001c9d0: 2061 6761 696e 2e27 290a 2020 2020 7375   again.').    su
-0001c9e0: 6270 726f 6365 7373 5f75 7469 6c73 2e68  bprocess_utils.h
-0001c9f0: 616e 646c 655f 7265 7475 726e 636f 6465  andle_returncode
-0001ca00: 2872 632c 0a20 2020 2020 2020 2020 2020  (rc,.           
-0001ca10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ca20: 2020 2020 2020 2020 2020 2020 636f 6d6d              comm
-0001ca30: 616e 642c 0a20 2020 2020 2020 2020 2020  and,.           
-0001ca40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ca50: 2020 2020 2020 2020 2020 2020 6661 696c              fail
-0001ca60: 7572 655f 6d65 7373 6167 652c 0a20 2020  ure_message,.   
+00019b90: 2020 706f 7274 3d68 616e 646c 652e 6865    port=handle.he
+00019ba0: 6164 5f73 7368 5f70 6f72 7429 0a20 2020  ad_ssh_port).   
+00019bb0: 2020 2020 2069 6620 6e6f 7420 7275 6e6e       if not runn
+00019bc0: 6572 2e63 6865 636b 5f63 6f6e 6e65 6374  er.check_connect
+00019bd0: 696f 6e28 293a 0a20 2020 2020 2020 2020  ion():.         
+00019be0: 2020 2065 7272 6f72 5f6d 7367 203d 2063     error_msg = c
+00019bf0: 6f6e 7472 6f6c 6c65 722e 7661 6c75 652e  ontroller.value.
+00019c00: 636f 6e6e 6563 7469 6f6e 5f65 7272 6f72  connection_error
+00019c10: 5f68 696e 740a 2020 2020 656c 7365 3a0a  _hint.    else:.
+00019c20: 2020 2020 2020 2020 6173 7365 7274 2063          assert c
+00019c30: 6f6e 7472 6f6c 6c65 725f 7374 6174 7573  ontroller_status
+00019c40: 203d 3d20 7374 6174 7573 5f6c 6962 2e43   == status_lib.C
+00019c50: 6c75 7374 6572 5374 6174 7573 2e55 502c  lusterStatus.UP,
+00019c60: 2068 616e 646c 650a 0a20 2020 2069 6620   handle..    if 
+00019c70: 6572 726f 725f 6d73 6720 6973 206e 6f74  error_msg is not
+00019c80: 204e 6f6e 653a 0a20 2020 2020 2020 2069   None:.        i
+00019c90: 6620 6578 6974 5f69 665f 6e6f 745f 6163  f exit_if_not_ac
+00019ca0: 6365 7373 6962 6c65 3a0a 2020 2020 2020  cessible:.      
+00019cb0: 2020 2020 2020 736b 795f 6c6f 6767 696e        sky_loggin
+00019cc0: 672e 7072 696e 7428 6572 726f 725f 6d73  g.print(error_ms
+00019cd0: 6729 0a20 2020 2020 2020 2020 2020 2073  g).            s
+00019ce0: 7973 2e65 7869 7428 3129 0a20 2020 2020  ys.exit(1).     
+00019cf0: 2020 2077 6974 6820 7578 5f75 7469 6c73     with ux_utils
+00019d00: 2e70 7269 6e74 5f65 7863 6570 7469 6f6e  .print_exception
+00019d10: 5f6e 6f5f 7472 6163 6562 6163 6b28 293a  _no_traceback():
+00019d20: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+00019d30: 7365 2065 7863 6570 7469 6f6e 732e 436c  se exceptions.Cl
+00019d40: 7573 7465 724e 6f74 5570 4572 726f 7228  usterNotUpError(
+00019d50: 6572 726f 725f 6d73 672c 0a20 2020 2020  error_msg,.     
+00019d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019d80: 2020 2020 2020 2020 2020 636c 7573 7465            cluste
+00019d90: 725f 7374 6174 7573 3d63 6f6e 7472 6f6c  r_status=control
+00019da0: 6c65 725f 7374 6174 7573 2c0a 2020 2020  ler_status,.    
+00019db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019dd0: 2020 2020 2020 2020 2020 2068 616e 646c             handl
+00019de0: 653d 6861 6e64 6c65 290a 2020 2020 6173  e=handle).    as
+00019df0: 7365 7274 2068 616e 646c 6520 6973 206e  sert handle is n
+00019e00: 6f74 204e 6f6e 6520 616e 6420 6861 6e64  ot None and hand
+00019e10: 6c65 2e68 6561 645f 6970 2069 7320 6e6f  le.head_ip is no
+00019e20: 7420 4e6f 6e65 2c20 280a 2020 2020 2020  t None, (.      
+00019e30: 2020 6861 6e64 6c65 2c20 636f 6e74 726f    handle, contro
+00019e40: 6c6c 6572 5f73 7461 7475 7329 0a20 2020  ller_status).   
+00019e50: 2072 6574 7572 6e20 6861 6e64 6c65 0a0a   return handle..
+00019e60: 0a63 6c61 7373 2043 6c6f 7564 4669 6c74  .class CloudFilt
+00019e70: 6572 2865 6e75 6d2e 456e 756d 293a 0a20  er(enum.Enum):. 
+00019e80: 2020 2023 2046 696c 7465 7220 666f 7220     # Filter for 
+00019e90: 616c 6c20 7479 7065 7320 6f66 2063 6c6f  all types of clo
+00019ea0: 7564 732e 0a20 2020 2041 4c4c 203d 2027  uds..    ALL = '
+00019eb0: 616c 6c27 0a20 2020 2023 2046 696c 7465  all'.    # Filte
+00019ec0: 7220 666f 7220 536b 7927 7320 6d61 696e  r for Sky's main
+00019ed0: 2063 6c6f 7564 7320 2861 7773 2c20 6763   clouds (aws, gc
+00019ee0: 702c 2061 7a75 7265 2c20 646f 636b 6572  p, azure, docker
+00019ef0: 292e 0a20 2020 2043 4c4f 5544 535f 414e  )..    CLOUDS_AN
+00019f00: 445f 444f 434b 4552 203d 2027 636c 6f75  D_DOCKER = 'clou
+00019f10: 6473 2d61 6e64 2d64 6f63 6b65 7227 0a20  ds-and-docker'. 
+00019f20: 2020 2023 2046 696c 7465 7220 666f 7220     # Filter for 
+00019f30: 6f6e 6c79 206c 6f63 616c 2063 6c6f 7564  only local cloud
+00019f40: 732e 0a20 2020 204c 4f43 414c 203d 2027  s..    LOCAL = '
+00019f50: 6c6f 6361 6c27 0a0a 0a64 6566 2067 6574  local'...def get
+00019f60: 5f63 6c75 7374 6572 7328 0a20 2020 2069  _clusters(.    i
+00019f70: 6e63 6c75 6465 5f63 6f6e 7472 6f6c 6c65  nclude_controlle
+00019f80: 723a 2062 6f6f 6c2c 0a20 2020 2072 6566  r: bool,.    ref
+00019f90: 7265 7368 3a20 626f 6f6c 2c0a 2020 2020  resh: bool,.    
+00019fa0: 636c 7573 7465 725f 6e61 6d65 733a 204f  cluster_names: O
+00019fb0: 7074 696f 6e61 6c5b 556e 696f 6e5b 7374  ptional[Union[st
+00019fc0: 722c 204c 6973 745b 7374 725d 5d5d 203d  r, List[str]]] =
+00019fd0: 204e 6f6e 652c 0a29 202d 3e20 4c69 7374   None,.) -> List
+00019fe0: 5b44 6963 745b 7374 722c 2041 6e79 5d5d  [Dict[str, Any]]
+00019ff0: 3a0a 2020 2020 2222 2252 6574 7572 6e73  :.    """Returns
+0001a000: 2061 206c 6973 7420 6f66 2063 6163 6865   a list of cache
+0001a010: 6420 6f72 206f 7074 696f 6e61 6c6c 7920  d or optionally 
+0001a020: 7265 6672 6573 6865 6420 636c 7573 7465  refreshed cluste
+0001a030: 7220 7265 636f 7264 732e 0a0a 2020 2020  r records...    
+0001a040: 436f 6d62 7320 7468 726f 7567 6820 7468  Combs through th
+0001a050: 6520 6461 7461 6261 7365 2028 696e 207e  e database (in ~
+0001a060: 2f2e 736b 792f 7374 6174 652e 6462 2920  /.sky/state.db) 
+0001a070: 746f 2067 6574 2061 206c 6973 7420 6f66  to get a list of
+0001a080: 2072 6563 6f72 6473 0a20 2020 2063 6f72   records.    cor
+0001a090: 7265 7370 6f6e 6469 6e67 2074 6f20 6c61  responding to la
+0001a0a0: 756e 6368 6564 2063 6c75 7374 6572 7320  unched clusters 
+0001a0b0: 2866 696c 7465 7265 6420 6279 2060 636c  (filtered by `cl
+0001a0c0: 7573 7465 725f 6e61 6d65 7360 2069 6620  uster_names` if 
+0001a0d0: 6974 2069 730a 2020 2020 7370 6563 6966  it is.    specif
+0001a0e0: 6965 6429 2e20 5468 6520 7265 6672 6573  ied). The refres
+0001a0f0: 6820 666c 6167 2063 616e 2062 6520 7573  h flag can be us
+0001a100: 6564 2074 6f20 666f 7263 6520 6120 7265  ed to force a re
+0001a110: 6672 6573 6820 6f66 2074 6865 2073 7461  fresh of the sta
+0001a120: 7475 730a 2020 2020 6f66 2074 6865 2063  tus.    of the c
+0001a130: 6c75 7374 6572 732e 0a0a 2020 2020 4172  lusters...    Ar
+0001a140: 6773 3a0a 2020 2020 2020 2020 696e 636c  gs:.        incl
+0001a150: 7564 655f 636f 6e74 726f 6c6c 6572 3a20  ude_controller: 
+0001a160: 5768 6574 6865 7220 746f 2069 6e63 6c75  Whether to inclu
+0001a170: 6465 2063 6f6e 7472 6f6c 6c65 7273 2c20  de controllers, 
+0001a180: 652e 672e 206a 6f62 7320 636f 6e74 726f  e.g. jobs contro
+0001a190: 6c6c 6572 0a20 2020 2020 2020 2020 2020  ller.           
+0001a1a0: 206f 7220 736b 7920 7365 7276 6520 636f   or sky serve co
+0001a1b0: 6e74 726f 6c6c 6572 2e0a 2020 2020 2020  ntroller..      
+0001a1c0: 2020 7265 6672 6573 683a 2057 6865 7468    refresh: Wheth
+0001a1d0: 6572 2074 6f20 7265 6672 6573 6820 7468  er to refresh th
+0001a1e0: 6520 7374 6174 7573 206f 6620 7468 6520  e status of the 
+0001a1f0: 636c 7573 7465 7273 2e20 2852 6566 7265  clusters. (Refre
+0001a200: 7368 696e 6720 7769 6c6c 0a20 2020 2020  shing will.     
+0001a210: 2020 2020 2020 2073 6574 2074 6865 2073         set the s
+0001a220: 7461 7475 7320 746f 2053 544f 5050 4544  tatus to STOPPED
+0001a230: 2069 6620 7468 6520 636c 7573 7465 7220   if the cluster 
+0001a240: 6361 6e6e 6f74 2062 6520 7069 6e67 6564  cannot be pinged
+0001a250: 2e29 0a20 2020 2020 2020 2063 6c6f 7564  .).        cloud
+0001a260: 5f66 696c 7465 723a 2053 6574 7320 7768  _filter: Sets wh
+0001a270: 6963 6820 636c 6f75 6473 2074 6f20 6669  ich clouds to fi
+0001a280: 6c65 7220 7468 726f 7567 6820 6672 6f6d  ler through from
+0001a290: 2074 6865 2067 6c6f 6261 6c20 7573 6572   the global user
+0001a2a0: 0a20 2020 2020 2020 2020 2020 2073 7461  .            sta
+0001a2b0: 7465 2e20 5375 7070 6f72 7473 2074 6872  te. Supports thr
+0001a2c0: 6565 2076 616c 7565 732c 2027 616c 6c27  ee values, 'all'
+0001a2d0: 2066 6f72 2061 6c6c 2063 6c6f 7564 732c   for all clouds,
+0001a2e0: 2027 7075 626c 6963 2720 666f 720a 2020   'public' for.  
+0001a2f0: 2020 2020 2020 2020 2020 7075 626c 6963            public
+0001a300: 2063 6c6f 7564 7320 6f6e 6c79 2c20 616e   clouds only, an
+0001a310: 6420 276c 6f63 616c 2720 666f 7220 6f6e  d 'local' for on
+0001a320: 6c79 206c 6f63 616c 2063 6c6f 7564 732e  ly local clouds.
+0001a330: 0a20 2020 2020 2020 2063 6c75 7374 6572  .        cluster
+0001a340: 5f6e 616d 6573 3a20 4966 2070 726f 7669  _names: If provi
+0001a350: 6465 642c 206f 6e6c 7920 7265 7475 726e  ded, only return
+0001a360: 2072 6563 6f72 6473 2066 6f72 2074 6865   records for the
+0001a370: 2067 6976 656e 2063 6c75 7374 6572 0a20   given cluster. 
+0001a380: 2020 2020 2020 2020 2020 206e 616d 6573             names
+0001a390: 2e0a 0a20 2020 2052 6574 7572 6e73 3a0a  ...    Returns:.
+0001a3a0: 2020 2020 2020 2020 4120 6c69 7374 206f          A list o
+0001a3b0: 6620 636c 7573 7465 7220 7265 636f 7264  f cluster record
+0001a3c0: 732e 2049 6620 7468 6520 636c 7573 7465  s. If the cluste
+0001a3d0: 7220 646f 6573 206e 6f74 2065 7869 7374  r does not exist
+0001a3e0: 206f 7220 6861 7320 6265 656e 0a20 2020   or has been.   
+0001a3f0: 2020 2020 2074 6572 6d69 6e61 7465 642c       terminated,
+0001a400: 2074 6865 2072 6563 6f72 6420 7769 6c6c   the record will
+0001a410: 2062 6520 6f6d 6974 7465 6420 6672 6f6d   be omitted from
+0001a420: 2074 6865 2072 6574 7572 6e65 6420 6c69   the returned li
+0001a430: 7374 2e0a 2020 2020 2222 220a 2020 2020  st..    """.    
+0001a440: 7265 636f 7264 7320 3d20 676c 6f62 616c  records = global
+0001a450: 5f75 7365 725f 7374 6174 652e 6765 745f  _user_state.get_
+0001a460: 636c 7573 7465 7273 2829 0a0a 2020 2020  clusters()..    
+0001a470: 6966 206e 6f74 2069 6e63 6c75 6465 5f63  if not include_c
+0001a480: 6f6e 7472 6f6c 6c65 723a 0a20 2020 2020  ontroller:.     
+0001a490: 2020 2072 6563 6f72 6473 203d 205b 0a20     records = [. 
+0001a4a0: 2020 2020 2020 2020 2020 2072 6563 6f72             recor
+0001a4b0: 6420 666f 7220 7265 636f 7264 2069 6e20  d for record in 
+0001a4c0: 7265 636f 7264 730a 2020 2020 2020 2020  records.        
+0001a4d0: 2020 2020 6966 2063 6f6e 7472 6f6c 6c65      if controlle
+0001a4e0: 725f 7574 696c 732e 436f 6e74 726f 6c6c  r_utils.Controll
+0001a4f0: 6572 732e 6672 6f6d 5f6e 616d 6528 7265  ers.from_name(re
+0001a500: 636f 7264 5b27 6e61 6d65 275d 2920 6973  cord['name']) is
+0001a510: 204e 6f6e 650a 2020 2020 2020 2020 5d0a   None.        ].
+0001a520: 0a20 2020 2079 656c 6c6f 7720 3d20 636f  .    yellow = co
+0001a530: 6c6f 7261 6d61 2e46 6f72 652e 5945 4c4c  lorama.Fore.YELL
+0001a540: 4f57 0a20 2020 2062 7269 6768 7420 3d20  OW.    bright = 
+0001a550: 636f 6c6f 7261 6d61 2e53 7479 6c65 2e42  colorama.Style.B
+0001a560: 5249 4748 540a 2020 2020 7265 7365 7420  RIGHT.    reset 
+0001a570: 3d20 636f 6c6f 7261 6d61 2e53 7479 6c65  = colorama.Style
+0001a580: 2e52 4553 4554 5f41 4c4c 0a0a 2020 2020  .RESET_ALL..    
+0001a590: 6966 2063 6c75 7374 6572 5f6e 616d 6573  if cluster_names
+0001a5a0: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+0001a5b0: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
+0001a5c0: 6e63 6528 636c 7573 7465 725f 6e61 6d65  nce(cluster_name
+0001a5d0: 732c 2073 7472 293a 0a20 2020 2020 2020  s, str):.       
+0001a5e0: 2020 2020 2063 6c75 7374 6572 5f6e 616d       cluster_nam
+0001a5f0: 6573 203d 205b 636c 7573 7465 725f 6e61  es = [cluster_na
+0001a600: 6d65 735d 0a20 2020 2020 2020 206e 6577  mes].        new
+0001a610: 5f72 6563 6f72 6473 203d 205b 5d0a 2020  _records = [].  
+0001a620: 2020 2020 2020 6e6f 745f 6578 6973 745f        not_exist_
+0001a630: 636c 7573 7465 725f 6e61 6d65 7320 3d20  cluster_names = 
+0001a640: 5b5d 0a20 2020 2020 2020 2066 6f72 2063  [].        for c
+0001a650: 6c75 7374 6572 5f6e 616d 6520 696e 2063  luster_name in c
+0001a660: 6c75 7374 6572 5f6e 616d 6573 3a0a 2020  luster_names:.  
+0001a670: 2020 2020 2020 2020 2020 666f 7220 7265            for re
+0001a680: 636f 7264 2069 6e20 7265 636f 7264 733a  cord in records:
+0001a690: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001a6a0: 2069 6620 7265 636f 7264 5b27 6e61 6d65   if record['name
+0001a6b0: 275d 203d 3d20 636c 7573 7465 725f 6e61  '] == cluster_na
+0001a6c0: 6d65 3a0a 2020 2020 2020 2020 2020 2020  me:.            
+0001a6d0: 2020 2020 2020 2020 6e65 775f 7265 636f          new_reco
+0001a6e0: 7264 732e 6170 7065 6e64 2872 6563 6f72  rds.append(recor
+0001a6f0: 6429 0a20 2020 2020 2020 2020 2020 2020  d).             
+0001a700: 2020 2020 2020 2062 7265 616b 0a20 2020         break.   
+0001a710: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+0001a720: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+0001a730: 6f74 5f65 7869 7374 5f63 6c75 7374 6572  ot_exist_cluster
+0001a740: 5f6e 616d 6573 2e61 7070 656e 6428 636c  _names.append(cl
+0001a750: 7573 7465 725f 6e61 6d65 290a 2020 2020  uster_name).    
+0001a760: 2020 2020 6966 206e 6f74 5f65 7869 7374      if not_exist
+0001a770: 5f63 6c75 7374 6572 5f6e 616d 6573 3a0a  _cluster_names:.
+0001a780: 2020 2020 2020 2020 2020 2020 636c 7573              clus
+0001a790: 7465 7273 5f73 7472 203d 2027 2c20 272e  ters_str = ', '.
+0001a7a0: 6a6f 696e 286e 6f74 5f65 7869 7374 5f63  join(not_exist_c
+0001a7b0: 6c75 7374 6572 5f6e 616d 6573 290a 2020  luster_names).  
+0001a7c0: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
+0001a7d0: 2e69 6e66 6f28 6627 436c 7573 7465 7228  .info(f'Cluster(
+0001a7e0: 7329 206e 6f74 2066 6f75 6e64 3a20 7b62  s) not found: {b
+0001a7f0: 7269 6768 747d 7b63 6c75 7374 6572 735f  right}{clusters_
+0001a800: 7374 727d 7b72 6573 6574 7d2e 2729 0a20  str}{reset}.'). 
+0001a810: 2020 2020 2020 2072 6563 6f72 6473 203d         records =
+0001a820: 206e 6577 5f72 6563 6f72 6473 0a0a 2020   new_records..  
+0001a830: 2020 6966 206e 6f74 2072 6566 7265 7368    if not refresh
+0001a840: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+0001a850: 2072 6563 6f72 6473 0a0a 2020 2020 706c   records..    pl
+0001a860: 7572 616c 203d 2027 7327 2069 6620 6c65  ural = 's' if le
+0001a870: 6e28 7265 636f 7264 7329 203e 2031 2065  n(records) > 1 e
+0001a880: 6c73 6520 2727 0a20 2020 2070 726f 6772  lse ''.    progr
+0001a890: 6573 7320 3d20 7269 6368 5f70 726f 6772  ess = rich_progr
+0001a8a0: 6573 732e 5072 6f67 7265 7373 2874 7261  ess.Progress(tra
+0001a8b0: 6e73 6965 6e74 3d54 7275 652c 0a20 2020  nsient=True,.   
+0001a8c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a8e0: 2020 2072 6564 6972 6563 745f 7374 646f     redirect_stdo
+0001a8f0: 7574 3d46 616c 7365 2c0a 2020 2020 2020  ut=False,.      
+0001a900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a920: 7265 6469 7265 6374 5f73 7464 6572 723d  redirect_stderr=
+0001a930: 4661 6c73 6529 0a20 2020 2074 6173 6b20  False).    task 
+0001a940: 3d20 7072 6f67 7265 7373 2e61 6464 5f74  = progress.add_t
+0001a950: 6173 6b28 0a20 2020 2020 2020 2066 275b  ask(.        f'[
+0001a960: 626f 6c64 2063 7961 6e5d 5265 6672 6573  bold cyan]Refres
+0001a970: 6869 6e67 2073 7461 7475 7320 666f 7220  hing status for 
+0001a980: 7b6c 656e 2872 6563 6f72 6473 297d 2063  {len(records)} c
+0001a990: 6c75 7374 6572 7b70 6c75 7261 6c7d 5b2f  luster{plural}[/
+0001a9a0: 5d27 2c0a 2020 2020 2020 2020 746f 7461  ]',.        tota
+0001a9b0: 6c3d 6c65 6e28 7265 636f 7264 7329 290a  l=len(records)).
+0001a9c0: 0a20 2020 2064 6566 205f 7265 6672 6573  .    def _refres
+0001a9d0: 685f 636c 7573 7465 7228 636c 7573 7465  h_cluster(cluste
+0001a9e0: 725f 6e61 6d65 293a 0a20 2020 2020 2020  r_name):.       
+0001a9f0: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+0001aa00: 2020 7265 636f 7264 203d 2072 6566 7265    record = refre
+0001aa10: 7368 5f63 6c75 7374 6572 5f72 6563 6f72  sh_cluster_recor
+0001aa20: 6428 0a20 2020 2020 2020 2020 2020 2020  d(.             
+0001aa30: 2020 2063 6c75 7374 6572 5f6e 616d 652c     cluster_name,
+0001aa40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001aa50: 2066 6f72 6365 5f72 6566 7265 7368 5f73   force_refresh_s
+0001aa60: 7461 7475 7365 733d 7365 7428 7374 6174  tatuses=set(stat
+0001aa70: 7573 5f6c 6962 2e43 6c75 7374 6572 5374  us_lib.ClusterSt
+0001aa80: 6174 7573 292c 0a20 2020 2020 2020 2020  atus),.         
+0001aa90: 2020 2020 2020 2061 6371 7569 7265 5f70         acquire_p
+0001aaa0: 6572 5f63 6c75 7374 6572 5f73 7461 7475  er_cluster_statu
+0001aab0: 735f 6c6f 636b 3d54 7275 6529 0a20 2020  s_lock=True).   
+0001aac0: 2020 2020 2065 7863 6570 7420 2865 7863       except (exc
+0001aad0: 6570 7469 6f6e 732e 436c 7573 7465 7253  eptions.ClusterS
+0001aae0: 7461 7475 7346 6574 6368 696e 6745 7272  tatusFetchingErr
+0001aaf0: 6f72 2c0a 2020 2020 2020 2020 2020 2020  or,.            
+0001ab00: 2020 2020 6578 6365 7074 696f 6e73 2e43      exceptions.C
+0001ab10: 6c6f 7564 5573 6572 4964 656e 7469 7479  loudUserIdentity
+0001ab20: 4572 726f 722c 0a20 2020 2020 2020 2020  Error,.         
+0001ab30: 2020 2020 2020 2065 7863 6570 7469 6f6e         exception
+0001ab40: 732e 436c 7573 7465 724f 776e 6572 4964  s.ClusterOwnerId
+0001ab50: 656e 7469 7479 4d69 736d 6174 6368 4572  entityMismatchEr
+0001ab60: 726f 7229 2061 7320 653a 0a20 2020 2020  ror) as e:.     
+0001ab70: 2020 2020 2020 2023 2044 6f20 6e6f 7420         # Do not 
+0001ab80: 6661 696c 2074 6865 2065 6e74 6972 6520  fail the entire 
+0001ab90: 7265 6672 6573 6820 7072 6f63 6573 732e  refresh process.
+0001aba0: 2054 6865 2063 616c 6c65 7220 7769 6c6c   The caller will
+0001abb0: 0a20 2020 2020 2020 2020 2020 2023 2068  .            # h
+0001abc0: 616e 646c 6520 7468 6520 2755 4e4b 4e4f  andle the 'UNKNO
+0001abd0: 574e 2720 7374 6174 7573 2c20 616e 6420  WN' status, and 
+0001abe0: 636f 6c6c 6563 7420 7468 6520 6572 726f  collect the erro
+0001abf0: 7273 2069 6e74 6f0a 2020 2020 2020 2020  rs into.        
+0001ac00: 2020 2020 2320 6120 7461 626c 652e 0a20      # a table.. 
+0001ac10: 2020 2020 2020 2020 2020 2072 6563 6f72             recor
+0001ac20: 6420 3d20 7b27 7374 6174 7573 273a 2027  d = {'status': '
+0001ac30: 554e 4b4e 4f57 4e27 2c20 2765 7272 6f72  UNKNOWN', 'error
+0001ac40: 273a 2065 7d0a 2020 2020 2020 2020 7072  ': e}.        pr
+0001ac50: 6f67 7265 7373 2e75 7064 6174 6528 7461  ogress.update(ta
+0001ac60: 736b 2c20 6164 7661 6e63 653d 3129 0a20  sk, advance=1). 
+0001ac70: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
+0001ac80: 636f 7264 0a0a 2020 2020 636c 7573 7465  cord..    cluste
+0001ac90: 725f 6e61 6d65 7320 3d20 5b72 6563 6f72  r_names = [recor
+0001aca0: 645b 276e 616d 6527 5d20 666f 7220 7265  d['name'] for re
+0001acb0: 636f 7264 2069 6e20 7265 636f 7264 735d  cord in records]
+0001acc0: 0a20 2020 2077 6974 6820 7072 6f67 7265  .    with progre
+0001acd0: 7373 3a0a 2020 2020 2020 2020 7570 6461  ss:.        upda
+0001ace0: 7465 645f 7265 636f 7264 7320 3d20 7375  ted_records = su
+0001acf0: 6270 726f 6365 7373 5f75 7469 6c73 2e72  bprocess_utils.r
+0001ad00: 756e 5f69 6e5f 7061 7261 6c6c 656c 280a  un_in_parallel(.
+0001ad10: 2020 2020 2020 2020 2020 2020 5f72 6566              _ref
+0001ad20: 7265 7368 5f63 6c75 7374 6572 2c20 636c  resh_cluster, cl
+0001ad30: 7573 7465 725f 6e61 6d65 7329 0a0a 2020  uster_names)..  
+0001ad40: 2020 2320 5368 6f77 2069 6e66 6f72 6d61    # Show informa
+0001ad50: 7469 6f6e 2066 6f72 2072 656d 6f76 6564  tion for removed
+0001ad60: 2063 6c75 7374 6572 732e 0a20 2020 206b   clusters..    k
+0001ad70: 6570 745f 7265 636f 7264 7320 3d20 5b5d  ept_records = []
+0001ad80: 0a20 2020 2061 7574 6f64 6f77 6e5f 636c  .    autodown_cl
+0001ad90: 7573 7465 7273 2c20 7265 6d61 696e 696e  usters, remainin
+0001ada0: 675f 636c 7573 7465 7273 2c20 6661 696c  g_clusters, fail
+0001adb0: 6564 5f63 6c75 7374 6572 7320 3d20 5b5d  ed_clusters = []
+0001adc0: 2c20 5b5d 2c20 5b5d 0a20 2020 2066 6f72  , [], [].    for
+0001add0: 2069 2c20 7265 636f 7264 2069 6e20 656e   i, record in en
+0001ade0: 756d 6572 6174 6528 7265 636f 7264 7329  umerate(records)
+0001adf0: 3a0a 2020 2020 2020 2020 6966 2075 7064  :.        if upd
+0001ae00: 6174 6564 5f72 6563 6f72 6473 5b69 5d20  ated_records[i] 
+0001ae10: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+0001ae20: 2020 2020 2069 6620 7265 636f 7264 5b27       if record['
+0001ae30: 746f 5f64 6f77 6e27 5d3a 0a20 2020 2020  to_down']:.     
+0001ae40: 2020 2020 2020 2020 2020 2061 7574 6f64             autod
+0001ae50: 6f77 6e5f 636c 7573 7465 7273 2e61 7070  own_clusters.app
+0001ae60: 656e 6428 636c 7573 7465 725f 6e61 6d65  end(cluster_name
+0001ae70: 735b 695d 290a 2020 2020 2020 2020 2020  s[i]).          
+0001ae80: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0001ae90: 2020 2020 2020 2020 7265 6d61 696e 696e          remainin
+0001aea0: 675f 636c 7573 7465 7273 2e61 7070 656e  g_clusters.appen
+0001aeb0: 6428 636c 7573 7465 725f 6e61 6d65 735b  d(cluster_names[
+0001aec0: 695d 290a 2020 2020 2020 2020 656c 6966  i]).        elif
+0001aed0: 2075 7064 6174 6564 5f72 6563 6f72 6473   updated_records
+0001aee0: 5b69 5d5b 2773 7461 7475 7327 5d20 3d3d  [i]['status'] ==
+0001aef0: 2027 554e 4b4e 4f57 4e27 3a0a 2020 2020   'UNKNOWN':.    
+0001af00: 2020 2020 2020 2020 6661 696c 6564 5f63          failed_c
+0001af10: 6c75 7374 6572 732e 6170 7065 6e64 280a  lusters.append(.
+0001af20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001af30: 2863 6c75 7374 6572 5f6e 616d 6573 5b69  (cluster_names[i
+0001af40: 5d2c 2075 7064 6174 6564 5f72 6563 6f72  ], updated_recor
+0001af50: 6473 5b69 5d5b 2765 7272 6f72 275d 2929  ds[i]['error']))
+0001af60: 0a20 2020 2020 2020 2020 2020 2023 204b  .            # K
+0001af70: 6565 7020 7468 6520 6f72 6967 696e 616c  eep the original
+0001af80: 2072 6563 6f72 6420 6966 2074 6865 2073   record if the s
+0001af90: 7461 7475 7320 6973 2075 6e6b 6e6f 776e  tatus is unknown
+0001afa0: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
+0001afb0: 736f 2074 6861 7420 7468 6520 7573 6572  so that the user
+0001afc0: 2063 616e 2073 7469 6c6c 2073 6565 2074   can still see t
+0001afd0: 6865 2063 6c75 7374 6572 2e0a 2020 2020  he cluster..    
+0001afe0: 2020 2020 2020 2020 6b65 7074 5f72 6563          kept_rec
+0001aff0: 6f72 6473 2e61 7070 656e 6428 7265 636f  ords.append(reco
+0001b000: 7264 290a 2020 2020 2020 2020 656c 7365  rd).        else
+0001b010: 3a0a 2020 2020 2020 2020 2020 2020 6b65  :.            ke
+0001b020: 7074 5f72 6563 6f72 6473 2e61 7070 656e  pt_records.appen
+0001b030: 6428 7570 6461 7465 645f 7265 636f 7264  d(updated_record
+0001b040: 735b 695d 290a 0a20 2020 2069 6620 6175  s[i])..    if au
+0001b050: 746f 646f 776e 5f63 6c75 7374 6572 733a  todown_clusters:
+0001b060: 0a20 2020 2020 2020 2070 6c75 7261 6c20  .        plural 
+0001b070: 3d20 2773 2720 6966 206c 656e 2861 7574  = 's' if len(aut
+0001b080: 6f64 6f77 6e5f 636c 7573 7465 7273 2920  odown_clusters) 
+0001b090: 3e20 3120 656c 7365 2027 270a 2020 2020  > 1 else ''.    
+0001b0a0: 2020 2020 636c 7573 7465 725f 7374 7220      cluster_str 
+0001b0b0: 3d20 272c 2027 2e6a 6f69 6e28 6175 746f  = ', '.join(auto
+0001b0c0: 646f 776e 5f63 6c75 7374 6572 7329 0a20  down_clusters). 
+0001b0d0: 2020 2020 2020 206c 6f67 6765 722e 696e         logger.in
+0001b0e0: 666f 2866 2741 7574 6f64 6f77 6e65 6420  fo(f'Autodowned 
+0001b0f0: 636c 7573 7465 727b 706c 7572 616c 7d3a  cluster{plural}:
+0001b100: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+0001b110: 2020 2020 2020 2066 277b 6272 6967 6874         f'{bright
+0001b120: 7d7b 636c 7573 7465 725f 7374 727d 7b72  }{cluster_str}{r
+0001b130: 6573 6574 7d27 290a 2020 2020 6966 2072  eset}').    if r
+0001b140: 656d 6169 6e69 6e67 5f63 6c75 7374 6572  emaining_cluster
+0001b150: 733a 0a20 2020 2020 2020 2070 6c75 7261  s:.        plura
+0001b160: 6c20 3d20 2773 2720 6966 206c 656e 2872  l = 's' if len(r
+0001b170: 656d 6169 6e69 6e67 5f63 6c75 7374 6572  emaining_cluster
+0001b180: 7329 203e 2031 2065 6c73 6520 2727 0a20  s) > 1 else ''. 
+0001b190: 2020 2020 2020 2063 6c75 7374 6572 5f73         cluster_s
+0001b1a0: 7472 203d 2027 2c20 272e 6a6f 696e 286e  tr = ', '.join(n
+0001b1b0: 616d 6520 666f 7220 6e61 6d65 2069 6e20  ame for name in 
+0001b1c0: 7265 6d61 696e 696e 675f 636c 7573 7465  remaining_cluste
+0001b1d0: 7273 290a 2020 2020 2020 2020 6c6f 6767  rs).        logg
+0001b1e0: 6572 2e77 6172 6e69 6e67 2866 277b 7965  er.warning(f'{ye
+0001b1f0: 6c6c 6f77 7d43 6c75 7374 6572 7b70 6c75  llow}Cluster{plu
+0001b200: 7261 6c7d 2074 6572 6d69 6e61 7465 6420  ral} terminated 
+0001b210: 6f6e 2027 0a20 2020 2020 2020 2020 2020  on '.           
+0001b220: 2020 2020 2020 2020 2020 2020 6627 7468              f'th
+0001b230: 6520 636c 6f75 643a 207b 7265 7365 747d  e cloud: {reset}
+0001b240: 7b62 7269 6768 747d 7b63 6c75 7374 6572  {bright}{cluster
+0001b250: 5f73 7472 7d7b 7265 7365 747d 2729 0a0a  _str}{reset}')..
+0001b260: 2020 2020 6966 2066 6169 6c65 645f 636c      if failed_cl
+0001b270: 7573 7465 7273 3a0a 2020 2020 2020 2020  usters:.        
+0001b280: 706c 7572 616c 203d 2027 7327 2069 6620  plural = 's' if 
+0001b290: 6c65 6e28 6661 696c 6564 5f63 6c75 7374  len(failed_clust
+0001b2a0: 6572 7329 203e 2031 2065 6c73 6520 2727  ers) > 1 else ''
+0001b2b0: 0a20 2020 2020 2020 206c 6f67 6765 722e  .        logger.
+0001b2c0: 7761 726e 696e 6728 6627 7b79 656c 6c6f  warning(f'{yello
+0001b2d0: 777d 4661 696c 6564 2074 6f20 7265 6672  w}Failed to refr
+0001b2e0: 6573 6820 7374 6174 7573 2066 6f72 2027  esh status for '
+0001b2f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001b300: 2020 2020 2020 2020 6627 7b6c 656e 2866          f'{len(f
+0001b310: 6169 6c65 645f 636c 7573 7465 7273 297d  ailed_clusters)}
+0001b320: 2063 6c75 7374 6572 7b70 6c75 7261 6c7d   cluster{plural}
+0001b330: 3a7b 7265 7365 747d 2729 0a20 2020 2020  :{reset}').     
+0001b340: 2020 2066 6f72 2063 6c75 7374 6572 5f6e     for cluster_n
+0001b350: 616d 652c 2065 2069 6e20 6661 696c 6564  ame, e in failed
+0001b360: 5f63 6c75 7374 6572 733a 0a20 2020 2020  _clusters:.     
+0001b370: 2020 2020 2020 206c 6f67 6765 722e 7761         logger.wa
+0001b380: 726e 696e 6728 6627 2020 7b62 7269 6768  rning(f'  {brigh
+0001b390: 747d 7b63 6c75 7374 6572 5f6e 616d 657d  t}{cluster_name}
+0001b3a0: 7b72 6573 6574 7d3a 207b 657d 2729 0a20  {reset}: {e}'). 
+0001b3b0: 2020 2072 6574 7572 6e20 6b65 7074 5f72     return kept_r
+0001b3c0: 6563 6f72 6473 0a0a 0a40 7479 7069 6e67  ecords...@typing
+0001b3d0: 2e6f 7665 726c 6f61 640a 6465 6620 6765  .overload.def ge
+0001b3e0: 745f 6261 636b 656e 645f 6672 6f6d 5f68  t_backend_from_h
+0001b3f0: 616e 646c 6528 0a20 2020 2068 616e 646c  andle(.    handl
+0001b400: 653a 2027 636c 6f75 645f 766d 5f72 6179  e: 'cloud_vm_ray
+0001b410: 5f62 6163 6b65 6e64 2e43 6c6f 7564 566d  _backend.CloudVm
+0001b420: 5261 7952 6573 6f75 7263 6548 616e 646c  RayResourceHandl
+0001b430: 6527 0a29 202d 3e20 2763 6c6f 7564 5f76  e'.) -> 'cloud_v
+0001b440: 6d5f 7261 795f 6261 636b 656e 642e 436c  m_ray_backend.Cl
+0001b450: 6f75 6456 6d52 6179 4261 636b 656e 6427  oudVmRayBackend'
+0001b460: 3a0a 2020 2020 2e2e 2e0a 0a0a 4074 7970  :.    ......@typ
+0001b470: 696e 672e 6f76 6572 6c6f 6164 0a64 6566  ing.overload.def
+0001b480: 2067 6574 5f62 6163 6b65 6e64 5f66 726f   get_backend_fro
+0001b490: 6d5f 6861 6e64 6c65 280a 2020 2020 6861  m_handle(.    ha
+0001b4a0: 6e64 6c65 3a20 276c 6f63 616c 5f64 6f63  ndle: 'local_doc
+0001b4b0: 6b65 725f 6261 636b 656e 642e 4c6f 6361  ker_backend.Loca
+0001b4c0: 6c44 6f63 6b65 7252 6573 6f75 7263 6548  lDockerResourceH
+0001b4d0: 616e 646c 6527 0a29 202d 3e20 276c 6f63  andle'.) -> 'loc
+0001b4e0: 616c 5f64 6f63 6b65 725f 6261 636b 656e  al_docker_backen
+0001b4f0: 642e 4c6f 6361 6c44 6f63 6b65 7242 6163  d.LocalDockerBac
+0001b500: 6b65 6e64 273a 0a20 2020 202e 2e2e 0a0a  kend':.    .....
+0001b510: 0a40 7479 7069 6e67 2e6f 7665 726c 6f61  .@typing.overloa
+0001b520: 640a 6465 6620 6765 745f 6261 636b 656e  d.def get_backen
+0001b530: 645f 6672 6f6d 5f68 616e 646c 6528 0a20  d_from_handle(. 
+0001b540: 2020 2020 2020 2068 616e 646c 653a 2062         handle: b
+0001b550: 6163 6b65 6e64 732e 5265 736f 7572 6365  ackends.Resource
+0001b560: 4861 6e64 6c65 2920 2d3e 2062 6163 6b65  Handle) -> backe
+0001b570: 6e64 732e 4261 636b 656e 643a 0a20 2020  nds.Backend:.   
+0001b580: 202e 2e2e 0a0a 0a64 6566 2067 6574 5f62   ......def get_b
+0001b590: 6163 6b65 6e64 5f66 726f 6d5f 6861 6e64  ackend_from_hand
+0001b5a0: 6c65 280a 2020 2020 2020 2020 6861 6e64  le(.        hand
+0001b5b0: 6c65 3a20 6261 636b 656e 6473 2e52 6573  le: backends.Res
+0001b5c0: 6f75 7263 6548 616e 646c 6529 202d 3e20  ourceHandle) -> 
+0001b5d0: 6261 636b 656e 6473 2e42 6163 6b65 6e64  backends.Backend
+0001b5e0: 3a0a 2020 2020 2222 2247 6574 7320 6120  :.    """Gets a 
+0001b5f0: 4261 636b 656e 6420 6f62 6a65 6374 2063  Backend object c
+0001b600: 6f72 7265 7370 6f6e 6469 6e67 2074 6f20  orresponding to 
+0001b610: 6120 6861 6e64 6c65 2e0a 0a20 2020 2049  a handle...    I
+0001b620: 6e73 7065 6374 7320 6861 6e64 6c65 2074  nspects handle t
+0001b630: 7970 6520 746f 2069 6e66 6572 2074 6865  ype to infer the
+0001b640: 2062 6163 6b65 6e64 2075 7365 6420 666f   backend used fo
+0001b650: 7220 7468 6520 7265 736f 7572 6365 2e0a  r the resource..
+0001b660: 2020 2020 2222 220a 2020 2020 6261 636b      """.    back
+0001b670: 656e 643a 2062 6163 6b65 6e64 732e 4261  end: backends.Ba
+0001b680: 636b 656e 640a 2020 2020 6966 2069 7369  ckend.    if isi
+0001b690: 6e73 7461 6e63 6528 6861 6e64 6c65 2c20  nstance(handle, 
+0001b6a0: 6261 636b 656e 6473 2e43 6c6f 7564 566d  backends.CloudVm
+0001b6b0: 5261 7952 6573 6f75 7263 6548 616e 646c  RayResourceHandl
+0001b6c0: 6529 3a0a 2020 2020 2020 2020 6261 636b  e):.        back
+0001b6d0: 656e 6420 3d20 6261 636b 656e 6473 2e43  end = backends.C
+0001b6e0: 6c6f 7564 566d 5261 7942 6163 6b65 6e64  loudVmRayBackend
+0001b6f0: 2829 0a20 2020 2065 6c69 6620 6973 696e  ().    elif isin
+0001b700: 7374 616e 6365 2868 616e 646c 652c 2062  stance(handle, b
+0001b710: 6163 6b65 6e64 732e 4c6f 6361 6c44 6f63  ackends.LocalDoc
+0001b720: 6b65 7252 6573 6f75 7263 6548 616e 646c  kerResourceHandl
+0001b730: 6529 3a0a 2020 2020 2020 2020 6261 636b  e):.        back
+0001b740: 656e 6420 3d20 6261 636b 656e 6473 2e4c  end = backends.L
+0001b750: 6f63 616c 446f 636b 6572 4261 636b 656e  ocalDockerBacken
+0001b760: 6428 290a 2020 2020 656c 7365 3a0a 2020  d().    else:.  
+0001b770: 2020 2020 2020 7261 6973 6520 4e6f 7449        raise NotI
+0001b780: 6d70 6c65 6d65 6e74 6564 4572 726f 7228  mplementedError(
+0001b790: 0a20 2020 2020 2020 2020 2020 2066 2748  .            f'H
+0001b7a0: 616e 646c 6520 7479 7065 207b 7479 7065  andle type {type
+0001b7b0: 2868 616e 646c 6529 7d20 6973 206e 6f74  (handle)} is not
+0001b7c0: 2073 7570 706f 7274 6564 2079 6574 2e27   supported yet.'
+0001b7d0: 290a 2020 2020 7265 7475 726e 2062 6163  ).    return bac
+0001b7e0: 6b65 6e64 0a0a 0a64 6566 2067 6574 5f74  kend...def get_t
+0001b7f0: 6173 6b5f 6465 6d61 6e64 735f 6469 6374  ask_demands_dict
+0001b800: 2874 6173 6b3a 2027 7461 736b 5f6c 6962  (task: 'task_lib
+0001b810: 2e54 6173 6b27 2920 2d3e 2044 6963 745b  .Task') -> Dict[
+0001b820: 7374 722c 2066 6c6f 6174 5d3a 0a20 2020  str, float]:.   
+0001b830: 2022 2222 5265 7475 726e 7320 7468 6520   """Returns the 
+0001b840: 7265 736f 7572 6365 7320 6469 6374 206f  resources dict o
+0001b850: 6620 7468 6520 7461 736b 2e0a 0a20 2020  f the task...   
+0001b860: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
+0001b870: 2020 4120 6469 6374 206f 6620 7468 6520    A dict of the 
+0001b880: 7265 736f 7572 6365 7320 6f66 2074 6865  resources of the
+0001b890: 2074 6173 6b2e 2054 6865 206b 6579 7320   task. The keys 
+0001b8a0: 6172 6520 7468 6520 7265 736f 7572 6365  are the resource
+0001b8b0: 206e 616d 6573 0a20 2020 2020 2020 2061   names.        a
+0001b8c0: 6e64 2074 6865 2076 616c 7565 7320 6172  nd the values ar
+0001b8d0: 6520 7468 6520 6e75 6d62 6572 206f 6620  e the number of 
+0001b8e0: 7468 6520 7265 736f 7572 6365 732e 2049  the resources. I
+0001b8f0: 7420 616c 7761 7973 2063 6f6e 7461 696e  t always contain
+0001b900: 730a 2020 2020 2020 2020 7468 6520 4350  s.        the CP
+0001b910: 5520 7265 736f 7572 6365 2028 746f 2063  U resource (to c
+0001b920: 6f6e 7472 6f6c 2074 6865 206d 6178 696d  ontrol the maxim
+0001b930: 756d 206e 756d 6265 7220 6f66 2074 6173  um number of tas
+0001b940: 6b73 292c 2061 6e64 0a20 2020 2020 2020  ks), and.       
+0001b950: 206f 7074 696f 6e61 6c6c 7920 6163 6365   optionally acce
+0001b960: 6c65 7261 746f 7220 6465 6d61 6e64 732e  lerator demands.
+0001b970: 0a20 2020 2022 2222 0a20 2020 2023 2054  .    """.    # T
+0001b980: 4f44 4f3a 2043 7573 746f 6d20 4350 5520  ODO: Custom CPU 
+0001b990: 616e 6420 6f74 6865 7220 6d65 6d6f 7279  and other memory
+0001b9a0: 2072 6573 6f75 7263 6573 2061 7265 206e   resources are n
+0001b9b0: 6f74 2073 7570 706f 7274 6564 2079 6574  ot supported yet
+0001b9c0: 2e0a 2020 2020 2320 466f 7220 736b 7920  ..    # For sky 
+0001b9d0: 6a6f 6273 2f73 6572 7665 2063 6f6e 7472  jobs/serve contr
+0001b9e0: 6f6c 6c65 7220 7461 736b 2c20 7765 2073  oller task, we s
+0001b9f0: 6574 2074 6865 2043 5055 2072 6573 6f75  et the CPU resou
+0001ba00: 7263 6520 746f 2061 2073 6d61 6c6c 6572  rce to a smaller
+0001ba10: 0a20 2020 2023 2076 616c 7565 2074 6f20  .    # value to 
+0001ba20: 7375 7070 6f72 7420 6120 6c61 7267 6572  support a larger
+0001ba30: 206e 756d 6265 7220 6f66 206d 616e 6167   number of manag
+0001ba40: 6564 206a 6f62 7320 616e 6420 7365 7276  ed jobs and serv
+0001ba50: 6963 6573 2e0a 2020 2020 7265 736f 7572  ices..    resour
+0001ba60: 6365 735f 6469 6374 203d 207b 0a20 2020  ces_dict = {.   
+0001ba70: 2020 2020 2027 4350 5527 3a20 2863 6f6e       'CPU': (con
+0001ba80: 7374 616e 7473 2e43 4f4e 5452 4f4c 4c45  stants.CONTROLLE
+0001ba90: 525f 5052 4f43 4553 535f 4350 555f 4445  R_PROCESS_CPU_DE
+0001baa0: 4d41 4e44 0a20 2020 2020 2020 2020 2020  MAND.           
+0001bab0: 2020 2020 2069 6620 7461 736b 2e69 735f       if task.is_
+0001bac0: 636f 6e74 726f 6c6c 6572 5f74 6173 6b28  controller_task(
+0001bad0: 2920 656c 7365 2044 4546 4155 4c54 5f54  ) else DEFAULT_T
+0001bae0: 4153 4b5f 4350 555f 4445 4d41 4e44 290a  ASK_CPU_DEMAND).
+0001baf0: 2020 2020 7d0a 2020 2020 6966 2074 6173      }.    if tas
+0001bb00: 6b2e 6265 7374 5f72 6573 6f75 7263 6573  k.best_resources
+0001bb10: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+0001bb20: 2020 2020 2020 7265 736f 7572 6365 7320        resources 
+0001bb30: 3d20 7461 736b 2e62 6573 745f 7265 736f  = task.best_reso
+0001bb40: 7572 6365 730a 2020 2020 656c 7365 3a0a  urces.    else:.
+0001bb50: 2020 2020 2020 2020 2320 5461 736b 206d          # Task m
+0001bb60: 6179 2028 652e 672e 2c20 736b 7920 6c61  ay (e.g., sky la
+0001bb70: 756e 6368 2920 6f72 206d 6179 206e 6f74  unch) or may not
+0001bb80: 2028 652e 672e 2c20 736b 7920 6578 6563   (e.g., sky exec
+0001bb90: 2920 6861 7665 2075 6e64 6572 676f 6e65  ) have undergone
+0001bba0: 0a20 2020 2020 2020 2023 2073 6b79 2e6f  .        # sky.o
+0001bbb0: 7074 696d 697a 6528 292c 2073 6f20 6265  ptimize(), so be
+0001bbc0: 7374 5f72 6573 6f75 7263 6573 206d 6179  st_resources may
+0001bbd0: 2062 6520 4e6f 6e65 2e0a 2020 2020 2020   be None..      
+0001bbe0: 2020 6173 7365 7274 206c 656e 2874 6173    assert len(tas
+0001bbf0: 6b2e 7265 736f 7572 6365 7329 203d 3d20  k.resources) == 
+0001bc00: 312c 2074 6173 6b2e 7265 736f 7572 6365  1, task.resource
+0001bc10: 730a 2020 2020 2020 2020 7265 736f 7572  s.        resour
+0001bc20: 6365 7320 3d20 6c69 7374 2874 6173 6b2e  ces = list(task.
+0001bc30: 7265 736f 7572 6365 7329 5b30 5d0a 2020  resources)[0].  
+0001bc40: 2020 6966 2072 6573 6f75 7263 6573 2069    if resources i
+0001bc50: 7320 6e6f 7420 4e6f 6e65 2061 6e64 2072  s not None and r
+0001bc60: 6573 6f75 7263 6573 2e61 6363 656c 6572  esources.acceler
+0001bc70: 6174 6f72 7320 6973 206e 6f74 204e 6f6e  ators is not Non
+0001bc80: 653a 0a20 2020 2020 2020 2072 6573 6f75  e:.        resou
+0001bc90: 7263 6573 5f64 6963 742e 7570 6461 7465  rces_dict.update
+0001bca0: 2872 6573 6f75 7263 6573 2e61 6363 656c  (resources.accel
+0001bcb0: 6572 6174 6f72 7329 0a20 2020 2072 6574  erators).    ret
+0001bcc0: 7572 6e20 7265 736f 7572 6365 735f 6469  urn resources_di
+0001bcd0: 6374 0a0a 0a64 6566 2067 6574 5f74 6173  ct...def get_tas
+0001bce0: 6b5f 7265 736f 7572 6365 735f 7374 7228  k_resources_str(
+0001bcf0: 7461 736b 3a20 2774 6173 6b5f 6c69 622e  task: 'task_lib.
+0001bd00: 5461 736b 272c 0a20 2020 2020 2020 2020  Task',.         
+0001bd10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bd20: 2020 6973 5f6d 616e 6167 6564 5f6a 6f62    is_managed_job
+0001bd30: 3a20 626f 6f6c 203d 2046 616c 7365 2920  : bool = False) 
+0001bd40: 2d3e 2073 7472 3a0a 2020 2020 2222 2252  -> str:.    """R
+0001bd50: 6574 7572 6e73 2074 6865 2072 6573 6f75  eturns the resou
+0001bd60: 7263 6573 2073 7472 696e 6720 6f66 2074  rces string of t
+0001bd70: 6865 2074 6173 6b2e 0a0a 2020 2020 5468  he task...    Th
+0001bd80: 6520 7265 736f 7572 6365 7320 7374 7269  e resources stri
+0001bd90: 6e67 2069 7320 6f6e 6c79 2075 7365 6420  ng is only used 
+0001bda0: 6173 2061 2064 6973 706c 6179 2070 7572  as a display pur
+0001bdb0: 706f 7365 2c20 736f 2077 6520 6f6e 6c79  pose, so we only
+0001bdc0: 2073 686f 770a 2020 2020 7468 6520 6163   show.    the ac
+0001bdd0: 6365 6c65 7261 746f 7220 6465 6d61 6e64  celerator demand
+0001bde0: 7320 2869 6620 616e 7929 2e20 4f74 6865  s (if any). Othe
+0001bdf0: 7277 6973 652c 2074 6865 2043 5055 2064  rwise, the CPU d
+0001be00: 656d 616e 6420 6973 2073 686f 776e 2e0a  emand is shown..
+0001be10: 2020 2020 2222 220a 2020 2020 7370 6f74      """.    spot
+0001be20: 5f73 7472 203d 2027 270a 2020 2020 7461  _str = ''.    ta
+0001be30: 736b 5f63 7075 5f64 656d 616e 6420 3d20  sk_cpu_demand = 
+0001be40: 2873 7472 2863 6f6e 7374 616e 7473 2e43  (str(constants.C
+0001be50: 4f4e 5452 4f4c 4c45 525f 5052 4f43 4553  ONTROLLER_PROCES
+0001be60: 535f 4350 555f 4445 4d41 4e44 290a 2020  S_CPU_DEMAND).  
+0001be70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001be80: 2020 2020 2069 6620 7461 736b 2e69 735f       if task.is_
+0001be90: 636f 6e74 726f 6c6c 6572 5f74 6173 6b28  controller_task(
+0001bea0: 2920 656c 7365 0a20 2020 2020 2020 2020  ) else.         
+0001beb0: 2020 2020 2020 2020 2020 2020 2020 7374                st
+0001bec0: 7228 4445 4641 554c 545f 5441 534b 5f43  r(DEFAULT_TASK_C
+0001bed0: 5055 5f44 454d 414e 4429 290a 2020 2020  PU_DEMAND)).    
+0001bee0: 6966 2074 6173 6b2e 6265 7374 5f72 6573  if task.best_res
+0001bef0: 6f75 7263 6573 2069 7320 6e6f 7420 4e6f  ources is not No
+0001bf00: 6e65 3a0a 2020 2020 2020 2020 6163 6365  ne:.        acce
+0001bf10: 6c65 7261 746f 725f 6469 6374 203d 2074  lerator_dict = t
+0001bf20: 6173 6b2e 6265 7374 5f72 6573 6f75 7263  ask.best_resourc
+0001bf30: 6573 2e61 6363 656c 6572 6174 6f72 730a  es.accelerators.
+0001bf40: 2020 2020 2020 2020 6966 2069 735f 6d61          if is_ma
+0001bf50: 6e61 6765 645f 6a6f 623a 0a20 2020 2020  naged_job:.     
+0001bf60: 2020 2020 2020 2069 6620 7461 736b 2e62         if task.b
+0001bf70: 6573 745f 7265 736f 7572 6365 732e 7573  est_resources.us
+0001bf80: 655f 7370 6f74 3a0a 2020 2020 2020 2020  e_spot:.        
+0001bf90: 2020 2020 2020 2020 7370 6f74 5f73 7472          spot_str
+0001bfa0: 203d 2027 5b53 706f 745d 270a 2020 2020   = '[Spot]'.    
+0001bfb0: 2020 2020 2020 2020 7461 736b 5f63 7075          task_cpu
+0001bfc0: 5f64 656d 616e 6420 3d20 7461 736b 2e62  _demand = task.b
+0001bfd0: 6573 745f 7265 736f 7572 6365 732e 6370  est_resources.cp
+0001bfe0: 7573 0a20 2020 2020 2020 2069 6620 6163  us.        if ac
+0001bff0: 6365 6c65 7261 746f 725f 6469 6374 2069  celerator_dict i
+0001c000: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+0001c010: 2020 2020 7265 736f 7572 6365 735f 7374      resources_st
+0001c020: 7220 3d20 6627 4350 553a 7b74 6173 6b5f  r = f'CPU:{task_
+0001c030: 6370 755f 6465 6d61 6e64 7d27 0a20 2020  cpu_demand}'.   
+0001c040: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0001c050: 2020 2020 2020 2072 6573 6f75 7263 6573         resources
+0001c060: 5f73 7472 203d 2027 2c20 272e 6a6f 696e  _str = ', '.join
+0001c070: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0001c080: 2020 6627 7b6b 7d3a 7b76 7d27 2066 6f72    f'{k}:{v}' for
+0001c090: 206b 2c20 7620 696e 2061 6363 656c 6572   k, v in acceler
+0001c0a0: 6174 6f72 5f64 6963 742e 6974 656d 7328  ator_dict.items(
+0001c0b0: 2929 0a20 2020 2065 6c73 653a 0a20 2020  )).    else:.   
+0001c0c0: 2020 2020 2072 6573 6f75 7263 655f 6163       resource_ac
+0001c0d0: 6365 6c65 7261 746f 7273 203d 205b 5d0a  celerators = [].
+0001c0e0: 2020 2020 2020 2020 6d69 6e5f 6370 7573          min_cpus
+0001c0f0: 203d 2066 6c6f 6174 2827 696e 6627 290a   = float('inf').
+0001c100: 2020 2020 2020 2020 7370 6f74 5f74 7970          spot_typ
+0001c110: 653a 2053 6574 5b73 7472 5d20 3d20 7365  e: Set[str] = se
+0001c120: 7428 290a 2020 2020 2020 2020 666f 7220  t().        for 
+0001c130: 7265 736f 7572 6365 2069 6e20 7461 736b  resource in task
+0001c140: 2e72 6573 6f75 7263 6573 3a0a 2020 2020  .resources:.    
+0001c150: 2020 2020 2020 2020 7461 736b 5f63 7075          task_cpu
+0001c160: 5f64 656d 616e 6420 3d20 2731 2b27 0a20  _demand = '1+'. 
+0001c170: 2020 2020 2020 2020 2020 2069 6620 7265             if re
+0001c180: 736f 7572 6365 2e63 7075 7320 6973 206e  source.cpus is n
+0001c190: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+0001c1a0: 2020 2020 2020 2020 2074 6173 6b5f 6370           task_cp
+0001c1b0: 755f 6465 6d61 6e64 203d 2072 6573 6f75  u_demand = resou
+0001c1c0: 7263 652e 6370 7573 0a20 2020 2020 2020  rce.cpus.       
+0001c1d0: 2020 2020 206d 696e 5f63 7075 7320 3d20       min_cpus = 
+0001c1e0: 6d69 6e28 6d69 6e5f 6370 7573 2c20 666c  min(min_cpus, fl
+0001c1f0: 6f61 7428 7461 736b 5f63 7075 5f64 656d  oat(task_cpu_dem
+0001c200: 616e 642e 7374 7269 7028 272b 2027 2929  and.strip('+ '))
+0001c210: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+0001c220: 2072 6573 6f75 7263 652e 7573 655f 7370   resource.use_sp
+0001c230: 6f74 3a0a 2020 2020 2020 2020 2020 2020  ot:.            
+0001c240: 2020 2020 7370 6f74 5f74 7970 652e 6164      spot_type.ad
+0001c250: 6428 2753 706f 7427 290a 2020 2020 2020  d('Spot').      
+0001c260: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0001c270: 2020 2020 2020 2020 2020 2020 7370 6f74              spot
+0001c280: 5f74 7970 652e 6164 6428 274f 6e2d 6465  _type.add('On-de
+0001c290: 6d61 6e64 2729 0a0a 2020 2020 2020 2020  mand')..        
+0001c2a0: 2020 2020 6966 2072 6573 6f75 7263 652e      if resource.
+0001c2b0: 6163 6365 6c65 7261 746f 7273 2069 7320  accelerators is 
+0001c2c0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+0001c2d0: 2020 2020 2020 636f 6e74 696e 7565 0a20        continue. 
+0001c2e0: 2020 2020 2020 2020 2020 2066 6f72 206b             for k
+0001c2f0: 2c20 7620 696e 2072 6573 6f75 7263 652e  , v in resource.
+0001c300: 6163 6365 6c65 7261 746f 7273 2e69 7465  accelerators.ite
+0001c310: 6d73 2829 3a0a 2020 2020 2020 2020 2020  ms():.          
+0001c320: 2020 2020 2020 7265 736f 7572 6365 5f61        resource_a
+0001c330: 6363 656c 6572 6174 6f72 732e 6170 7065  ccelerators.appe
+0001c340: 6e64 2866 277b 6b7d 3a7b 767d 2729 0a0a  nd(f'{k}:{v}')..
+0001c350: 2020 2020 2020 2020 6966 2069 735f 6d61          if is_ma
+0001c360: 6e61 6765 645f 6a6f 623a 0a20 2020 2020  naged_job:.     
+0001c370: 2020 2020 2020 2069 6620 6c65 6e28 7461         if len(ta
+0001c380: 736b 2e72 6573 6f75 7263 6573 2920 3e20  sk.resources) > 
+0001c390: 313a 0a20 2020 2020 2020 2020 2020 2020  1:.             
+0001c3a0: 2020 2074 6173 6b5f 6370 755f 6465 6d61     task_cpu_dema
+0001c3b0: 6e64 203d 2066 277b 6d69 6e5f 6370 7573  nd = f'{min_cpus
+0001c3c0: 7d2b 270a 2020 2020 2020 2020 2020 2020  }+'.            
+0001c3d0: 6966 2027 5370 6f74 2720 696e 2073 706f  if 'Spot' in spo
+0001c3e0: 745f 7479 7065 3a0a 2020 2020 2020 2020  t_type:.        
+0001c3f0: 2020 2020 2020 2020 7370 6f74 5f73 7472          spot_str
+0001c400: 203d 2027 7c27 2e6a 6f69 6e28 736f 7274   = '|'.join(sort
+0001c410: 6564 2873 706f 745f 7479 7065 2929 0a20  ed(spot_type)). 
+0001c420: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0001c430: 706f 745f 7374 7220 3d20 6627 5b7b 7370  pot_str = f'[{sp
+0001c440: 6f74 5f73 7472 7d5d 270a 2020 2020 2020  ot_str}]'.      
+0001c450: 2020 6966 2072 6573 6f75 7263 655f 6163    if resource_ac
+0001c460: 6365 6c65 7261 746f 7273 3a0a 2020 2020  celerators:.    
+0001c470: 2020 2020 2020 2020 7265 736f 7572 6365          resource
+0001c480: 735f 7374 7220 3d20 272c 2027 2e6a 6f69  s_str = ', '.joi
+0001c490: 6e28 7365 7428 7265 736f 7572 6365 5f61  n(set(resource_a
+0001c4a0: 6363 656c 6572 6174 6f72 7329 290a 2020  ccelerators)).  
+0001c4b0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0001c4c0: 2020 2020 2020 2020 7265 736f 7572 6365          resource
+0001c4d0: 735f 7374 7220 3d20 6627 4350 553a 7b74  s_str = f'CPU:{t
+0001c4e0: 6173 6b5f 6370 755f 6465 6d61 6e64 7d27  ask_cpu_demand}'
+0001c4f0: 0a20 2020 2072 6573 6f75 7263 6573 5f73  .    resources_s
+0001c500: 7472 203d 2066 277b 7461 736b 2e6e 756d  tr = f'{task.num
+0001c510: 5f6e 6f64 6573 7d78 5b7b 7265 736f 7572  _nodes}x[{resour
+0001c520: 6365 735f 7374 727d 5d7b 7370 6f74 5f73  ces_str}]{spot_s
+0001c530: 7472 7d27 0a20 2020 2072 6574 7572 6e20  tr}'.    return 
+0001c540: 7265 736f 7572 6365 735f 7374 720a 0a0a  resources_str...
+0001c550: 2320 4861 6e64 6c65 2063 7472 6c2d 630a  # Handle ctrl-c.
+0001c560: 6465 6620 696e 7465 7272 7570 745f 6861  def interrupt_ha
+0001c570: 6e64 6c65 7228 7369 676e 756d 2c20 6672  ndler(signum, fr
+0001c580: 616d 6529 3a0a 2020 2020 6465 6c20 7369  ame):.    del si
+0001c590: 676e 756d 2c20 6672 616d 650a 2020 2020  gnum, frame.    
+0001c5a0: 7375 6270 726f 6365 7373 5f75 7469 6c73  subprocess_utils
+0001c5b0: 2e6b 696c 6c5f 6368 696c 6472 656e 5f70  .kill_children_p
+0001c5c0: 726f 6365 7373 6573 2829 0a20 2020 2023  rocesses().    #
+0001c5d0: 2041 766f 6964 2075 7369 6e67 206c 6f67   Avoid using log
+0001c5e0: 6765 7220 6865 7265 2c20 6173 2069 7420  ger here, as it 
+0001c5f0: 7769 6c6c 2070 7269 6e74 2074 6865 2073  will print the s
+0001c600: 7461 636b 2074 7261 6365 2066 6f72 2062  tack trace for b
+0001c610: 726f 6b65 6e0a 2020 2020 2320 7069 7065  roken.    # pipe
+0001c620: 2c20 7768 656e 2074 6865 206f 7574 7075  , when the outpu
+0001c630: 7420 6973 2070 6970 6564 2074 6f20 616e  t is piped to an
+0001c640: 6f74 6865 7220 7072 6f67 7261 6d2e 0a20  other program.. 
+0001c650: 2020 2070 7269 6e74 2866 277b 636f 6c6f     print(f'{colo
+0001c660: 7261 6d61 2e53 7479 6c65 2e44 494d 7d54  rama.Style.DIM}T
+0001c670: 6970 3a20 5468 6520 6a6f 6220 7769 6c6c  ip: The job will
+0001c680: 206b 6565 7020 270a 2020 2020 2020 2020   keep '.        
+0001c690: 2020 6627 7275 6e6e 696e 6720 6166 7465    f'running afte
+0001c6a0: 7220 4374 726c 2d43 2e7b 636f 6c6f 7261  r Ctrl-C.{colora
+0001c6b0: 6d61 2e53 7479 6c65 2e52 4553 4554 5f41  ma.Style.RESET_A
+0001c6c0: 4c4c 7d27 290a 2020 2020 7769 7468 2075  LL}').    with u
+0001c6d0: 785f 7574 696c 732e 7072 696e 745f 6578  x_utils.print_ex
+0001c6e0: 6365 7074 696f 6e5f 6e6f 5f74 7261 6365  ception_no_trace
+0001c6f0: 6261 636b 2829 3a0a 2020 2020 2020 2020  back():.        
+0001c700: 7261 6973 6520 4b65 7962 6f61 7264 496e  raise KeyboardIn
+0001c710: 7465 7272 7570 7428 6578 6365 7074 696f  terrupt(exceptio
+0001c720: 6e73 2e4b 4559 424f 4152 445f 494e 5445  ns.KEYBOARD_INTE
+0001c730: 5252 5550 545f 434f 4445 290a 0a0a 2320  RRUPT_CODE)...# 
+0001c740: 4861 6e64 6c65 2063 7472 6c2d 7a0a 6465  Handle ctrl-z.de
+0001c750: 6620 7374 6f70 5f68 616e 646c 6572 2873  f stop_handler(s
+0001c760: 6967 6e75 6d2c 2066 7261 6d65 293a 0a20  ignum, frame):. 
+0001c770: 2020 2064 656c 2073 6967 6e75 6d2c 2066     del signum, f
+0001c780: 7261 6d65 0a20 2020 2073 7562 7072 6f63  rame.    subproc
+0001c790: 6573 735f 7574 696c 732e 6b69 6c6c 5f63  ess_utils.kill_c
+0001c7a0: 6869 6c64 7265 6e5f 7072 6f63 6573 7365  hildren_processe
+0001c7b0: 7328 290a 2020 2020 2320 4176 6f69 6420  s().    # Avoid 
+0001c7c0: 7573 696e 6720 6c6f 6767 6572 2068 6572  using logger her
+0001c7d0: 652c 2061 7320 6974 2077 696c 6c20 7072  e, as it will pr
+0001c7e0: 696e 7420 7468 6520 7374 6163 6b20 7472  int the stack tr
+0001c7f0: 6163 6520 666f 7220 6272 6f6b 656e 0a20  ace for broken. 
+0001c800: 2020 2023 2070 6970 652c 2077 6865 6e20     # pipe, when 
+0001c810: 7468 6520 6f75 7470 7574 2069 7320 7069  the output is pi
+0001c820: 7065 6420 746f 2061 6e6f 7468 6572 2070  ped to another p
+0001c830: 726f 6772 616d 2e0a 2020 2020 7072 696e  rogram..    prin
+0001c840: 7428 6627 7b63 6f6c 6f72 616d 612e 5374  t(f'{colorama.St
+0001c850: 796c 652e 4449 4d7d 5469 703a 2054 6865  yle.DIM}Tip: The
+0001c860: 206a 6f62 2077 696c 6c20 6b65 6570 2027   job will keep '
+0001c870: 0a20 2020 2020 2020 2020 2066 2772 756e  .          f'run
+0001c880: 6e69 6e67 2061 6674 6572 2043 7472 6c2d  ning after Ctrl-
+0001c890: 5a2e 7b63 6f6c 6f72 616d 612e 5374 796c  Z.{colorama.Styl
+0001c8a0: 652e 5245 5345 545f 414c 4c7d 2729 0a20  e.RESET_ALL}'). 
+0001c8b0: 2020 2077 6974 6820 7578 5f75 7469 6c73     with ux_utils
+0001c8c0: 2e70 7269 6e74 5f65 7863 6570 7469 6f6e  .print_exception
+0001c8d0: 5f6e 6f5f 7472 6163 6562 6163 6b28 293a  _no_traceback():
+0001c8e0: 0a20 2020 2020 2020 2072 6169 7365 204b  .        raise K
+0001c8f0: 6579 626f 6172 6449 6e74 6572 7275 7074  eyboardInterrupt
+0001c900: 2865 7863 6570 7469 6f6e 732e 5349 4754  (exceptions.SIGT
+0001c910: 5354 505f 434f 4445 290a 0a0a 6465 6620  STP_CODE)...def 
+0001c920: 7275 6e5f 636f 6d6d 616e 645f 616e 645f  run_command_and_
+0001c930: 6861 6e64 6c65 5f73 7368 5f66 6169 6c75  handle_ssh_failu
+0001c940: 7265 2872 756e 6e65 723a 2063 6f6d 6d61  re(runner: comma
+0001c950: 6e64 5f72 756e 6e65 722e 5353 4843 6f6d  nd_runner.SSHCom
+0001c960: 6d61 6e64 5275 6e6e 6572 2c0a 2020 2020  mandRunner,.    
+0001c970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c990: 2020 2063 6f6d 6d61 6e64 3a20 7374 722c     command: str,
+0001c9a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001c9b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c9c0: 2020 2020 2020 2020 6661 696c 7572 655f          failure_
+0001c9d0: 6d65 7373 6167 653a 2073 7472 2920 2d3e  message: str) ->
+0001c9e0: 2073 7472 3a0a 2020 2020 2222 2252 756e   str:.    """Run
+0001c9f0: 7320 636f 6d6d 616e 6420 7265 6d6f 7465  s command remote
+0001ca00: 6c79 2061 6e64 2072 6574 7572 6e73 206f  ly and returns o
+0001ca10: 7574 7075 7420 7769 7468 2070 726f 7065  utput with prope
+0001ca20: 7220 6572 726f 7220 6861 6e64 6c69 6e67  r error handling
+0001ca30: 2e22 2222 0a20 2020 2072 632c 2073 7464  .""".    rc, std
+0001ca40: 6f75 742c 2073 7464 6572 7220 3d20 7275  out, stderr = ru
+0001ca50: 6e6e 6572 2e72 756e 2863 6f6d 6d61 6e64  nner.run(command
+0001ca60: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
 0001ca70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ca80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ca90: 2020 2020 7374 6465 7272 3d73 7464 6572      stderr=stder
-0001caa0: 7229 0a20 2020 2072 6574 7572 6e20 7374  r).    return st
-0001cab0: 646f 7574 0a0a 0a64 6566 2063 6865 636b  dout...def check
-0001cac0: 5f72 7379 6e63 5f69 6e73 7461 6c6c 6564  _rsync_installed
-0001cad0: 2829 202d 3e20 4e6f 6e65 3a0a 2020 2020  () -> None:.    
-0001cae0: 2222 2243 6865 636b 7320 6966 2072 7379  """Checks if rsy
-0001caf0: 6e63 2069 7320 696e 7374 616c 6c65 642e  nc is installed.
-0001cb00: 0a0a 2020 2020 5261 6973 6573 3a0a 2020  ..    Raises:.  
-0001cb10: 2020 2020 2020 5275 6e74 696d 6545 7272        RuntimeErr
-0001cb20: 6f72 3a20 6966 2072 7379 6e63 2069 7320  or: if rsync is 
-0001cb30: 6e6f 7420 696e 7374 616c 6c65 6420 696e  not installed in
-0001cb40: 2074 6865 206d 6163 6869 6e65 2e0a 2020   the machine..  
-0001cb50: 2020 2222 220a 2020 2020 7472 793a 0a20    """.    try:. 
-0001cb60: 2020 2020 2020 2073 7562 7072 6f63 6573         subproces
-0001cb70: 732e 7275 6e28 2772 7379 6e63 202d 2d76  s.run('rsync --v
-0001cb80: 6572 7369 6f6e 272c 0a20 2020 2020 2020  ersion',.       
-0001cb90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cba0: 7368 656c 6c3d 5472 7565 2c0a 2020 2020  shell=True,.    
-0001cbb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cbc0: 2020 2063 6865 636b 3d54 7275 652c 0a20     check=True,. 
-0001cbd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cbe0: 2020 2020 2020 7374 646f 7574 3d73 7562        stdout=sub
-0001cbf0: 7072 6f63 6573 732e 5049 5045 2c0a 2020  process.PIPE,.  
-0001cc00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cc10: 2020 2020 2073 7464 6572 723d 7375 6270       stderr=subp
-0001cc20: 726f 6365 7373 2e50 4950 4529 0a20 2020  rocess.PIPE).   
-0001cc30: 2065 7863 6570 7420 7375 6270 726f 6365   except subproce
-0001cc40: 7373 2e43 616c 6c65 6450 726f 6365 7373  ss.CalledProcess
-0001cc50: 4572 726f 723a 0a20 2020 2020 2020 2077  Error:.        w
-0001cc60: 6974 6820 7578 5f75 7469 6c73 2e70 7269  ith ux_utils.pri
-0001cc70: 6e74 5f65 7863 6570 7469 6f6e 5f6e 6f5f  nt_exception_no_
-0001cc80: 7472 6163 6562 6163 6b28 293a 0a20 2020  traceback():.   
-0001cc90: 2020 2020 2020 2020 2072 6169 7365 2052           raise R
-0001cca0: 756e 7469 6d65 4572 726f 7228 0a20 2020  untimeError(.   
-0001ccb0: 2020 2020 2020 2020 2020 2020 2027 6072               '`r
-0001ccc0: 7379 6e63 6020 6973 2072 6571 7569 7265  sync` is require
-0001ccd0: 6420 666f 7220 7072 6f76 6973 696f 6e69  d for provisioni
-0001cce0: 6e67 2061 6e64 270a 2020 2020 2020 2020  ng and'.        
-0001ccf0: 2020 2020 2020 2020 2720 6974 2069 7320          ' it is 
-0001cd00: 6e6f 7420 696e 7374 616c 6c65 642e 2046  not installed. F
-0001cd10: 6f72 2044 6562 6961 6e2f 5562 756e 7475  or Debian/Ubuntu
-0001cd20: 2073 7973 7465 6d2c 2027 0a20 2020 2020   system, '.     
-0001cd30: 2020 2020 2020 2020 2020 2027 696e 7374             'inst
-0001cd40: 616c 6c20 6974 2077 6974 683a 5c6e 270a  all it with:\n'.
-0001cd50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cd60: 2720 2024 2073 7564 6f20 6170 7420 696e  '  $ sudo apt in
-0001cd70: 7374 616c 6c20 7273 796e 6327 2920 6672  stall rsync') fr
-0001cd80: 6f6d 204e 6f6e 650a 0a0a 6465 6620 6368  om None...def ch
-0001cd90: 6563 6b5f 7374 616c 655f 7275 6e74 696d  eck_stale_runtim
-0001cda0: 655f 6f6e 5f72 656d 6f74 6528 7265 7475  e_on_remote(retu
-0001cdb0: 726e 636f 6465 3a20 696e 742c 2073 7464  rncode: int, std
-0001cdc0: 6572 723a 2073 7472 2c0a 2020 2020 2020  err: str,.      
-0001cdd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cde0: 2020 2020 2020 2020 2020 2020 636c 7573              clus
-0001cdf0: 7465 725f 6e61 6d65 3a20 7374 7229 202d  ter_name: str) -
-0001ce00: 3e20 4e6f 6e65 3a0a 2020 2020 2222 2252  > None:.    """R
-0001ce10: 6169 7365 7320 5275 6e74 696d 6545 7272  aises RuntimeErr
-0001ce20: 6f72 2069 6620 7265 6d6f 7465 2053 6b79  or if remote Sky
-0001ce30: 5069 6c6f 7420 7275 6e74 696d 6520 6e65  Pilot runtime ne
-0001ce40: 6564 7320 746f 2062 6520 7570 6461 7465  eds to be update
-0001ce50: 642e 0a0a 2020 2020 5765 2064 6574 6563  d...    We detec
-0001ce60: 7420 7468 6973 2062 7920 7061 7273 696e  t this by parsin
-0001ce70: 6720 6365 7274 6169 6e20 6261 636b 7761  g certain backwa
-0001ce80: 7264 2d69 6e63 6f6d 7061 7469 626c 6520  rd-incompatible 
-0001ce90: 6572 726f 7220 6d65 7373 6167 6573 2066  error messages f
-0001cea0: 726f 6d0a 2020 2020 6073 7464 6572 7260  rom.    `stderr`
-0001ceb0: 2e20 5479 7069 6361 6c6c 7920 6475 6520  . Typically due 
-0001cec0: 746f 2074 6865 206c 6f63 616c 2063 6c69  to the local cli
-0001ced0: 656e 7420 7665 7273 696f 6e20 6a75 7374  ent version just
-0001cee0: 2067 6f74 2075 7064 6174 6564 2c20 616e   got updated, an
-0001cef0: 640a 2020 2020 7468 6520 7265 6d6f 7465  d.    the remote
-0001cf00: 2072 756e 7469 6d65 2069 7320 616e 206f   runtime is an o
-0001cf10: 6c64 6572 2076 6572 7369 6f6e 2e0a 2020  lder version..  
-0001cf20: 2020 2222 220a 2020 2020 7061 7474 6572    """.    patter
-0001cf30: 6e20 3d20 7265 2e63 6f6d 7069 6c65 2872  n = re.compile(r
-0001cf40: 2741 7474 7269 6275 7465 4572 726f 723a  'AttributeError:
-0001cf50: 206d 6f64 756c 6520 5c27 736b 795c 2e28   module \'sky\.(
-0001cf60: 2e2a 295c 2720 6861 7320 6e6f 2027 0a20  .*)\' has no '. 
-0001cf70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cf80: 2020 2020 2020 2020 7227 6174 7472 6962          r'attrib
-0001cf90: 7574 6520 5c27 282e 2a29 5c27 2729 0a20  ute \'(.*)\''). 
-0001cfa0: 2020 2069 6620 7265 7475 726e 636f 6465     if returncode
-0001cfb0: 2021 3d20 303a 0a20 2020 2020 2020 2061   != 0:.        a
-0001cfc0: 7474 7269 6275 7465 5f65 7272 6f72 203d  ttribute_error =
-0001cfd0: 2072 652e 6669 6e64 616c 6c28 7061 7474   re.findall(patt
-0001cfe0: 6572 6e2c 2073 7464 6572 7229 0a20 2020  ern, stderr).   
-0001cff0: 2020 2020 2069 6620 6174 7472 6962 7574       if attribut
-0001d000: 655f 6572 726f 723a 0a20 2020 2020 2020  e_error:.       
-0001d010: 2020 2020 2077 6974 6820 7578 5f75 7469       with ux_uti
-0001d020: 6c73 2e70 7269 6e74 5f65 7863 6570 7469  ls.print_excepti
-0001d030: 6f6e 5f6e 6f5f 7472 6163 6562 6163 6b28  on_no_traceback(
-0001d040: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0001d050: 2020 2072 6169 7365 2052 756e 7469 6d65     raise Runtime
-0001d060: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
-0001d070: 2020 2020 2020 2020 2020 2066 277b 636f             f'{co
-0001d080: 6c6f 7261 6d61 2e46 6f72 652e 5245 447d  lorama.Fore.RED}
-0001d090: 536b 7950 696c 6f74 2072 756e 7469 6d65  SkyPilot runtime
-0001d0a0: 206e 6565 6473 2074 6f20 6265 2075 7064   needs to be upd
-0001d0b0: 6174 6564 2027 0a20 2020 2020 2020 2020  ated '.         
-0001d0c0: 2020 2020 2020 2020 2020 2027 6f6e 2074             'on t
-0001d0d0: 6865 2072 656d 6f74 6520 636c 7573 7465  he remote cluste
-0001d0e0: 722e 2054 6f20 7570 6461 7465 2c20 7275  r. To update, ru
-0001d0f0: 6e20 2865 7869 7374 696e 6720 6a6f 6273  n (existing jobs
-0001d100: 2061 7265 2027 0a20 2020 2020 2020 2020   are '.         
-0001d110: 2020 2020 2020 2020 2020 2066 276e 6f74             f'not
-0001d120: 2069 6e74 6572 7275 7074 6564 293a 207b   interrupted): {
-0001d130: 636f 6c6f 7261 6d61 2e53 7479 6c65 2e42  colorama.Style.B
-0001d140: 5249 4748 547d 736b 7920 7374 6172 7420  RIGHT}sky start 
-0001d150: 2d66 202d 7920 270a 2020 2020 2020 2020  -f -y '.        
-0001d160: 2020 2020 2020 2020 2020 2020 6627 7b63              f'{c
-0001d170: 6c75 7374 6572 5f6e 616d 657d 7b63 6f6c  luster_name}{col
-0001d180: 6f72 616d 612e 5374 796c 652e 5245 5345  orama.Style.RESE
-0001d190: 545f 414c 4c7d 270a 2020 2020 2020 2020  T_ALL}'.        
-0001d1a0: 2020 2020 2020 2020 2020 2020 6627 5c6e              f'\n
-0001d1b0: 2d2d 2d20 4465 7461 696c 7320 2d2d 2d5c  --- Details ---\
-0001d1c0: 6e7b 7374 6465 7272 2e73 7472 6970 2829  n{stderr.strip()
-0001d1d0: 7d5c 6e27 290a                           }\n').
+0001ca80: 2020 2020 2020 7265 7175 6972 655f 6f75        require_ou
+0001ca90: 7470 7574 733d 5472 7565 2c0a 2020 2020  tputs=True,.    
+0001caa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cac0: 7374 7265 616d 5f6c 6f67 733d 4661 6c73  stream_logs=Fals
+0001cad0: 6529 0a20 2020 2069 6620 7263 203d 3d20  e).    if rc == 
+0001cae0: 3235 353a 0a20 2020 2020 2020 2023 2053  255:.        # S
+0001caf0: 5348 2066 6169 6c65 640a 2020 2020 2020  SH failed.      
+0001cb00: 2020 7261 6973 6520 5275 6e74 696d 6545    raise RuntimeE
+0001cb10: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
+0001cb20: 2020 6627 5353 4820 7769 7468 2075 7365    f'SSH with use
+0001cb30: 7220 7b72 756e 6e65 722e 7373 685f 7573  r {runner.ssh_us
+0001cb40: 6572 7d20 616e 6420 6b65 7920 7b72 756e  er} and key {run
+0001cb50: 6e65 722e 7373 685f 7072 6976 6174 655f  ner.ssh_private_
+0001cb60: 6b65 797d 2027 0a20 2020 2020 2020 2020  key} '.         
+0001cb70: 2020 2066 2774 6f20 7b72 756e 6e65 722e     f'to {runner.
+0001cb80: 6970 7d20 6661 696c 6564 2e20 5468 6973  ip} failed. This
+0001cb90: 2069 7320 6d6f 7374 206c 696b 656c 7920   is most likely 
+0001cba0: 6475 6520 746f 2069 6e63 6f72 7265 6374  due to incorrect
+0001cbb0: 2027 0a20 2020 2020 2020 2020 2020 2027   '.            '
+0001cbc0: 6372 6564 656e 7469 616c 7320 6f72 2069  credentials or i
+0001cbd0: 6e63 6f72 7265 6374 2070 6572 6d69 7373  ncorrect permiss
+0001cbe0: 696f 6e73 2066 6f72 2074 6865 206b 6579  ions for the key
+0001cbf0: 2066 696c 652e 2043 6865 636b 2027 0a20   file. Check '. 
+0001cc00: 2020 2020 2020 2020 2020 2027 796f 7572             'your
+0001cc10: 2063 7265 6465 6e74 6961 6c73 2061 6e64   credentials and
+0001cc20: 2074 7279 2061 6761 696e 2e27 290a 2020   try again.').  
+0001cc30: 2020 7375 6270 726f 6365 7373 5f75 7469    subprocess_uti
+0001cc40: 6c73 2e68 616e 646c 655f 7265 7475 726e  ls.handle_return
+0001cc50: 636f 6465 2872 632c 0a20 2020 2020 2020  code(rc,.       
+0001cc60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cc70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cc80: 636f 6d6d 616e 642c 0a20 2020 2020 2020  command,.       
+0001cc90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ccb0: 6661 696c 7572 655f 6d65 7373 6167 652c  failure_message,
+0001ccc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001ccd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cce0: 2020 2020 2020 2020 7374 6465 7272 3d73          stderr=s
+0001ccf0: 7464 6572 7229 0a20 2020 2072 6574 7572  tderr).    retur
+0001cd00: 6e20 7374 646f 7574 0a0a 0a64 6566 2063  n stdout...def c
+0001cd10: 6865 636b 5f72 7379 6e63 5f69 6e73 7461  heck_rsync_insta
+0001cd20: 6c6c 6564 2829 202d 3e20 4e6f 6e65 3a0a  lled() -> None:.
+0001cd30: 2020 2020 2222 2243 6865 636b 7320 6966      """Checks if
+0001cd40: 2072 7379 6e63 2069 7320 696e 7374 616c   rsync is instal
+0001cd50: 6c65 642e 0a0a 2020 2020 5261 6973 6573  led...    Raises
+0001cd60: 3a0a 2020 2020 2020 2020 5275 6e74 696d  :.        Runtim
+0001cd70: 6545 7272 6f72 3a20 6966 2072 7379 6e63  eError: if rsync
+0001cd80: 2069 7320 6e6f 7420 696e 7374 616c 6c65   is not installe
+0001cd90: 6420 696e 2074 6865 206d 6163 6869 6e65  d in the machine
+0001cda0: 2e0a 2020 2020 2222 220a 2020 2020 7472  ..    """.    tr
+0001cdb0: 793a 0a20 2020 2020 2020 2073 7562 7072  y:.        subpr
+0001cdc0: 6f63 6573 732e 7275 6e28 2772 7379 6e63  ocess.run('rsync
+0001cdd0: 202d 2d76 6572 7369 6f6e 272c 0a20 2020   --version',.   
+0001cde0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cdf0: 2020 2020 7368 656c 6c3d 5472 7565 2c0a      shell=True,.
+0001ce00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ce10: 2020 2020 2020 2063 6865 636b 3d54 7275         check=Tru
+0001ce20: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+0001ce30: 2020 2020 2020 2020 2020 7374 646f 7574            stdout
+0001ce40: 3d73 7562 7072 6f63 6573 732e 5049 5045  =subprocess.PIPE
+0001ce50: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001ce60: 2020 2020 2020 2020 2073 7464 6572 723d           stderr=
+0001ce70: 7375 6270 726f 6365 7373 2e50 4950 4529  subprocess.PIPE)
+0001ce80: 0a20 2020 2065 7863 6570 7420 7375 6270  .    except subp
+0001ce90: 726f 6365 7373 2e43 616c 6c65 6450 726f  rocess.CalledPro
+0001cea0: 6365 7373 4572 726f 723a 0a20 2020 2020  cessError:.     
+0001ceb0: 2020 2077 6974 6820 7578 5f75 7469 6c73     with ux_utils
+0001cec0: 2e70 7269 6e74 5f65 7863 6570 7469 6f6e  .print_exception
+0001ced0: 5f6e 6f5f 7472 6163 6562 6163 6b28 293a  _no_traceback():
+0001cee0: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+0001cef0: 7365 2052 756e 7469 6d65 4572 726f 7228  se RuntimeError(
+0001cf00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001cf10: 2027 6072 7379 6e63 6020 6973 2072 6571   '`rsync` is req
+0001cf20: 7569 7265 6420 666f 7220 7072 6f76 6973  uired for provis
+0001cf30: 696f 6e69 6e67 2061 6e64 270a 2020 2020  ioning and'.    
+0001cf40: 2020 2020 2020 2020 2020 2020 2720 6974              ' it
+0001cf50: 2069 7320 6e6f 7420 696e 7374 616c 6c65   is not installe
+0001cf60: 642e 2046 6f72 2044 6562 6961 6e2f 5562  d. For Debian/Ub
+0001cf70: 756e 7475 2073 7973 7465 6d2c 2027 0a20  untu system, '. 
+0001cf80: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+0001cf90: 696e 7374 616c 6c20 6974 2077 6974 683a  install it with:
+0001cfa0: 5c6e 270a 2020 2020 2020 2020 2020 2020  \n'.            
+0001cfb0: 2020 2020 2720 2024 2073 7564 6f20 6170      '  $ sudo ap
+0001cfc0: 7420 696e 7374 616c 6c20 7273 796e 6327  t install rsync'
+0001cfd0: 2920 6672 6f6d 204e 6f6e 650a 0a0a 6465  ) from None...de
+0001cfe0: 6620 6368 6563 6b5f 7374 616c 655f 7275  f check_stale_ru
+0001cff0: 6e74 696d 655f 6f6e 5f72 656d 6f74 6528  ntime_on_remote(
+0001d000: 7265 7475 726e 636f 6465 3a20 696e 742c  returncode: int,
+0001d010: 2073 7464 6572 723a 2073 7472 2c0a 2020   stderr: str,.  
+0001d020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d040: 636c 7573 7465 725f 6e61 6d65 3a20 7374  cluster_name: st
+0001d050: 7229 202d 3e20 4e6f 6e65 3a0a 2020 2020  r) -> None:.    
+0001d060: 2222 2252 6169 7365 7320 5275 6e74 696d  """Raises Runtim
+0001d070: 6545 7272 6f72 2069 6620 7265 6d6f 7465  eError if remote
+0001d080: 2053 6b79 5069 6c6f 7420 7275 6e74 696d   SkyPilot runtim
+0001d090: 6520 6e65 6564 7320 746f 2062 6520 7570  e needs to be up
+0001d0a0: 6461 7465 642e 0a0a 2020 2020 5765 2064  dated...    We d
+0001d0b0: 6574 6563 7420 7468 6973 2062 7920 7061  etect this by pa
+0001d0c0: 7273 696e 6720 6365 7274 6169 6e20 6261  rsing certain ba
+0001d0d0: 636b 7761 7264 2d69 6e63 6f6d 7061 7469  ckward-incompati
+0001d0e0: 626c 6520 6572 726f 7220 6d65 7373 6167  ble error messag
+0001d0f0: 6573 2066 726f 6d0a 2020 2020 6073 7464  es from.    `std
+0001d100: 6572 7260 2e20 5479 7069 6361 6c6c 7920  err`. Typically 
+0001d110: 6475 6520 746f 2074 6865 206c 6f63 616c  due to the local
+0001d120: 2063 6c69 656e 7420 7665 7273 696f 6e20   client version 
+0001d130: 6a75 7374 2067 6f74 2075 7064 6174 6564  just got updated
+0001d140: 2c20 616e 640a 2020 2020 7468 6520 7265  , and.    the re
+0001d150: 6d6f 7465 2072 756e 7469 6d65 2069 7320  mote runtime is 
+0001d160: 616e 206f 6c64 6572 2076 6572 7369 6f6e  an older version
+0001d170: 2e0a 2020 2020 2222 220a 2020 2020 7061  ..    """.    pa
+0001d180: 7474 6572 6e20 3d20 7265 2e63 6f6d 7069  ttern = re.compi
+0001d190: 6c65 2872 2741 7474 7269 6275 7465 4572  le(r'AttributeEr
+0001d1a0: 726f 723a 206d 6f64 756c 6520 5c27 736b  ror: module \'sk
+0001d1b0: 795c 2e28 2e2a 295c 2720 6861 7320 6e6f  y\.(.*)\' has no
+0001d1c0: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+0001d1d0: 2020 2020 2020 2020 2020 2020 7227 6174              r'at
+0001d1e0: 7472 6962 7574 6520 5c27 282e 2a29 5c27  tribute \'(.*)\'
+0001d1f0: 2729 0a20 2020 2069 6620 7265 7475 726e  ').    if return
+0001d200: 636f 6465 2021 3d20 303a 0a20 2020 2020  code != 0:.     
+0001d210: 2020 2061 7474 7269 6275 7465 5f65 7272     attribute_err
+0001d220: 6f72 203d 2072 652e 6669 6e64 616c 6c28  or = re.findall(
+0001d230: 7061 7474 6572 6e2c 2073 7464 6572 7229  pattern, stderr)
+0001d240: 0a20 2020 2020 2020 2069 6620 6174 7472  .        if attr
+0001d250: 6962 7574 655f 6572 726f 723a 0a20 2020  ibute_error:.   
+0001d260: 2020 2020 2020 2020 2077 6974 6820 7578           with ux
+0001d270: 5f75 7469 6c73 2e70 7269 6e74 5f65 7863  _utils.print_exc
+0001d280: 6570 7469 6f6e 5f6e 6f5f 7472 6163 6562  eption_no_traceb
+0001d290: 6163 6b28 293a 0a20 2020 2020 2020 2020  ack():.         
+0001d2a0: 2020 2020 2020 2072 6169 7365 2052 756e         raise Run
+0001d2b0: 7469 6d65 4572 726f 7228 0a20 2020 2020  timeError(.     
+0001d2c0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0001d2d0: 277b 636f 6c6f 7261 6d61 2e46 6f72 652e  '{colorama.Fore.
+0001d2e0: 5245 447d 536b 7950 696c 6f74 2072 756e  RED}SkyPilot run
+0001d2f0: 7469 6d65 206e 6565 6473 2074 6f20 6265  time needs to be
+0001d300: 2075 7064 6174 6564 2027 0a20 2020 2020   updated '.     
+0001d310: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+0001d320: 6f6e 2074 6865 2072 656d 6f74 6520 636c  on the remote cl
+0001d330: 7573 7465 722e 2054 6f20 7570 6461 7465  uster. To update
+0001d340: 2c20 7275 6e20 2865 7869 7374 696e 6720  , run (existing 
+0001d350: 6a6f 6273 2061 7265 2027 0a20 2020 2020  jobs are '.     
+0001d360: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0001d370: 276e 6f74 2069 6e74 6572 7275 7074 6564  'not interrupted
+0001d380: 293a 207b 636f 6c6f 7261 6d61 2e53 7479  ): {colorama.Sty
+0001d390: 6c65 2e42 5249 4748 547d 736b 7920 7374  le.BRIGHT}sky st
+0001d3a0: 6172 7420 2d66 202d 7920 270a 2020 2020  art -f -y '.    
+0001d3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d3c0: 6627 7b63 6c75 7374 6572 5f6e 616d 657d  f'{cluster_name}
+0001d3d0: 7b63 6f6c 6f72 616d 612e 5374 796c 652e  {colorama.Style.
+0001d3e0: 5245 5345 545f 414c 4c7d 270a 2020 2020  RESET_ALL}'.    
+0001d3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d400: 6627 5c6e 2d2d 2d20 4465 7461 696c 7320  f'\n--- Details 
+0001d410: 2d2d 2d5c 6e7b 7374 6465 7272 2e73 7472  ---\n{stderr.str
+0001d420: 6970 2829 7d5c 6e27 290a                 ip()}\n').
```

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/backends/cloud_vm_ray_backend.py` & `skypilot_nightly-1.0.0.dev20240505/sky/backends/cloud_vm_ray_backend.py`

 * *Files 1% similar despite different names*

```diff
@@ -24,20 +24,20 @@
 
 import sky
 from sky import backends
 from sky import cloud_stores
 from sky import clouds
 from sky import exceptions
 from sky import global_user_state
+from sky import jobs as managed_jobs
 from sky import optimizer
 from sky import provision as provision_lib
 from sky import resources as resources_lib
 from sky import serve as serve_lib
 from sky import sky_logging
-from sky import spot as spot_lib
 from sky import status_lib
 from sky import task as task_lib
 from sky.backends import backend_utils
 from sky.backends import wheel_utils
 from sky.clouds import service_catalog
 from sky.clouds.utils import gcp_utils
 from sky.data import data_utils
@@ -3111,15 +3111,15 @@
 
     def _exec_code_on_head(
         self,
         handle: CloudVmRayResourceHandle,
         codegen: str,
         job_id: int,
         detach_run: bool = False,
-        spot_dag: Optional['dag.Dag'] = None,
+        managed_job_dag: Optional['dag.Dag'] = None,
     ) -> None:
         """Executes generated code on the head node."""
         style = colorama.Style
         fore = colorama.Fore
 
         script_path = os.path.join(SKY_REMOTE_APP_DIR, f'sky_job_{job_id}')
         remote_log_dir = self.log_dir
@@ -3141,30 +3141,32 @@
             # Redirect stderr to /dev/null to avoid distracting error from ray.
             f'"{constants.SKY_PYTHON_CMD} -u {script_path} > {remote_log_path} 2> /dev/null"'
         )
 
         code = job_lib.JobLibCodeGen.queue_job(job_id, job_submit_cmd)
         job_submit_cmd = ' && '.join([mkdir_code, create_script_code, code])
 
-        if spot_dag is not None:
-            # Add the spot job to spot queue table.
-            spot_codegen = spot_lib.SpotCodeGen()
-            spot_code = spot_codegen.set_pending(job_id, spot_dag)
-            # Set the spot job to PENDING state to make sure that this spot
-            # job appears in the `sky spot queue`, when there are already 16
-            # controller process jobs running on the controller VM with 8
-            # CPU cores.
-            # The spot job should be set to PENDING state *after* the
+        if managed_job_dag is not None:
+            # Add the managed job to job queue database.
+            managed_job_codegen = managed_jobs.ManagedJobCodeGen()
+            managed_job_code = managed_job_codegen.set_pending(
+                job_id, managed_job_dag)
+            # Set the managed job to PENDING state to make sure that this
+            # managed job appears in the `sky jobs queue`, when there are
+            # already 2x vCPU controller processes running on the controller VM,
+            # e.g., 16 controller processes running on a controller with 8
+            # vCPUs.
+            # The managed job should be set to PENDING state *after* the
             # controller process job has been queued, as our skylet on spot
-            # controller will set the spot job in FAILED state if the
+            # controller will set the managed job in FAILED state if the
             # controller process job does not exist.
-            # We cannot set the spot job to PENDING state in the codegen for
+            # We cannot set the managed job to PENDING state in the codegen for
             # the controller process job, as it will stay in the job pending
             # table and not be executed until there is an empty slot.
-            job_submit_cmd = job_submit_cmd + ' && ' + spot_code
+            job_submit_cmd = job_submit_cmd + ' && ' + managed_job_code
 
         returncode, stdout, stderr = self.run_on_head(handle,
                                                       job_submit_cmd,
                                                       stream_logs=False,
                                                       require_outputs=True)
 
         # Happens when someone calls `sky exec` but remote is outdated
@@ -3177,41 +3179,42 @@
                                            stderr=stdout + stderr)
 
         logger.info('Job submitted with Job ID: '
                     f'{style.BRIGHT}{job_id}{style.RESET_ALL}')
 
         try:
             if not detach_run:
-                if handle.cluster_name == spot_lib.SPOT_CONTROLLER_NAME:
-                    self.tail_spot_logs(handle, job_id)
+                if (handle.cluster_name in controller_utils.Controllers.
+                        JOBS_CONTROLLER.value.candidate_cluster_names):
+                    self.tail_managed_job_logs(handle, job_id)
                 else:
                     # Sky logs. Not using subprocess.run since it will make the
                     # ssh keep connected after ctrl-c.
                     self.tail_logs(handle, job_id)
         finally:
             name = handle.cluster_name
             controller = controller_utils.Controllers.from_name(name)
-            if controller == controller_utils.Controllers.SPOT_CONTROLLER:
+            if controller == controller_utils.Controllers.JOBS_CONTROLLER:
                 logger.info(
-                    f'{fore.CYAN}Spot Job ID: '
+                    f'{fore.CYAN}Managed Job ID: '
                     f'{style.BRIGHT}{job_id}{style.RESET_ALL}'
                     '\nTo cancel the job:\t\t'
-                    f'{backend_utils.BOLD}sky spot cancel {job_id}'
+                    f'{backend_utils.BOLD}sky jobs cancel {job_id}'
                     f'{backend_utils.RESET_BOLD}'
                     '\nTo stream job logs:\t\t'
-                    f'{backend_utils.BOLD}sky spot logs {job_id}'
+                    f'{backend_utils.BOLD}sky jobs logs {job_id}'
                     f'{backend_utils.RESET_BOLD}'
                     f'\nTo stream controller logs:\t'
-                    f'{backend_utils.BOLD}sky spot logs --controller {job_id}'
+                    f'{backend_utils.BOLD}sky jobs logs --controller {job_id}'
                     f'{backend_utils.RESET_BOLD}'
-                    '\nTo view all spot jobs:\t\t'
-                    f'{backend_utils.BOLD}sky spot queue'
+                    '\nTo view all managed jobs:\t'
+                    f'{backend_utils.BOLD}sky jobs queue'
                     f'{backend_utils.RESET_BOLD}'
-                    '\nTo view the spot job dashboard:\t'
-                    f'{backend_utils.BOLD}sky spot dashboard'
+                    '\nTo view managed job dashboard:\t'
+                    f'{backend_utils.BOLD}sky jobs dashboard'
                     f'{backend_utils.RESET_BOLD}')
             elif controller is None:
                 logger.info(f'{fore.CYAN}Job ID: '
                             f'{style.BRIGHT}{job_id}{style.RESET_ALL}'
                             '\nTo cancel the job:\t'
                             f'{backend_utils.BOLD}sky cancel {name} {job_id}'
                             f'{backend_utils.RESET_BOLD}'
@@ -3533,20 +3536,20 @@
                          for runner in runners]
         subprocess_utils.run_in_parallel(_rsync_down, parallel_args)
         return dict(zip(job_ids, local_log_dirs))
 
     def tail_logs(self,
                   handle: CloudVmRayResourceHandle,
                   job_id: Optional[int],
-                  spot_job_id: Optional[int] = None,
+                  managed_job_id: Optional[int] = None,
                   follow: bool = True) -> int:
         code = job_lib.JobLibCodeGen.tail_logs(job_id,
-                                               spot_job_id=spot_job_id,
+                                               managed_job_id=managed_job_id,
                                                follow=follow)
-        if job_id is None and spot_job_id is None:
+        if job_id is None and managed_job_id is None:
             logger.info(
                 'Job ID not provided. Streaming the logs of the latest job.')
 
         # With the stdin=subprocess.DEVNULL, the ctrl-c will not directly
         # kill the process, so we need to handle it manually here.
         if threading.current_thread() is threading.main_thread():
             signal.signal(signal.SIGINT, backend_utils.interrupt_handler)
@@ -3565,25 +3568,27 @@
                 # Refer to: https://github.com/ray-project/ray/blob/d462172be7c5779abf37609aed08af112a533e1e/python/ray/autoscaler/_private/subprocess_output_util.py#L264 # pylint: disable=line-too-long
                 stdin=subprocess.DEVNULL,
             )
         except SystemExit as e:
             returncode = e.code
         return returncode
 
-    def tail_spot_logs(self,
-                       handle: CloudVmRayResourceHandle,
-                       job_id: Optional[int] = None,
-                       job_name: Optional[str] = None,
-                       follow: bool = True) -> None:
+    def tail_managed_job_logs(self,
+                              handle: CloudVmRayResourceHandle,
+                              job_id: Optional[int] = None,
+                              job_name: Optional[str] = None,
+                              follow: bool = True) -> None:
         # if job_name is not None, job_id should be None
         assert job_name is None or job_id is None, (job_name, job_id)
         if job_name is not None:
-            code = spot_lib.SpotCodeGen.stream_logs_by_name(job_name, follow)
+            code = managed_jobs.ManagedJobCodeGen.stream_logs_by_name(
+                job_name, follow)
         else:
-            code = spot_lib.SpotCodeGen.stream_logs_by_id(job_id, follow)
+            code = managed_jobs.ManagedJobCodeGen.stream_logs_by_id(
+                job_id, follow)
 
         # With the stdin=subprocess.DEVNULL, the ctrl-c will not directly
         # kill the process, so we need to handle it manually here.
         if threading.current_thread() is threading.main_thread():
             signal.signal(signal.SIGINT, backend_utils.interrupt_handler)
             signal.signal(signal.SIGTSTP, backend_utils.stop_handler)
 
@@ -4561,16 +4566,16 @@
             })
         }
 
     def _get_task_env_vars(self, task: task_lib.Task, job_id: int,
                            handle: CloudVmRayResourceHandle) -> Dict[str, str]:
         """Returns the environment variables for the task."""
         env_vars = task.envs.copy()
-        # If it is a managed spot job, the TASK_ID_ENV_VAR will have been
-        # already set by the controller.
+        # If it is a managed job, the TASK_ID_ENV_VAR will have been already set
+        # by the controller.
         if constants.TASK_ID_ENV_VAR not in env_vars:
             env_vars[
                 constants.TASK_ID_ENV_VAR] = common_utils.get_global_job_id(
                     self.run_timestamp,
                     cluster_name=handle.cluster_name,
                     job_id=str(job_id))
         env_vars.update(self._skypilot_predefined_env_vars(handle))
@@ -4614,15 +4619,15 @@
 
         codegen.add_epilogue()
 
         self._exec_code_on_head(handle,
                                 codegen.build(),
                                 job_id,
                                 detach_run=detach_run,
-                                spot_dag=task.spot_dag)
+                                managed_job_dag=task.managed_job_dag)
 
     def _execute_task_n_nodes(self, handle: CloudVmRayResourceHandle,
                               task: task_lib.Task, job_id: int,
                               detach_run: bool) -> None:
         # Strategy:
         #   ray.init(...)
         #   for node:
@@ -4669,8 +4674,8 @@
 
         codegen.add_epilogue()
         # TODO(zhanghao): Add help info for downloading logs.
         self._exec_code_on_head(handle,
                                 codegen.build(),
                                 job_id,
                                 detach_run=detach_run,
-                                spot_dag=task.spot_dag)
+                                managed_job_dag=task.managed_job_dag)
```

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/backends/docker_utils.py` & `skypilot_nightly-1.0.0.dev20240505/sky/backends/docker_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/backends/local_docker_backend.py` & `skypilot_nightly-1.0.0.dev20240505/sky/backends/local_docker_backend.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/backends/monkey_patches/monkey_patch_ray_up.py` & `skypilot_nightly-1.0.0.dev20240505/sky/backends/monkey_patches/monkey_patch_ray_up.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/backends/wheel_utils.py` & `skypilot_nightly-1.0.0.dev20240505/sky/backends/wheel_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/benchmark/benchmark_state.py` & `skypilot_nightly-1.0.0.dev20240505/sky/benchmark/benchmark_state.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/benchmark/benchmark_utils.py` & `skypilot_nightly-1.0.0.dev20240505/sky/benchmark/benchmark_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/check.py` & `skypilot_nightly-1.0.0.dev20240505/sky/check.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/cli.py` & `skypilot_nightly-1.0.0.dev20240505/sky/cli.py`

 * *Files 2% similar despite different names*

```diff
@@ -47,18 +47,18 @@
 import sky
 from sky import backends
 from sky import check as sky_check
 from sky import clouds
 from sky import core
 from sky import exceptions
 from sky import global_user_state
+from sky import jobs as managed_jobs
 from sky import provision as provision_lib
 from sky import serve as serve_lib
 from sky import sky_logging
-from sky import spot as spot_lib
 from sky import status_lib
 from sky.adaptors import common as adaptors_common
 from sky.backends import backend_utils
 from sky.benchmark import benchmark_state
 from sky.benchmark import benchmark_utils
 from sky.clouds import service_catalog
 from sky.data import storage_utils
@@ -87,27 +87,27 @@
 _CONTEXT_SETTINGS = dict(help_option_names=['-h', '--help'])
 
 _CLUSTER_FLAG_HELP = """\
 A cluster name. If provided, either reuse an existing cluster with that name or
 provision a new cluster with that name. Otherwise provision a new cluster with
 an autogenerated name."""
 
-# The maximum number of in-progress spot jobs to show in the status
+# The maximum number of in-progress managed jobs to show in the status
 # command.
-_NUM_SPOT_JOBS_TO_SHOW_IN_STATUS = 5
+_NUM_MANAGED_JOBS_TO_SHOW_IN_STATUS = 5
 
 _STATUS_PROPERTY_CLUSTER_NUM_ERROR_MESSAGE = (
     '{cluster_num} cluster{plural} {verb}. Please specify {cause} '
     'cluster to show its {property}.\nUsage: `sky status --{flag} <cluster>`')
 
 _ENDPOINTS_RETRY_MESSAGE = ('If the cluster was recently started, '
                             'please retry after a while.')
 
 _DAG_NOT_SUPPORTED_MESSAGE = ('YAML specifies a DAG which is only supported by '
-                              '`sky spot launch`. `{command}` supports a '
+                              '`sky jobs launch`. `{command}` supports a '
                               'single task only.')
 
 
 def _get_glob_clusters(clusters: List[str], silent: bool = False) -> List[str]:
     """Returns a list of clusters that match the glob pattern."""
     glob_clusters = []
     for cluster in clusters:
@@ -704,16 +704,16 @@
     use_spot: Optional[bool] = None,
     image_id: Optional[str] = None,
     disk_size: Optional[int] = None,
     disk_tier: Optional[str] = None,
     ports: Optional[Tuple[str]] = None,
     env: Optional[List[Tuple[str, str]]] = None,
     field_to_ignore: Optional[List[str]] = None,
-    # spot launch specific
-    spot_recovery: Optional[str] = None,
+    # job launch specific
+    job_recovery: Optional[str] = None,
 ) -> Union[sky.Task, sky.Dag]:
     """Creates a task or a dag from an entrypoint with overrides.
 
     Returns:
         A dag iff the entrypoint is YAML and contains more than 1 task.
         Otherwise, a task.
     """
@@ -773,17 +773,17 @@
         task = sky.Task(name='sky-cmd', run=entrypoint)
         task.set_resources({sky.Resources()})
 
     # Override.
     if workdir is not None:
         task.workdir = workdir
 
-    # Spot launch specific.
-    if spot_recovery is not None:
-        override_params['spot_recovery'] = spot_recovery
+    # job launch specific.
+    if job_recovery is not None:
+        override_params['job_recovery'] = job_recovery
 
     task.set_resources_override(override_params)
 
     if num_nodes is not None:
         task.num_nodes = num_nodes
     if name is not None:
         task.name = name
@@ -812,39 +812,88 @@
 
     def get_help(self, ctx):
         help_str = ctx.command.help
         ctx.command.help = help_str.replace('.. code-block:: bash\n', '\b')
         return super().get_help(ctx)
 
 
-def _with_deprecation_warning(f, original_name, alias_name):
+def _with_deprecation_warning(
+        f,
+        original_name: str,
+        alias_name: str,
+        override_command_argument: Optional[Dict[str, Any]] = None):
 
     @functools.wraps(f)
     def wrapper(self, *args, **kwargs):
+        override_str = ''
+        if override_command_argument is not None:
+            overrides = []
+            for k, v in override_command_argument.items():
+                if isinstance(v, bool):
+                    if v:
+                        overrides.append(f'--{k}')
+                    else:
+                        overrides.append(f'--no-{k}')
+                else:
+                    overrides.append(f'--{k.replace("_", "-")}={v}')
+            override_str = ' with additional arguments ' + ' '.join(overrides)
         click.secho(
-            f'WARNING: `{alias_name}` is deprecated and will be removed in a '
-            f'future release. Please use `{original_name}` instead.\n',
+            f'WARNING: `{alias_name}` has been renamed to `{original_name}` '
+            f'and will be removed in a future release. Please use the '
+            f'latter{override_str} instead.\n',
             err=True,
             fg='yellow')
         return f(self, *args, **kwargs)
 
     return wrapper
 
 
-def _add_command_alias_to_group(group, command, name, hidden):
+def _override_arguments(callback, override_command_argument: Dict[str, Any]):
+
+    def wrapper(*args, **kwargs):
+        logger.info(f'Overriding arguments: {override_command_argument}')
+        kwargs.update(override_command_argument)
+        return callback(*args, **kwargs)
+
+    return wrapper
+
+
+def _add_command_alias(
+    group: click.Group,
+    command: click.Command,
+    hidden: bool = False,
+    new_group: Optional[click.Group] = None,
+    new_command_name: Optional[str] = None,
+    override_command_argument: Optional[Dict[str, Any]] = None,
+    with_warning: bool = True,
+) -> None:
     """Add a alias of a command to a group."""
+    if new_group is None:
+        new_group = group
+    if new_command_name is None:
+        new_command_name = command.name
+    if new_group == group and new_command_name == command.name:
+        raise ValueError('Cannot add an alias to the same command.')
     new_command = copy.deepcopy(command)
     new_command.hidden = hidden
-    new_command.name = name
+    new_command.name = new_command_name
+
+    if override_command_argument:
+        new_command.callback = _override_arguments(new_command.callback,
+                                                   override_command_argument)
 
     orig = f'sky {group.name} {command.name}'
-    alias = f'sky {group.name} {name}'
-    new_command.invoke = _with_deprecation_warning(new_command.invoke, orig,
-                                                   alias)
-    group.add_command(new_command, name=name)
+    alias = f'sky {new_group.name} {new_command_name}'
+    if with_warning:
+        new_command.invoke = _with_deprecation_warning(
+            new_command.invoke,
+            orig,
+            alias,
+            override_command_argument=override_command_argument)
+    new_group.add_command(new_command, name=new_command_name)
 
 
 def _deprecate_and_hide_command(group, command_to_deprecate,
                                 alternative_command):
     """Hide a command and show a deprecation note, hinting the alternative."""
     command_to_deprecate.hidden = True
     if group is not None:
@@ -1215,71 +1264,90 @@
                                'supports a single task only.')
     task = task_or_dag
 
     click.secho(f'Executing task on cluster {cluster}...', fg='yellow')
     sky.exec(task, backend=backend, cluster_name=cluster, detach_run=detach_run)
 
 
-def _get_spot_jobs(
+def _get_managed_jobs(
         refresh: bool,
         skip_finished: bool,
         show_all: bool,
         limit_num_jobs_to_show: bool = False,
         is_called_by_user: bool = False) -> Tuple[Optional[int], str]:
-    """Get the in-progress spot jobs.
+    """Get the in-progress managed jobs.
 
     Args:
-        refresh: Query the latest statuses, restarting the spot controller if
+        refresh: Query the latest statuses, restarting the jobs controller if
             stopped.
         skip_finished: Show only in-progress jobs.
-        show_all: Show all information of each spot job (e.g., region, price).
+        show_all: Show all information of each job (e.g., region, price).
         limit_num_jobs_to_show: If True, limit the number of jobs to show to
-            _NUM_SPOT_JOBS_TO_SHOW_IN_STATUS, which is mainly used by
+            _NUM_MANAGED_JOBS_TO_SHOW_IN_STATUS, which is mainly used by
             `sky status`.
         is_called_by_user: If this function is called by user directly, or an
             internal call.
 
     Returns:
         A tuple of (num_in_progress_jobs, msg). If num_in_progress_jobs is None,
-        it means there is an error when querying the spot jobs. In this case,
+        it means there is an error when querying the managed jobs. In this case,
         msg contains the error message. Otherwise, msg contains the formatted
-        spot job table.
+        managed job table.
     """
     num_in_progress_jobs = None
     try:
         if not is_called_by_user:
             usage_lib.messages.usage.set_internal()
         with sky_logging.silent():
             # Make the call silent
-            spot_jobs = spot_lib.queue(refresh=refresh,
-                                       skip_finished=skip_finished)
-        num_in_progress_jobs = len(spot_jobs)
+            managed_jobs_ = managed_jobs.queue(refresh=refresh,
+                                               skip_finished=skip_finished)
+        num_in_progress_jobs = len(set(job['job_id'] for job in managed_jobs_))
     except exceptions.ClusterNotUpError as e:
         controller_status = e.cluster_status
         msg = str(e)
         if controller_status is None:
-            msg += (f' (See: {colorama.Style.BRIGHT}sky spot -h'
+            msg += (f' (See: {colorama.Style.BRIGHT}sky jobs -h'
                     f'{colorama.Style.RESET_ALL})')
         elif (controller_status == status_lib.ClusterStatus.STOPPED and
               is_called_by_user):
-            msg += (f' (See finished jobs: {colorama.Style.BRIGHT}'
-                    f'sky spot queue --refresh{colorama.Style.RESET_ALL})')
+            msg += (f' (See finished managed jobs: {colorama.Style.BRIGHT}'
+                    f'sky jobs queue --refresh{colorama.Style.RESET_ALL})')
     except RuntimeError as e:
-        msg = ('Failed to query spot jobs due to connection '
-               'issues. Try again later. '
-               f'Details: {common_utils.format_exception(e, use_bracket=True)}')
+        msg = ''
+        try:
+            # Check the controller status again, as the RuntimeError is likely
+            # due to the controller being autostopped when querying the jobs.
+            controller_type = controller_utils.Controllers.JOBS_CONTROLLER
+            record = backend_utils.refresh_cluster_record(
+                controller_type.value.cluster_name,
+                cluster_status_lock_timeout=0)
+            if (record is None or
+                    record['status'] == status_lib.ClusterStatus.STOPPED):
+                msg = controller_type.value.default_hint_if_non_existent
+        except Exception:  # pylint: disable=broad-except
+            # This is to an best effort to find the latest controller status to
+            # print more helpful message, so we can ignore any exception to
+            # print the original error.
+            pass
+        if not msg:
+            msg = (
+                'Failed to query managed jobs due to connection '
+                'issues. Try again later. '
+                f'Details: {common_utils.format_exception(e, use_bracket=True)}'
+            )
     except Exception as e:  # pylint: disable=broad-except
-        msg = ('Failed to query spot jobs: '
+        msg = ('Failed to query managed jobs: '
                f'{common_utils.format_exception(e, use_bracket=True)}')
     else:
-        max_jobs_to_show = (_NUM_SPOT_JOBS_TO_SHOW_IN_STATUS
+        max_jobs_to_show = (_NUM_MANAGED_JOBS_TO_SHOW_IN_STATUS
                             if limit_num_jobs_to_show else None)
-        msg = spot_lib.format_job_table(spot_jobs,
-                                        show_all=show_all,
-                                        max_jobs=max_jobs_to_show)
+        msg = managed_jobs.format_job_table(managed_jobs_,
+                                            show_all=show_all,
+                                            max_jobs=max_jobs_to_show)
     return num_in_progress_jobs, msg
 
 
 def _get_services(service_names: Optional[List[str]],
                   show_all: bool,
                   show_endpoint: bool,
                   is_called_by_user: bool = False) -> Tuple[Optional[int], str]:
@@ -1310,17 +1378,35 @@
     except exceptions.ClusterNotUpError as e:
         controller_status = e.cluster_status
         msg = str(e)
         if controller_status is None:
             msg += (f' (See: {colorama.Style.BRIGHT}sky serve -h'
                     f'{colorama.Style.RESET_ALL})')
     except RuntimeError as e:
-        msg = ('Failed to fetch service statuses due to connection issues. '
-               'Please try again later. Details: '
-               f'{common_utils.format_exception(e, use_bracket=True)}')
+        msg = ''
+        try:
+            # Check the controller status again, as the RuntimeError is likely
+            # due to the controller being autostopped when querying the
+            # services.
+            controller_type = controller_utils.Controllers.SKY_SERVE_CONTROLLER
+            record = backend_utils.refresh_cluster_record(
+                controller_type.value.cluster_name,
+                cluster_status_lock_timeout=0)
+            if (record is None or
+                    record['status'] == status_lib.ClusterStatus.STOPPED):
+                msg = controller_type.value.default_hint_if_non_existent
+        except Exception:  # pylint: disable=broad-except
+            # This is to an best effort to find the latest controller status to
+            # print more helpful message, so we can ignore any exception to
+            # print the original error.
+            pass
+        if not msg:
+            msg = ('Failed to fetch service statuses due to connection issues. '
+                   'Please try again later. Details: '
+                   f'{common_utils.format_exception(e, use_bracket=True)}')
     except Exception as e:  # pylint: disable=broad-except
         msg = ('Failed to fetch service statuses: '
                f'{common_utils.format_exception(e, use_bracket=True)}')
     else:
         if show_endpoint:
             if len(service_records) != 1:
                 plural = 's' if len(service_records) > 1 else ''
@@ -1376,34 +1462,34 @@
                     'cluster. This option will override all other options.'))
 @click.option('--endpoint',
               required=False,
               default=None,
               type=int,
               help=('Get the endpoint URL for the specified port number on the '
                     'cluster. This option will override all other options.'))
-@click.option('--show-spot-jobs/--no-show-spot-jobs',
+@click.option('--show-managed-jobs/--no-show-managed-jobs',
               default=True,
               is_flag=True,
               required=False,
-              help='Also show recent in-progress spot jobs, if any.')
+              help='Also show recent in-progress managed jobs, if any.')
 @click.option('--show-services/--no-show-services',
               default=True,
               is_flag=True,
               required=False,
               help='Also show sky serve services, if any.')
 @click.argument('clusters',
                 required=False,
                 type=str,
                 nargs=-1,
                 **_get_shell_complete_args(_complete_cluster_name))
 @usage_lib.entrypoint
 # pylint: disable=redefined-builtin
 def status(all: bool, refresh: bool, ip: bool, endpoints: bool,
-           endpoint: Optional[int], show_spot_jobs: bool, show_services: bool,
-           clusters: List[str]):
+           endpoint: Optional[int], show_managed_jobs: bool,
+           show_services: bool, clusters: List[str]):
     # NOTE(dev): Keep the docstring consistent between the Python API and CLI.
     """Show clusters.
 
     If CLUSTERS is given, show those clusters. Otherwise, show all clusters.
 
     If --ip is specified, show the IP address of the head node of the cluster.
     Only available when CLUSTERS contains exactly one cluster, e.g.
@@ -1454,27 +1540,28 @@
       statuses.
 
     - In cases where clusters are changed outside of SkyPilot (e.g., manual
       operations in cloud consoles; unmanaged spot clusters getting preempted)
       or for autostop-enabled clusters, use ``--refresh`` to query the latest
       cluster statuses from the cloud providers.
     """
-    # Using a pool with 2 worker to run the spot job query and sky serve service
-    # query in parallel to speed up. The pool provides a AsyncResult object that
-    # can be used as a future.
+    # Using a pool with 2 worker to run the managed job query and sky serve
+    # service query in parallel to speed up. The pool provides a AsyncResult
+    # object that can be used as a future.
     with multiprocessing.Pool(2) as pool:
-        # Do not show spot queue if user specifies clusters, and if user
+        # Do not show job queue if user specifies clusters, and if user
         # specifies --ip or --endpoint(s).
-        show_spot_jobs = show_spot_jobs and not any([clusters, ip, endpoints])
+        show_managed_jobs = show_managed_jobs and not any(
+            [clusters, ip, endpoints])
         show_endpoints = endpoints or endpoint is not None
         show_single_endpoint = endpoint is not None
-        if show_spot_jobs:
-            # Run the spot job query in parallel to speed up the status query.
-            spot_jobs_future = pool.apply_async(
-                _get_spot_jobs,
+        if show_managed_jobs:
+            # Run managed job query in parallel to speed up the status query.
+            managed_jobs_future = pool.apply_async(
+                _get_managed_jobs,
                 kwds=dict(refresh=False,
                           skip_finished=True,
                           show_all=False,
                           limit_num_jobs_to_show=not all,
                           is_called_by_user=False))
 
         show_services = show_services and not clusters and not ip
@@ -1651,55 +1738,56 @@
             try:
                 result = future.get()
             except KeyboardInterrupt:
                 pool.terminate()
                 interrupted = True
             return interrupted, result
 
-        spot_jobs_query_interrupted = False
-        if show_spot_jobs:
+        managed_jobs_query_interrupted = False
+        if show_managed_jobs:
             click.echo(f'\n{colorama.Fore.CYAN}{colorama.Style.BRIGHT}'
-                       f'Managed spot jobs{colorama.Style.RESET_ALL}')
-            with rich_utils.safe_status('[cyan]Checking spot jobs[/]'):
-                spot_jobs_query_interrupted, result = _try_get_future_result(
-                    spot_jobs_future)
-                if spot_jobs_query_interrupted:
+                       f'Managed jobs{colorama.Style.RESET_ALL}')
+            with rich_utils.safe_status('[cyan]Checking managed jobs[/]'):
+                managed_jobs_query_interrupted, result = _try_get_future_result(
+                    managed_jobs_future)
+                if managed_jobs_query_interrupted:
                     # Set to -1, so that the controller is not considered
-                    # down, and the hint for showing sky spot queue
+                    # down, and the hint for showing sky jobs queue
                     # will still be shown.
                     num_in_progress_jobs = -1
                     msg = 'KeyboardInterrupt'
                 else:
                     num_in_progress_jobs, msg = result
 
             click.echo(msg)
             if num_in_progress_jobs is not None:
-                # spot controller is UP.
+                # jobs controller is UP.
                 job_info = ''
                 if num_in_progress_jobs > 0:
                     plural_and_verb = ' is'
                     if num_in_progress_jobs > 1:
                         plural_and_verb = 's are'
                     job_info = (
-                        f'{num_in_progress_jobs} spot job{plural_and_verb} '
+                        f'{num_in_progress_jobs} managed job{plural_and_verb} '
                         'in progress')
-                    if num_in_progress_jobs > _NUM_SPOT_JOBS_TO_SHOW_IN_STATUS:
+                    if (num_in_progress_jobs >
+                            _NUM_MANAGED_JOBS_TO_SHOW_IN_STATUS):
                         job_info += (
-                            f' ({_NUM_SPOT_JOBS_TO_SHOW_IN_STATUS} latest ones '
-                            'shown)')
+                            f' ({_NUM_MANAGED_JOBS_TO_SHOW_IN_STATUS} latest '
+                            'ones shown)')
                     job_info += '. '
                 hints.append(
-                    controller_utils.Controllers.SPOT_CONTROLLER.value.
+                    controller_utils.Controllers.JOBS_CONTROLLER.value.
                     in_progress_hint.format(job_info=job_info))
 
         if show_services:
             click.echo(f'\n{colorama.Fore.CYAN}{colorama.Style.BRIGHT}'
                        f'Services{colorama.Style.RESET_ALL}')
             num_services = None
-            if spot_jobs_query_interrupted:
+            if managed_jobs_query_interrupted:
                 # The pool is terminated, so we cannot run the service query.
                 msg = 'KeyboardInterrupt'
             else:
                 with rich_utils.safe_status('[cyan]Checking services[/]'):
                     interrupted, result = _try_get_future_result(
                         services_future)
                     if interrupted:
@@ -1708,15 +1796,15 @@
                     else:
                         num_services, msg = result
             click.echo(msg)
             if num_services is not None:
                 hints.append(controller_utils.Controllers.SKY_SERVE_CONTROLLER.
                              value.in_progress_hint)
 
-        if show_spot_jobs or show_services:
+        if show_managed_jobs or show_services:
             try:
                 pool.close()
                 pool.join()
             except SystemExit as e:
                 # This is to avoid a "Exception ignored" problem caused by
                 # ray worker setting the sigterm handler to sys.exit(15)
                 # (see ray/_private/worker.py).
@@ -1979,15 +2067,15 @@
               '-y',
               is_flag=True,
               default=False,
               required=False,
               help='Skip confirmation prompt.')
 @click.argument('jobs', required=False, type=int, nargs=-1)
 @usage_lib.entrypoint
-def cancel(cluster: str, all: bool, jobs: List[int], yes: bool):  # pylint: disable=redefined-builtin
+def cancel(cluster: str, all: bool, jobs: List[int], yes: bool):  # pylint: disable=redefined-builtin, redefined-outer-name
     # NOTE(dev): Keep the docstring consistent between the Python API and CLI.
     """Cancel job(s).
 
     Example usage:
 
     .. code-block:: bash
 
@@ -2378,15 +2466,15 @@
             assert force or cluster_status in (
                 status_lib.ClusterStatus.INIT,
                 status_lib.ClusterStatus.STOPPED), cluster_status
             to_start.append(name)
     if not to_start:
         return
 
-    # Checks for controller clusters (spot controller / sky serve controller).
+    # Checks for controller clusters (jobs controller / sky serve controller).
     controllers, normal_clusters = [], []
     for name in to_start:
         if controller_utils.Controllers.from_name(name) is not None:
             controllers.append(name)
         else:
             normal_clusters.append(name)
     if controllers and normal_clusters:
@@ -2497,53 +2585,54 @@
     _down_or_stop_clusters(clusters,
                            apply_to_all=all,
                            down=True,
                            no_confirm=yes,
                            purge=purge)
 
 
-def _hint_or_raise_for_down_spot_controller(controller_name: str):
+def _hint_or_raise_for_down_jobs_controller(controller_name: str):
     controller = controller_utils.Controllers.from_name(controller_name)
     assert controller is not None, controller_name
 
     with rich_utils.safe_status(
-            '[bold cyan]Checking for in-progress spot jobs[/]'):
+            '[bold cyan]Checking for in-progress managed jobs[/]'):
         try:
-            spot_jobs = spot_lib.queue(refresh=False, skip_finished=True)
+            managed_jobs_ = managed_jobs.queue(refresh=False,
+                                               skip_finished=True)
         except exceptions.ClusterNotUpError as e:
             if controller.value.connection_error_hint in str(e):
                 with ux_utils.print_exception_no_traceback():
                     raise exceptions.NotSupportedError(
                         controller.value.
                         decline_down_when_failed_to_fetch_status_hint)
             if e.cluster_status is None:
                 click.echo(
-                    'Managed spot controller has already been torn down.')
+                    'Managed jobs controller has already been torn down.')
                 sys.exit(0)
-            # At this point, the spot jobs are failed to be fetched due to the
-            # controller being STOPPED or being firstly launched, i.e., there is
-            # no in-prgress spot jobs.
-            spot_jobs = []
+            # At this point, the managed jobs are failed to be fetched due to
+            # the controller being STOPPED or being firstly launched, i.e.,
+            # there is no in-prgress managed jobs.
+            managed_jobs_ = []
 
     msg = (f'{colorama.Fore.YELLOW}WARNING: Tearing down the managed '
-           'spot controller. Please be aware of the following:'
+           'jobs controller. Please be aware of the following:'
            f'{colorama.Style.RESET_ALL}'
-           '\n * All logs and status information of the spot '
-           'jobs (output of `sky spot queue`) will be lost.')
+           '\n * All logs and status information of the managed '
+           'jobs (output of `sky jobs queue`) will be lost.')
     click.echo(msg)
-    if spot_jobs:
-        job_table = spot_lib.format_job_table(spot_jobs, show_all=False)
+    if managed_jobs_:
+        job_table = managed_jobs.format_job_table(managed_jobs_, show_all=False)
         msg = controller.value.decline_down_for_dirty_controller_hint
         # Add prefix to each line to align with the bullet point.
         msg += '\n'.join(
             ['   ' + line for line in job_table.split('\n') if line != ''])
         with ux_utils.print_exception_no_traceback():
             raise exceptions.NotSupportedError(msg)
     else:
-        click.echo(' * No in-progress spot jobs found. It should be safe to '
+        click.echo(' * No in-progress managed jobs found. It should be safe to '
                    'terminate (see caveats above).')
 
 
 def _hint_or_raise_for_down_sky_serve_controller(controller_name: str):
     controller = controller_utils.Controllers.from_name(controller_name)
     assert controller is not None, controller_name
     with rich_utils.safe_status('[bold cyan]Checking for live services[/]'):
@@ -2571,33 +2660,33 @@
                     service_names=', '.join(service_names)))
             raise exceptions.NotSupportedError(msg)
     # Do nothing for STOPPED state, as it is safe to terminate the cluster.
     click.echo(f'Terminate sky serve controller: {controller_name}.')
 
 
 _CONTROLLER_TO_HINT_OR_RAISE = {
-    controller_utils.Controllers.SPOT_CONTROLLER:
-        (_hint_or_raise_for_down_spot_controller),
+    controller_utils.Controllers.JOBS_CONTROLLER:
+        (_hint_or_raise_for_down_jobs_controller),
     controller_utils.Controllers.SKY_SERVE_CONTROLLER:
         (_hint_or_raise_for_down_sky_serve_controller),
 }
 
 
 def _down_or_stop_clusters(
         names: List[str],
         apply_to_all: Optional[bool],
         down: bool,  # pylint: disable=redefined-outer-name
         no_confirm: bool,
         purge: bool = False,
         idle_minutes_to_autostop: Optional[int] = None) -> None:
     """Tears down or (auto-)stops a cluster (or all clusters).
 
-    Controllers (spot controller and sky serve controller) can only be
+    Controllers (jobs controller and sky serve controller) can only be
     terminated if the cluster name is explicitly and uniquely specified (not
-    via glob) and purge is set to True.
+    via glob).
     """
     if down:
         command = 'down'
     elif idle_minutes_to_autostop is not None:
         command = 'autostop'
     else:
         command = 'stop'
@@ -2658,18 +2747,18 @@
                     controller_name)
                 assert controller is not None
                 hint_or_raise = _CONTROLLER_TO_HINT_OR_RAISE[controller]
                 try:
                     # TODO(zhwu): This hint or raise is not transactional, which
                     # means even if it passed the check with no in-progress spot
                     # or service and prompt the confirmation for termination,
-                    # a user could still do a `sky spot launch` or a
+                    # a user could still do a `sky jobs launch` or a
                     # `sky serve up` before typing the delete, causing a leaked
-                    # spot job or service. We should make this check atomic with
-                    # the termination.
+                    # managed job or service. We should make this check atomic
+                    # with the termination.
                     hint_or_raise(controller_name)
                 except exceptions.ClusterOwnerIdentityMismatchError as e:
                     if purge:
                         click.echo(common_utils.format_exception(e))
                     else:
                         raise
                 confirm_str = 'delete'
@@ -3143,31 +3232,31 @@
 @cli.group(cls=_NaturalOrderGroup)
 def bench():
     """SkyPilot Benchmark CLI."""
     pass
 
 
 @cli.group(cls=_NaturalOrderGroup)
-def spot():
-    """Managed Spot CLI (spot instances with auto-recovery)."""
+def jobs():
+    """Managed Jobs CLI (jobs with auto-recovery)."""
     pass
 
 
-@spot.command('launch', cls=_DocumentedCodeCommand)
+@jobs.command('launch', cls=_DocumentedCodeCommand)
 @click.argument('entrypoint',
                 required=True,
                 type=str,
                 nargs=-1,
                 **_get_shell_complete_args(_complete_file_name))
 # TODO(zhwu): Add --dryrun option to test the launch command.
 @_add_click_options(_TASK_OPTIONS_WITH_NAME + _EXTRA_RESOURCES_OPTIONS)
-@click.option('--spot-recovery',
+@click.option('--job-recovery',
               default=None,
               type=str,
-              help='Spot recovery strategy to use for the managed spot task.')
+              help='Recovery strategy to use for managed jobs.')
 @click.option(
     '--detach-run',
     '-d',
     default=False,
     is_flag=True,
     help=('If True, as soon as a job is submitted, return from this call '
           'and do not stream execution logs.'))
@@ -3177,61 +3266,61 @@
     default=None,
     is_flag=True,
     required=False,
     help=(
         '(Default: True; this flag is deprecated and will be removed in a '
         'future release.) Whether to retry provisioning infinitely until the '
         'cluster is up, if unavailability errors are encountered. This '  # pylint: disable=bad-docstring-quotes
-        'applies to launching the spot clusters (both the initial and any '
-        'recovery attempts), not the spot controller.'))
+        'applies to launching all managed jobs (both the initial and '
+        'any recovery attempts), not the jobs controller.'))
 @click.option('--yes',
               '-y',
               is_flag=True,
               default=False,
               required=False,
               help='Skip confirmation prompt.')
 @timeline.event
 @usage_lib.entrypoint
-def spot_launch(
+def jobs_launch(
     entrypoint: List[str],
     name: Optional[str],
     workdir: Optional[str],
     cloud: Optional[str],
     region: Optional[str],
     zone: Optional[str],
     gpus: Optional[str],
     cpus: Optional[str],
     memory: Optional[str],
     instance_type: Optional[str],
     num_nodes: Optional[int],
     use_spot: Optional[bool],
     image_id: Optional[str],
-    spot_recovery: Optional[str],
+    job_recovery: Optional[str],
     env_file: Optional[Dict[str, str]],
     env: List[Tuple[str, str]],
     disk_size: Optional[int],
     disk_tier: Optional[str],
     ports: Tuple[str],
     detach_run: bool,
     retry_until_up: bool,
     yes: bool,
 ):
-    """Launch a managed spot job from a YAML or a command.
+    """Launch a managed job from a YAML or a command.
 
     If ENTRYPOINT points to a valid YAML file, it is read in as the task
     specification. Otherwise, it is interpreted as a bash command.
 
     Examples:
 
     .. code-block:: bash
 
       # You can use normal task YAMLs.
-      sky spot launch task.yaml
+      sky jobs launch task.yaml
 
-      sky spot launch 'echo hello!'
+      sky jobs launch 'echo hello!'
     """
     env = _merge_env_vars(env_file, env)
     task_or_dag = _make_task_or_dag_from_entrypoint_with_overrides(
         entrypoint,
         name=name,
         workdir=workdir,
         cloud=cloud,
@@ -3244,24 +3333,25 @@
         num_nodes=num_nodes,
         use_spot=use_spot,
         image_id=image_id,
         env=env,
         disk_size=disk_size,
         disk_tier=disk_tier,
         ports=ports,
-        spot_recovery=spot_recovery,
+        job_recovery=job_recovery,
     )
-    # Deprecation.
+    # Deprecation. We set the default behavior to be retry until up, and the
+    # flag `--retry-until-up` is deprecated. We can remove the flag in 0.8.0.
     if retry_until_up is not None:
         flag_str = '--retry-until-up'
         if not retry_until_up:
             flag_str = '--no-retry-until-up'
         click.secho(
             f'Flag {flag_str} is deprecated and will be removed in a '
-            'future release (managed spot jobs will always be retried). '
+            'future release (managed jobs will always be retried). '
             'Please file an issue if this does not work for you.',
             fg='yellow')
     else:
         retry_until_up = True
 
     if not isinstance(task_or_dag, sky.Dag):
         assert isinstance(task_or_dag, sky.Task), task_or_dag
@@ -3271,72 +3361,71 @@
     else:
         dag = task_or_dag
 
     if name is not None:
         dag.name = name
 
     dag_utils.maybe_infer_and_fill_dag_and_task_names(dag)
-    dag_utils.fill_default_spot_config_in_dag_for_spot_launch(dag)
+    dag_utils.fill_default_config_in_dag_for_job_launch(dag)
 
-    click.secho(
-        f'Managed spot job {dag.name!r} will be launched on (estimated):',
-        fg='yellow')
+    click.secho(f'Managed job {dag.name!r} will be launched on (estimated):',
+                fg='yellow')
     dag = sky.optimize(dag)
 
     if not yes:
-        prompt = f'Launching the spot job {dag.name!r}. Proceed?'
+        prompt = f'Launching a managed job {dag.name!r}. Proceed?'
         if prompt is not None:
             click.confirm(prompt, default=True, abort=True, show_default=True)
 
     common_utils.check_cluster_name_is_valid(name)
 
-    spot_lib.launch(dag,
-                    name,
-                    detach_run=detach_run,
-                    retry_until_up=retry_until_up)
+    managed_jobs.launch(dag,
+                        name,
+                        detach_run=detach_run,
+                        retry_until_up=retry_until_up)
 
 
-@spot.command('queue', cls=_DocumentedCodeCommand)
+@jobs.command('queue', cls=_DocumentedCodeCommand)
 @click.option('--all',
               '-a',
               default=False,
               is_flag=True,
               required=False,
               help='Show all information in full.')
 @click.option(
     '--refresh',
     '-r',
     default=False,
     is_flag=True,
     required=False,
-    help='Query the latest statuses, restarting the spot controller if stopped.'
+    help='Query the latest statuses, restarting the jobs controller if stopped.'
 )
 @click.option('--skip-finished',
               '-s',
               default=False,
               is_flag=True,
               required=False,
               help='Show only pending/running jobs\' information.')
 @usage_lib.entrypoint
 # pylint: disable=redefined-builtin
-def spot_queue(all: bool, refresh: bool, skip_finished: bool):
-    """Show statuses of managed spot jobs.
+def jobs_queue(all: bool, refresh: bool, skip_finished: bool):
+    """Show statuses of managed jobs.
 
-    Each spot job can have one of the following statuses:
+    Each managed jobs can have one of the following statuses:
 
-    - ``PENDING``: Job is waiting for a free slot on the spot controller to be
+    - ``PENDING``: Job is waiting for a free slot on the jobs controller to be
       accepted.
 
-    - ``SUBMITTED``: Job is submitted to and accepted by the spot controller.
+    - ``SUBMITTED``: Job is submitted to and accepted by the jobs controller.
 
-    - ``STARTING``: Job is starting (provisioning a spot cluster).
+    - ``STARTING``: Job is starting (provisioning a cluster for the job).
 
     - ``RUNNING``: Job is running.
 
-    - ``RECOVERING``: The spot cluster is recovering from a preemption.
+    - ``RECOVERING``: The cluster of the job is recovering from a preemption.
 
     - ``SUCCEEDED``: Job succeeded.
 
     - ``CANCELLING``: Job was requested to be cancelled by the user, and the
       cancellation is in progress.
 
     - ``CANCELLED``: Job was cancelled by the user.
@@ -3351,180 +3440,181 @@
 
     - ``FAILED_NO_RESOURCE``: Job failed due to resources being unavailable
       after a maximum number of retries.
 
     - ``FAILED_CONTROLLER``: Job failed due to an unexpected error in the spot
       controller.
 
-    If the job failed, either due to user code or spot unavailability, the
-    error log can be found with ``sky spot logs --controller``, e.g.:
+    If the job failed, either due to user code or resource unavailability, the
+    error log can be found with ``sky jobs logs --controller``, e.g.:
 
     .. code-block:: bash
 
-      sky spot logs --controller job_id
+      sky jobs logs --controller job_id
 
     This also shows the logs for provisioning and any preemption and recovery
     attempts.
 
     (Tip) To fetch job statuses every 60 seconds, use ``watch``:
 
     .. code-block:: bash
 
-      watch -n60 sky spot queue
+      watch -n60 sky jobs queue
 
     """
-    click.secho('Fetching managed spot job statuses...', fg='yellow')
-    with rich_utils.safe_status('[cyan]Checking spot jobs[/]'):
-        _, msg = _get_spot_jobs(refresh=refresh,
-                                skip_finished=skip_finished,
-                                show_all=all,
-                                is_called_by_user=True)
+    click.secho('Fetching managed job statuses...', fg='yellow')
+    with rich_utils.safe_status('[cyan]Checking managed jobs[/]'):
+        _, msg = _get_managed_jobs(refresh=refresh,
+                                   skip_finished=skip_finished,
+                                   show_all=all,
+                                   is_called_by_user=True)
     if not skip_finished:
         in_progress_only_hint = ''
     else:
         in_progress_only_hint = ' (showing in-progress jobs only)'
     click.echo(f'{colorama.Fore.CYAN}{colorama.Style.BRIGHT}'
-               f'Managed spot jobs{colorama.Style.RESET_ALL}'
+               f'Managed jobs{colorama.Style.RESET_ALL}'
                f'{in_progress_only_hint}\n{msg}')
 
 
-@spot.command('cancel', cls=_DocumentedCodeCommand)
+@jobs.command('cancel', cls=_DocumentedCodeCommand)
 @click.option('--name',
               '-n',
               required=False,
               type=str,
-              help='Managed spot job name to cancel.')
+              help='Managed job name to cancel.')
 @click.argument('job_ids', default=None, type=int, required=False, nargs=-1)
 @click.option('--all',
               '-a',
               is_flag=True,
               default=False,
               required=False,
-              help='Cancel all managed spot jobs.')
+              help='Cancel all managed jobs.')
 @click.option('--yes',
               '-y',
               is_flag=True,
               default=False,
               required=False,
               help='Skip confirmation prompt.')
 @usage_lib.entrypoint
 # pylint: disable=redefined-builtin
-def spot_cancel(name: Optional[str], job_ids: Tuple[int], all: bool, yes: bool):
-    """Cancel managed spot jobs.
+def jobs_cancel(name: Optional[str], job_ids: Tuple[int], all: bool, yes: bool):
+    """Cancel managed jobs.
 
     You can provide either a job name or a list of job IDs to be cancelled.
     They are exclusive options.
 
     Examples:
 
     .. code-block:: bash
 
-      # Cancel managed spot job with name 'my-job'
-      $ sky spot cancel -n my-job
+      # Cancel managed job with name 'my-job'
+      $ sky jobs cancel -n my-job
       \b
-      # Cancel managed spot jobs with IDs 1, 2, 3
-      $ sky spot cancel 1 2 3
+      # Cancel managed jobs with IDs 1, 2, 3
+      $ sky jobs cancel 1 2 3
     """
     backend_utils.is_controller_accessible(
-        controller_type=controller_utils.Controllers.SPOT_CONTROLLER,
-        stopped_message='All managed spot jobs should have finished.',
+        controller=controller_utils.Controllers.JOBS_CONTROLLER,
+        stopped_message='All managed jobs should have finished.',
         exit_if_not_accessible=True)
 
     job_id_str = ','.join(map(str, job_ids))
     if sum([len(job_ids) > 0, name is not None, all]) != 1:
         argument_str = f'--job-ids {job_id_str}' if len(job_ids) > 0 else ''
         argument_str += f' --name {name}' if name is not None else ''
         argument_str += ' --all' if all else ''
         raise click.UsageError(
             'Can only specify one of JOB_IDS or --name or --all. '
             f'Provided {argument_str!r}.')
 
     if not yes:
-        job_identity_str = (f'managed spot jobs with IDs {job_id_str}'
+        job_identity_str = (f'managed jobs with IDs {job_id_str}'
                             if job_ids else repr(name))
         if all:
-            job_identity_str = 'all managed spot jobs'
+            job_identity_str = 'all managed jobs'
         click.confirm(f'Cancelling {job_identity_str}. Proceed?',
                       default=True,
                       abort=True,
                       show_default=True)
 
-    spot_lib.cancel(job_ids=job_ids, name=name, all=all)
+    managed_jobs.cancel(job_ids=job_ids, name=name, all=all)
 
 
-@spot.command('logs', cls=_DocumentedCodeCommand)
+@jobs.command('logs', cls=_DocumentedCodeCommand)
 @click.option('--name',
               '-n',
               required=False,
               type=str,
-              help='Managed spot job name.')
+              help='Managed job name.')
 @click.option(
     '--follow/--no-follow',
     is_flag=True,
     default=True,
     help=('Follow the logs of the job. [default: --follow] '
           'If --no-follow is specified, print the log so far and exit.'))
 @click.option(
     '--controller',
     is_flag=True,
     default=False,
     help=('Show the controller logs of this job; useful for debugging '
           'launching/recoveries, etc.'))
 @click.argument('job_id', required=False, type=int)
 @usage_lib.entrypoint
-def spot_logs(name: Optional[str], job_id: Optional[int], follow: bool,
+def jobs_logs(name: Optional[str], job_id: Optional[int], follow: bool,
               controller: bool):
-    """Tail the log of a managed spot job."""
+    """Tail the log of a managed job."""
     try:
         if controller:
-            core.tail_logs(spot_lib.SPOT_CONTROLLER_NAME,
-                           job_id=job_id,
-                           follow=follow)
+            core.tail_logs(
+                controller_utils.Controllers.JOBS_CONTROLLER.value.cluster_name,
+                job_id=job_id,
+                follow=follow)
         else:
-            spot_lib.tail_logs(name=name, job_id=job_id, follow=follow)
+            managed_jobs.tail_logs(name=name, job_id=job_id, follow=follow)
     except exceptions.ClusterNotUpError as e:
         click.echo(e)
         sys.exit(1)
 
 
-@spot.command('dashboard', cls=_DocumentedCodeCommand)
+@jobs.command('dashboard', cls=_DocumentedCodeCommand)
 @click.option(
     '--port',
     '-p',
     default=None,
     type=int,
     required=False,
     help=('Local port to use for the dashboard. If None, a free port is '
           'automatically chosen.'))
 @usage_lib.entrypoint
-def spot_dashboard(port: Optional[int]):
-    """Opens a dashboard for spot jobs (needs controller to be UP)."""
+def jobs_dashboard(port: Optional[int]):
+    """Opens a dashboard for managed jobs (needs controller to be UP)."""
     # TODO(zongheng): ideally, the controller/dashboard server should expose the
     # API perhaps via REST. Then here we would (1) not have to use SSH to try to
     # see if the controller is UP first, which is slow; (2) not have to run SSH
     # port forwarding first (we'd just launch a local dashboard which would make
     # REST API calls to the controller dashboard server).
-    click.secho('Checking if spot controller is up...', fg='yellow')
-    hint = (
-        'Dashboard is not available if spot controller is not up. Run a spot '
-        'job first.')
+    click.secho('Checking if jobs controller is up...', fg='yellow')
+    hint = ('Dashboard is not available if jobs controller is not up. Run a '
+            'managed job first.')
     backend_utils.is_controller_accessible(
-        controller_type=controller_utils.Controllers.SPOT_CONTROLLER,
+        controller=controller_utils.Controllers.JOBS_CONTROLLER,
         stopped_message=hint,
         non_existent_message=hint,
         exit_if_not_accessible=True)
 
     # SSH forward a free local port to remote's dashboard port.
     remote_port = constants.SPOT_DASHBOARD_REMOTE_PORT
     if port is None:
         free_port = common_utils.find_free_port(remote_port)
     else:
         free_port = port
-    ssh_command = (f'ssh -qNL {free_port}:localhost:{remote_port} '
-                   f'{spot_lib.SPOT_CONTROLLER_NAME}')
+    ssh_command = (
+        f'ssh -qNL {free_port}:localhost:{remote_port} '
+        f'{controller_utils.Controllers.JOBS_CONTROLLER.value.cluster_name}')
     click.echo('Forwarding port: ', nl=False)
     click.secho(f'{ssh_command}', dim=True)
 
     with subprocess.Popen(ssh_command, shell=True,
                           start_new_session=True) as ssh_process:
         time.sleep(3)  # Added delay for ssh_command to initialize.
         webbrowser.open(f'http://localhost:{free_port}')
@@ -3535,20 +3625,39 @@
             ssh_process.wait()
         except KeyboardInterrupt:
             # When user presses Ctrl-C in terminal, exits the previous ssh
             # command so that <free local port> is freed up.
             try:
                 os.killpg(os.getpgid(ssh_process.pid), signal.SIGTERM)
             except ProcessLookupError:
-                # This happens if spot controller is auto-stopped.
+                # This happens if jobs controller is auto-stopped.
                 pass
         finally:
             click.echo('Exiting.')
 
 
+# TODO(zhwu): Backward compatibility for the old `sky spot launch` command.
+# It is now renamed to `sky jobs launch` and the old command is deprecated.
+# Remove in v0.8.0.
+@cli.group(cls=_NaturalOrderGroup)
+def spot():
+    """Alias for Managed Jobs CLI (default to managed spot jobs)."""
+    pass
+
+
+_add_command_alias(jobs,
+                   jobs_launch,
+                   new_group=spot,
+                   override_command_argument={'use_spot': True})
+_add_command_alias(jobs, jobs_queue, new_group=spot)
+_add_command_alias(jobs, jobs_logs, new_group=spot)
+_add_command_alias(jobs, jobs_cancel, new_group=spot)
+_add_command_alias(jobs, jobs_dashboard, new_group=spot)
+
+
 @cli.group(cls=_NaturalOrderGroup)
 def serve():
     """SkyServe CLI (multi-region, multi-cloud serving)."""
     pass
 
 
 def _generate_task_with_service(
@@ -4036,15 +4145,15 @@
             service_names) > 0 else ''
         argument_str += ' --all' if all else ''
         raise click.UsageError(
             'Can only specify one of SERVICE_NAMES or --all. '
             f'Provided {argument_str!r}.')
 
     backend_utils.is_controller_accessible(
-        controller_type=controller_utils.Controllers.SKY_SERVE_CONTROLLER,
+        controller=controller_utils.Controllers.SKY_SERVE_CONTROLLER,
         stopped_message='All services should have been terminated.',
         exit_if_not_accessible=True)
 
     if not yes:
         quoted_service_names = [f'{name!r}' for name in service_names]
         service_identity_str = f'service(s) {", ".join(quoted_service_names)}'
         if all:
```

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/cloud_stores.py` & `skypilot_nightly-1.0.0.dev20240505/sky/cloud_stores.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/clouds/__init__.py` & `skypilot_nightly-1.0.0.dev20240505/sky/clouds/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/clouds/aws.py` & `skypilot_nightly-1.0.0.dev20240505/sky/clouds/aws.py`

 * *Files 0% similar despite different names*

```diff
@@ -33,15 +33,15 @@
 # This local file (under ~/.aws/) will be uploaded to remote nodes (any
 # cloud), if all of the following conditions hold:
 #   - the current user identity is not using AWS SSO
 #   - this file exists
 # It has the following purposes:
 #   - make all nodes (any cloud) able to access private S3 buckets
 #   - make some remote nodes able to launch new nodes on AWS (i.e., makes
-#     AWS head node able to launch AWS workers, or any-cloud spot controller
+#     AWS head node able to launch AWS workers, or any-cloud jobs controller
 #     able to launch spot clusters on AWS).
 #
 # If we detect the current user identity is AWS SSO, we will not upload this
 # file to any remote nodes (any cloud). Instead, a SkyPilot IAM role is
 # assigned to both AWS head and workers.
 # TODO(skypilot): This also means we leave open a bug for AWS SSO users that
 # use multiple clouds. The non-AWS nodes will have neither the credential
@@ -537,17 +537,17 @@
                     'with static credentials (e.g., ~/.aws/credentials) by unsetting '
                     'the AWS_PROFILE environment variable.')
             else:
                 hints += single_cloud_hint
         elif identity_type == AWSIdentityType.IAM_ROLE:
             # When using an IAM role, the credentials may not exist in the
             # ~/.aws/credentials file. So we don't check for the existence of the
-            # file. This will happen when the user is on a VM (or spot-controller)
-            # created by an SSO account, i.e. the VM will be assigned the IAM
-            # role: skypilot-v1.
+            # file. This will happen when the user is on a VM (or
+            # jobs-controller) created by an SSO account, i.e. the VM will be
+            # assigned the IAM role: skypilot-v1.
             hints = f'AWS IAM role is set.{single_cloud_hint}'
         else:
             # This file is required because it is required by the VMs launched on
             # other clouds to access private s3 buckets and resources like EC2.
             # `get_current_user_identity` does not guarantee this file exists.
             if not static_credential_exists:
                 return (False, '~/.aws/credentials does not exist. ' +
@@ -741,15 +741,15 @@
         # buckets.
         #
         # TODO(zhwu/zongheng): We can also avoid uploading the credential file
         # for the cluster launched on AWS even if the user is using static
         # credentials. We need to define a mechanism to find out the cloud
         # provider of the cluster to be launched in this function and make sure
         # the cluster will not be used for launching clusters in other clouds,
-        # e.g. spot controller.
+        # e.g. jobs controller.
         if self._current_identity_type(
         ) != AWSIdentityType.SHARED_CREDENTIALS_FILE:
             return {}
         return {
             f'~/.aws/{filename}': f'~/.aws/{filename}'
             for filename in _CREDENTIAL_FILES
             if os.path.exists(os.path.expanduser(f'~/.aws/{filename}'))
```

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/clouds/azure.py` & `skypilot_nightly-1.0.0.dev20240505/sky/clouds/azure.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/clouds/cloud.py` & `skypilot_nightly-1.0.0.dev20240505/sky/clouds/cloud.py`

 * *Files 1% similar despite different names*

```diff
@@ -38,15 +38,15 @@
     CLONE_DISK_FROM_CLUSTER = 'clone_disk_from_cluster'
     IMAGE_ID = 'image_id'
     DOCKER_IMAGE = 'docker_image'
     SPOT_INSTANCE = 'spot_instance'
     CUSTOM_DISK_TIER = 'custom_disk_tier'
     OPEN_PORTS = 'open_ports'
     STORAGE_MOUNTING = 'storage_mounting'
-    HOST_CONTROLLERS = 'host_controllers'  # Can run spot/serve controllers
+    HOST_CONTROLLERS = 'host_controllers'  # Can run jobs/serve controllers
 
 
 class Region(collections.namedtuple('Region', ['name'])):
     """A region."""
     name: str
     zones: Optional[List['Zone']] = None
 
@@ -492,23 +492,24 @@
         Raises:
             ValueError: If region or zone is invalid or not supported.
         """
         return service_catalog.validate_region_zone(region,
                                                     zone,
                                                     clouds=self._REPR.lower())
 
-    def need_cleanup_after_preemption(
+    def need_cleanup_after_preemption_or_failure(
             self, resources: 'resources_lib.Resources') -> bool:
-        """Returns whether a spot resource needs cleanup after preeemption.
+        """Whether a resource needs cleanup after preeemption or failure.
 
         In most cases, spot resources do not need cleanup after preemption,
         as long as the cluster can be relaunched with the same name and tag,
         no matter the preemption behavior is to terminate or stop the cluster.
-        The only exception by far is GCP's Spot TPU VM. We override this method
-        in gcp.py.
+        Similar for on-demand resources that go into maintenance mode. The
+        only exception by far is GCP's TPU VM. We override this method in
+        gcp.py.
         """
         del resources
         return False
 
     @classmethod
     def check_features_are_supported(
             cls, resources: 'resources_lib.Resources',
```

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/clouds/cloud_registry.py` & `skypilot_nightly-1.0.0.dev20240505/sky/clouds/cloud_registry.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/clouds/cudo.py` & `skypilot_nightly-1.0.0.dev20240505/sky/clouds/cudo.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/clouds/fluidstack.py` & `skypilot_nightly-1.0.0.dev20240505/sky/clouds/fluidstack.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/clouds/gcp.py` & `skypilot_nightly-1.0.0.dev20240505/sky/clouds/gcp.py`

 * *Files 2% similar despite different names*

```diff
@@ -837,21 +837,22 @@
         if user_identity is None:
             return None
         return user_identity[0].replace('\n', '')
 
     def instance_type_exists(self, instance_type):
         return service_catalog.instance_type_exists(instance_type, 'gcp')
 
-    def need_cleanup_after_preemption(self,
-                                      resources: 'resources.Resources') -> bool:
-        """Returns whether a spot resource needs cleanup after preeemption."""
+    def need_cleanup_after_preemption_or_failure(
+            self, resources: 'resources.Resources') -> bool:
+        """Whether a resource needs cleanup after preeemption or failure."""
         # Spot TPU VMs require manual cleanup after preemption.
         # "If your Cloud TPU is preempted,
         # you must delete it and create a new one ..."
         # See: https://cloud.google.com/tpu/docs/preemptible#tpu-vm
+        # On-demand TPU VMs are likely to require manual cleanup as well.
 
         return gcp_utils.is_tpu_vm(resources)
 
     @classmethod
     def get_project_id(cls, dryrun: bool = False) -> str:
         if dryrun:
             return 'dryrun-project-id'
```

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/clouds/ibm.py` & `skypilot_nightly-1.0.0.dev20240505/sky/clouds/ibm.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/clouds/kubernetes.py` & `skypilot_nightly-1.0.0.dev20240505/sky/clouds/kubernetes.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/clouds/lambda_cloud.py` & `skypilot_nightly-1.0.0.dev20240505/sky/clouds/lambda_cloud.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/clouds/oci.py` & `skypilot_nightly-1.0.0.dev20240505/sky/clouds/oci.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/clouds/paperspace.py` & `skypilot_nightly-1.0.0.dev20240505/sky/clouds/paperspace.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/clouds/runpod.py` & `skypilot_nightly-1.0.0.dev20240505/sky/clouds/runpod.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/clouds/scp.py` & `skypilot_nightly-1.0.0.dev20240505/sky/clouds/scp.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/clouds/service_catalog/__init__.py` & `skypilot_nightly-1.0.0.dev20240505/sky/clouds/service_catalog/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/clouds/service_catalog/aws_catalog.py` & `skypilot_nightly-1.0.0.dev20240505/sky/clouds/service_catalog/aws_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/clouds/service_catalog/azure_catalog.py` & `skypilot_nightly-1.0.0.dev20240505/sky/clouds/service_catalog/azure_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/clouds/service_catalog/common.py` & `skypilot_nightly-1.0.0.dev20240505/sky/clouds/service_catalog/common.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/clouds/service_catalog/config.py` & `skypilot_nightly-1.0.0.dev20240505/sky/clouds/service_catalog/config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/clouds/service_catalog/cudo_catalog.py` & `skypilot_nightly-1.0.0.dev20240505/sky/clouds/service_catalog/cudo_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/clouds/service_catalog/data_fetchers/fetch_aws.py` & `skypilot_nightly-1.0.0.dev20240505/sky/clouds/service_catalog/data_fetchers/fetch_aws.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/clouds/service_catalog/data_fetchers/fetch_azure.py` & `skypilot_nightly-1.0.0.dev20240505/sky/clouds/service_catalog/data_fetchers/fetch_azure.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/clouds/service_catalog/data_fetchers/fetch_cudo.py` & `skypilot_nightly-1.0.0.dev20240505/sky/clouds/service_catalog/data_fetchers/fetch_cudo.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/clouds/service_catalog/data_fetchers/fetch_fluidstack.py` & `skypilot_nightly-1.0.0.dev20240505/sky/clouds/service_catalog/data_fetchers/fetch_fluidstack.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/clouds/service_catalog/data_fetchers/fetch_gcp.py` & `skypilot_nightly-1.0.0.dev20240505/sky/clouds/service_catalog/data_fetchers/fetch_gcp.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/clouds/service_catalog/data_fetchers/fetch_lambda_cloud.py` & `skypilot_nightly-1.0.0.dev20240505/sky/clouds/service_catalog/data_fetchers/fetch_lambda_cloud.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/clouds/service_catalog/data_fetchers/fetch_vsphere.py` & `skypilot_nightly-1.0.0.dev20240505/sky/clouds/service_catalog/data_fetchers/fetch_vsphere.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/clouds/service_catalog/fluidstack_catalog.py` & `skypilot_nightly-1.0.0.dev20240505/sky/clouds/service_catalog/fluidstack_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/clouds/service_catalog/gcp_catalog.py` & `skypilot_nightly-1.0.0.dev20240505/sky/clouds/service_catalog/gcp_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/clouds/service_catalog/ibm_catalog.py` & `skypilot_nightly-1.0.0.dev20240505/sky/clouds/service_catalog/ibm_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/clouds/service_catalog/kubernetes_catalog.py` & `skypilot_nightly-1.0.0.dev20240505/sky/clouds/service_catalog/kubernetes_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/clouds/service_catalog/lambda_catalog.py` & `skypilot_nightly-1.0.0.dev20240505/sky/clouds/service_catalog/lambda_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/clouds/service_catalog/oci_catalog.py` & `skypilot_nightly-1.0.0.dev20240505/sky/clouds/service_catalog/oci_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/clouds/service_catalog/paperspace_catalog.py` & `skypilot_nightly-1.0.0.dev20240505/sky/clouds/service_catalog/paperspace_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/clouds/service_catalog/runpod_catalog.py` & `skypilot_nightly-1.0.0.dev20240505/sky/clouds/service_catalog/runpod_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/clouds/service_catalog/scp_catalog.py` & `skypilot_nightly-1.0.0.dev20240505/sky/clouds/service_catalog/scp_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/clouds/service_catalog/vsphere_catalog.py` & `skypilot_nightly-1.0.0.dev20240505/sky/clouds/service_catalog/vsphere_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/clouds/utils/gcp_utils.py` & `skypilot_nightly-1.0.0.dev20240505/sky/clouds/utils/gcp_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/clouds/utils/lambda_utils.py` & `skypilot_nightly-1.0.0.dev20240505/sky/clouds/utils/lambda_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/clouds/utils/oci_utils.py` & `skypilot_nightly-1.0.0.dev20240505/sky/clouds/utils/oci_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/clouds/utils/scp_utils.py` & `skypilot_nightly-1.0.0.dev20240505/sky/clouds/utils/scp_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/clouds/vsphere.py` & `skypilot_nightly-1.0.0.dev20240505/sky/clouds/vsphere.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/core.py` & `skypilot_nightly-1.0.0.dev20240505/sky/core.py`

 * *Files 0% similar despite different names*

```diff
@@ -192,16 +192,14 @@
                 'Passing a custom autostop setting is currently not '
                 'supported when starting SkyPilot controllers. To '
                 'fix: omit the `idle_minutes_to_autostop` argument to use the '
                 f'default autostop settings (got: {idle_minutes_to_autostop}).')
         idle_minutes_to_autostop = (
             constants.CONTROLLER_IDLE_MINUTES_TO_AUTOSTOP)
 
-    # NOTE: if spot_queue() calls _start() and hits here, that entrypoint
-    # would have a cluster name (the controller) filled in.
     usage_lib.record_cluster_name_for_current_operation(cluster_name)
 
     with dag.Dag():
         dummy_task = task.Task().set_resources(handle.launched_resources)
         dummy_task.num_nodes = handle.launched_nodes
     handle = backend.provision(dummy_task,
                                to_provision=handle.launched_resources,
@@ -260,15 +258,15 @@
         force: whether to force start the cluster even if it is already up.
             Useful for upgrading SkyPilot runtime.
 
     Raises:
         ValueError: argument values are invalid: (1) the specified cluster does
           not exist; (2) if ``down`` is set to True but
           ``idle_minutes_to_autostop`` is None; (3) if the specified cluster is
-          the managed spot controller, and either ``idle_minutes_to_autostop``
+          the managed jobs controller, and either ``idle_minutes_to_autostop``
           is not None or ``down`` is True (omit them to use the default
           autostop settings).
         sky.exceptions.NotSupportedError: if the cluster to restart was
           launched using a non-default backend that does not support this
           operation.
         sky.exceptions.ClusterOwnerIdentitiesMismatchError: if the cluster to
             restart was launched by a different user.
@@ -313,15 +311,15 @@
             user's responsibility to ensure there are no leaked instances and
             related resources.
 
     Raises:
         ValueError: the specified cluster does not exist.
         RuntimeError: failed to stop the cluster.
         sky.exceptions.NotSupportedError: if the specified cluster is a spot
-          cluster, or a TPU VM Pod cluster, or the managed spot controller.
+          cluster, or a TPU VM Pod cluster, or the managed jobs controller.
     """
     if controller_utils.Controllers.from_name(cluster_name) is not None:
         raise exceptions.NotSupportedError(
             f'Stopping SkyPilot controller {cluster_name!r} '
             f'is not supported.')
     handle = global_user_state.get_handle_from_cluster_name(cluster_name)
     if handle is None:
@@ -368,15 +366,15 @@
             responsibility to ensure there are no leaked instances and related
             resources.
 
     Raises:
         ValueError: the specified cluster does not exist.
         RuntimeError: failed to tear down the cluster.
         sky.exceptions.NotSupportedError: the specified cluster is the managed
-          spot controller.
+          jobs controller.
     """
     handle = global_user_state.get_handle_from_cluster_name(cluster_name)
     if handle is None:
         raise ValueError(f'Cluster {cluster_name!r} does not exist.')
 
     usage_lib.record_cluster_name_for_current_operation(cluster_name)
     backend = backend_utils.get_backend_from_handle(handle)
@@ -555,15 +553,15 @@
     Please refer to the sky.cli.cancel for the document.
 
     When `all` is False and `job_ids` is None, cancel the latest running job.
 
     Additional arguments:
         _try_cancel_if_cluster_is_init: (bool) whether to try cancelling the job
             even if the cluster is not UP, but the head node is still alive.
-            This is used by the spot controller to cancel the job when the
+            This is used by the jobs controller to cancel the job when the
             worker node is preempted in the spot cluster.
 
     Raises:
         ValueError: if arguments are invalid, or the cluster does not exist.
         sky.exceptions.ClusterNotUpError: if the cluster is not UP.
         sky.exceptions.NotSupportedError: if the specified cluster is a
           controller that does not support this operation.
```

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/dag.py` & `skypilot_nightly-1.0.0.dev20240505/sky/dag.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/data/data_transfer.py` & `skypilot_nightly-1.0.0.dev20240505/sky/data/data_transfer.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/data/data_utils.py` & `skypilot_nightly-1.0.0.dev20240505/sky/data/data_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/data/mounting_utils.py` & `skypilot_nightly-1.0.0.dev20240505/sky/data/mounting_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/data/storage.py` & `skypilot_nightly-1.0.0.dev20240505/sky/data/storage.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/data/storage_utils.py` & `skypilot_nightly-1.0.0.dev20240505/sky/data/storage_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/exceptions.py` & `skypilot_nightly-1.0.0.dev20240505/sky/exceptions.py`

 * *Files 5% similar despite different names*

```diff
@@ -48,35 +48,36 @@
 
 class InvalidCloudConfigs(Exception):
     """Raised when invalid configurations are provided for a given cloud."""
     pass
 
 
 class ProvisionPrechecksError(Exception):
-    """Raised when a spot job fails prechecks before provision.
+    """Raised when a managed job fails prechecks before provision.
+
     Developer note: For now this should only be used by managed
-    spot code path (technically, this can/should be raised by the
+    jobs code path (technically, this can/should be raised by the
     lower-level sky.launch()). Please refer to the docstring of
-    `spot.recovery_strategy._launch` for more details about when
+    `jobs.recovery_strategy._launch` for more details about when
     the error will be raised.
 
     Args:
         reasons: (List[Exception]) The reasons why the prechecks failed.
     """
 
     def __init__(self, reasons: List[Exception]) -> None:
         super().__init__()
         self.reasons = list(reasons)
 
 
-class SpotJobReachedMaxRetriesError(Exception):
-    """Raised when a spot job fails to be launched after maximum retries.
+class ManagedJobReachedMaxRetriesError(Exception):
+    """Raised when a managed job fails to be launched after maximum retries.
 
-    Developer note: For now this should only be used by managed spot code
-    path. Please refer to the docstring of `spot.recovery_strategy._launch`
+    Developer note: For now this should only be used by managed jobs code
+    path. Please refer to the docstring of `jobs.recovery_strategy._launch`
     for more details about when the error will be raised.
     """
     pass
 
 
 class ResourcesMismatchError(Exception):
     """Raised when resources are mismatched."""
@@ -207,16 +208,16 @@
 
 
 class ClusterStatusFetchingError(Exception):
     """Raised when fetching the cluster status fails."""
     pass
 
 
-class SpotUserCancelledError(Exception):
-    """Raised when a spot user cancels the job."""
+class ManagedJobUserCancelledError(Exception):
+    """Raised when a user cancels a managed job."""
     pass
 
 
 class InvalidClusterNameError(Exception):
     """Raised when the cluster name is invalid."""
     pass
```

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/execution.py` & `skypilot_nightly-1.0.0.dev20240505/sky/execution.py`

 * *Files 1% similar despite different names*

```diff
@@ -104,15 +104,15 @@
     detach_setup: bool = False,
     detach_run: bool = False,
     idle_minutes_to_autostop: Optional[int] = None,
     no_setup: bool = False,
     clone_disk_from: Optional[str] = None,
     # Internal only:
     # pylint: disable=invalid-name
-    _is_launched_by_spot_controller: bool = False,
+    _is_launched_by_jobs_controller: bool = False,
     _is_launched_by_sky_serve_controller: bool = False,
 ) -> Tuple[Optional[int], Optional[backends.ResourceHandle]]:
     """Execute an entrypoint.
 
     If sky.Task is given or DAG has not been optimized yet, this will call
     sky.optimize() for the caller.
 
@@ -156,19 +156,19 @@
       handle: Optional[backends.ResourceHandle]; the handle to the cluster. None
         if dryrun.
     """
     dag = dag_utils.convert_entrypoint_to_dag(entrypoint)
     assert len(dag) == 1, f'We support 1 task for now. {dag}'
     task = dag.tasks[0]
 
-    if task.need_spot_recovery:
+    if any(r.job_recovery is not None for r in task.resources):
         with ux_utils.print_exception_no_traceback():
             raise ValueError(
-                'Spot recovery is specified in the task. To launch the '
-                'managed spot job, please use: sky spot launch')
+                'Job recovery is specified in the task. To launch a '
+                'managed job, please use: sky jobs launch')
 
     cluster_exists = False
     if cluster_name is not None:
         existing_handle = global_user_state.get_handle_from_cluster_name(
             cluster_name)
         cluster_exists = existing_handle is not None
         # TODO(woosuk): If the cluster exists, print a warning that
@@ -221,28 +221,28 @@
                 f' {backends.CloudVmRayBackend.NAME}')
 
     if Stage.CLONE_DISK in stages:
         task = _maybe_clone_disk_from_cluster(clone_disk_from, cluster_name,
                                               task)
 
     if not cluster_exists:
-        # If spot is launched by skyserve controller or managed spot controller,
-        # We don't need to print out the logger info.
+        # If spot is launched on serve or jobs controller, we don't need to
+        # print out the hint.
         if (Stage.PROVISION in stages and task.use_spot and
-                not _is_launched_by_spot_controller and
+                not _is_launched_by_jobs_controller and
                 not _is_launched_by_sky_serve_controller):
             yellow = colorama.Fore.YELLOW
             bold = colorama.Style.BRIGHT
             reset = colorama.Style.RESET_ALL
             logger.info(
                 f'{yellow}Launching an unmanaged spot task, which does not '
                 f'automatically recover from preemptions.{reset}\n{yellow}To '
-                'get automatic recovery, use managed spot instead: '
-                f'{reset}{bold}sky spot launch{reset} {yellow}or{reset} '
-                f'{bold}sky.spot.launch(){reset}.')
+                'get automatic recovery, use managed job instead: '
+                f'{reset}{bold}sky jobs launch{reset} {yellow}or{reset} '
+                f'{bold}sky.jobs.launch(){reset}.')
 
         if Stage.OPTIMIZE in stages:
             if task.best_resources is None:
                 # TODO: fix this for the situation where number of requested
                 # accelerators is not an integer.
                 if isinstance(backend, backends.CloudVmRayBackend):
                     # TODO: adding this check because docker backend on a
@@ -314,27 +314,27 @@
                 backend.teardown_ephemeral_storage(task)
                 backend.teardown(handle, terminate=True)
     finally:
         controller = controller_utils.Controllers.from_name(cluster_name)
         if controller is None and not _is_launched_by_sky_serve_controller:
             # UX: print live clusters to make users aware (to save costs).
             #
-            # Don't print if this job is launched by the spot controller,
-            # because spot jobs are serverless, there can be many of them, and
-            # users tend to continuously monitor spot jobs using `sky spot
-            # status`. Also don't print if this job is a skyserve controller
+            # Don't print if this job is launched by the jobs controller,
+            # because managed jobs are serverless, there can be many of them,
+            # and users tend to continuously monitor managed jobs using `sky
+            # job queue`. Also don't print if this job is a skyserve controller
             # job or launched by a skyserve controller job, because the
             # redirect for this subprocess.run won't success and it will
             # pollute the controller logs.
             #
             # Disable the usage collection for this status command.
             env = dict(os.environ,
                        **{env_options.Options.DISABLE_LOGGING.value: '1'})
             subprocess_utils.run(
-                'sky status --no-show-spot-jobs --no-show-services', env=env)
+                'sky status --no-show-managed-jobs --no-show-services', env=env)
         print()
         print('\x1b[?25h', end='')  # Show cursor.
     return job_id, handle
 
 
 @timeline.event
 @usage_lib.entrypoint
@@ -350,15 +350,15 @@
     optimize_target: optimizer.OptimizeTarget = optimizer.OptimizeTarget.COST,
     detach_setup: bool = False,
     detach_run: bool = False,
     no_setup: bool = False,
     clone_disk_from: Optional[str] = None,
     # Internal only:
     # pylint: disable=invalid-name
-    _is_launched_by_spot_controller: bool = False,
+    _is_launched_by_jobs_controller: bool = False,
     _is_launched_by_sky_serve_controller: bool = False,
     _disable_controller_check: bool = False,
 ) -> Tuple[Optional[int], Optional[backends.ResourceHandle]]:
     # NOTE(dev): Keep the docstring consistent between the Python API and CLI.
     """Launch a cluster or task.
 
     The task's setup and run commands are executed under the task's workdir
@@ -460,15 +460,15 @@
         optimize_target=optimize_target,
         cluster_name=cluster_name,
         detach_setup=detach_setup,
         detach_run=detach_run,
         idle_minutes_to_autostop=idle_minutes_to_autostop,
         no_setup=no_setup,
         clone_disk_from=clone_disk_from,
-        _is_launched_by_spot_controller=_is_launched_by_spot_controller,
+        _is_launched_by_jobs_controller=_is_launched_by_jobs_controller,
         _is_launched_by_sky_serve_controller=
         _is_launched_by_sky_serve_controller,
     )
 
 
 @usage_lib.entrypoint
 def exec(  # pylint: disable=redefined-builtin
```

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/global_user_state.py` & `skypilot_nightly-1.0.0.dev20240505/sky/global_user_state.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/optimizer.py` & `skypilot_nightly-1.0.0.dev20240505/sky/optimizer.py`

 * *Files 1% similar despite different names*

```diff
@@ -805,18 +805,20 @@
                 sort_keys=True)
 
         # Print the list of resouces that the optimizer considered.
         resource_fields = [
             'CLOUD', 'INSTANCE', 'vCPUs', 'Mem(GB)', 'ACCELERATORS',
             'REGION/ZONE'
         ]
-        # Do not print Source or Sink.
-        best_plan_rows = [[t, t.num_nodes] + _get_resources_element_list(r)
-                          for t, r in ordered_best_plan.items()]
-        if len(best_plan_rows) > 1:
+        if len(ordered_best_plan) > 1:
+            best_plan_rows = []
+            for t, r in ordered_best_plan.items():
+                assert t.name is not None, t
+                best_plan_rows.append([t.name, str(t.num_nodes)] +
+                                      _get_resources_element_list(r))
             logger.info(
                 f'{colorama.Style.BRIGHT}Best plan: {colorama.Style.RESET_ALL}')
             best_plan_table = _create_table(['TASK', '#NODES'] +
                                             resource_fields)
             best_plan_table.add_rows(best_plan_rows)
             logger.info(f'{best_plan_table}\n')
 
@@ -831,15 +833,15 @@
             # Hack: convert the dictionary values
             # (resources) to their yaml config
             # For dictionary comparison later.
             v_yaml = {
                 json.dumps(resource.to_yaml_config()): cost
                 for resource, cost in v.items()
             }
-            task_str = (f'for task {repr(task)!r} ' if num_tasks > 1 else '')
+            task_str = (f'for task {task.name!r} ' if num_tasks > 1 else '')
             plural = 's' if task.num_nodes > 1 else ''
             logger.info(
                 f'{colorama.Style.BRIGHT}Considered resources {task_str}'
                 f'({task.num_nodes} node{plural}):'
                 f'{colorama.Style.RESET_ALL}')
 
             # Only print 1 row per cloud.
```

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/provision/__init__.py` & `skypilot_nightly-1.0.0.dev20240505/sky/provision/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/provision/aws/__init__.py` & `skypilot_nightly-1.0.0.dev20240505/sky/provision/aws/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/provision/aws/config.py` & `skypilot_nightly-1.0.0.dev20240505/sky/provision/aws/config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/provision/aws/instance.py` & `skypilot_nightly-1.0.0.dev20240505/sky/provision/aws/instance.py`

 * *Files 1% similar despite different names*

```diff
@@ -57,34 +57,34 @@
 #  costs $0.01/GB:
 # https://aws.amazon.com/ec2/pricing/on-demand/#Data_Transfer_within_the_same_AWS_Region
 
 
 def _default_ec2_resource(region: str) -> Any:
     if not hasattr(aws, 'version'):
         # For backward compatibility, reload the module if the aws module was
-        # imported before and stale. Used for, e.g., a live spot controller
+        # imported before and stale. Used for, e.g., a live jobs controller
         # running an older version and a new version gets installed by
-        # `sky spot launch`.
+        # `sky jobs launch`.
         #
         # Detailed explanation follows. Assume we're in this situation: an old
-        # spot controller running a spot job and then the code gets updated on
-        # the controller due to a new `sky spot launch` or `sky start`.
+        # jobs controller running a managed job and then the code gets updated
+        # on the controller due to a new `sky jobs launch or `sky start`.
         #
-        # First, controller consists of an outer process (sky.spot.controller's
+        # First, controller consists of an outer process (sky.jobs.controller's
         # main) and an inner process running the controller logic (started as a
-        # multiprocessing.Process in sky.spot.controller). `sky.provision.aws`
+        # multiprocessing.Process in sky.jobs.controller). `sky.provision.aws`
         # is only imported in the inner process due to its load-on-use
         # semantics.
         #
         # At this point in the normal execution, inner process has loaded
         # {old sky.provision.aws, old sky.adaptors.aws}, and outer process has
         # loaded {old sky.adaptors.aws}.
         #
-        # In controller.py's start(), the inner process may exit due to spot job
-        # exits or `sky spot cancel`, entering outer process'
+        # In controller.py's start(), the inner process may exit due to managed
+        # job exits or `sky jobs cancel`, entering outer process'
         # `finally: ... _cleanup()` path. Inside _cleanup(), we eventually call
         # into `sky.provision.aws` which loads this module for the first time
         # for the outer process. At this point, outer process has loaded
         # {old sky.adaptors.aws, new sky.provision.aws}.
         #
         # This version mismatch becomes a "backward compatibility" problem if
         # `new sky.provision.aws` depends on `new sky.adaptors.aws` (assuming
```

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/provision/aws/utils.py` & `skypilot_nightly-1.0.0.dev20240505/sky/provision/aws/utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/provision/azure/instance.py` & `skypilot_nightly-1.0.0.dev20240505/sky/provision/azure/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/provision/common.py` & `skypilot_nightly-1.0.0.dev20240505/sky/provision/common.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/provision/cudo/__init__.py` & `skypilot_nightly-1.0.0.dev20240505/sky/provision/cudo/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/provision/cudo/cudo_machine_type.py` & `skypilot_nightly-1.0.0.dev20240505/sky/provision/cudo/cudo_machine_type.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/provision/cudo/cudo_wrapper.py` & `skypilot_nightly-1.0.0.dev20240505/sky/provision/cudo/cudo_wrapper.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/provision/cudo/instance.py` & `skypilot_nightly-1.0.0.dev20240505/sky/provision/cudo/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/provision/docker_utils.py` & `skypilot_nightly-1.0.0.dev20240505/sky/provision/docker_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/provision/fluidstack/__init__.py` & `skypilot_nightly-1.0.0.dev20240505/sky/provision/fluidstack/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/provision/fluidstack/fluidstack_utils.py` & `skypilot_nightly-1.0.0.dev20240505/sky/provision/fluidstack/fluidstack_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/provision/fluidstack/instance.py` & `skypilot_nightly-1.0.0.dev20240505/sky/provision/fluidstack/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/provision/gcp/__init__.py` & `skypilot_nightly-1.0.0.dev20240505/sky/provision/gcp/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/provision/gcp/config.py` & `skypilot_nightly-1.0.0.dev20240505/sky/provision/gcp/config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/provision/gcp/constants.py` & `skypilot_nightly-1.0.0.dev20240505/sky/provision/gcp/constants.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/provision/gcp/instance.py` & `skypilot_nightly-1.0.0.dev20240505/sky/provision/gcp/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/provision/gcp/instance_utils.py` & `skypilot_nightly-1.0.0.dev20240505/sky/provision/gcp/instance_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/provision/instance_setup.py` & `skypilot_nightly-1.0.0.dev20240505/sky/provision/instance_setup.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/provision/kubernetes/__init__.py` & `skypilot_nightly-1.0.0.dev20240505/sky/provision/kubernetes/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/provision/kubernetes/config.py` & `skypilot_nightly-1.0.0.dev20240505/sky/provision/kubernetes/config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/provision/kubernetes/instance.py` & `skypilot_nightly-1.0.0.dev20240505/sky/provision/kubernetes/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/provision/kubernetes/manifests/smarter-device-manager-daemonset.yaml` & `skypilot_nightly-1.0.0.dev20240505/sky/provision/kubernetes/manifests/smarter-device-manager-daemonset.yaml`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/provision/kubernetes/network.py` & `skypilot_nightly-1.0.0.dev20240505/sky/provision/kubernetes/network.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/provision/kubernetes/network_utils.py` & `skypilot_nightly-1.0.0.dev20240505/sky/provision/kubernetes/network_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/provision/kubernetes/utils.py` & `skypilot_nightly-1.0.0.dev20240505/sky/provision/kubernetes/utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/provision/logging.py` & `skypilot_nightly-1.0.0.dev20240505/sky/provision/logging.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/provision/metadata_utils.py` & `skypilot_nightly-1.0.0.dev20240505/sky/provision/metadata_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/provision/paperspace/__init__.py` & `skypilot_nightly-1.0.0.dev20240505/sky/provision/paperspace/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/provision/paperspace/config.py` & `skypilot_nightly-1.0.0.dev20240505/sky/provision/paperspace/config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/provision/paperspace/constants.py` & `skypilot_nightly-1.0.0.dev20240505/sky/provision/paperspace/constants.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/provision/paperspace/instance.py` & `skypilot_nightly-1.0.0.dev20240505/sky/provision/paperspace/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/provision/paperspace/utils.py` & `skypilot_nightly-1.0.0.dev20240505/sky/provision/paperspace/utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/provision/provisioner.py` & `skypilot_nightly-1.0.0.dev20240505/sky/provision/provisioner.py`

 * *Files 0% similar despite different names*

```diff
@@ -478,15 +478,15 @@
 
             cluster_info.docker_user = docker_user
             ssh_credentials['docker_user'] = docker_user
             logger.debug(f'Docker user: {docker_user}')
 
         # We mount the metadata with sky wheel for speedup.
         # NOTE: currently we mount all credentials for all nodes, because
-        # (1) spot controllers need permission to launch/down nodes of
+        # (1) jobs controllers need permission to launch/down nodes of
         #     multiple clouds
         # (2) head instances need permission for auto stop or auto down
         #     nodes for the current cloud
         # (3) all instances need permission to mount storage for all clouds
         # It is possible to have a "smaller" permission model, but we leave that
         # for later.
         file_mounts = config_from_yaml.get('file_mounts', {})
```

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/provision/runpod/instance.py` & `skypilot_nightly-1.0.0.dev20240505/sky/provision/runpod/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/provision/runpod/utils.py` & `skypilot_nightly-1.0.0.dev20240505/sky/provision/runpod/utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/provision/vsphere/__init__.py` & `skypilot_nightly-1.0.0.dev20240505/sky/provision/vsphere/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/provision/vsphere/common/cls_api_client.py` & `skypilot_nightly-1.0.0.dev20240505/sky/provision/vsphere/common/cls_api_client.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/provision/vsphere/common/cls_api_helper.py` & `skypilot_nightly-1.0.0.dev20240505/sky/provision/vsphere/common/cls_api_helper.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/provision/vsphere/common/metadata_utils.py` & `skypilot_nightly-1.0.0.dev20240505/sky/provision/vsphere/common/metadata_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/provision/vsphere/common/service_manager.py` & `skypilot_nightly-1.0.0.dev20240505/sky/provision/vsphere/common/service_manager.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/provision/vsphere/common/service_manager_factory.py` & `skypilot_nightly-1.0.0.dev20240505/sky/provision/vsphere/common/service_manager_factory.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/provision/vsphere/common/ssl_helper.py` & `skypilot_nightly-1.0.0.dev20240505/sky/provision/vsphere/common/ssl_helper.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/provision/vsphere/common/vapiconnect.py` & `skypilot_nightly-1.0.0.dev20240505/sky/provision/vsphere/common/vapiconnect.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/provision/vsphere/common/vim_utils.py` & `skypilot_nightly-1.0.0.dev20240505/sky/provision/vsphere/common/vim_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/provision/vsphere/instance.py` & `skypilot_nightly-1.0.0.dev20240505/sky/provision/vsphere/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/provision/vsphere/vsphere_utils.py` & `skypilot_nightly-1.0.0.dev20240505/sky/provision/vsphere/vsphere_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/resources.py` & `skypilot_nightly-1.0.0.dev20240505/sky/resources.py`

 * *Files 2% similar despite different names*

```diff
@@ -5,17 +5,17 @@
 from typing import Any, Dict, List, Optional, Set, Tuple, Union
 
 import colorama
 
 from sky import check as sky_check
 from sky import clouds
 from sky import exceptions
+from sky import jobs as managed_jobs
 from sky import sky_logging
 from sky import skypilot_config
-from sky import spot
 from sky.clouds import service_catalog
 from sky.provision import docker_utils
 from sky.skylet import constants
 from sky.utils import accelerator_registry
 from sky.utils import common_utils
 from sky.utils import log_utils
 from sky.utils import resources_utils
@@ -40,26 +40,26 @@
     * as a "filter" to get concrete launchable instances
     * for calculating billing
     * for provisioning on a cloud
 
     """
     # If any fields changed, increment the version. For backward compatibility,
     # modify the __setstate__ method to handle the old version.
-    _VERSION = 17
+    _VERSION = 18
 
     def __init__(
         self,
         cloud: Optional[clouds.Cloud] = None,
         instance_type: Optional[str] = None,
         cpus: Union[None, int, float, str] = None,
         memory: Union[None, int, float, str] = None,
         accelerators: Union[None, str, Dict[str, int]] = None,
         accelerator_args: Optional[Dict[str, str]] = None,
         use_spot: Optional[bool] = None,
-        spot_recovery: Optional[str] = None,
+        job_recovery: Optional[str] = None,
         region: Optional[str] = None,
         zone: Optional[str] = None,
         image_id: Union[Dict[str, str], str, None] = None,
         disk_size: Optional[int] = None,
         disk_tier: Optional[Union[str, resources_utils.DiskTier]] = None,
         ports: Optional[Union[int, str, List[str], Tuple[str]]] = None,
         labels: Optional[Dict[str, str]] = None,
@@ -102,17 +102,17 @@
             a string of the form ``'V100'`` or ``'V100:2'``, where the ``:2``
             indicates that the task requires 2 V100 GPUs. If a dict, must be a
             dict of the form ``{'V100': 2}`` or ``{'tpu-v2-8': 1}``.
           accelerator_args: accelerator-specific arguments. For example,
             ``{'tpu_vm': True, 'runtime_version': 'tpu-vm-base'}`` for TPUs.
           use_spot: whether to use spot instances. If None, defaults to
             False.
-          spot_recovery: the spot recovery strategy to use for the managed
-            spot to recover the cluster from preemption. Refer to
-            `recovery_strategy module <https://github.com/skypilot-org/skypilot/blob/master/sky/spot/recovery_strategy.py>`__ # pylint: disable=line-too-long
+          job_recovery: the job recovery strategy to use for the managed
+            job to recover the cluster from preemption. Refer to
+            `recovery_strategy module <https://github.com/skypilot-org/skypilot/blob/master/sky/jobs/recovery_strategy.py>`__ # pylint: disable=line-too-long
             for more details.
           region: the region to use.
           zone: the zone to use.
           image_id: the image ID to use. If a str, must be a string
             of the image id from the cloud, such as AWS:
             ``'ami-1234567890abcdef0'``, GCP:
             ``'projects/my-project-id/global/images/my-image-name'``;
@@ -156,18 +156,18 @@
         self._zone: Optional[str] = None
         self._validate_and_set_region_zone(region, zone)
 
         self._instance_type = instance_type
 
         self._use_spot_specified = use_spot is not None
         self._use_spot = use_spot if use_spot is not None else False
-        self._spot_recovery = None
-        if spot_recovery is not None:
-            if spot_recovery.strip().lower() != 'none':
-                self._spot_recovery = spot_recovery.upper()
+        self._job_recovery = None
+        if job_recovery is not None:
+            if job_recovery.strip().lower() != 'none':
+                self._job_recovery = job_recovery.upper()
 
         if disk_size is not None:
             if round(disk_size) != disk_size:
                 with ux_utils.print_exception_no_traceback():
                     raise ValueError(
                         f'OS disk size must be an integer. Got: {disk_size}.')
             self._disk_size = int(disk_size)
@@ -220,15 +220,15 @@
 
         self._set_cpus(cpus)
         self._set_memory(memory)
         self._set_accelerators(accelerators, accelerator_args)
 
         self._try_validate_instance_type()
         self._try_validate_cpus_mem()
-        self._try_validate_spot()
+        self._try_validate_managed_job_attributes()
         self._try_validate_image_id()
         self._try_validate_disk_tier()
         self._try_validate_ports()
         self._try_validate_labels()
 
     # When querying the accelerators inside this func (we call self.accelerators
     # which is a @property), we will check the cloud's catalog, which can error
@@ -264,16 +264,16 @@
         accelerator_args = ''
         if self.accelerators is not None:
             accelerators = f', {self.accelerators}'
             if self.accelerator_args is not None:
                 accelerator_args = f', accelerator_args={self.accelerator_args}'
 
         cpus = ''
-        if self.cpus is not None:
-            cpus = f', cpus={self.cpus}'
+        if self._cpus is not None:
+            cpus = f', cpus={self._cpus}'
 
         memory = ''
         if self.memory is not None:
             memory = f', mem={self.memory}'
 
         use_spot = ''
         if self.use_spot:
@@ -349,25 +349,32 @@
         return self._zone
 
     @property
     def instance_type(self):
         return self._instance_type
 
     @property
+    @functools.lru_cache(maxsize=1)
     def cpus(self) -> Optional[str]:
         """Returns the number of vCPUs that each instance must have.
 
         For example, cpus='4' means each instance must have exactly 4 vCPUs,
         and cpus='4+' means each instance must have at least 4 vCPUs.
 
         (Developer note: The cpus field is only used to select the instance type
         at launch time. Thus, Resources in the backend's ResourceHandle will
         always have the cpus field set to None.)
         """
-        return self._cpus
+        if self._cpus is not None:
+            return self._cpus
+        if self.cloud is not None and self._instance_type is not None:
+            vcpus, _ = self.cloud.get_vcpus_mem_from_instance_type(
+                self._instance_type)
+            return str(vcpus)
+        return None
 
     @property
     def memory(self) -> Optional[str]:
         """Returns the memory that each instance must have in GB.
 
         For example, memory='16' means each instance must have exactly 16GB
         memory; memory='16+' means each instance must have at least 16GB
@@ -404,16 +411,16 @@
         return self._use_spot
 
     @property
     def use_spot_specified(self) -> bool:
         return self._use_spot_specified
 
     @property
-    def spot_recovery(self) -> Optional[str]:
-        return self._spot_recovery
+    def job_recovery(self) -> Optional[str]:
+        return self._job_recovery
 
     @property
     def disk_size(self) -> int:
         return self._disk_size
 
     @property
     def image_id(self) -> Optional[Dict[str, str]]:
@@ -483,15 +490,15 @@
             self._memory = None
             return
 
         self._memory = str(memory)
         if isinstance(memory, str):
             if memory.endswith(('+', 'x')):
                 # 'x' is used internally for make sure our resources used by
-                # spot controller (memory: 3x) to have enough memory based on
+                # jobs controller (memory: 3x) to have enough memory based on
                 # the vCPUs.
                 num_memory_gb = memory[:-1]
             else:
                 num_memory_gb = memory
 
             try:
                 memory_gb = float(num_memory_gb)
@@ -572,18 +579,18 @@
 
         self._accelerators = accelerators
         self._accelerator_args = accelerator_args
 
     def is_launchable(self) -> bool:
         return self.cloud is not None and self._instance_type is not None
 
-    def need_cleanup_after_preemption(self) -> bool:
-        """Returns whether a spot resource needs cleanup after preemption."""
+    def need_cleanup_after_preemption_or_failure(self) -> bool:
+        """Whether a resource needs cleanup after preemption or failure."""
         assert self.is_launchable(), self
-        return self.cloud.need_cleanup_after_preemption(self)
+        return self.cloud.need_cleanup_after_preemption_or_failure(self)
 
     def _validate_and_set_region_zone(self, region: Optional[str],
                                       zone: Optional[str]) -> None:
         """Try to validate and set the region and zone attribute.
 
         Raises:
             ValueError: if the attributes are invalid.
@@ -741,38 +748,38 @@
 
     def _try_validate_cpus_mem(self) -> None:
         """Try to validate the cpus and memory attributes.
 
         Raises:
             ValueError: if the attributes are invalid.
         """
-        if self.cpus is None and self.memory is None:
+        if self._cpus is None and self._memory is None:
             return
-        if self.instance_type is not None:
+        if self._instance_type is not None:
             # The assertion should be true because we have already executed
             # _try_validate_instance_type() before this method.
             # The _try_validate_instance_type() method infers and sets
             # self.cloud if self.instance_type is not None.
             assert self.cloud is not None
             cpus, mem = self.cloud.get_vcpus_mem_from_instance_type(
-                self.instance_type)
-            if self.cpus is not None:
-                if self.cpus.endswith('+'):
-                    if cpus < float(self.cpus[:-1]):
+                self._instance_type)
+            if self._cpus is not None:
+                if self._cpus.endswith('+'):
+                    if cpus < float(self._cpus[:-1]):
                         with ux_utils.print_exception_no_traceback():
                             raise ValueError(
                                 f'{self.instance_type} does not have enough '
                                 f'vCPUs. {self.instance_type} has {cpus} '
-                                f'vCPUs, but {self.cpus} is requested.')
-                elif cpus != float(self.cpus):
+                                f'vCPUs, but {self._cpus} is requested.')
+                elif cpus != float(self._cpus):
                     with ux_utils.print_exception_no_traceback():
                         raise ValueError(
                             f'{self.instance_type} does not have the requested '
                             f'number of vCPUs. {self.instance_type} has {cpus} '
-                            f'vCPUs, but {self.cpus} is requested.')
+                            f'vCPUs, but {self._cpus} is requested.')
             if self.memory is not None:
                 if self.memory.endswith(('+', 'x')):
                     if mem < float(self.memory[:-1]):
                         with ux_utils.print_exception_no_traceback():
                             raise ValueError(
                                 f'{self.instance_type} does not have enough '
                                 f'memory. {self.instance_type} has {mem} GB '
@@ -780,33 +787,28 @@
                 elif mem != float(self.memory):
                     with ux_utils.print_exception_no_traceback():
                         raise ValueError(
                             f'{self.instance_type} does not have the requested '
                             f'memory. {self.instance_type} has {mem} GB '
                             f'memory, but {self.memory} is requested.')
 
-    def _try_validate_spot(self) -> None:
-        """Try to validate the spot related attributes.
+    def _try_validate_managed_job_attributes(self) -> None:
+        """Try to validate managed job related attributes.
 
         Raises:
             ValueError: if the attributes are invalid.
         """
-        if self._spot_recovery is None:
+        if self._job_recovery is None:
             return
-        if not self._use_spot:
-            with ux_utils.print_exception_no_traceback():
-                raise ValueError(
-                    'Cannot specify spot_recovery without use_spot set to True.'
-                )
-        if self._spot_recovery not in spot.SPOT_STRATEGIES:
+        if self._job_recovery not in managed_jobs.RECOVERY_STRATEGIES:
             with ux_utils.print_exception_no_traceback():
                 raise ValueError(
-                    f'Spot recovery strategy {self._spot_recovery} '
+                    f'Spot recovery strategy {self._job_recovery} '
                     'is not supported. The strategy should be among '
-                    f'{list(spot.SPOT_STRATEGIES.keys())}')
+                    f'{list(managed_jobs.RECOVERY_STRATEGIES.keys())}')
 
     def extract_docker_image(self) -> Optional[str]:
         if self.image_id is None:
             return None
         if len(self.image_id) == 1 and self.region in self.image_id:
             image_id = self.image_id[self.region]
             if image_id.startswith('docker:'):
@@ -1165,15 +1167,15 @@
         return is_matched
 
     def is_empty(self) -> bool:
         """Is this Resources an empty request (all fields None)?"""
         return all([
             self.cloud is None,
             self._instance_type is None,
-            self.cpus is None,
+            self._cpus is None,
             self.memory is None,
             self.accelerators is None,
             self.accelerator_args is None,
             not self._use_spot_specified,
             self.disk_size == _DEFAULT_DISK_SIZE_GB,
             self.disk_tier is None,
             self._image_id is None,
@@ -1183,21 +1185,21 @@
 
     def copy(self, **override) -> 'Resources':
         """Returns a copy of the given Resources."""
         use_spot = self.use_spot if self._use_spot_specified else None
         resources = Resources(
             cloud=override.pop('cloud', self.cloud),
             instance_type=override.pop('instance_type', self.instance_type),
-            cpus=override.pop('cpus', self.cpus),
+            cpus=override.pop('cpus', self._cpus),
             memory=override.pop('memory', self.memory),
             accelerators=override.pop('accelerators', self.accelerators),
             accelerator_args=override.pop('accelerator_args',
                                           self.accelerator_args),
             use_spot=override.pop('use_spot', use_spot),
-            spot_recovery=override.pop('spot_recovery', self.spot_recovery),
+            job_recovery=override.pop('job_recovery', self.job_recovery),
             disk_size=override.pop('disk_size', self.disk_size),
             region=override.pop('region', self.region),
             zone=override.pop('zone', self.zone),
             image_id=override.pop('image_id', self.image_id),
             disk_tier=override.pop('disk_tier', self.disk_tier),
             ports=override.pop('ports', self.ports),
             labels=override.pop('labels', self.labels),
@@ -1340,15 +1342,23 @@
         resources_fields['instance_type'] = config.pop('instance_type', None)
         resources_fields['cpus'] = config.pop('cpus', None)
         resources_fields['memory'] = config.pop('memory', None)
         resources_fields['accelerators'] = config.pop('accelerators', None)
         resources_fields['accelerator_args'] = config.pop(
             'accelerator_args', None)
         resources_fields['use_spot'] = config.pop('use_spot', None)
-        resources_fields['spot_recovery'] = config.pop('spot_recovery', None)
+        if config.get('spot_recovery') is not None:
+            logger.warning('spot_recovery is deprecated. Use job_recovery '
+                           'instead (the system is defaulting to that for '
+                           'you).')
+            resources_fields['job_recovery'] = config.pop('spot_recovery', None)
+        else:
+            # spot_recovery and job_recovery are guaranteed to be mutually
+            # exclusive by the schema validation.
+            resources_fields['job_recovery'] = config.pop('job_recovery', None)
         resources_fields['disk_size'] = config.pop('disk_size', None)
         resources_fields['region'] = config.pop('region', None)
         resources_fields['zone'] = config.pop('zone', None)
         resources_fields['image_id'] = config.pop('image_id', None)
         resources_fields['disk_tier'] = config.pop('disk_tier', None)
         resources_fields['ports'] = config.pop('ports', None)
         resources_fields['labels'] = config.pop('labels', None)
@@ -1377,22 +1387,22 @@
 
         def add_if_not_none(key, value):
             if value is not None and value != 'None':
                 config[key] = value
 
         add_if_not_none('cloud', str(self.cloud))
         add_if_not_none('instance_type', self.instance_type)
-        add_if_not_none('cpus', self.cpus)
+        add_if_not_none('cpus', self._cpus)
         add_if_not_none('memory', self.memory)
         add_if_not_none('accelerators', self.accelerators)
         add_if_not_none('accelerator_args', self.accelerator_args)
 
         if self._use_spot_specified:
             add_if_not_none('use_spot', self.use_spot)
-            add_if_not_none('spot_recovery', self.spot_recovery)
+        add_if_not_none('job_recovery', self.job_recovery)
         add_if_not_none('disk_size', self.disk_size)
         add_if_not_none('region', self.region)
         add_if_not_none('zone', self.zone)
         add_if_not_none('image_id', self.image_id)
         if self.disk_tier is not None:
             config['disk_tier'] = self.disk_tier.value
         add_if_not_none('ports', self.ports)
@@ -1431,14 +1441,16 @@
 
             disk_size = state.pop('disk_size', _DEFAULT_DISK_SIZE_GB)
             state['_disk_size'] = disk_size
 
         if version < 2:
             self._region = None
 
+        # spot_recovery is deprecated. We keep the history just for readability,
+        # it should be removed by chunk in the future.
         if version < 3:
             self._spot_recovery = None
 
         if version < 4:
             self._image_id = None
 
         if version < 5:
@@ -1506,8 +1518,11 @@
             # mode and have FUSE support enabled by default. As a result, we
             # set the default to True for backward compatibility.
             state['_requires_fuse'] = state.get('_requires_fuse', True)
 
         if version < 17:
             state['_labels'] = state.get('_labels', None)
 
+        if version < 18:
+            self._job_recovery = state.pop('_spot_recovery', None)
+
         self.__dict__.update(state)
```

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/serve/__init__.py` & `skypilot_nightly-1.0.0.dev20240505/sky/serve/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/serve/autoscalers.py` & `skypilot_nightly-1.0.0.dev20240505/sky/serve/autoscalers.py`

 * *Files 1% similar despite different names*

```diff
@@ -510,15 +510,15 @@
         # Assert: Either dynamic_ondemand_fallback is set
         # or base_ondemand_fallback_replicas is greater than 0.
         assert spec.use_ondemand_fallback
         self.dynamic_ondemand_fallback = (spec.dynamic_ondemand_fallback
                                           if spec.dynamic_ondemand_fallback
                                           is not None else False)
 
-    # spot_recovery field is checked earlier in core
+    # job_recovery field is checked earlier in core
     def _get_spot_resources_override_dict(self) -> Dict[str, Any]:
         return {'use_spot': True}
 
     def _get_ondemand_resources_override_dict(self) -> Dict[str, Any]:
         return {'use_spot': False}
 
     def evaluate_scaling(
```

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/serve/constants.py` & `skypilot_nightly-1.0.0.dev20240505/sky/serve/constants.py`

 * *Files 8% similar despite different names*

```diff
@@ -49,17 +49,17 @@
 # The default controller resources. We need 200 GB disk space to enable using
 # Azure as controller, since its default image size is 150 GB.
 # TODO(tian): We might need to be careful that service logs can take a lot of
 # disk space. Maybe we could use a larger disk size, migrate to cloud storage or
 # do some log rotation.
 CONTROLLER_RESOURCES = {'cpus': '4+', 'disk_size': 200}
 
-# Due to the CPU/memory usage of the controller process launched with sky job (
-# use ray job under the hood), we need to reserve some CPU/memory for each serve
-# controller process.
+# Due to the CPU/memory usage of the controller process launched with a job on
+# controller VM (use ray job under the hood), we need to reserve some CPU/memory
+# for each serve controller process.
 # Serve: A default controller with 4 vCPU and 16 GB memory can run up to 16
 # services.
 CONTROLLER_MEMORY_USAGE_GB = 1.0
 
 # A period of time to initialize your service. Any readiness probe failures
 # during this period will be ignored.
 DEFAULT_INITIAL_DELAY_SECONDS = 1200
```

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/serve/controller.py` & `skypilot_nightly-1.0.0.dev20240505/sky/serve/controller.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/serve/core.py` & `skypilot_nightly-1.0.0.dev20240505/sky/serve/core.py`

 * *Files 1% similar despite different names*

```diff
@@ -53,17 +53,17 @@
     if task.service is None:
         with ux_utils.print_exception_no_traceback():
             raise RuntimeError('Service section not found.')
 
     policy_description = ('on-demand'
                           if task.service.dynamic_ondemand_fallback else 'spot')
     for resource in list(task.resources):
-        if resource.spot_recovery is not None:
+        if resource.job_recovery is not None:
             with ux_utils.print_exception_no_traceback():
-                raise ValueError('spot_recovery is disabled for SkyServe. '
+                raise ValueError('job_recovery is disabled for SkyServe. '
                                  'SkyServe will replenish preempted spot '
                                  f'with {policy_description} instances.')
 
     replica_ingress_port: Optional[int] = None
     for requested_resources in task.resources:
         if (task.service.use_ondemand_fallback and
                 not requested_resources.use_spot):
@@ -135,26 +135,27 @@
         remote_tmp_task_yaml_path = (
             serve_utils.generate_remote_tmp_task_yaml_file_name(service_name))
         remote_config_yaml_path = (
             serve_utils.generate_remote_config_yaml_file_name(service_name))
         controller_log_file = (
             serve_utils.generate_remote_controller_log_file_name(service_name))
         controller_resources = controller_utils.get_controller_resources(
-            controller_type='serve', task_resources=task.resources)
+            controller=controller_utils.Controllers.SKY_SERVE_CONTROLLER,
+            task_resources=task.resources)
 
         vars_to_fill = {
             'remote_task_yaml_path': remote_tmp_task_yaml_path,
             'local_task_yaml_path': service_file.name,
             'service_name': service_name,
             'controller_log_file': controller_log_file,
             'remote_user_config_path': remote_config_yaml_path,
             'modified_catalogs':
                 service_catalog_common.get_modified_catalog_file_mounts(),
             **controller_utils.shared_controller_vars_to_fill(
-                'serve',
+                controller=controller_utils.Controllers.SKY_SERVE_CONTROLLER,
                 remote_user_config_path=remote_config_yaml_path,
             ),
         }
         common_utils.fill_template(serve_constants.CONTROLLER_TEMPLATE,
                                    vars_to_fill,
                                    output_path=controller_file.name)
         controller_task = task_lib.Task.from_yaml(controller_file.name)
@@ -300,15 +301,15 @@
 
     Args:
         task: sky.Task to update.
         service_name: Name of the service.
     """
     _validate_service_task(task)
     handle = backend_utils.is_controller_accessible(
-        controller_type=controller_utils.Controllers.SKY_SERVE_CONTROLLER,
+        controller=controller_utils.Controllers.SKY_SERVE_CONTROLLER,
         stopped_message=
         'Service controller is stopped. There is no service to update. '
         f'To spin up a new service, use {backend_utils.BOLD}'
         f'sky serve up{backend_utils.RESET_BOLD}',
         non_existent_message='Service does not exist. '
         'To spin up a new service, '
         f'use {backend_utils.BOLD}sky serve up{backend_utils.RESET_BOLD}',
@@ -444,15 +445,15 @@
         RuntimeError: if failed to terminate the service.
     """
     if service_names is None:
         service_names = []
     if isinstance(service_names, str):
         service_names = [service_names]
     handle = backend_utils.is_controller_accessible(
-        controller_type=controller_utils.Controllers.SKY_SERVE_CONTROLLER,
+        controller=controller_utils.Controllers.SKY_SERVE_CONTROLLER,
         stopped_message='All services should have terminated.')
 
     service_names_str = ','.join(service_names)
     if sum([len(service_names) > 0, all]) != 1:
         argument_str = f'service_names={service_names_str}' if len(
             service_names) > 0 else ''
         argument_str += ' all' if all else ''
@@ -551,15 +552,15 @@
     except exceptions.NetworkError as e:
         with ux_utils.print_exception_no_traceback():
             raise RuntimeError(
                 'Failed to refresh service status due to network error.') from e
 
     controller_type = controller_utils.Controllers.SKY_SERVE_CONTROLLER
     handle = backend_utils.is_controller_accessible(
-        controller_type=controller_type,
+        controller=controller_type,
         stopped_message=controller_type.value.default_hint_if_non_existent)
 
     backend = backend_utils.get_backend_from_handle(handle)
     assert isinstance(backend, backends.CloudVmRayBackend)
 
     code = serve_utils.ServeCodeGen.get_service_status(service_names)
     returncode, serve_status_payload, stderr = backend.run_on_head(
@@ -635,15 +636,15 @@
                     '`replica_id` must be specified when using target=REPLICA.')
     else:
         if replica_id is not None:
             with ux_utils.print_exception_no_traceback():
                 raise ValueError('`replica_id` must be None when using '
                                  'target=CONTROLLER/LOAD_BALANCER.')
     handle = backend_utils.is_controller_accessible(
-        controller_type=controller_utils.Controllers.SKY_SERVE_CONTROLLER,
+        controller=controller_utils.Controllers.SKY_SERVE_CONTROLLER,
         stopped_message=(controller_utils.Controllers.SKY_SERVE_CONTROLLER.
                          value.default_hint_if_non_existent))
 
     backend = backend_utils.get_backend_from_handle(handle)
     assert isinstance(backend, backends.CloudVmRayBackend), backend
     backend.tail_serve_logs(handle,
                             service_name,
```

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/serve/load_balancer.py` & `skypilot_nightly-1.0.0.dev20240505/sky/serve/load_balancer.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/serve/load_balancing_policies.py` & `skypilot_nightly-1.0.0.dev20240505/sky/serve/load_balancing_policies.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/serve/replica_managers.py` & `skypilot_nightly-1.0.0.dev20240505/sky/serve/replica_managers.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/serve/serve_state.py` & `skypilot_nightly-1.0.0.dev20240505/sky/serve/serve_state.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/serve/serve_utils.py` & `skypilot_nightly-1.0.0.dev20240505/sky/serve/serve_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/serve/service.py` & `skypilot_nightly-1.0.0.dev20240505/sky/serve/service.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/serve/service_spec.py` & `skypilot_nightly-1.0.0.dev20240505/sky/serve/service_spec.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/setup_files/MANIFEST.in` & `skypilot_nightly-1.0.0.dev20240505/sky/setup_files/MANIFEST.in`

 * *Files 2% similar despite different names*

```diff
@@ -9,12 +9,12 @@
 include sky/skylet/providers/ibm/*
 include sky/skylet/providers/kubernetes/*
 include sky/skylet/providers/lambda_cloud/*
 include sky/skylet/providers/oci/*
 include sky/skylet/providers/scp/*
 include sky/skylet/providers/*.py
 include sky/skylet/ray_patches/*.patch
-include sky/spot/dashboard/*
-include sky/spot/dashboard/templates/*
-include sky/spot/dashboard/static/*
+include sky/jobs/dashboard/*
+include sky/jobs/dashboard/templates/*
+include sky/jobs/dashboard/static/*
 include sky/templates/*
 include sky/utils/kubernetes/*
```

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/setup_files/setup.py` & `skypilot_nightly-1.0.0.dev20240505/sky/setup_files/setup.py`

 * *Files 0% similar despite different names*

```diff
@@ -186,15 +186,15 @@
     # https://github.com/ray-project/ray/blob/ray-2.9.3/python/setup.py#L343
     'protobuf >= 3.15.3, != 3.19.5',
     # Some pydantic versions are not compatible with ray. Adopted from ray's
     # setup.py: https://github.com/ray-project/ray/blob/ray-2.9.3/python/setup.py#L254
     'pydantic!=2.0.*,!=2.1.*,!=2.2.*,!=2.3.*,!=2.4.*,<3',
 ]
 
-# NOTE: Change the templates/spot-controller.yaml.j2 file if any of the
+# NOTE: Change the templates/jobs-controller.yaml.j2 file if any of the
 # following packages dependencies are changed.
 aws_dependencies = [
     # botocore does not work with urllib3>=2.0.0, according to https://github.com/boto/botocore/issues/2926
     # We have to explicitly pin the version to optimize the time for
     # poetry install. See https://github.com/orgs/python-poetry/discussions/7937
     'urllib3<2',
     # NOTE: this installs CLI V1. To use AWS SSO (e.g., `aws sso login`), users
```

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/sky_logging.py` & `skypilot_nightly-1.0.0.dev20240505/sky/sky_logging.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/skylet/LICENSE` & `skypilot_nightly-1.0.0.dev20240505/sky/skylet/LICENSE`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/skylet/attempt_skylet.py` & `skypilot_nightly-1.0.0.dev20240505/sky/skylet/attempt_skylet.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/skylet/autostop_lib.py` & `skypilot_nightly-1.0.0.dev20240505/sky/skylet/autostop_lib.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/skylet/configs.py` & `skypilot_nightly-1.0.0.dev20240505/sky/skylet/configs.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/skylet/constants.py` & `skypilot_nightly-1.0.0.dev20240505/sky/skylet/constants.py`

 * *Files 5% similar despite different names*

```diff
@@ -38,19 +38,19 @@
 SKY_PIP_CMD = f'{SKY_PYTHON_CMD} -m pip'
 # Ray executable, e.g., /opt/conda/bin/ray
 SKY_RAY_CMD = (f'$([ -s {SKY_RAY_PATH_FILE} ] && '
                f'cat {SKY_RAY_PATH_FILE} 2> /dev/null || which ray)')
 
 # The name for the environment variable that stores the unique ID of the
 # current task. This will stay the same across multiple recoveries of the
-# same spot task.
+# same managed task.
 TASK_ID_ENV_VAR = 'SKYPILOT_TASK_ID'
 # This environment variable stores a '\n'-separated list of task IDs that
-# are within the same spot job (DAG). This can be used by the user to
-# retrieve the task IDs of any tasks that are within the same spot job.
+# are within the same managed job (DAG). This can be used by the user to
+# retrieve the task IDs of any tasks that are within the same managed job.
 # This environment variable is pre-assigned before any task starts
 # running within the same job, and will remain constant throughout the
 # lifetime of the job.
 TASK_ID_LIST_ENV_VAR = 'SKYPILOT_TASK_IDS'
 
 # The version of skylet. MUST bump this version whenever we need the skylet to
 # be restarted on existing clusters updated with the new version of SkyPilot,
@@ -62,17 +62,17 @@
 SKYLET_VERSION = '8'
 # The version of the lib files that skylet/jobs use. Whenever there is an API
 # change for the job_lib or log_lib, we need to bump this version, so that the
 # user can be notified to update their SkyPilot version on the remote cluster.
 SKYLET_LIB_VERSION = 1
 SKYLET_VERSION_FILE = '~/.sky/skylet_version'
 
-# `sky spot dashboard`-related
+# `sky jobs dashboard`-related
 #
-# Port on the remote spot controller that the dashboard is running on.
+# Port on the remote jobs controller that the dashboard is running on.
 SPOT_DASHBOARD_REMOTE_PORT = 5000
 
 # Docker default options
 DEFAULT_DOCKER_CONTAINER_NAME = 'sky_container'
 DEFAULT_DOCKER_PORT = 10022
 DOCKER_USERNAME_ENV_VAR = 'SKYPILOT_DOCKER_USERNAME'
 DOCKER_PASSWORD_ENV_VAR = 'SKYPILOT_DOCKER_PASSWORD'
@@ -156,15 +156,15 @@
     # files.
     f'{SKY_PIP_CMD} list | grep "ray " | grep {SKY_REMOTE_RAY_VERSION} 2>&1 > /dev/null '
     f'&& {{ {SKY_PYTHON_CMD} -c "from sky.skylet.ray_patches import patch; patch()" '
     '|| exit 1; };')
 
 # The name for the environment variable that stores SkyPilot user hash, which
 # is mainly used to make sure sky commands runs on a VM launched by SkyPilot
-# will be recognized as the same user (e.g., spot controller or sky serve
+# will be recognized as the same user (e.g., jobs controller or sky serve
 # controller).
 USER_ID_ENV_VAR = 'SKYPILOT_USER_ID'
 
 # The name for the environment variable that stores SkyPilot user name.
 # Similar to USER_ID_ENV_VAR, this is mainly used to make sure sky commands
 # runs on a VM launched by SkyPilot will be recognized as the same user.
 USER_ENV_VAR = 'SKYPILOT_USER'
@@ -183,15 +183,15 @@
 FILE_MOUNTS_REMOTE_TMP_DIR = '/tmp/sky-{}-filemounts-files'
 
 # The default idle timeout for SkyPilot controllers. This include spot
 # controller and sky serve controller.
 # TODO(tian): Refactor to controller_utils. Current blocker: circular import.
 CONTROLLER_IDLE_MINUTES_TO_AUTOSTOP = 10
 
-# Due to the CPU/memory usage of the controller process launched with sky job (
-# use ray job under the hood), we need to reserve some CPU/memory for each spot/
+# Due to the CPU/memory usage of the controller process launched with sky jobs (
+# use ray job under the hood), we need to reserve some CPU/memory for each jobs/
 # serve controller process.
-# Spot: A default controller with 8 vCPU and 32 GB memory can manage up to 32
-# spot jobs.
+# Jobs: A default controller with 8 vCPU and 32 GB memory can manage up to 32
+# managed jobs.
 # Serve: A default controller with 4 vCPU and 16 GB memory can run up to 16
 # services.
 CONTROLLER_PROCESS_CPU_DEMAND = 0.25
```

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/skylet/events.py` & `skypilot_nightly-1.0.0.dev20240505/sky/skylet/events.py`

 * *Files 2% similar despite different names*

```diff
@@ -10,18 +10,18 @@
 import psutil
 import yaml
 
 from sky import clouds
 from sky import sky_logging
 from sky.backends import cloud_vm_ray_backend
 from sky.clouds import cloud_registry
+from sky.jobs import utils as managed_job_utils
 from sky.serve import serve_utils
 from sky.skylet import autostop_lib
 from sky.skylet import job_lib
-from sky.spot import spot_utils
 from sky.utils import cluster_yaml_utils
 from sky.utils import common_utils
 from sky.utils import ux_utils
 
 # Seconds of sleep between the processing of skylet events.
 EVENT_CHECKING_INTERVAL_SECONDS = 20
 logger = sky_logging.init_logger(__name__)
@@ -63,20 +63,20 @@
     """Skylet event for scheduling jobs"""
     EVENT_INTERVAL_SECONDS = 300
 
     def _run(self):
         job_lib.scheduler.schedule_step(force_update_jobs=True)
 
 
-class SpotJobUpdateEvent(SkyletEvent):
-    """Skylet event for updating spot job status."""
+class ManagedJobUpdateEvent(SkyletEvent):
+    """Skylet event for updating managed job status."""
     EVENT_INTERVAL_SECONDS = 300
 
     def _run(self):
-        spot_utils.update_spot_job_status()
+        managed_job_utils.update_managed_job_status()
 
 
 class ServiceUpdateEvent(SkyletEvent):
     """Skylet event for updating sky serve service status.
 
     This is needed to handle the case that controller process is somehow
     terminated and the service status is not updated.
```

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/skylet/job_lib.py` & `skypilot_nightly-1.0.0.dev20240505/sky/skylet/job_lib.py`

 * *Files 1% similar despite different names*

```diff
@@ -1,8 +1,8 @@
-"""Sky job lib, backed by a sqlite database.
+"""Utilities for jobs on a remote cluster, backed by a sqlite database.
 
 This is a remote utility module that provides job queue functionality.
 """
 import enum
 import getpass
 import json
 import os
@@ -388,23 +388,22 @@
     return None
 
 
 def get_job_submitted_or_ended_timestamp_payload(job_id: int,
                                                  get_ended_time: bool) -> str:
     """Get the job submitted/ended timestamp.
 
-    This function should only be called by the spot controller,
-    which is ok to use `submitted_at` instead of `start_at`,
-    because the spot job duration need to include both setup
-    and running time and the job will not stay in PENDING
-    state.
-
-    The normal job duration will use `start_at` instead of
-    `submitted_at` (in `format_job_queue()`), because the job
-    may stay in PENDING if the cluster is busy.
+    This function should only be called by the jobs controller, which is ok to
+    use `submitted_at` instead of `start_at`, because the managed job duration
+    need to include both setup and running time and the job will not stay in
+    PENDING state.
+
+    The normal job duration will use `start_at` instead of `submitted_at` (in
+    `format_job_queue()`), because the job may stay in PENDING if the cluster is
+    busy.
     """
     field = 'end_at' if get_ended_time else 'submitted_at'
     rows = _CURSOR.execute(f'SELECT {field} FROM jobs WHERE job_id=(?)',
                            (job_id,))
     for (timestamp,) in rows:
         return common_utils.encode_payload(timestamp)
     return common_utils.encode_payload(None)
@@ -876,23 +875,23 @@
         # Used only for restarting a cluster.
         code = ['job_lib.fail_all_jobs_in_progress()']
         return cls._build(code)
 
     @classmethod
     def tail_logs(cls,
                   job_id: Optional[int],
-                  spot_job_id: Optional[int],
+                  managed_job_id: Optional[int],
                   follow: bool = True) -> str:
         # pylint: disable=line-too-long
         code = [
             f'job_id = {job_id} if {job_id} is not None else job_lib.get_latest_job_id()',
             'run_timestamp = job_lib.get_run_timestamp(job_id)',
             f'log_dir = None if run_timestamp is None else os.path.join({constants.SKY_LOGS_DIRECTORY!r}, run_timestamp)',
             f'log_lib.tail_logs(job_id=job_id, log_dir=log_dir, '
-            f'spot_job_id={spot_job_id!r}, follow={follow}, **job_owner_kwargs)',
+            f'managed_job_id={managed_job_id!r}, follow={follow}, **job_owner_kwargs)',
         ]
         return cls._build(code)
 
     @classmethod
     def get_job_status(cls, job_ids: Optional[List[int]] = None) -> str:
         # Prints "Job <id> <status>" for UX; caller should parse the last token.
         code = [
```

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/skylet/log_lib.py` & `skypilot_nightly-1.0.0.dev20240505/sky/skylet/log_lib.py`

 * *Files 2% similar despite different names*

```diff
@@ -375,39 +375,40 @@
 
             time.sleep(_SKY_LOG_TAILING_GAP_SECONDS)
             status = job_lib.get_status_no_lock(job_id)
 
 
 def tail_logs(job_id: Optional[int],
               log_dir: Optional[str],
-              spot_job_id: Optional[int] = None,
+              managed_job_id: Optional[int] = None,
               follow: bool = True) -> None:
     """Tail the logs of a job.
 
     Args:
         job_id: The job id.
         log_dir: The log directory of the job.
-        spot_job_id: The spot job id (for logging info only to avoid confusion).
+        managed_job_id: The managed job id (for logging info only to avoid
+            confusion).
         follow: Whether to follow the logs or print the logs so far and exit.
     """
     if job_id is None:
         # This only happens when job_lib.get_latest_job_id() returns None,
         # which means no job has been submitted to this cluster. See
         # sky.skylet.job_lib.JobLibCodeGen.tail_logs for more details.
         logger.info('Skip streaming logs as no job has been submitted.')
         return
     job_str = f'job {job_id}'
-    if spot_job_id is not None:
-        job_str = f'spot job {spot_job_id}'
+    if managed_job_id is not None:
+        job_str = f'managed job {managed_job_id}'
     if log_dir is None:
         print(f'{job_str.capitalize()} not found (see `sky queue`).',
               file=sys.stderr)
         return
-    logger.debug(f'Tailing logs for job, real job_id {job_id}, spot_job_id '
-                 f'{spot_job_id}.')
+    logger.debug(f'Tailing logs for job, real job_id {job_id}, managed_job_id '
+                 f'{managed_job_id}.')
     logger.info(f'{colorama.Fore.YELLOW}Start streaming logs for {job_str}.'
                 f'{colorama.Style.RESET_ALL}')
     log_path = os.path.join(log_dir, 'run.log')
     log_path = os.path.expanduser(log_path)
 
     status = job_lib.update_job_status([job_id], silent=True)[0]
```

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/skylet/log_lib.pyi` & `skypilot_nightly-1.0.0.dev20240505/sky/skylet/log_lib.pyi`

 * *Files 4% similar despite different names*

```diff
@@ -116,10 +116,10 @@
                               stream_logs: bool = ...,
                               with_ray: bool = ...):
     ...
 
 
 def tail_logs(job_id: int,
               log_dir: Optional[str],
-              spot_job_id: Optional[int] = ...,
+              managed_job_id: Optional[int] = ...,
               follow: bool = ...) -> None:
     ...
```

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/skylet/providers/azure/azure-config-template.json` & `skypilot_nightly-1.0.0.dev20240505/sky/skylet/providers/azure/azure-config-template.json`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/skylet/providers/azure/azure-vm-template.json` & `skypilot_nightly-1.0.0.dev20240505/sky/skylet/providers/azure/azure-vm-template.json`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/skylet/providers/azure/config.py` & `skypilot_nightly-1.0.0.dev20240505/sky/skylet/providers/azure/config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/skylet/providers/azure/node_provider.py` & `skypilot_nightly-1.0.0.dev20240505/sky/skylet/providers/azure/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/skylet/providers/command_runner.py` & `skypilot_nightly-1.0.0.dev20240505/sky/skylet/providers/command_runner.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/skylet/providers/ibm/node_provider.py` & `skypilot_nightly-1.0.0.dev20240505/sky/skylet/providers/ibm/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/skylet/providers/ibm/utils.py` & `skypilot_nightly-1.0.0.dev20240505/sky/skylet/providers/ibm/utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/skylet/providers/ibm/vpc_provider.py` & `skypilot_nightly-1.0.0.dev20240505/sky/skylet/providers/ibm/vpc_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/skylet/providers/lambda_cloud/node_provider.py` & `skypilot_nightly-1.0.0.dev20240505/sky/skylet/providers/lambda_cloud/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/skylet/providers/oci/node_provider.py` & `skypilot_nightly-1.0.0.dev20240505/sky/skylet/providers/oci/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/skylet/providers/oci/query_helper.py` & `skypilot_nightly-1.0.0.dev20240505/sky/skylet/providers/oci/query_helper.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/skylet/providers/scp/config.py` & `skypilot_nightly-1.0.0.dev20240505/sky/skylet/providers/scp/config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/skylet/providers/scp/node_provider.py` & `skypilot_nightly-1.0.0.dev20240505/sky/skylet/providers/scp/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/skylet/ray_patches/__init__.py` & `skypilot_nightly-1.0.0.dev20240505/sky/skylet/ray_patches/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/skylet/ray_patches/log_monitor.py.patch` & `skypilot_nightly-1.0.0.dev20240505/sky/skylet/ray_patches/log_monitor.py.patch`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/skylet/ray_patches/resource_demand_scheduler.py.patch` & `skypilot_nightly-1.0.0.dev20240505/sky/skylet/ray_patches/resource_demand_scheduler.py.patch`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/skylet/ray_patches/worker.py.patch` & `skypilot_nightly-1.0.0.dev20240505/sky/skylet/ray_patches/worker.py.patch`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/skylet/skylet.py` & `skypilot_nightly-1.0.0.dev20240505/sky/skylet/skylet.py`

 * *Files 9% similar despite different names*

```diff
@@ -13,18 +13,18 @@
 logger = sky_logging.init_logger('sky.skylet.skylet')
 logger.info(f'Skylet started with version {constants.SKYLET_VERSION}; '
             f'SkyPilot v{sky.__version__} (commit: {sky.__commit__})')
 
 EVENTS = [
     events.AutostopEvent(),
     events.JobSchedulerEvent(),
-    # The spot job update event should be after the job update event.
-    # Otherwise, the abnormal spot job status update will be delayed
+    # The managed job update event should be after the job update event.
+    # Otherwise, the abnormal managed job status update will be delayed
     # until the next job update event.
-    events.SpotJobUpdateEvent(),
+    events.ManagedJobUpdateEvent(),
     # This is for monitoring controller job status. If it becomes
     # unhealthy, this event will correctly update the controller
     # status to CONTROLLER_FAILED.
     events.ServiceUpdateEvent(),
 ]
 
 while True:
```

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/skylet/subprocess_daemon.py` & `skypilot_nightly-1.0.0.dev20240505/sky/skylet/subprocess_daemon.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/skypilot_config.py` & `skypilot_nightly-1.0.0.dev20240505/sky/skypilot_config.py`

 * *Files 1% similar despite different names*

```diff
@@ -59,15 +59,15 @@
 #     path;
 # (2) If file {CONFIG_PATH} exists, use this file.
 #
 # If the path discovered by (1) fails to load, we do not attempt to go to step
 # 2 in the list.
 
 # (Used internally) An env var holding the path to the local config file. This
-# is only used by spot controller tasks to ensure recoveries of the same job
+# is only used by jobs controller tasks to ensure recoveries of the same job
 # use the same config file.
 ENV_VAR_SKYPILOT_CONFIG = 'SKYPILOT_CONFIG'
 
 # Path to the local config file.
 CONFIG_PATH = '~/.sky/config.yaml'
 
 logger = sky_logging.init_logger(__name__)
```

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/spot/constants.py` & `skypilot_nightly-1.0.0.dev20240505/sky/jobs/constants.py`

 * *Files 24% similar despite different names*

```diff
@@ -1,22 +1,27 @@
-"""Constants used for Managed Spot."""
+"""Constants used for Managed Jobs."""
 
-SPOT_CONTROLLER_TEMPLATE = 'spot-controller.yaml.j2'
-SPOT_CONTROLLER_YAML_PREFIX = '~/.sky/spot_controller'
+JOBS_CONTROLLER_TEMPLATE = 'jobs-controller.yaml.j2'
+JOBS_CONTROLLER_YAML_PREFIX = '~/.sky/jobs_controller'
 
-SPOT_TASK_YAML_PREFIX = '~/.sky/spot_tasks'
+JOBS_TASK_YAML_PREFIX = '~/.sky/managed_jobs'
 
-# Resources as a dict for the spot controller.
-# Use default CPU instance type for spot controller with >= 24GB, i.e.
+# Resources as a dict for the jobs controller.
+# Use default CPU instance type for jobs controller with >= 24GB, i.e.
 # m6i.2xlarge (8vCPUs, 32 GB) for AWS, Standard_D8s_v4 (8vCPUs, 32 GB)
 # for Azure, and n1-standard-8 (8 vCPUs, 32 GB) for GCP, etc.
 # Based on profiling, memory should be at least 3x (in GB) as num vCPUs to avoid
-# OOM (each vCPU can have 4 spot controller processes as we set the CPU
-# requirement to 0.25, and 3 GB is barely enough for 4 spot processes).
+# OOM (each vCPU can have 4 jobs controller processes as we set the CPU
+# requirement to 0.25, and 3 GB is barely enough for 4 job processes).
 # We use 50 GB disk size to reduce the cost.
 CONTROLLER_RESOURCES = {'cpus': '8+', 'memory': '3x', 'disk_size': 50}
 
 # Max length of the cluster name for GCP is 35, the user hash to be attached is
 # 4+1 chars, and we assume the maximum length of the job id is 4+1, so the max
 # length of the cluster name prefix is 25 to avoid the cluster name being too
 # long and truncated twice during the cluster creation.
-SPOT_CLUSTER_NAME_PREFIX_LENGTH = 25
+JOBS_CLUSTER_NAME_PREFIX_LENGTH = 25
+
+# The version of the lib files that jobs/utils use. Whenever there is an API
+# change for the jobs/utils, we need to bump this version and update
+# job.utils.ManagedJobCodeGen to handle the version update.
+MANAGED_JOBS_VERSION = 1
```

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/spot/controller.py` & `skypilot_nightly-1.0.0.dev20240505/sky/jobs/controller.py`

 * *Files 14% similar despite different names*

```diff
@@ -1,8 +1,8 @@
-"""Controller: handles the life cycle of a managed spot cluster (job)."""
+"""Controller: handles the life cycle of a managed job."""
 import argparse
 import multiprocessing
 import os
 import pathlib
 import time
 import traceback
 import typing
@@ -11,44 +11,44 @@
 import filelock
 
 from sky import exceptions
 from sky import sky_logging
 from sky import status_lib
 from sky.backends import backend_utils
 from sky.backends import cloud_vm_ray_backend
+from sky.jobs import recovery_strategy
+from sky.jobs import state as managed_job_state
+from sky.jobs import utils as managed_job_utils
 from sky.skylet import constants
 from sky.skylet import job_lib
-from sky.spot import recovery_strategy
-from sky.spot import spot_state
-from sky.spot import spot_utils
 from sky.usage import usage_lib
 from sky.utils import common_utils
 from sky.utils import controller_utils
 from sky.utils import dag_utils
 from sky.utils import subprocess_utils
 from sky.utils import ux_utils
 
 if typing.TYPE_CHECKING:
     import sky
 
 # Use the explicit logger name so that the logger is under the
-# `sky.spot.controller` namespace when executed directly, so as
+# `sky.jobs.controller` namespace when executed directly, so as
 # to inherit the setup from the `sky` logger.
-logger = sky_logging.init_logger('sky.spot.controller')
+logger = sky_logging.init_logger('sky.jobs.controller')
 
 
 def _get_dag_and_name(dag_yaml: str) -> Tuple['sky.Dag', str]:
     dag = dag_utils.load_chain_dag_from_yaml(dag_yaml)
     dag_name = dag.name
     assert dag_name is not None, dag
     return dag, dag_name
 
 
-class SpotController:
-    """Each spot controller manages the life cycle of one spot job."""
+class JobsController:
+    """Each jobs controller manages the life cycle of one managed job."""
 
     def __init__(self, job_id: int, dag_yaml: str,
                  retry_until_up: bool) -> None:
         self._job_id = job_id
         self._dag, self._dag_name = _get_dag_and_name(dag_yaml)
         logger.info(self._dag)
         self._retry_until_up = retry_until_up
@@ -84,31 +84,31 @@
             task_envs[constants.TASK_ID_LIST_ENV_VAR] = '\n'.join(
                 job_id_env_vars)
             task.update_envs(task_envs)
 
     def _download_log_and_stream(
             self,
             handle: cloud_vm_ray_backend.CloudVmRayResourceHandle) -> None:
-        """Downloads and streams the logs of the latest job of a spot cluster.
+        """Downloads and streams the logs of the latest job.
 
-        We do not stream the logs from the spot cluster directly, as the
+        We do not stream the logs from the cluster directly, as the
         donwload and stream should be faster, and more robust against
         preemptions or ssh disconnection during the streaming.
         """
-        spot_job_logs_dir = os.path.join(constants.SKY_LOGS_DIRECTORY,
-                                         'spot_jobs')
+        managed_job_logs_dir = os.path.join(constants.SKY_LOGS_DIRECTORY,
+                                            'managed_jobs')
         controller_utils.download_and_stream_latest_job_log(
-            self._backend, handle, spot_job_logs_dir)
+            self._backend, handle, managed_job_logs_dir)
         logger.info(f'\n== End of logs (ID: {self._job_id}) ==')
 
     def _run_one_task(self, task_id: int, task: 'sky.Task') -> bool:
-        """Busy loop monitoring spot cluster status and handling recovery.
+        """Busy loop monitoring cluster status and handling recovery.
 
         When the task is successfully completed, this function returns True,
-        and will terminate the spot cluster before returning.
+        and will terminate the cluster before returning.
 
         If the user program fails, i.e. the task is set to FAILED or
         FAILED_SETUP, this function will return False.
         In other cases, the function will raise exceptions.
         All the failure cases will rely on the caller to clean up the spot
         cluster(s) and storages.
 
@@ -126,192 +126,205 @@
                 cloud user identity, or unsupported feature.
             exceptions.SpotJobReachedMaxRetryError: This will be raised when
                 all prechecks passed but the maximum number of retries is
                 reached for `sky.launch`. The failure of `sky.launch` can be
                 due to:
                 1. Any of the underlying failover exceptions is due to resources
                 unavailability.
-                2. The cluster is preempted before the job is submitted.
+                2. The cluster is preempted or failed before the job is
+                submitted.
                 3. Any unexpected error happens during the `sky.launch`.
         Other exceptions may be raised depending on the backend.
         """
 
-        callback_func = spot_utils.event_callback_func(job_id=self._job_id,
-                                                       task_id=task_id,
-                                                       task=task)
+        callback_func = managed_job_utils.event_callback_func(
+            job_id=self._job_id, task_id=task_id, task=task)
         if task.run is None:
             logger.info(f'Skip running task {task_id} ({task.name}) due to its '
                         'run commands being empty.')
             # Call set_started first to initialize columns in the state table,
             # including start_at and last_recovery_at to avoid issues for
             # uninitialized columns.
-            spot_state.set_started(job_id=self._job_id,
-                                   task_id=task_id,
-                                   start_time=time.time(),
-                                   callback_func=callback_func)
-            spot_state.set_succeeded(job_id=self._job_id,
-                                     task_id=task_id,
-                                     end_time=time.time(),
-                                     callback_func=callback_func)
+            managed_job_state.set_started(job_id=self._job_id,
+                                          task_id=task_id,
+                                          start_time=time.time(),
+                                          callback_func=callback_func)
+            managed_job_state.set_succeeded(job_id=self._job_id,
+                                            task_id=task_id,
+                                            end_time=time.time(),
+                                            callback_func=callback_func)
             return True
         usage_lib.messages.usage.update_task_id(task_id)
         task_id_env_var = task.envs[constants.TASK_ID_ENV_VAR]
         submitted_at = time.time()
         if task_id == 0:
             submitted_at = backend_utils.get_timestamp_from_run_timestamp(
                 self._backend.run_timestamp)
-        spot_state.set_submitted(
+        managed_job_state.set_submitted(
             self._job_id,
             task_id,
             self._backend.run_timestamp,
             submitted_at,
-            resources_str=backend_utils.get_task_resources_str(task),
+            resources_str=backend_utils.get_task_resources_str(
+                task, is_managed_job=True),
             callback_func=callback_func)
         logger.info(
-            f'Submitted spot job {self._job_id} (task: {task_id}, name: '
+            f'Submitted managed job {self._job_id} (task: {task_id}, name: '
             f'{task.name!r}); {constants.TASK_ID_ENV_VAR}: {task_id_env_var}')
         assert task.name is not None, task
-        cluster_name = spot_utils.generate_spot_cluster_name(
+        cluster_name = managed_job_utils.generate_managed_job_cluster_name(
             task.name, self._job_id)
         self._strategy_executor = recovery_strategy.StrategyExecutor.make(
             cluster_name, self._backend, task, self._retry_until_up)
 
         logger.info('Started monitoring.')
-        spot_state.set_starting(job_id=self._job_id,
-                                task_id=task_id,
-                                callback_func=callback_func)
+        managed_job_state.set_starting(job_id=self._job_id,
+                                       task_id=task_id,
+                                       callback_func=callback_func)
         remote_job_submitted_at = self._strategy_executor.launch()
         assert remote_job_submitted_at is not None, remote_job_submitted_at
 
-        spot_state.set_started(job_id=self._job_id,
-                               task_id=task_id,
-                               start_time=remote_job_submitted_at,
-                               callback_func=callback_func)
+        managed_job_state.set_started(job_id=self._job_id,
+                                      task_id=task_id,
+                                      start_time=remote_job_submitted_at,
+                                      callback_func=callback_func)
         while True:
-            time.sleep(spot_utils.JOB_STATUS_CHECK_GAP_SECONDS)
+            time.sleep(managed_job_utils.JOB_STATUS_CHECK_GAP_SECONDS)
 
             # Check the network connection to avoid false alarm for job failure.
             # Network glitch was observed even in the VM.
             try:
                 backend_utils.check_network_connection()
             except exceptions.NetworkError:
-                logger.info(
-                    'Network is not available. Retrying again in '
-                    f'{spot_utils.JOB_STATUS_CHECK_GAP_SECONDS} seconds.')
+                logger.info('Network is not available. Retrying again in '
+                            f'{managed_job_utils.JOB_STATUS_CHECK_GAP_SECONDS} '
+                            'seconds.')
                 continue
 
             # NOTE: we do not check cluster status first because race condition
             # can occur, i.e. cluster can be down during the job status check.
-            job_status = spot_utils.get_job_status(self._backend, cluster_name)
+            job_status = managed_job_utils.get_job_status(
+                self._backend, cluster_name)
 
             if job_status == job_lib.JobStatus.SUCCEEDED:
-                end_time = spot_utils.get_job_timestamp(self._backend,
-                                                        cluster_name,
-                                                        get_end_time=True)
+                end_time = managed_job_utils.get_job_timestamp(
+                    self._backend, cluster_name, get_end_time=True)
                 # The job is done.
-                spot_state.set_succeeded(self._job_id,
-                                         task_id,
-                                         end_time=end_time,
-                                         callback_func=callback_func)
+                managed_job_state.set_succeeded(self._job_id,
+                                                task_id,
+                                                end_time=end_time,
+                                                callback_func=callback_func)
                 logger.info(
                     f'Spot job {self._job_id} (task: {task_id}) SUCCEEDED. '
-                    f'Cleaning up the spot cluster {cluster_name}.')
-                # Only clean up the spot cluster, not the storages, because
-                # tasks may share storages.
+                    f'Cleaning up the cluster {cluster_name}.')
+                # Only clean up the cluster, not the storages, because tasks may
+                # share storages.
                 recovery_strategy.terminate_cluster(cluster_name=cluster_name)
                 return True
 
             # For single-node jobs, nonterminated job_status indicates a
             # healthy cluster. We can safely continue monitoring.
             # For multi-node jobs, since the job may not be set to FAILED
             # immediately (depending on user program) when only some of the
-            # nodes are preempted, need to check the actual cluster status.
+            # nodes are preempted or failed, need to check the actual cluster
+            # status.
             if (job_status is not None and not job_status.is_terminal() and
                     task.num_nodes == 1):
                 continue
 
             if job_status in [
                     job_lib.JobStatus.FAILED, job_lib.JobStatus.FAILED_SETUP
             ]:
                 # Add a grace period before the check of preemption to avoid
                 # false alarm for job failure.
                 time.sleep(5)
+
             # Pull the actual cluster status from the cloud provider to
-            # determine whether the cluster is preempted.
+            # determine whether the cluster is preempted or failed.
+            # TODO(zhwu): For hardware failure, such as GPU failure, it may not
+            # be reflected in the cluster status, depending on the cloud, which
+            # can also cause failure of the job, and we need to recover it
+            # rather than fail immediately.
             (cluster_status,
              handle) = backend_utils.refresh_cluster_status_handle(
                  cluster_name,
                  force_refresh_statuses=set(status_lib.ClusterStatus))
 
             if cluster_status != status_lib.ClusterStatus.UP:
-                # The cluster is (partially) preempted. It can be down, INIT
-                # or STOPPED, based on the interruption behavior of the cloud.
-                # Spot recovery is needed (will be done later in the code).
+                # The cluster is (partially) preempted or failed. It can be
+                # down, INIT or STOPPED, based on the interruption behavior of
+                # the cloud. Spot recovery is needed (will be done later in the
+                # code).
                 cluster_status_str = ('' if cluster_status is None else
                                       f' (status: {cluster_status.value})')
                 logger.info(
-                    f'Cluster is preempted{cluster_status_str}. Recovering...')
+                    f'Cluster is preempted or failed{cluster_status_str}. '
+                    'Recovering...')
             else:
                 if job_status is not None and not job_status.is_terminal():
                     # The multi-node job is still running, continue monitoring.
                     continue
                 elif job_status in [
                         job_lib.JobStatus.FAILED, job_lib.JobStatus.FAILED_SETUP
                 ]:
                     # The user code has probably crashed, fail immediately.
-                    end_time = spot_utils.get_job_timestamp(self._backend,
-                                                            cluster_name,
-                                                            get_end_time=True)
+                    end_time = managed_job_utils.get_job_timestamp(
+                        self._backend, cluster_name, get_end_time=True)
                     logger.info(
                         'The user job failed. Please check the logs below.\n'
                         f'== Logs of the user job (ID: {self._job_id}) ==\n')
 
                     self._download_log_and_stream(handle)
-                    spot_status_to_set = spot_state.SpotStatus.FAILED
+                    managed_job_status = (
+                        managed_job_state.ManagedJobStatus.FAILED)
                     if job_status == job_lib.JobStatus.FAILED_SETUP:
-                        spot_status_to_set = spot_state.SpotStatus.FAILED_SETUP
+                        managed_job_status = (
+                            managed_job_state.ManagedJobStatus.FAILED_SETUP)
                     failure_reason = (
                         'To see the details, run: '
-                        f'sky spot logs --controller {self._job_id}')
+                        f'sky jobs logs --controller {self._job_id}')
 
-                    spot_state.set_failed(self._job_id,
-                                          task_id,
-                                          failure_type=spot_status_to_set,
-                                          failure_reason=failure_reason,
-                                          end_time=end_time,
-                                          callback_func=callback_func)
+                    managed_job_state.set_failed(
+                        self._job_id,
+                        task_id,
+                        failure_type=managed_job_status,
+                        failure_reason=failure_reason,
+                        end_time=end_time,
+                        callback_func=callback_func)
                     return False
                 # Although the cluster is healthy, we fail to access the
                 # job status. Try to recover the job (will not restart the
                 # cluster, if the cluster is healthy).
                 assert job_status is None, job_status
                 logger.info('Failed to fetch the job status while the '
                             'cluster is healthy. Try to recover the job '
                             '(the cluster will not be restarted).')
 
             # When the handle is None, the cluster should be cleaned up already.
             if handle is not None:
                 resources = handle.launched_resources
                 assert resources is not None, handle
-                if resources.need_cleanup_after_preemption():
+                if resources.need_cleanup_after_preemption_or_failure():
                     # Some spot resource (e.g., Spot TPU VM) may need to be
-                    # cleaned up after preemption.
-                    logger.info('Cleaning up the preempted spot cluster...')
+                    # cleaned up after preemption, as running launch again on
+                    # those clusters again may fail.
+                    logger.info('Cleaning up the preempted or failed cluster'
+                                '...')
                     recovery_strategy.terminate_cluster(cluster_name)
 
-            # Try to recover the spot jobs, when the cluster is preempted
-            # or the job status is failed to be fetched.
-            spot_state.set_recovering(job_id=self._job_id,
-                                      task_id=task_id,
-                                      callback_func=callback_func)
+            # Try to recover the managed jobs, when the cluster is preempted or
+            # failed or the job status is failed to be fetched.
+            managed_job_state.set_recovering(job_id=self._job_id,
+                                             task_id=task_id,
+                                             callback_func=callback_func)
             recovered_time = self._strategy_executor.recover()
-            spot_state.set_recovered(self._job_id,
-                                     task_id,
-                                     recovered_time=recovered_time,
-                                     callback_func=callback_func)
+            managed_job_state.set_recovered(self._job_id,
+                                            task_id,
+                                            recovered_time=recovered_time,
+                                            callback_func=callback_func)
 
     def run(self):
         """Run controller logic and handle exceptions."""
         task_id = 0
         try:
             succeeded = True
             # We support chain DAGs only for now.
@@ -322,119 +335,124 @@
         except exceptions.ProvisionPrechecksError as e:
             # Please refer to the docstring of self._run for the cases when
             # this exception can occur.
             failure_reason = ('; '.join(
                 common_utils.format_exception(reason, use_bracket=True)
                 for reason in e.reasons))
             logger.error(failure_reason)
-            spot_state.set_failed(
+            managed_job_state.set_failed(
                 self._job_id,
                 task_id=task_id,
-                failure_type=spot_state.SpotStatus.FAILED_PRECHECKS,
+                failure_type=managed_job_state.ManagedJobStatus.
+                FAILED_PRECHECKS,
                 failure_reason=failure_reason,
-                callback_func=spot_utils.event_callback_func(
+                callback_func=managed_job_utils.event_callback_func(
                     job_id=self._job_id,
                     task_id=task_id,
                     task=self._dag.tasks[task_id]))
-        except exceptions.SpotJobReachedMaxRetriesError as e:
+        except exceptions.ManagedJobReachedMaxRetriesError as e:
             # Please refer to the docstring of self._run for the cases when
             # this exception can occur.
             logger.error(common_utils.format_exception(e))
-            # The spot job should be marked as FAILED_NO_RESOURCE, as the
-            # spot job may be able to launch next time.
-            spot_state.set_failed(
+            # The managed job should be marked as FAILED_NO_RESOURCE, as the
+            # managed job may be able to launch next time.
+            managed_job_state.set_failed(
                 self._job_id,
                 task_id=task_id,
-                failure_type=spot_state.SpotStatus.FAILED_NO_RESOURCE,
+                failure_type=managed_job_state.ManagedJobStatus.
+                FAILED_NO_RESOURCE,
                 failure_reason=common_utils.format_exception(e),
-                callback_func=spot_utils.event_callback_func(
+                callback_func=managed_job_utils.event_callback_func(
                     job_id=self._job_id,
                     task_id=task_id,
                     task=self._dag.tasks[task_id]))
         except (Exception, SystemExit) as e:  # pylint: disable=broad-except
             with ux_utils.enable_traceback():
                 logger.error(traceback.format_exc())
             msg = ('Unexpected error occurred: '
                    f'{common_utils.format_exception(e, use_bracket=True)}')
             logger.error(msg)
-            spot_state.set_failed(
+            managed_job_state.set_failed(
                 self._job_id,
                 task_id=task_id,
-                failure_type=spot_state.SpotStatus.FAILED_CONTROLLER,
+                failure_type=managed_job_state.ManagedJobStatus.
+                FAILED_CONTROLLER,
                 failure_reason=msg,
-                callback_func=spot_utils.event_callback_func(
+                callback_func=managed_job_utils.event_callback_func(
                     job_id=self._job_id,
                     task_id=task_id,
                     task=self._dag.tasks[task_id]))
         finally:
             # This will set all unfinished tasks to CANCELLING, and will not
             # affect the jobs in terminal states.
             # We need to call set_cancelling before set_cancelled to make sure
             # the table entries are correctly set.
-            callback_func = spot_utils.event_callback_func(
+            callback_func = managed_job_utils.event_callback_func(
                 job_id=self._job_id,
                 task_id=task_id,
                 task=self._dag.tasks[task_id])
-            spot_state.set_cancelling(job_id=self._job_id,
-                                      callback_func=callback_func)
-            spot_state.set_cancelled(job_id=self._job_id,
-                                     callback_func=callback_func)
+            managed_job_state.set_cancelling(job_id=self._job_id,
+                                             callback_func=callback_func)
+            managed_job_state.set_cancelled(job_id=self._job_id,
+                                            callback_func=callback_func)
 
 
 def _run_controller(job_id: int, dag_yaml: str, retry_until_up: bool):
     """Runs the controller in a remote process for interruption."""
     # The controller needs to be instantiated in the remote process, since
     # the controller is not serializable.
-    spot_controller = SpotController(job_id, dag_yaml, retry_until_up)
-    spot_controller.run()
+    jobs_controller = JobsController(job_id, dag_yaml, retry_until_up)
+    jobs_controller.run()
 
 
 def _handle_signal(job_id):
     """Handle the signal if the user sent it."""
-    signal_file = pathlib.Path(spot_utils.SIGNAL_FILE_PREFIX.format(job_id))
+    signal_file = pathlib.Path(
+        managed_job_utils.SIGNAL_FILE_PREFIX.format(job_id))
     user_signal = None
     if signal_file.exists():
         # Filelock is needed to prevent race condition with concurrent
         # signal writing.
         with filelock.FileLock(str(signal_file) + '.lock'):
             with signal_file.open(mode='r', encoding='utf-8') as f:
                 user_signal = f.read().strip()
                 try:
-                    user_signal = spot_utils.UserSignal(user_signal)
+                    user_signal = managed_job_utils.UserSignal(user_signal)
                 except ValueError:
                     logger.warning(
                         f'Unknown signal received: {user_signal}. Ignoring.')
                     user_signal = None
             # Remove the signal file, after reading the signal.
             signal_file.unlink()
     if user_signal is None:
         # None or empty string.
         return
-    assert user_signal == spot_utils.UserSignal.CANCEL, (
+    assert user_signal == managed_job_utils.UserSignal.CANCEL, (
         f'Only cancel signal is supported, but {user_signal} got.')
-    raise exceptions.SpotUserCancelledError(
+    raise exceptions.ManagedJobUserCancelledError(
         f'User sent {user_signal.value} signal.')
 
 
 def _cleanup(job_id: int, dag_yaml: str):
-    """Clean up the spot cluster(s) and storages.
+    """Clean up the cluster(s) and storages.
 
     (1) Clean up the succeeded task(s)' ephemeral storage. The storage has
         to be cleaned up after the whole job is finished, as the tasks
         may share the same storage.
-    (2) Clean up the spot cluster(s) that are not cleaned up yet, which
-        can happen when the spot task failed or cancelled. At most one
-        spot cluster should be left when reaching here, as we currently
-        only support chain DAGs, and only spot task is executed at a time.
+    (2) Clean up the cluster(s) that are not cleaned up yet, which can happen
+        when the task failed or cancelled. At most one cluster should be left
+        when reaching here, as we currently only support chain DAGs, and only
+        task is executed at a time.
     """
     # NOTE: The code to get cluster name is same as what we did in the spot
-    # controller, we should keep it in sync with SpotController.__init__()
+    # controller, we should keep it in sync with JobsController.__init__()
     dag, _ = _get_dag_and_name(dag_yaml)
     for task in dag.tasks:
-        cluster_name = spot_utils.generate_spot_cluster_name(task.name, job_id)
+        cluster_name = managed_job_utils.generate_managed_job_cluster_name(
+            task.name, job_id)
         recovery_strategy.terminate_cluster(cluster_name)
         # Clean up Storages with persistent=False.
         # TODO(zhwu): this assumes the specific backend.
         backend = cloud_vm_ray_backend.CloudVmRayBackend()
         backend.teardown_ephemeral_storage(task)
 
 
@@ -453,80 +471,80 @@
         controller_process = multiprocessing.Process(target=_run_controller,
                                                      args=(job_id, dag_yaml,
                                                            retry_until_up))
         controller_process.start()
         while controller_process.is_alive():
             _handle_signal(job_id)
             time.sleep(1)
-    except exceptions.SpotUserCancelledError:
+    except exceptions.ManagedJobUserCancelledError:
         dag, _ = _get_dag_and_name(dag_yaml)
-        task_id, _ = (spot_state.get_latest_task_id_status(job_id))
+        task_id, _ = managed_job_state.get_latest_task_id_status(job_id)
         logger.info(
-            f'Cancelling spot job, job_id: {job_id}, task_id: {task_id}')
-        spot_state.set_cancelling(job_id=job_id,
-                                  callback_func=spot_utils.event_callback_func(
-                                      job_id=job_id,
-                                      task_id=task_id,
-                                      task=dag.tasks[task_id]))
+            f'Cancelling managed job, job_id: {job_id}, task_id: {task_id}')
+        managed_job_state.set_cancelling(
+            job_id=job_id,
+            callback_func=managed_job_utils.event_callback_func(
+                job_id=job_id, task_id=task_id, task=dag.tasks[task_id]))
         cancelling = True
     finally:
         if controller_process is not None:
             logger.info(f'Killing controller process {controller_process.pid}.')
             # NOTE: it is ok to kill or join a killed process.
             # Kill the controller process first; if its child process is
             # killed first, then the controller process will raise errors.
             # Kill any possible remaining children processes recursively.
             subprocess_utils.kill_children_processes(controller_process.pid,
                                                      force=True)
             controller_process.join()
             logger.info(f'Controller process {controller_process.pid} killed.')
 
-        logger.info(f'Cleaning up any spot cluster for job {job_id}.')
+        logger.info(f'Cleaning up any cluster for job {job_id}.')
         # NOTE: Originally, we send an interruption signal to the controller
         # process and the controller process handles cleanup. However, we
         # figure out the behavior differs from cloud to cloud
         # (e.g., GCP ignores 'SIGINT'). A possible explanation is
         # https://unix.stackexchange.com/questions/356408/strange-problem-with-trap-and-sigint
         # But anyway, a clean solution is killing the controller process
-        # directly, and then cleanup the cluster state.
+        # directly, and then cleanup the cluster job_state.
         _cleanup(job_id, dag_yaml=dag_yaml)
-        logger.info(f'Spot cluster of job {job_id} has been cleaned up.')
+        logger.info(f'Cluster of managed job {job_id} has been cleaned up.')
 
         if cancelling:
-            spot_state.set_cancelled(
+            managed_job_state.set_cancelled(
                 job_id=job_id,
-                callback_func=spot_utils.event_callback_func(
+                callback_func=managed_job_utils.event_callback_func(
                     job_id=job_id, task_id=task_id, task=dag.tasks[task_id]))
 
         # We should check job status after 'set_cancelled', otherwise
         # the job status is not terminal.
-        job_status = spot_state.get_status(job_id)
+        job_status = managed_job_state.get_status(job_id)
         assert job_status is not None
         # The job can be non-terminal if the controller exited abnormally,
         # e.g. failed to launch cluster after reaching the MAX_RETRY.
         if not job_status.is_terminal():
-            logger.info(f'Previous spot job status: {job_status.value}')
-            spot_state.set_failed(
+            logger.info(f'Previous job status: {job_status.value}')
+            managed_job_state.set_failed(
                 job_id,
                 task_id=None,
-                failure_type=spot_state.SpotStatus.FAILED_CONTROLLER,
+                failure_type=managed_job_state.ManagedJobStatus.
+                FAILED_CONTROLLER,
                 failure_reason=('Unexpected error occurred. For details, '
-                                f'run: sky spot logs --controller {job_id}'))
+                                f'run: sky jobs logs --controller {job_id}'))
 
 
 if __name__ == '__main__':
     parser = argparse.ArgumentParser()
     parser.add_argument('--job-id',
                         required=True,
                         type=int,
                         help='Job id for the controller job.')
     parser.add_argument('--retry-until-up',
                         action='store_true',
-                        help='Retry until the spot cluster is up.')
+                        help='Retry until the cluster is up.')
     parser.add_argument('dag_yaml',
                         type=str,
-                        help='The path to the user spot task yaml file.')
+                        help='The path to the user job yaml file.')
     args = parser.parse_args()
     # We start process with 'spawn', because 'fork' could result in weird
     # behaviors; 'spawn' is also cross-platform.
     multiprocessing.set_start_method('spawn', force=True)
     start(args.job_id, args.dag_yaml, args.retry_until_up)
```

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/spot/core.py` & `skypilot_nightly-1.0.0.dev20240505/sky/jobs/core.py`

 * *Files 8% similar despite different names*

```diff
@@ -1,8 +1,8 @@
-"""SDK functions for managed spot job."""
+"""SDK functions for managed jobs."""
 import os
 import tempfile
 from typing import Any, Dict, List, Optional, Union
 import uuid
 
 import colorama
 
@@ -10,17 +10,17 @@
 from sky import backends
 from sky import exceptions
 from sky import sky_logging
 from sky import status_lib
 from sky import task as task_lib
 from sky.backends import backend_utils
 from sky.clouds.service_catalog import common as service_catalog_common
+from sky.jobs import constants as managed_job_constants
+from sky.jobs import utils as managed_job_utils
 from sky.skylet import constants as skylet_constants
-from sky.spot import constants
-from sky.spot import spot_utils
 from sky.usage import usage_lib
 from sky.utils import common_utils
 from sky.utils import controller_utils
 from sky.utils import dag_utils
 from sky.utils import rich_utils
 from sky.utils import subprocess_utils
 from sky.utils import ux_utils
@@ -31,184 +31,189 @@
     task: Union['sky.Task', 'sky.Dag'],
     name: Optional[str] = None,
     stream_logs: bool = True,
     detach_run: bool = False,
     retry_until_up: bool = False,
 ) -> None:
     # NOTE(dev): Keep the docstring consistent between the Python API and CLI.
-    """Launch a managed spot job.
+    """Launch a managed job.
 
-    Please refer to the sky.cli.spot_launch for the document.
+    Please refer to sky.cli.job_launch for documentation.
 
     Args:
         task: sky.Task, or sky.Dag (experimental; 1-task only) to launch as a
-          managed spot job.
-        name: Name of the spot job.
+          managed job.
+        name: Name of the managed job.
         detach_run: Whether to detach the run.
 
     Raises:
-        ValueError: cluster does not exist.
+        ValueError: cluster does not exist. Or, the entrypoint is not a valid
+            chain dag.
         sky.exceptions.NotSupportedError: the feature is not supported.
     """
     entrypoint = task
     dag_uuid = str(uuid.uuid4().hex[:4])
 
     dag = dag_utils.convert_entrypoint_to_dag(entrypoint)
     if not dag.is_chain():
         with ux_utils.print_exception_no_traceback():
-            raise ValueError('Only single-task or chain DAG is allowed for '
-                             f'sky.spot.launch. Dag:\n{dag}')
+            raise ValueError('Only single-task or chain DAG is '
+                             f'allowed for job_launch. Dag: {dag}')
 
     dag_utils.maybe_infer_and_fill_dag_and_task_names(dag)
 
     task_names = set()
     for task_ in dag.tasks:
         if task_.name in task_names:
             with ux_utils.print_exception_no_traceback():
                 raise ValueError(
                     f'Task name {task_.name!r} is duplicated in the DAG. '
                     'Either change task names to be unique, or specify the DAG '
                     'name only and comment out the task names (so that they '
                     'will be auto-generated) .')
         task_names.add(task_.name)
 
-    dag_utils.fill_default_spot_config_in_dag_for_spot_launch(dag)
+    dag_utils.fill_default_config_in_dag_for_job_launch(dag)
 
     for task_ in dag.tasks:
         controller_utils.maybe_translate_local_file_mounts_and_sync_up(
-            task_, path='spot')
+            task_, path='jobs')
 
-    with tempfile.NamedTemporaryFile(prefix=f'spot-dag-{dag.name}-',
+    with tempfile.NamedTemporaryFile(prefix=f'managed-dag-{dag.name}-',
                                      mode='w') as f:
         dag_utils.dump_chain_dag_to_yaml(dag, f.name)
-        controller_name = spot_utils.SPOT_CONTROLLER_NAME
-        prefix = constants.SPOT_TASK_YAML_PREFIX
+        controller = controller_utils.Controllers.JOBS_CONTROLLER
+        controller_name = controller.value.cluster_name
+        prefix = managed_job_constants.JOBS_TASK_YAML_PREFIX
         remote_user_yaml_path = f'{prefix}/{dag.name}-{dag_uuid}.yaml'
         remote_user_config_path = f'{prefix}/{dag.name}-{dag_uuid}.config_yaml'
         controller_resources = controller_utils.get_controller_resources(
-            controller_type='spot',
+            controller=controller_utils.Controllers.JOBS_CONTROLLER,
             task_resources=sum([list(t.resources) for t in dag.tasks], []))
 
         vars_to_fill = {
             'remote_user_yaml_path': remote_user_yaml_path,
             'user_yaml_path': f.name,
-            'spot_controller': controller_name,
-            # Note: actual spot cluster name will be <task.name>-<spot job ID>
+            'jobs_controller': controller_name,
+            # Note: actual cluster name will be <task.name>-<managed job ID>
             'dag_name': dag.name,
             'retry_until_up': retry_until_up,
             'remote_user_config_path': remote_user_config_path,
             'sky_python_cmd': skylet_constants.SKY_PYTHON_CMD,
             'modified_catalogs':
                 service_catalog_common.get_modified_catalog_file_mounts(),
             **controller_utils.shared_controller_vars_to_fill(
-                'spot',
+                controller_utils.Controllers.JOBS_CONTROLLER,
                 remote_user_config_path=remote_user_config_path,
             ),
         }
 
-        yaml_path = os.path.join(constants.SPOT_CONTROLLER_YAML_PREFIX,
-                                 f'{name}-{dag_uuid}.yaml')
-        common_utils.fill_template(constants.SPOT_CONTROLLER_TEMPLATE,
-                                   vars_to_fill,
-                                   output_path=yaml_path)
+        yaml_path = os.path.join(
+            managed_job_constants.JOBS_CONTROLLER_YAML_PREFIX,
+            f'{name}-{dag_uuid}.yaml')
+        common_utils.fill_template(
+            managed_job_constants.JOBS_CONTROLLER_TEMPLATE,
+            vars_to_fill,
+            output_path=yaml_path)
         controller_task = task_lib.Task.from_yaml(yaml_path)
         controller_task.set_resources(controller_resources)
 
-        controller_task.spot_dag = dag
-        assert len(controller_task.resources) == 1
+        controller_task.managed_job_dag = dag
+        assert len(controller_task.resources) == 1, controller_task
 
         sky_logging.print(
             f'{colorama.Fore.YELLOW}'
-            f'Launching managed spot job {dag.name!r} from spot controller...'
+            f'Launching managed job {dag.name!r} from jobs controller...'
             f'{colorama.Style.RESET_ALL}')
-        sky_logging.print('Launching spot controller...')
+        sky_logging.print('Launching jobs controller...')
         sky.launch(task=controller_task,
                    stream_logs=stream_logs,
                    cluster_name=controller_name,
                    detach_run=detach_run,
                    idle_minutes_to_autostop=skylet_constants.
                    CONTROLLER_IDLE_MINUTES_TO_AUTOSTOP,
                    retry_until_up=True,
                    _disable_controller_check=True)
 
 
 @usage_lib.entrypoint
 def queue(refresh: bool, skip_finished: bool = False) -> List[Dict[str, Any]]:
     # NOTE(dev): Keep the docstring consistent between the Python API and CLI.
-    """Get statuses of managed spot jobs.
+    """Get statuses of managed jobs.
 
-    Please refer to the sky.cli.spot_queue for the documentation.
+    Please refer to sky.cli.job_queue for documentation.
 
     Returns:
         [
             {
                 'job_id': int,
                 'job_name': str,
                 'resources': str,
                 'submitted_at': (float) timestamp of submission,
                 'end_at': (float) timestamp of end,
                 'duration': (float) duration in seconds,
                 'recovery_count': (int) Number of retries,
-                'status': (sky.spot.SpotStatus) of the job,
+                'status': (sky.jobs.ManagedJobStatus) of the job,
                 'cluster_resources': (str) resources of the cluster,
                 'region': (str) region of the cluster,
             }
         ]
     Raises:
-        sky.exceptions.ClusterNotUpError: the spot controller is not up or
+        sky.exceptions.ClusterNotUpError: the jobs controller is not up or
             does not exist.
-        RuntimeError: if failed to get the spot jobs with ssh.
+        RuntimeError: if failed to get the managed jobs with ssh.
     """
+    jobs_controller_type = controller_utils.Controllers.JOBS_CONTROLLER
     stopped_message = ''
     if not refresh:
-        stopped_message = 'No in-progress spot jobs.'
+        stopped_message = 'No in-progress managed jobs.'
     try:
         handle = backend_utils.is_controller_accessible(
-            controller_type=controller_utils.Controllers.SPOT_CONTROLLER,
-            stopped_message=stopped_message)
+            controller=jobs_controller_type, stopped_message=stopped_message)
     except exceptions.ClusterNotUpError as e:
         if not refresh:
             raise
         handle = None
         controller_status = e.cluster_status
 
     if refresh and handle is None:
         sky_logging.print(f'{colorama.Fore.YELLOW}'
                           'Restarting controller for latest status...'
                           f'{colorama.Style.RESET_ALL}')
 
-        rich_utils.force_update_status('[cyan] Checking spot jobs - restarting '
-                                       'controller[/]')
-        handle = sky.start(spot_utils.SPOT_CONTROLLER_NAME)
+        rich_utils.force_update_status(
+            '[cyan] Checking managed jobs - restarting '
+            'controller[/]')
+        handle = sky.start(jobs_controller_type.value.cluster_name)
         controller_status = status_lib.ClusterStatus.UP
-        rich_utils.force_update_status('[cyan] Checking spot jobs[/]')
+        rich_utils.force_update_status('[cyan] Checking managed jobs[/]')
 
     assert handle is not None, (controller_status, refresh)
 
     backend = backend_utils.get_backend_from_handle(handle)
     assert isinstance(backend, backends.CloudVmRayBackend)
 
-    code = spot_utils.SpotCodeGen.get_job_table()
+    code = managed_job_utils.ManagedJobCodeGen.get_job_table()
     returncode, job_table_payload, stderr = backend.run_on_head(
         handle,
         code,
         require_outputs=True,
         stream_logs=False,
         separate_stderr=True)
 
     try:
         subprocess_utils.handle_returncode(returncode,
                                            code,
-                                           'Failed to fetch managed spot jobs',
+                                           'Failed to fetch managed jobs',
                                            job_table_payload + stderr,
                                            stream_logs=False)
     except exceptions.CommandError as e:
         raise RuntimeError(str(e)) from e
 
-    jobs = spot_utils.load_spot_job_queue(job_table_payload)
+    jobs = managed_job_utils.load_managed_job_queue(job_table_payload)
     if skip_finished:
         # Filter out the finished jobs. If a multi-task job is partially
         # finished, we will include all its tasks.
         non_finished_tasks = list(
             filter(lambda job: not job['status'].is_terminal(), jobs))
         non_finished_job_ids = {job['job_id'] for job in non_finished_tasks}
         jobs = list(
@@ -218,53 +223,53 @@
 
 @usage_lib.entrypoint
 # pylint: disable=redefined-builtin
 def cancel(name: Optional[str] = None,
            job_ids: Optional[List[int]] = None,
            all: bool = False) -> None:
     # NOTE(dev): Keep the docstring consistent between the Python API and CLI.
-    """Cancel managed spot jobs.
+    """Cancel managed jobs.
 
-    Please refer to the sky.cli.spot_cancel for the document.
+    Please refer to sky.cli.job_cancel for documentation.
 
     Raises:
-        sky.exceptions.ClusterNotUpError: the spot controller is not up.
+        sky.exceptions.ClusterNotUpError: the jobs controller is not up.
         RuntimeError: failed to cancel the job.
     """
     job_ids = [] if job_ids is None else job_ids
     handle = backend_utils.is_controller_accessible(
-        controller_type=controller_utils.Controllers.SPOT_CONTROLLER,
-        stopped_message='All managed spot jobs should have finished.')
+        controller=controller_utils.Controllers.JOBS_CONTROLLER,
+        stopped_message='All managed jobs should have finished.')
 
     job_id_str = ','.join(map(str, job_ids))
     if sum([len(job_ids) > 0, name is not None, all]) != 1:
         argument_str = f'job_ids={job_id_str}' if len(job_ids) > 0 else ''
         argument_str += f' name={name}' if name is not None else ''
         argument_str += ' all' if all else ''
         with ux_utils.print_exception_no_traceback():
             raise ValueError('Can only specify one of JOB_IDS or name or all. '
                              f'Provided {argument_str!r}.')
 
     backend = backend_utils.get_backend_from_handle(handle)
     assert isinstance(backend, backends.CloudVmRayBackend)
     if all:
-        code = spot_utils.SpotCodeGen.cancel_jobs_by_id(None)
+        code = managed_job_utils.ManagedJobCodeGen.cancel_jobs_by_id(None)
     elif job_ids:
-        code = spot_utils.SpotCodeGen.cancel_jobs_by_id(job_ids)
+        code = managed_job_utils.ManagedJobCodeGen.cancel_jobs_by_id(job_ids)
     else:
         assert name is not None, (job_ids, name, all)
-        code = spot_utils.SpotCodeGen.cancel_job_by_name(name)
+        code = managed_job_utils.ManagedJobCodeGen.cancel_job_by_name(name)
     # The stderr is redirected to stdout
     returncode, stdout, _ = backend.run_on_head(handle,
                                                 code,
                                                 require_outputs=True,
                                                 stream_logs=False)
     try:
         subprocess_utils.handle_returncode(returncode, code,
-                                           'Failed to cancel managed spot job',
+                                           'Failed to cancel managed job',
                                            stdout)
     except exceptions.CommandError as e:
         with ux_utils.print_exception_no_traceback():
             raise RuntimeError(e.error_msg) from e
 
     sky_logging.print(stdout)
     if 'Multiple jobs found with name' in stdout:
@@ -272,46 +277,53 @@
             raise RuntimeError(
                 'Please specify the job ID instead of the job name.')
 
 
 @usage_lib.entrypoint
 def tail_logs(name: Optional[str], job_id: Optional[int], follow: bool) -> None:
     # NOTE(dev): Keep the docstring consistent between the Python API and CLI.
-    """Tail logs of managed spot jobs.
+    """Tail logs of managed jobs.
 
-    Please refer to the sky.cli.spot_logs for the document.
+    Please refer to sky.cli.job_logs for documentation.
 
     Raises:
         ValueError: invalid arguments.
-        sky.exceptions.ClusterNotUpError: the spot controller is not up.
+        sky.exceptions.ClusterNotUpError: the jobs controller is not up.
     """
-    # TODO(zhwu): Automatically restart the spot controller
+    # TODO(zhwu): Automatically restart the jobs controller
+    jobs_controller_type = controller_utils.Controllers.JOBS_CONTROLLER
     handle = backend_utils.is_controller_accessible(
-        controller_type=controller_utils.Controllers.SPOT_CONTROLLER,
-        stopped_message=('Please restart the spot controller with '
-                         f'`sky start {spot_utils.SPOT_CONTROLLER_NAME}`.'))
+        controller=jobs_controller_type,
+        stopped_message=(
+            'Please restart the jobs controller with '
+            f'`sky start {jobs_controller_type.value.cluster_name}`.'))
 
     if name is not None and job_id is not None:
         raise ValueError('Cannot specify both name and job_id.')
     backend = backend_utils.get_backend_from_handle(handle)
     assert isinstance(backend, backends.CloudVmRayBackend), backend
     # Stream the realtime logs
-    backend.tail_spot_logs(handle, job_id=job_id, job_name=name, follow=follow)
+    backend.tail_managed_job_logs(handle,
+                                  job_id=job_id,
+                                  job_name=name,
+                                  follow=follow)
 
 
-spot_launch = common_utils.deprecated_function(launch,
-                                               name='sky.spot.launch',
-                                               deprecated_name='spot_launch',
-                                               removing_version='0.7.0')
+spot_launch = common_utils.deprecated_function(
+    launch,
+    name='sky.jobs.launch',
+    deprecated_name='spot_launch',
+    removing_version='0.8.0',
+    override_argument={'use_spot': True})
 spot_queue = common_utils.deprecated_function(queue,
-                                              name='sky.spot.queue',
+                                              name='sky.jobs.queue',
                                               deprecated_name='spot_queue',
-                                              removing_version='0.7.0')
+                                              removing_version='0.8.0')
 spot_cancel = common_utils.deprecated_function(cancel,
-                                               name='sky.spot.cancel',
+                                               name='sky.jobs.cancel',
                                                deprecated_name='spot_cancel',
-                                               removing_version='0.7.0')
+                                               removing_version='0.8.0')
 spot_tail_logs = common_utils.deprecated_function(
     tail_logs,
-    name='sky.spot.tail_logs',
+    name='sky.jobs.tail_logs',
     deprecated_name='spot_tail_logs',
-    removing_version='0.7.0')
+    removing_version='0.8.0')
```

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/spot/dashboard/dashboard.py` & `skypilot_nightly-1.0.0.dev20240505/sky/jobs/dashboard/dashboard.py`

 * *Files 24% similar despite different names*

```diff
@@ -1,62 +1,76 @@
-"""Dashboard for spot jobs based on Flask.
+"""Dashboard for managed jobs based on Flask.
 
 TODO(zongheng): This is a basic version. In the future we can beef up the web
 frameworks used (e.g.,
 https://github.com/ray-project/ray/tree/master/dashboard/client/src) and/or get
-rid of the SSH port-forwarding business (see cli.py's spot_dashboard()
+rid of the SSH port-forwarding business (see cli.py's job_dashboard()
 comment).
 """
 import datetime
 import pathlib
 
 import flask
 import yaml
 
-import sky
-from sky import spot
+from sky import jobs as managed_jobs
 from sky.utils import common_utils
+from sky.utils import controller_utils
 
 app = flask.Flask(__name__)
 
 
-def _is_running_on_spot_controller() -> bool:
-    """Am I running on spot controller?
+def _is_running_on_jobs_controller() -> bool:
+    """Am I running on jobs controller?
 
     Loads ~/.sky/sky_ray.yml and check cluster_name.
     """
     if pathlib.Path('~/.sky/sky_ray.yml').expanduser().exists():
         config = yaml.safe_load(
             pathlib.Path('~/.sky/sky_ray.yml').expanduser().read_text())
-        return config.get('cluster_name', '').startswith('sky-spot-controller-')
+        cluster_name = config.get('cluster_name', '')
+        candidate_controller_names = (
+            controller_utils.Controllers.JOBS_CONTROLLER.value.
+            candidate_cluster_names)
+        # We use startswith instead of exact match because the cluster name in
+        # the yaml file is cluster_name_on_cloud which may have additional
+        # suffices.
+        return any(
+            cluster_name.startswith(name)
+            for name in candidate_controller_names)
     return False
 
 
 @app.route('/')
 def home():
-    if not _is_running_on_spot_controller():
+    if not _is_running_on_jobs_controller():
         # Experimental: run on laptop (refresh is very slow).
-        all_spot_jobs = sky.spot_queue(refresh=True, skip_finished=False)
+        all_managed_jobs = managed_jobs.queue(refresh=True, skip_finished=False)
     else:
-        job_table = spot.dump_spot_job_queue()
-        all_spot_jobs = spot.load_spot_job_queue(job_table)
+        job_table = managed_jobs.dump_managed_job_queue()
+        all_managed_jobs = managed_jobs.load_managed_job_queue(job_table)
 
-    timestamp = datetime.datetime.utcnow()
-    rows = spot.format_job_table(all_spot_jobs, show_all=True, return_rows=True)
+    timestamp = datetime.datetime.now(datetime.timezone.utc)
+    rows = managed_jobs.format_job_table(all_managed_jobs,
+                                         show_all=True,
+                                         return_rows=True)
+    # Add an empty column for the dropdown button. This will be added in the
+    # jobs/templates/index.html file.
+    rows = [[''] + row for row in rows]
 
     # FIXME(zongheng): make the job table/queue funcs return structured info so
     # that we don't have to do things like row[-5] below.
     columns = [
-        'ID', 'Task', 'Name', 'Resources', 'Submitted', 'Total Duration',
+        '', 'ID', 'Task', 'Name', 'Resources', 'Submitted', 'Total Duration',
         'Job Duration', 'Recoveries', 'Status', 'Started', 'Cluster', 'Region',
         'Failure'
     ]
     if rows and len(rows[0]) != len(columns):
         raise RuntimeError(
-            'Dashboard code and spot queue code are out of sync.')
+            'Dashboard code and managed job queue code are out of sync.')
 
     # Fix STATUS color codes: '\x1b[33mCANCELLED\x1b[0m' -> 'CANCELLED'.
     for row in rows:
         row[-5] = common_utils.remove_color(row[-5])
     # Remove filler rows ([''], ..., ['-']).
     rows = [row for row in rows if ''.join(map(str, row)) != '']
```

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/spot/dashboard/static/favicon.ico` & `skypilot_nightly-1.0.0.dev20240505/sky/jobs/dashboard/static/favicon.ico`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/spot/recovery_strategy.py` & `skypilot_nightly-1.0.0.dev20240505/sky/jobs/recovery_strategy.py`

 * *Files 3% similar despite different names*

```diff
@@ -1,70 +1,70 @@
-"""The strategy to handle launching/recovery/termination of spot clusters.
+"""Strategies to handle launching/recovery/termination of managed job clusters.
 
-In the YAML file, the user can specify the strategy to use for spot jobs.
+In the YAML file, the user can specify the strategy to use for managed jobs.
 
 resources:
-    spot_recovery: EAGER_NEXT_REGION
+    job_recovery: EAGER_NEXT_REGION
 """
 import time
 import traceback
 import typing
 from typing import Optional
 
 import sky
 from sky import backends
 from sky import exceptions
 from sky import global_user_state
 from sky import sky_logging
 from sky import status_lib
 from sky.backends import backend_utils
+from sky.jobs import utils as managed_job_utils
 from sky.skylet import job_lib
-from sky.spot import spot_utils
 from sky.usage import usage_lib
 from sky.utils import common_utils
 from sky.utils import ux_utils
 
 if typing.TYPE_CHECKING:
     from sky import task as task_lib
 
 logger = sky_logging.init_logger(__name__)
 
-SPOT_STRATEGIES = {}
-SPOT_DEFAULT_STRATEGY = None
+RECOVERY_STRATEGIES = {}
+DEFAULT_RECOVERY_STRATEGY = None
 
 # Waiting time for job from INIT/PENDING to RUNNING
 # 10 * JOB_STARTED_STATUS_CHECK_GAP_SECONDS = 10 * 5 = 50 seconds
 MAX_JOB_CHECKING_RETRY = 10
 
 
 def terminate_cluster(cluster_name: str, max_retry: int = 3) -> None:
-    """Terminate the spot cluster."""
+    """Terminate the cluster."""
     retry_cnt = 0
     while True:
         try:
             usage_lib.messages.usage.set_internal()
             sky.down(cluster_name)
             return
         except ValueError:
             # The cluster is already down.
             return
         except Exception as e:  # pylint: disable=broad-except
             retry_cnt += 1
             if retry_cnt >= max_retry:
-                raise RuntimeError('Failed to terminate the spot cluster '
-                                   f'{cluster_name}.') from e
-            logger.error('Failed to terminate the spot cluster '
-                         f'{cluster_name}. Retrying.'
-                         f'Details: {common_utils.format_exception(e)}')
+                raise RuntimeError(
+                    f'Failed to terminate the cluster {cluster_name}.') from e
+            logger.error(
+                f'Failed to terminate the cluster {cluster_name}. Retrying.'
+                f'Details: {common_utils.format_exception(e)}')
             with ux_utils.enable_traceback():
                 logger.error(f'  Traceback: {traceback.format_exc()}')
 
 
 class StrategyExecutor:
-    """Handle each launching, recovery and termination of the spot clusters."""
+    """Handle the launching, recovery and termination of managed job clusters"""
 
     RETRY_INIT_GAP_SECONDS = 60
 
     def __init__(self, cluster_name: str, backend: 'backends.Backend',
                  task: 'task_lib.Task', retry_until_up: bool) -> None:
         """Initialize the strategy executor.
 
@@ -79,44 +79,44 @@
         self.dag = sky.Dag()
         self.dag.add(task)
         self.cluster_name = cluster_name
         self.backend = backend
         self.retry_until_up = retry_until_up
 
     def __init_subclass__(cls, name: str, default: bool = False):
-        SPOT_STRATEGIES[name] = cls
+        RECOVERY_STRATEGIES[name] = cls
         if default:
-            global SPOT_DEFAULT_STRATEGY
-            assert SPOT_DEFAULT_STRATEGY is None, (
+            global DEFAULT_RECOVERY_STRATEGY
+            assert DEFAULT_RECOVERY_STRATEGY is None, (
                 'Only one strategy can be default.')
-            SPOT_DEFAULT_STRATEGY = name
+            DEFAULT_RECOVERY_STRATEGY = name
 
     @classmethod
     def make(cls, cluster_name: str, backend: 'backends.Backend',
              task: 'task_lib.Task', retry_until_up: bool) -> 'StrategyExecutor':
         """Create a strategy from a task."""
 
         resource_list = list(task.resources)
-        spot_recovery = resource_list[0].spot_recovery
+        job_recovery = resource_list[0].job_recovery
         for resource in resource_list:
-            if resource.spot_recovery != spot_recovery:
+            if resource.job_recovery != job_recovery:
                 raise ValueError(
-                    'The spot recovery strategy should be the same for all '
+                    'The job recovery strategy should be the same for all '
                     'resources.')
-        # Remove the spot_recovery field from the resources, as the strategy
+        # Remove the job_recovery field from the resources, as the strategy
         # will be handled by the strategy class.
-        new_resources_list = [r.copy(spot_recovery=None) for r in resource_list]
+        new_resources_list = [r.copy(job_recovery=None) for r in resource_list]
         # set the new_task_resources to be the same type (list or set) as the
         # original task.resources
         task.set_resources(type(task.resources)(new_resources_list))
-        return SPOT_STRATEGIES[spot_recovery](cluster_name, backend, task,
-                                              retry_until_up)
+        return RECOVERY_STRATEGIES[job_recovery](cluster_name, backend, task,
+                                                 retry_until_up)
 
     def launch(self) -> float:
-        """Launch the spot cluster for the first time.
+        """Launch the cluster for the first time.
 
         It can fail if resource is not available. Need to check the cluster
         status, after calling.
 
         Returns: The job's submit timestamp, on success (otherwise, an
             exception is raised).
 
@@ -127,15 +127,15 @@
             job_submit_at = self._launch(max_retry=None)
         else:
             job_submit_at = self._launch()
         assert job_submit_at is not None
         return job_submit_at
 
     def recover(self) -> float:
-        """Relaunch the spot cluster after failure and wait until job starts.
+        """Relaunch the cluster after failure and wait until job starts.
 
         When recover() is called the cluster should be in STOPPED status (i.e.
         partially down).
 
         Returns: The timestamp job started.
         """
         raise NotImplementedError
@@ -210,41 +210,41 @@
                 logger.info('The cluster is preempted before the job '
                             'is submitted.')
                 # TODO(zhwu): we should recover the preemption with the
                 # recovery strategy instead of the current while loop.
                 break
 
             try:
-                status = spot_utils.get_job_status(self.backend,
-                                                   self.cluster_name)
+                status = managed_job_utils.get_job_status(
+                    self.backend, self.cluster_name)
             except Exception as e:  # pylint: disable=broad-except
                 # If any unexpected error happens, retry the job checking
                 # loop.
                 # Note: the CommandError is already handled in the
                 # get_job_status, so it should not happen here.
                 # TODO(zhwu): log the unexpected error to usage collection
                 # for future debugging.
                 logger.info(f'Unexpected exception: {e}\nFailed to get the '
                             'job status. Retrying.')
                 continue
 
             # Check the job status until it is not in initialized status
             if status is not None and status > job_lib.JobStatus.INIT:
                 try:
-                    job_submitted_at = spot_utils.get_job_timestamp(
+                    job_submitted_at = managed_job_utils.get_job_timestamp(
                         self.backend, self.cluster_name, get_end_time=False)
                     return job_submitted_at
                 except Exception as e:  # pylint: disable=broad-except
                     # If we failed to get the job timestamp, we will retry
                     # job checking loop.
                     logger.info(f'Unexpected Exception: {e}\nFailed to get '
                                 'the job start timestamp. Retrying.')
                     continue
             # Wait for the job to be started
-            time.sleep(spot_utils.JOB_STARTED_STATUS_CHECK_GAP_SECONDS)
+            time.sleep(managed_job_utils.JOB_STARTED_STATUS_CHECK_GAP_SECONDS)
         return None
 
     def _launch(self,
                 max_retry: Optional[int] = 3,
                 raise_on_failure: bool = True) -> Optional[float]:
         """Implementation of launch().
 
@@ -289,16 +289,16 @@
                 usage_lib.messages.usage.set_internal()
                 # Detach setup, so that the setup failure can be detected
                 # by the controller process (job_status -> FAILED_SETUP).
                 sky.launch(self.dag,
                            cluster_name=self.cluster_name,
                            detach_setup=True,
                            detach_run=True,
-                           _is_launched_by_spot_controller=True)
-                logger.info('Spot cluster launched.')
+                           _is_launched_by_jobs_controller=True)
+                logger.info('Managed job cluster launched.')
             except (exceptions.InvalidClusterNameError,
                     exceptions.NoCloudAccessError,
                     exceptions.ResourcesMismatchError) as e:
                 logger.error('Failure happened before provisioning. '
                              f'{common_utils.format_exception(e)}')
                 if raise_on_failure:
                     raise exceptions.ProvisionPrechecksError(reasons=[e])
@@ -326,49 +326,49 @@
                     logger.error(
                         'Failure happened before provisioning. Failover '
                         f'reasons: {reasons_str}')
                     if raise_on_failure:
                         raise exceptions.ProvisionPrechecksError(
                             reasons=reasons)
                     return None
-                logger.info('Failed to launch the spot cluster with error: '
+                logger.info('Failed to launch a cluster with error: '
                             f'{common_utils.format_exception(e)})')
             except Exception as e:  # pylint: disable=broad-except
                 # If the launch fails, it will be recovered by the following
                 # code.
-                logger.info('Failed to launch the spot cluster with error: '
+                logger.info('Failed to launch a cluster with error: '
                             f'{common_utils.format_exception(e)})')
                 with ux_utils.enable_traceback():
                     logger.info(f'  Traceback: {traceback.format_exc()}')
             else:  # No exception, the launch succeeds.
                 # At this point, a sky.launch() has succeeded. Cluster may be
                 # UP (no preemption since) or DOWN (newly preempted).
                 job_submitted_at = self._wait_until_job_starts_on_cluster()
                 if job_submitted_at is not None:
                     return job_submitted_at
-                # The job fails to start on the spot cluster, retry the launch.
+                # The job fails to start on the cluster, retry the launch.
                 # TODO(zhwu): log the unexpected error to usage collection
                 # for future debugging.
                 logger.info(
                     'Failed to successfully submit the job to the '
                     'launched cluster, due to unexpected submission errors or '
                     'the cluster being preempted during job submission.')
 
             terminate_cluster(self.cluster_name)
             if max_retry is not None and retry_cnt >= max_retry:
                 # Retry forever if max_retry is None.
                 if raise_on_failure:
                     with ux_utils.print_exception_no_traceback():
-                        raise exceptions.SpotJobReachedMaxRetriesError(
-                            'Resources unavailable: failed to launch the spot '
-                            f'cluster after {max_retry} retries.')
+                        raise exceptions.ManagedJobReachedMaxRetriesError(
+                            'Resources unavailable: failed to launch clusters '
+                            f'after {max_retry} retries.')
                 else:
                     return None
             gap_seconds = backoff.current_backoff()
-            logger.info('Retrying to launch the spot cluster in '
+            logger.info('Retrying to launch the cluster in '
                         f'{gap_seconds:.1f} seconds.')
             time.sleep(gap_seconds)
 
 
 class FailoverStrategyExecutor(StrategyExecutor, name='FAILOVER',
                                default=False):
     """Failover strategy: wait in same region and failover after timeout."""
@@ -425,35 +425,35 @@
                 job_submitted_at = self._launch(raise_on_failure=False)
                 # Restore the original dag, i.e. reset the region constraint.
                 task.set_resources(original_resources)
                 if job_submitted_at is not None:
                     return job_submitted_at
 
             # Step 2
-            logger.debug('Terminating unhealthy spot cluster and '
-                         'reset cloud region.')
+            logger.debug('Terminating unhealthy cluster and reset cloud '
+                         'region.')
             terminate_cluster(self.cluster_name)
 
             # Step 3
             logger.debug('Relaunch the cluster  without constraining to prior '
                          'cloud/region.')
             # Not using self.launch to avoid the retry until up logic.
             job_submitted_at = self._launch(max_retry=self._MAX_RETRY_CNT,
                                             raise_on_failure=False)
             if job_submitted_at is None:
                 # Failed to launch the cluster.
                 if self.retry_until_up:
                     gap_seconds = self.RETRY_INIT_GAP_SECONDS
-                    logger.info('Retrying to recover the spot cluster in '
+                    logger.info('Retrying to recover the cluster in '
                                 f'{gap_seconds:.1f} seconds.')
                     time.sleep(gap_seconds)
                     continue
                 with ux_utils.print_exception_no_traceback():
                     raise exceptions.ResourcesUnavailableError(
-                        f'Failed to recover the spot cluster after retrying '
+                        f'Failed to recover the cluster after retrying '
                         f'{self._MAX_RETRY_CNT} times.')
 
             return job_submitted_at
 
 
 class EagerFailoverStrategyExecutor(FailoverStrategyExecutor,
                                     name='EAGER_NEXT_REGION',
@@ -489,16 +489,15 @@
         # 3. (If step 2 failed) Retry forever: Launch again with no blocked
         # locations (this will failover through the entire search space)
         #
         # The entire search space is defined by the original task request,
         # task.resources.
 
         # Step 1
-        logger.debug('Terminating unhealthy spot cluster and '
-                     'reset cloud region.')
+        logger.debug('Terminating unhealthy cluster and reset cloud region.')
         terminate_cluster(self.cluster_name)
 
         # Step 2
         logger.debug('Relaunch the cluster skipping the previously launched '
                      'cloud/region.')
         if self._launched_resources is not None:
             task = self.dag.tasks[0]
@@ -528,17 +527,17 @@
             # Not using self.launch to avoid the retry until up logic.
             job_submitted_at = self._launch(max_retry=self._MAX_RETRY_CNT,
                                             raise_on_failure=False)
             if job_submitted_at is None:
                 # Failed to launch the cluster.
                 if self.retry_until_up:
                     gap_seconds = self.RETRY_INIT_GAP_SECONDS
-                    logger.info('Retrying to recover the spot cluster in '
+                    logger.info('Retrying to recover the cluster in '
                                 f'{gap_seconds:.1f} seconds.')
                     time.sleep(gap_seconds)
                     continue
                 with ux_utils.print_exception_no_traceback():
                     raise exceptions.ResourcesUnavailableError(
-                        f'Failed to recover the spot cluster after retrying '
+                        f'Failed to recover the cluster after retrying '
                         f'{self._MAX_RETRY_CNT} times.')
 
             return job_submitted_at
```

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/spot/spot_state.py` & `skypilot_nightly-1.0.0.dev20240505/sky/jobs/state.py`

 * *Files 8% similar despite different names*

```diff
@@ -1,8 +1,8 @@
-"""The database for spot jobs status."""
+"""The database for managed jobs status."""
 # TODO(zhwu): maybe use file based status instead of database, so
 # that we can easily switch to a s3-based storage.
 import enum
 import pathlib
 import sqlite3
 import time
 import typing
@@ -26,17 +26,19 @@
 _DB_PATH = str(_DB_PATH)
 
 # Module-level connection/cursor; thread-safe as the module is only imported
 # once.
 _CONN = sqlite3.connect(_DB_PATH)
 _CURSOR = _CONN.cursor()
 
+# === Database schema ===
 # `spot` table contains all the finest-grained tasks, including all the
-# tasks of a spot job. All tasks of the same job will have the same
-# `spot_job_id`.
+# tasks of a managed job (called spot for legacy reason, as it is generalized
+# from the previous managed spot jobs). All tasks of the same job will have the
+# same `spot_job_id`.
 # The `job_name` column is now deprecated. It now holds the task's name, i.e.,
 # the same content as the `task_name` column.
 # The `job_id` is now not really a job id, but a only a unique
 # identifier/primary key for all the tasks. We will use `spot_job_id`
 # to identify the spot job.
 # TODO(zhwu): schema migration may be needed.
 _CURSOR.execute("""\
@@ -56,15 +58,15 @@
     spot_job_id INTEGER,
     task_id INTEGER DEFAULT 0,
     task_name TEXT)""")
 _CONN.commit()
 
 db_utils.add_column_to_table(_CURSOR, _CONN, 'spot', 'failure_reason', 'TEXT')
 # Create a new column `spot_job_id`, which is the same for tasks of the
-# same spot job.
+# same managed job.
 # The original `job_id` no longer has an actual meaning, but only a legacy
 # identifier for all tasks in database.
 db_utils.add_column_to_table(_CURSOR,
                              _CONN,
                              'spot',
                              'spot_job_id',
                              'INTEGER',
@@ -95,15 +97,15 @@
 # and recovery time.
 # If the job is not finished:
 # total_job_duration = now() - last_recovered_at + job_duration
 # If the job is not finished:
 # total_job_duration = end_at - last_recovered_at + job_duration
 #
 # Column names to be used in the jobs dict returned to the caller,
-# e.g., via sky spot queue. These may not correspond to actual
+# e.g., via sky jobs queue. These may not correspond to actual
 # column names in the DB and it corresponds to the combined view
 # by joining the spot and job_info tables.
 columns = [
     '_job_id',
     '_task_name',
     'resources',
     'submitted_at',
@@ -120,136 +122,136 @@
     'task_name',
     # columns from the job_info table
     '_job_info_job_id',  # This should be the same as job_id
     'job_name'
 ]
 
 
-class SpotStatus(enum.Enum):
-    """Spot job status, designed to be in serverless style.
+class ManagedJobStatus(enum.Enum):
+    """Managed job status, designed to be in serverless style.
 
-    The SpotStatus is a higher level status than the JobStatus.
-    Each spot job submitted to the spot cluster, will have a JobStatus
-    on that spot cluster:
+    The ManagedJobStatus is a higher level status than the JobStatus.
+    Each managed job submitted to a cluster will have a JobStatus
+    on that cluster:
         JobStatus = [INIT, SETTING_UP, PENDING, RUNNING, ...]
-    Whenever the spot cluster is preempted and recovered, the JobStatus
+    Whenever the cluster is preempted and recovered, the JobStatus
     will go through the statuses above again.
-    That means during the lifetime of a spot job, its JobsStatus could be
+    That means during the lifetime of a managed job, its JobsStatus could be
     reset to INIT or SETTING_UP multiple times (depending on the preemptions).
 
-    However, a spot job only has one SpotStatus on the spot controller.
-        SpotStatus = [PENDING, SUBMITTED, STARTING, RUNNING, ...]
-    Mapping from JobStatus to SpotStatus:
+    However, a managed job only has one ManagedJobStatus on the jobs controller.
+        ManagedJobStatus = [PENDING, SUBMITTED, STARTING, RUNNING, ...]
+    Mapping from JobStatus to ManagedJobStatus:
         INIT            ->  STARTING/RECOVERING
         SETTING_UP      ->  RUNNING
         PENDING         ->  RUNNING
         RUNNING         ->  RUNNING
         SUCCEEDED       ->  SUCCEEDED
         FAILED          ->  FAILED
         FAILED_SETUP    ->  FAILED_SETUP
-    Note that the JobStatus will not be stuck in PENDING, because each spot
-    cluster is dedicated to a spot job, i.e. there should always be enough
-    resource to run the job and the job will be immediately transitioned to
-    RUNNING.
+    Note that the JobStatus will not be stuck in PENDING, because each cluster
+    is dedicated to a managed job, i.e. there should always be enough resource
+    to run the job and the job will be immediately transitioned to RUNNING.
     """
-    # PENDING: Waiting for the spot controller to have a slot to run the
+    # PENDING: Waiting for the jobs controller to have a slot to run the
     # controller process.
-    # The submitted_at timestamp of the spot job in the 'spot' table will be
+    # The submitted_at timestamp of the managed job in the 'spot' table will be
     # set to the time when the job is firstly submitted by the user (set to
     # PENDING).
     PENDING = 'PENDING'
-    # SUBMITTED: The spot controller starts the controller process.
+    # SUBMITTED: The jobs controller starts the controller process.
     SUBMITTED = 'SUBMITTED'
-    # STARTING: The controller process is launching the spot cluster for
-    # the spot job.
+    # STARTING: The controller process is launching the cluster for the managed
+    # job.
     STARTING = 'STARTING'
-    # RUNNING: The job is submitted to the spot cluster, and is setting up
-    # or running.
-    # The start_at timestamp of the spot job in the 'spot' table will be set
+    # RUNNING: The job is submitted to the cluster, and is setting up or
+    # running.
+    # The start_at timestamp of the managed job in the 'spot' table will be set
     # to the time when the job is firstly transitioned to RUNNING.
     RUNNING = 'RUNNING'
-    # RECOVERING: The spot cluster is preempted, and the controller process
-    # is recovering the spot cluster (relaunching/failover).
+    # RECOVERING: The cluster is preempted, and the controller process is
+    # recovering the cluster (relaunching/failover).
     RECOVERING = 'RECOVERING'
     # Terminal statuses
     # SUCCEEDED: The job is finished successfully.
     SUCCEEDED = 'SUCCEEDED'
     # CANCELLING: The job is requested to be cancelled by the user, and the
-    # controller is cleaning up the spot cluster.
+    # controller is cleaning up the cluster.
     CANCELLING = 'CANCELLING'
-    # CANCELLED: The job is cancelled by the user. When the spot job is in
-    # CANCELLED status, the spot cluster has been cleaned up.
+    # CANCELLED: The job is cancelled by the user. When the managed job is in
+    # CANCELLED status, the cluster has been cleaned up.
     CANCELLED = 'CANCELLED'
     # FAILED: The job is finished with failure from the user's program.
     FAILED = 'FAILED'
     # FAILED_SETUP: The job is finished with failure from the user's setup
     # script.
     FAILED_SETUP = 'FAILED_SETUP'
     # FAILED_PRECHECKS: the underlying `sky.launch` fails due to precheck
     # errors only. I.e., none of the failover exceptions, if any, is due to
     # resources unavailability. This exception includes the following cases:
     # 1. The optimizer cannot find a feasible solution.
     # 2. Precheck errors: invalid cluster name, failure in getting cloud user
     #    identity, or unsupported feature.
     FAILED_PRECHECKS = 'FAILED_PRECHECKS'
     # FAILED_NO_RESOURCE: The job is finished with failure because there is no
-    # resource available in the cloud provider(s) to launch the spot cluster.
+    # resource available in the cloud provider(s) to launch the cluster.
     FAILED_NO_RESOURCE = 'FAILED_NO_RESOURCE'
     # FAILED_CONTROLLER: The job is finished with failure because of unexpected
     # error in the controller process.
     FAILED_CONTROLLER = 'FAILED_CONTROLLER'
 
     def is_terminal(self) -> bool:
         return self in self.terminal_statuses()
 
     def is_failed(self) -> bool:
         return self in self.failure_statuses()
 
-    def colored_str(self):
+    def colored_str(self) -> str:
         color = _SPOT_STATUS_TO_COLOR[self]
         return f'{color}{self.value}{colorama.Style.RESET_ALL}'
 
-    def __lt__(self, other):
-        return list(SpotStatus).index(self) < list(SpotStatus).index(other)
+    def __lt__(self, other) -> bool:
+        status_list = list(ManagedJobStatus)
+        return status_list.index(self) < status_list.index(other)
 
     @classmethod
-    def terminal_statuses(cls) -> List['SpotStatus']:
+    def terminal_statuses(cls) -> List['ManagedJobStatus']:
         return [
             cls.SUCCEEDED,
             cls.FAILED,
             cls.FAILED_SETUP,
             cls.FAILED_PRECHECKS,
             cls.FAILED_NO_RESOURCE,
             cls.FAILED_CONTROLLER,
             cls.CANCELLING,
             cls.CANCELLED,
         ]
 
     @classmethod
-    def failure_statuses(cls) -> List['SpotStatus']:
+    def failure_statuses(cls) -> List['ManagedJobStatus']:
         return [
             cls.FAILED, cls.FAILED_SETUP, cls.FAILED_PRECHECKS,
             cls.FAILED_NO_RESOURCE, cls.FAILED_CONTROLLER
         ]
 
 
 _SPOT_STATUS_TO_COLOR = {
-    SpotStatus.PENDING: colorama.Fore.BLUE,
-    SpotStatus.SUBMITTED: colorama.Fore.BLUE,
-    SpotStatus.STARTING: colorama.Fore.BLUE,
-    SpotStatus.RUNNING: colorama.Fore.GREEN,
-    SpotStatus.RECOVERING: colorama.Fore.CYAN,
-    SpotStatus.SUCCEEDED: colorama.Fore.GREEN,
-    SpotStatus.FAILED: colorama.Fore.RED,
-    SpotStatus.FAILED_PRECHECKS: colorama.Fore.RED,
-    SpotStatus.FAILED_SETUP: colorama.Fore.RED,
-    SpotStatus.FAILED_NO_RESOURCE: colorama.Fore.RED,
-    SpotStatus.FAILED_CONTROLLER: colorama.Fore.RED,
-    SpotStatus.CANCELLING: colorama.Fore.YELLOW,
-    SpotStatus.CANCELLED: colorama.Fore.YELLOW,
+    ManagedJobStatus.PENDING: colorama.Fore.BLUE,
+    ManagedJobStatus.SUBMITTED: colorama.Fore.BLUE,
+    ManagedJobStatus.STARTING: colorama.Fore.BLUE,
+    ManagedJobStatus.RUNNING: colorama.Fore.GREEN,
+    ManagedJobStatus.RECOVERING: colorama.Fore.CYAN,
+    ManagedJobStatus.SUCCEEDED: colorama.Fore.GREEN,
+    ManagedJobStatus.FAILED: colorama.Fore.RED,
+    ManagedJobStatus.FAILED_PRECHECKS: colorama.Fore.RED,
+    ManagedJobStatus.FAILED_SETUP: colorama.Fore.RED,
+    ManagedJobStatus.FAILED_NO_RESOURCE: colorama.Fore.RED,
+    ManagedJobStatus.FAILED_CONTROLLER: colorama.Fore.RED,
+    ManagedJobStatus.CANCELLING: colorama.Fore.YELLOW,
+    ManagedJobStatus.CANCELLED: colorama.Fore.YELLOW,
 }
 
 
 # === Status transition functions ===
 def set_job_name(job_id: int, name: str):
     with db_utils.safe_cursor(_DB_PATH) as cursor:
         cursor.execute(
@@ -264,136 +266,143 @@
     with db_utils.safe_cursor(_DB_PATH) as cursor:
         cursor.execute(
             """\
             INSERT INTO spot
             (spot_job_id, task_id, task_name, resources, status)
             VALUES (?, ?, ?, ?, ?)""",
             (job_id, task_id, task_name, resources_str,
-             SpotStatus.PENDING.value))
+             ManagedJobStatus.PENDING.value))
 
 
 def set_submitted(job_id: int, task_id: int, run_timestamp: str,
                   submit_time: float, resources_str: str,
                   callback_func: CallbackType):
     """Set the task to submitted.
 
     Args:
-        job_id: The spot job ID.
+        job_id: The managed job ID.
         task_id: The task ID.
         run_timestamp: The run_timestamp of the run. This will be used to
-            determine the log directory of the spot task.
-        submit_time: The time when the spot task is submitted.
-        resources_str: The resources string of the spot task.
+            determine the log directory of the managed task.
+        submit_time: The time when the managed task is submitted.
+        resources_str: The resources string of the managed task.
     """
     # Use the timestamp in the `run_timestamp` ('sky-2022-10...'), to make
     # the log directory and submission time align with each other, so as to
     # make it easier to find them based on one of the values.
     # Also, using the earlier timestamp should be closer to the term
-    # `submit_at`, which represents the time the spot task is submitted.
+    # `submit_at`, which represents the time the managed task is submitted.
     with db_utils.safe_cursor(_DB_PATH) as cursor:
         cursor.execute(
             """\
             UPDATE spot SET
             resources=(?),
             submitted_at=(?),
             status=(?),
             run_timestamp=(?)
             WHERE spot_job_id=(?) AND
             task_id=(?)""",
-            (resources_str, submit_time, SpotStatus.SUBMITTED.value,
+            (resources_str, submit_time, ManagedJobStatus.SUBMITTED.value,
              run_timestamp, job_id, task_id))
     callback_func('SUBMITTED')
 
 
 def set_starting(job_id: int, task_id: int, callback_func: CallbackType):
     """Set the task to starting state."""
     logger.info('Launching the spot cluster...')
     with db_utils.safe_cursor(_DB_PATH) as cursor:
         cursor.execute(
             """\
             UPDATE spot SET status=(?)
             WHERE spot_job_id=(?) AND
-            task_id=(?)""", (SpotStatus.STARTING.value, job_id, task_id))
+            task_id=(?)""", (ManagedJobStatus.STARTING.value, job_id, task_id))
     callback_func('STARTING')
 
 
 def set_started(job_id: int, task_id: int, start_time: float,
                 callback_func: CallbackType):
     """Set the task to started state."""
     logger.info('Job started.')
     with db_utils.safe_cursor(_DB_PATH) as cursor:
         cursor.execute(
             """\
             UPDATE spot SET status=(?), start_at=(?), last_recovered_at=(?)
             WHERE spot_job_id=(?) AND
             task_id=(?)""",
-            (SpotStatus.RUNNING.value, start_time, start_time, job_id, task_id))
+            (
+                ManagedJobStatus.RUNNING.value,
+                start_time,
+                start_time,
+                job_id,
+                task_id,
+            ),
+        )
     callback_func('STARTED')
 
 
 def set_recovering(job_id: int, task_id: int, callback_func: CallbackType):
     """Set the task to recovering state, and update the job duration."""
     logger.info('=== Recovering... ===')
     with db_utils.safe_cursor(_DB_PATH) as cursor:
         cursor.execute(
             """\
                 UPDATE spot SET
                 status=(?), job_duration=job_duration+(?)-last_recovered_at
                 WHERE spot_job_id=(?) AND
                 task_id=(?)""",
-            (SpotStatus.RECOVERING.value, time.time(), job_id, task_id))
+            (ManagedJobStatus.RECOVERING.value, time.time(), job_id, task_id))
     callback_func('RECOVERING')
 
 
 def set_recovered(job_id: int, task_id: int, recovered_time: float,
                   callback_func: CallbackType):
     """Set the task to recovered."""
     with db_utils.safe_cursor(_DB_PATH) as cursor:
         cursor.execute(
             """\
             UPDATE spot SET
             status=(?), last_recovered_at=(?), recovery_count=recovery_count+1
             WHERE spot_job_id=(?) AND
             task_id=(?)""",
-            (SpotStatus.RUNNING.value, recovered_time, job_id, task_id))
+            (ManagedJobStatus.RUNNING.value, recovered_time, job_id, task_id))
     logger.info('==== Recovered. ====')
     callback_func('RECOVERED')
 
 
 def set_succeeded(job_id: int, task_id: int, end_time: float,
                   callback_func: CallbackType):
     """Set the task to succeeded, if it is in a non-terminal state."""
     with db_utils.safe_cursor(_DB_PATH) as cursor:
         cursor.execute(
             """\
             UPDATE spot SET
             status=(?), end_at=(?)
             WHERE spot_job_id=(?) AND task_id=(?)
             AND end_at IS null""",
-            (SpotStatus.SUCCEEDED.value, end_time, job_id, task_id))
+            (ManagedJobStatus.SUCCEEDED.value, end_time, job_id, task_id))
 
     callback_func('SUCCEEDED')
     logger.info('Job succeeded.')
 
 
 def set_failed(
     job_id: int,
     task_id: Optional[int],
-    failure_type: SpotStatus,
+    failure_type: ManagedJobStatus,
     failure_reason: str,
     callback_func: Optional[CallbackType] = None,
     end_time: Optional[float] = None,
 ):
     """Set an entire job or task to failed, if they are in non-terminal states.
 
     Args:
         job_id: The job id.
         task_id: The task id. If None, all non-finished tasks of the job will
             be set to failed.
-        failure_type: The failure type. One of SpotStatus.FAILED_*.
+        failure_type: The failure type. One of ManagedJobStatus.FAILED_*.
         failure_reason: The failure reason.
         end_time: The end time. If None, the current time will be used.
     """
     assert failure_type.is_failed(), failure_type
     end_time = time.time() if end_time is None else end_time
 
     fields_to_set = {
@@ -401,16 +410,16 @@
         'status': failure_type.value,
         'failure_reason': failure_reason,
     }
     with db_utils.safe_cursor(_DB_PATH) as cursor:
         previous_status = cursor.execute(
             'SELECT status FROM spot WHERE spot_job_id=(?)',
             (job_id,)).fetchone()
-        previous_status = SpotStatus(previous_status[0])
-        if previous_status in [SpotStatus.RECOVERING]:
+        previous_status = ManagedJobStatus(previous_status[0])
+        if previous_status in [ManagedJobStatus.RECOVERING]:
             # If the job is recovering, we should set the
             # last_recovered_at to the end_time, so that the
             # end_at - last_recovered_at will not be affect the job duration
             # calculation.
             fields_to_set['last_recovered_at'] = end_time
         set_str = ', '.join(f'{k}=(?)' for k in fields_to_set)
         task_str = '' if task_id is None else f' AND task_id={task_id}'
@@ -434,15 +443,15 @@
     """
     with db_utils.safe_cursor(_DB_PATH) as cursor:
         rows = cursor.execute(
             """\
             UPDATE spot SET
             status=(?), end_at=(?)
             WHERE spot_job_id=(?) AND end_at IS null""",
-            (SpotStatus.CANCELLING.value, time.time(), job_id))
+            (ManagedJobStatus.CANCELLING.value, time.time(), job_id))
         if rows.rowcount > 0:
             logger.info('Cancelling the job...')
             callback_func('CANCELLING')
 
 
 def set_cancelled(job_id: int, callback_func: CallbackType):
     """Set tasks in the job as cancelled, if they are in CANCELLING state.
@@ -451,38 +460,40 @@
     """
     with db_utils.safe_cursor(_DB_PATH) as cursor:
         rows = cursor.execute(
             """\
             UPDATE spot SET
             status=(?), end_at=(?)
             WHERE spot_job_id=(?) AND status=(?)""",
-            (SpotStatus.CANCELLED.value, time.time(), job_id,
-             SpotStatus.CANCELLING.value))
+            (ManagedJobStatus.CANCELLED.value, time.time(), job_id,
+             ManagedJobStatus.CANCELLING.value))
         if rows.rowcount > 0:
             logger.info('Job cancelled.')
             callback_func('CANCELLED')
 
 
 # ======== utility functions ========
 def get_nonterminal_job_ids_by_name(name: Optional[str]) -> List[int]:
     """Get non-terminal job ids by name."""
-    statuses = ', '.join(['?'] * len(SpotStatus.terminal_statuses()))
-    field_values = [status.value for status in SpotStatus.terminal_statuses()]
+    statuses = ', '.join(['?'] * len(ManagedJobStatus.terminal_statuses()))
+    field_values = [
+        status.value for status in ManagedJobStatus.terminal_statuses()
+    ]
 
     name_filter = ''
     if name is not None:
         # We match the job name from `job_info` for the jobs submitted after
         # #1982, and from `spot` for the jobs submitted before #1982, whose
         # job_info is not available.
         name_filter = ('AND (job_info.name=(?) OR '
                        '(job_info.name IS NULL AND spot.task_name=(?)))')
         field_values.extend([name, name])
 
     # Left outer join is used here instead of join, because the job_info does
-    # not contain the spot jobs submitted before #1982.
+    # not contain the managed jobs submitted before #1982.
     with db_utils.safe_cursor(_DB_PATH) as cursor:
         rows = cursor.execute(
             f"""\
             SELECT DISTINCT spot.spot_job_id
             FROM spot
             LEFT OUTER JOIN job_info
             ON spot.spot_job_id=job_info.spot_job_id
@@ -490,50 +501,51 @@
             ({statuses})
             {name_filter}
             ORDER BY spot.spot_job_id DESC""", field_values).fetchall()
         job_ids = [row[0] for row in rows if row[0] is not None]
         return job_ids
 
 
-def _get_all_task_ids_statuses(job_id: int) -> List[Tuple[int, SpotStatus]]:
+def _get_all_task_ids_statuses(
+        job_id: int) -> List[Tuple[int, ManagedJobStatus]]:
     with db_utils.safe_cursor(_DB_PATH) as cursor:
         id_statuses = cursor.execute(
             """\
             SELECT task_id, status FROM spot
             WHERE spot_job_id=(?)
             ORDER BY task_id ASC""", (job_id,)).fetchall()
-        return [(row[0], SpotStatus(row[1])) for row in id_statuses]
+        return [(row[0], ManagedJobStatus(row[1])) for row in id_statuses]
 
 
 def get_num_tasks(job_id: int) -> int:
     return len(_get_all_task_ids_statuses(job_id))
 
 
 def get_latest_task_id_status(
-        job_id: int) -> Union[Tuple[int, SpotStatus], Tuple[None, None]]:
+        job_id: int) -> Union[Tuple[int, ManagedJobStatus], Tuple[None, None]]:
     """Returns the (task id, status) of the latest task of a job.
 
-    The latest means the task that is currently being executed or to be
-    started by the controller process. For example, in a spot job with
-    3 tasks, the first task is succeeded, and the second task is being
-    executed. This will return (1, SpotStatus.RUNNING).
+    The latest means the task that is currently being executed or to be started
+    by the controller process. For example, in a managed job with 3 tasks, the
+    first task is succeeded, and the second task is being executed. This will
+    return (1, ManagedJobStatus.RUNNING).
 
     If the job_id does not exist, (None, None) will be returned.
     """
     id_statuses = _get_all_task_ids_statuses(job_id)
     if len(id_statuses) == 0:
         return None, None
     task_id, status = id_statuses[-1]
     for task_id, status in id_statuses:
         if not status.is_terminal():
             break
     return task_id, status
 
 
-def get_status(job_id: int) -> Optional[SpotStatus]:
+def get_status(job_id: int) -> Optional[ManagedJobStatus]:
     _, status = get_latest_task_id_status(job_id)
     return status
 
 
 def get_failure_reason(job_id: int) -> Optional[str]:
     """Get the failure reason of a job.
 
@@ -547,35 +559,35 @@
             ORDER BY task_id ASC""", (job_id,)).fetchall()
         reason = [r[0] for r in reason if r[0] is not None]
         if len(reason) == 0:
             return None
         return reason[0]
 
 
-def get_spot_jobs(job_id: Optional[int] = None) -> List[Dict[str, Any]]:
-    """Get spot clusters' status."""
+def get_managed_jobs(job_id: Optional[int] = None) -> List[Dict[str, Any]]:
+    """Get managed jobs from the database."""
     job_filter = '' if job_id is None else f'WHERE spot.spot_job_id={job_id}'
 
-    # Join the spot and job_info tables to get the job name for each task.
+    # Join spot and job_info tables to get the job name for each task.
     # We use LEFT OUTER JOIN mainly for backward compatibility, as for an
     # existing controller before #1982, the job_info table may not exist,
-    # and all the spot jobs created before will not present in the
+    # and all the managed jobs created before will not present in the
     # job_info.
     with db_utils.safe_cursor(_DB_PATH) as cursor:
         rows = cursor.execute(f"""\
             SELECT *
             FROM spot
             LEFT OUTER JOIN job_info
             ON spot.spot_job_id=job_info.spot_job_id
             {job_filter}
             ORDER BY spot.spot_job_id DESC, spot.task_id ASC""").fetchall()
         jobs = []
         for row in rows:
             job_dict = dict(zip(columns, row))
-            job_dict['status'] = SpotStatus(job_dict['status'])
+            job_dict['status'] = ManagedJobStatus(job_dict['status'])
             if job_dict['job_name'] is None:
                 job_dict['job_name'] = job_dict['task_name']
             jobs.append(job_dict)
         return jobs
 
 
 def get_task_name(job_id: int, task_id: int) -> str:
```

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/spot/spot_utils.py` & `skypilot_nightly-1.0.0.dev20240505/sky/jobs/utils.py`

 * *Files 23% similar despite different names*

```diff
@@ -1,82 +1,89 @@
-"""User interfaces with managed spot jobs."""
+"""User interfaces with managed jobs.
+
+NOTE: whenever an API change is made in this file, we need to bump the
+jobs.constants.MANAGED_JOBS_VERSION and handle the API change in the
+ManagedJobCodeGen.
+"""
 import collections
 import enum
-import json
 import os
 import pathlib
 import shlex
+import shutil
+import textwrap
 import time
 import typing
 from typing import Any, Dict, List, Optional, Tuple, Union
 
 import colorama
 import filelock
 from typing_extensions import Literal
 
 from sky import backends
 from sky import exceptions
 from sky import global_user_state
 from sky import sky_logging
 from sky.backends import backend_utils
+from sky.jobs import constants as managed_job_constants
+from sky.jobs import state as managed_job_state
 from sky.skylet import constants
 from sky.skylet import job_lib
 from sky.skylet.log_lib import run_bash_command_with_log
-from sky.spot import constants as spot_constants
-from sky.spot import spot_state
 from sky.utils import common_utils
 from sky.utils import log_utils
 from sky.utils import rich_utils
 from sky.utils import subprocess_utils
 
 if typing.TYPE_CHECKING:
     import sky
     from sky import dag as dag_lib
 
 logger = sky_logging.init_logger(__name__)
 
 # Add user hash so that two users don't have the same controller VM on
 # shared-account clouds such as GCP.
-SPOT_CONTROLLER_NAME: str = (
+JOB_CONTROLLER_NAME: str = (
+    f'sky-jobs-controller-{common_utils.get_user_hash()}')
+LEGACY_JOB_CONTROLLER_NAME: str = (
     f'sky-spot-controller-{common_utils.get_user_hash()}')
-SIGNAL_FILE_PREFIX = '/tmp/sky_spot_controller_signal_{}'
+SIGNAL_FILE_PREFIX = '/tmp/sky_jobs_controller_signal_{}'
+LEGACY_SIGNAL_FILE_PREFIX = '/tmp/sky_spot_controller_signal_{}'
 # Controller checks its job's status every this many seconds.
 JOB_STATUS_CHECK_GAP_SECONDS = 20
 
 # Controller checks if its job has started every this many seconds.
 JOB_STARTED_STATUS_CHECK_GAP_SECONDS = 5
 
-_SPOT_STATUS_CACHE = '~/.sky/spot_status_cache.txt'
-
 _LOG_STREAM_CHECK_CONTROLLER_GAP_SECONDS = 5
 
 _JOB_WAITING_STATUS_MESSAGE = ('[bold cyan]Waiting for the task to start'
                                '{status_str}.[/] It may take a few minutes.')
 _JOB_CANCELLED_MESSAGE = (
     '[bold cyan]Waiting for the task status to be updated.'
     '[/] It may take a minute.')
 
-# The maximum time to wait for the spot job status to transition to terminal
+# The maximum time to wait for the managed job status to transition to terminal
 # state, after the job finished. This is a safeguard to avoid the case where
-# the spot job status fails to be updated and keep the `sky spot logs` blocking
-# for a long time.
-_FINAL_SPOT_STATUS_WAIT_TIMEOUT_SECONDS = 20
+# the managed job status fails to be updated and keep the `sky jobs logs`
+# blocking for a long time.
+_FINAL_JOB_STATUS_WAIT_TIMEOUT_SECONDS = 20
 
 
 class UserSignal(enum.Enum):
     """The signal to be sent to the user."""
     CANCEL = 'CANCEL'
     # NOTE: We can have more communication signals here if needed
     # in the future.
 
 
 # ====== internal functions ======
 def get_job_status(backend: 'backends.CloudVmRayBackend',
                    cluster_name: str) -> Optional['job_lib.JobStatus']:
-    """Check the status of the job running on the spot cluster.
+    """Check the status of the job running on a managed job cluster.
 
     It can be None, INIT, RUNNING, SUCCEEDED, FAILED, FAILED_SETUP or CANCELLED.
     """
     handle = global_user_state.get_handle_from_cluster_name(cluster_name)
     assert isinstance(handle, backends.CloudVmRayResourceHandle), handle
     status = None
     try:
@@ -89,63 +96,65 @@
             logger.info(f'Job status: {status}')
     except exceptions.CommandError:
         logger.info('Failed to connect to the cluster.')
     logger.info('=' * 34)
     return status
 
 
-def update_spot_job_status(job_id: Optional[int] = None):
-    """Update spot job status if the controller job failed abnormally.
+def update_managed_job_status(job_id: Optional[int] = None):
+    """Update managed job status if the controller job failed abnormally.
 
     Check the status of the controller job. If it is not running, it must have
     exited abnormally, and we should set the job status to FAILED_CONTROLLER.
     `end_at` will be set to the current timestamp for the job when above
     happens, which could be not accurate based on the frequency this function
     is called.
     """
     if job_id is None:
-        job_ids = spot_state.get_nonterminal_job_ids_by_name(None)
+        job_ids = managed_job_state.get_nonterminal_job_ids_by_name(None)
     else:
         job_ids = [job_id]
     for job_id_ in job_ids:
         controller_status = job_lib.get_status(job_id_)
         if controller_status is None or controller_status.is_terminal():
             logger.error(f'Controller for job {job_id_} has exited abnormally. '
                          'Setting the job status to FAILED_CONTROLLER.')
-            tasks = spot_state.get_spot_jobs(job_id_)
+            tasks = managed_job_state.get_managed_jobs(job_id_)
             for task in tasks:
                 task_name = task['job_name']
-                # Tear down the abnormal spot cluster to avoid resource leakage.
-                cluster_name = generate_spot_cluster_name(task_name, job_id_)
+                # Tear down the abnormal cluster to avoid resource leakage.
+                cluster_name = generate_managed_job_cluster_name(
+                    task_name, job_id_)
                 handle = global_user_state.get_handle_from_cluster_name(
                     cluster_name)
                 if handle is not None:
                     backend = backend_utils.get_backend_from_handle(handle)
                     max_retry = 3
                     for retry_cnt in range(max_retry):
                         try:
                             backend.teardown(handle, terminate=True)
                             break
                         except RuntimeError:
-                            logger.error('Failed to tear down the spot cluster '
+                            logger.error('Failed to tear down the cluster '
                                          f'{cluster_name!r}. Retrying '
                                          f'[{retry_cnt}/{max_retry}].')
 
-            # The controller job for this spot job is not running: it must
+            # The controller job for this managed job is not running: it must
             # have exited abnormally, and we should set the job status to
             # FAILED_CONTROLLER.
             # The `set_failed` will only update the task's status if the
             # status is non-terminal.
-            spot_state.set_failed(
+            managed_job_state.set_failed(
                 job_id_,
                 task_id=None,
-                failure_type=spot_state.SpotStatus.FAILED_CONTROLLER,
+                failure_type=managed_job_state.ManagedJobStatus.
+                FAILED_CONTROLLER,
                 failure_reason=
                 'Controller process has exited abnormally. For more details,'
-                f' run: sky spot logs --controller {job_id_}')
+                f' run: sky jobs logs --controller {job_id_}')
 
 
 def get_job_timestamp(backend: 'backends.CloudVmRayBackend', cluster_name: str,
                       get_end_time: bool) -> float:
     """Get the submitted/ended time of the job."""
     code = job_lib.JobLibCodeGen.get_job_submitted_or_ended_timestamp_payload(
         job_id=None, get_ended_time=get_end_time)
@@ -160,113 +169,117 @@
     stdout = common_utils.decode_payload(stdout)
     return float(stdout)
 
 
 def event_callback_func(job_id: int, task_id: int, task: 'sky.Task'):
     """Run event callback for the task."""
 
-    def callback_func(state: str):
+    def callback_func(status: str):
         event_callback = task.event_callback if task else None
         if event_callback is None or task is None:
             return
         event_callback = event_callback.strip()
-        cluster_name = generate_spot_cluster_name(task.name,
-                                                  job_id) if task.name else None
-        logger.info(f'=== START: event callback for {state!r} ===')
-        log_path = os.path.join(constants.SKY_LOGS_DIRECTORY, 'spot_event',
-                                f'spot-callback-{job_id}-{task_id}.log')
+        cluster_name = generate_managed_job_cluster_name(
+            task.name, job_id) if task.name else None
+        logger.info(f'=== START: event callback for {status!r} ===')
+        log_path = os.path.join(constants.SKY_LOGS_DIRECTORY,
+                                'managed_job_event',
+                                f'jobs-callback-{job_id}-{task_id}.log')
         result = run_bash_command_with_log(
             bash_command=event_callback,
             log_path=log_path,
             env_vars=dict(
                 SKYPILOT_TASK_ID=str(
                     task.envs.get(constants.TASK_ID_ENV_VAR, 'N.A.')),
                 SKYPILOT_TASK_IDS=str(
                     task.envs.get(constants.TASK_ID_LIST_ENV_VAR, 'N.A.')),
                 TASK_ID=str(task_id),
                 JOB_ID=str(job_id),
-                JOB_STATUS=state,
+                JOB_STATUS=status,
                 CLUSTER_NAME=cluster_name or '',
                 TASK_NAME=task.name or '',
                 # TODO(MaoZiming): Future event type Job or Spot.
                 EVENT_TYPE='Spot'))
         logger.info(
             f'Bash:{event_callback},log_path:{log_path},result:{result}')
-        logger.info(f'=== END: event callback for {state!r} ===')
+        logger.info(f'=== END: event callback for {status!r} ===')
 
     return callback_func
 
 
 # ======== user functions ========
 
 
-def generate_spot_cluster_name(task_name: str, job_id: int) -> str:
-    """Generate spot cluster name."""
+def generate_managed_job_cluster_name(task_name: str, job_id: int) -> str:
+    """Generate managed job cluster name."""
     # Truncate the task name to 30 chars to avoid the cluster name being too
     # long after appending the job id, which will cause another truncation in
     # the underlying sky.launch, hiding the `job_id` in the cluster name.
     cluster_name = common_utils.make_cluster_name_on_cloud(
         task_name,
-        spot_constants.SPOT_CLUSTER_NAME_PREFIX_LENGTH,
+        managed_job_constants.JOBS_CLUSTER_NAME_PREFIX_LENGTH,
         add_user_hash=False)
     return f'{cluster_name}-{job_id}'
 
 
 def cancel_jobs_by_id(job_ids: Optional[List[int]]) -> str:
     """Cancel jobs by id.
 
     If job_ids is None, cancel all jobs.
     """
     if job_ids is None:
-        job_ids = spot_state.get_nonterminal_job_ids_by_name(None)
+        job_ids = managed_job_state.get_nonterminal_job_ids_by_name(None)
     job_ids = list(set(job_ids))
     if len(job_ids) == 0:
         return 'No job to cancel.'
     job_id_str = ', '.join(map(str, job_ids))
     logger.info(f'Cancelling jobs {job_id_str}.')
     cancelled_job_ids = []
     for job_id in job_ids:
-        # Check the status of the managed spot job status. If it is in
+        # Check the status of the managed job status. If it is in
         # terminal state, we can safely skip it.
-        job_status = spot_state.get_status(job_id)
+        job_status = managed_job_state.get_status(job_id)
         if job_status is None:
             logger.info(f'Job {job_id} not found. Skipped.')
             continue
         elif job_status.is_terminal():
             logger.info(f'Job {job_id} is already in terminal state '
                         f'{job_status.value}. Skipped.')
             continue
 
-        update_spot_job_status(job_id)
+        update_managed_job_status(job_id)
 
-        # Send the signal to the spot job controller.
+        # Send the signal to the jobs controller.
         signal_file = pathlib.Path(SIGNAL_FILE_PREFIX.format(job_id))
+        legacy_signal_file = pathlib.Path(
+            LEGACY_SIGNAL_FILE_PREFIX.format(job_id))
         # Filelock is needed to prevent race condition between signal
         # check/removal and signal writing.
-        # TODO(mraheja): remove pylint disabling when filelock version updated
-        # pylint: disable=abstract-class-instantiated
         with filelock.FileLock(str(signal_file) + '.lock'):
             with signal_file.open('w', encoding='utf-8') as f:
                 f.write(UserSignal.CANCEL.value)
                 f.flush()
+            # Backward compatibility for managed jobs launched before #3419. It
+            # can be removed in the future 0.8.0 release.
+            shutil.copy(str(signal_file), str(legacy_signal_file))
         cancelled_job_ids.append(job_id)
 
     if len(cancelled_job_ids) == 0:
         return 'No job to cancel.'
     identity_str = f'Job with ID {cancelled_job_ids[0]} is'
     if len(cancelled_job_ids) > 1:
         cancelled_job_ids_str = ', '.join(map(str, cancelled_job_ids))
         identity_str = f'Jobs with IDs {cancelled_job_ids_str} are'
 
     return f'{identity_str} scheduled to be cancelled.'
 
 
 def cancel_job_by_name(job_name: str) -> str:
     """Cancel a job by name."""
-    job_ids = spot_state.get_nonterminal_job_ids_by_name(job_name)
+    job_ids = managed_job_state.get_nonterminal_job_ids_by_name(job_name)
     if len(job_ids) == 0:
         return f'No running job found with name {job_name!r}.'
     if len(job_ids) > 1:
         return (f'{colorama.Fore.RED}Multiple running jobs found '
                 f'with name {job_name!r}.\n'
                 f'Job IDs: {job_ids}{colorama.Style.RESET_ALL}')
     cancel_jobs_by_id(job_ids)
@@ -275,15 +288,15 @@
 
 def stream_logs_by_id(job_id: int, follow: bool = True) -> str:
     """Stream logs by job id."""
     controller_status = job_lib.get_status(job_id)
     status_msg = ('[bold cyan]Waiting for controller process to be RUNNING'
                   '{status_str}[/].')
     status_display = rich_utils.safe_status(status_msg.format(status_str=''))
-    num_tasks = spot_state.get_num_tasks(job_id)
+    num_tasks = managed_job_state.get_num_tasks(job_id)
 
     with status_display:
         prev_msg = None
         while (controller_status != job_lib.JobStatus.RUNNING and
                (controller_status is None or
                 not controller_status.is_terminal())):
             status_str = 'None'
@@ -295,74 +308,77 @@
                 prev_msg = msg
             time.sleep(_LOG_STREAM_CHECK_CONTROLLER_GAP_SECONDS)
             controller_status = job_lib.get_status(job_id)
 
         msg = _JOB_WAITING_STATUS_MESSAGE.format(status_str='')
         status_display.update(msg)
         prev_msg = msg
-        spot_job_status = spot_state.get_status(job_id)
-        while spot_job_status is None:
+        managed_job_status = managed_job_state.get_status(job_id)
+        while managed_job_status is None:
             time.sleep(1)
-            spot_job_status = spot_state.get_status(job_id)
+            managed_job_status = managed_job_state.get_status(job_id)
 
-        if spot_job_status.is_terminal():
+        if managed_job_status.is_terminal():
             job_msg = ''
-            if spot_job_status.is_failed():
-                job_msg = (
-                    f'\nFailure reason: {spot_state.get_failure_reason(job_id)}'
-                )
+            if managed_job_status.is_failed():
+                job_msg = ('\nFailure reason: '
+                           f'{managed_job_state.get_failure_reason(job_id)}')
             return (f'{colorama.Fore.YELLOW}'
                     f'Job {job_id} is already in terminal state '
-                    f'{spot_job_status.value}. Logs will not be shown.'
+                    f'{managed_job_status.value}. Logs will not be shown.'
                     f'{colorama.Style.RESET_ALL}{job_msg}')
         backend = backends.CloudVmRayBackend()
-        task_id, spot_status = spot_state.get_latest_task_id_status(job_id)
+        task_id, managed_job_status = (
+            managed_job_state.get_latest_task_id_status(job_id))
 
-        # task_id and spot_status can be None if the controller process just
-        # started and the spot status has not set to PENDING yet.
-        while spot_status is None or not spot_status.is_terminal():
+        # task_id and managed_job_status can be None if the controller process
+        # just started and the managed job status has not set to PENDING yet.
+        while (managed_job_status is None or
+               not managed_job_status.is_terminal()):
             handle = None
             if task_id is not None:
-                task_name = spot_state.get_task_name(job_id, task_id)
-                cluster_name = generate_spot_cluster_name(task_name, job_id)
+                task_name = managed_job_state.get_task_name(job_id, task_id)
+                cluster_name = generate_managed_job_cluster_name(
+                    task_name, job_id)
                 handle = global_user_state.get_handle_from_cluster_name(
                     cluster_name)
 
             # Check the handle: The cluster can be preempted and removed from
-            # the table before the spot state is updated by the controller. In
-            # this case, we should skip the logging, and wait for the next
-            # round of status check.
-            if handle is None or spot_status != spot_state.SpotStatus.RUNNING:
+            # the table before the managed job state is updated by the
+            # controller. In this case, we should skip the logging, and wait for
+            # the next round of status check.
+            if (handle is None or managed_job_status !=
+                    managed_job_state.ManagedJobStatus.RUNNING):
                 status_str = ''
-                if (spot_status is not None and
-                        spot_status != spot_state.SpotStatus.RUNNING):
-                    status_str = f' (status: {spot_status.value})'
+                if (managed_job_status is not None and managed_job_status !=
+                        managed_job_state.ManagedJobStatus.RUNNING):
+                    status_str = f' (status: {managed_job_status.value})'
                 logger.debug(
                     f'INFO: The log is not ready yet{status_str}. '
                     f'Waiting for {JOB_STATUS_CHECK_GAP_SECONDS} seconds.')
                 msg = _JOB_WAITING_STATUS_MESSAGE.format(status_str=status_str)
                 if msg != prev_msg:
                     status_display.update(msg)
                     prev_msg = msg
                 time.sleep(JOB_STATUS_CHECK_GAP_SECONDS)
-                task_id, spot_status = (
-                    spot_state.get_latest_task_id_status(job_id))
+                task_id, managed_job_status = (
+                    managed_job_state.get_latest_task_id_status(job_id))
                 continue
-            assert spot_status is not None
+            assert managed_job_status is not None
             assert isinstance(handle, backends.CloudVmRayResourceHandle), handle
             status_display.stop()
             returncode = backend.tail_logs(handle,
                                            job_id=None,
-                                           spot_job_id=job_id,
+                                           managed_job_id=job_id,
                                            follow=follow)
             if returncode == 0:
                 # If the log tailing exit successfully (the real job can be
                 # SUCCEEDED or FAILED), we can safely break the loop. We use the
-                # status in job queue to show the information, as the spot_state
-                # is not updated yet.
+                # status in job queue to show the information, as the
+                # ManagedJobStatus is not updated yet.
                 job_statuses = backend.get_job_status(handle, stream_logs=False)
                 job_status = list(job_statuses.values())[0]
                 assert job_status is not None, 'No job found.'
                 if job_status != job_lib.JobStatus.CANCELLED:
                     assert task_id is not None, job_id
                     if task_id < num_tasks - 1 and follow:
                         # The log for the current job is finished. We need to
@@ -372,16 +388,17 @@
                             'is finished. Waiting for the next task\'s log '
                             'to be started.')
                         status_display.update('Waiting for the next task: '
                                               f'{task_id + 1}.')
                         status_display.start()
                         original_task_id = task_id
                         while True:
-                            task_id, spot_status = (
-                                spot_state.get_latest_task_id_status(job_id))
+                            task_id, managed_job_status = (
+                                managed_job_state.get_latest_task_id_status(
+                                    job_id))
                             if original_task_id != task_id:
                                 break
                             time.sleep(JOB_STATUS_CHECK_GAP_SECONDS)
                         continue
                     else:
                         break
                 # The job can be cancelled by the user or the controller (when
@@ -389,110 +406,131 @@
                 logger.debug(
                     'INFO: Job is cancelled. Waiting for the status update in '
                     f'{JOB_STATUS_CHECK_GAP_SECONDS} seconds.')
             else:
                 logger.debug(
                     f'INFO: (Log streaming) Got return code {returncode}. '
                     f'Retrying in {JOB_STATUS_CHECK_GAP_SECONDS} seconds.')
-            # Finish early if the spot status is already in terminal state.
-            spot_status = spot_state.get_status(job_id)
-            assert spot_status is not None, job_id
-            if spot_status.is_terminal():
+            # Finish early if the managed job status is already in terminal
+            # state.
+            managed_job_status = managed_job_state.get_status(job_id)
+            assert managed_job_status is not None, job_id
+            if managed_job_status.is_terminal():
                 break
-            logger.info(f'{colorama.Fore.YELLOW}The job is preempted.'
-                        f'{colorama.Style.RESET_ALL}')
+            logger.info(f'{colorama.Fore.YELLOW}The job cluster is preempted '
+                        f'or failed.{colorama.Style.RESET_ALL}')
             msg = _JOB_CANCELLED_MESSAGE
             status_display.update(msg)
             prev_msg = msg
             status_display.start()
             # If the tailing fails, it is likely that the cluster fails, so we
-            # wait a while to make sure the spot state is updated by the
-            # controller, and check the spot queue again.
+            # wait a while to make sure the managed job state is updated by the
+            # controller, and check the managed job queue again.
             # Wait a bit longer than the controller, so as to make sure the
-            # spot state is updated.
+            # managed job state is updated.
             time.sleep(3 * JOB_STATUS_CHECK_GAP_SECONDS)
-            spot_status = spot_state.get_status(job_id)
+            managed_job_status = managed_job_state.get_status(job_id)
 
-    # The spot_status may not be in terminal status yet, since the controllerhas
-    # not updated the spot state yet. We wait for a while, until the spot state
-    # is updated.
+    # The managed_job_status may not be in terminal status yet, since the
+    # controller has not updated the managed job state yet. We wait for a while,
+    # until the managed job state is updated.
     wait_seconds = 0
-    spot_status = spot_state.get_status(job_id)
-    assert spot_status is not None, job_id
-    while (not spot_status.is_terminal() and follow and
-           wait_seconds < _FINAL_SPOT_STATUS_WAIT_TIMEOUT_SECONDS):
+    managed_job_status = managed_job_state.get_status(job_id)
+    assert managed_job_status is not None, job_id
+    while (not managed_job_status.is_terminal() and follow and
+           wait_seconds < _FINAL_JOB_STATUS_WAIT_TIMEOUT_SECONDS):
         time.sleep(1)
         wait_seconds += 1
-        spot_status = spot_state.get_status(job_id)
-        assert spot_status is not None, job_id
+        managed_job_status = managed_job_state.get_status(job_id)
+        assert managed_job_status is not None, job_id
 
     logger.info(f'Logs finished for job {job_id} '
-                f'(status: {spot_status.value}).')
+                f'(status: {managed_job_status.value}).')
     return ''
 
 
 def stream_logs_by_name(job_name: str, follow: bool = True) -> str:
     """Stream logs by name."""
-    job_ids = spot_state.get_nonterminal_job_ids_by_name(job_name)
+    job_ids = managed_job_state.get_nonterminal_job_ids_by_name(job_name)
     if len(job_ids) == 0:
         return (f'{colorama.Fore.RED}No job found with name {job_name!r}.'
                 f'{colorama.Style.RESET_ALL}')
     if len(job_ids) > 1:
         return (f'{colorama.Fore.RED}Multiple running jobs found '
                 f'with name {job_name!r}.\n'
                 f'Job IDs: {job_ids}{colorama.Style.RESET_ALL}')
     stream_logs_by_id(job_ids[0], follow)
     return ''
 
 
-def dump_spot_job_queue() -> str:
-    jobs = spot_state.get_spot_jobs()
+def dump_managed_job_queue() -> str:
+    jobs = managed_job_state.get_managed_jobs()
 
     for job in jobs:
         end_at = job['end_at']
         if end_at is None:
             end_at = time.time()
 
         job_submitted_at = job['last_recovered_at'] - job['job_duration']
-        if job['status'] == spot_state.SpotStatus.RECOVERING:
+        if job['status'] == managed_job_state.ManagedJobStatus.RECOVERING:
             # When job is recovering, the duration is exact job['job_duration']
             job_duration = job['job_duration']
         elif job_submitted_at > 0:
             job_duration = end_at - job_submitted_at
         else:
             # When job_start_at <= 0, that means the last_recovered_at is not
             # set yet, i.e. the job is not started.
             job_duration = 0
         job['job_duration'] = job_duration
         job['status'] = job['status'].value
 
-        cluster_name = generate_spot_cluster_name(job['task_name'],
-                                                  job['job_id'])
+        cluster_name = generate_managed_job_cluster_name(
+            job['task_name'], job['job_id'])
         handle = global_user_state.get_handle_from_cluster_name(cluster_name)
         if handle is not None:
             assert isinstance(handle, backends.CloudVmRayResourceHandle)
             job['cluster_resources'] = (
                 f'{handle.launched_nodes}x {handle.launched_resources}')
             job['region'] = handle.launched_resources.region
         else:
             # FIXME(zongheng): display the last cached values for these.
             job['cluster_resources'] = '-'
             job['region'] = '-'
 
     return common_utils.encode_payload(jobs)
 
 
-def load_spot_job_queue(payload: str) -> List[Dict[str, Any]]:
+def load_managed_job_queue(payload: str) -> List[Dict[str, Any]]:
     """Load job queue from json string."""
     jobs = common_utils.decode_payload(payload)
     for job in jobs:
-        job['status'] = spot_state.SpotStatus(job['status'])
+        job['status'] = managed_job_state.ManagedJobStatus(job['status'])
     return jobs
 
 
+def _get_job_status_from_tasks(
+    job_tasks: List[Dict[str, Any]]
+) -> Tuple[managed_job_state.ManagedJobStatus, int]:
+    """Get the current task status and the current task id for a job."""
+    managed_task_status = managed_job_state.ManagedJobStatus.SUCCEEDED
+    current_task_id = 0
+    for task in job_tasks:
+        managed_task_status = task['status']
+        current_task_id = task['task_id']
+
+        # Use the first non-succeeded status.
+        if managed_task_status != managed_job_state.ManagedJobStatus.SUCCEEDED:
+            # TODO(zhwu): we should not blindly use the first non-
+            # succeeded as the status could be changed to SUBMITTED
+            # when going from one task to the next one, which can be
+            # confusing.
+            break
+    return managed_task_status, current_task_id
+
+
 @typing.overload
 def format_job_table(tasks: List[Dict[str, Any]],
                      show_all: bool,
                      return_rows: Literal[False] = False,
                      max_jobs: Optional[int] = None) -> str:
     ...
 
@@ -506,26 +544,44 @@
 
 
 def format_job_table(
         tasks: List[Dict[str, Any]],
         show_all: bool,
         return_rows: bool = False,
         max_jobs: Optional[int] = None) -> Union[str, List[List[str]]]:
-    """Returns spot jobs as a formatted string.
+    """Returns managed jobs as a formatted string.
 
     Args:
-        jobs: A list of spot jobs.
+        jobs: A list of managed jobs.
         show_all: Whether to show all columns.
         max_jobs: The maximum number of jobs to show in the table.
         return_rows: If True, return the rows as a list of strings instead of
           all rows concatenated into a single string.
 
-    Returns: A formatted string of spot jobs, if not `return_rows`; otherwise a
-      list of "rows" (each of which is a list of str).
+    Returns: A formatted string of managed jobs, if not `return_rows`; otherwise
+      a list of "rows" (each of which is a list of str).
     """
+    jobs = collections.defaultdict(list)
+    for task in tasks:
+        # The tasks within the same job_id are already sorted
+        # by the task_id.
+        jobs[task['job_id']].append(task)
+    jobs = dict(jobs)
+
+    status_counts: Dict[str, int] = collections.defaultdict(int)
+    for job_tasks in jobs.values():
+        managed_job_status = _get_job_status_from_tasks(job_tasks)[0]
+        if not managed_job_status.is_terminal():
+            status_counts[managed_job_status.value] += 1
+
+    if max_jobs is not None:
+        job_ids = sorted(jobs.keys(), reverse=True)
+        job_ids = job_ids[:max_jobs]
+        jobs = {job_id: jobs[job_id] for job_id in job_ids}
+
     columns = [
         'ID', 'TASK', 'NAME', 'RESOURCES', 'SUBMITTED', 'TOT. DURATION',
         'JOB DURATION', '#RECOVERIES', 'STATUS'
     ]
     if show_all:
         columns += ['STARTED', 'CLUSTER', 'REGION', 'FAILURE']
     job_table = log_utils.create_table(columns)
@@ -548,53 +604,40 @@
         if len(job_tasks) > 1:
             # Aggregate the tasks into a new row in the table.
             job_name = job_tasks[0]['job_name']
             job_duration = 0
             submitted_at = None
             end_at: Optional[int] = 0
             recovery_cnt = 0
-            spot_status = spot_state.SpotStatus.SUCCEEDED
-            failure_reason = None
-            current_task_id = len(job_tasks) - 1
+            managed_job_status, current_task_id = _get_job_status_from_tasks(
+                job_tasks)
             for task in job_tasks:
                 job_duration += task['job_duration']
                 if task['submitted_at'] is not None:
                     if (submitted_at is None or
                             submitted_at > task['submitted_at']):
                         submitted_at = task['submitted_at']
                 if task['end_at'] is not None:
                     if end_at is not None and end_at < task['end_at']:
                         end_at = task['end_at']
                 else:
                     end_at = None
                 recovery_cnt += task['recovery_count']
-                if spot_status == spot_state.SpotStatus.SUCCEEDED:
-                    # Use the first non-succeeded status.
-                    # TODO(zhwu): we should not blindly use the first non-
-                    # succeeded as the status could be changed to SUBMITTED
-                    # when going from one task to the next one, which can be
-                    # confusing.
-                    spot_status = task['status']
-                    current_task_id = task['task_id']
-
-                if (failure_reason is None and
-                        task['status'] > spot_state.SpotStatus.SUCCEEDED):
-                    failure_reason = task['failure_reason']
 
+            failure_reason = job_tasks[current_task_id]['failure_reason']
             job_duration = log_utils.readable_time_duration(0,
                                                             job_duration,
                                                             absolute=True)
             submitted = log_utils.readable_time_duration(submitted_at)
             total_duration = log_utils.readable_time_duration(submitted_at,
                                                               end_at,
                                                               absolute=True)
 
-            status_str = spot_status.colored_str()
-            if (spot_status < spot_state.SpotStatus.RUNNING and
-                    current_task_id > 0):
+            status_str = managed_job_status.colored_str()
+            if not managed_job_status.is_terminal():
                 status_str += f' (task: {current_task_id})'
 
             job_values = [
                 job_id,
                 '',
                 job_name,
                 '-',
@@ -611,15 +654,15 @@
                     '-',
                     failure_reason if failure_reason is not None else '-',
                 ])
             job_table.add_row(job_values)
 
         for task in job_tasks:
             # The job['job_duration'] is already calculated in
-            # dump_spot_job_queue().
+            # dump_managed_job_queue().
             job_duration = log_utils.readable_time_duration(
                 0, task['job_duration'], absolute=True)
             submitted = log_utils.readable_time_duration(task['submitted_at'])
             values = [
                 task['job_id'] if len(job_tasks) == 1 else ' \u21B3',
                 task['task_id'] if len(job_tasks) > 1 else '-',
                 task['task_name'],
@@ -650,118 +693,98 @@
             job_table.add_row([''] * len(columns))
     status_str = ', '.join([
         f'{count} {status}' for status, count in sorted(status_counts.items())
     ])
     if status_str:
         status_str = f'In progress tasks: {status_str}'
     else:
-        status_str = 'No in-progress spot jobs.'
+        status_str = 'No in-progress managed jobs.'
     output = status_str
     if str(job_table):
         output += f'\n{job_table}'
     if return_rows:
         return job_table.rows
     return output
 
 
-class SpotCodeGen:
-    """Code generator for managed spot job utility functions.
+class ManagedJobCodeGen:
+    """Code generator for managed job utility functions.
 
     Usage:
 
-      >> codegen = SpotCodegen.show_jobs(...)
+      >> codegen = ManagedJobCodeGen.show_jobs(...)
     """
-    _PREFIX = [
-        'from sky.spot import spot_state',
-        'from sky.spot import spot_utils',
-    ]
+    _PREFIX = textwrap.dedent("""\
+        managed_job_version = 0
+        try:
+            from sky.jobs import constants, state, utils
+            managed_job_version = constants.MANAGED_JOBS_VERSION
+        except ImportError:
+            from sky.spot import spot_state as state, spot_utils as utils
+        """)
 
     @classmethod
     def get_job_table(cls) -> str:
-        code = [
-            'job_table = spot_utils.dump_spot_job_queue()',
-            'print(job_table, flush=True)',
-        ]
+        code = textwrap.dedent("""\
+        if managed_job_version < 1:
+            job_table = utils.dump_spot_job_queue()
+        else:
+            job_table = utils.dump_managed_job_queue()
+        print(job_table, flush=True)
+        """)
         return cls._build(code)
 
     @classmethod
     def cancel_jobs_by_id(cls, job_ids: Optional[List[int]]) -> str:
-        code = [
-            f'msg = spot_utils.cancel_jobs_by_id({job_ids})',
-            'print(msg, end="", flush=True)',
-        ]
+        code = textwrap.dedent(f"""\
+        msg = utils.cancel_jobs_by_id({job_ids})
+        print(msg, end="", flush=True)
+        """)
         return cls._build(code)
 
     @classmethod
     def cancel_job_by_name(cls, job_name: str) -> str:
-        code = [
-            f'msg = spot_utils.cancel_job_by_name({job_name!r})',
-            'print(msg, end="", flush=True)',
-        ]
+        code = textwrap.dedent(f"""\
+        msg = utils.cancel_job_by_name({job_name!r})
+        print(msg, end="", flush=True)
+        """)
         return cls._build(code)
 
     @classmethod
     def stream_logs_by_name(cls, job_name: str, follow: bool = True) -> str:
-        code = [
-            f'msg = spot_utils.stream_logs_by_name({job_name!r}, '
-            f'follow={follow})',
-            'print(msg, flush=True)',
-        ]
+        code = textwrap.dedent(f"""\
+        msg = utils.stream_logs_by_name({job_name!r}, follow={follow})
+        print(msg, flush=True)
+        """)
         return cls._build(code)
 
     @classmethod
     def stream_logs_by_id(cls,
                           job_id: Optional[int],
                           follow: bool = True) -> str:
-        code = [
-            f'job_id = {job_id} if {job_id} is not None '
-            'else spot_state.get_latest_job_id()',
-            f'msg = spot_utils.stream_logs_by_id(job_id, follow={follow})',
-            'print(msg, flush=True)',
-        ]
+        code = textwrap.dedent(f"""\
+        job_id = {job_id} if {job_id} is not None else state.get_latest_job_id()
+        msg = utils.stream_logs_by_id(job_id, follow={follow})
+        print(msg, flush=True)
+        """)
         return cls._build(code)
 
     @classmethod
-    def set_pending(cls, job_id: int, spot_dag: 'dag_lib.Dag') -> str:
-        dag_name = spot_dag.name
-        # Add the spot job to spot queue table.
-        code = [
-            f'spot_state.set_job_name('
-            f'{job_id}, {dag_name!r})',
-        ]
-        for task_id, task in enumerate(spot_dag.tasks):
-            resources_str = backend_utils.get_task_resources_str(task)
-            code += [
-                f'spot_state.set_pending('
-                f'{job_id}, {task_id}, {task.name!r}, '
-                f'{resources_str!r})',
-            ]
+    def set_pending(cls, job_id: int, managed_job_dag: 'dag_lib.Dag') -> str:
+        dag_name = managed_job_dag.name
+        # Add the managed job to queue table.
+        code = textwrap.dedent(f"""\
+            state.set_job_name({job_id}, {dag_name!r})
+            """)
+        for task_id, task in enumerate(managed_job_dag.tasks):
+            resources_str = backend_utils.get_task_resources_str(
+                task, is_managed_job=True)
+            code += textwrap.dedent(f"""\
+                state.set_pending({job_id}, {task_id}, 
+                                  {task.name!r}, {resources_str!r})
+                """)
         return cls._build(code)
 
     @classmethod
-    def _build(cls, code: List[str]) -> str:
-        code = cls._PREFIX + code
-        generated_code = '; '.join(code)
+    def _build(cls, code: str) -> str:
+        generated_code = cls._PREFIX + '\n' + code
         return f'{constants.SKY_PYTHON_CMD} -u -c {shlex.quote(generated_code)}'
-
-
-def dump_job_table_cache(job_table: str):
-    """Dump job table cache to file."""
-    cache_file = pathlib.Path(_SPOT_STATUS_CACHE).expanduser()
-    with cache_file.open('w', encoding='utf-8') as f:
-        json.dump((time.time(), job_table), f)
-
-
-def load_job_table_cache() -> Optional[Tuple[float, str]]:
-    """Load job table cache from file.
-
-    Returns:
-        A tuple of (timestamp, job_table), where the timestamp is
-        the time when the job table is dumped and the job_table is
-        the dumped job table in string.
-        None if the cache file does not exist.
-    """
-    cache_file = pathlib.Path(_SPOT_STATUS_CACHE).expanduser()
-    if not cache_file.exists():
-        return None
-    with cache_file.open('r', encoding='utf-8') as f:
-        return json.load(f)
```

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/status_lib.py` & `skypilot_nightly-1.0.0.dev20240505/sky/status_lib.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/task.py` & `skypilot_nightly-1.0.0.dev20240505/sky/task.py`

 * *Files 0% similar despite different names*

```diff
@@ -267,17 +267,17 @@
         # Resources that this task cannot run on.
         self.blocked_resources = blocked_resources
 
         self.time_estimator_func: Optional[Callable[['sky.Resources'],
                                                     int]] = None
         self.file_mounts: Optional[Dict[str, str]] = None
 
-        # Only set when 'self' is a spot controller task: 'self.spot_dag' is
-        # the underlying managed spot dag (sky.Dag object).
-        self.spot_dag: Optional['sky.Dag'] = None
+        # Only set when 'self' is a jobs controller task: 'self.managed_job_dag'
+        # is the underlying managed job dag (sky.Dag object).
+        self.managed_job_dag: Optional['sky.Dag'] = None
 
         # Only set when 'self' is a sky serve controller task.
         self.service_name: Optional[str] = None
 
         # Filled in by the optimizer.  If None, this Task is not planned.
         self.best_resources = None
         # Check if the task is legal.
@@ -545,18 +545,14 @@
         # docker login envs are newly added.
         if _check_docker_login_config(self._envs):
             self.resources = _with_docker_login_config(self.resources,
                                                        self._envs)
         return self
 
     @property
-    def need_spot_recovery(self) -> bool:
-        return any(r.spot_recovery is not None for r in self.resources)
-
-    @property
     def use_spot(self) -> bool:
         return any(r.use_spot for r in self.resources)
 
     def set_inputs(self, inputs: str,
                    estimated_size_gigabytes: float) -> 'Task':
         # E.g., 's3://bucket', 'gs://bucket', or None.
         self.inputs = inputs
@@ -1003,16 +999,16 @@
         for k, v in self.file_mounts.items():
             if not data_utils.is_cloud_store_url(
                     k) and not data_utils.is_cloud_store_url(v):
                 d[k] = v
         return d
 
     def is_controller_task(self) -> bool:
-        """Returns whether this task is a spot/serve controller process."""
-        return self.spot_dag is not None or self.service_name is not None
+        """Returns whether this task is a jobs/serve controller process."""
+        return self.managed_job_dag is not None or self.service_name is not None
 
     def get_cloud_to_remote_file_mounts(self) -> Optional[Dict[str, str]]:
         """Returns file mounts of the form (dst=VM path, src=cloud URL).
 
         Local-to-remote file mounts are excluded (handled by
         get_local_to_remote_file_mounts()).
```

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/templates/aws-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240505/sky/templates/aws-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/templates/azure-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240505/sky/templates/azure-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/templates/cudo-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240505/sky/templates/cudo-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/templates/fluidstack-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240505/sky/templates/fluidstack-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/templates/gcp-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240505/sky/templates/gcp-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/templates/ibm-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240505/sky/templates/ibm-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/templates/kubernetes-ingress.yml.j2` & `skypilot_nightly-1.0.0.dev20240505/sky/templates/kubernetes-ingress.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/templates/kubernetes-port-forward-proxy-command.sh.j2` & `skypilot_nightly-1.0.0.dev20240505/sky/templates/kubernetes-port-forward-proxy-command.sh.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/templates/kubernetes-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240505/sky/templates/kubernetes-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/templates/kubernetes-ssh-jump.yml.j2` & `skypilot_nightly-1.0.0.dev20240505/sky/templates/kubernetes-ssh-jump.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/templates/lambda-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240505/sky/templates/lambda-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/templates/local-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240505/sky/templates/local-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/templates/oci-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240505/sky/templates/oci-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/templates/paperspace-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240505/sky/templates/paperspace-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/templates/runpod-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240505/sky/templates/runpod-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/templates/scp-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240505/sky/templates/scp-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/templates/sky-serve-controller.yaml.j2` & `skypilot_nightly-1.0.0.dev20240505/sky/templates/sky-serve-controller.yaml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/templates/spot-controller.yaml.j2` & `skypilot_nightly-1.0.0.dev20240505/sky/templates/jobs-controller.yaml.j2`

 * *Files 26% similar despite different names*

```diff
@@ -1,8 +1,8 @@
-# The template for the spot controller
+# The template for the jobs controller
 
 name: {{dag_name}}
 
 file_mounts:
   {{remote_user_yaml_path}}: {{user_yaml_path}}
   {{remote_user_config_path}}: skypilot:local_skypilot_config_path
   {%- for remote_catalog_path, local_catalog_path in modified_catalogs.items() %}
@@ -11,24 +11,25 @@
 
 setup: |
   {%- for cmd in cloud_dependencies_installation_commands %}
   {{cmd}}
   {%- endfor %}
 
   {% if is_dev %}
-  # Internal: disable logging for manually logging into the spot controller for debugging.
+  # Internal: disable logging for manually logging into the jobs controller for debugging.
   echo 'export SKYPILOT_DEV=1' >> ~/.bashrc
   {% endif %}
 
   # Dashboard.
+  ps aux | grep -v nohup | grep -v grep | grep -- "-m sky.spot.dashboard" | awk '{print $2}' | xargs kill > /dev/null 2>&1 || true
   pip list | grep flask  > /dev/null 2>&1 || pip install flask 2>&1 > /dev/null
-  ((ps aux | grep -v nohup | grep -v grep | grep -q -- "python3 -m sky.spot.dashboard.dashboard") || (nohup {{ sky_python_cmd }} -m sky.spot.dashboard.dashboard >> ~/.sky/spot-dashboard.log 2>&1 &));
+  ((ps aux | grep -v nohup | grep -v grep | grep -q -- "-m sky.jobs.dashboard.dashboard") || (nohup {{ sky_python_cmd }} -m sky.jobs.dashboard.dashboard >> ~/.sky/job-dashboard.log 2>&1 &));
 
 run: |
-  # Start the controller for the current spot job.
-  python -u -m sky.spot.controller {{remote_user_yaml_path}} \
+  # Start the controller for the current managed job.
+  python -u -m sky.jobs.controller {{remote_user_yaml_path}} \
     --job-id $SKYPILOT_INTERNAL_JOB_ID {% if retry_until_up %}--retry-until-up{% endif %}
 
 envs:
 {%- for env_name, env_value in controller_envs.items() %}
   {{env_name}}: {{env_value}}
 {%- endfor %}
```

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/templates/vsphere-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240505/sky/templates/vsphere-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/usage/constants.py` & `skypilot_nightly-1.0.0.dev20240505/sky/usage/constants.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/usage/usage_lib.py` & `skypilot_nightly-1.0.0.dev20240505/sky/usage/usage_lib.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/utils/accelerator_registry.py` & `skypilot_nightly-1.0.0.dev20240505/sky/utils/accelerator_registry.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/utils/cli_utils/status_utils.py` & `skypilot_nightly-1.0.0.dev20240505/sky/utils/cli_utils/status_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/utils/cluster_yaml_utils.py` & `skypilot_nightly-1.0.0.dev20240505/sky/utils/cluster_yaml_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/utils/command_runner.py` & `skypilot_nightly-1.0.0.dev20240505/sky/utils/command_runner.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/utils/command_runner.pyi` & `skypilot_nightly-1.0.0.dev20240505/sky/utils/command_runner.pyi`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/utils/common_utils.py` & `skypilot_nightly-1.0.0.dev20240505/sky/utils/common_utils.py`

 * *Files 2% similar despite different names*

```diff
@@ -632,22 +632,31 @@
     # Write out yaml config.
     j2_template = jinja2.Template(template)
     content = j2_template.render(**variables)
     with open(output_path, 'w', encoding='utf-8') as fout:
         fout.write(content)
 
 
-def deprecated_function(func: Callable, name: str, deprecated_name: str,
-                        removing_version: str) -> Callable:
+def deprecated_function(
+        func: Callable,
+        name: str,
+        deprecated_name: str,
+        removing_version: str,
+        override_argument: Optional[Dict[str, Any]] = None) -> Callable:
     """Decorator for creating deprecated functions, for backward compatibility.
 
     It will result in a warning being emitted when the function is used.
     """
 
     @functools.wraps(func)
     def new_func(*args, **kwargs):
+        override_argument_str = ''
+        if override_argument:
+            override_argument_str = ', '.join(
+                f'{k}={v}' for k, v in override_argument.items())
         logger.warning(
             f'Call to deprecated function {deprecated_name}, which will be '
-            f'removed in {removing_version}. Please use {name}() instead.')
+            f'removed in {removing_version}. Please use '
+            f'{name}({override_argument_str}) instead.')
         return func(*args, **kwargs)
 
     return new_func
```

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/utils/controller_utils.py` & `skypilot_nightly-1.0.0.dev20240505/sky/utils/controller_utils.py`

 * *Files 6% similar despite different names*

```diff
@@ -13,33 +13,34 @@
 from sky import check as sky_check
 from sky import clouds
 from sky import exceptions
 from sky import global_user_state
 from sky import resources
 from sky import sky_logging
 from sky import skypilot_config
+from sky.adaptors import cloudflare
 from sky.clouds import gcp
 from sky.data import data_utils
 from sky.data import storage as storage_lib
+from sky.jobs import constants as managed_job_constants
+from sky.jobs import utils as managed_job_utils
 from sky.serve import constants as serve_constants
 from sky.serve import serve_utils
 from sky.skylet import constants
-from sky.spot import constants as spot_constants
-from sky.spot import spot_utils
 from sky.utils import common_utils
 from sky.utils import env_options
 from sky.utils import ux_utils
 
 if typing.TYPE_CHECKING:
     from sky import task as task_lib
     from sky.backends import cloud_vm_ray_backend
 
 logger = sky_logging.init_logger(__name__)
 
-# Message thrown when APIs sky.spot.launch(),sky.serve.up() received an invalid
+# Message thrown when APIs sky.jobs.launch(), sky.serve.up() received an invalid
 # controller resources spec.
 CONTROLLER_RESOURCES_NOT_VALID_MESSAGE = (
     '{controller_type} controller resources is not valid, please check '
     '~/.sky/config.yaml file and make sure '
     '{controller_type}.controller.resources is a valid resources spec. '
     'Details:\n  {err}')
 
@@ -48,101 +49,124 @@
 
 
 @dataclasses.dataclass
 class _ControllerSpec:
     """Spec for skypilot controllers."""
     controller_type: str
     name: str
-    cluster_name: str
+    # Use a list of strings to support fallback to old names. The list is in the
+    # fallback order.
+    candidate_cluster_names: List[str]
     in_progress_hint: str
     decline_cancel_hint: str
-    decline_down_when_failed_to_fetch_status_hint: str
+    _decline_down_when_failed_to_fetch_status_hint: str
     decline_down_for_dirty_controller_hint: str
-    check_cluster_name_hint: str
+    _check_cluster_name_hint: str
     default_hint_if_non_existent: str
     connection_error_hint: str
     default_resources_config: Dict[str, Any]
 
+    @property
+    def cluster_name(self) -> str:
+        """The name in candidate_cluster_names that exists, else the first."""
+        for candidate_name in self.candidate_cluster_names:
+            record = global_user_state.get_cluster_from_name(candidate_name)
+            if record is not None:
+                return candidate_name
+        return self.candidate_cluster_names[0]
+
+    @property
+    def decline_down_when_failed_to_fetch_status_hint(self) -> str:
+        return self._decline_down_when_failed_to_fetch_status_hint.format(
+            cluster_name=self.cluster_name)
+
+    @property
+    def check_cluster_name_hint(self) -> str:
+        return self._check_cluster_name_hint.format(
+            cluster_name=self.cluster_name)
+
 
 class Controllers(enum.Enum):
     """Skypilot controllers."""
     # NOTE(dev): Keep this align with
     # sky/cli.py::_CONTROLLER_TO_HINT_OR_RAISE
-    SPOT_CONTROLLER = _ControllerSpec(
-        controller_type='spot',
-        name='managed spot controller',
-        cluster_name=spot_utils.SPOT_CONTROLLER_NAME,
+    JOBS_CONTROLLER = _ControllerSpec(
+        controller_type='jobs',
+        name='managed jobs controller',
+        candidate_cluster_names=[
+            managed_job_utils.JOB_CONTROLLER_NAME,
+            managed_job_utils.LEGACY_JOB_CONTROLLER_NAME
+        ],
         in_progress_hint=(
-            '* {job_info}To see all spot jobs: '
-            f'{colorama.Style.BRIGHT}sky spot queue{colorama.Style.RESET_ALL}'),
+            '* {job_info}To see all managed jobs: '
+            f'{colorama.Style.BRIGHT}sky jobs queue{colorama.Style.RESET_ALL}'),
         decline_cancel_hint=(
-            'Cancelling the spot controller\'s jobs is not allowed.\nTo cancel '
-            f'spot jobs, use: {colorama.Style.BRIGHT}sky spot cancel <spot '
-            f'job IDs> [--all]{colorama.Style.RESET_ALL}'),
-        decline_down_when_failed_to_fetch_status_hint=(
-            f'{colorama.Fore.RED}Tearing down the spot controller while '
-            'it is in INIT state is not supported (this means a spot launch '
+            'Cancelling the jobs controller\'s jobs is not allowed.\nTo cancel '
+            f'managed jobs, use: {colorama.Style.BRIGHT}sky jobs cancel '
+            f'<managed job IDs> [--all]{colorama.Style.RESET_ALL}'),
+        _decline_down_when_failed_to_fetch_status_hint=(
+            f'{colorama.Fore.RED}Tearing down the jobs controller while '
+            'it is in INIT state is not supported (this means a job launch '
             'is in progress or the previous launch failed), as we cannot '
-            'guarantee that all the spot jobs are finished. Please wait '
-            'until the spot controller is UP or fix it with '
+            'guarantee that all the managed jobs are finished. Please wait '
+            'until the jobs controller is UP or fix it with '
             f'{colorama.Style.BRIGHT}sky start '
-            f'{spot_utils.SPOT_CONTROLLER_NAME}{colorama.Style.RESET_ALL}.'),
+            '{cluster_name}'
+            f'{colorama.Style.RESET_ALL}.'),
         decline_down_for_dirty_controller_hint=(
-            f'{colorama.Fore.RED}In-progress spot jobs found. To avoid '
+            f'{colorama.Fore.RED}In-progress managed jobs found. To avoid '
             f'resource leakage, cancel all jobs first: {colorama.Style.BRIGHT}'
-            f'sky spot cancel -a{colorama.Style.RESET_ALL}\n'),
-        check_cluster_name_hint=(
-            f'Cluster {spot_utils.SPOT_CONTROLLER_NAME} is reserved for '
-            'managed spot controller.'),
-        default_hint_if_non_existent='No in-progress spot jobs.',
+            f'sky jobs cancel -a{colorama.Style.RESET_ALL}\n'),
+        _check_cluster_name_hint=('Cluster {cluster_name} is reserved for '
+                                  'managed jobs controller.'),
+        default_hint_if_non_existent='No in-progress managed jobs.',
         connection_error_hint=(
-            'Failed to connect to spot controller, please try again later.'),
-        default_resources_config=spot_constants.CONTROLLER_RESOURCES)
+            'Failed to connect to jobs controller, please try again later.'),
+        default_resources_config=managed_job_constants.CONTROLLER_RESOURCES)
     SKY_SERVE_CONTROLLER = _ControllerSpec(
         controller_type='serve',
         name='serve controller',
-        cluster_name=serve_utils.SKY_SERVE_CONTROLLER_NAME,
+        candidate_cluster_names=[serve_utils.SKY_SERVE_CONTROLLER_NAME],
         in_progress_hint=(
             f'* To see detailed service status: {colorama.Style.BRIGHT}'
             f'sky serve status -a{colorama.Style.RESET_ALL}'),
         decline_cancel_hint=(
             'Cancelling the sky serve controller\'s jobs is not allowed.'),
-        decline_down_when_failed_to_fetch_status_hint=(
+        _decline_down_when_failed_to_fetch_status_hint=(
             f'{colorama.Fore.RED}Tearing down the sky serve controller '
             'while it is in INIT state is not supported (this means a sky '
             'serve up is in progress or the previous launch failed), as we '
             'cannot guarantee that all the services are terminated. Please '
             'wait until the sky serve controller is UP or fix it with '
             f'{colorama.Style.BRIGHT}sky start '
-            f'{serve_utils.SKY_SERVE_CONTROLLER_NAME}'
+            '{cluster_name}'
             f'{colorama.Style.RESET_ALL}.'),
         decline_down_for_dirty_controller_hint=(
             f'{colorama.Fore.RED}Tearing down the sky serve controller is not '
             'supported, as it is currently serving the following services: '
             '{service_names}. Please terminate the services first with '
             f'{colorama.Style.BRIGHT}sky serve down -a'
             f'{colorama.Style.RESET_ALL}.'),
-        check_cluster_name_hint=(
-            f'Cluster {serve_utils.SKY_SERVE_CONTROLLER_NAME} is reserved for '
-            'sky serve controller.'),
+        _check_cluster_name_hint=('Cluster {cluster_name} is reserved for '
+                                  'sky serve controller.'),
         default_hint_if_non_existent='No live services.',
         connection_error_hint=(
             'Failed to connect to serve controller, please try again later.'),
         default_resources_config=serve_constants.CONTROLLER_RESOURCES)
 
     @classmethod
     def from_name(cls, name: Optional[str]) -> Optional['Controllers']:
         """Check if the cluster name is a controller name.
 
         Returns:
             The controller if the cluster name is a controller name.
             Otherwise, returns None.
         """
         for controller in cls:
-            if controller.value.cluster_name == name:
+            if name in controller.value.candidate_cluster_names:
                 return controller
         return None
 
     @classmethod
     def from_type(cls, controller_type: str) -> Optional['Controllers']:
         """Get the controller by controller type.
 
@@ -156,48 +180,91 @@
         return None
 
 
 # Install cli dependencies. Not using SkyPilot wheels because the wheel
 # can be cleaned up by another process.
 # TODO(zhwu): Keep the dependencies align with the ones in setup.py
 def _get_cloud_dependencies_installation_commands(
-        controller_type: str) -> List[str]:
-    commands = [
-        # aws
-        'pip list | grep boto3 > /dev/null 2>&1 || '
-        'pip install "urllib3<2" awscli>=1.27.10 botocore>=1.29.10 '
-        'boto3>=1.26.1 > /dev/null 2>&1',
-        # gcp
-        'pip list | grep google-api-python-client > /dev/null 2>&1 || '
-        'pip install google-api-python-client>=2.69.0 '
-        '> /dev/null 2>&1',
-        # Have to separate the installation of google-cloud-storage from above
-        # because for a VM launched on GCP, the VM may have
-        # google-api-python-client installed alone.
-        'pip list | grep google-cloud-storage > /dev/null 2>&1 || '
-        'pip install google-cloud-storage > /dev/null 2>&1',
-        f'{gcp.GOOGLE_SDK_INSTALLATION_COMMAND}',
-        # fluidstack does not need to install any cloud dependencies.
-    ]
-    # k8s and ibm doesn't support open port and spot instance yet, so we don't
-    # install them for either controller.
-    if controller_type == 'spot':
-        # oci doesn't support open port yet, so we don't install oci
-        # dependencies for sky serve controller.
-        commands.append('pip list | grep oci > /dev/null 2>&1 || '
-                        'pip install oci > /dev/null 2>&1')
+        controller: Controllers) -> List[str]:
     # TODO(tian): Make dependency installation command a method of cloud
     # class and get all installation command for enabled clouds.
-    if any(
-            cloud.is_same_cloud(clouds.Azure())
-            for cloud in sky_check.get_cached_enabled_clouds_or_refresh()):
-        commands.append(
-            'pip list | grep azure-cli > /dev/null 2>&1 || '
-            'pip install azure-cli>=2.31.0 azure-core azure-identity>=1.13.0 '
-            'azure-mgmt-network > /dev/null 2>&1')
+    commands = []
+    prefix_str = 'Check & install cloud dependencies on controller: '
+    # This is to make sure the shorter checking message does not have junk
+    # characters from the previous message.
+    empty_str = ' ' * 5
+    aws_dependencies_installation = (
+        'pip list | grep boto3 > /dev/null 2>&1 || pip install '
+        'botocore>=1.29.10 boto3>=1.26.1; '
+        # Need to separate the installation of awscli from above because some
+        # other clouds will install boto3 but not awscli.
+        'pip list | grep awscli> /dev/null 2>&1 || pip install "urllib3<2" '
+        'awscli>=1.27.10 "colorama<0.4.5" > /dev/null 2>&1')
+    for cloud in sky_check.get_cached_enabled_clouds_or_refresh():
+        if isinstance(
+                clouds,
+            (clouds.Lambda, clouds.SCP, clouds.Fluidstack, clouds.Paperspace)):
+            # no need to install any cloud dependencies for lambda, scp,
+            # fluidstack and paperspace
+            continue
+        if isinstance(cloud, clouds.AWS):
+            commands.append(f'echo -n "{prefix_str}AWS{empty_str}" && ' +
+                            aws_dependencies_installation)
+        elif isinstance(cloud, clouds.Azure):
+            commands.append(
+                f'echo -en "\\r{prefix_str}Azure{empty_str}" && '
+                'pip list | grep azure-cli > /dev/null 2>&1 || '
+                'pip install "azure-cli>=2.31.0" azure-core '
+                '"azure-identity>=1.13.0" azure-mgmt-network > /dev/null 2>&1')
+        elif isinstance(cloud, clouds.GCP):
+            commands.append(
+                f'echo -en "\\r{prefix_str}GCP{empty_str}" && '
+                'pip list | grep google-api-python-client > /dev/null 2>&1 || '
+                'pip install "google-api-python-client>=2.69.0" '
+                '> /dev/null 2>&1')
+            # Have to separate the installation of google-cloud-storage from
+            # above because for a VM launched on GCP, the VM may have
+            # google-api-python-client installed alone.
+            commands.append(
+                'pip list | grep google-cloud-storage > /dev/null 2>&1 || '
+                'pip install google-cloud-storage > /dev/null 2>&1')
+            commands.append(f'{gcp.GOOGLE_SDK_INSTALLATION_COMMAND}')
+        if controller == Controllers.JOBS_CONTROLLER:
+            if isinstance(cloud, clouds.IBM):
+                commands.append(
+                    f'echo -en "\\r{prefix_str}IBM{empty_str}" '
+                    '&& pip list | grep ibm-cloud-sdk-core > /dev/null 2>&1 || '
+                    'pip install ibm-cloud-sdk-core ibm-vpc '
+                    'ibm-platform-services ibm-cos-sdk > /dev/null 2>&1')
+            elif isinstance(cloud, clouds.OCI):
+                commands.append(f'echo -en "\\r{prefix_str}OCI{empty_str}" && '
+                                'pip list | grep oci > /dev/null 2>&1 || '
+                                'pip install oci > /dev/null 2>&1')
+            elif isinstance(cloud, clouds.Kubernetes):
+                commands.append(
+                    f'echo -en "\\r{prefix_str}Kubernetes{empty_str}" && '
+                    'pip list | grep kubernetes > /dev/null 2>&1 || '
+                    'pip install "kubernetes>=20.0.0" > /dev/null 2>&1')
+            elif isinstance(cloud, clouds.RunPod):
+                commands.append(
+                    f'echo -en "\\r{prefix_str}RunPod{empty_str}" && '
+                    'pip list | grep runpod > /dev/null 2>&1 || '
+                    'pip install "runpod>=1.5.1" > /dev/null 2>&1')
+            elif isinstance(cloud, clouds.Cudo):
+                # cudo doesn't support open port
+                commands.append(
+                    f'echo -en "\\r{prefix_str}Cudo{empty_str}" && '
+                    'pip list | grep cudo-compute > /dev/null 2>&1 || '
+                    'pip install "cudo-compute>=0.1.8" > /dev/null 2>&1')
+    if (cloudflare.NAME
+            in storage_lib.get_cached_enabled_storage_clouds_or_refresh()):
+        commands.append(f'echo -en "\\r{prefix_str}Cloudflare{empty_str}" && ' +
+                        aws_dependencies_installation)
+    commands.append(f'echo -e "\\r{prefix_str}Done for {len(commands)} '
+                    'clouds."')
     return commands
 
 
 def check_cluster_name_not_controller(
         cluster_name: Optional[str],
         operation_str: Optional[str] = None) -> None:
     """Errors out if the cluster name is a controller name.
@@ -222,27 +289,27 @@
 # Internal only:
 def download_and_stream_latest_job_log(
         backend: 'cloud_vm_ray_backend.CloudVmRayBackend',
         handle: 'cloud_vm_ray_backend.CloudVmRayResourceHandle',
         local_dir: str) -> Optional[str]:
     """Downloads and streams the latest job log.
 
-    This function is only used by spot controller and sky serve controller.
+    This function is only used by jobs controller and sky serve controller.
     """
     os.makedirs(local_dir, exist_ok=True)
     log_file = None
     try:
         log_dirs = backend.sync_down_logs(
             handle,
             # Download the log of the latest job.
-            # The job_id for the spot job running on the spot cluster is not
+            # The job_id for the managed job running on the cluster is not
             # necessarily 1, as it is possible that the worker node in a
-            # multi-node cluster is preempted, and we recover the spot job
+            # multi-node cluster is preempted, and we recover the managed job
             # on the existing cluster, which leads to a larger job_id. Those
-            # job_ids all represent the same logical spot job.
+            # job_ids all represent the same logical managed job.
             job_ids=None,
             local_dir=local_dir)
     except exceptions.CommandError as e:
         logger.info(f'Failed to download the logs: '
                     f'{common_utils.format_exception(e)}')
     else:
         if not log_dirs:
@@ -258,18 +325,19 @@
             except FileNotFoundError:
                 logger.error('Failed to find the logs for the user '
                              f'program at {log_file}.')
     return log_file
 
 
 def shared_controller_vars_to_fill(
-        controller_type: str, remote_user_config_path: str) -> Dict[str, str]:
+        controller: Controllers,
+        remote_user_config_path: str) -> Dict[str, str]:
     vars_to_fill: Dict[str, Any] = {
         'cloud_dependencies_installation_commands':
-            _get_cloud_dependencies_installation_commands(controller_type)
+            _get_cloud_dependencies_installation_commands(controller)
     }
     env_vars: Dict[str, str] = {
         env.value: '1' for env in env_options.Options if env.get()
     }
     env_vars.update({
         # Should not use $USER here, as that env var can be empty when
         # running in a container.
@@ -283,60 +351,62 @@
         env_vars[
             skypilot_config.ENV_VAR_SKYPILOT_CONFIG] = remote_user_config_path
     vars_to_fill['controller_envs'] = env_vars
     return vars_to_fill
 
 
 def get_controller_resources(
-    controller_type: str,
+    controller: Controllers,
     task_resources: Iterable['resources.Resources'],
 ) -> Set['resources.Resources']:
     """Read the skypilot config and setup the controller resources.
 
     Returns:
         A set of controller resources that will be used to launch the
         controller. All fields are the same except for the cloud. If no
         controller exists and the controller resources has no cloud
         specified, the controller will be launched on one of the clouds
         of the task resources for better connectivity.
     """
-    controller = Controllers.from_type(controller_type)
-    assert controller is not None, controller_type
     controller_resources_config_copied: Dict[str, Any] = copy.copy(
         controller.value.default_resources_config)
     if skypilot_config.loaded():
         # Override the controller resources with the ones specified in the
         # config.
         custom_controller_resources_config = skypilot_config.get_nested(
-            (controller_type, 'controller', 'resources'), None)
+            (controller.value.controller_type, 'controller', 'resources'), None)
         if custom_controller_resources_config is not None:
             controller_resources_config_copied.update(
                 custom_controller_resources_config)
+        elif controller == Controllers.JOBS_CONTROLLER:
+            controller_resources_config_copied.update(
+                skypilot_config.get_nested(('spot', 'controller', 'resources'),
+                                           {}))
 
     try:
         controller_resources = resources.Resources.from_yaml_config(
             controller_resources_config_copied)
     except ValueError as e:
         with ux_utils.print_exception_no_traceback():
             raise ValueError(
                 CONTROLLER_RESOURCES_NOT_VALID_MESSAGE.format(
-                    controller_type=controller_type,
-                    err=common_utils.format_exception(e,
-                                                      use_bracket=True))) from e
+                    controller_type=controller.value.controller_type,
+                    err=common_utils.format_exception(
+                        e, use_bracket=True)).capitalize()) from e
     # TODO(tian): Support multiple resources for the controller. One blocker
     # here is the semantic if controller resources use `ordered` and we want
     # to override it with multiple cloud from task resources.
     if len(controller_resources) != 1:
         with ux_utils.print_exception_no_traceback():
             raise ValueError(
                 CONTROLLER_RESOURCES_NOT_VALID_MESSAGE.format(
-                    controller_type=controller_type,
+                    controller_type=controller.value.controller_type,
                     err=f'Expected exactly one resource, got '
                     f'{len(controller_resources)} resources: '
-                    f'{controller_resources}'))
+                    f'{controller_resources}').capitalize())
     controller_resources_to_use: resources.Resources = list(
         controller_resources)[0]
 
     controller_record = global_user_state.get_cluster_from_name(
         controller.value.cluster_name)
     if controller_record is not None:
         handle = controller_record.get('handle', None)
@@ -400,26 +470,26 @@
     # launch may not have or need the proxy setup. (If the controller
     # needs to launch mew clusters in another region/VPC, the user
     # should properly set up VPC peering, which will allow the
     # cross-region/VPC communication. The proxy command is orthogonal
     # to this scenario.)
     #
     # This file will be uploaded to the controller node and will be
-    # used throughout the spot job's / service's recovery attempts
+    # used throughout the managed job's / service's recovery attempts
     # (i.e., if it relaunches due to preemption, we make sure the
     # same config is used).
     #
     # NOTE: suppose that we have a controller in old VPC, then user
-    # changes 'vpc_name' in the config and does a 'spot launch' /
+    # changes 'vpc_name' in the config and does a 'job launch' /
     # 'serve up'. In general, the old controller may not successfully
     # launch the job in the new VPC. This happens if the two VPCs dont
     # have peering set up. Like other places in the code, we assume
     # properly setting up networking is user's responsibilities.
     # TODO(zongheng): consider adding a basic check that checks
-    # controller VPC (or name) == the spot job's / service's VPC
+    # controller VPC (or name) == the managed job's / service's VPC
     # (or name). It may not be a sufficient check (as it's always
     # possible that peering is not set up), but it may catch some
     # obvious errors.
     proxy_command_key = (str(controller_launched_cloud).lower(),
                          'ssh_proxy_command')
     ssh_proxy_command = skypilot_config.get_nested(proxy_command_key, None)
     config_dict = skypilot_config.to_dict()
@@ -465,15 +535,15 @@
                     del file_mounts[remote_path]
     if replaced:
         logger.debug(f'Replaced {LOCAL_SKYPILOT_CONFIG_PATH_PLACEHOLDER} with '
                      f'the real path in file mounts: {file_mounts}')
 
 
 def maybe_translate_local_file_mounts_and_sync_up(task: 'task_lib.Task',
-                                                  path: str):
+                                                  path: str) -> None:
     """Translates local->VM mounts into Storage->VM, then syncs up any Storage.
 
     Eagerly syncing up local->Storage ensures Storage->VM would work at task
     launch time.
 
     If there are no local source paths to be translated, this function would
     still sync up any storage mounts with local source paths (which do not
@@ -591,15 +661,15 @@
                     f'cloud storage {file_bucket_name}:'
                     f'\n\t{sources_str}')
     task.update_storage_mounts(new_storage_mounts)
 
     # Step 4: Upload storage from sources
     # Upload the local source to a bucket. The task will not be executed
     # locally, so we need to upload the files/folders to the bucket manually
-    # here before sending the task to the remote spot controller.
+    # here before sending the task to the remote jobs controller.
     if task.storage_mounts:
         # There may be existing (non-translated) storage mounts, so log this
         # whenever task.storage_mounts is non-empty.
         logger.info(f'{colorama.Fore.YELLOW}Uploading sources to cloud storage.'
                     f'{colorama.Style.RESET_ALL} See: sky storage ls')
     task.sync_storage_mounts()
```

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/utils/dag_utils.py` & `skypilot_nightly-1.0.0.dev20240505/sky/utils/dag_utils.py`

 * *Files 10% similar despite different names*

```diff
@@ -1,14 +1,14 @@
 """Utilities for loading and dumping DAGs from/to YAML files."""
 import copy
 from typing import Any, Dict, List, Optional, Tuple
 
 from sky import dag as dag_lib
+from sky import jobs
 from sky import sky_logging
-from sky import spot
 from sky import task as task_lib
 from sky.backends import backend_utils
 from sky.utils import common_utils
 from sky.utils import ux_utils
 
 logger = sky_logging.init_logger(__name__)
 
@@ -138,37 +138,28 @@
             first_task.name = dag.name
     else:
         for task_id, task in enumerate(dag.tasks):
             if task.name is None:
                 task.name = f'{dag.name}-{task_id}'
 
 
-def fill_default_spot_config_in_dag_for_spot_launch(dag: dag_lib.Dag) -> None:
+def fill_default_config_in_dag_for_job_launch(dag: dag_lib.Dag) -> None:
     for task_ in dag.tasks:
 
         new_resources_list = []
         for resources in list(task_.resources):
             change_default_value: Dict[str, Any] = {}
-            if resources.use_spot_specified and not resources.use_spot:
-                logger.info(
-                    'Field `use_spot` is set to false but a managed spot job is '  # pylint: disable=line-too-long
-                    'being launched. Ignoring the field and proceeding to use spot '  # pylint: disable=line-too-long
-                    'instance(s).')
-            change_default_value['use_spot'] = True
-            if resources.spot_recovery is None:
+            if resources.job_recovery is None:
                 change_default_value[
-                    'spot_recovery'] = spot.SPOT_DEFAULT_STRATEGY
+                    'job_recovery'] = jobs.DEFAULT_RECOVERY_STRATEGY
 
             new_resources = resources.copy(**change_default_value)
             new_resources_list.append(new_resources)
 
-        spot_recovery_strategy = new_resources_list[0].spot_recovery
+        job_recovery_strategy = new_resources_list[0].job_recovery
         for resource in new_resources_list:
-            if resource.spot_recovery != spot_recovery_strategy:
+            if resource.job_recovery != job_recovery_strategy:
                 with ux_utils.print_exception_no_traceback():
                     raise ValueError('All resources in the task must have'
-                                     'the same spot recovery strategy.')
+                                     'the same job recovery strategy.')
 
-        if isinstance(task_.resources, list):
-            task_.set_resources(new_resources_list)
-        else:
-            task_.set_resources(set(new_resources_list))
+        task_.set_resources(type(task_.resources)(new_resources_list))
```

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/utils/db_utils.py` & `skypilot_nightly-1.0.0.dev20240505/sky/utils/db_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/utils/env_options.py` & `skypilot_nightly-1.0.0.dev20240505/sky/utils/env_options.py`

 * *Files 16% similar despite different names*

```diff
@@ -5,17 +5,17 @@
 
 class Options(enum.Enum):
     """Environment variables for SkyPilot."""
     IS_DEVELOPER = 'SKYPILOT_DEV'
     SHOW_DEBUG_INFO = 'SKYPILOT_DEBUG'
     DISABLE_LOGGING = 'SKYPILOT_DISABLE_USAGE_COLLECTION'
     MINIMIZE_LOGGING = 'SKYPILOT_MINIMIZE_LOGGING'
-    # Internal: this is used to skip the cloud user identity check,
-    # which is used to protect cluster operations in a multi-identity
-    # scenario. Currently, this is only used in the spot controller,
-    # as there will not be multiple identities, and skipping the check
-    # can increase robustness.
+    # Internal: this is used to skip the cloud user identity check, which is
+    # used to protect cluster operations in a multi-identity scenario.
+    # Currently, this is only used in the job and serve controller, as there
+    # will not be multiple identities, and skipping the check can increase
+    # robustness.
     SKIP_CLOUD_IDENTITY_CHECK = 'SKYPILOT_SKIP_CLOUD_IDENTITY_CHECK'
 
     def get(self):
         """Check if an environment variable is set to True."""
         return os.getenv(self.value, 'False').lower() in ('true', '1')
```

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/utils/kubernetes/create_cluster.sh` & `skypilot_nightly-1.0.0.dev20240505/sky/utils/kubernetes/create_cluster.sh`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/utils/kubernetes/delete_cluster.sh` & `skypilot_nightly-1.0.0.dev20240505/sky/utils/kubernetes/delete_cluster.sh`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/utils/kubernetes/generate_kind_config.py` & `skypilot_nightly-1.0.0.dev20240505/sky/utils/kubernetes/generate_kind_config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/utils/kubernetes/gpu_labeler.py` & `skypilot_nightly-1.0.0.dev20240505/sky/utils/kubernetes/gpu_labeler.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/utils/kubernetes/k8s_gpu_labeler_job.yaml` & `skypilot_nightly-1.0.0.dev20240505/sky/utils/kubernetes/k8s_gpu_labeler_job.yaml`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/utils/kubernetes/k8s_gpu_labeler_setup.yaml` & `skypilot_nightly-1.0.0.dev20240505/sky/utils/kubernetes/k8s_gpu_labeler_setup.yaml`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/utils/kubernetes/ssh_jump_lifecycle_manager.py` & `skypilot_nightly-1.0.0.dev20240505/sky/utils/kubernetes/ssh_jump_lifecycle_manager.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/utils/kubernetes_enums.py` & `skypilot_nightly-1.0.0.dev20240505/sky/utils/kubernetes_enums.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/utils/log_utils.py` & `skypilot_nightly-1.0.0.dev20240505/sky/utils/log_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/utils/resources_utils.py` & `skypilot_nightly-1.0.0.dev20240505/sky/utils/resources_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/utils/rich_utils.py` & `skypilot_nightly-1.0.0.dev20240505/sky/utils/rich_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/utils/schemas.py` & `skypilot_nightly-1.0.0.dev20240505/sky/utils/schemas.py`

 * *Files 3% similar despite different names*

```diff
@@ -78,17 +78,22 @@
             },
             'instance_type': {
                 'type': 'string',
             },
             'use_spot': {
                 'type': 'boolean',
             },
+            # Deprecated: use 'job_recovery' instead. This is for backward
+            # compatibility, and can be removed in 0.8.0.
             'spot_recovery': {
                 'type': 'string',
             },
+            'job_recovery': {
+                'type': 'string',
+            },
             'disk_size': {
                 'type': 'integer',
             },
             'disk_tier': {
                 'type': 'string',
             },
             'ports': {
@@ -214,15 +219,17 @@
                 'type': 'array',
                 'items': multi_resources_schema,
             },
             'ordered': {
                 'type': 'array',
                 'items': multi_resources_schema,
             }
-        }
+        },
+        # Avoid job_recovery and spot_recovery being present at the same time.
+        **_check_not_both_fields_present('job_recovery', 'spot_recovery')
     }
 
 
 def get_storage_schema():
     # pylint: disable=import-outside-toplevel
     from sky.data import storage
     return {
@@ -657,12 +664,15 @@
         config['properties'].update(_REMOTE_IDENTITY_SCHEMA)
     return {
         '$schema': 'https://json-schema.org/draft/2020-12/schema',
         'type': 'object',
         'required': [],
         'additionalProperties': False,
         'properties': {
+            'jobs': controller_resources_schema,
             'spot': controller_resources_schema,
             'serve': controller_resources_schema,
             **cloud_configs,
-        }
+        },
+        # Avoid spot and jobs being present at the same time.
+        **_check_not_both_fields_present('spot', 'jobs')
     }
```

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/utils/subprocess_utils.py` & `skypilot_nightly-1.0.0.dev20240505/sky/utils/subprocess_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/utils/timeline.py` & `skypilot_nightly-1.0.0.dev20240505/sky/utils/timeline.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/utils/ux_utils.py` & `skypilot_nightly-1.0.0.dev20240505/sky/utils/ux_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/sky/utils/validator.py` & `skypilot_nightly-1.0.0.dev20240505/sky/utils/validator.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/skypilot_nightly.egg-info/PKG-INFO` & `skypilot_nightly-1.0.0.dev20240505/skypilot_nightly.egg-info/PKG-INFO`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: skypilot-nightly
-Version: 1.0.0.dev20240504
+Version: 1.0.0.dev20240505
 Summary: SkyPilot: An intercloud broker for the clouds
 Author: SkyPilot Team
 License: Apache 2.0
 Project-URL: Homepage, https://github.com/skypilot-org/skypilot
 Project-URL: Issues, https://github.com/skypilot-org/skypilot/issues
 Project-URL: Discussion, https://github.com/skypilot-org/skypilot/discussions
 Project-URL: Documentation, https://skypilot.readthedocs.io/en/latest/
```

### Comparing `skypilot_nightly-1.0.0.dev20240504/skypilot_nightly.egg-info/SOURCES.txt` & `skypilot_nightly-1.0.0.dev20240505/skypilot_nightly.egg-info/SOURCES.txt`

 * *Files 5% similar despite different names*

```diff
@@ -91,14 +91,24 @@
 sky/clouds/utils/scp_utils.py
 sky/data/__init__.py
 sky/data/data_transfer.py
 sky/data/data_utils.py
 sky/data/mounting_utils.py
 sky/data/storage.py
 sky/data/storage_utils.py
+sky/jobs/__init__.py
+sky/jobs/constants.py
+sky/jobs/controller.py
+sky/jobs/core.py
+sky/jobs/recovery_strategy.py
+sky/jobs/state.py
+sky/jobs/utils.py
+sky/jobs/dashboard/dashboard.py
+sky/jobs/dashboard/static/favicon.ico
+sky/jobs/dashboard/templates/index.html
 sky/provision/__init__.py
 sky/provision/common.py
 sky/provision/docker_utils.py
 sky/provision/instance_setup.py
 sky/provision/logging.py
 sky/provision/metadata_utils.py
 sky/provision/provisioner.py
@@ -204,43 +214,33 @@
 sky/skylet/ray_patches/autoscaler.py.patch
 sky/skylet/ray_patches/cli.py.patch
 sky/skylet/ray_patches/command_runner.py.patch
 sky/skylet/ray_patches/log_monitor.py.patch
 sky/skylet/ray_patches/resource_demand_scheduler.py.patch
 sky/skylet/ray_patches/updater.py.patch
 sky/skylet/ray_patches/worker.py.patch
-sky/spot/__init__.py
-sky/spot/constants.py
-sky/spot/controller.py
-sky/spot/core.py
-sky/spot/recovery_strategy.py
-sky/spot/spot_state.py
-sky/spot/spot_utils.py
-sky/spot/dashboard/dashboard.py
-sky/spot/dashboard/static/favicon.ico
-sky/spot/dashboard/templates/index.html
 sky/templates/aws-ray.yml.j2
 sky/templates/azure-ray.yml.j2
 sky/templates/cudo-ray.yml.j2
 sky/templates/fluidstack-ray.yml.j2
 sky/templates/gcp-ray.yml.j2
 sky/templates/ibm-ray.yml.j2
+sky/templates/jobs-controller.yaml.j2
 sky/templates/kubernetes-ingress.yml.j2
 sky/templates/kubernetes-loadbalancer.yml.j2
 sky/templates/kubernetes-port-forward-proxy-command.sh.j2
 sky/templates/kubernetes-ray.yml.j2
 sky/templates/kubernetes-ssh-jump.yml.j2
 sky/templates/lambda-ray.yml.j2
 sky/templates/local-ray.yml.j2
 sky/templates/oci-ray.yml.j2
 sky/templates/paperspace-ray.yml.j2
 sky/templates/runpod-ray.yml.j2
 sky/templates/scp-ray.yml.j2
 sky/templates/sky-serve-controller.yaml.j2
-sky/templates/spot-controller.yaml.j2
 sky/templates/vsphere-ray.yml.j2
 sky/usage/__init__.py
 sky/usage/constants.py
 sky/usage/usage_lib.py
 sky/utils/__init__.py
 sky/utils/accelerator_registry.py
 sky/utils/cluster_yaml_utils.py
@@ -277,16 +277,16 @@
 skypilot_nightly.egg-info/requires.txt
 skypilot_nightly.egg-info/top_level.txt
 tests/test_api.py
 tests/test_cli.py
 tests/test_config.py
 tests/test_global_user_state.py
 tests/test_jobs.py
+tests/test_jobs_and_serve.py
 tests/test_list_accelerators.py
 tests/test_optimizer_dryruns.py
 tests/test_optimizer_random_dag.py
 tests/test_serve_autoscaler.py
 tests/test_smoke.py
-tests/test_spot_serve.py
 tests/test_storage.py
 tests/test_wheels.py
 tests/test_yaml_parser.py
```

### Comparing `skypilot_nightly-1.0.0.dev20240504/skypilot_nightly.egg-info/requires.txt` & `skypilot_nightly-1.0.0.dev20240505/skypilot_nightly.egg-info/requires.txt`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/tests/test_cli.py` & `skypilot_nightly-1.0.0.dev20240505/tests/test_cli.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/tests/test_config.py` & `skypilot_nightly-1.0.0.dev20240505/tests/test_config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/tests/test_jobs.py` & `skypilot_nightly-1.0.0.dev20240505/tests/test_jobs.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/tests/test_list_accelerators.py` & `skypilot_nightly-1.0.0.dev20240505/tests/test_list_accelerators.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/tests/test_optimizer_dryruns.py` & `skypilot_nightly-1.0.0.dev20240505/tests/test_optimizer_dryruns.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/tests/test_optimizer_random_dag.py` & `skypilot_nightly-1.0.0.dev20240505/tests/test_optimizer_random_dag.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/tests/test_serve_autoscaler.py` & `skypilot_nightly-1.0.0.dev20240505/tests/test_serve_autoscaler.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/tests/test_smoke.py` & `skypilot_nightly-1.0.0.dev20240505/tests/test_smoke.py`

 * *Files 4% similar despite different names*

```diff
@@ -19,13447 +19,13428 @@
 00000120: 6169 6c65 6420 7465 7374 730a 2320 3e20  ailed tests.# > 
 00000130: 7079 7465 7374 202d 2d6c 660a 230a 2320  pytest --lf.#.# 
 00000140: 5275 6e20 6f6e 6520 6f66 2074 6865 2073  Run one of the s
 00000150: 6d6f 6b65 2074 6573 7473 0a23 203e 2070  moke tests.# > p
 00000160: 7974 6573 7420 7465 7374 732f 7465 7374  ytest tests/test
 00000170: 5f73 6d6f 6b65 2e70 793a 3a74 6573 745f  _smoke.py::test_
 00000180: 6d69 6e69 6d61 6c0a 230a 2320 4f6e 6c79  minimal.#.# Only
-00000190: 2072 756e 206d 616e 6167 6564 2073 706f   run managed spo
-000001a0: 7420 7465 7374 730a 2320 3e20 7079 7465  t tests.# > pyte
-000001b0: 7374 2074 6573 7473 2f74 6573 745f 736d  st tests/test_sm
-000001c0: 6f6b 652e 7079 202d 2d6d 616e 6167 6564  oke.py --managed
-000001d0: 2d73 706f 740a 230a 2320 4f6e 6c79 2072  -spot.#.# Only r
-000001e0: 756e 2073 6b79 2073 6572 7665 2074 6573  un sky serve tes
-000001f0: 7473 0a23 203e 2070 7974 6573 7420 7465  ts.# > pytest te
-00000200: 7374 732f 7465 7374 5f73 6d6f 6b65 2e70  sts/test_smoke.p
-00000210: 7920 2d2d 736b 792d 7365 7276 650a 230a  y --sky-serve.#.
-00000220: 2320 4f6e 6c79 2072 756e 2074 6573 7420  # Only run test 
-00000230: 666f 7220 4157 5320 2b20 6765 6e65 7269  for AWS + generi
-00000240: 6320 7465 7374 730a 2320 3e20 7079 7465  c tests.# > pyte
-00000250: 7374 2074 6573 7473 2f74 6573 745f 736d  st tests/test_sm
-00000260: 6f6b 652e 7079 202d 2d61 7773 0a23 0a23  oke.py --aws.#.#
-00000270: 2043 6861 6e67 6520 636c 6f75 6420 666f   Change cloud fo
-00000280: 7220 6765 6e65 7269 6320 7465 7374 7320  r generic tests 
-00000290: 746f 2061 7773 0a23 203e 2070 7974 6573  to aws.# > pytes
-000002a0: 7420 7465 7374 732f 7465 7374 5f73 6d6f  t tests/test_smo
-000002b0: 6b65 2e70 7920 2d2d 6765 6e65 7269 632d  ke.py --generic-
-000002c0: 636c 6f75 6420 6177 730a 0a69 6d70 6f72  cloud aws..impor
-000002d0: 7420 696e 7370 6563 740a 696d 706f 7274  t inspect.import
-000002e0: 206a 736f 6e0a 696d 706f 7274 206f 730a   json.import os.
-000002f0: 696d 706f 7274 2070 6174 686c 6962 0a69  import pathlib.i
-00000300: 6d70 6f72 7420 7368 6c65 780a 696d 706f  mport shlex.impo
-00000310: 7274 2073 6875 7469 6c0a 696d 706f 7274  rt shutil.import
-00000320: 2073 7562 7072 6f63 6573 730a 696d 706f   subprocess.impo
-00000330: 7274 2073 7973 0a69 6d70 6f72 7420 7465  rt sys.import te
-00000340: 6d70 6669 6c65 0a69 6d70 6f72 7420 7469  mpfile.import ti
-00000350: 6d65 0a66 726f 6d20 7479 7069 6e67 2069  me.from typing i
-00000360: 6d70 6f72 7420 4469 6374 2c20 4c69 7374  mport Dict, List
-00000370: 2c20 4e61 6d65 6454 7570 6c65 2c20 4f70  , NamedTuple, Op
-00000380: 7469 6f6e 616c 2c20 5475 706c 650a 696d  tional, Tuple.im
-00000390: 706f 7274 2075 726c 6c69 622e 7061 7273  port urllib.pars
-000003a0: 650a 696d 706f 7274 2075 7569 640a 0a69  e.import uuid..i
-000003b0: 6d70 6f72 7420 636f 6c6f 7261 6d61 0a69  mport colorama.i
-000003c0: 6d70 6f72 7420 6a69 6e6a 6132 0a69 6d70  mport jinja2.imp
-000003d0: 6f72 7420 7079 7465 7374 0a0a 696d 706f  ort pytest..impo
-000003e0: 7274 2073 6b79 0a66 726f 6d20 736b 7920  rt sky.from sky 
-000003f0: 696d 706f 7274 2067 6c6f 6261 6c5f 7573  import global_us
-00000400: 6572 5f73 7461 7465 0a66 726f 6d20 736b  er_state.from sk
-00000410: 7920 696d 706f 7274 2073 6572 7665 0a66  y import serve.f
-00000420: 726f 6d20 736b 7920 696d 706f 7274 2073  rom sky import s
-00000430: 706f 740a 6672 6f6d 2073 6b79 2e61 6461  pot.from sky.ada
-00000440: 7074 6f72 7320 696d 706f 7274 2063 6c6f  ptors import clo
-00000450: 7564 666c 6172 650a 6672 6f6d 2073 6b79  udflare.from sky
-00000460: 2e61 6461 7074 6f72 7320 696d 706f 7274  .adaptors import
-00000470: 2069 626d 0a66 726f 6d20 736b 792e 636c   ibm.from sky.cl
-00000480: 6f75 6473 2069 6d70 6f72 7420 4157 530a  ouds import AWS.
-00000490: 6672 6f6d 2073 6b79 2e63 6c6f 7564 7320  from sky.clouds 
-000004a0: 696d 706f 7274 2041 7a75 7265 0a66 726f  import Azure.fro
-000004b0: 6d20 736b 792e 636c 6f75 6473 2069 6d70  m sky.clouds imp
-000004c0: 6f72 7420 4743 500a 6672 6f6d 2073 6b79  ort GCP.from sky
-000004d0: 2e64 6174 6120 696d 706f 7274 2064 6174  .data import dat
-000004e0: 615f 7574 696c 730a 6672 6f6d 2073 6b79  a_utils.from sky
-000004f0: 2e64 6174 6120 696d 706f 7274 2073 746f  .data import sto
-00000500: 7261 6765 2061 7320 7374 6f72 6167 655f  rage as storage_
-00000510: 6c69 620a 6672 6f6d 2073 6b79 2e64 6174  lib.from sky.dat
-00000520: 612e 6461 7461 5f75 7469 6c73 2069 6d70  a.data_utils imp
-00000530: 6f72 7420 5263 6c6f 6e65 0a66 726f 6d20  ort Rclone.from 
-00000540: 736b 792e 736b 796c 6574 2069 6d70 6f72  sky.skylet impor
-00000550: 7420 6576 656e 7473 0a66 726f 6d20 736b  t events.from sk
-00000560: 792e 7574 696c 7320 696d 706f 7274 2063  y.utils import c
-00000570: 6f6d 6d6f 6e5f 7574 696c 730a 6672 6f6d  ommon_utils.from
-00000580: 2073 6b79 2e75 7469 6c73 2069 6d70 6f72   sky.utils impor
-00000590: 7420 7265 736f 7572 6365 735f 7574 696c  t resources_util
-000005a0: 730a 6672 6f6d 2073 6b79 2e75 7469 6c73  s.from sky.utils
-000005b0: 2069 6d70 6f72 7420 7375 6270 726f 6365   import subproce
-000005c0: 7373 5f75 7469 6c73 0a0a 2320 546f 2061  ss_utils..# To a
-000005d0: 766f 6964 2074 6865 2073 6563 6f6e 6420  void the second 
-000005e0: 736d 6f6b 6520 7465 7374 2072 6575 7369  smoke test reusi
-000005f0: 6e67 2074 6865 2063 6c75 7374 6572 206c  ng the cluster l
-00000600: 6175 6e63 6865 6420 696e 2074 6865 2066  aunched in the f
-00000610: 6972 7374 0a23 2073 6d6f 6b65 2074 6573  irst.# smoke tes
-00000620: 742e 2041 6c73 6f20 7265 7175 6972 6564  t. Also required
-00000630: 2066 6f72 2074 6573 745f 7370 6f74 5f72   for test_spot_r
-00000640: 6563 6f76 6572 7920 746f 206d 616b 6520  ecovery to make 
-00000650: 7375 7265 2074 6865 206d 616e 7561 6c0a  sure the manual.
-00000660: 2320 7465 726d 696e 6174 696f 6e20 7769  # termination wi
-00000670: 7468 2061 7773 2065 6332 2064 6f65 7320  th aws ec2 does 
-00000680: 6e6f 7420 6163 6369 6465 6e74 616c 6c79  not accidentally
-00000690: 2074 6572 6d69 6e61 7465 206f 7468 6572   terminate other
-000006a0: 2073 706f 7420 636c 7573 7465 7273 0a23   spot clusters.#
-000006b0: 2066 726f 6d20 7468 6520 6469 6666 6572   from the differ
-000006c0: 656e 7420 7370 6f74 206c 6175 6e63 6820  ent spot launch 
-000006d0: 7769 7468 2074 6865 2073 616d 6520 636c  with the same cl
-000006e0: 7573 7465 7220 6e61 6d65 2062 7574 2061  uster name but a
-000006f0: 2064 6966 6665 7265 6e74 206a 6f62 0a23   different job.#
-00000700: 2069 642e 0a74 6573 745f 6964 203d 2073   id..test_id = s
-00000710: 7472 2875 7569 642e 7575 6964 3428 2929  tr(uuid.uuid4())
-00000720: 5b2d 323a 5d0a 0a4c 414d 4244 415f 5459  [-2:]..LAMBDA_TY
-00000730: 5045 203d 2027 2d2d 636c 6f75 6420 6c61  PE = '--cloud la
-00000740: 6d62 6461 202d 2d67 7075 7320 4131 3027  mbda --gpus A10'
-00000750: 0a46 4c55 4944 5354 4143 4b5f 5459 5045  .FLUIDSTACK_TYPE
-00000760: 203d 2027 2d2d 636c 6f75 6420 666c 7569   = '--cloud flui
-00000770: 6473 7461 636b 202d 2d67 7075 7320 5254  dstack --gpus RT
-00000780: 5841 3430 3030 270a 0a53 4350 5f54 5950  XA4000'..SCP_TYP
-00000790: 4520 3d20 272d 2d63 6c6f 7564 2073 6370  E = '--cloud scp
-000007a0: 270a 5343 505f 4750 555f 5631 3030 203d  '.SCP_GPU_V100 =
-000007b0: 2027 2d2d 6770 7573 2056 3130 302d 3332   '--gpus V100-32
-000007c0: 4742 270a 0a73 746f 7261 6765 5f73 6574  GB'..storage_set
-000007d0: 7570 5f63 6f6d 6d61 6e64 7320 3d20 5b0a  up_commands = [.
-000007e0: 2020 2020 2774 6f75 6368 207e 2f74 6d70      'touch ~/tmp
-000007f0: 6669 6c65 272c 2027 6d6b 6469 7220 2d70  file', 'mkdir -p
-00000800: 207e 2f74 6d70 2d77 6f72 6b64 6972 272c   ~/tmp-workdir',
-00000810: 0a20 2020 2027 746f 7563 6820 7e2f 746d  .    'touch ~/tm
-00000820: 702d 776f 726b 6469 722f 746d 705c 2066  p-workdir/tmp\ f
-00000830: 696c 6527 2c20 2774 6f75 6368 207e 2f74  ile', 'touch ~/t
-00000840: 6d70 2d77 6f72 6b64 6972 2f74 6d70 5c20  mp-workdir/tmp\ 
-00000850: 6669 6c65 3227 2c0a 2020 2020 2774 6f75  file2',.    'tou
-00000860: 6368 207e 2f74 6d70 2d77 6f72 6b64 6972  ch ~/tmp-workdir
-00000870: 2f66 6f6f 272c 0a20 2020 2027 5b20 2120  /foo',.    '[ ! 
-00000880: 2d65 207e 2f74 6d70 2d77 6f72 6b64 6972  -e ~/tmp-workdir
-00000890: 2f63 6972 636c 652d 6c69 6e6b 205d 2026  /circle-link ] &
-000008a0: 2620 6c6e 202d 7320 7e2f 746d 702d 776f  & ln -s ~/tmp-wo
-000008b0: 726b 6469 722f 207e 2f74 6d70 2d77 6f72  rkdir/ ~/tmp-wor
-000008c0: 6b64 6972 2f63 6972 636c 652d 6c69 6e6b  kdir/circle-link
-000008d0: 207c 7c20 7472 7565 272c 0a20 2020 2027   || true',.    '
-000008e0: 746f 7563 6820 7e2f 2e73 7368 2f69 645f  touch ~/.ssh/id_
-000008f0: 7273 612e 7075 6227 0a5d 0a0a 2320 5761  rsa.pub'.]..# Wa
-00000900: 6974 2075 6e74 696c 2074 6865 2073 706f  it until the spo
-00000910: 7420 636f 6e74 726f 6c6c 6572 2069 7320  t controller is 
-00000920: 6e6f 7420 696e 2049 4e49 5420 7374 6174  not in INIT stat
-00000930: 652e 0a23 2054 6869 7320 6973 2061 2077  e..# This is a w
-00000940: 6f72 6b61 726f 756e 6420 666f 7220 7468  orkaround for th
-00000950: 6520 6973 7375 6520 7468 6174 2077 6865  e issue that whe
-00000960: 6e20 6d75 6c74 6970 6c65 2073 706f 7420  n multiple spot 
-00000970: 7465 7374 730a 2320 6172 6520 7275 6e6e  tests.# are runn
-00000980: 696e 6720 696e 2070 6172 616c 6c65 6c2c  ing in parallel,
-00000990: 2074 6865 2073 706f 7420 636f 6e74 726f   the spot contro
-000009a0: 6c6c 6572 206d 6179 2062 6520 696e 2049  ller may be in I
-000009b0: 4e49 5420 616e 640a 2320 7468 6520 7370  NIT and.# the sp
-000009c0: 6f74 2071 7565 7565 2f63 616e 6365 6c20  ot queue/cancel 
-000009d0: 636f 6d6d 616e 6420 7769 6c6c 2072 6574  command will ret
-000009e0: 7572 6e20 7374 616c 6564 2074 6162 6c65  urn staled table
-000009f0: 2e0a 5f53 504f 545f 5155 4555 455f 5741  .._SPOT_QUEUE_WA
-00000a00: 4954 203d 2028 2773 3d24 2873 6b79 2073  IT = ('s=$(sky s
-00000a10: 706f 7420 7175 6575 6529 3b20 270a 2020  pot queue); '.  
-00000a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00000a30: 2020 2775 6e74 696c 2021 2065 6368 6f20    'until ! echo 
-00000a40: 2224 7322 207c 2067 7265 7020 226a 6f62  "$s" | grep "job
-00000a50: 7320 7769 6c6c 206e 6f74 2062 6520 7368  s will not be sh
-00000a60: 6f77 6e20 756e 7469 6c22 3b20 270a 2020  own until"; '.  
-00000a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00000a80: 2020 2764 6f20 6563 686f 2022 5761 6974    'do echo "Wait
-00000a90: 696e 6720 666f 7220 7370 6f74 2071 7565  ing for spot que
-00000aa0: 7565 2074 6f20 6265 2072 6561 6479 2e2e  ue to be ready..
-00000ab0: 2e22 3b20 270a 2020 2020 2020 2020 2020  ."; '.          
-00000ac0: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
-00000ad0: 2035 3b20 733d 2428 736b 7920 7370 6f74   5; s=$(sky spot
-00000ae0: 2071 7565 7565 293b 2064 6f6e 653b 2065   queue); done; e
-00000af0: 6368 6f20 2224 7322 3b20 270a 2020 2020  cho "$s"; '.    
+00000190: 2072 756e 206d 616e 6167 6564 206a 6f62   run managed job
+000001a0: 2074 6573 7473 0a23 203e 2070 7974 6573   tests.# > pytes
+000001b0: 7420 7465 7374 732f 7465 7374 5f73 6d6f  t tests/test_smo
+000001c0: 6b65 2e70 7920 2d2d 6d61 6e61 6765 642d  ke.py --managed-
+000001d0: 6a6f 6273 0a23 0a23 204f 6e6c 7920 7275  jobs.#.# Only ru
+000001e0: 6e20 736b 7920 7365 7276 6520 7465 7374  n sky serve test
+000001f0: 730a 2320 3e20 7079 7465 7374 2074 6573  s.# > pytest tes
+00000200: 7473 2f74 6573 745f 736d 6f6b 652e 7079  ts/test_smoke.py
+00000210: 202d 2d73 6b79 2d73 6572 7665 0a23 0a23   --sky-serve.#.#
+00000220: 204f 6e6c 7920 7275 6e20 7465 7374 2066   Only run test f
+00000230: 6f72 2041 5753 202b 2067 656e 6572 6963  or AWS + generic
+00000240: 2074 6573 7473 0a23 203e 2070 7974 6573   tests.# > pytes
+00000250: 7420 7465 7374 732f 7465 7374 5f73 6d6f  t tests/test_smo
+00000260: 6b65 2e70 7920 2d2d 6177 730a 230a 2320  ke.py --aws.#.# 
+00000270: 4368 616e 6765 2063 6c6f 7564 2066 6f72  Change cloud for
+00000280: 2067 656e 6572 6963 2074 6573 7473 2074   generic tests t
+00000290: 6f20 6177 730a 2320 3e20 7079 7465 7374  o aws.# > pytest
+000002a0: 2074 6573 7473 2f74 6573 745f 736d 6f6b   tests/test_smok
+000002b0: 652e 7079 202d 2d67 656e 6572 6963 2d63  e.py --generic-c
+000002c0: 6c6f 7564 2061 7773 0a0a 696d 706f 7274  loud aws..import
+000002d0: 2069 6e73 7065 6374 0a69 6d70 6f72 7420   inspect.import 
+000002e0: 6a73 6f6e 0a69 6d70 6f72 7420 6f73 0a69  json.import os.i
+000002f0: 6d70 6f72 7420 7061 7468 6c69 620a 696d  mport pathlib.im
+00000300: 706f 7274 2073 686c 6578 0a69 6d70 6f72  port shlex.impor
+00000310: 7420 7368 7574 696c 0a69 6d70 6f72 7420  t shutil.import 
+00000320: 7375 6270 726f 6365 7373 0a69 6d70 6f72  subprocess.impor
+00000330: 7420 7379 730a 696d 706f 7274 2074 656d  t sys.import tem
+00000340: 7066 696c 650a 696d 706f 7274 2074 696d  pfile.import tim
+00000350: 650a 6672 6f6d 2074 7970 696e 6720 696d  e.from typing im
+00000360: 706f 7274 2044 6963 742c 204c 6973 742c  port Dict, List,
+00000370: 204e 616d 6564 5475 706c 652c 204f 7074   NamedTuple, Opt
+00000380: 696f 6e61 6c2c 2054 7570 6c65 0a69 6d70  ional, Tuple.imp
+00000390: 6f72 7420 7572 6c6c 6962 2e70 6172 7365  ort urllib.parse
+000003a0: 0a69 6d70 6f72 7420 7575 6964 0a0a 696d  .import uuid..im
+000003b0: 706f 7274 2063 6f6c 6f72 616d 610a 696d  port colorama.im
+000003c0: 706f 7274 206a 696e 6a61 320a 696d 706f  port jinja2.impo
+000003d0: 7274 2070 7974 6573 740a 0a69 6d70 6f72  rt pytest..impor
+000003e0: 7420 736b 790a 6672 6f6d 2073 6b79 2069  t sky.from sky i
+000003f0: 6d70 6f72 7420 676c 6f62 616c 5f75 7365  mport global_use
+00000400: 725f 7374 6174 650a 6672 6f6d 2073 6b79  r_state.from sky
+00000410: 2069 6d70 6f72 7420 6a6f 6273 0a66 726f   import jobs.fro
+00000420: 6d20 736b 7920 696d 706f 7274 2073 6572  m sky import ser
+00000430: 7665 0a66 726f 6d20 736b 792e 6164 6170  ve.from sky.adap
+00000440: 746f 7273 2069 6d70 6f72 7420 636c 6f75  tors import clou
+00000450: 6466 6c61 7265 0a66 726f 6d20 736b 792e  dflare.from sky.
+00000460: 6164 6170 746f 7273 2069 6d70 6f72 7420  adaptors import 
+00000470: 6962 6d0a 6672 6f6d 2073 6b79 2e63 6c6f  ibm.from sky.clo
+00000480: 7564 7320 696d 706f 7274 2041 5753 0a66  uds import AWS.f
+00000490: 726f 6d20 736b 792e 636c 6f75 6473 2069  rom sky.clouds i
+000004a0: 6d70 6f72 7420 417a 7572 650a 6672 6f6d  mport Azure.from
+000004b0: 2073 6b79 2e63 6c6f 7564 7320 696d 706f   sky.clouds impo
+000004c0: 7274 2047 4350 0a66 726f 6d20 736b 792e  rt GCP.from sky.
+000004d0: 6461 7461 2069 6d70 6f72 7420 6461 7461  data import data
+000004e0: 5f75 7469 6c73 0a66 726f 6d20 736b 792e  _utils.from sky.
+000004f0: 6461 7461 2069 6d70 6f72 7420 7374 6f72  data import stor
+00000500: 6167 6520 6173 2073 746f 7261 6765 5f6c  age as storage_l
+00000510: 6962 0a66 726f 6d20 736b 792e 6461 7461  ib.from sky.data
+00000520: 2e64 6174 615f 7574 696c 7320 696d 706f  .data_utils impo
+00000530: 7274 2052 636c 6f6e 650a 6672 6f6d 2073  rt Rclone.from s
+00000540: 6b79 2e73 6b79 6c65 7420 696d 706f 7274  ky.skylet import
+00000550: 2065 7665 6e74 730a 6672 6f6d 2073 6b79   events.from sky
+00000560: 2e75 7469 6c73 2069 6d70 6f72 7420 636f  .utils import co
+00000570: 6d6d 6f6e 5f75 7469 6c73 0a66 726f 6d20  mmon_utils.from 
+00000580: 736b 792e 7574 696c 7320 696d 706f 7274  sky.utils import
+00000590: 2072 6573 6f75 7263 6573 5f75 7469 6c73   resources_utils
+000005a0: 0a66 726f 6d20 736b 792e 7574 696c 7320  .from sky.utils 
+000005b0: 696d 706f 7274 2073 7562 7072 6f63 6573  import subproces
+000005c0: 735f 7574 696c 730a 0a23 2054 6f20 6176  s_utils..# To av
+000005d0: 6f69 6420 7468 6520 7365 636f 6e64 2073  oid the second s
+000005e0: 6d6f 6b65 2074 6573 7420 7265 7573 696e  moke test reusin
+000005f0: 6720 7468 6520 636c 7573 7465 7220 6c61  g the cluster la
+00000600: 756e 6368 6564 2069 6e20 7468 6520 6669  unched in the fi
+00000610: 7273 740a 2320 736d 6f6b 6520 7465 7374  rst.# smoke test
+00000620: 2e20 416c 736f 2072 6571 7569 7265 6420  . Also required 
+00000630: 666f 7220 7465 7374 5f6d 616e 6167 6564  for test_managed
+00000640: 5f6a 6f62 735f 7265 636f 7665 7279 2074  _jobs_recovery t
+00000650: 6f20 6d61 6b65 2073 7572 6520 7468 650a  o make sure the.
+00000660: 2320 6d61 6e75 616c 2074 6572 6d69 6e61  # manual termina
+00000670: 7469 6f6e 2077 6974 6820 6177 7320 6563  tion with aws ec
+00000680: 3220 646f 6573 206e 6f74 2061 6363 6964  2 does not accid
+00000690: 656e 7461 6c6c 7920 7465 726d 696e 6174  entally terminat
+000006a0: 6520 6f74 6865 7220 636c 7573 7465 7273  e other clusters
+000006b0: 0a23 2066 6f72 2066 6f72 2074 6865 2064  .# for for the d
+000006c0: 6966 6665 7265 6e74 206d 616e 6167 6564  ifferent managed
+000006d0: 206a 6f62 7320 6c61 756e 6368 2077 6974   jobs launch wit
+000006e0: 6820 7468 6520 7361 6d65 206a 6f62 206e  h the same job n
+000006f0: 616d 6520 6275 7420 610a 2320 6469 6666  ame but a.# diff
+00000700: 6572 656e 7420 6a6f 6220 6964 2e0a 7465  erent job id..te
+00000710: 7374 5f69 6420 3d20 7374 7228 7575 6964  st_id = str(uuid
+00000720: 2e75 7569 6434 2829 295b 2d32 3a5d 0a0a  .uuid4())[-2:]..
+00000730: 4c41 4d42 4441 5f54 5950 4520 3d20 272d  LAMBDA_TYPE = '-
+00000740: 2d63 6c6f 7564 206c 616d 6264 6120 2d2d  -cloud lambda --
+00000750: 6770 7573 2041 3130 270a 464c 5549 4453  gpus A10'.FLUIDS
+00000760: 5441 434b 5f54 5950 4520 3d20 272d 2d63  TACK_TYPE = '--c
+00000770: 6c6f 7564 2066 6c75 6964 7374 6163 6b20  loud fluidstack 
+00000780: 2d2d 6770 7573 2052 5458 4134 3030 3027  --gpus RTXA4000'
+00000790: 0a0a 5343 505f 5459 5045 203d 2027 2d2d  ..SCP_TYPE = '--
+000007a0: 636c 6f75 6420 7363 7027 0a53 4350 5f47  cloud scp'.SCP_G
+000007b0: 5055 5f56 3130 3020 3d20 272d 2d67 7075  PU_V100 = '--gpu
+000007c0: 7320 5631 3030 2d33 3247 4227 0a0a 7374  s V100-32GB'..st
+000007d0: 6f72 6167 655f 7365 7475 705f 636f 6d6d  orage_setup_comm
+000007e0: 616e 6473 203d 205b 0a20 2020 2027 746f  ands = [.    'to
+000007f0: 7563 6820 7e2f 746d 7066 696c 6527 2c20  uch ~/tmpfile', 
+00000800: 276d 6b64 6972 202d 7020 7e2f 746d 702d  'mkdir -p ~/tmp-
+00000810: 776f 726b 6469 7227 2c0a 2020 2020 2774  workdir',.    't
+00000820: 6f75 6368 207e 2f74 6d70 2d77 6f72 6b64  ouch ~/tmp-workd
+00000830: 6972 2f74 6d70 5c20 6669 6c65 272c 2027  ir/tmp\ file', '
+00000840: 746f 7563 6820 7e2f 746d 702d 776f 726b  touch ~/tmp-work
+00000850: 6469 722f 746d 705c 2066 696c 6532 272c  dir/tmp\ file2',
+00000860: 0a20 2020 2027 746f 7563 6820 7e2f 746d  .    'touch ~/tm
+00000870: 702d 776f 726b 6469 722f 666f 6f27 2c0a  p-workdir/foo',.
+00000880: 2020 2020 275b 2021 202d 6520 7e2f 746d      '[ ! -e ~/tm
+00000890: 702d 776f 726b 6469 722f 6369 7263 6c65  p-workdir/circle
+000008a0: 2d6c 696e 6b20 5d20 2626 206c 6e20 2d73  -link ] && ln -s
+000008b0: 207e 2f74 6d70 2d77 6f72 6b64 6972 2f20   ~/tmp-workdir/ 
+000008c0: 7e2f 746d 702d 776f 726b 6469 722f 6369  ~/tmp-workdir/ci
+000008d0: 7263 6c65 2d6c 696e 6b20 7c7c 2074 7275  rcle-link || tru
+000008e0: 6527 2c0a 2020 2020 2774 6f75 6368 207e  e',.    'touch ~
+000008f0: 2f2e 7373 682f 6964 5f72 7361 2e70 7562  /.ssh/id_rsa.pub
+00000900: 270a 5d0a 0a23 2057 6169 7420 756e 7469  '.]..# Wait unti
+00000910: 6c20 7468 6520 6a6f 6273 2063 6f6e 7472  l the jobs contr
+00000920: 6f6c 6c65 7220 6973 206e 6f74 2069 6e20  oller is not in 
+00000930: 494e 4954 2073 7461 7465 2e0a 2320 5468  INIT state..# Th
+00000940: 6973 2069 7320 6120 776f 726b 6172 6f75  is is a workarou
+00000950: 6e64 2066 6f72 2074 6865 2069 7373 7565  nd for the issue
+00000960: 2074 6861 7420 7768 656e 206d 756c 7469   that when multi
+00000970: 706c 6520 6a6f 6220 7465 7374 730a 2320  ple job tests.# 
+00000980: 6172 6520 7275 6e6e 696e 6720 696e 2070  are running in p
+00000990: 6172 616c 6c65 6c2c 2074 6865 206a 6f62  arallel, the job
+000009a0: 7320 636f 6e74 726f 6c6c 6572 206d 6179  s controller may
+000009b0: 2062 6520 696e 2049 4e49 5420 616e 640a   be in INIT and.
+000009c0: 2320 7468 6520 6a6f 6220 7175 6575 652f  # the job queue/
+000009d0: 6361 6e63 656c 2063 6f6d 6d61 6e64 2077  cancel command w
+000009e0: 696c 6c20 7265 7475 726e 2073 7461 6c65  ill return stale
+000009f0: 6420 7461 626c 652e 0a5f 4a4f 425f 5155  d table.._JOB_QU
+00000a00: 4555 455f 5741 4954 203d 2028 2773 3d24  EUE_WAIT = ('s=$
+00000a10: 2873 6b79 206a 6f62 7320 7175 6575 6529  (sky jobs queue)
+00000a20: 3b20 270a 2020 2020 2020 2020 2020 2020  ; '.            
+00000a30: 2020 2020 2020 2027 756e 7469 6c20 2120         'until ! 
+00000a40: 6563 686f 2022 2473 2220 7c20 6772 6570  echo "$s" | grep
+00000a50: 2022 6a6f 6273 2077 696c 6c20 6e6f 7420   "jobs will not 
+00000a60: 6265 2073 686f 776e 2075 6e74 696c 223b  be shown until";
+00000a70: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+00000a80: 2020 2020 2020 2764 6f20 6563 686f 2022        'do echo "
+00000a90: 5761 6974 696e 6720 666f 7220 6a6f 6220  Waiting for job 
+00000aa0: 7175 6575 6520 746f 2062 6520 7265 6164  queue to be read
+00000ab0: 792e 2e2e 223b 2027 0a20 2020 2020 2020  y..."; '.       
+00000ac0: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
+00000ad0: 6570 2035 3b20 733d 2428 736b 7920 6a6f  ep 5; s=$(sky jo
+00000ae0: 6273 2071 7565 7565 293b 2064 6f6e 653b  bs queue); done;
+00000af0: 2065 6368 6f20 2224 7322 3b20 270a 2020   echo "$s"; '.  
 00000b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00000b10: 2765 6368 6f3b 2065 6368 6f3b 2065 6368  'echo; echo; ech
-00000b20: 6f20 2224 7322 2729 0a5f 5350 4f54 5f43  o "$s"')._SPOT_C
+00000b10: 2027 6563 686f 3b20 6563 686f 3b20 6563   'echo; echo; ec
+00000b20: 686f 2022 2473 2227 290a 5f4a 4f42 5f43  ho "$s"')._JOB_C
 00000b30: 414e 4345 4c5f 5741 4954 203d 2028 0a20  ANCEL_WAIT = (. 
-00000b40: 2020 2027 733d 2428 736b 7920 7370 6f74     's=$(sky spot
+00000b40: 2020 2027 733d 2428 736b 7920 6a6f 6273     's=$(sky jobs
 00000b50: 2063 616e 6365 6c20 2d79 202d 6e20 7b6a   cancel -y -n {j
 00000b60: 6f62 5f6e 616d 657d 293b 2027 0a20 2020  ob_name}); '.   
 00000b70: 2027 756e 7469 6c20 2120 6563 686f 2022   'until ! echo "
 00000b80: 2473 2220 7c20 6772 6570 2022 506c 6561  $s" | grep "Plea
 00000b90: 7365 2077 6169 7420 666f 7220 7468 6520  se wait for the 
 00000ba0: 636f 6e74 726f 6c6c 6572 2074 6f20 6265  controller to be
 00000bb0: 2072 6561 6479 2e22 3b20 270a 2020 2020   ready."; '.    
 00000bc0: 2764 6f20 6563 686f 2022 5761 6974 696e  'do echo "Waitin
-00000bd0: 6720 666f 7220 7468 6520 7370 6f74 2063  g for the spot c
+00000bd0: 6720 666f 7220 7468 6520 6a6f 6273 2063  g for the jobs c
 00000be0: 6f6e 7472 6f6c 6c65 7220 270a 2020 2020  ontroller '.    
 00000bf0: 2774 6f20 6265 2072 6561 6479 223b 2073  'to be ready"; s
 00000c00: 6c65 6570 2035 3b20 733d 2428 736b 7920  leep 5; s=$(sky 
-00000c10: 7370 6f74 2063 616e 6365 6c20 2d79 202d  spot cancel -y -
+00000c10: 6a6f 6273 2063 616e 6365 6c20 2d79 202d  jobs cancel -y -
 00000c20: 6e20 7b6a 6f62 5f6e 616d 657d 293b 2027  n {job_name}); '
 00000c30: 0a20 2020 2027 646f 6e65 3b20 6563 686f  .    'done; echo
 00000c40: 2022 2473 223b 2065 6368 6f3b 2065 6368   "$s"; echo; ech
 00000c50: 6f3b 2065 6368 6f20 2224 7322 2729 0a23  o; echo "$s"').#
 00000c60: 2054 4f44 4f28 7a68 7775 293a 206d 616b   TODO(zhwu): mak
-00000c70: 6520 7468 6520 7370 6f74 2063 6f6e 7472  e the spot contr
-00000c80: 6f6c 6c65 7220 6f6e 2047 4350 2e0a 0a44  oller on GCP...D
-00000c90: 4546 4155 4c54 5f43 4d44 5f54 494d 454f  EFAULT_CMD_TIMEO
-00000ca0: 5554 203d 2031 3520 2a20 3630 0a0a 0a63  UT = 15 * 60...c
-00000cb0: 6c61 7373 2054 6573 7428 4e61 6d65 6454  lass Test(NamedT
-00000cc0: 7570 6c65 293a 0a20 2020 206e 616d 653a  uple):.    name:
-00000cd0: 2073 7472 0a20 2020 2023 2045 6163 6820   str.    # Each 
-00000ce0: 636f 6d6d 616e 6420 6973 2065 7865 6375  command is execu
-00000cf0: 7465 6420 7365 7269 616c 6c79 2e20 2049  ted serially.  I
-00000d00: 6620 616e 7920 6661 696c 6564 2c20 7468  f any failed, th
-00000d10: 6520 7265 6d61 696e 696e 6720 636f 6d6d  e remaining comm
-00000d20: 616e 6473 0a20 2020 2023 2061 7265 206e  ands.    # are n
-00000d30: 6f74 2072 756e 2061 6e64 2074 6865 2074  ot run and the t
-00000d40: 6573 7420 6973 2074 7265 6174 6564 2061  est is treated a
-00000d50: 7320 6661 696c 6564 2e0a 2020 2020 636f  s failed..    co
-00000d60: 6d6d 616e 6473 3a20 4c69 7374 5b73 7472  mmands: List[str
-00000d70: 5d0a 2020 2020 7465 6172 646f 776e 3a20  ].    teardown: 
-00000d80: 4f70 7469 6f6e 616c 5b73 7472 5d20 3d20  Optional[str] = 
-00000d90: 4e6f 6e65 0a20 2020 2023 2054 696d 656f  None.    # Timeo
-00000da0: 7574 2066 6f72 2065 6163 6820 636f 6d6d  ut for each comm
-00000db0: 616e 6420 696e 2073 6563 6f6e 6473 2e0a  and in seconds..
-00000dc0: 2020 2020 7469 6d65 6f75 743a 2069 6e74      timeout: int
-00000dd0: 203d 2044 4546 4155 4c54 5f43 4d44 5f54   = DEFAULT_CMD_T
-00000de0: 494d 454f 5554 0a0a 2020 2020 6465 6620  IMEOUT..    def 
-00000df0: 6563 686f 2873 656c 662c 206d 6573 7361  echo(self, messa
-00000e00: 6765 3a20 7374 7229 3a0a 2020 2020 2020  ge: str):.      
-00000e10: 2020 2320 7079 7465 7374 2773 2078 6469    # pytest's xdi
-00000e20: 7374 2070 6c75 6769 6e20 6361 7074 7572  st plugin captur
-00000e30: 6573 2073 7464 6f75 743b 2070 7269 6e74  es stdout; print
-00000e40: 2074 6f20 7374 6465 7272 2073 6f20 7468   to stderr so th
-00000e50: 6174 2074 6865 0a20 2020 2020 2020 2023  at the.        #
-00000e60: 206c 6f67 7320 6172 6520 7374 7265 616d   logs are stream
-00000e70: 696e 6720 7768 696c 6520 7468 6520 7465  ing while the te
-00000e80: 7374 7320 6172 6520 7275 6e6e 696e 672e  sts are running.
-00000e90: 0a20 2020 2020 2020 2070 7265 6669 7820  .        prefix 
-00000ea0: 3d20 6627 5b7b 7365 6c66 2e6e 616d 657d  = f'[{self.name}
-00000eb0: 5d27 0a20 2020 2020 2020 206d 6573 7361  ]'.        messa
-00000ec0: 6765 203d 2066 277b 7072 6566 6978 7d20  ge = f'{prefix} 
-00000ed0: 7b6d 6573 7361 6765 7d27 0a20 2020 2020  {message}'.     
-00000ee0: 2020 206d 6573 7361 6765 203d 206d 6573     message = mes
-00000ef0: 7361 6765 2e72 6570 6c61 6365 2827 5c6e  sage.replace('\n
-00000f00: 272c 2066 275c 6e7b 7072 6566 6978 7d20  ', f'\n{prefix} 
-00000f10: 2729 0a20 2020 2020 2020 2070 7269 6e74  ').        print
-00000f20: 286d 6573 7361 6765 2c20 6669 6c65 3d73  (message, file=s
-00000f30: 7973 2e73 7464 6572 722c 2066 6c75 7368  ys.stderr, flush
-00000f40: 3d54 7275 6529 0a0a 0a64 6566 205f 6765  =True)...def _ge
-00000f50: 745f 7469 6d65 6f75 7428 6765 6e65 7269  t_timeout(generi
-00000f60: 635f 636c 6f75 643a 2073 7472 2c0a 2020  c_cloud: str,.  
-00000f70: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-00000f80: 7665 7272 6964 655f 7469 6d65 6f75 743a  verride_timeout:
-00000f90: 2069 6e74 203d 2044 4546 4155 4c54 5f43   int = DEFAULT_C
-00000fa0: 4d44 5f54 494d 454f 5554 293a 0a20 2020  MD_TIMEOUT):.   
-00000fb0: 2074 696d 656f 7574 7320 3d20 7b27 666c   timeouts = {'fl
-00000fc0: 7569 6473 7461 636b 273a 2036 3020 2a20  uidstack': 60 * 
-00000fd0: 3630 7d20 2023 2066 696c 655f 6d6f 756e  60}  # file_moun
-00000fe0: 7473 0a20 2020 2072 6574 7572 6e20 7469  ts.    return ti
-00000ff0: 6d65 6f75 7473 2e67 6574 2867 656e 6572  meouts.get(gener
-00001000: 6963 5f63 6c6f 7564 2c20 6f76 6572 7269  ic_cloud, overri
-00001010: 6465 5f74 696d 656f 7574 290a 0a0a 6465  de_timeout)...de
-00001020: 6620 5f67 6574 5f63 6c75 7374 6572 5f6e  f _get_cluster_n
-00001030: 616d 6528 2920 2d3e 2073 7472 3a0a 2020  ame() -> str:.  
-00001040: 2020 2222 2252 6574 7572 6e73 2061 2075    """Returns a u
-00001050: 7365 722d 756e 6971 7565 2063 6c75 7374  ser-unique clust
-00001060: 6572 206e 616d 6520 666f 7220 6561 6368  er name for each
-00001070: 2074 6573 745f 3c6e 616d 653e 2829 2e0a   test_<name>()..
-00001080: 0a20 2020 204d 7573 7420 6265 2063 616c  .    Must be cal
-00001090: 6c65 6420 6672 6f6d 2065 6163 6820 7465  led from each te
-000010a0: 7374 5f3c 6e61 6d65 3e28 292e 0a20 2020  st_<name>()..   
-000010b0: 2022 2222 0a20 2020 2063 616c 6c65 725f   """.    caller_
-000010c0: 6675 6e63 5f6e 616d 6520 3d20 696e 7370  func_name = insp
-000010d0: 6563 742e 7374 6163 6b28 295b 315d 5b33  ect.stack()[1][3
-000010e0: 5d0a 2020 2020 7465 7374 5f6e 616d 6520  ].    test_name 
-000010f0: 3d20 6361 6c6c 6572 5f66 756e 635f 6e61  = caller_func_na
-00001100: 6d65 2e72 6570 6c61 6365 2827 5f27 2c20  me.replace('_', 
-00001110: 272d 2729 2e72 6570 6c61 6365 2827 7465  '-').replace('te
-00001120: 7374 2d27 2c20 2774 2d27 290a 2020 2020  st-', 't-').    
-00001130: 7465 7374 5f6e 616d 6520 3d20 636f 6d6d  test_name = comm
-00001140: 6f6e 5f75 7469 6c73 2e6d 616b 655f 636c  on_utils.make_cl
-00001150: 7573 7465 725f 6e61 6d65 5f6f 6e5f 636c  uster_name_on_cl
-00001160: 6f75 6428 7465 7374 5f6e 616d 652c 0a20  oud(test_name,. 
-00001170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000011a0: 2020 2020 2020 2032 342c 0a20 2020 2020         24,.     
-000011b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000011c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000011d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000011e0: 2020 2061 6464 5f75 7365 725f 6861 7368     add_user_hash
-000011f0: 3d46 616c 7365 290a 2020 2020 7265 7475  =False).    retu
-00001200: 726e 2066 277b 7465 7374 5f6e 616d 657d  rn f'{test_name}
-00001210: 2d7b 7465 7374 5f69 647d 270a 0a0a 6465  -{test_id}'...de
-00001220: 6620 5f74 6572 6d69 6e61 7465 5f67 6370  f _terminate_gcp
-00001230: 5f72 6570 6c69 6361 286e 616d 653a 2073  _replica(name: s
-00001240: 7472 2c20 7a6f 6e65 3a20 7374 722c 2072  tr, zone: str, r
-00001250: 6570 6c69 6361 5f69 643a 2069 6e74 2920  eplica_id: int) 
-00001260: 2d3e 2073 7472 3a0a 2020 2020 636c 7573  -> str:.    clus
-00001270: 7465 725f 6e61 6d65 203d 2073 6572 7665  ter_name = serve
-00001280: 2e67 656e 6572 6174 655f 7265 706c 6963  .generate_replic
-00001290: 615f 636c 7573 7465 725f 6e61 6d65 286e  a_cluster_name(n
-000012a0: 616d 652c 2072 6570 6c69 6361 5f69 6429  ame, replica_id)
-000012b0: 0a20 2020 2071 7565 7279 5f63 6d64 203d  .    query_cmd =
-000012c0: 2028 6627 6763 6c6f 7564 2063 6f6d 7075   (f'gcloud compu
-000012d0: 7465 2069 6e73 7461 6e63 6573 206c 6973  te instances lis
-000012e0: 7420 2d2d 6669 6c74 6572 3d27 0a20 2020  t --filter='.   
-000012f0: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-00001300: 2228 6c61 6265 6c73 2e72 6179 2d63 6c75  "(labels.ray-clu
-00001310: 7374 6572 2d6e 616d 653a 7b63 6c75 7374  ster-name:{clust
-00001320: 6572 5f6e 616d 657d 2922 2027 0a20 2020  er_name})" '.   
-00001330: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-00001340: 2d2d 7a6f 6e65 733d 7b7a 6f6e 657d 202d  --zones={zone} -
-00001350: 2d66 6f72 6d61 743d 2276 616c 7565 286e  -format="value(n
-00001360: 616d 6529 2227 290a 2020 2020 7265 7475  ame)"').    retu
-00001370: 726e 2028 6627 6763 6c6f 7564 2063 6f6d  rn (f'gcloud com
-00001380: 7075 7465 2069 6e73 7461 6e63 6573 2064  pute instances d
-00001390: 656c 6574 6520 2d2d 7a6f 6e65 3d7b 7a6f  elete --zone={zo
-000013a0: 6e65 7d27 0a20 2020 2020 2020 2020 2020  ne}'.           
-000013b0: 2066 2720 2d2d 7175 6965 7420 2428 7b71   f' --quiet $({q
-000013c0: 7565 7279 5f63 6d64 7d29 2729 0a0a 0a64  uery_cmd})')...d
-000013d0: 6566 2072 756e 5f6f 6e65 5f74 6573 7428  ef run_one_test(
-000013e0: 7465 7374 3a20 5465 7374 2920 2d3e 2054  test: Test) -> T
-000013f0: 7570 6c65 5b69 6e74 2c20 7374 722c 2073  uple[int, str, s
-00001400: 7472 5d3a 0a20 2020 2023 2046 6169 6c20  tr]:.    # Fail 
-00001410: 6661 7374 2069 6620 6073 6b79 6020 434c  fast if `sky` CL
-00001420: 4920 736f 6d65 686f 7720 6572 726f 7273  I somehow errors
-00001430: 206f 7574 2e0a 2020 2020 7375 6270 726f   out..    subpro
-00001440: 6365 7373 2e72 756e 285b 2773 6b79 272c  cess.run(['sky',
-00001450: 2027 7374 6174 7573 275d 2c20 7374 646f   'status'], stdo
-00001460: 7574 3d73 7562 7072 6f63 6573 732e 4445  ut=subprocess.DE
-00001470: 564e 554c 4c2c 2063 6865 636b 3d54 7275  VNULL, check=Tru
-00001480: 6529 0a20 2020 206c 6f67 5f66 696c 6520  e).    log_file 
-00001490: 3d20 7465 6d70 6669 6c65 2e4e 616d 6564  = tempfile.Named
-000014a0: 5465 6d70 6f72 6172 7946 696c 6528 2761  TemporaryFile('a
-000014b0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-000014c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000014d0: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-000014e0: 6566 6978 3d66 277b 7465 7374 2e6e 616d  efix=f'{test.nam
-000014f0: 657d 2d27 2c0a 2020 2020 2020 2020 2020  e}-',.          
-00001500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001520: 2073 7566 6669 783d 272e 6c6f 6727 2c0a   suffix='.log',.
+00000c70: 6520 7468 6520 6a6f 6273 2063 6f6e 7472  e the jobs contr
+00000c80: 6f6c 6c65 7220 6f6e 2047 4350 2c20 746f  oller on GCP, to
+00000c90: 2061 766f 6964 2070 6172 616c 6c65 6c20   avoid parallel 
+00000ca0: 7465 7374 2069 7373 7565 730a 2320 7768  test issues.# wh
+00000cb0: 656e 2074 6865 2063 6f6e 7472 6f6c 6c65  en the controlle
+00000cc0: 7220 6265 696e 6720 6f6e 2041 7a75 7265  r being on Azure
+00000cd0: 2c20 7768 6963 6820 7461 6b65 7320 6120  , which takes a 
+00000ce0: 6c6f 6e67 2074 696d 6520 666f 7220 6c61  long time for la
+00000cf0: 756e 6368 696e 670a 2320 7374 6570 2e0a  unching.# step..
+00000d00: 0a44 4546 4155 4c54 5f43 4d44 5f54 494d  .DEFAULT_CMD_TIM
+00000d10: 454f 5554 203d 2031 3520 2a20 3630 0a0a  EOUT = 15 * 60..
+00000d20: 0a63 6c61 7373 2054 6573 7428 4e61 6d65  .class Test(Name
+00000d30: 6454 7570 6c65 293a 0a20 2020 206e 616d  dTuple):.    nam
+00000d40: 653a 2073 7472 0a20 2020 2023 2045 6163  e: str.    # Eac
+00000d50: 6820 636f 6d6d 616e 6420 6973 2065 7865  h command is exe
+00000d60: 6375 7465 6420 7365 7269 616c 6c79 2e20  cuted serially. 
+00000d70: 2049 6620 616e 7920 6661 696c 6564 2c20   If any failed, 
+00000d80: 7468 6520 7265 6d61 696e 696e 6720 636f  the remaining co
+00000d90: 6d6d 616e 6473 0a20 2020 2023 2061 7265  mmands.    # are
+00000da0: 206e 6f74 2072 756e 2061 6e64 2074 6865   not run and the
+00000db0: 2074 6573 7420 6973 2074 7265 6174 6564   test is treated
+00000dc0: 2061 7320 6661 696c 6564 2e0a 2020 2020   as failed..    
+00000dd0: 636f 6d6d 616e 6473 3a20 4c69 7374 5b73  commands: List[s
+00000de0: 7472 5d0a 2020 2020 7465 6172 646f 776e  tr].    teardown
+00000df0: 3a20 4f70 7469 6f6e 616c 5b73 7472 5d20  : Optional[str] 
+00000e00: 3d20 4e6f 6e65 0a20 2020 2023 2054 696d  = None.    # Tim
+00000e10: 656f 7574 2066 6f72 2065 6163 6820 636f  eout for each co
+00000e20: 6d6d 616e 6420 696e 2073 6563 6f6e 6473  mmand in seconds
+00000e30: 2e0a 2020 2020 7469 6d65 6f75 743a 2069  ..    timeout: i
+00000e40: 6e74 203d 2044 4546 4155 4c54 5f43 4d44  nt = DEFAULT_CMD
+00000e50: 5f54 494d 454f 5554 0a0a 2020 2020 6465  _TIMEOUT..    de
+00000e60: 6620 6563 686f 2873 656c 662c 206d 6573  f echo(self, mes
+00000e70: 7361 6765 3a20 7374 7229 3a0a 2020 2020  sage: str):.    
+00000e80: 2020 2020 2320 7079 7465 7374 2773 2078      # pytest's x
+00000e90: 6469 7374 2070 6c75 6769 6e20 6361 7074  dist plugin capt
+00000ea0: 7572 6573 2073 7464 6f75 743b 2070 7269  ures stdout; pri
+00000eb0: 6e74 2074 6f20 7374 6465 7272 2073 6f20  nt to stderr so 
+00000ec0: 7468 6174 2074 6865 0a20 2020 2020 2020  that the.       
+00000ed0: 2023 206c 6f67 7320 6172 6520 7374 7265   # logs are stre
+00000ee0: 616d 696e 6720 7768 696c 6520 7468 6520  aming while the 
+00000ef0: 7465 7374 7320 6172 6520 7275 6e6e 696e  tests are runnin
+00000f00: 672e 0a20 2020 2020 2020 2070 7265 6669  g..        prefi
+00000f10: 7820 3d20 6627 5b7b 7365 6c66 2e6e 616d  x = f'[{self.nam
+00000f20: 657d 5d27 0a20 2020 2020 2020 206d 6573  e}]'.        mes
+00000f30: 7361 6765 203d 2066 277b 7072 6566 6978  sage = f'{prefix
+00000f40: 7d20 7b6d 6573 7361 6765 7d27 0a20 2020  } {message}'.   
+00000f50: 2020 2020 206d 6573 7361 6765 203d 206d       message = m
+00000f60: 6573 7361 6765 2e72 6570 6c61 6365 2827  essage.replace('
+00000f70: 5c6e 272c 2066 275c 6e7b 7072 6566 6978  \n', f'\n{prefix
+00000f80: 7d20 2729 0a20 2020 2020 2020 2070 7269  } ').        pri
+00000f90: 6e74 286d 6573 7361 6765 2c20 6669 6c65  nt(message, file
+00000fa0: 3d73 7973 2e73 7464 6572 722c 2066 6c75  =sys.stderr, flu
+00000fb0: 7368 3d54 7275 6529 0a0a 0a64 6566 205f  sh=True)...def _
+00000fc0: 6765 745f 7469 6d65 6f75 7428 6765 6e65  get_timeout(gene
+00000fd0: 7269 635f 636c 6f75 643a 2073 7472 2c0a  ric_cloud: str,.
+00000fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000ff0: 206f 7665 7272 6964 655f 7469 6d65 6f75   override_timeou
+00001000: 743a 2069 6e74 203d 2044 4546 4155 4c54  t: int = DEFAULT
+00001010: 5f43 4d44 5f54 494d 454f 5554 293a 0a20  _CMD_TIMEOUT):. 
+00001020: 2020 2074 696d 656f 7574 7320 3d20 7b27     timeouts = {'
+00001030: 666c 7569 6473 7461 636b 273a 2036 3020  fluidstack': 60 
+00001040: 2a20 3630 7d20 2023 2066 696c 655f 6d6f  * 60}  # file_mo
+00001050: 756e 7473 0a20 2020 2072 6574 7572 6e20  unts.    return 
+00001060: 7469 6d65 6f75 7473 2e67 6574 2867 656e  timeouts.get(gen
+00001070: 6572 6963 5f63 6c6f 7564 2c20 6f76 6572  eric_cloud, over
+00001080: 7269 6465 5f74 696d 656f 7574 290a 0a0a  ride_timeout)...
+00001090: 6465 6620 5f67 6574 5f63 6c75 7374 6572  def _get_cluster
+000010a0: 5f6e 616d 6528 2920 2d3e 2073 7472 3a0a  _name() -> str:.
+000010b0: 2020 2020 2222 2252 6574 7572 6e73 2061      """Returns a
+000010c0: 2075 7365 722d 756e 6971 7565 2063 6c75   user-unique clu
+000010d0: 7374 6572 206e 616d 6520 666f 7220 6561  ster name for ea
+000010e0: 6368 2074 6573 745f 3c6e 616d 653e 2829  ch test_<name>()
+000010f0: 2e0a 0a20 2020 204d 7573 7420 6265 2063  ...    Must be c
+00001100: 616c 6c65 6420 6672 6f6d 2065 6163 6820  alled from each 
+00001110: 7465 7374 5f3c 6e61 6d65 3e28 292e 0a20  test_<name>().. 
+00001120: 2020 2022 2222 0a20 2020 2063 616c 6c65     """.    calle
+00001130: 725f 6675 6e63 5f6e 616d 6520 3d20 696e  r_func_name = in
+00001140: 7370 6563 742e 7374 6163 6b28 295b 315d  spect.stack()[1]
+00001150: 5b33 5d0a 2020 2020 7465 7374 5f6e 616d  [3].    test_nam
+00001160: 6520 3d20 6361 6c6c 6572 5f66 756e 635f  e = caller_func_
+00001170: 6e61 6d65 2e72 6570 6c61 6365 2827 5f27  name.replace('_'
+00001180: 2c20 272d 2729 2e72 6570 6c61 6365 2827  , '-').replace('
+00001190: 7465 7374 2d27 2c20 2774 2d27 290a 2020  test-', 't-').  
+000011a0: 2020 7465 7374 5f6e 616d 6520 3d20 636f    test_name = co
+000011b0: 6d6d 6f6e 5f75 7469 6c73 2e6d 616b 655f  mmon_utils.make_
+000011c0: 636c 7573 7465 725f 6e61 6d65 5f6f 6e5f  cluster_name_on_
+000011d0: 636c 6f75 6428 7465 7374 5f6e 616d 652c  cloud(test_name,
+000011e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000011f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001210: 2020 2020 2020 2020 2032 342c 0a20 2020           24,.   
+00001220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001250: 2020 2020 2061 6464 5f75 7365 725f 6861       add_user_ha
+00001260: 7368 3d46 616c 7365 290a 2020 2020 7265  sh=False).    re
+00001270: 7475 726e 2066 277b 7465 7374 5f6e 616d  turn f'{test_nam
+00001280: 657d 2d7b 7465 7374 5f69 647d 270a 0a0a  e}-{test_id}'...
+00001290: 6465 6620 5f74 6572 6d69 6e61 7465 5f67  def _terminate_g
+000012a0: 6370 5f72 6570 6c69 6361 286e 616d 653a  cp_replica(name:
+000012b0: 2073 7472 2c20 7a6f 6e65 3a20 7374 722c   str, zone: str,
+000012c0: 2072 6570 6c69 6361 5f69 643a 2069 6e74   replica_id: int
+000012d0: 2920 2d3e 2073 7472 3a0a 2020 2020 636c  ) -> str:.    cl
+000012e0: 7573 7465 725f 6e61 6d65 203d 2073 6572  uster_name = ser
+000012f0: 7665 2e67 656e 6572 6174 655f 7265 706c  ve.generate_repl
+00001300: 6963 615f 636c 7573 7465 725f 6e61 6d65  ica_cluster_name
+00001310: 286e 616d 652c 2072 6570 6c69 6361 5f69  (name, replica_i
+00001320: 6429 0a20 2020 2071 7565 7279 5f63 6d64  d).    query_cmd
+00001330: 203d 2028 6627 6763 6c6f 7564 2063 6f6d   = (f'gcloud com
+00001340: 7075 7465 2069 6e73 7461 6e63 6573 206c  pute instances l
+00001350: 6973 7420 2d2d 6669 6c74 6572 3d27 0a20  ist --filter='. 
+00001360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001370: 6627 2228 6c61 6265 6c73 2e72 6179 2d63  f'"(labels.ray-c
+00001380: 6c75 7374 6572 2d6e 616d 653a 7b63 6c75  luster-name:{clu
+00001390: 7374 6572 5f6e 616d 657d 2922 2027 0a20  ster_name})" '. 
+000013a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000013b0: 6627 2d2d 7a6f 6e65 733d 7b7a 6f6e 657d  f'--zones={zone}
+000013c0: 202d 2d66 6f72 6d61 743d 2276 616c 7565   --format="value
+000013d0: 286e 616d 6529 2227 290a 2020 2020 7265  (name)"').    re
+000013e0: 7475 726e 2028 6627 6763 6c6f 7564 2063  turn (f'gcloud c
+000013f0: 6f6d 7075 7465 2069 6e73 7461 6e63 6573  ompute instances
+00001400: 2064 656c 6574 6520 2d2d 7a6f 6e65 3d7b   delete --zone={
+00001410: 7a6f 6e65 7d27 0a20 2020 2020 2020 2020  zone}'.         
+00001420: 2020 2066 2720 2d2d 7175 6965 7420 2428     f' --quiet $(
+00001430: 7b71 7565 7279 5f63 6d64 7d29 2729 0a0a  {query_cmd})')..
+00001440: 0a64 6566 2072 756e 5f6f 6e65 5f74 6573  .def run_one_tes
+00001450: 7428 7465 7374 3a20 5465 7374 2920 2d3e  t(test: Test) ->
+00001460: 2054 7570 6c65 5b69 6e74 2c20 7374 722c   Tuple[int, str,
+00001470: 2073 7472 5d3a 0a20 2020 2023 2046 6169   str]:.    # Fai
+00001480: 6c20 6661 7374 2069 6620 6073 6b79 6020  l fast if `sky` 
+00001490: 434c 4920 736f 6d65 686f 7720 6572 726f  CLI somehow erro
+000014a0: 7273 206f 7574 2e0a 2020 2020 7375 6270  rs out..    subp
+000014b0: 726f 6365 7373 2e72 756e 285b 2773 6b79  rocess.run(['sky
+000014c0: 272c 2027 7374 6174 7573 275d 2c20 7374  ', 'status'], st
+000014d0: 646f 7574 3d73 7562 7072 6f63 6573 732e  dout=subprocess.
+000014e0: 4445 564e 554c 4c2c 2063 6865 636b 3d54  DEVNULL, check=T
+000014f0: 7275 6529 0a20 2020 206c 6f67 5f66 696c  rue).    log_fil
+00001500: 6520 3d20 7465 6d70 6669 6c65 2e4e 616d  e = tempfile.Nam
+00001510: 6564 5465 6d70 6f72 6172 7946 696c 6528  edTemporaryFile(
+00001520: 2761 272c 0a20 2020 2020 2020 2020 2020  'a',.           
 00001530: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00001540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001550: 2020 2020 2020 2020 2020 2064 656c 6574             delet
-00001560: 653d 4661 6c73 6529 0a20 2020 2074 6573  e=False).    tes
-00001570: 742e 6563 686f 2866 2754 6573 7420 7374  t.echo(f'Test st
-00001580: 6172 7465 642e 204c 6f67 3a20 6c65 7373  arted. Log: less
-00001590: 207b 6c6f 675f 6669 6c65 2e6e 616d 657d   {log_file.name}
-000015a0: 2729 0a20 2020 2066 6f72 2063 6f6d 6d61  ').    for comma
-000015b0: 6e64 2069 6e20 7465 7374 2e63 6f6d 6d61  nd in test.comma
-000015c0: 6e64 733a 0a20 2020 2020 2020 206c 6f67  nds:.        log
-000015d0: 5f66 696c 652e 7772 6974 6528 6627 2b20  _file.write(f'+ 
-000015e0: 7b63 6f6d 6d61 6e64 7d5c 6e27 290a 2020  {command}\n').  
-000015f0: 2020 2020 2020 6c6f 675f 6669 6c65 2e66        log_file.f
-00001600: 6c75 7368 2829 0a20 2020 2020 2020 2070  lush().        p
-00001610: 726f 6320 3d20 7375 6270 726f 6365 7373  roc = subprocess
-00001620: 2e50 6f70 656e 280a 2020 2020 2020 2020  .Popen(.        
-00001630: 2020 2020 636f 6d6d 616e 642c 0a20 2020      command,.   
-00001640: 2020 2020 2020 2020 2073 7464 6f75 743d           stdout=
-00001650: 6c6f 675f 6669 6c65 2c0a 2020 2020 2020  log_file,.      
-00001660: 2020 2020 2020 7374 6465 7272 3d73 7562        stderr=sub
-00001670: 7072 6f63 6573 732e 5354 444f 5554 2c0a  process.STDOUT,.
-00001680: 2020 2020 2020 2020 2020 2020 7368 656c              shel
-00001690: 6c3d 5472 7565 2c0a 2020 2020 2020 2020  l=True,.        
-000016a0: 2020 2020 6578 6563 7574 6162 6c65 3d27      executable='
-000016b0: 2f62 696e 2f62 6173 6827 2c0a 2020 2020  /bin/bash',.    
-000016c0: 2020 2020 290a 2020 2020 2020 2020 7472      ).        tr
-000016d0: 793a 0a20 2020 2020 2020 2020 2020 2070  y:.            p
-000016e0: 726f 632e 7761 6974 2874 696d 656f 7574  roc.wait(timeout
-000016f0: 3d74 6573 742e 7469 6d65 6f75 7429 0a20  =test.timeout). 
-00001700: 2020 2020 2020 2065 7863 6570 7420 7375         except su
-00001710: 6270 726f 6365 7373 2e54 696d 656f 7574  bprocess.Timeout
-00001720: 4578 7069 7265 6420 6173 2065 3a0a 2020  Expired as e:.  
-00001730: 2020 2020 2020 2020 2020 6c6f 675f 6669            log_fi
-00001740: 6c65 2e66 6c75 7368 2829 0a20 2020 2020  le.flush().     
-00001750: 2020 2020 2020 2074 6573 742e 6563 686f         test.echo
-00001760: 2866 2754 696d 656f 7574 2061 6674 6572  (f'Timeout after
-00001770: 207b 7465 7374 2e74 696d 656f 7574 7d20   {test.timeout} 
-00001780: 7365 636f 6e64 732e 2729 0a20 2020 2020  seconds.').     
-00001790: 2020 2020 2020 2074 6573 742e 6563 686f         test.echo
-000017a0: 2873 7472 2865 2929 0a20 2020 2020 2020  (str(e)).       
-000017b0: 2020 2020 206c 6f67 5f66 696c 652e 7772       log_file.wr
-000017c0: 6974 6528 6627 5469 6d65 6f75 7420 6166  ite(f'Timeout af
-000017d0: 7465 7220 7b74 6573 742e 7469 6d65 6f75  ter {test.timeou
-000017e0: 747d 2073 6563 6f6e 6473 2e5c 6e27 290a  t} seconds.\n').
-000017f0: 2020 2020 2020 2020 2020 2020 6c6f 675f              log_
-00001800: 6669 6c65 2e66 6c75 7368 2829 0a20 2020  file.flush().   
-00001810: 2020 2020 2020 2020 2023 204b 696c 6c20           # Kill 
-00001820: 7468 6520 6375 7272 656e 7420 7072 6f63  the current proc
-00001830: 6573 732e 0a20 2020 2020 2020 2020 2020  ess..           
-00001840: 2070 726f 632e 7465 726d 696e 6174 6528   proc.terminate(
-00001850: 290a 2020 2020 2020 2020 2020 2020 7072  ).            pr
-00001860: 6f63 2e72 6574 7572 6e63 6f64 6520 3d20  oc.returncode = 
-00001870: 3120 2023 204e 6f6e 6520 6966 2077 6520  1  # None if we 
-00001880: 646f 6e27 7420 7365 7420 6974 2e0a 2020  don't set it..  
-00001890: 2020 2020 2020 2020 2020 6272 6561 6b0a            break.
-000018a0: 0a20 2020 2020 2020 2069 6620 7072 6f63  .        if proc
-000018b0: 2e72 6574 7572 6e63 6f64 653a 0a20 2020  .returncode:.   
-000018c0: 2020 2020 2020 2020 2062 7265 616b 0a0a           break..
-000018d0: 2020 2020 7374 796c 6520 3d20 636f 6c6f      style = colo
-000018e0: 7261 6d61 2e53 7479 6c65 0a20 2020 2066  rama.Style.    f
-000018f0: 6f72 6520 3d20 636f 6c6f 7261 6d61 2e46  ore = colorama.F
-00001900: 6f72 650a 2020 2020 6f75 7463 6f6d 6520  ore.    outcome 
-00001910: 3d20 2866 277b 666f 7265 2e52 4544 7d46  = (f'{fore.RED}F
-00001920: 6169 6c65 647b 7374 796c 652e 5245 5345  ailed{style.RESE
-00001930: 545f 414c 4c7d 270a 2020 2020 2020 2020  T_ALL}'.        
-00001940: 2020 2020 2020 2069 6620 7072 6f63 2e72         if proc.r
-00001950: 6574 7572 6e63 6f64 6520 656c 7365 2066  eturncode else f
-00001960: 277b 666f 7265 2e47 5245 454e 7d50 6173  '{fore.GREEN}Pas
-00001970: 7365 647b 7374 796c 652e 5245 5345 545f  sed{style.RESET_
-00001980: 414c 4c7d 2729 0a20 2020 2072 6561 736f  ALL}').    reaso
-00001990: 6e20 3d20 6627 5c6e 5265 6173 6f6e 3a20  n = f'\nReason: 
-000019a0: 7b63 6f6d 6d61 6e64 7d27 2069 6620 7072  {command}' if pr
-000019b0: 6f63 2e72 6574 7572 6e63 6f64 6520 656c  oc.returncode el
-000019c0: 7365 2027 270a 2020 2020 6d73 6720 3d20  se ''.    msg = 
-000019d0: 2866 277b 6f75 7463 6f6d 657d 2e27 0a20  (f'{outcome}.'. 
-000019e0: 2020 2020 2020 2020 2020 6627 7b72 6561            f'{rea
-000019f0: 736f 6e7d 270a 2020 2020 2020 2020 2020  son}'.          
-00001a00: 2066 275c 6e4c 6f67 3a20 6c65 7373 207b   f'\nLog: less {
-00001a10: 6c6f 675f 6669 6c65 2e6e 616d 657d 5c6e  log_file.name}\n
-00001a20: 2729 0a20 2020 2074 6573 742e 6563 686f  ').    test.echo
-00001a30: 286d 7367 290a 2020 2020 6c6f 675f 6669  (msg).    log_fi
-00001a40: 6c65 2e77 7269 7465 286d 7367 290a 2020  le.write(msg).  
-00001a50: 2020 6966 2028 7072 6f63 2e72 6574 7572    if (proc.retur
-00001a60: 6e63 6f64 6520 3d3d 2030 206f 720a 2020  ncode == 0 or.  
-00001a70: 2020 2020 2020 2020 2020 7079 7465 7374            pytest
-00001a80: 2e74 6572 6d69 6e61 7465 5f6f 6e5f 6661  .terminate_on_fa
-00001a90: 696c 7572 6529 2061 6e64 2074 6573 742e  ilure) and test.
-00001aa0: 7465 6172 646f 776e 2069 7320 6e6f 7420  teardown is not 
-00001ab0: 4e6f 6e65 3a0a 2020 2020 2020 2020 7375  None:.        su
-00001ac0: 6270 726f 6365 7373 5f75 7469 6c73 2e72  bprocess_utils.r
-00001ad0: 756e 280a 2020 2020 2020 2020 2020 2020  un(.            
-00001ae0: 7465 7374 2e74 6561 7264 6f77 6e2c 0a20  test.teardown,. 
-00001af0: 2020 2020 2020 2020 2020 2073 7464 6f75             stdou
-00001b00: 743d 6c6f 675f 6669 6c65 2c0a 2020 2020  t=log_file,.    
-00001b10: 2020 2020 2020 2020 7374 6465 7272 3d73          stderr=s
-00001b20: 7562 7072 6f63 6573 732e 5354 444f 5554  ubprocess.STDOUT
-00001b30: 2c0a 2020 2020 2020 2020 2020 2020 7469  ,.            ti
-00001b40: 6d65 6f75 743d 3130 202a 2036 302c 2020  meout=10 * 60,  
-00001b50: 2320 3130 206d 696e 730a 2020 2020 2020  # 10 mins.      
-00001b60: 2020 2020 2020 7368 656c 6c3d 5472 7565        shell=True
-00001b70: 2c0a 2020 2020 2020 2020 290a 0a20 2020  ,.        )..   
-00001b80: 2069 6620 7072 6f63 2e72 6574 7572 6e63   if proc.returnc
-00001b90: 6f64 653a 0a20 2020 2020 2020 2072 6169  ode:.        rai
-00001ba0: 7365 2045 7863 6570 7469 6f6e 2866 2774  se Exception(f't
-00001bb0: 6573 7420 6661 696c 6564 3a20 6c65 7373  est failed: less
-00001bc0: 207b 6c6f 675f 6669 6c65 2e6e 616d 657d   {log_file.name}
-00001bd0: 2729 0a0a 0a64 6566 2067 6574 5f61 7773  ')...def get_aws
-00001be0: 5f72 6567 696f 6e5f 666f 725f 7175 6f74  _region_for_quot
-00001bf0: 615f 6661 696c 6f76 6572 2829 202d 3e20  a_failover() -> 
-00001c00: 4f70 7469 6f6e 616c 5b73 7472 5d3a 0a20  Optional[str]:. 
-00001c10: 2020 2063 616e 6469 6461 7465 5f72 6567     candidate_reg
-00001c20: 696f 6e73 203d 2041 5753 2e72 6567 696f  ions = AWS.regio
-00001c30: 6e73 5f77 6974 685f 6f66 6665 7269 6e67  ns_with_offering
-00001c40: 2869 6e73 7461 6e63 655f 7479 7065 3d27  (instance_type='
-00001c50: 7033 2e31 3678 6c61 7267 6527 2c0a 2020  p3.16xlarge',.  
-00001c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001c90: 6163 6365 6c65 7261 746f 7273 3d4e 6f6e  accelerators=Non
-00001ca0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-00001cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001cd0: 2020 2020 2075 7365 5f73 706f 743d 5472       use_spot=Tr
-00001ce0: 7565 2c0a 2020 2020 2020 2020 2020 2020  ue,.            
+00001550: 7072 6566 6978 3d66 277b 7465 7374 2e6e  prefix=f'{test.n
+00001560: 616d 657d 2d27 2c0a 2020 2020 2020 2020  ame}-',.        
+00001570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001590: 2020 2073 7566 6669 783d 272e 6c6f 6727     suffix='.log'
+000015a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000015b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000015c0: 2020 2020 2020 2020 2020 2020 2064 656c               del
+000015d0: 6574 653d 4661 6c73 6529 0a20 2020 2074  ete=False).    t
+000015e0: 6573 742e 6563 686f 2866 2754 6573 7420  est.echo(f'Test 
+000015f0: 7374 6172 7465 642e 204c 6f67 3a20 6c65  started. Log: le
+00001600: 7373 207b 6c6f 675f 6669 6c65 2e6e 616d  ss {log_file.nam
+00001610: 657d 2729 0a20 2020 2066 6f72 2063 6f6d  e}').    for com
+00001620: 6d61 6e64 2069 6e20 7465 7374 2e63 6f6d  mand in test.com
+00001630: 6d61 6e64 733a 0a20 2020 2020 2020 206c  mands:.        l
+00001640: 6f67 5f66 696c 652e 7772 6974 6528 6627  og_file.write(f'
+00001650: 2b20 7b63 6f6d 6d61 6e64 7d5c 6e27 290a  + {command}\n').
+00001660: 2020 2020 2020 2020 6c6f 675f 6669 6c65          log_file
+00001670: 2e66 6c75 7368 2829 0a20 2020 2020 2020  .flush().       
+00001680: 2070 726f 6320 3d20 7375 6270 726f 6365   proc = subproce
+00001690: 7373 2e50 6f70 656e 280a 2020 2020 2020  ss.Popen(.      
+000016a0: 2020 2020 2020 636f 6d6d 616e 642c 0a20        command,. 
+000016b0: 2020 2020 2020 2020 2020 2073 7464 6f75             stdou
+000016c0: 743d 6c6f 675f 6669 6c65 2c0a 2020 2020  t=log_file,.    
+000016d0: 2020 2020 2020 2020 7374 6465 7272 3d73          stderr=s
+000016e0: 7562 7072 6f63 6573 732e 5354 444f 5554  ubprocess.STDOUT
+000016f0: 2c0a 2020 2020 2020 2020 2020 2020 7368  ,.            sh
+00001700: 656c 6c3d 5472 7565 2c0a 2020 2020 2020  ell=True,.      
+00001710: 2020 2020 2020 6578 6563 7574 6162 6c65        executable
+00001720: 3d27 2f62 696e 2f62 6173 6827 2c0a 2020  ='/bin/bash',.  
+00001730: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00001740: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+00001750: 2070 726f 632e 7761 6974 2874 696d 656f   proc.wait(timeo
+00001760: 7574 3d74 6573 742e 7469 6d65 6f75 7429  ut=test.timeout)
+00001770: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
+00001780: 7375 6270 726f 6365 7373 2e54 696d 656f  subprocess.Timeo
+00001790: 7574 4578 7069 7265 6420 6173 2065 3a0a  utExpired as e:.
+000017a0: 2020 2020 2020 2020 2020 2020 6c6f 675f              log_
+000017b0: 6669 6c65 2e66 6c75 7368 2829 0a20 2020  file.flush().   
+000017c0: 2020 2020 2020 2020 2074 6573 742e 6563           test.ec
+000017d0: 686f 2866 2754 696d 656f 7574 2061 6674  ho(f'Timeout aft
+000017e0: 6572 207b 7465 7374 2e74 696d 656f 7574  er {test.timeout
+000017f0: 7d20 7365 636f 6e64 732e 2729 0a20 2020  } seconds.').   
+00001800: 2020 2020 2020 2020 2074 6573 742e 6563           test.ec
+00001810: 686f 2873 7472 2865 2929 0a20 2020 2020  ho(str(e)).     
+00001820: 2020 2020 2020 206c 6f67 5f66 696c 652e         log_file.
+00001830: 7772 6974 6528 6627 5469 6d65 6f75 7420  write(f'Timeout 
+00001840: 6166 7465 7220 7b74 6573 742e 7469 6d65  after {test.time
+00001850: 6f75 747d 2073 6563 6f6e 6473 2e5c 6e27  out} seconds.\n'
+00001860: 290a 2020 2020 2020 2020 2020 2020 6c6f  ).            lo
+00001870: 675f 6669 6c65 2e66 6c75 7368 2829 0a20  g_file.flush(). 
+00001880: 2020 2020 2020 2020 2020 2023 204b 696c             # Kil
+00001890: 6c20 7468 6520 6375 7272 656e 7420 7072  l the current pr
+000018a0: 6f63 6573 732e 0a20 2020 2020 2020 2020  ocess..         
+000018b0: 2020 2070 726f 632e 7465 726d 696e 6174     proc.terminat
+000018c0: 6528 290a 2020 2020 2020 2020 2020 2020  e().            
+000018d0: 7072 6f63 2e72 6574 7572 6e63 6f64 6520  proc.returncode 
+000018e0: 3d20 3120 2023 204e 6f6e 6520 6966 2077  = 1  # None if w
+000018f0: 6520 646f 6e27 7420 7365 7420 6974 2e0a  e don't set it..
+00001900: 2020 2020 2020 2020 2020 2020 6272 6561              brea
+00001910: 6b0a 0a20 2020 2020 2020 2069 6620 7072  k..        if pr
+00001920: 6f63 2e72 6574 7572 6e63 6f64 653a 0a20  oc.returncode:. 
+00001930: 2020 2020 2020 2020 2020 2062 7265 616b             break
+00001940: 0a0a 2020 2020 7374 796c 6520 3d20 636f  ..    style = co
+00001950: 6c6f 7261 6d61 2e53 7479 6c65 0a20 2020  lorama.Style.   
+00001960: 2066 6f72 6520 3d20 636f 6c6f 7261 6d61   fore = colorama
+00001970: 2e46 6f72 650a 2020 2020 6f75 7463 6f6d  .Fore.    outcom
+00001980: 6520 3d20 2866 277b 666f 7265 2e52 4544  e = (f'{fore.RED
+00001990: 7d46 6169 6c65 647b 7374 796c 652e 5245  }Failed{style.RE
+000019a0: 5345 545f 414c 4c7d 270a 2020 2020 2020  SET_ALL}'.      
+000019b0: 2020 2020 2020 2020 2069 6620 7072 6f63           if proc
+000019c0: 2e72 6574 7572 6e63 6f64 6520 656c 7365  .returncode else
+000019d0: 2066 277b 666f 7265 2e47 5245 454e 7d50   f'{fore.GREEN}P
+000019e0: 6173 7365 647b 7374 796c 652e 5245 5345  assed{style.RESE
+000019f0: 545f 414c 4c7d 2729 0a20 2020 2072 6561  T_ALL}').    rea
+00001a00: 736f 6e20 3d20 6627 5c6e 5265 6173 6f6e  son = f'\nReason
+00001a10: 3a20 7b63 6f6d 6d61 6e64 7d27 2069 6620  : {command}' if 
+00001a20: 7072 6f63 2e72 6574 7572 6e63 6f64 6520  proc.returncode 
+00001a30: 656c 7365 2027 270a 2020 2020 6d73 6720  else ''.    msg 
+00001a40: 3d20 2866 277b 6f75 7463 6f6d 657d 2e27  = (f'{outcome}.'
+00001a50: 0a20 2020 2020 2020 2020 2020 6627 7b72  .           f'{r
+00001a60: 6561 736f 6e7d 270a 2020 2020 2020 2020  eason}'.        
+00001a70: 2020 2066 275c 6e4c 6f67 3a20 6c65 7373     f'\nLog: less
+00001a80: 207b 6c6f 675f 6669 6c65 2e6e 616d 657d   {log_file.name}
+00001a90: 5c6e 2729 0a20 2020 2074 6573 742e 6563  \n').    test.ec
+00001aa0: 686f 286d 7367 290a 2020 2020 6c6f 675f  ho(msg).    log_
+00001ab0: 6669 6c65 2e77 7269 7465 286d 7367 290a  file.write(msg).
+00001ac0: 2020 2020 6966 2028 7072 6f63 2e72 6574      if (proc.ret
+00001ad0: 7572 6e63 6f64 6520 3d3d 2030 206f 720a  urncode == 0 or.
+00001ae0: 2020 2020 2020 2020 2020 2020 7079 7465              pyte
+00001af0: 7374 2e74 6572 6d69 6e61 7465 5f6f 6e5f  st.terminate_on_
+00001b00: 6661 696c 7572 6529 2061 6e64 2074 6573  failure) and tes
+00001b10: 742e 7465 6172 646f 776e 2069 7320 6e6f  t.teardown is no
+00001b20: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+00001b30: 7375 6270 726f 6365 7373 5f75 7469 6c73  subprocess_utils
+00001b40: 2e72 756e 280a 2020 2020 2020 2020 2020  .run(.          
+00001b50: 2020 7465 7374 2e74 6561 7264 6f77 6e2c    test.teardown,
+00001b60: 0a20 2020 2020 2020 2020 2020 2073 7464  .            std
+00001b70: 6f75 743d 6c6f 675f 6669 6c65 2c0a 2020  out=log_file,.  
+00001b80: 2020 2020 2020 2020 2020 7374 6465 7272            stderr
+00001b90: 3d73 7562 7072 6f63 6573 732e 5354 444f  =subprocess.STDO
+00001ba0: 5554 2c0a 2020 2020 2020 2020 2020 2020  UT,.            
+00001bb0: 7469 6d65 6f75 743d 3130 202a 2036 302c  timeout=10 * 60,
+00001bc0: 2020 2320 3130 206d 696e 730a 2020 2020    # 10 mins.    
+00001bd0: 2020 2020 2020 2020 7368 656c 6c3d 5472          shell=Tr
+00001be0: 7565 2c0a 2020 2020 2020 2020 290a 0a20  ue,.        ).. 
+00001bf0: 2020 2069 6620 7072 6f63 2e72 6574 7572     if proc.retur
+00001c00: 6e63 6f64 653a 0a20 2020 2020 2020 2072  ncode:.        r
+00001c10: 6169 7365 2045 7863 6570 7469 6f6e 2866  aise Exception(f
+00001c20: 2774 6573 7420 6661 696c 6564 3a20 6c65  'test failed: le
+00001c30: 7373 207b 6c6f 675f 6669 6c65 2e6e 616d  ss {log_file.nam
+00001c40: 657d 2729 0a0a 0a64 6566 2067 6574 5f61  e}')...def get_a
+00001c50: 7773 5f72 6567 696f 6e5f 666f 725f 7175  ws_region_for_qu
+00001c60: 6f74 615f 6661 696c 6f76 6572 2829 202d  ota_failover() -
+00001c70: 3e20 4f70 7469 6f6e 616c 5b73 7472 5d3a  > Optional[str]:
+00001c80: 0a20 2020 2063 616e 6469 6461 7465 5f72  .    candidate_r
+00001c90: 6567 696f 6e73 203d 2041 5753 2e72 6567  egions = AWS.reg
+00001ca0: 696f 6e73 5f77 6974 685f 6f66 6665 7269  ions_with_offeri
+00001cb0: 6e67 2869 6e73 7461 6e63 655f 7479 7065  ng(instance_type
+00001cc0: 3d27 7033 2e31 3678 6c61 7267 6527 2c0a  ='p3.16xlarge',.
+00001cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00001cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001d10: 2020 2020 2020 7265 6769 6f6e 3d4e 6f6e        region=Non
-00001d20: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+00001d00: 2020 6163 6365 6c65 7261 746f 7273 3d4e    accelerators=N
+00001d10: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
+00001d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00001d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001d50: 2020 2020 207a 6f6e 653d 4e6f 6e65 290a       zone=None).
-00001d60: 2020 2020 6f72 6967 696e 616c 5f72 6573      original_res
-00001d70: 6f75 7263 6573 203d 2073 6b79 2e52 6573  ources = sky.Res
-00001d80: 6f75 7263 6573 2863 6c6f 7564 3d73 6b79  ources(cloud=sky
-00001d90: 2e41 5753 2829 2c0a 2020 2020 2020 2020  .AWS(),.        
+00001d40: 2020 2020 2020 2075 7365 5f73 706f 743d         use_spot=
+00001d50: 5472 7565 2c0a 2020 2020 2020 2020 2020  True,.          
+00001d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001d80: 2020 2020 2020 2020 7265 6769 6f6e 3d4e          region=N
+00001d90: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
 00001da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001db0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00001dc0: 6e73 7461 6e63 655f 7479 7065 3d27 7033  nstance_type='p3
-00001dd0: 2e31 3678 6c61 7267 6527 2c0a 2020 2020  .16xlarge',.    
-00001de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001e00: 2020 2075 7365 5f73 706f 743d 5472 7565     use_spot=True
-00001e10: 290a 0a20 2020 2023 2046 696c 7465 7220  )..    # Filter 
-00001e20: 7468 6520 7265 6769 6f6e 7320 7769 7468  the regions with
-00001e30: 2070 726f 7879 2063 6f6d 6d61 6e64 2069   proxy command i
-00001e40: 6e20 7e2f 2e73 6b79 2f63 6f6e 6669 672e  n ~/.sky/config.
-00001e50: 7961 6d6c 2e0a 2020 2020 6669 6c74 6572  yaml..    filter
-00001e60: 6564 5f72 6567 696f 6e73 203d 206f 7269  ed_regions = ori
-00001e70: 6769 6e61 6c5f 7265 736f 7572 6365 732e  ginal_resources.
-00001e80: 6765 745f 7661 6c69 645f 7265 6769 6f6e  get_valid_region
-00001e90: 735f 666f 725f 6c61 756e 6368 6162 6c65  s_for_launchable
-00001ea0: 2829 0a20 2020 2063 616e 6469 6461 7465  ().    candidate
-00001eb0: 5f72 6567 696f 6e73 203d 205b 0a20 2020  _regions = [.   
-00001ec0: 2020 2020 2072 6567 696f 6e20 666f 7220       region for 
-00001ed0: 7265 6769 6f6e 2069 6e20 6361 6e64 6964  region in candid
-00001ee0: 6174 655f 7265 6769 6f6e 730a 2020 2020  ate_regions.    
-00001ef0: 2020 2020 6966 2072 6567 696f 6e2e 6e61      if region.na
-00001f00: 6d65 2069 6e20 6669 6c74 6572 6564 5f72  me in filtered_r
-00001f10: 6567 696f 6e73 0a20 2020 205d 0a0a 2020  egions.    ]..  
-00001f20: 2020 666f 7220 7265 6769 6f6e 2069 6e20    for region in 
-00001f30: 6361 6e64 6964 6174 655f 7265 6769 6f6e  candidate_region
-00001f40: 733a 0a20 2020 2020 2020 2072 6573 6f75  s:.        resou
-00001f50: 7263 6573 203d 206f 7269 6769 6e61 6c5f  rces = original_
-00001f60: 7265 736f 7572 6365 732e 636f 7079 2872  resources.copy(r
-00001f70: 6567 696f 6e3d 7265 6769 6f6e 2e6e 616d  egion=region.nam
-00001f80: 6529 0a20 2020 2020 2020 2069 6620 6e6f  e).        if no
-00001f90: 7420 4157 532e 6368 6563 6b5f 7175 6f74  t AWS.check_quot
-00001fa0: 615f 6176 6169 6c61 626c 6528 7265 736f  a_available(reso
-00001fb0: 7572 6365 7329 3a0a 2020 2020 2020 2020  urces):.        
-00001fc0: 2020 2020 7265 7475 726e 2072 6567 696f      return regio
-00001fd0: 6e2e 6e61 6d65 0a0a 2020 2020 7265 7475  n.name..    retu
-00001fe0: 726e 204e 6f6e 650a 0a0a 6465 6620 6765  rn None...def ge
-00001ff0: 745f 6763 705f 7265 6769 6f6e 5f66 6f72  t_gcp_region_for
-00002000: 5f71 756f 7461 5f66 6169 6c6f 7665 7228  _quota_failover(
-00002010: 2920 2d3e 204f 7074 696f 6e61 6c5b 7374  ) -> Optional[st
-00002020: 725d 3a0a 0a20 2020 2063 616e 6469 6461  r]:..    candida
-00002030: 7465 5f72 6567 696f 6e73 203d 2047 4350  te_regions = GCP
-00002040: 2e72 6567 696f 6e73 5f77 6974 685f 6f66  .regions_with_of
-00002050: 6665 7269 6e67 2869 6e73 7461 6e63 655f  fering(instance_
-00002060: 7479 7065 3d4e 6f6e 652c 0a20 2020 2020  type=None,.     
-00002070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002090: 2020 2020 2020 2020 2020 2020 2061 6363               acc
-000020a0: 656c 6572 6174 6f72 733d 7b27 4131 3030  elerators={'A100
-000020b0: 2d38 3047 4227 3a20 317d 2c0a 2020 2020  -80GB': 1},.    
-000020c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000020d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000020e0: 2020 2020 2020 2020 2020 2020 2020 7573                us
-000020f0: 655f 7370 6f74 3d54 7275 652c 0a20 2020  e_spot=True,.   
-00002100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002120: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00002130: 6567 696f 6e3d 4e6f 6e65 2c0a 2020 2020  egion=None,.    
+00001db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001dc0: 2020 2020 2020 207a 6f6e 653d 4e6f 6e65         zone=None
+00001dd0: 290a 2020 2020 6f72 6967 696e 616c 5f72  ).    original_r
+00001de0: 6573 6f75 7263 6573 203d 2073 6b79 2e52  esources = sky.R
+00001df0: 6573 6f75 7263 6573 2863 6c6f 7564 3d73  esources(cloud=s
+00001e00: 6b79 2e41 5753 2829 2c0a 2020 2020 2020  ky.AWS(),.      
+00001e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001e30: 2069 6e73 7461 6e63 655f 7479 7065 3d27   instance_type='
+00001e40: 7033 2e31 3678 6c61 7267 6527 2c0a 2020  p3.16xlarge',.  
+00001e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001e70: 2020 2020 2075 7365 5f73 706f 743d 5472       use_spot=Tr
+00001e80: 7565 290a 0a20 2020 2023 2046 696c 7465  ue)..    # Filte
+00001e90: 7220 7468 6520 7265 6769 6f6e 7320 7769  r the regions wi
+00001ea0: 7468 2070 726f 7879 2063 6f6d 6d61 6e64  th proxy command
+00001eb0: 2069 6e20 7e2f 2e73 6b79 2f63 6f6e 6669   in ~/.sky/confi
+00001ec0: 672e 7961 6d6c 2e0a 2020 2020 6669 6c74  g.yaml..    filt
+00001ed0: 6572 6564 5f72 6567 696f 6e73 203d 206f  ered_regions = o
+00001ee0: 7269 6769 6e61 6c5f 7265 736f 7572 6365  riginal_resource
+00001ef0: 732e 6765 745f 7661 6c69 645f 7265 6769  s.get_valid_regi
+00001f00: 6f6e 735f 666f 725f 6c61 756e 6368 6162  ons_for_launchab
+00001f10: 6c65 2829 0a20 2020 2063 616e 6469 6461  le().    candida
+00001f20: 7465 5f72 6567 696f 6e73 203d 205b 0a20  te_regions = [. 
+00001f30: 2020 2020 2020 2072 6567 696f 6e20 666f         region fo
+00001f40: 7220 7265 6769 6f6e 2069 6e20 6361 6e64  r region in cand
+00001f50: 6964 6174 655f 7265 6769 6f6e 730a 2020  idate_regions.  
+00001f60: 2020 2020 2020 6966 2072 6567 696f 6e2e        if region.
+00001f70: 6e61 6d65 2069 6e20 6669 6c74 6572 6564  name in filtered
+00001f80: 5f72 6567 696f 6e73 0a20 2020 205d 0a0a  _regions.    ]..
+00001f90: 2020 2020 666f 7220 7265 6769 6f6e 2069      for region i
+00001fa0: 6e20 6361 6e64 6964 6174 655f 7265 6769  n candidate_regi
+00001fb0: 6f6e 733a 0a20 2020 2020 2020 2072 6573  ons:.        res
+00001fc0: 6f75 7263 6573 203d 206f 7269 6769 6e61  ources = origina
+00001fd0: 6c5f 7265 736f 7572 6365 732e 636f 7079  l_resources.copy
+00001fe0: 2872 6567 696f 6e3d 7265 6769 6f6e 2e6e  (region=region.n
+00001ff0: 616d 6529 0a20 2020 2020 2020 2069 6620  ame).        if 
+00002000: 6e6f 7420 4157 532e 6368 6563 6b5f 7175  not AWS.check_qu
+00002010: 6f74 615f 6176 6169 6c61 626c 6528 7265  ota_available(re
+00002020: 736f 7572 6365 7329 3a0a 2020 2020 2020  sources):.      
+00002030: 2020 2020 2020 7265 7475 726e 2072 6567        return reg
+00002040: 696f 6e2e 6e61 6d65 0a0a 2020 2020 7265  ion.name..    re
+00002050: 7475 726e 204e 6f6e 650a 0a0a 6465 6620  turn None...def 
+00002060: 6765 745f 6763 705f 7265 6769 6f6e 5f66  get_gcp_region_f
+00002070: 6f72 5f71 756f 7461 5f66 6169 6c6f 7665  or_quota_failove
+00002080: 7228 2920 2d3e 204f 7074 696f 6e61 6c5b  r() -> Optional[
+00002090: 7374 725d 3a0a 0a20 2020 2063 616e 6469  str]:..    candi
+000020a0: 6461 7465 5f72 6567 696f 6e73 203d 2047  date_regions = G
+000020b0: 4350 2e72 6567 696f 6e73 5f77 6974 685f  CP.regions_with_
+000020c0: 6f66 6665 7269 6e67 2869 6e73 7461 6e63  offering(instanc
+000020d0: 655f 7479 7065 3d4e 6f6e 652c 0a20 2020  e_type=None,.   
+000020e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000020f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002100: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00002110: 6363 656c 6572 6174 6f72 733d 7b27 4131  ccelerators={'A1
+00002120: 3030 2d38 3047 4227 3a20 317d 2c0a 2020  00-80GB': 1},.  
+00002130: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00002140: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00002150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002160: 2020 2020 2020 2020 2020 2020 2020 7a6f                zo
-00002170: 6e65 3d4e 6f6e 6529 0a0a 2020 2020 6f72  ne=None)..    or
-00002180: 6967 696e 616c 5f72 6573 6f75 7263 6573  iginal_resources
-00002190: 203d 2073 6b79 2e52 6573 6f75 7263 6573   = sky.Resources
-000021a0: 2863 6c6f 7564 3d73 6b79 2e47 4350 2829  (cloud=sky.GCP()
-000021b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00002160: 7573 655f 7370 6f74 3d54 7275 652c 0a20  use_spot=True,. 
+00002170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000021a0: 2072 6567 696f 6e3d 4e6f 6e65 2c0a 2020   region=None,.  
+000021b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000021c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000021d0: 2020 2020 2020 2020 2069 6e73 7461 6e63           instanc
-000021e0: 655f 7479 7065 3d27 6132 2d75 6c74 7261  e_type='a2-ultra
-000021f0: 6770 752d 3167 272c 0a20 2020 2020 2020  gpu-1g',.       
-00002200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002220: 6163 6365 6c65 7261 746f 7273 3d7b 2741  accelerators={'A
-00002230: 3130 302d 3830 4742 273a 2031 7d2c 0a20  100-80GB': 1},. 
-00002240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002260: 2020 2020 2020 7573 655f 7370 6f74 3d54        use_spot=T
-00002270: 7275 6529 0a0a 2020 2020 2320 4669 6c74  rue)..    # Filt
-00002280: 6572 2074 6865 2072 6567 696f 6e73 2077  er the regions w
-00002290: 6974 6820 7072 6f78 7920 636f 6d6d 616e  ith proxy comman
-000022a0: 6420 696e 207e 2f2e 736b 792f 636f 6e66  d in ~/.sky/conf
-000022b0: 6967 2e79 616d 6c2e 0a20 2020 2066 696c  ig.yaml..    fil
-000022c0: 7465 7265 645f 7265 6769 6f6e 7320 3d20  tered_regions = 
-000022d0: 6f72 6967 696e 616c 5f72 6573 6f75 7263  original_resourc
-000022e0: 6573 2e67 6574 5f76 616c 6964 5f72 6567  es.get_valid_reg
-000022f0: 696f 6e73 5f66 6f72 5f6c 6175 6e63 6861  ions_for_launcha
-00002300: 626c 6528 290a 2020 2020 6361 6e64 6964  ble().    candid
-00002310: 6174 655f 7265 6769 6f6e 7320 3d20 5b0a  ate_regions = [.
-00002320: 2020 2020 2020 2020 7265 6769 6f6e 2066          region f
-00002330: 6f72 2072 6567 696f 6e20 696e 2063 616e  or region in can
-00002340: 6469 6461 7465 5f72 6567 696f 6e73 0a20  didate_regions. 
-00002350: 2020 2020 2020 2069 6620 7265 6769 6f6e         if region
-00002360: 2e6e 616d 6520 696e 2066 696c 7465 7265  .name in filtere
-00002370: 645f 7265 6769 6f6e 730a 2020 2020 5d0a  d_regions.    ].
-00002380: 0a20 2020 2066 6f72 2072 6567 696f 6e20  .    for region 
-00002390: 696e 2063 616e 6469 6461 7465 5f72 6567  in candidate_reg
-000023a0: 696f 6e73 3a0a 2020 2020 2020 2020 6966  ions:.        if
-000023b0: 206e 6f74 2047 4350 2e63 6865 636b 5f71   not GCP.check_q
-000023c0: 756f 7461 5f61 7661 696c 6162 6c65 280a  uota_available(.
-000023d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000023e0: 6f72 6967 696e 616c 5f72 6573 6f75 7263  original_resourc
-000023f0: 6573 2e63 6f70 7928 7265 6769 6f6e 3d72  es.copy(region=r
-00002400: 6567 696f 6e2e 6e61 6d65 2929 3a0a 2020  egion.name)):.  
-00002410: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00002420: 2072 6567 696f 6e2e 6e61 6d65 0a0a 2020   region.name..  
-00002430: 2020 7265 7475 726e 204e 6f6e 650a 0a0a    return None...
-00002440: 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2044 7279  # ---------- Dry
-00002450: 2072 756e 3a20 3220 5461 736b 7320 696e   run: 2 Tasks in
-00002460: 2061 2063 6861 696e 2e20 2d2d 2d2d 2d2d   a chain. ------
-00002470: 2d2d 2d2d 0a40 7079 7465 7374 2e6d 6172  ----.@pytest.mar
-00002480: 6b2e 6e6f 5f66 6c75 6964 7374 6163 6b20  k.no_fluidstack 
-00002490: 2023 7265 7175 6972 6573 2047 4350 2061   #requires GCP a
-000024a0: 6e64 2041 5753 2073 6574 2075 700a 6465  nd AWS set up.de
-000024b0: 6620 7465 7374 5f65 7861 6d70 6c65 5f61  f test_example_a
-000024c0: 7070 2829 3a0a 2020 2020 7465 7374 203d  pp():.    test =
-000024d0: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
-000024e0: 6578 616d 706c 655f 6170 7027 2c0a 2020  example_app',.  
-000024f0: 2020 2020 2020 5b27 7079 7468 6f6e 2065        ['python e
-00002500: 7861 6d70 6c65 732f 6578 616d 706c 655f  xamples/example_
-00002510: 6170 702e 7079 275d 2c0a 2020 2020 290a  app.py'],.    ).
-00002520: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
-00002530: 2874 6573 7429 0a0a 0a23 202d 2d2d 2d2d  (test)...# -----
-00002540: 2d2d 2d2d 2d20 4120 6d69 6e69 6d61 6c20  ----- A minimal 
-00002550: 7461 736b 202d 2d2d 2d2d 2d2d 2d2d 2d0a  task ----------.
-00002560: 6465 6620 7465 7374 5f6d 696e 696d 616c  def test_minimal
-00002570: 2867 656e 6572 6963 5f63 6c6f 7564 3a20  (generic_cloud: 
-00002580: 7374 7229 3a0a 2020 2020 6e61 6d65 203d  str):.    name =
-00002590: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
-000025a0: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
-000025b0: 5465 7374 280a 2020 2020 2020 2020 276d  Test(.        'm
-000025c0: 696e 696d 616c 272c 0a20 2020 2020 2020  inimal',.       
-000025d0: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
-000025e0: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
-000025f0: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
-00002600: 207b 6765 6e65 7269 635f 636c 6f75 647d   {generic_cloud}
-00002610: 2074 6573 7473 2f74 6573 745f 7961 6d6c   tests/test_yaml
-00002620: 732f 6d69 6e69 6d61 6c2e 7961 6d6c 272c  s/minimal.yaml',
-00002630: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00002640: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
-00002650: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
-00002660: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
-00002670: 6773 207b 6e61 6d65 7d20 2d2d 7374 6174  gs {name} --stat
-00002680: 7573 207c 2067 7265 7020 224a 6f62 2031  us | grep "Job 1
-00002690: 3a20 5355 4343 4545 4445 4422 272c 2020  : SUCCEEDED"',  
-000026a0: 2320 4571 7569 7661 6c65 6e74 2e0a 2020  # Equivalent..  
-000026b0: 2020 2020 2020 2020 2020 2320 4368 6563            # Chec
-000026c0: 6b20 7468 6520 6c6f 6773 2064 6f77 6e6c  k the logs downl
-000026d0: 6f61 6469 6e67 0a20 2020 2020 2020 2020  oading.         
-000026e0: 2020 2066 276c 6f67 5f70 6174 683d 2428     f'log_path=$(
-000026f0: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-00002700: 3120 2d2d 7379 6e63 2d64 6f77 6e20 7c20  1 --sync-down | 
-00002710: 6772 6570 2022 4a6f 6220 3120 6c6f 6773  grep "Job 1 logs
-00002720: 3a22 207c 2073 6564 202d 4520 2273 2f5e  :" | sed -E "s/^
-00002730: 2e2a 4a6f 6220 3120 6c6f 6773 3a20 282e  .*Job 1 logs: (.
-00002740: 2a29 5c5c 7831 625c 5c5b 306d 2f5c 5c31  *)\\x1b\\[0m/\\1
-00002750: 2f67 2229 2026 2620 6563 686f 2024 6c6f  /g") && echo $lo
-00002760: 675f 7061 7468 2026 2620 7465 7374 202d  g_path && test -
-00002770: 6620 246c 6f67 5f70 6174 682f 7275 6e2e  f $log_path/run.
-00002780: 6c6f 6727 2c0a 2020 2020 2020 2020 2020  log',.          
-00002790: 2020 2320 456e 7375 7265 2074 6865 2072    # Ensure the r
-000027a0: 6179 6c65 7420 7072 6f63 6573 7320 6861  aylet process ha
-000027b0: 7320 7468 6520 636f 7272 6563 7420 6669  s the correct fi
-000027c0: 6c65 2064 6573 6372 6970 746f 7220 6c69  le descriptor li
-000027d0: 6d69 742e 0a20 2020 2020 2020 2020 2020  mit..           
-000027e0: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
-000027f0: 657d 2022 7072 6c69 6d69 7420 2d6e 202d  e} "prlimit -n -
-00002800: 2d70 6964 3d5c 2428 7067 7265 7020 2d66  -pid=\$(pgrep -f
-00002810: 205c 2772 6179 6c65 742f 7261 796c 6574   \'raylet/raylet
-00002820: 202d 2d72 6179 6c65 745f 736f 636b 6574   --raylet_socket
-00002830: 5f6e 616d 655c 2729 207c 2067 7265 7020  _name\') | grep 
-00002840: 5c27 225c 2731 3034 3835 3736 2031 3034  \'"\'1048576 104
-00002850: 3835 3736 5c27 225c 2722 272c 0a20 2020  8576\'"\'"',.   
-00002860: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00002870: 6f67 7320 7b6e 616d 657d 2032 202d 2d73  ogs {name} 2 --s
-00002880: 7461 7475 7327 2c20 2023 2045 6e73 7572  tatus',  # Ensur
-00002890: 6520 7468 6520 6a6f 6220 7375 6363 6565  e the job succee
-000028a0: 6465 642e 0a20 2020 2020 2020 2020 2020  ded..           
-000028b0: 2023 2043 6865 636b 2074 6865 2063 6c75   # Check the clu
-000028c0: 7374 6572 2069 6e66 6f0a 2020 2020 2020  ster info.      
-000028d0: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
-000028e0: 207b 6e61 6d65 7d20 5c27 6563 686f 2024   {name} \'echo $
-000028f0: 534b 5950 494c 4f54 5f43 4c55 5354 4552  SKYPILOT_CLUSTER
-00002900: 5f49 4e46 4f20 7c20 6a71 202e 636c 7573  _INFO | jq .clus
-00002910: 7465 725f 6e61 6d65 207c 2067 7265 7020  ter_name | grep 
-00002920: 7b6e 616d 657d 5c27 272c 0a20 2020 2020  {name}\'',.     
-00002930: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-00002940: 7320 7b6e 616d 657d 2033 202d 2d73 7461  s {name} 3 --sta
-00002950: 7475 7327 2c20 2023 2045 6e73 7572 6520  tus',  # Ensure 
-00002960: 7468 6520 6a6f 6220 7375 6363 6565 6465  the job succeede
-00002970: 642e 0a20 2020 2020 2020 2020 2020 2066  d..            f
-00002980: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
-00002990: 205c 2765 6368 6f20 2453 4b59 5049 4c4f   \'echo $SKYPILO
-000029a0: 545f 434c 5553 5445 525f 494e 464f 207c  T_CLUSTER_INFO |
-000029b0: 206a 7120 2e63 6c6f 7564 207c 2067 7265   jq .cloud | gre
-000029c0: 7020 2d69 207b 6765 6e65 7269 635f 636c  p -i {generic_cl
-000029d0: 6f75 647d 5c27 272c 0a20 2020 2020 2020  oud}\'',.       
-000029e0: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-000029f0: 7b6e 616d 657d 2034 202d 2d73 7461 7475  {name} 4 --statu
-00002a00: 7327 2c20 2023 2045 6e73 7572 6520 7468  s',  # Ensure th
-00002a10: 6520 6a6f 6220 7375 6363 6565 6465 642e  e job succeeded.
-00002a20: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
-00002a30: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
-00002a40: 7920 7b6e 616d 657d 272c 0a20 2020 2020  y {name}',.     
-00002a50: 2020 205f 6765 745f 7469 6d65 6f75 7428     _get_timeout(
-00002a60: 6765 6e65 7269 635f 636c 6f75 6429 2c0a  generic_cloud),.
-00002a70: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
-00002a80: 655f 7465 7374 2874 6573 7429 0a0a 0a23  e_test(test)...#
-00002a90: 202d 2d2d 2d2d 2d2d 2d2d 2d20 5465 7374   ---------- Test
-00002aa0: 2072 6567 696f 6e20 2d2d 2d2d 2d2d 2d2d   region --------
-00002ab0: 2d2d 0a40 7079 7465 7374 2e6d 6172 6b2e  --.@pytest.mark.
-00002ac0: 6177 730a 6465 6620 7465 7374 5f61 7773  aws.def test_aws
-00002ad0: 5f72 6567 696f 6e28 293a 0a20 2020 206e  _region():.    n
-00002ae0: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
-00002af0: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
-00002b00: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
-00002b10: 2020 2027 6177 735f 7265 6769 6f6e 272c     'aws_region',
-00002b20: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
-00002b30: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
-00002b40: 6e63 6820 2d79 202d 6320 7b6e 616d 657d  nch -y -c {name}
-00002b50: 202d 2d72 6567 696f 6e20 7573 2d65 6173   --region us-eas
-00002b60: 742d 3220 6578 616d 706c 6573 2f6d 696e  t-2 examples/min
-00002b70: 696d 616c 2e79 616d 6c27 2c0a 2020 2020  imal.yaml',.    
-00002b80: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
-00002b90: 6563 207b 6e61 6d65 7d20 6578 616d 706c  ec {name} exampl
-00002ba0: 6573 2f6d 696e 696d 616c 2e79 616d 6c27  es/minimal.yaml'
-00002bb0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00002bc0: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-00002bd0: 3120 2d2d 7374 6174 7573 272c 2020 2320  1 --status',  # 
-00002be0: 456e 7375 7265 2074 6865 206a 6f62 2073  Ensure the job s
-00002bf0: 7563 6365 6564 6564 2e0a 2020 2020 2020  ucceeded..      
-00002c00: 2020 2020 2020 6627 736b 7920 7374 6174        f'sky stat
-00002c10: 7573 202d 2d61 6c6c 207c 2067 7265 7020  us --all | grep 
-00002c20: 7b6e 616d 657d 207c 2067 7265 7020 7573  {name} | grep us
-00002c30: 2d65 6173 742d 3227 2c20 2023 2045 6e73  -east-2',  # Ens
-00002c40: 7572 6520 7468 6520 7265 6769 6f6e 2069  ure the region i
-00002c50: 7320 636f 7272 6563 742e 0a20 2020 2020  s correct..     
-00002c60: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
-00002c70: 6320 7b6e 616d 657d 205c 2765 6368 6f20  c {name} \'echo 
-00002c80: 2453 4b59 5049 4c4f 545f 434c 5553 5445  $SKYPILOT_CLUSTE
-00002c90: 525f 494e 464f 207c 206a 7120 2e72 6567  R_INFO | jq .reg
-00002ca0: 696f 6e20 7c20 6772 6570 2075 732d 6561  ion | grep us-ea
-00002cb0: 7374 2d32 5c27 272c 0a20 2020 2020 2020  st-2\'',.       
-00002cc0: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-00002cd0: 7b6e 616d 657d 2032 202d 2d73 7461 7475  {name} 2 --statu
-00002ce0: 7327 2c20 2023 2045 6e73 7572 6520 7468  s',  # Ensure th
-00002cf0: 6520 6a6f 6220 7375 6363 6565 6465 642e  e job succeeded.
-00002d00: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
-00002d10: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
-00002d20: 7920 7b6e 616d 657d 272c 0a20 2020 2029  y {name}',.    )
-00002d30: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
-00002d40: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
-00002d50: 742e 6d61 726b 2e67 6370 0a64 6566 2074  t.mark.gcp.def t
-00002d60: 6573 745f 6763 705f 7265 6769 6f6e 5f61  est_gcp_region_a
-00002d70: 6e64 5f73 6572 7669 6365 5f61 6363 6f75  nd_service_accou
-00002d80: 6e74 2829 3a0a 2020 2020 6e61 6d65 203d  nt():.    name =
-00002d90: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
-00002da0: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
-00002db0: 5465 7374 280a 2020 2020 2020 2020 2767  Test(.        'g
-00002dc0: 6370 5f72 6567 696f 6e27 2c0a 2020 2020  cp_region',.    
-00002dd0: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
-00002de0: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
-00002df0: 7920 2d63 207b 6e61 6d65 7d20 2d2d 7265  y -c {name} --re
-00002e00: 6769 6f6e 2075 732d 6365 6e74 7261 6c31  gion us-central1
-00002e10: 202d 2d63 6c6f 7564 2067 6370 2074 6573   --cloud gcp tes
-00002e20: 7473 2f74 6573 745f 7961 6d6c 732f 6d69  ts/test_yamls/mi
-00002e30: 6e69 6d61 6c2e 7961 6d6c 272c 0a20 2020  nimal.yaml',.   
-00002e40: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
-00002e50: 7865 6320 7b6e 616d 657d 2074 6573 7473  xec {name} tests
-00002e60: 2f74 6573 745f 7961 6d6c 732f 6d69 6e69  /test_yamls/mini
-00002e70: 6d61 6c2e 7961 6d6c 272c 0a20 2020 2020  mal.yaml',.     
-00002e80: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-00002e90: 7320 7b6e 616d 657d 2031 202d 2d73 7461  s {name} 1 --sta
-00002ea0: 7475 7327 2c20 2023 2045 6e73 7572 6520  tus',  # Ensure 
-00002eb0: 7468 6520 6a6f 6220 7375 6363 6565 6465  the job succeede
-00002ec0: 642e 0a20 2020 2020 2020 2020 2020 2066  d..            f
-00002ed0: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
-00002ee0: 205c 2763 7572 6c20 2d48 2022 4d65 7461   \'curl -H "Meta
-00002ef0: 6461 7461 2d46 6c61 766f 723a 2047 6f6f  data-Flavor: Goo
-00002f00: 676c 6522 2022 6874 7470 3a2f 2f6d 6574  gle" "http://met
-00002f10: 6164 6174 612e 676f 6f67 6c65 2e69 6e74  adata.google.int
-00002f20: 6572 6e61 6c2f 636f 6d70 7574 654d 6574  ernal/computeMet
-00002f30: 6164 6174 612f 7631 2f69 6e73 7461 6e63  adata/v1/instanc
-00002f40: 652f 7365 7276 6963 652d 6163 636f 756e  e/service-accoun
-00002f50: 7473 2f64 6566 6175 6c74 2f69 6465 6e74  ts/default/ident
-00002f60: 6974 793f 666f 726d 6174 3d73 7461 6e64  ity?format=stand
-00002f70: 6172 6426 6175 6469 656e 6365 3d67 6370  ard&audience=gcp
-00002f80: 225c 2727 2c0a 2020 2020 2020 2020 2020  "\'',.          
-00002f90: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
-00002fa0: 6d65 7d20 3220 2d2d 7374 6174 7573 272c  me} 2 --status',
-00002fb0: 2020 2320 456e 7375 7265 2074 6865 206a    # Ensure the j
-00002fc0: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
-00002fd0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00002fe0: 7374 6174 7573 202d 2d61 6c6c 207c 2067  status --all | g
-00002ff0: 7265 7020 7b6e 616d 657d 207c 2067 7265  rep {name} | gre
-00003000: 7020 7573 2d63 656e 7472 616c 3127 2c20  p us-central1', 
-00003010: 2023 2045 6e73 7572 6520 7468 6520 7265   # Ensure the re
-00003020: 6769 6f6e 2069 7320 636f 7272 6563 742e  gion is correct.
-00003030: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00003040: 6b79 2065 7865 6320 7b6e 616d 657d 205c  ky exec {name} \
-00003050: 2765 6368 6f20 2453 4b59 5049 4c4f 545f  'echo $SKYPILOT_
-00003060: 434c 5553 5445 525f 494e 464f 207c 206a  CLUSTER_INFO | j
-00003070: 7120 2e72 6567 696f 6e20 7c20 6772 6570  q .region | grep
-00003080: 2075 732d 6365 6e74 7261 6c31 5c27 272c   us-central1\'',
-00003090: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-000030a0: 6b79 206c 6f67 7320 7b6e 616d 657d 2033  ky logs {name} 3
-000030b0: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
-000030c0: 6e73 7572 6520 7468 6520 6a6f 6220 7375  nsure the job su
-000030d0: 6363 6565 6465 642e 0a20 2020 2020 2020  cceeded..       
-000030e0: 205d 2c0a 2020 2020 2020 2020 6627 736b   ],.        f'sk
-000030f0: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
-00003100: 272c 0a20 2020 2029 0a20 2020 2072 756e  ',.    ).    run
-00003110: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
-00003120: 0a0a 4070 7974 6573 742e 6d61 726b 2e69  ..@pytest.mark.i
-00003130: 626d 0a64 6566 2074 6573 745f 6962 6d5f  bm.def test_ibm_
-00003140: 7265 6769 6f6e 2829 3a0a 2020 2020 6e61  region():.    na
-00003150: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
-00003160: 725f 6e61 6d65 2829 0a20 2020 2072 6567  r_name().    reg
-00003170: 696f 6e20 3d20 2765 752d 6465 270a 2020  ion = 'eu-de'.  
-00003180: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
-00003190: 2020 2020 2020 2027 7265 6769 6f6e 272c         'region',
-000031a0: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
-000031b0: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
-000031c0: 6e63 6820 2d79 202d 6320 7b6e 616d 657d  nch -y -c {name}
-000031d0: 202d 2d63 6c6f 7564 2069 626d 202d 2d72   --cloud ibm --r
-000031e0: 6567 696f 6e20 7b72 6567 696f 6e7d 2065  egion {region} e
-000031f0: 7861 6d70 6c65 732f 6d69 6e69 6d61 6c2e  xamples/minimal.
-00003200: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
-00003210: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
-00003220: 616d 657d 202d 2d63 6c6f 7564 2069 626d  ame} --cloud ibm
-00003230: 2065 7861 6d70 6c65 732f 6d69 6e69 6d61   examples/minima
-00003240: 6c2e 7961 6d6c 272c 0a20 2020 2020 2020  l.yaml',.       
-00003250: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-00003260: 7b6e 616d 657d 2031 202d 2d73 7461 7475  {name} 1 --statu
-00003270: 7327 2c20 2023 2045 6e73 7572 6520 7468  s',  # Ensure th
-00003280: 6520 6a6f 6220 7375 6363 6565 6465 642e  e job succeeded.
-00003290: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-000032a0: 6b79 2073 7461 7475 7320 2d2d 616c 6c20  ky status --all 
-000032b0: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
-000032c0: 6772 6570 207b 7265 6769 6f6e 7d27 2c20  grep {region}', 
-000032d0: 2023 2045 6e73 7572 6520 7468 6520 7265   # Ensure the re
-000032e0: 6769 6f6e 2069 7320 636f 7272 6563 742e  gion is correct.
-000032f0: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
-00003300: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
-00003310: 7920 7b6e 616d 657d 272c 0a20 2020 2029  y {name}',.    )
-00003320: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
-00003330: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
-00003340: 742e 6d61 726b 2e61 7a75 7265 0a64 6566  t.mark.azure.def
-00003350: 2074 6573 745f 617a 7572 655f 7265 6769   test_azure_regi
-00003360: 6f6e 2829 3a0a 2020 2020 6e61 6d65 203d  on():.    name =
-00003370: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
-00003380: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
-00003390: 5465 7374 280a 2020 2020 2020 2020 2761  Test(.        'a
-000033a0: 7a75 7265 5f72 6567 696f 6e27 2c0a 2020  zure_region',.  
-000033b0: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
-000033c0: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
-000033d0: 202d 7920 2d63 207b 6e61 6d65 7d20 2d2d   -y -c {name} --
-000033e0: 7265 6769 6f6e 2065 6173 7475 7332 202d  region eastus2 -
-000033f0: 2d63 6c6f 7564 2061 7a75 7265 2074 6573  -cloud azure tes
-00003400: 7473 2f74 6573 745f 7961 6d6c 732f 6d69  ts/test_yamls/mi
-00003410: 6e69 6d61 6c2e 7961 6d6c 272c 0a20 2020  nimal.yaml',.   
-00003420: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
-00003430: 7865 6320 7b6e 616d 657d 2074 6573 7473  xec {name} tests
-00003440: 2f74 6573 745f 7961 6d6c 732f 6d69 6e69  /test_yamls/mini
-00003450: 6d61 6c2e 7961 6d6c 272c 0a20 2020 2020  mal.yaml',.     
-00003460: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-00003470: 7320 7b6e 616d 657d 2031 202d 2d73 7461  s {name} 1 --sta
-00003480: 7475 7327 2c20 2023 2045 6e73 7572 6520  tus',  # Ensure 
-00003490: 7468 6520 6a6f 6220 7375 6363 6565 6465  the job succeede
-000034a0: 642e 0a20 2020 2020 2020 2020 2020 2066  d..            f
-000034b0: 2773 6b79 2073 7461 7475 7320 2d2d 616c  'sky status --al
-000034c0: 6c20 7c20 6772 6570 207b 6e61 6d65 7d20  l | grep {name} 
-000034d0: 7c20 6772 6570 2065 6173 7475 7332 272c  | grep eastus2',
-000034e0: 2020 2320 456e 7375 7265 2074 6865 2072    # Ensure the r
-000034f0: 6567 696f 6e20 6973 2063 6f72 7265 6374  egion is correct
-00003500: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
-00003510: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
-00003520: 5c27 6563 686f 2024 534b 5950 494c 4f54  \'echo $SKYPILOT
-00003530: 5f43 4c55 5354 4552 5f49 4e46 4f20 7c20  _CLUSTER_INFO | 
-00003540: 6a71 202e 7265 6769 6f6e 207c 2067 7265  jq .region | gre
-00003550: 7020 6561 7374 7573 325c 2727 2c0a 2020  p eastus2\'',.  
-00003560: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00003570: 6c6f 6773 207b 6e61 6d65 7d20 3220 2d2d  logs {name} 2 --
-00003580: 7374 6174 7573 272c 2020 2320 456e 7375  status',  # Ensu
-00003590: 7265 2074 6865 206a 6f62 2073 7563 6365  re the job succe
-000035a0: 6564 6564 2e0a 2020 2020 2020 2020 2020  eded..          
-000035b0: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
-000035c0: 6d65 7d20 5c27 6563 686f 2024 534b 5950  me} \'echo $SKYP
-000035d0: 494c 4f54 5f43 4c55 5354 4552 5f49 4e46  ILOT_CLUSTER_INF
-000035e0: 4f20 7c20 6a71 202e 7a6f 6e65 207c 2067  O | jq .zone | g
-000035f0: 7265 7020 6e75 6c6c 5c27 272c 0a20 2020  rep null\'',.   
-00003600: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00003610: 6f67 7320 7b6e 616d 657d 2033 202d 2d73  ogs {name} 3 --s
-00003620: 7461 7475 7327 2c20 2023 2045 6e73 7572  tatus',  # Ensur
-00003630: 6520 7468 6520 6a6f 6220 7375 6363 6565  e the job succee
-00003640: 6465 642e 0a20 2020 2020 2020 205d 2c0a  ded..        ],.
-00003650: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
-00003660: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
-00003670: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
-00003680: 5f74 6573 7428 7465 7374 290a 0a0a 2320  _test(test)...# 
-00003690: 2d2d 2d2d 2d2d 2d2d 2d2d 2054 6573 7420  ---------- Test 
-000036a0: 7a6f 6e65 202d 2d2d 2d2d 2d2d 2d2d 2d0a  zone ----------.
-000036b0: 4070 7974 6573 742e 6d61 726b 2e61 7773  @pytest.mark.aws
-000036c0: 0a64 6566 2074 6573 745f 6177 735f 7a6f  .def test_aws_zo
-000036d0: 6e65 2829 3a0a 2020 2020 6e61 6d65 203d  ne():.    name =
-000036e0: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
-000036f0: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
-00003700: 5465 7374 280a 2020 2020 2020 2020 2761  Test(.        'a
-00003710: 7773 5f7a 6f6e 6527 2c0a 2020 2020 2020  ws_zone',.      
-00003720: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
-00003730: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
-00003740: 2d63 207b 6e61 6d65 7d20 6578 616d 706c  -c {name} exampl
-00003750: 6573 2f6d 696e 696d 616c 2e79 616d 6c20  es/minimal.yaml 
-00003760: 2d2d 7a6f 6e65 2075 732d 6561 7374 2d32  --zone us-east-2
-00003770: 6227 2c0a 2020 2020 2020 2020 2020 2020  b',.            
-00003780: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
-00003790: 7d20 6578 616d 706c 6573 2f6d 696e 696d  } examples/minim
-000037a0: 616c 2e79 616d 6c20 2d2d 7a6f 6e65 2075  al.yaml --zone u
-000037b0: 732d 6561 7374 2d32 6227 2c0a 2020 2020  s-east-2b',.    
-000037c0: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
-000037d0: 6773 207b 6e61 6d65 7d20 3120 2d2d 7374  gs {name} 1 --st
-000037e0: 6174 7573 272c 2020 2320 456e 7375 7265  atus',  # Ensure
-000037f0: 2074 6865 206a 6f62 2073 7563 6365 6564   the job succeed
-00003800: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
-00003810: 6627 736b 7920 7374 6174 7573 202d 2d61  f'sky status --a
-00003820: 6c6c 207c 2067 7265 7020 7b6e 616d 657d  ll | grep {name}
-00003830: 207c 2067 7265 7020 7573 2d65 6173 742d   | grep us-east-
-00003840: 3262 272c 2020 2320 456e 7375 7265 2074  2b',  # Ensure t
-00003850: 6865 207a 6f6e 6520 6973 2063 6f72 7265  he zone is corre
-00003860: 6374 2e0a 2020 2020 2020 2020 5d2c 0a20  ct..        ],. 
-00003870: 2020 2020 2020 2066 2773 6b79 2064 6f77         f'sky dow
-00003880: 6e20 2d79 207b 6e61 6d65 7d27 2c0a 2020  n -y {name}',.  
-00003890: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
-000038a0: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
-000038b0: 7465 7374 2e6d 6172 6b2e 6962 6d0a 6465  test.mark.ibm.de
-000038c0: 6620 7465 7374 5f69 626d 5f7a 6f6e 6528  f test_ibm_zone(
-000038d0: 293a 0a20 2020 206e 616d 6520 3d20 5f67  ):.    name = _g
-000038e0: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
-000038f0: 290a 2020 2020 7a6f 6e65 203d 2027 6575  ).    zone = 'eu
-00003900: 2d64 652d 3227 0a20 2020 2074 6573 7420  -de-2'.    test 
-00003910: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
-00003920: 277a 6f6e 6527 2c0a 2020 2020 2020 2020  'zone',.        
-00003930: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
-00003940: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
-00003950: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
-00003960: 6962 6d20 6578 616d 706c 6573 2f6d 696e  ibm examples/min
-00003970: 696d 616c 2e79 616d 6c20 2d2d 7a6f 6e65  imal.yaml --zone
-00003980: 207b 7a6f 6e65 7d27 2c0a 2020 2020 2020   {zone}',.      
-00003990: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
-000039a0: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
-000039b0: 6962 6d20 6578 616d 706c 6573 2f6d 696e  ibm examples/min
-000039c0: 696d 616c 2e79 616d 6c20 2d2d 7a6f 6e65  imal.yaml --zone
-000039d0: 207b 7a6f 6e65 7d27 2c0a 2020 2020 2020   {zone}',.      
-000039e0: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
-000039f0: 207b 6e61 6d65 7d20 3120 2d2d 7374 6174   {name} 1 --stat
-00003a00: 7573 272c 2020 2320 456e 7375 7265 2074  us',  # Ensure t
-00003a10: 6865 206a 6f62 2073 7563 6365 6564 6564  he job succeeded
-00003a20: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
-00003a30: 736b 7920 7374 6174 7573 202d 2d61 6c6c  sky status --all
-00003a40: 207c 2067 7265 7020 7b6e 616d 657d 207c   | grep {name} |
-00003a50: 2067 7265 7020 7b7a 6f6e 657d 272c 2020   grep {zone}',  
-00003a60: 2320 456e 7375 7265 2074 6865 207a 6f6e  # Ensure the zon
-00003a70: 6520 6973 2063 6f72 7265 6374 2e0a 2020  e is correct..  
-00003a80: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-00003a90: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
-00003aa0: 6e61 6d65 7d20 7b6e 616d 657d 2d32 207b  name} {name}-2 {
-00003ab0: 6e61 6d65 7d2d 3327 2c0a 2020 2020 290a  name}-3',.    ).
-00003ac0: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
-00003ad0: 2874 6573 7429 0a0a 0a40 7079 7465 7374  (test)...@pytest
-00003ae0: 2e6d 6172 6b2e 6763 700a 6465 6620 7465  .mark.gcp.def te
-00003af0: 7374 5f67 6370 5f7a 6f6e 6528 293a 0a20  st_gcp_zone():. 
-00003b00: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
-00003b10: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
-00003b20: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
-00003b30: 2020 2020 2020 2027 6763 705f 7a6f 6e65         'gcp_zone
-00003b40: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
-00003b50: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00003b60: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
-00003b70: 657d 202d 2d7a 6f6e 6520 7573 2d63 656e  e} --zone us-cen
-00003b80: 7472 616c 312d 6120 2d2d 636c 6f75 6420  tral1-a --cloud 
-00003b90: 6763 7020 7465 7374 732f 7465 7374 5f79  gcp tests/test_y
-00003ba0: 616d 6c73 2f6d 696e 696d 616c 2e79 616d  amls/minimal.yam
-00003bb0: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
-00003bc0: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
-00003bd0: 7d20 2d2d 7a6f 6e65 2075 732d 6365 6e74  } --zone us-cent
-00003be0: 7261 6c31 2d61 202d 2d63 6c6f 7564 2067  ral1-a --cloud g
-00003bf0: 6370 2074 6573 7473 2f74 6573 745f 7961  cp tests/test_ya
-00003c00: 6d6c 732f 6d69 6e69 6d61 6c2e 7961 6d6c  mls/minimal.yaml
-00003c10: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00003c20: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-00003c30: 2031 202d 2d73 7461 7475 7327 2c20 2023   1 --status',  #
-00003c40: 2045 6e73 7572 6520 7468 6520 6a6f 6220   Ensure the job 
-00003c50: 7375 6363 6565 6465 642e 0a20 2020 2020  succeeded..     
-00003c60: 2020 2020 2020 2066 2773 6b79 2073 7461         f'sky sta
-00003c70: 7475 7320 2d2d 616c 6c20 7c20 6772 6570  tus --all | grep
-00003c80: 207b 6e61 6d65 7d20 7c20 6772 6570 2075   {name} | grep u
-00003c90: 732d 6365 6e74 7261 6c31 2d61 272c 2020  s-central1-a',  
-00003ca0: 2320 456e 7375 7265 2074 6865 207a 6f6e  # Ensure the zon
-00003cb0: 6520 6973 2063 6f72 7265 6374 2e0a 2020  e is correct..  
-00003cc0: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-00003cd0: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
-00003ce0: 6e61 6d65 7d27 2c0a 2020 2020 290a 2020  name}',.    ).  
-00003cf0: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
-00003d00: 6573 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d  est)...# -------
-00003d10: 2d2d 2d20 5465 7374 2074 6865 2069 6d61  --- Test the ima
-00003d20: 6765 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070  ge ----------.@p
-00003d30: 7974 6573 742e 6d61 726b 2e61 7773 0a64  ytest.mark.aws.d
-00003d40: 6566 2074 6573 745f 6177 735f 696d 6167  ef test_aws_imag
-00003d50: 6573 2829 3a0a 2020 2020 6e61 6d65 203d  es():.    name =
-00003d60: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
-00003d70: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
-00003d80: 5465 7374 280a 2020 2020 2020 2020 2761  Test(.        'a
-00003d90: 7773 5f69 6d61 6765 7327 2c0a 2020 2020  ws_images',.    
-00003da0: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
-00003db0: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
-00003dc0: 7920 2d63 207b 6e61 6d65 7d20 2d2d 696d  y -c {name} --im
-00003dd0: 6167 652d 6964 2073 6b79 7069 6c6f 743a  age-id skypilot:
-00003de0: 6770 752d 7562 756e 7475 2d31 3830 3420  gpu-ubuntu-1804 
-00003df0: 6578 616d 706c 6573 2f6d 696e 696d 616c  examples/minimal
-00003e00: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
-00003e10: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
-00003e20: 6e61 6d65 7d20 3120 2d2d 7374 6174 7573  name} 1 --status
-00003e30: 272c 2020 2320 456e 7375 7265 2074 6865  ',  # Ensure the
-00003e40: 206a 6f62 2073 7563 6365 6564 6564 2e0a   job succeeded..
-00003e50: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00003e60: 7920 6c61 756e 6368 202d 6320 7b6e 616d  y launch -c {nam
-00003e70: 657d 202d 2d69 6d61 6765 2d69 6420 736b  e} --image-id sk
-00003e80: 7970 696c 6f74 3a67 7075 2d75 6275 6e74  ypilot:gpu-ubunt
-00003e90: 752d 3230 3034 2065 7861 6d70 6c65 732f  u-2004 examples/
-00003ea0: 6d69 6e69 6d61 6c2e 7961 6d6c 2026 2620  minimal.yaml && 
-00003eb0: 6578 6974 2031 207c 7c20 7472 7565 272c  exit 1 || true',
-00003ec0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00003ed0: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
-00003ee0: 7b6e 616d 657d 2065 7861 6d70 6c65 732f  {name} examples/
-00003ef0: 6d69 6e69 6d61 6c2e 7961 6d6c 272c 0a20  minimal.yaml',. 
-00003f00: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00003f10: 206c 6f67 7320 7b6e 616d 657d 2032 202d   logs {name} 2 -
-00003f20: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
-00003f30: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
-00003f40: 207b 6e61 6d65 7d20 2d2d 7374 6174 7573   {name} --status
-00003f50: 207c 2067 7265 7020 224a 6f62 2032 3a20   | grep "Job 2: 
-00003f60: 5355 4343 4545 4445 4422 272c 2020 2320  SUCCEEDED"',  # 
-00003f70: 4571 7569 7661 6c65 6e74 2e0a 2020 2020  Equivalent..    
-00003f80: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
-00003f90: 6563 207b 6e61 6d65 7d20 5c27 6563 686f  ec {name} \'echo
-00003fa0: 2024 534b 5950 494c 4f54 5f43 4c55 5354   $SKYPILOT_CLUST
-00003fb0: 4552 5f49 4e46 4f20 7c20 6a71 202e 636c  ER_INFO | jq .cl
-00003fc0: 6f75 6420 7c20 6772 6570 202d 6920 6177  oud | grep -i aw
-00003fd0: 735c 2727 2c0a 2020 2020 2020 2020 2020  s\'',.          
-00003fe0: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
-00003ff0: 6d65 7d20 3320 2d2d 7374 6174 7573 272c  me} 3 --status',
-00004000: 2020 2320 456e 7375 7265 2074 6865 206a    # Ensure the j
-00004010: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
-00004020: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-00004030: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
-00004040: 6e61 6d65 7d27 2c0a 2020 2020 290a 2020  name}',.    ).  
-00004050: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
-00004060: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
-00004070: 6172 6b2e 6763 700a 6465 6620 7465 7374  ark.gcp.def test
-00004080: 5f67 6370 5f69 6d61 6765 7328 293a 0a20  _gcp_images():. 
-00004090: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
-000040a0: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
-000040b0: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
-000040c0: 2020 2020 2020 2027 6763 705f 696d 6167         'gcp_imag
-000040d0: 6573 272c 0a20 2020 2020 2020 205b 0a20  es',.        [. 
-000040e0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-000040f0: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
-00004100: 616d 657d 202d 2d69 6d61 6765 2d69 6420  ame} --image-id 
-00004110: 736b 7970 696c 6f74 3a67 7075 2d64 6562  skypilot:gpu-deb
-00004120: 6961 6e2d 3130 202d 2d63 6c6f 7564 2067  ian-10 --cloud g
-00004130: 6370 2074 6573 7473 2f74 6573 745f 7961  cp tests/test_ya
-00004140: 6d6c 732f 6d69 6e69 6d61 6c2e 7961 6d6c  mls/minimal.yaml
-00004150: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00004160: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-00004170: 2031 202d 2d73 7461 7475 7327 2c20 2023   1 --status',  #
-00004180: 2045 6e73 7572 6520 7468 6520 6a6f 6220   Ensure the job 
-00004190: 7375 6363 6565 6465 642e 0a20 2020 2020  succeeded..     
-000041a0: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
-000041b0: 6e63 6820 2d63 207b 6e61 6d65 7d20 2d2d  nch -c {name} --
-000041c0: 696d 6167 652d 6964 2073 6b79 7069 6c6f  image-id skypilo
-000041d0: 743a 6370 752d 6465 6269 616e 2d31 3020  t:cpu-debian-10 
-000041e0: 2d2d 636c 6f75 6420 6763 7020 7465 7374  --cloud gcp test
-000041f0: 732f 7465 7374 5f79 616d 6c73 2f6d 696e  s/test_yamls/min
-00004200: 696d 616c 2e79 616d 6c20 2626 2065 7869  imal.yaml && exi
-00004210: 7420 3120 7c7c 2074 7275 6527 2c0a 2020  t 1 || true',.  
-00004220: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00004230: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
-00004240: 6d65 7d20 7465 7374 732f 7465 7374 5f79  me} tests/test_y
-00004250: 616d 6c73 2f6d 696e 696d 616c 2e79 616d  amls/minimal.yam
-00004260: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
-00004270: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
-00004280: 7d20 3220 2d2d 7374 6174 7573 272c 0a20  } 2 --status',. 
-00004290: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-000042a0: 206c 6f67 7320 7b6e 616d 657d 202d 2d73   logs {name} --s
-000042b0: 7461 7475 7320 7c20 6772 6570 2022 4a6f  tatus | grep "Jo
-000042c0: 6220 323a 2053 5543 4345 4544 4544 2227  b 2: SUCCEEDED"'
-000042d0: 2c20 2023 2045 7175 6976 616c 656e 742e  ,  # Equivalent.
-000042e0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-000042f0: 6b79 2065 7865 6320 7b6e 616d 657d 205c  ky exec {name} \
-00004300: 2765 6368 6f20 2453 4b59 5049 4c4f 545f  'echo $SKYPILOT_
-00004310: 434c 5553 5445 525f 494e 464f 207c 206a  CLUSTER_INFO | j
-00004320: 7120 2e63 6c6f 7564 207c 2067 7265 7020  q .cloud | grep 
-00004330: 2d69 2067 6370 5c27 272c 0a20 2020 2020  -i gcp\'',.     
-00004340: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-00004350: 7320 7b6e 616d 657d 2033 202d 2d73 7461  s {name} 3 --sta
-00004360: 7475 7327 2c20 2023 2045 6e73 7572 6520  tus',  # Ensure 
-00004370: 7468 6520 6a6f 6220 7375 6363 6565 6465  the job succeede
-00004380: 642e 0a20 2020 2020 2020 205d 2c0a 2020  d..        ],.  
-00004390: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
-000043a0: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
-000043b0: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
-000043c0: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
-000043d0: 6573 742e 6d61 726b 2e61 7a75 7265 0a64  est.mark.azure.d
-000043e0: 6566 2074 6573 745f 617a 7572 655f 696d  ef test_azure_im
-000043f0: 6167 6573 2829 3a0a 2020 2020 6e61 6d65  ages():.    name
-00004400: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
-00004410: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
-00004420: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
-00004430: 2761 7a75 7265 5f69 6d61 6765 7327 2c0a  'azure_images',.
-00004440: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
-00004450: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
-00004460: 6368 202d 7920 2d63 207b 6e61 6d65 7d20  ch -y -c {name} 
-00004470: 2d2d 696d 6167 652d 6964 2073 6b79 7069  --image-id skypi
-00004480: 6c6f 743a 6770 752d 7562 756e 7475 2d32  lot:gpu-ubuntu-2
-00004490: 3230 3420 2d2d 636c 6f75 6420 617a 7572  204 --cloud azur
-000044a0: 6520 7465 7374 732f 7465 7374 5f79 616d  e tests/test_yam
-000044b0: 6c73 2f6d 696e 696d 616c 2e79 616d 6c27  ls/minimal.yaml'
-000044c0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-000044d0: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-000044e0: 3120 2d2d 7374 6174 7573 272c 2020 2320  1 --status',  # 
-000044f0: 456e 7375 7265 2074 6865 206a 6f62 2073  Ensure the job s
-00004500: 7563 6365 6564 6564 2e0a 2020 2020 2020  ucceeded..      
-00004510: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
-00004520: 6368 202d 6320 7b6e 616d 657d 202d 2d69  ch -c {name} --i
-00004530: 6d61 6765 2d69 6420 736b 7970 696c 6f74  mage-id skypilot
-00004540: 3a76 312d 7562 756e 7475 2d32 3030 3420  :v1-ubuntu-2004 
-00004550: 2d2d 636c 6f75 6420 617a 7572 6520 7465  --cloud azure te
-00004560: 7374 732f 7465 7374 5f79 616d 6c73 2f6d  sts/test_yamls/m
-00004570: 696e 696d 616c 2e79 616d 6c20 2626 2065  inimal.yaml && e
-00004580: 7869 7420 3120 7c7c 2074 7275 6527 2c0a  xit 1 || true',.
-00004590: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-000045a0: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
-000045b0: 6e61 6d65 7d20 7465 7374 732f 7465 7374  name} tests/test
-000045c0: 5f79 616d 6c73 2f6d 696e 696d 616c 2e79  _yamls/minimal.y
-000045d0: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-000045e0: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
-000045f0: 6d65 7d20 3220 2d2d 7374 6174 7573 272c  me} 2 --status',
-00004600: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00004610: 6b79 206c 6f67 7320 7b6e 616d 657d 202d  ky logs {name} -
-00004620: 2d73 7461 7475 7320 7c20 6772 6570 2022  -status | grep "
-00004630: 4a6f 6220 323a 2053 5543 4345 4544 4544  Job 2: SUCCEEDED
-00004640: 2227 2c20 2023 2045 7175 6976 616c 656e  "',  # Equivalen
-00004650: 742e 0a20 2020 2020 2020 2020 2020 2066  t..            f
-00004660: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
-00004670: 205c 2765 6368 6f20 2453 4b59 5049 4c4f   \'echo $SKYPILO
-00004680: 545f 434c 5553 5445 525f 494e 464f 207c  T_CLUSTER_INFO |
-00004690: 206a 7120 2e63 6c6f 7564 207c 2067 7265   jq .cloud | gre
-000046a0: 7020 2d69 2061 7a75 7265 5c27 272c 0a20  p -i azure\'',. 
-000046b0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-000046c0: 206c 6f67 7320 7b6e 616d 657d 2033 202d   logs {name} 3 -
-000046d0: 2d73 7461 7475 7327 2c20 2023 2045 6e73  -status',  # Ens
-000046e0: 7572 6520 7468 6520 6a6f 6220 7375 6363  ure the job succ
-000046f0: 6565 6465 642e 0a20 2020 2020 2020 205d  eeded..        ]
-00004700: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
-00004710: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
-00004720: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
-00004730: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
-00004740: 4070 7974 6573 742e 6d61 726b 2e61 7773  @pytest.mark.aws
-00004750: 0a64 6566 2074 6573 745f 6177 735f 696d  .def test_aws_im
-00004760: 6167 655f 6964 5f64 6963 7428 293a 0a20  age_id_dict():. 
-00004770: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
-00004780: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
-00004790: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
-000047a0: 2020 2020 2020 2027 6177 735f 696d 6167         'aws_imag
-000047b0: 655f 6964 5f64 6963 7427 2c0a 2020 2020  e_id_dict',.    
-000047c0: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
-000047d0: 2020 2320 5573 6520 696d 6167 6520 6964    # Use image id
-000047e0: 2064 6963 742e 0a20 2020 2020 2020 2020   dict..         
-000047f0: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
-00004800: 2d79 202d 6320 7b6e 616d 657d 2065 7861  -y -c {name} exa
-00004810: 6d70 6c65 732f 7065 725f 7265 6769 6f6e  mples/per_region
-00004820: 5f69 6d61 6765 732e 7961 6d6c 272c 0a20  _images.yaml',. 
-00004830: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00004840: 2065 7865 6320 7b6e 616d 657d 2065 7861   exec {name} exa
-00004850: 6d70 6c65 732f 7065 725f 7265 6769 6f6e  mples/per_region
-00004860: 5f69 6d61 6765 732e 7961 6d6c 272c 0a20  _images.yaml',. 
-00004870: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00004880: 2065 7865 6320 7b6e 616d 657d 2022 6c73   exec {name} "ls
-00004890: 207e 2227 2c0a 2020 2020 2020 2020 2020   ~"',.          
-000048a0: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
-000048b0: 6d65 7d20 3120 2d2d 7374 6174 7573 272c  me} 1 --status',
-000048c0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-000048d0: 6b79 206c 6f67 7320 7b6e 616d 657d 2032  ky logs {name} 2
-000048e0: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
-000048f0: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
-00004900: 6773 207b 6e61 6d65 7d20 3320 2d2d 7374  gs {name} 3 --st
-00004910: 6174 7573 272c 0a20 2020 2020 2020 205d  atus',.        ]
-00004920: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
-00004930: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
-00004940: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
-00004950: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
-00004960: 4070 7974 6573 742e 6d61 726b 2e67 6370  @pytest.mark.gcp
-00004970: 0a64 6566 2074 6573 745f 6763 705f 696d  .def test_gcp_im
-00004980: 6167 655f 6964 5f64 6963 7428 293a 0a20  age_id_dict():. 
-00004990: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
-000049a0: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
-000049b0: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
-000049c0: 2020 2020 2020 2027 6763 705f 696d 6167         'gcp_imag
-000049d0: 655f 6964 5f64 6963 7427 2c0a 2020 2020  e_id_dict',.    
-000049e0: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
-000049f0: 2020 2320 5573 6520 696d 6167 6520 6964    # Use image id
-00004a00: 2064 6963 742e 0a20 2020 2020 2020 2020   dict..         
-00004a10: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
-00004a20: 2d79 202d 6320 7b6e 616d 657d 2074 6573  -y -c {name} tes
-00004a30: 7473 2f74 6573 745f 7961 6d6c 732f 6763  ts/test_yamls/gc
-00004a40: 705f 7065 725f 7265 6769 6f6e 5f69 6d61  p_per_region_ima
-00004a50: 6765 732e 7961 6d6c 272c 0a20 2020 2020  ges.yaml',.     
-00004a60: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
-00004a70: 6320 7b6e 616d 657d 2074 6573 7473 2f74  c {name} tests/t
-00004a80: 6573 745f 7961 6d6c 732f 6763 705f 7065  est_yamls/gcp_pe
-00004a90: 725f 7265 6769 6f6e 5f69 6d61 6765 732e  r_region_images.
-00004aa0: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
-00004ab0: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
-00004ac0: 616d 657d 2022 6c73 207e 2227 2c0a 2020  ame} "ls ~"',.  
-00004ad0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00004ae0: 6c6f 6773 207b 6e61 6d65 7d20 3120 2d2d  logs {name} 1 --
-00004af0: 7374 6174 7573 272c 0a20 2020 2020 2020  status',.       
-00004b00: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-00004b10: 7b6e 616d 657d 2032 202d 2d73 7461 7475  {name} 2 --statu
-00004b20: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
-00004b30: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
-00004b40: 7d20 3320 2d2d 7374 6174 7573 272c 0a20  } 3 --status',. 
-00004b50: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-00004b60: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
-00004b70: 7b6e 616d 657d 272c 0a20 2020 2029 0a20  {name}',.    ). 
-00004b80: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-00004b90: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
-00004ba0: 6d61 726b 2e61 7773 0a64 6566 2074 6573  mark.aws.def tes
-00004bb0: 745f 6177 735f 696d 6167 655f 6964 5f64  t_aws_image_id_d
-00004bc0: 6963 745f 7265 6769 6f6e 2829 3a0a 2020  ict_region():.  
-00004bd0: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
-00004be0: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
-00004bf0: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
-00004c00: 2020 2020 2020 2761 7773 5f69 6d61 6765        'aws_image
-00004c10: 5f69 645f 6469 6374 5f72 6567 696f 6e27  _id_dict_region'
-00004c20: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
-00004c30: 2020 2020 2020 2020 2320 5941 4d4c 2068          # YAML h
-00004c40: 6173 0a20 2020 2020 2020 2020 2020 2023  as.            #
-00004c50: 2020 2069 6d61 6765 5f69 643a 0a20 2020     image_id:.   
-00004c60: 2020 2020 2020 2020 2023 2020 2020 2020           #      
-00004c70: 2075 732d 7765 7374 2d32 3a20 736b 7970   us-west-2: skyp
-00004c80: 696c 6f74 3a67 7075 2d75 6275 6e74 752d  ilot:gpu-ubuntu-
-00004c90: 3138 3034 0a20 2020 2020 2020 2020 2020  1804.           
-00004ca0: 2023 2020 2020 2020 2075 732d 6561 7374   #       us-east
-00004cb0: 2d32 3a20 736b 7970 696c 6f74 3a67 7075  -2: skypilot:gpu
-00004cc0: 2d75 6275 6e74 752d 3230 3034 0a20 2020  -ubuntu-2004.   
-00004cd0: 2020 2020 2020 2020 2023 2055 7365 2072           # Use r
-00004ce0: 6567 696f 6e20 746f 2066 696c 7465 7220  egion to filter 
-00004cf0: 696d 6167 655f 6964 2064 6963 742e 0a20  image_id dict.. 
-00004d00: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00004d10: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
-00004d20: 616d 657d 202d 2d72 6567 696f 6e20 7573  ame} --region us
-00004d30: 2d65 6173 742d 3120 6578 616d 706c 6573  -east-1 examples
-00004d40: 2f70 6572 5f72 6567 696f 6e5f 696d 6167  /per_region_imag
-00004d50: 6573 2e79 616d 6c20 2626 2065 7869 7420  es.yaml && exit 
-00004d60: 3120 7c7c 2074 7275 6527 2c0a 2020 2020  1 || true',.    
-00004d70: 2020 2020 2020 2020 6627 736b 7920 7374          f'sky st
-00004d80: 6174 7573 207c 2067 7265 7020 7b6e 616d  atus | grep {nam
-00004d90: 657d 2026 2620 6578 6974 2031 207c 7c20  e} && exit 1 || 
-00004da0: 7472 7565 272c 2020 2320 456e 7375 7265  true',  # Ensure
-00004db0: 2074 6865 2063 6c75 7374 6572 2069 7320   the cluster is 
-00004dc0: 6e6f 7420 6372 6561 7465 642e 0a20 2020  not created..   
-00004dd0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00004de0: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
-00004df0: 657d 202d 2d72 6567 696f 6e20 7573 2d65  e} --region us-e
-00004e00: 6173 742d 3220 6578 616d 706c 6573 2f70  ast-2 examples/p
-00004e10: 6572 5f72 6567 696f 6e5f 696d 6167 6573  er_region_images
-00004e20: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
-00004e30: 2020 2020 2320 5368 6f75 6c64 2073 7563      # Should suc
-00004e40: 6365 7373 2062 6563 6175 7365 2074 6865  cess because the
-00004e50: 2069 6d61 6765 2069 6420 6d61 7463 6820   image id match 
-00004e60: 666f 7220 7468 6520 7265 6769 6f6e 2e0a  for the region..
-00004e70: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00004e80: 7920 6c61 756e 6368 202d 6320 7b6e 616d  y launch -c {nam
-00004e90: 657d 202d 2d69 6d61 6765 2d69 6420 736b  e} --image-id sk
-00004ea0: 7970 696c 6f74 3a67 7075 2d75 6275 6e74  ypilot:gpu-ubunt
-00004eb0: 752d 3230 3034 2065 7861 6d70 6c65 732f  u-2004 examples/
-00004ec0: 6d69 6e69 6d61 6c2e 7961 6d6c 272c 0a20  minimal.yaml',. 
-00004ed0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00004ee0: 2065 7865 6320 7b6e 616d 657d 202d 2d69   exec {name} --i
-00004ef0: 6d61 6765 2d69 6420 736b 7970 696c 6f74  mage-id skypilot
-00004f00: 3a67 7075 2d75 6275 6e74 752d 3230 3034  :gpu-ubuntu-2004
-00004f10: 2065 7861 6d70 6c65 732f 6d69 6e69 6d61   examples/minima
-00004f20: 6c2e 7961 6d6c 272c 0a20 2020 2020 2020  l.yaml',.       
-00004f30: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
-00004f40: 7b6e 616d 657d 202d 2d69 6d61 6765 2d69  {name} --image-i
-00004f50: 6420 736b 7970 696c 6f74 3a67 7075 2d75  d skypilot:gpu-u
-00004f60: 6275 6e74 752d 3138 3034 2065 7861 6d70  buntu-1804 examp
-00004f70: 6c65 732f 6d69 6e69 6d61 6c2e 7961 6d6c  les/minimal.yaml
-00004f80: 2026 2620 6578 6974 2031 207c 7c20 7472   && exit 1 || tr
-00004f90: 7565 272c 0a20 2020 2020 2020 2020 2020  ue',.           
-00004fa0: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
-00004fb0: 657d 2031 202d 2d73 7461 7475 7327 2c0a  e} 1 --status',.
-00004fc0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00004fd0: 7920 6c6f 6773 207b 6e61 6d65 7d20 3220  y logs {name} 2 
-00004fe0: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
-00004ff0: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-00005000: 7320 7b6e 616d 657d 2033 202d 2d73 7461  s {name} 3 --sta
-00005010: 7475 7327 2c0a 2020 2020 2020 2020 2020  tus',.          
-00005020: 2020 6627 736b 7920 7374 6174 7573 202d    f'sky status -
-00005030: 2d61 6c6c 207c 2067 7265 7020 7b6e 616d  -all | grep {nam
-00005040: 657d 207c 2067 7265 7020 7573 2d65 6173  e} | grep us-eas
-00005050: 742d 3227 2c20 2023 2045 6e73 7572 6520  t-2',  # Ensure 
-00005060: 7468 6520 7265 6769 6f6e 2069 7320 636f  the region is co
-00005070: 7272 6563 742e 0a20 2020 2020 2020 2020  rrect..         
-00005080: 2020 2023 2045 6e73 7572 6520 6578 6563     # Ensure exec
-00005090: 2077 6f72 6b73 2e0a 2020 2020 2020 2020   works..        
-000050a0: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
-000050b0: 6e61 6d65 7d20 2d2d 7265 6769 6f6e 2075  name} --region u
-000050c0: 732d 6561 7374 2d32 2065 7861 6d70 6c65  s-east-2 example
-000050d0: 732f 7065 725f 7265 6769 6f6e 5f69 6d61  s/per_region_ima
-000050e0: 6765 732e 7961 6d6c 272c 0a20 2020 2020  ges.yaml',.     
-000050f0: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
-00005100: 6320 7b6e 616d 657d 2065 7861 6d70 6c65  c {name} example
-00005110: 732f 7065 725f 7265 6769 6f6e 5f69 6d61  s/per_region_ima
-00005120: 6765 732e 7961 6d6c 272c 0a20 2020 2020  ges.yaml',.     
-00005130: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
-00005140: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
-00005150: 2061 7773 202d 2d72 6567 696f 6e20 7573   aws --region us
-00005160: 2d65 6173 742d 3220 226c 7320 7e22 272c  -east-2 "ls ~"',
-00005170: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00005180: 6b79 2065 7865 6320 7b6e 616d 657d 2022  ky exec {name} "
-00005190: 6c73 207e 2227 2c0a 2020 2020 2020 2020  ls ~"',.        
-000051a0: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
-000051b0: 6e61 6d65 7d20 3420 2d2d 7374 6174 7573  name} 4 --status
-000051c0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-000051d0: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-000051e0: 2035 202d 2d73 7461 7475 7327 2c0a 2020   5 --status',.  
-000051f0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00005200: 6c6f 6773 207b 6e61 6d65 7d20 3620 2d2d  logs {name} 6 --
-00005210: 7374 6174 7573 272c 0a20 2020 2020 2020  status',.       
-00005220: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-00005230: 7b6e 616d 657d 2037 202d 2d73 7461 7475  {name} 7 --statu
-00005240: 7327 2c0a 2020 2020 2020 2020 5d2c 0a20  s',.        ],. 
-00005250: 2020 2020 2020 2066 2773 6b79 2064 6f77         f'sky dow
-00005260: 6e20 2d79 207b 6e61 6d65 7d27 2c0a 2020  n -y {name}',.  
-00005270: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
-00005280: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
-00005290: 7465 7374 2e6d 6172 6b2e 6763 700a 6465  test.mark.gcp.de
-000052a0: 6620 7465 7374 5f67 6370 5f69 6d61 6765  f test_gcp_image
-000052b0: 5f69 645f 6469 6374 5f72 6567 696f 6e28  _id_dict_region(
-000052c0: 293a 0a20 2020 206e 616d 6520 3d20 5f67  ):.    name = _g
-000052d0: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
-000052e0: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
-000052f0: 7428 0a20 2020 2020 2020 2027 6763 705f  t(.        'gcp_
-00005300: 696d 6167 655f 6964 5f64 6963 745f 7265  image_id_dict_re
-00005310: 6769 6f6e 272c 0a20 2020 2020 2020 205b  gion',.        [
-00005320: 0a20 2020 2020 2020 2020 2020 2023 2055  .            # U
-00005330: 7365 2072 6567 696f 6e20 746f 2066 696c  se region to fil
-00005340: 7465 7220 696d 6167 655f 6964 2064 6963  ter image_id dic
-00005350: 742e 0a20 2020 2020 2020 2020 2020 2066  t..            f
-00005360: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
-00005370: 6320 7b6e 616d 657d 202d 2d72 6567 696f  c {name} --regio
-00005380: 6e20 7573 2d65 6173 7431 2074 6573 7473  n us-east1 tests
-00005390: 2f74 6573 745f 7961 6d6c 732f 6763 705f  /test_yamls/gcp_
-000053a0: 7065 725f 7265 6769 6f6e 5f69 6d61 6765  per_region_image
-000053b0: 732e 7961 6d6c 2026 2620 6578 6974 2031  s.yaml && exit 1
-000053c0: 207c 7c20 7472 7565 272c 0a20 2020 2020   || true',.     
-000053d0: 2020 2020 2020 2066 2773 6b79 2073 7461         f'sky sta
-000053e0: 7475 7320 7c20 6772 6570 207b 6e61 6d65  tus | grep {name
-000053f0: 7d20 2626 2065 7869 7420 3120 7c7c 2074  } && exit 1 || t
-00005400: 7275 6527 2c20 2023 2045 6e73 7572 6520  rue',  # Ensure 
-00005410: 7468 6520 636c 7573 7465 7220 6973 206e  the cluster is n
-00005420: 6f74 2063 7265 6174 6564 2e0a 2020 2020  ot created..    
-00005430: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
-00005440: 756e 6368 202d 7920 2d63 207b 6e61 6d65  unch -y -c {name
-00005450: 7d20 2d2d 7265 6769 6f6e 2075 732d 7765  } --region us-we
-00005460: 7374 3320 7465 7374 732f 7465 7374 5f79  st3 tests/test_y
-00005470: 616d 6c73 2f67 6370 5f70 6572 5f72 6567  amls/gcp_per_reg
-00005480: 696f 6e5f 696d 6167 6573 2e79 616d 6c27  ion_images.yaml'
-00005490: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-000054a0: 5368 6f75 6c64 2073 7563 6365 7373 2062  Should success b
-000054b0: 6563 6175 7365 2074 6865 2069 6d61 6765  ecause the image
-000054c0: 2069 6420 6d61 7463 6820 666f 7220 7468   id match for th
-000054d0: 6520 7265 6769 6f6e 2e0a 2020 2020 2020  e region..      
-000054e0: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
-000054f0: 6368 202d 6320 7b6e 616d 657d 202d 2d63  ch -c {name} --c
-00005500: 6c6f 7564 2067 6370 202d 2d69 6d61 6765  loud gcp --image
-00005510: 2d69 6420 7072 6f6a 6563 7473 2f75 6275  -id projects/ubu
-00005520: 6e74 752d 6f73 2d63 6c6f 7564 2f67 6c6f  ntu-os-cloud/glo
-00005530: 6261 6c2f 696d 6167 6573 2f75 6275 6e74  bal/images/ubunt
-00005540: 752d 3138 3034 2d62 696f 6e69 632d 7632  u-1804-bionic-v2
-00005550: 3032 3330 3131 3220 7465 7374 732f 7465  0230112 tests/te
-00005560: 7374 5f79 616d 6c73 2f6d 696e 696d 616c  st_yamls/minimal
-00005570: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
-00005580: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
-00005590: 6e61 6d65 7d20 2d2d 636c 6f75 6420 6763  name} --cloud gc
-000055a0: 7020 2d2d 696d 6167 652d 6964 2070 726f  p --image-id pro
-000055b0: 6a65 6374 732f 7562 756e 7475 2d6f 732d  jects/ubuntu-os-
-000055c0: 636c 6f75 642f 676c 6f62 616c 2f69 6d61  cloud/global/ima
-000055d0: 6765 732f 7562 756e 7475 2d31 3830 342d  ges/ubuntu-1804-
-000055e0: 6269 6f6e 6963 2d76 3230 3233 3031 3132  bionic-v20230112
-000055f0: 2074 6573 7473 2f74 6573 745f 7961 6d6c   tests/test_yaml
-00005600: 732f 6d69 6e69 6d61 6c2e 7961 6d6c 272c  s/minimal.yaml',
-00005610: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00005620: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
-00005630: 2d63 6c6f 7564 2067 6370 202d 2d69 6d61  -cloud gcp --ima
-00005640: 6765 2d69 6420 736b 7970 696c 6f74 3a63  ge-id skypilot:c
-00005650: 7075 2d64 6562 6961 6e2d 3130 2074 6573  pu-debian-10 tes
-00005660: 7473 2f74 6573 745f 7961 6d6c 732f 6d69  ts/test_yamls/mi
-00005670: 6e69 6d61 6c2e 7961 6d6c 2026 2620 6578  nimal.yaml && ex
-00005680: 6974 2031 207c 7c20 7472 7565 272c 0a20  it 1 || true',. 
-00005690: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-000056a0: 206c 6f67 7320 7b6e 616d 657d 2031 202d   logs {name} 1 -
-000056b0: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
-000056c0: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
-000056d0: 207b 6e61 6d65 7d20 3220 2d2d 7374 6174   {name} 2 --stat
-000056e0: 7573 272c 0a20 2020 2020 2020 2020 2020  us',.           
-000056f0: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
-00005700: 657d 2033 202d 2d73 7461 7475 7327 2c0a  e} 3 --status',.
-00005710: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00005720: 7920 7374 6174 7573 202d 2d61 6c6c 207c  y status --all |
-00005730: 2067 7265 7020 7b6e 616d 657d 207c 2067   grep {name} | g
-00005740: 7265 7020 7573 2d77 6573 7433 272c 2020  rep us-west3',  
-00005750: 2320 456e 7375 7265 2074 6865 2072 6567  # Ensure the reg
-00005760: 696f 6e20 6973 2063 6f72 7265 6374 2e0a  ion is correct..
-00005770: 2020 2020 2020 2020 2020 2020 2320 456e              # En
-00005780: 7375 7265 2065 7865 6320 776f 726b 732e  sure exec works.
-00005790: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-000057a0: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
-000057b0: 2d72 6567 696f 6e20 7573 2d77 6573 7433  -region us-west3
-000057c0: 2074 6573 7473 2f74 6573 745f 7961 6d6c   tests/test_yaml
-000057d0: 732f 6763 705f 7065 725f 7265 6769 6f6e  s/gcp_per_region
-000057e0: 5f69 6d61 6765 732e 7961 6d6c 272c 0a20  _images.yaml',. 
-000057f0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00005800: 2065 7865 6320 7b6e 616d 657d 2074 6573   exec {name} tes
-00005810: 7473 2f74 6573 745f 7961 6d6c 732f 6763  ts/test_yamls/gc
-00005820: 705f 7065 725f 7265 6769 6f6e 5f69 6d61  p_per_region_ima
-00005830: 6765 732e 7961 6d6c 272c 0a20 2020 2020  ges.yaml',.     
-00005840: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
-00005850: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
-00005860: 2067 6370 202d 2d72 6567 696f 6e20 7573   gcp --region us
-00005870: 2d77 6573 7433 2022 6c73 207e 2227 2c0a  -west3 "ls ~"',.
-00005880: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00005890: 7920 6578 6563 207b 6e61 6d65 7d20 226c  y exec {name} "l
-000058a0: 7320 7e22 272c 0a20 2020 2020 2020 2020  s ~"',.         
-000058b0: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
-000058c0: 616d 657d 2034 202d 2d73 7461 7475 7327  ame} 4 --status'
-000058d0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-000058e0: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-000058f0: 3520 2d2d 7374 6174 7573 272c 0a20 2020  5 --status',.   
-00005900: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00005910: 6f67 7320 7b6e 616d 657d 2036 202d 2d73  ogs {name} 6 --s
-00005920: 7461 7475 7327 2c0a 2020 2020 2020 2020  tatus',.        
-00005930: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
-00005940: 6e61 6d65 7d20 3720 2d2d 7374 6174 7573  name} 7 --status
-00005950: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
-00005960: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
-00005970: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
-00005980: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
-00005990: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
-000059a0: 6573 742e 6d61 726b 2e61 7773 0a64 6566  est.mark.aws.def
-000059b0: 2074 6573 745f 6177 735f 696d 6167 655f   test_aws_image_
-000059c0: 6964 5f64 6963 745f 7a6f 6e65 2829 3a0a  id_dict_zone():.
-000059d0: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
-000059e0: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
-000059f0: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
-00005a00: 2020 2020 2020 2020 2761 7773 5f69 6d61          'aws_ima
-00005a10: 6765 5f69 645f 6469 6374 5f7a 6f6e 6527  ge_id_dict_zone'
-00005a20: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
-00005a30: 2020 2020 2020 2020 2320 5941 4d4c 2068          # YAML h
-00005a40: 6173 0a20 2020 2020 2020 2020 2020 2023  as.            #
-00005a50: 2020 2069 6d61 6765 5f69 643a 0a20 2020     image_id:.   
-00005a60: 2020 2020 2020 2020 2023 2020 2020 2020           #      
-00005a70: 2075 732d 7765 7374 2d32 3a20 736b 7970   us-west-2: skyp
-00005a80: 696c 6f74 3a67 7075 2d75 6275 6e74 752d  ilot:gpu-ubuntu-
-00005a90: 3138 3034 0a20 2020 2020 2020 2020 2020  1804.           
-00005aa0: 2023 2020 2020 2020 2075 732d 6561 7374   #       us-east
-00005ab0: 2d32 3a20 736b 7970 696c 6f74 3a67 7075  -2: skypilot:gpu
-00005ac0: 2d75 6275 6e74 752d 3230 3034 0a20 2020  -ubuntu-2004.   
-00005ad0: 2020 2020 2020 2020 2023 2055 7365 207a           # Use z
-00005ae0: 6f6e 6520 746f 2066 696c 7465 7220 696d  one to filter im
-00005af0: 6167 655f 6964 2064 6963 742e 0a20 2020  age_id dict..   
-00005b00: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00005b10: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
-00005b20: 657d 202d 2d7a 6f6e 6520 7573 2d65 6173  e} --zone us-eas
-00005b30: 742d 3162 2065 7861 6d70 6c65 732f 7065  t-1b examples/pe
-00005b40: 725f 7265 6769 6f6e 5f69 6d61 6765 732e  r_region_images.
-00005b50: 7961 6d6c 2026 2620 6578 6974 2031 207c  yaml && exit 1 |
-00005b60: 7c20 7472 7565 272c 0a20 2020 2020 2020  | true',.       
-00005b70: 2020 2020 2066 2773 6b79 2073 7461 7475       f'sky statu
-00005b80: 7320 7c20 6772 6570 207b 6e61 6d65 7d20  s | grep {name} 
-00005b90: 2626 2065 7869 7420 3120 7c7c 2074 7275  && exit 1 || tru
-00005ba0: 6527 2c20 2023 2045 6e73 7572 6520 7468  e',  # Ensure th
-00005bb0: 6520 636c 7573 7465 7220 6973 206e 6f74  e cluster is not
-00005bc0: 2063 7265 6174 6564 2e0a 2020 2020 2020   created..      
-00005bd0: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
-00005be0: 6368 202d 7920 2d63 207b 6e61 6d65 7d20  ch -y -c {name} 
-00005bf0: 2d2d 7a6f 6e65 2075 732d 6561 7374 2d32  --zone us-east-2
-00005c00: 6120 6578 616d 706c 6573 2f70 6572 5f72  a examples/per_r
-00005c10: 6567 696f 6e5f 696d 6167 6573 2e79 616d  egion_images.yam
-00005c20: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
-00005c30: 2320 5368 6f75 6c64 2073 7563 6365 7373  # Should success
-00005c40: 2062 6563 6175 7365 2074 6865 2069 6d61   because the ima
-00005c50: 6765 2069 6420 6d61 7463 6820 666f 7220  ge id match for 
-00005c60: 7468 6520 7a6f 6e65 2e0a 2020 2020 2020  the zone..      
-00005c70: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
-00005c80: 6368 202d 7920 2d63 207b 6e61 6d65 7d20  ch -y -c {name} 
-00005c90: 2d2d 696d 6167 652d 6964 2073 6b79 7069  --image-id skypi
-00005ca0: 6c6f 743a 6770 752d 7562 756e 7475 2d32  lot:gpu-ubuntu-2
-00005cb0: 3030 3420 6578 616d 706c 6573 2f6d 696e  004 examples/min
-00005cc0: 696d 616c 2e79 616d 6c27 2c0a 2020 2020  imal.yaml',.    
-00005cd0: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
-00005ce0: 6563 207b 6e61 6d65 7d20 2d2d 696d 6167  ec {name} --imag
-00005cf0: 652d 6964 2073 6b79 7069 6c6f 743a 6770  e-id skypilot:gp
-00005d00: 752d 7562 756e 7475 2d32 3030 3420 6578  u-ubuntu-2004 ex
-00005d10: 616d 706c 6573 2f6d 696e 696d 616c 2e79  amples/minimal.y
-00005d20: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-00005d30: 2020 2320 4661 696c 2064 7565 2074 6f20    # Fail due to 
-00005d40: 696d 6167 6520 6964 206d 6973 6d61 7463  image id mismatc
-00005d50: 682e 0a20 2020 2020 2020 2020 2020 2066  h..            f
-00005d60: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
-00005d70: 202d 2d69 6d61 6765 2d69 6420 736b 7970   --image-id skyp
-00005d80: 696c 6f74 3a67 7075 2d75 6275 6e74 752d  ilot:gpu-ubuntu-
-00005d90: 3138 3034 2065 7861 6d70 6c65 732f 6d69  1804 examples/mi
-00005da0: 6e69 6d61 6c2e 7961 6d6c 2026 2620 6578  nimal.yaml && ex
-00005db0: 6974 2031 207c 7c20 7472 7565 272c 0a20  it 1 || true',. 
-00005dc0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00005dd0: 206c 6f67 7320 7b6e 616d 657d 2031 202d   logs {name} 1 -
-00005de0: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
-00005df0: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
-00005e00: 207b 6e61 6d65 7d20 3220 2d2d 7374 6174   {name} 2 --stat
-00005e10: 7573 272c 0a20 2020 2020 2020 2020 2020  us',.           
-00005e20: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
-00005e30: 657d 2033 202d 2d73 7461 7475 7327 2c0a  e} 3 --status',.
-00005e40: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00005e50: 7920 7374 6174 7573 202d 2d61 6c6c 207c  y status --all |
-00005e60: 2067 7265 7020 7b6e 616d 657d 207c 2067   grep {name} | g
-00005e70: 7265 7020 7573 2d65 6173 742d 3261 272c  rep us-east-2a',
-00005e80: 2020 2320 456e 7375 7265 2074 6865 207a    # Ensure the z
-00005e90: 6f6e 6520 6973 2063 6f72 7265 6374 2e0a  one is correct..
-00005ea0: 2020 2020 2020 2020 2020 2020 2320 456e              # En
-00005eb0: 7375 7265 2065 7865 6320 776f 726b 732e  sure exec works.
-00005ec0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00005ed0: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
-00005ee0: 2d7a 6f6e 6520 7573 2d65 6173 742d 3261  -zone us-east-2a
-00005ef0: 2065 7861 6d70 6c65 732f 7065 725f 7265   examples/per_re
-00005f00: 6769 6f6e 5f69 6d61 6765 732e 7961 6d6c  gion_images.yaml
-00005f10: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00005f20: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
-00005f30: 2065 7861 6d70 6c65 732f 7065 725f 7265   examples/per_re
-00005f40: 6769 6f6e 5f69 6d61 6765 732e 7961 6d6c  gion_images.yaml
-00005f50: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00005f60: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
-00005f70: 202d 2d63 6c6f 7564 2061 7773 202d 2d72   --cloud aws --r
-00005f80: 6567 696f 6e20 7573 2d65 6173 742d 3220  egion us-east-2 
-00005f90: 226c 7320 7e22 272c 0a20 2020 2020 2020  "ls ~"',.       
-00005fa0: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
-00005fb0: 7b6e 616d 657d 2022 6c73 207e 2227 2c0a  {name} "ls ~"',.
-00005fc0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00005fd0: 7920 6c6f 6773 207b 6e61 6d65 7d20 3420  y logs {name} 4 
-00005fe0: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
-00005ff0: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-00006000: 7320 7b6e 616d 657d 2035 202d 2d73 7461  s {name} 5 --sta
-00006010: 7475 7327 2c0a 2020 2020 2020 2020 2020  tus',.          
-00006020: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
-00006030: 6d65 7d20 3620 2d2d 7374 6174 7573 272c  me} 6 --status',
-00006040: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00006050: 6b79 206c 6f67 7320 7b6e 616d 657d 2037  ky logs {name} 7
-00006060: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
-00006070: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
-00006080: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
-00006090: 6d65 7d27 2c0a 2020 2020 290a 2020 2020  me}',.    ).    
-000060a0: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-000060b0: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
-000060c0: 6b2e 6763 700a 6465 6620 7465 7374 5f67  k.gcp.def test_g
-000060d0: 6370 5f69 6d61 6765 5f69 645f 6469 6374  cp_image_id_dict
-000060e0: 5f7a 6f6e 6528 293a 0a20 2020 206e 616d  _zone():.    nam
-000060f0: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
-00006100: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
-00006110: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-00006120: 2027 6763 705f 696d 6167 655f 6964 5f64   'gcp_image_id_d
-00006130: 6963 745f 7a6f 6e65 272c 0a20 2020 2020  ict_zone',.     
-00006140: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
-00006150: 2023 2055 7365 207a 6f6e 6520 746f 2066   # Use zone to f
-00006160: 696c 7465 7220 696d 6167 655f 6964 2064  ilter image_id d
-00006170: 6963 742e 0a20 2020 2020 2020 2020 2020  ict..           
-00006180: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
-00006190: 202d 6320 7b6e 616d 657d 202d 2d7a 6f6e   -c {name} --zon
-000061a0: 6520 7573 2d65 6173 7431 2d61 2074 6573  e us-east1-a tes
-000061b0: 7473 2f74 6573 745f 7961 6d6c 732f 6763  ts/test_yamls/gc
-000061c0: 705f 7065 725f 7265 6769 6f6e 5f69 6d61  p_per_region_ima
-000061d0: 6765 732e 7961 6d6c 2026 2620 6578 6974  ges.yaml && exit
-000061e0: 2031 207c 7c20 7472 7565 272c 0a20 2020   1 || true',.   
-000061f0: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
-00006200: 7461 7475 7320 7c20 6772 6570 207b 6e61  tatus | grep {na
-00006210: 6d65 7d20 2626 2065 7869 7420 3120 7c7c  me} && exit 1 ||
-00006220: 2074 7275 6527 2c20 2023 2045 6e73 7572   true',  # Ensur
-00006230: 6520 7468 6520 636c 7573 7465 7220 6973  e the cluster is
-00006240: 206e 6f74 2063 7265 6174 6564 2e0a 2020   not created..  
-00006250: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00006260: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
-00006270: 6d65 7d20 2d2d 7a6f 6e65 2075 732d 6365  me} --zone us-ce
-00006280: 6e74 7261 6c31 2d61 2074 6573 7473 2f74  ntral1-a tests/t
-00006290: 6573 745f 7961 6d6c 732f 6763 705f 7065  est_yamls/gcp_pe
-000062a0: 725f 7265 6769 6f6e 5f69 6d61 6765 732e  r_region_images.
-000062b0: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
-000062c0: 2020 2023 2053 686f 756c 6420 7375 6363     # Should succ
-000062d0: 6573 7320 6265 6361 7573 6520 7468 6520  ess because the 
-000062e0: 696d 6167 6520 6964 206d 6174 6368 2066  image id match f
-000062f0: 6f72 2074 6865 207a 6f6e 652e 0a20 2020  or the zone..   
-00006300: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00006310: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
-00006320: 657d 202d 2d63 6c6f 7564 2067 6370 202d  e} --cloud gcp -
-00006330: 2d69 6d61 6765 2d69 6420 736b 7970 696c  -image-id skypil
-00006340: 6f74 3a63 7075 2d64 6562 6961 6e2d 3130  ot:cpu-debian-10
-00006350: 2074 6573 7473 2f74 6573 745f 7961 6d6c   tests/test_yaml
-00006360: 732f 6d69 6e69 6d61 6c2e 7961 6d6c 272c  s/minimal.yaml',
-00006370: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00006380: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
-00006390: 2d63 6c6f 7564 2067 6370 202d 2d69 6d61  -cloud gcp --ima
-000063a0: 6765 2d69 6420 736b 7970 696c 6f74 3a63  ge-id skypilot:c
-000063b0: 7075 2d64 6562 6961 6e2d 3130 2074 6573  pu-debian-10 tes
-000063c0: 7473 2f74 6573 745f 7961 6d6c 732f 6d69  ts/test_yamls/mi
-000063d0: 6e69 6d61 6c2e 7961 6d6c 272c 0a20 2020  nimal.yaml',.   
-000063e0: 2020 2020 2020 2020 2023 2046 6169 6c20           # Fail 
-000063f0: 6475 6520 746f 2069 6d61 6765 2069 6420  due to image id 
-00006400: 6d69 736d 6174 6368 2e0a 2020 2020 2020  mismatch..      
-00006410: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
-00006420: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
-00006430: 6763 7020 2d2d 696d 6167 652d 6964 2073  gcp --image-id s
-00006440: 6b79 7069 6c6f 743a 6770 752d 6465 6269  kypilot:gpu-debi
-00006450: 616e 2d31 3020 7465 7374 732f 7465 7374  an-10 tests/test
-00006460: 5f79 616d 6c73 2f6d 696e 696d 616c 2e79  _yamls/minimal.y
-00006470: 616d 6c20 2626 2065 7869 7420 3120 7c7c  aml && exit 1 ||
-00006480: 2074 7275 6527 2c0a 2020 2020 2020 2020   true',.        
-00006490: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
-000064a0: 6e61 6d65 7d20 3120 2d2d 7374 6174 7573  name} 1 --status
-000064b0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-000064c0: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-000064d0: 2032 202d 2d73 7461 7475 7327 2c0a 2020   2 --status',.  
-000064e0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-000064f0: 6c6f 6773 207b 6e61 6d65 7d20 3320 2d2d  logs {name} 3 --
-00006500: 7374 6174 7573 272c 0a20 2020 2020 2020  status',.       
-00006510: 2020 2020 2066 2773 6b79 2073 7461 7475       f'sky statu
-00006520: 7320 2d2d 616c 6c20 7c20 6772 6570 207b  s --all | grep {
-00006530: 6e61 6d65 7d20 7c20 6772 6570 2075 732d  name} | grep us-
-00006540: 6365 6e74 7261 6c31 272c 2020 2320 456e  central1',  # En
-00006550: 7375 7265 2074 6865 207a 6f6e 6520 6973  sure the zone is
-00006560: 2063 6f72 7265 6374 2e0a 2020 2020 2020   correct..      
-00006570: 2020 2020 2020 2320 456e 7375 7265 2065        # Ensure e
-00006580: 7865 6320 776f 726b 732e 0a20 2020 2020  xec works..     
-00006590: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
-000065a0: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
-000065b0: 2067 6370 202d 2d7a 6f6e 6520 7573 2d63   gcp --zone us-c
-000065c0: 656e 7472 616c 312d 6120 7465 7374 732f  entral1-a tests/
-000065d0: 7465 7374 5f79 616d 6c73 2f67 6370 5f70  test_yamls/gcp_p
-000065e0: 6572 5f72 6567 696f 6e5f 696d 6167 6573  er_region_images
-000065f0: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
-00006600: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
-00006610: 6e61 6d65 7d20 7465 7374 732f 7465 7374  name} tests/test
-00006620: 5f79 616d 6c73 2f67 6370 5f70 6572 5f72  _yamls/gcp_per_r
-00006630: 6567 696f 6e5f 696d 6167 6573 2e79 616d  egion_images.yam
-00006640: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
-00006650: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
-00006660: 7d20 2d2d 636c 6f75 6420 6763 7020 2d2d  } --cloud gcp --
-00006670: 7265 6769 6f6e 2075 732d 6365 6e74 7261  region us-centra
-00006680: 6c31 2022 6c73 207e 2227 2c0a 2020 2020  l1 "ls ~"',.    
-00006690: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
-000066a0: 6563 207b 6e61 6d65 7d20 226c 7320 7e22  ec {name} "ls ~"
-000066b0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-000066c0: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-000066d0: 2034 202d 2d73 7461 7475 7327 2c0a 2020   4 --status',.  
-000066e0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-000066f0: 6c6f 6773 207b 6e61 6d65 7d20 3520 2d2d  logs {name} 5 --
-00006700: 7374 6174 7573 272c 0a20 2020 2020 2020  status',.       
-00006710: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-00006720: 7b6e 616d 657d 2036 202d 2d73 7461 7475  {name} 6 --statu
-00006730: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
-00006740: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
-00006750: 7d20 3720 2d2d 7374 6174 7573 272c 0a20  } 7 --status',. 
-00006760: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-00006770: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
-00006780: 7b6e 616d 657d 272c 0a20 2020 2029 0a20  {name}',.    ). 
-00006790: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-000067a0: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
-000067b0: 6d61 726b 2e61 7773 0a64 6566 2074 6573  mark.aws.def tes
-000067c0: 745f 636c 6f6e 655f 6469 736b 5f61 7773  t_clone_disk_aws
-000067d0: 2829 3a0a 2020 2020 6e61 6d65 203d 205f  ():.    name = _
-000067e0: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
-000067f0: 2829 0a20 2020 2074 6573 7420 3d20 5465  ().    test = Te
-00006800: 7374 280a 2020 2020 2020 2020 2763 6c6f  st(.        'clo
-00006810: 6e65 5f64 6973 6b5f 6177 7327 2c0a 2020  ne_disk_aws',.  
-00006820: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
-00006830: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
-00006840: 202d 7920 2d63 207b 6e61 6d65 7d20 2d2d   -y -c {name} --
-00006850: 636c 6f75 6420 6177 7320 2d2d 7265 6769  cloud aws --regi
-00006860: 6f6e 2075 732d 6561 7374 2d32 202d 2d72  on us-east-2 --r
-00006870: 6574 7279 2d75 6e74 696c 2d75 7020 2265  etry-until-up "e
-00006880: 6368 6f20 6865 6c6c 6f20 3e20 7e2f 7573  cho hello > ~/us
-00006890: 6572 5f66 696c 652e 7478 7422 272c 0a20  er_file.txt"',. 
-000068a0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-000068b0: 206c 6175 6e63 6820 2d2d 636c 6f6e 652d   launch --clone-
-000068c0: 6469 736b 2d66 726f 6d20 7b6e 616d 657d  disk-from {name}
-000068d0: 202d 7920 2d63 207b 6e61 6d65 7d2d 636c   -y -c {name}-cl
-000068e0: 6f6e 6520 2626 2065 7869 7420 3120 7c7c  one && exit 1 ||
-000068f0: 2074 7275 6527 2c0a 2020 2020 2020 2020   true',.        
-00006900: 2020 2020 6627 736b 7920 7374 6f70 207b      f'sky stop {
-00006910: 6e61 6d65 7d20 2d79 272c 0a20 2020 2020  name} -y',.     
-00006920: 2020 2020 2020 2027 736c 6565 7020 3630         'sleep 60
-00006930: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00006940: 2773 6b79 206c 6175 6e63 6820 2d2d 636c  'sky launch --cl
-00006950: 6f6e 652d 6469 736b 2d66 726f 6d20 7b6e  one-disk-from {n
-00006960: 616d 657d 202d 7920 2d63 207b 6e61 6d65  ame} -y -c {name
-00006970: 7d2d 636c 6f6e 6520 2d2d 636c 6f75 6420  }-clone --cloud 
-00006980: 6177 7320 2d64 202d 2d72 6567 696f 6e20  aws -d --region 
-00006990: 7573 2d65 6173 742d 3220 2263 6174 207e  us-east-2 "cat ~
-000069a0: 2f75 7365 725f 6669 6c65 2e74 7874 207c  /user_file.txt |
-000069b0: 2067 7265 7020 6865 6c6c 6f22 272c 0a20   grep hello"',. 
-000069c0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-000069d0: 206c 6175 6e63 6820 2d2d 636c 6f6e 652d   launch --clone-
-000069e0: 6469 736b 2d66 726f 6d20 7b6e 616d 657d  disk-from {name}
-000069f0: 202d 7920 2d63 207b 6e61 6d65 7d2d 636c   -y -c {name}-cl
-00006a00: 6f6e 652d 3220 2d2d 636c 6f75 6420 6177  one-2 --cloud aw
-00006a10: 7320 2d64 202d 2d72 6567 696f 6e20 7573  s -d --region us
-00006a20: 2d65 6173 742d 3220 2263 6174 207e 2f75  -east-2 "cat ~/u
-00006a30: 7365 725f 6669 6c65 2e74 7874 207c 2067  ser_file.txt | g
-00006a40: 7265 7020 6865 6c6c 6f22 272c 0a20 2020  rep hello"',.   
-00006a50: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00006a60: 6f67 7320 7b6e 616d 657d 2d63 6c6f 6e65  ogs {name}-clone
-00006a70: 2031 202d 2d73 7461 7475 7327 2c0a 2020   1 --status',.  
-00006a80: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00006a90: 6c6f 6773 207b 6e61 6d65 7d2d 636c 6f6e  logs {name}-clon
-00006aa0: 652d 3220 3120 2d2d 7374 6174 7573 272c  e-2 1 --status',
-00006ab0: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
-00006ac0: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
-00006ad0: 7920 7b6e 616d 657d 207b 6e61 6d65 7d2d  y {name} {name}-
-00006ae0: 636c 6f6e 6520 7b6e 616d 657d 2d63 6c6f  clone {name}-clo
-00006af0: 6e65 2d32 272c 0a20 2020 2020 2020 2074  ne-2',.        t
-00006b00: 696d 656f 7574 3d33 3020 2a20 3630 2c0a  imeout=30 * 60,.
-00006b10: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
-00006b20: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
-00006b30: 7079 7465 7374 2e6d 6172 6b2e 6763 700a  pytest.mark.gcp.
-00006b40: 6465 6620 7465 7374 5f63 6c6f 6e65 5f64  def test_clone_d
-00006b50: 6973 6b5f 6763 7028 293a 0a20 2020 206e  isk_gcp():.    n
-00006b60: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
-00006b70: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
-00006b80: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
-00006b90: 2020 2027 636c 6f6e 655f 6469 736b 5f67     'clone_disk_g
-00006ba0: 6370 272c 0a20 2020 2020 2020 205b 0a20  cp',.        [. 
-00006bb0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00006bc0: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
-00006bd0: 616d 657d 202d 2d63 6c6f 7564 2067 6370  ame} --cloud gcp
-00006be0: 202d 2d7a 6f6e 6520 7573 2d65 6173 7431   --zone us-east1
-00006bf0: 2d62 202d 2d72 6574 7279 2d75 6e74 696c  -b --retry-until
-00006c00: 2d75 7020 2265 6368 6f20 6865 6c6c 6f20  -up "echo hello 
-00006c10: 3e20 7e2f 7573 6572 5f66 696c 652e 7478  > ~/user_file.tx
-00006c20: 7422 272c 0a20 2020 2020 2020 2020 2020  t"',.           
-00006c30: 2066 2773 6b79 206c 6175 6e63 6820 2d2d   f'sky launch --
-00006c40: 636c 6f6e 652d 6469 736b 2d66 726f 6d20  clone-disk-from 
-00006c50: 7b6e 616d 657d 202d 7920 2d63 207b 6e61  {name} -y -c {na
-00006c60: 6d65 7d2d 636c 6f6e 6520 2626 2065 7869  me}-clone && exi
-00006c70: 7420 3120 7c7c 2074 7275 6527 2c0a 2020  t 1 || true',.  
-00006c80: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00006c90: 7374 6f70 207b 6e61 6d65 7d20 2d79 272c  stop {name} -y',
-00006ca0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00006cb0: 6b79 206c 6175 6e63 6820 2d2d 636c 6f6e  ky launch --clon
-00006cc0: 652d 6469 736b 2d66 726f 6d20 7b6e 616d  e-disk-from {nam
-00006cd0: 657d 202d 7920 2d63 207b 6e61 6d65 7d2d  e} -y -c {name}-
-00006ce0: 636c 6f6e 6520 2d2d 636c 6f75 6420 6763  clone --cloud gc
-00006cf0: 7020 2d2d 7a6f 6e65 2075 732d 6365 6e74  p --zone us-cent
-00006d00: 7261 6c31 2d61 2022 6361 7420 7e2f 7573  ral1-a "cat ~/us
-00006d10: 6572 5f66 696c 652e 7478 7420 7c20 6772  er_file.txt | gr
-00006d20: 6570 2068 656c 6c6f 2227 2c0a 2020 2020  ep hello"',.    
-00006d30: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
-00006d40: 756e 6368 202d 2d63 6c6f 6e65 2d64 6973  unch --clone-dis
-00006d50: 6b2d 6672 6f6d 207b 6e61 6d65 7d20 2d79  k-from {name} -y
-00006d60: 202d 6320 7b6e 616d 657d 2d63 6c6f 6e65   -c {name}-clone
-00006d70: 2d32 202d 2d63 6c6f 7564 2067 6370 202d  -2 --cloud gcp -
-00006d80: 2d7a 6f6e 6520 7573 2d65 6173 7431 2d62  -zone us-east1-b
-00006d90: 2022 6361 7420 7e2f 7573 6572 5f66 696c   "cat ~/user_fil
-00006da0: 652e 7478 7420 7c20 6772 6570 2068 656c  e.txt | grep hel
-00006db0: 6c6f 2227 2c0a 2020 2020 2020 2020 2020  lo"',.          
-00006dc0: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
-00006dd0: 6d65 7d2d 636c 6f6e 6520 3120 2d2d 7374  me}-clone 1 --st
-00006de0: 6174 7573 272c 0a20 2020 2020 2020 2020  atus',.         
-00006df0: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
-00006e00: 616d 657d 2d63 6c6f 6e65 2d32 2031 202d  ame}-clone-2 1 -
-00006e10: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
-00006e20: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
-00006e30: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
-00006e40: 7d20 7b6e 616d 657d 2d63 6c6f 6e65 207b  } {name}-clone {
-00006e50: 6e61 6d65 7d2d 636c 6f6e 652d 3227 2c0a  name}-clone-2',.
-00006e60: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
-00006e70: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
-00006e80: 7079 7465 7374 2e6d 6172 6b2e 6177 730a  pytest.mark.aws.
-00006e90: 6465 6620 7465 7374 5f69 6d61 6765 5f6e  def test_image_n
-00006ea0: 6f5f 636f 6e64 6128 293a 0a20 2020 206e  o_conda():.    n
-00006eb0: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
-00006ec0: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
-00006ed0: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
-00006ee0: 2020 2027 696d 6167 655f 6e6f 5f63 6f6e     'image_no_con
-00006ef0: 6461 272c 0a20 2020 2020 2020 205b 0a20  da',.        [. 
-00006f00: 2020 2020 2020 2020 2020 2023 2055 7365             # Use
-00006f10: 2069 6d61 6765 2069 6420 6469 6374 2e0a   image id dict..
-00006f20: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00006f30: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
-00006f40: 6e61 6d65 7d20 2d2d 7265 6769 6f6e 2075  name} --region u
-00006f50: 732d 6561 7374 2d32 2065 7861 6d70 6c65  s-east-2 example
-00006f60: 732f 7065 725f 7265 6769 6f6e 5f69 6d61  s/per_region_ima
-00006f70: 6765 732e 7961 6d6c 272c 0a20 2020 2020  ges.yaml',.     
-00006f80: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-00006f90: 7320 7b6e 616d 657d 2031 202d 2d73 7461  s {name} 1 --sta
-00006fa0: 7475 7327 2c0a 2020 2020 2020 2020 2020  tus',.          
-00006fb0: 2020 6627 736b 7920 7374 6f70 207b 6e61    f'sky stop {na
-00006fc0: 6d65 7d20 2d79 272c 0a20 2020 2020 2020  me} -y',.       
-00006fd0: 2020 2020 2066 2773 6b79 2073 7461 7274       f'sky start
-00006fe0: 207b 6e61 6d65 7d20 2d79 272c 0a20 2020   {name} -y',.   
-00006ff0: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
-00007000: 7865 6320 7b6e 616d 657d 2065 7861 6d70  xec {name} examp
-00007010: 6c65 732f 7065 725f 7265 6769 6f6e 5f69  les/per_region_i
-00007020: 6d61 6765 732e 7961 6d6c 272c 0a20 2020  mages.yaml',.   
-00007030: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00007040: 6f67 7320 7b6e 616d 657d 2032 202d 2d73  ogs {name} 2 --s
-00007050: 7461 7475 7327 2c0a 2020 2020 2020 2020  tatus',.        
-00007060: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
-00007070: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
-00007080: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
-00007090: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
-000070a0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
-000070b0: 5f6b 7562 6572 6e65 7465 7320 2023 204b  _kubernetes  # K
-000070c0: 7562 6572 6e65 7465 7320 646f 6573 206e  ubernetes does n
-000070d0: 6f74 2073 7570 706f 7274 2073 746f 7070  ot support stopp
-000070e0: 696e 6720 696e 7374 616e 6365 730a 6465  ing instances.de
-000070f0: 6620 7465 7374 5f63 7573 746f 6d5f 6465  f test_custom_de
-00007100: 6661 756c 745f 636f 6e64 615f 656e 7628  fault_conda_env(
-00007110: 6765 6e65 7269 635f 636c 6f75 643a 2073  generic_cloud: s
-00007120: 7472 293a 0a20 2020 206e 616d 6520 3d20  tr):.    name = 
-00007130: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
-00007140: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
-00007150: 6573 7428 2763 7573 746f 6d5f 6465 6661  est('custom_defa
-00007160: 756c 745f 636f 6e64 615f 656e 7627 2c20  ult_conda_env', 
-00007170: 5b0a 2020 2020 2020 2020 6627 736b 7920  [.        f'sky 
-00007180: 6c61 756e 6368 202d 6320 7b6e 616d 657d  launch -c {name}
-00007190: 202d 7920 2d2d 636c 6f75 6420 7b67 656e   -y --cloud {gen
-000071a0: 6572 6963 5f63 6c6f 7564 7d20 7465 7374  eric_cloud} test
-000071b0: 732f 7465 7374 5f79 616d 6c73 2f74 6573  s/test_yamls/tes
-000071c0: 745f 6375 7374 6f6d 5f64 6566 6175 6c74  t_custom_default
-000071d0: 5f63 6f6e 6461 5f65 6e76 2e79 616d 6c27  _conda_env.yaml'
-000071e0: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
-000071f0: 7374 6174 7573 202d 7220 7b6e 616d 657d  status -r {name}
-00007200: 207c 2067 7265 7020 2255 5022 272c 0a20   | grep "UP"',. 
-00007210: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-00007220: 7320 7b6e 616d 657d 2031 202d 2d73 7461  s {name} 1 --sta
-00007230: 7475 7327 2c0a 2020 2020 2020 2020 6627  tus',.        f'
-00007240: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-00007250: 3120 2d2d 6e6f 2d66 6f6c 6c6f 7720 7c20  1 --no-follow | 
-00007260: 6772 6570 202d 5020 226d 7965 6e76 5c5c  grep -P "myenv\\
-00007270: 732b 5c5c 2a22 272c 0a20 2020 2020 2020  s+\\*"',.       
-00007280: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
-00007290: 657d 2074 6573 7473 2f74 6573 745f 7961  e} tests/test_ya
-000072a0: 6d6c 732f 7465 7374 5f63 7573 746f 6d5f  mls/test_custom_
-000072b0: 6465 6661 756c 745f 636f 6e64 615f 656e  default_conda_en
-000072c0: 762e 7961 6d6c 272c 0a20 2020 2020 2020  v.yaml',.       
-000072d0: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
-000072e0: 657d 2032 202d 2d73 7461 7475 7327 2c0a  e} 2 --status',.
-000072f0: 2020 2020 2020 2020 6627 736b 7920 6175          f'sky au
-00007300: 746f 7374 6f70 202d 7920 2d69 2030 207b  tostop -y -i 0 {
-00007310: 6e61 6d65 7d27 2c0a 2020 2020 2020 2020  name}',.        
-00007320: 2773 6c65 6570 2036 3027 2c0a 2020 2020  'sleep 60',.    
-00007330: 2020 2020 6627 736b 7920 7374 6174 7573      f'sky status
-00007340: 202d 7220 7b6e 616d 657d 207c 2067 7265   -r {name} | gre
-00007350: 7020 2253 544f 5050 4544 2227 2c0a 2020  p "STOPPED"',.  
-00007360: 2020 2020 2020 6627 736b 7920 7374 6172        f'sky star
-00007370: 7420 2d79 207b 6e61 6d65 7d27 2c0a 2020  t -y {name}',.  
-00007380: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
-00007390: 207b 6e61 6d65 7d20 3220 2d2d 6e6f 2d66   {name} 2 --no-f
-000073a0: 6f6c 6c6f 7720 7c20 6772 6570 202d 5020  ollow | grep -P 
-000073b0: 226d 7965 6e76 5c5c 732b 5c5c 2a22 272c  "myenv\\s+\\*"',
-000073c0: 0a20 2020 2020 2020 2066 2773 6b79 2065  .        f'sky e
-000073d0: 7865 6320 7b6e 616d 657d 2074 6573 7473  xec {name} tests
-000073e0: 2f74 6573 745f 7961 6d6c 732f 7465 7374  /test_yamls/test
-000073f0: 5f63 7573 746f 6d5f 6465 6661 756c 745f  _custom_default_
-00007400: 636f 6e64 615f 656e 762e 7961 6d6c 272c  conda_env.yaml',
-00007410: 0a20 2020 2020 2020 2066 2773 6b79 206c  .        f'sky l
-00007420: 6f67 7320 7b6e 616d 657d 2033 202d 2d73  ogs {name} 3 --s
-00007430: 7461 7475 7327 2c0a 2020 2020 5d2c 2066  tatus',.    ], f
-00007440: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
-00007450: 6d65 7d27 290a 2020 2020 7275 6e5f 6f6e  me}').    run_on
-00007460: 655f 7465 7374 2874 6573 7429 0a0a 0a23  e_test(test)...#
-00007470: 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d20 5465   ------------ Te
-00007480: 7374 2073 7461 6c65 206a 6f62 202d 2d2d  st stale job ---
-00007490: 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974 6573  ---------.@pytes
-000074a0: 742e 6d61 726b 2e6e 6f5f 666c 7569 6473  t.mark.no_fluids
-000074b0: 7461 636b 2020 2320 466c 7569 6453 7461  tack  # FluidSta
-000074c0: 636b 2064 6f65 7320 6e6f 7420 7375 7070  ck does not supp
-000074d0: 6f72 7420 7374 6f70 7069 6e67 2069 6e73  ort stopping ins
-000074e0: 7461 6e63 6573 2069 6e20 536b 7950 696c  tances in SkyPil
-000074f0: 6f74 2069 6d70 6c65 6d65 6e74 6174 696f  ot implementatio
-00007500: 6e0a 4070 7974 6573 742e 6d61 726b 2e6e  n.@pytest.mark.n
-00007510: 6f5f 6c61 6d62 6461 5f63 6c6f 7564 2020  o_lambda_cloud  
-00007520: 2320 4c61 6d62 6461 2043 6c6f 7564 2064  # Lambda Cloud d
-00007530: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
-00007540: 7374 6f70 7069 6e67 2069 6e73 7461 6e63  stopping instanc
-00007550: 6573 0a40 7079 7465 7374 2e6d 6172 6b2e  es.@pytest.mark.
-00007560: 6e6f 5f6b 7562 6572 6e65 7465 7320 2023  no_kubernetes  #
-00007570: 204b 7562 6572 6e65 7465 7320 646f 6573   Kubernetes does
-00007580: 206e 6f74 2073 7570 706f 7274 2073 746f   not support sto
-00007590: 7070 696e 6720 696e 7374 616e 6365 730a  pping instances.
-000075a0: 6465 6620 7465 7374 5f73 7461 6c65 5f6a  def test_stale_j
-000075b0: 6f62 2867 656e 6572 6963 5f63 6c6f 7564  ob(generic_cloud
-000075c0: 3a20 7374 7229 3a0a 2020 2020 6e61 6d65  : str):.    name
-000075d0: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
-000075e0: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
-000075f0: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
-00007600: 2773 7461 6c65 5f6a 6f62 272c 0a20 2020  'stale_job',.   
-00007610: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
-00007620: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
-00007630: 2d79 202d 6320 7b6e 616d 657d 202d 2d63  -y -c {name} --c
-00007640: 6c6f 7564 207b 6765 6e65 7269 635f 636c  loud {generic_cl
-00007650: 6f75 647d 2022 6563 686f 2068 6922 272c  oud} "echo hi"',
-00007660: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00007670: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
-00007680: 6420 2265 6368 6f20 7374 6172 743b 2073  d "echo start; s
-00007690: 6c65 6570 2031 3030 3030 2227 2c0a 2020  leep 10000"',.  
-000076a0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-000076b0: 7374 6f70 207b 6e61 6d65 7d20 2d79 272c  stop {name} -y',
-000076c0: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
-000076d0: 6565 7020 3130 3027 2c20 2023 2045 6e73  eep 100',  # Ens
-000076e0: 7572 6520 7468 6973 2069 7320 6c61 7267  ure this is larg
-000076f0: 6520 656e 6f75 6768 2c20 656c 7365 2047  e enough, else G
-00007700: 4350 206c 6561 6b73 2e0a 2020 2020 2020  CP leaks..      
-00007710: 2020 2020 2020 6627 736b 7920 7374 6172        f'sky star
-00007720: 7420 7b6e 616d 657d 202d 7927 2c0a 2020  t {name} -y',.  
-00007730: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00007740: 6c6f 6773 207b 6e61 6d65 7d20 3120 2d2d  logs {name} 1 --
-00007750: 7374 6174 7573 272c 0a20 2020 2020 2020  status',.       
-00007760: 2020 2020 2066 2773 3d24 2873 6b79 2071       f's=$(sky q
-00007770: 7565 7565 207b 6e61 6d65 7d29 3b20 6563  ueue {name}); ec
-00007780: 686f 2022 2473 223b 2065 6368 6f3b 2065  ho "$s"; echo; e
-00007790: 6368 6f3b 2065 6368 6f20 2224 7322 207c  cho; echo "$s" |
-000077a0: 2067 7265 7020 4641 494c 4544 272c 0a20   grep FAILED',. 
-000077b0: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-000077c0: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
-000077d0: 7b6e 616d 657d 272c 0a20 2020 2029 0a20  {name}',.    ). 
-000077e0: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-000077f0: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
-00007800: 6d61 726b 2e61 7773 0a64 6566 2074 6573  mark.aws.def tes
-00007810: 745f 6177 735f 7374 616c 655f 6a6f 625f  t_aws_stale_job_
-00007820: 6d61 6e75 616c 5f72 6573 7461 7274 2829  manual_restart()
-00007830: 3a0a 2020 2020 6e61 6d65 203d 205f 6765  :.    name = _ge
-00007840: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
-00007850: 0a20 2020 206e 616d 655f 6f6e 5f63 6c6f  .    name_on_clo
-00007860: 7564 203d 2063 6f6d 6d6f 6e5f 7574 696c  ud = common_util
-00007870: 732e 6d61 6b65 5f63 6c75 7374 6572 5f6e  s.make_cluster_n
-00007880: 616d 655f 6f6e 5f63 6c6f 7564 280a 2020  ame_on_cloud(.  
-00007890: 2020 2020 2020 6e61 6d65 2c20 736b 792e        name, sky.
-000078a0: 4157 532e 6d61 785f 636c 7573 7465 725f  AWS.max_cluster_
-000078b0: 6e61 6d65 5f6c 656e 6774 6828 2929 0a20  name_length()). 
-000078c0: 2020 2072 6567 696f 6e20 3d20 2775 732d     region = 'us-
-000078d0: 6561 7374 2d32 270a 2020 2020 7465 7374  east-2'.    test
-000078e0: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-000078f0: 2027 6177 735f 7374 616c 655f 6a6f 625f   'aws_stale_job_
-00007900: 6d61 6e75 616c 5f72 6573 7461 7274 272c  manual_restart',
-00007910: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
-00007920: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
-00007930: 6e63 6820 2d79 202d 6320 7b6e 616d 657d  nch -y -c {name}
-00007940: 202d 2d63 6c6f 7564 2061 7773 202d 2d72   --cloud aws --r
-00007950: 6567 696f 6e20 7b72 6567 696f 6e7d 2022  egion {region} "
-00007960: 6563 686f 2068 6922 272c 0a20 2020 2020  echo hi"',.     
-00007970: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
-00007980: 6320 7b6e 616d 657d 202d 6420 2265 6368  c {name} -d "ech
-00007990: 6f20 7374 6172 743b 2073 6c65 6570 2031  o start; sleep 1
-000079a0: 3030 3030 2227 2c0a 2020 2020 2020 2020  0000"',.        
-000079b0: 2020 2020 2320 5374 6f70 2074 6865 2063      # Stop the c
-000079c0: 6c75 7374 6572 206d 616e 7561 6c6c 792e  luster manually.
-000079d0: 0a20 2020 2020 2020 2020 2020 2066 2769  .            f'i
-000079e0: 643d 6061 7773 2065 6332 2064 6573 6372  d=`aws ec2 descr
-000079f0: 6962 652d 696e 7374 616e 6365 7320 2d2d  ibe-instances --
-00007a00: 7265 6769 6f6e 207b 7265 6769 6f6e 7d20  region {region} 
-00007a10: 2d2d 6669 6c74 6572 7320 270a 2020 2020  --filters '.    
-00007a20: 2020 2020 2020 2020 6627 4e61 6d65 3d74          f'Name=t
-00007a30: 6167 3a72 6179 2d63 6c75 7374 6572 2d6e  ag:ray-cluster-n
-00007a40: 616d 652c 5661 6c75 6573 3d7b 6e61 6d65  ame,Values={name
-00007a50: 5f6f 6e5f 636c 6f75 647d 2027 0a20 2020  _on_cloud} '.   
-00007a60: 2020 2020 2020 2020 2066 272d 2d71 7565           f'--que
-00007a70: 7279 2052 6573 6572 7661 7469 6f6e 735b  ry Reservations[
-00007a80: 5d2e 496e 7374 616e 6365 735b 5d2e 496e  ].Instances[].In
-00007a90: 7374 616e 6365 4964 2027 0a20 2020 2020  stanceId '.     
-00007aa0: 2020 2020 2020 2027 2d2d 6f75 7470 7574         '--output
-00007ab0: 2074 6578 7460 3b20 270a 2020 2020 2020   text`; '.      
-00007ac0: 2020 2020 2020 6627 6177 7320 6563 3220        f'aws ec2 
-00007ad0: 7374 6f70 2d69 6e73 7461 6e63 6573 202d  stop-instances -
-00007ae0: 2d72 6567 696f 6e20 7b72 6567 696f 6e7d  -region {region}
-00007af0: 2027 0a20 2020 2020 2020 2020 2020 2027   '.            '
-00007b00: 2d2d 696e 7374 616e 6365 2d69 6473 2024  --instance-ids $
-00007b10: 6964 272c 0a20 2020 2020 2020 2020 2020  id',.           
-00007b20: 2027 736c 6565 7020 3430 272c 0a20 2020   'sleep 40',.   
-00007b30: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00007b40: 6175 6e63 6820 2d63 207b 6e61 6d65 7d20  aunch -c {name} 
-00007b50: 2d79 2022 6563 686f 2068 6922 272c 0a20  -y "echo hi"',. 
-00007b60: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00007b70: 206c 6f67 7320 7b6e 616d 657d 2031 202d   logs {name} 1 -
-00007b80: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
-00007b90: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
-00007ba0: 207b 6e61 6d65 7d20 3320 2d2d 7374 6174   {name} 3 --stat
-00007bb0: 7573 272c 0a20 2020 2020 2020 2020 2020  us',.           
-00007bc0: 2023 2045 6e73 7572 6520 7468 6520 736b   # Ensure the sk
-00007bd0: 796c 6574 2075 7064 6174 6564 2074 6865  ylet updated the
-00007be0: 2073 7461 6c65 206a 6f62 2073 7461 7475   stale job statu
-00007bf0: 732e 0a20 2020 2020 2020 2020 2020 2066  s..            f
-00007c00: 2773 6c65 6570 207b 6576 656e 7473 2e4a  'sleep {events.J
-00007c10: 6f62 5363 6865 6475 6c65 7245 7665 6e74  obSchedulerEvent
-00007c20: 2e45 5645 4e54 5f49 4e54 4552 5641 4c5f  .EVENT_INTERVAL_
-00007c30: 5345 434f 4e44 537d 272c 0a20 2020 2020  SECONDS}',.     
-00007c40: 2020 2020 2020 2066 2773 3d24 2873 6b79         f's=$(sky
-00007c50: 2071 7565 7565 207b 6e61 6d65 7d29 3b20   queue {name}); 
-00007c60: 6563 686f 2022 2473 223b 2065 6368 6f3b  echo "$s"; echo;
-00007c70: 2065 6368 6f3b 2065 6368 6f20 2224 7322   echo; echo "$s"
-00007c80: 207c 2067 7265 7020 4641 494c 4544 272c   | grep FAILED',
-00007c90: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
-00007ca0: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
-00007cb0: 7920 7b6e 616d 657d 272c 0a20 2020 2029  y {name}',.    )
-00007cc0: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
-00007cd0: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
-00007ce0: 742e 6d61 726b 2e67 6370 0a64 6566 2074  t.mark.gcp.def t
-00007cf0: 6573 745f 6763 705f 7374 616c 655f 6a6f  est_gcp_stale_jo
-00007d00: 625f 6d61 6e75 616c 5f72 6573 7461 7274  b_manual_restart
-00007d10: 2829 3a0a 2020 2020 6e61 6d65 203d 205f  ():.    name = _
-00007d20: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
-00007d30: 2829 0a20 2020 206e 616d 655f 6f6e 5f63  ().    name_on_c
-00007d40: 6c6f 7564 203d 2063 6f6d 6d6f 6e5f 7574  loud = common_ut
-00007d50: 696c 732e 6d61 6b65 5f63 6c75 7374 6572  ils.make_cluster
-00007d60: 5f6e 616d 655f 6f6e 5f63 6c6f 7564 280a  _name_on_cloud(.
-00007d70: 2020 2020 2020 2020 6e61 6d65 2c20 736b          name, sk
-00007d80: 792e 4743 502e 6d61 785f 636c 7573 7465  y.GCP.max_cluste
-00007d90: 725f 6e61 6d65 5f6c 656e 6774 6828 2929  r_name_length())
-00007da0: 0a20 2020 207a 6f6e 6520 3d20 2775 732d  .    zone = 'us-
-00007db0: 7765 7374 322d 6127 0a20 2020 2071 7565  west2-a'.    que
-00007dc0: 7279 5f63 6d64 203d 2028 6627 6763 6c6f  ry_cmd = (f'gclo
-00007dd0: 7564 2063 6f6d 7075 7465 2069 6e73 7461  ud compute insta
-00007de0: 6e63 6573 206c 6973 7420 2d2d 6669 6c74  nces list --filt
-00007df0: 6572 3d27 0a20 2020 2020 2020 2020 2020  er='.           
-00007e00: 2020 2020 2020 6627 2228 6c61 6265 6c73        f'"(labels
-00007e10: 2e72 6179 2d63 6c75 7374 6572 2d6e 616d  .ray-cluster-nam
-00007e20: 653d 7b6e 616d 655f 6f6e 5f63 6c6f 7564  e={name_on_cloud
-00007e30: 7d29 2220 270a 2020 2020 2020 2020 2020  })" '.          
-00007e40: 2020 2020 2020 2066 272d 2d7a 6f6e 6573         f'--zones
-00007e50: 3d7b 7a6f 6e65 7d20 2d2d 666f 726d 6174  ={zone} --format
-00007e60: 3d22 7661 6c75 6528 6e61 6d65 2922 2729  ="value(name)"')
-00007e70: 0a20 2020 2073 746f 705f 636d 6420 3d20  .    stop_cmd = 
-00007e80: 2866 2767 636c 6f75 6420 636f 6d70 7574  (f'gcloud comput
-00007e90: 6520 696e 7374 616e 6365 7320 7374 6f70  e instances stop
-00007ea0: 202d 2d7a 6f6e 653d 7b7a 6f6e 657d 270a   --zone={zone}'.
-00007eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007ec0: 6627 202d 2d71 7569 6574 2024 287b 7175  f' --quiet $({qu
-00007ed0: 6572 795f 636d 647d 2927 290a 2020 2020  ery_cmd})').    
-00007ee0: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
-00007ef0: 2020 2020 2027 6763 705f 7374 616c 655f       'gcp_stale_
-00007f00: 6a6f 625f 6d61 6e75 616c 5f72 6573 7461  job_manual_resta
-00007f10: 7274 272c 0a20 2020 2020 2020 205b 0a20  rt',.        [. 
-00007f20: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00007f30: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
-00007f40: 616d 657d 202d 2d63 6c6f 7564 2067 6370  ame} --cloud gcp
-00007f50: 202d 2d7a 6f6e 6520 7b7a 6f6e 657d 2022   --zone {zone} "
-00007f60: 6563 686f 2068 6922 272c 0a20 2020 2020  echo hi"',.     
-00007f70: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
-00007f80: 6320 7b6e 616d 657d 202d 6420 2265 6368  c {name} -d "ech
-00007f90: 6f20 7374 6172 743b 2073 6c65 6570 2031  o start; sleep 1
-00007fa0: 3030 3030 2227 2c0a 2020 2020 2020 2020  0000"',.        
-00007fb0: 2020 2020 2320 5374 6f70 2074 6865 2063      # Stop the c
-00007fc0: 6c75 7374 6572 206d 616e 7561 6c6c 792e  luster manually.
-00007fd0: 0a20 2020 2020 2020 2020 2020 2073 746f  .            sto
-00007fe0: 705f 636d 642c 0a20 2020 2020 2020 2020  p_cmd,.         
-00007ff0: 2020 2027 736c 6565 7020 3430 272c 0a20     'sleep 40',. 
-00008000: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00008010: 206c 6175 6e63 6820 2d63 207b 6e61 6d65   launch -c {name
-00008020: 7d20 2d79 2022 6563 686f 2068 6922 272c  } -y "echo hi"',
-00008030: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00008040: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
-00008050: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
-00008060: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
-00008070: 6773 207b 6e61 6d65 7d20 3320 2d2d 7374  gs {name} 3 --st
-00008080: 6174 7573 272c 0a20 2020 2020 2020 2020  atus',.         
-00008090: 2020 2023 2045 6e73 7572 6520 7468 6520     # Ensure the 
-000080a0: 736b 796c 6574 2075 7064 6174 6564 2074  skylet updated t
-000080b0: 6865 2073 7461 6c65 206a 6f62 2073 7461  he stale job sta
-000080c0: 7475 732e 0a20 2020 2020 2020 2020 2020  tus..           
-000080d0: 2066 2773 6c65 6570 207b 6576 656e 7473   f'sleep {events
-000080e0: 2e4a 6f62 5363 6865 6475 6c65 7245 7665  .JobSchedulerEve
-000080f0: 6e74 2e45 5645 4e54 5f49 4e54 4552 5641  nt.EVENT_INTERVA
-00008100: 4c5f 5345 434f 4e44 537d 272c 0a20 2020  L_SECONDS}',.   
-00008110: 2020 2020 2020 2020 2066 2773 3d24 2873           f's=$(s
-00008120: 6b79 2071 7565 7565 207b 6e61 6d65 7d29  ky queue {name})
-00008130: 3b20 6563 686f 2022 2473 223b 2065 6368  ; echo "$s"; ech
-00008140: 6f3b 2065 6368 6f3b 2065 6368 6f20 2224  o; echo; echo "$
-00008150: 7322 207c 2067 7265 7020 4641 494c 4544  s" | grep FAILED
-00008160: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
-00008170: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
-00008180: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
-00008190: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
-000081a0: 6573 7428 7465 7374 290a 0a0a 2320 2d2d  est(test)...# --
-000081b0: 2d2d 2d2d 2d2d 2d2d 2043 6865 636b 2053  -------- Check S
-000081c0: 6b79 2773 2065 6e76 6972 6f6e 6d65 6e74  ky's environment
-000081d0: 2076 6172 6961 626c 6573 3b20 776f 726b   variables; work
-000081e0: 6469 722e 202d 2d2d 2d2d 2d2d 2d2d 2d0a  dir. ----------.
-000081f0: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
-00008200: 666c 7569 6473 7461 636b 2020 2320 5265  fluidstack  # Re
-00008210: 7175 6972 6573 2061 6d61 7a6f 6e20 5333  quires amazon S3
-00008220: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
-00008230: 5f73 6370 2020 2320 5343 5020 646f 6573  _scp  # SCP does
-00008240: 206e 6f74 2073 7570 706f 7274 206e 756d   not support num
-00008250: 5f6e 6f64 6573 203e 2031 2079 6574 0a64  _nodes > 1 yet.d
-00008260: 6566 2074 6573 745f 656e 765f 6368 6563  ef test_env_chec
-00008270: 6b28 6765 6e65 7269 635f 636c 6f75 643a  k(generic_cloud:
-00008280: 2073 7472 293a 0a20 2020 206e 616d 6520   str):.    name 
-00008290: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
-000082a0: 616d 6528 290a 2020 2020 746f 7461 6c5f  ame().    total_
-000082b0: 7469 6d65 6f75 745f 6d69 6e75 7465 7320  timeout_minutes 
-000082c0: 3d20 3235 2069 6620 6765 6e65 7269 635f  = 25 if generic_
-000082d0: 636c 6f75 6420 3d3d 2027 617a 7572 6527  cloud == 'azure'
-000082e0: 2065 6c73 6520 3135 0a20 2020 2074 6573   else 15.    tes
-000082f0: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
-00008300: 2020 2765 6e76 5f63 6865 636b 272c 0a20    'env_check',. 
-00008310: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-00008320: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
-00008330: 6820 2d79 202d 6320 7b6e 616d 657d 202d  h -y -c {name} -
-00008340: 2d63 6c6f 7564 207b 6765 6e65 7269 635f  -cloud {generic_
-00008350: 636c 6f75 647d 202d 2d64 6574 6163 682d  cloud} --detach-
-00008360: 7365 7475 7020 6578 616d 706c 6573 2f65  setup examples/e
-00008370: 6e76 5f63 6865 636b 2e79 616d 6c27 2c0a  nv_check.yaml',.
-00008380: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00008390: 7920 6c6f 6773 207b 6e61 6d65 7d20 3120  y logs {name} 1 
-000083a0: 2d2d 7374 6174 7573 272c 2020 2320 456e  --status',  # En
-000083b0: 7375 7265 2074 6865 206a 6f62 2073 7563  sure the job suc
-000083c0: 6365 6564 6564 2e0a 2020 2020 2020 2020  ceeded..        
-000083d0: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
-000083e0: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
-000083f0: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
-00008400: 743d 746f 7461 6c5f 7469 6d65 6f75 745f  t=total_timeout_
-00008410: 6d69 6e75 7465 7320 2a20 3630 2c0a 2020  minutes * 60,.  
-00008420: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
-00008430: 7465 7374 2874 6573 7429 0a0a 0a23 202d  test(test)...# -
-00008440: 2d2d 2d2d 2d2d 2d2d 2d20 6669 6c65 5f6d  --------- file_m
-00008450: 6f75 6e74 7320 2d2d 2d2d 2d2d 2d2d 2d2d  ounts ----------
-00008460: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
-00008470: 5f73 6370 2020 2320 5343 5020 646f 6573  _scp  # SCP does
-00008480: 206e 6f74 2073 7570 706f 7274 206e 756d   not support num
-00008490: 5f6e 6f64 6573 203e 2031 2079 6574 2e20  _nodes > 1 yet. 
-000084a0: 5275 6e20 7465 7374 5f73 6370 5f66 696c  Run test_scp_fil
-000084b0: 655f 6d6f 756e 7473 2069 6e73 7465 6164  e_mounts instead
-000084c0: 2e0a 6465 6620 7465 7374 5f66 696c 655f  ..def test_file_
-000084d0: 6d6f 756e 7473 2867 656e 6572 6963 5f63  mounts(generic_c
-000084e0: 6c6f 7564 3a20 7374 7229 3a0a 2020 2020  loud: str):.    
-000084f0: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
-00008500: 7465 725f 6e61 6d65 2829 0a20 2020 2065  ter_name().    e
-00008510: 7874 7261 5f66 6c61 6773 203d 2027 270a  xtra_flags = ''.
-00008520: 2020 2020 6966 2067 656e 6572 6963 5f63      if generic_c
-00008530: 6c6f 7564 2069 6e20 276b 7562 6572 6e65  loud in 'kuberne
-00008540: 7465 7327 3a0a 2020 2020 2020 2020 2320  tes':.        # 
-00008550: 4b75 6265 726e 6574 6573 2064 6f65 7320  Kubernetes does 
-00008560: 6e6f 7420 7375 7070 6f72 7420 6d75 6c74  not support mult
-00008570: 692d 6e6f 6465 0a20 2020 2020 2020 2023  i-node.        #
-00008580: 204e 4f54 453a 2054 6869 7320 7465 7374   NOTE: This test
-00008590: 2077 696c 6c20 6661 696c 2069 6620 796f   will fail if yo
-000085a0: 7520 6861 7665 2061 204b 7562 6572 6e65  u have a Kuberne
-000085b0: 7465 7320 636c 7573 7465 7220 7275 6e6e  tes cluster runn
-000085c0: 696e 6720 6f6e 0a20 2020 2020 2020 2023  ing on.        #
-000085d0: 2020 6172 6d36 3420 2865 2e67 2e2c 2041    arm64 (e.g., A
-000085e0: 7070 6c65 2053 696c 6963 6f6e 2920 7369  pple Silicon) si
-000085f0: 6e63 6520 676f 6f66 7973 2064 6f65 7320  nce goofys does 
-00008600: 6e6f 7420 776f 726b 206f 6e20 6172 6d36  not work on arm6
-00008610: 342e 0a20 2020 2020 2020 2065 7874 7261  4..        extra
-00008620: 5f66 6c61 6773 203d 2027 2d2d 6e75 6d2d  _flags = '--num-
-00008630: 6e6f 6465 7320 3127 0a20 2020 2074 6573  nodes 1'.    tes
-00008640: 745f 636f 6d6d 616e 6473 203d 205b 0a20  t_commands = [. 
-00008650: 2020 2020 2020 202a 7374 6f72 6167 655f         *storage_
-00008660: 7365 7475 705f 636f 6d6d 616e 6473 2c0a  setup_commands,.
-00008670: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
-00008680: 756e 6368 202d 7920 2d63 207b 6e61 6d65  unch -y -c {name
-00008690: 7d20 2d2d 636c 6f75 6420 7b67 656e 6572  } --cloud {gener
-000086a0: 6963 5f63 6c6f 7564 7d20 7b65 7874 7261  ic_cloud} {extra
-000086b0: 5f66 6c61 6773 7d20 6578 616d 706c 6573  _flags} examples
-000086c0: 2f75 7369 6e67 5f66 696c 655f 6d6f 756e  /using_file_moun
-000086d0: 7473 2e79 616d 6c27 2c0a 2020 2020 2020  ts.yaml',.      
-000086e0: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
-000086f0: 6d65 7d20 3120 2d2d 7374 6174 7573 272c  me} 1 --status',
-00008700: 2020 2320 456e 7375 7265 2074 6865 206a    # Ensure the j
-00008710: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
-00008720: 2020 5d0a 2020 2020 7465 7374 203d 2054    ].    test = T
-00008730: 6573 7428 0a20 2020 2020 2020 2027 7573  est(.        'us
-00008740: 696e 675f 6669 6c65 5f6d 6f75 6e74 7327  ing_file_mounts'
-00008750: 2c0a 2020 2020 2020 2020 7465 7374 5f63  ,.        test_c
-00008760: 6f6d 6d61 6e64 732c 0a20 2020 2020 2020  ommands,.       
-00008770: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
-00008780: 6e61 6d65 7d27 2c0a 2020 2020 2020 2020  name}',.        
-00008790: 5f67 6574 5f74 696d 656f 7574 2867 656e  _get_timeout(gen
-000087a0: 6572 6963 5f63 6c6f 7564 2c20 3230 202a  eric_cloud, 20 *
-000087b0: 2036 3029 2c20 2023 2032 3020 6d69 6e73   60),  # 20 mins
-000087c0: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
-000087d0: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
-000087e0: 4070 7974 6573 742e 6d61 726b 2e73 6370  @pytest.mark.scp
-000087f0: 0a64 6566 2074 6573 745f 7363 705f 6669  .def test_scp_fi
-00008800: 6c65 5f6d 6f75 6e74 7328 293a 0a20 2020  le_mounts():.   
-00008810: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
-00008820: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
-00008830: 7465 7374 5f63 6f6d 6d61 6e64 7320 3d20  test_commands = 
-00008840: 5b0a 2020 2020 2020 2020 2a73 746f 7261  [.        *stora
-00008850: 6765 5f73 6574 7570 5f63 6f6d 6d61 6e64  ge_setup_command
-00008860: 732c 0a20 2020 2020 2020 2066 2773 6b79  s,.        f'sky
-00008870: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
-00008880: 616d 657d 207b 5343 505f 5459 5045 7d20  ame} {SCP_TYPE} 
-00008890: 2d2d 6e75 6d2d 6e6f 6465 7320 3120 6578  --num-nodes 1 ex
-000088a0: 616d 706c 6573 2f75 7369 6e67 5f66 696c  amples/using_fil
-000088b0: 655f 6d6f 756e 7473 2e79 616d 6c27 2c0a  e_mounts.yaml',.
-000088c0: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
-000088d0: 6773 207b 6e61 6d65 7d20 3120 2d2d 7374  gs {name} 1 --st
-000088e0: 6174 7573 272c 2020 2320 456e 7375 7265  atus',  # Ensure
-000088f0: 2074 6865 206a 6f62 2073 7563 6365 6564   the job succeed
-00008900: 6564 2e0a 2020 2020 5d0a 2020 2020 7465  ed..    ].    te
-00008910: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
-00008920: 2020 2027 5343 505f 7573 696e 675f 6669     'SCP_using_fi
-00008930: 6c65 5f6d 6f75 6e74 7327 2c0a 2020 2020  le_mounts',.    
-00008940: 2020 2020 7465 7374 5f63 6f6d 6d61 6e64      test_command
-00008950: 732c 0a20 2020 2020 2020 2066 2773 6b79  s,.        f'sky
-00008960: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
-00008970: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
-00008980: 743d 3230 202a 2036 302c 2020 2320 3230  t=20 * 60,  # 20
-00008990: 206d 696e 730a 2020 2020 290a 2020 2020   mins.    ).    
-000089a0: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-000089b0: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
-000089c0: 6b2e 6e6f 5f66 6c75 6964 7374 6163 6b20  k.no_fluidstack 
-000089d0: 2023 2052 6571 7569 7265 7320 4743 5020   # Requires GCP 
-000089e0: 746f 2062 6520 656e 6162 6c65 640a 6465  to be enabled.de
-000089f0: 6620 7465 7374 5f75 7369 6e67 5f66 696c  f test_using_fil
-00008a00: 655f 6d6f 756e 7473 5f77 6974 685f 656e  e_mounts_with_en
-00008a10: 765f 7661 7273 2867 656e 6572 6963 5f63  v_vars(generic_c
-00008a20: 6c6f 7564 3a20 7374 7229 3a0a 2020 2020  loud: str):.    
-00008a30: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
-00008a40: 7465 725f 6e61 6d65 2829 0a20 2020 2073  ter_name().    s
-00008a50: 746f 7261 6765 5f6e 616d 6520 3d20 5465  torage_name = Te
-00008a60: 7374 5374 6f72 6167 6557 6974 6843 7265  stStorageWithCre
-00008a70: 6465 6e74 6961 6c73 2e67 656e 6572 6174  dentials.generat
-00008a80: 655f 6275 636b 6574 5f6e 616d 6528 290a  e_bucket_name().
-00008a90: 2020 2020 7465 7374 5f63 6f6d 6d61 6e64      test_command
-00008aa0: 7320 3d20 5b0a 2020 2020 2020 2020 2a73  s = [.        *s
-00008ab0: 746f 7261 6765 5f73 6574 7570 5f63 6f6d  torage_setup_com
-00008ac0: 6d61 6e64 732c 0a20 2020 2020 2020 2028  mands,.        (
-00008ad0: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
-00008ae0: 2d63 207b 6e61 6d65 7d20 2d2d 6370 7573  -c {name} --cpus
-00008af0: 2032 2b20 2d2d 636c 6f75 6420 7b67 656e   2+ --cloud {gen
-00008b00: 6572 6963 5f63 6c6f 7564 7d20 270a 2020  eric_cloud} '.  
-00008b10: 2020 2020 2020 2027 6578 616d 706c 6573         'examples
-00008b20: 2f75 7369 6e67 5f66 696c 655f 6d6f 756e  /using_file_moun
-00008b30: 7473 5f77 6974 685f 656e 765f 7661 7273  ts_with_env_vars
-00008b40: 2e79 616d 6c20 270a 2020 2020 2020 2020  .yaml '.        
-00008b50: 2066 272d 2d65 6e76 204d 595f 4255 434b   f'--env MY_BUCK
-00008b60: 4554 3d7b 7374 6f72 6167 655f 6e61 6d65  ET={storage_name
-00008b70: 7d27 292c 0a20 2020 2020 2020 2066 2773  }'),.        f's
-00008b80: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
-00008b90: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
-00008ba0: 6e73 7572 6520 7468 6520 6a6f 6220 7375  nsure the job su
-00008bb0: 6363 6565 6465 642e 0a20 2020 2020 2020  cceeded..       
-00008bc0: 2023 204f 7665 7272 6964 6520 7769 7468   # Override with
-00008bd0: 202d 2d65 6e76 3a0a 2020 2020 2020 2020   --env:.        
-00008be0: 2866 2773 6b79 206c 6175 6e63 6820 2d79  (f'sky launch -y
-00008bf0: 202d 6320 7b6e 616d 657d 2d32 202d 2d63   -c {name}-2 --c
-00008c00: 7075 7320 322b 202d 2d63 6c6f 7564 207b  pus 2+ --cloud {
-00008c10: 6765 6e65 7269 635f 636c 6f75 647d 2027  generic_cloud} '
-00008c20: 0a20 2020 2020 2020 2020 2765 7861 6d70  .         'examp
-00008c30: 6c65 732f 7573 696e 675f 6669 6c65 5f6d  les/using_file_m
-00008c40: 6f75 6e74 735f 7769 7468 5f65 6e76 5f76  ounts_with_env_v
-00008c50: 6172 732e 7961 6d6c 2027 0a20 2020 2020  ars.yaml '.     
-00008c60: 2020 2020 6627 2d2d 656e 7620 4d59 5f42      f'--env MY_B
-00008c70: 5543 4b45 543d 7b73 746f 7261 6765 5f6e  UCKET={storage_n
-00008c80: 616d 657d 2027 0a20 2020 2020 2020 2020  ame} '.         
-00008c90: 272d 2d65 6e76 204d 595f 4c4f 4341 4c5f  '--env MY_LOCAL_
-00008ca0: 5041 5448 3d74 6d70 6669 6c65 2729 2c0a  PATH=tmpfile'),.
-00008cb0: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
-00008cc0: 6773 207b 6e61 6d65 7d2d 3220 3120 2d2d  gs {name}-2 1 --
-00008cd0: 7374 6174 7573 272c 2020 2320 456e 7375  status',  # Ensu
-00008ce0: 7265 2074 6865 206a 6f62 2073 7563 6365  re the job succe
-00008cf0: 6564 6564 2e0a 2020 2020 5d0a 2020 2020  eded..    ].    
-00008d00: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
-00008d10: 2020 2020 2027 7573 696e 675f 6669 6c65       'using_file
-00008d20: 5f6d 6f75 6e74 735f 7769 7468 5f65 6e76  _mounts_with_env
-00008d30: 5f76 6172 7327 2c0a 2020 2020 2020 2020  _vars',.        
-00008d40: 7465 7374 5f63 6f6d 6d61 6e64 732c 0a20  test_commands,. 
-00008d50: 2020 2020 2020 2028 6627 736b 7920 646f         (f'sky do
-00008d60: 776e 202d 7920 7b6e 616d 657d 207b 6e61  wn -y {name} {na
-00008d70: 6d65 7d2d 3227 2c0a 2020 2020 2020 2020  me}-2',.        
-00008d80: 2066 2773 6b79 2073 746f 7261 6765 2064   f'sky storage d
-00008d90: 656c 6574 6520 2d79 207b 7374 6f72 6167  elete -y {storag
-00008da0: 655f 6e61 6d65 7d20 7b73 746f 7261 6765  e_name} {storage
-00008db0: 5f6e 616d 657d 2d32 2729 2c0a 2020 2020  _name}-2'),.    
-00008dc0: 2020 2020 7469 6d65 6f75 743d 3230 202a      timeout=20 *
-00008dd0: 2036 302c 2020 2320 3230 206d 696e 730a   60,  # 20 mins.
-00008de0: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
-00008df0: 655f 7465 7374 2874 6573 7429 0a0a 0a23  e_test(test)...#
-00008e00: 202d 2d2d 2d2d 2d2d 2d2d 2d20 7374 6f72   ---------- stor
-00008e10: 6167 6520 2d2d 2d2d 2d2d 2d2d 2d2d 0a40  age ----------.@
-00008e20: 7079 7465 7374 2e6d 6172 6b2e 6177 730a  pytest.mark.aws.
-00008e30: 6465 6620 7465 7374 5f61 7773 5f73 746f  def test_aws_sto
-00008e40: 7261 6765 5f6d 6f75 6e74 735f 7769 7468  rage_mounts_with
-00008e50: 5f73 746f 7028 293a 0a20 2020 206e 616d  _stop():.    nam
-00008e60: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
-00008e70: 5f6e 616d 6528 290a 2020 2020 7374 6f72  _name().    stor
-00008e80: 6167 655f 6e61 6d65 203d 2066 2773 6b79  age_name = f'sky
-00008e90: 2d74 6573 742d 7b69 6e74 2874 696d 652e  -test-{int(time.
-00008ea0: 7469 6d65 2829 297d 270a 2020 2020 7465  time())}'.    te
-00008eb0: 6d70 6c61 7465 5f73 7472 203d 2070 6174  mplate_str = pat
-00008ec0: 686c 6962 2e50 6174 6828 0a20 2020 2020  hlib.Path(.     
-00008ed0: 2020 2027 7465 7374 732f 7465 7374 5f79     'tests/test_y
-00008ee0: 616d 6c73 2f74 6573 745f 7374 6f72 6167  amls/test_storag
-00008ef0: 655f 6d6f 756e 7469 6e67 2e79 616d 6c2e  e_mounting.yaml.
-00008f00: 6a32 2729 2e72 6561 645f 7465 7874 2829  j2').read_text()
-00008f10: 0a20 2020 2074 656d 706c 6174 6520 3d20  .    template = 
-00008f20: 6a69 6e6a 6132 2e54 656d 706c 6174 6528  jinja2.Template(
-00008f30: 7465 6d70 6c61 7465 5f73 7472 290a 2020  template_str).  
-00008f40: 2020 636f 6e74 656e 7420 3d20 7465 6d70    content = temp
-00008f50: 6c61 7465 2e72 656e 6465 7228 7374 6f72  late.render(stor
-00008f60: 6167 655f 6e61 6d65 3d73 746f 7261 6765  age_name=storage
-00008f70: 5f6e 616d 6529 0a20 2020 2077 6974 6820  _name).    with 
-00008f80: 7465 6d70 6669 6c65 2e4e 616d 6564 5465  tempfile.NamedTe
-00008f90: 6d70 6f72 6172 7946 696c 6528 7375 6666  mporaryFile(suff
-00008fa0: 6978 3d27 2e79 616d 6c27 2c20 6d6f 6465  ix='.yaml', mode
-00008fb0: 3d27 7727 2920 6173 2066 3a0a 2020 2020  ='w') as f:.    
-00008fc0: 2020 2020 662e 7772 6974 6528 636f 6e74      f.write(cont
-00008fd0: 656e 7429 0a20 2020 2020 2020 2066 2e66  ent).        f.f
-00008fe0: 6c75 7368 2829 0a20 2020 2020 2020 2066  lush().        f
-00008ff0: 696c 655f 7061 7468 203d 2066 2e6e 616d  ile_path = f.nam
-00009000: 650a 2020 2020 2020 2020 7465 7374 5f63  e.        test_c
-00009010: 6f6d 6d61 6e64 7320 3d20 5b0a 2020 2020  ommands = [.    
-00009020: 2020 2020 2020 2020 2a73 746f 7261 6765          *storage
-00009030: 5f73 6574 7570 5f63 6f6d 6d61 6e64 732c  _setup_commands,
-00009040: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00009050: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
-00009060: 7b6e 616d 657d 202d 2d63 6c6f 7564 2061  {name} --cloud a
-00009070: 7773 207b 6669 6c65 5f70 6174 687d 272c  ws {file_path}',
-00009080: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00009090: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
-000090a0: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
-000090b0: 6e73 7572 6520 6a6f 6220 7375 6363 6565  nsure job succee
-000090c0: 6465 642e 0a20 2020 2020 2020 2020 2020  ded..           
-000090d0: 2066 2761 7773 2073 3320 6c73 207b 7374   f'aws s3 ls {st
-000090e0: 6f72 6167 655f 6e61 6d65 7d2f 6865 6c6c  orage_name}/hell
-000090f0: 6f2e 7478 7427 2c0a 2020 2020 2020 2020  o.txt',.        
-00009100: 2020 2020 6627 736b 7920 7374 6f70 202d      f'sky stop -
-00009110: 7920 7b6e 616d 657d 272c 0a20 2020 2020  y {name}',.     
-00009120: 2020 2020 2020 2066 2773 6b79 2073 7461         f'sky sta
-00009130: 7274 202d 7920 7b6e 616d 657d 272c 0a20  rt -y {name}',. 
-00009140: 2020 2020 2020 2020 2020 2023 2043 6865             # Che
-00009150: 636b 2069 6620 6865 6c6c 6f2e 7478 7420  ck if hello.txt 
-00009160: 6672 6f6d 206d 6f75 6e74 696e 6720 6275  from mounting bu
-00009170: 636b 6574 2065 7869 7374 7320 6166 7465  cket exists afte
-00009180: 7220 7265 7374 6172 7420 696e 0a20 2020  r restart in.   
-00009190: 2020 2020 2020 2020 2023 2074 6865 206d           # the m
-000091a0: 6f75 6e74 6564 2064 6972 6563 746f 7279  ounted directory
-000091b0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-000091c0: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
-000091d0: 2d20 2273 6574 202d 6578 3b20 6c73 202f  - "set -ex; ls /
-000091e0: 6d6f 756e 745f 7072 6976 6174 655f 6d6f  mount_private_mo
-000091f0: 756e 742f 6865 6c6c 6f2e 7478 7422 270a  unt/hello.txt"'.
-00009200: 2020 2020 2020 2020 5d0a 2020 2020 2020          ].      
-00009210: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
-00009220: 2020 2020 2020 2020 2020 2027 6177 735f             'aws_
-00009230: 7374 6f72 6167 655f 6d6f 756e 7473 272c  storage_mounts',
-00009240: 0a20 2020 2020 2020 2020 2020 2074 6573  .            tes
-00009250: 745f 636f 6d6d 616e 6473 2c0a 2020 2020  t_commands,.    
-00009260: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
-00009270: 776e 202d 7920 7b6e 616d 657d 3b20 736b  wn -y {name}; sk
-00009280: 7920 7374 6f72 6167 6520 6465 6c65 7465  y storage delete
-00009290: 202d 7920 7b73 746f 7261 6765 5f6e 616d   -y {storage_nam
-000092a0: 657d 272c 0a20 2020 2020 2020 2020 2020  e}',.           
-000092b0: 2074 696d 656f 7574 3d32 3020 2a20 3630   timeout=20 * 60
-000092c0: 2c20 2023 2032 3020 6d69 6e73 0a20 2020  ,  # 20 mins.   
-000092d0: 2020 2020 2029 0a20 2020 2020 2020 2072       ).        r
-000092e0: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
-000092f0: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
-00009300: 2e67 6370 0a64 6566 2074 6573 745f 6763  .gcp.def test_gc
-00009310: 705f 7374 6f72 6167 655f 6d6f 756e 7473  p_storage_mounts
-00009320: 5f77 6974 685f 7374 6f70 2829 3a0a 2020  _with_stop():.  
-00009330: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
-00009340: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
-00009350: 2073 746f 7261 6765 5f6e 616d 6520 3d20   storage_name = 
-00009360: 6627 736b 792d 7465 7374 2d7b 696e 7428  f'sky-test-{int(
-00009370: 7469 6d65 2e74 696d 6528 2929 7d27 0a20  time.time())}'. 
-00009380: 2020 2074 656d 706c 6174 655f 7374 7220     template_str 
-00009390: 3d20 7061 7468 6c69 622e 5061 7468 280a  = pathlib.Path(.
-000093a0: 2020 2020 2020 2020 2774 6573 7473 2f74          'tests/t
-000093b0: 6573 745f 7961 6d6c 732f 7465 7374 5f73  est_yamls/test_s
-000093c0: 746f 7261 6765 5f6d 6f75 6e74 696e 672e  torage_mounting.
-000093d0: 7961 6d6c 2e6a 3227 292e 7265 6164 5f74  yaml.j2').read_t
-000093e0: 6578 7428 290a 2020 2020 7465 6d70 6c61  ext().    templa
-000093f0: 7465 203d 206a 696e 6a61 322e 5465 6d70  te = jinja2.Temp
-00009400: 6c61 7465 2874 656d 706c 6174 655f 7374  late(template_st
-00009410: 7229 0a20 2020 2063 6f6e 7465 6e74 203d  r).    content =
-00009420: 2074 656d 706c 6174 652e 7265 6e64 6572   template.render
-00009430: 2873 746f 7261 6765 5f6e 616d 653d 7374  (storage_name=st
-00009440: 6f72 6167 655f 6e61 6d65 290a 2020 2020  orage_name).    
-00009450: 7769 7468 2074 656d 7066 696c 652e 4e61  with tempfile.Na
-00009460: 6d65 6454 656d 706f 7261 7279 4669 6c65  medTemporaryFile
-00009470: 2873 7566 6669 783d 272e 7961 6d6c 272c  (suffix='.yaml',
-00009480: 206d 6f64 653d 2777 2729 2061 7320 663a   mode='w') as f:
-00009490: 0a20 2020 2020 2020 2066 2e77 7269 7465  .        f.write
-000094a0: 2863 6f6e 7465 6e74 290a 2020 2020 2020  (content).      
-000094b0: 2020 662e 666c 7573 6828 290a 2020 2020    f.flush().    
-000094c0: 2020 2020 6669 6c65 5f70 6174 6820 3d20      file_path = 
-000094d0: 662e 6e61 6d65 0a20 2020 2020 2020 2074  f.name.        t
-000094e0: 6573 745f 636f 6d6d 616e 6473 203d 205b  est_commands = [
-000094f0: 0a20 2020 2020 2020 2020 2020 202a 7374  .            *st
-00009500: 6f72 6167 655f 7365 7475 705f 636f 6d6d  orage_setup_comm
-00009510: 616e 6473 2c0a 2020 2020 2020 2020 2020  ands,.          
-00009520: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
-00009530: 7920 2d63 207b 6e61 6d65 7d20 2d2d 636c  y -c {name} --cl
-00009540: 6f75 6420 6763 7020 7b66 696c 655f 7061  oud gcp {file_pa
-00009550: 7468 7d27 2c0a 2020 2020 2020 2020 2020  th}',.          
-00009560: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
-00009570: 6d65 7d20 3120 2d2d 7374 6174 7573 272c  me} 1 --status',
-00009580: 2020 2320 456e 7375 7265 206a 6f62 2073    # Ensure job s
-00009590: 7563 6365 6564 6564 2e0a 2020 2020 2020  ucceeded..      
-000095a0: 2020 2020 2020 6627 6773 7574 696c 206c        f'gsutil l
-000095b0: 7320 6773 3a2f 2f7b 7374 6f72 6167 655f  s gs://{storage_
-000095c0: 6e61 6d65 7d2f 6865 6c6c 6f2e 7478 7427  name}/hello.txt'
-000095d0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-000095e0: 736b 7920 7374 6f70 202d 7920 7b6e 616d  sky stop -y {nam
-000095f0: 657d 272c 0a20 2020 2020 2020 2020 2020  e}',.           
-00009600: 2066 2773 6b79 2073 7461 7274 202d 7920   f'sky start -y 
-00009610: 7b6e 616d 657d 272c 0a20 2020 2020 2020  {name}',.       
-00009620: 2020 2020 2023 2043 6865 636b 2069 6620       # Check if 
-00009630: 6865 6c6c 6f2e 7478 7420 6672 6f6d 206d  hello.txt from m
-00009640: 6f75 6e74 696e 6720 6275 636b 6574 2065  ounting bucket e
-00009650: 7869 7374 7320 6166 7465 7220 7265 7374  xists after rest
-00009660: 6172 7420 696e 0a20 2020 2020 2020 2020  art in.         
-00009670: 2020 2023 2074 6865 206d 6f75 6e74 6564     # the mounted
-00009680: 2064 6972 6563 746f 7279 0a20 2020 2020   directory.     
-00009690: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
-000096a0: 6320 7b6e 616d 657d 202d 2d20 2273 6574  c {name} -- "set
-000096b0: 202d 6578 3b20 6c73 202f 6d6f 756e 745f   -ex; ls /mount_
-000096c0: 7072 6976 6174 655f 6d6f 756e 742f 6865  private_mount/he
-000096d0: 6c6c 6f2e 7478 7422 270a 2020 2020 2020  llo.txt"'.      
-000096e0: 2020 5d0a 2020 2020 2020 2020 7465 7374    ].        test
-000096f0: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-00009700: 2020 2020 2027 6763 705f 7374 6f72 6167       'gcp_storag
-00009710: 655f 6d6f 756e 7473 272c 0a20 2020 2020  e_mounts',.     
-00009720: 2020 2020 2020 2074 6573 745f 636f 6d6d         test_comm
-00009730: 616e 6473 2c0a 2020 2020 2020 2020 2020  ands,.          
-00009740: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
-00009750: 7b6e 616d 657d 3b20 736b 7920 7374 6f72  {name}; sky stor
-00009760: 6167 6520 6465 6c65 7465 202d 7920 7b73  age delete -y {s
-00009770: 746f 7261 6765 5f6e 616d 657d 272c 0a20  torage_name}',. 
-00009780: 2020 2020 2020 2020 2020 2074 696d 656f             timeo
-00009790: 7574 3d32 3020 2a20 3630 2c20 2023 2032  ut=20 * 60,  # 2
-000097a0: 3020 6d69 6e73 0a20 2020 2020 2020 2029  0 mins.        )
-000097b0: 0a20 2020 2020 2020 2072 756e 5f6f 6e65  .        run_one
-000097c0: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
-000097d0: 7974 6573 742e 6d61 726b 2e6b 7562 6572  ytest.mark.kuber
-000097e0: 6e65 7465 730a 6465 6620 7465 7374 5f6b  netes.def test_k
-000097f0: 7562 6572 6e65 7465 735f 7374 6f72 6167  ubernetes_storag
-00009800: 655f 6d6f 756e 7473 2829 3a0a 2020 2020  e_mounts():.    
-00009810: 2320 5465 7374 7320 6275 636b 6574 206d  # Tests bucket m
-00009820: 6f75 6e74 696e 6720 6f6e 206b 3873 2c20  ounting on k8s, 
-00009830: 6173 7375 6d69 6e67 2053 3320 6973 2063  assuming S3 is c
-00009840: 6f6e 6669 6775 7265 642e 0a20 2020 2023  onfigured..    #
-00009850: 2054 6869 7320 7465 7374 2077 696c 6c20   This test will 
-00009860: 6661 696c 2069 6620 7275 6e20 6f6e 206e  fail if run on n
-00009870: 6f6e 2078 3836 5f36 3420 6172 6368 6974  on x86_64 archit
-00009880: 6563 7475 7265 2c20 7369 6e63 6520 676f  ecture, since go
-00009890: 6f66 7973 2069 730a 2020 2020 2320 6275  ofys is.    # bu
-000098a0: 696c 7420 666f 7220 7838 365f 3634 206f  ilt for x86_64 o
-000098b0: 6e6c 792e 0a20 2020 206e 616d 6520 3d20  nly..    name = 
-000098c0: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
-000098d0: 6528 290a 2020 2020 7374 6f72 6167 655f  e().    storage_
-000098e0: 6e61 6d65 203d 2066 2773 6b79 2d74 6573  name = f'sky-tes
-000098f0: 742d 7b69 6e74 2874 696d 652e 7469 6d65  t-{int(time.time
-00009900: 2829 297d 270a 2020 2020 7465 6d70 6c61  ())}'.    templa
-00009910: 7465 5f73 7472 203d 2070 6174 686c 6962  te_str = pathlib
-00009920: 2e50 6174 6828 0a20 2020 2020 2020 2027  .Path(.        '
-00009930: 7465 7374 732f 7465 7374 5f79 616d 6c73  tests/test_yamls
-00009940: 2f74 6573 745f 7374 6f72 6167 655f 6d6f  /test_storage_mo
-00009950: 756e 7469 6e67 2e79 616d 6c2e 6a32 2729  unting.yaml.j2')
-00009960: 2e72 6561 645f 7465 7874 2829 0a20 2020  .read_text().   
-00009970: 2074 656d 706c 6174 6520 3d20 6a69 6e6a   template = jinj
-00009980: 6132 2e54 656d 706c 6174 6528 7465 6d70  a2.Template(temp
-00009990: 6c61 7465 5f73 7472 290a 2020 2020 636f  late_str).    co
-000099a0: 6e74 656e 7420 3d20 7465 6d70 6c61 7465  ntent = template
-000099b0: 2e72 656e 6465 7228 7374 6f72 6167 655f  .render(storage_
-000099c0: 6e61 6d65 3d73 746f 7261 6765 5f6e 616d  name=storage_nam
-000099d0: 6529 0a20 2020 2077 6974 6820 7465 6d70  e).    with temp
-000099e0: 6669 6c65 2e4e 616d 6564 5465 6d70 6f72  file.NamedTempor
-000099f0: 6172 7946 696c 6528 7375 6666 6978 3d27  aryFile(suffix='
-00009a00: 2e79 616d 6c27 2c20 6d6f 6465 3d27 7727  .yaml', mode='w'
-00009a10: 2920 6173 2066 3a0a 2020 2020 2020 2020  ) as f:.        
-00009a20: 662e 7772 6974 6528 636f 6e74 656e 7429  f.write(content)
-00009a30: 0a20 2020 2020 2020 2066 2e66 6c75 7368  .        f.flush
-00009a40: 2829 0a20 2020 2020 2020 2066 696c 655f  ().        file_
-00009a50: 7061 7468 203d 2066 2e6e 616d 650a 2020  path = f.name.  
-00009a60: 2020 2020 2020 7465 7374 5f63 6f6d 6d61        test_comma
-00009a70: 6e64 7320 3d20 5b0a 2020 2020 2020 2020  nds = [.        
-00009a80: 2020 2020 2a73 746f 7261 6765 5f73 6574      *storage_set
-00009a90: 7570 5f63 6f6d 6d61 6e64 732c 0a20 2020  up_commands,.   
-00009aa0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00009ab0: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
-00009ac0: 657d 202d 2d63 6c6f 7564 206b 7562 6572  e} --cloud kuber
-00009ad0: 6e65 7465 7320 7b66 696c 655f 7061 7468  netes {file_path
-00009ae0: 7d27 2c0a 2020 2020 2020 2020 2020 2020  }',.            
-00009af0: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
-00009b00: 7d20 3120 2d2d 7374 6174 7573 272c 2020  } 1 --status',  
-00009b10: 2320 456e 7375 7265 206a 6f62 2073 7563  # Ensure job suc
-00009b20: 6365 6564 6564 2e0a 2020 2020 2020 2020  ceeded..        
-00009b30: 2020 2020 6627 6177 7320 7333 206c 7320      f'aws s3 ls 
-00009b40: 7b73 746f 7261 6765 5f6e 616d 657d 2f68  {storage_name}/h
-00009b50: 656c 6c6f 2e74 7874 207c 7c20 270a 2020  ello.txt || '.  
-00009b60: 2020 2020 2020 2020 2020 6627 6773 7574            f'gsut
-00009b70: 696c 206c 7320 6773 3a2f 2f7b 7374 6f72  il ls gs://{stor
-00009b80: 6167 655f 6e61 6d65 7d2f 6865 6c6c 6f2e  age_name}/hello.
-00009b90: 7478 7427 2c0a 2020 2020 2020 2020 5d0a  txt',.        ].
-00009ba0: 2020 2020 2020 2020 7465 7374 203d 2054          test = T
-00009bb0: 6573 7428 0a20 2020 2020 2020 2020 2020  est(.           
-00009bc0: 2027 6b75 6265 726e 6574 6573 5f73 746f   'kubernetes_sto
-00009bd0: 7261 6765 5f6d 6f75 6e74 7327 2c0a 2020  rage_mounts',.  
-00009be0: 2020 2020 2020 2020 2020 7465 7374 5f63            test_c
-00009bf0: 6f6d 6d61 6e64 732c 0a20 2020 2020 2020  ommands,.       
-00009c00: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
-00009c10: 2d79 207b 6e61 6d65 7d3b 2073 6b79 2073  -y {name}; sky s
-00009c20: 746f 7261 6765 2064 656c 6574 6520 2d79  torage delete -y
-00009c30: 207b 7374 6f72 6167 655f 6e61 6d65 7d27   {storage_name}'
-00009c40: 2c0a 2020 2020 2020 2020 2020 2020 7469  ,.            ti
-00009c50: 6d65 6f75 743d 3230 202a 2036 302c 2020  meout=20 * 60,  
-00009c60: 2320 3230 206d 696e 730a 2020 2020 2020  # 20 mins.      
-00009c70: 2020 290a 2020 2020 2020 2020 7275 6e5f    ).        run_
-00009c80: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
-00009c90: 0a40 7079 7465 7374 2e6d 6172 6b2e 7061  .@pytest.mark.pa
-00009ca0: 7261 6d65 7472 697a 6528 0a20 2020 2022  rametrize(.    "
-00009cb0: 696d 6167 655f 6964 222c 0a20 2020 205b  image_id",.    [
-00009cc0: 0a20 2020 2020 2020 2022 646f 636b 6572  .        "docker
-00009cd0: 3a6e 7669 6469 612f 6375 6461 3a31 312e  :nvidia/cuda:11.
-00009ce0: 382e 302d 6465 7665 6c2d 7562 756e 7475  8.0-devel-ubuntu
-00009cf0: 3138 2e30 3422 2c0a 2020 2020 2020 2020  18.04",.        
-00009d00: 2264 6f63 6b65 723a 7562 756e 7475 3a31  "docker:ubuntu:1
-00009d10: 382e 3034 222c 0a20 2020 2020 2020 2023  8.04",.        #
-00009d20: 2054 6573 7420 6c61 7465 7374 2069 6d61   Test latest ima
-00009d30: 6765 2077 6974 6820 7079 7468 6f6e 2033  ge with python 3
-00009d40: 2e31 3120 696e 7374 616c 6c65 6420 6279  .11 installed by
-00009d50: 2064 6566 6175 6c74 2e0a 2020 2020 2020   default..      
-00009d60: 2020 2320 446f 6573 206e 6f74 2077 6f72    # Does not wor
-00009d70: 6b20 666f 7220 7079 7468 6f6e 2033 2e31  k for python 3.1
-00009d80: 3220 6475 6520 746f 2072 6179 2773 2072  2 due to ray's r
-00009d90: 6571 7569 7265 6d65 6e74 2066 6f72 2033  equirement for 3
-00009da0: 2e31 312e 0a20 2020 2020 2020 2027 646f  .11..        'do
-00009db0: 636b 6572 3a63 6f6e 7469 6e75 756d 696f  cker:continuumio
-00009dc0: 2f6d 696e 6963 6f6e 6461 333a 3234 2e31  /miniconda3:24.1
-00009dd0: 2e32 2d30 272c 0a20 2020 205d 290a 6465  .2-0',.    ]).de
-00009de0: 6620 7465 7374 5f64 6f63 6b65 725f 7374  f test_docker_st
-00009df0: 6f72 6167 655f 6d6f 756e 7473 2867 656e  orage_mounts(gen
-00009e00: 6572 6963 5f63 6c6f 7564 3a20 7374 722c  eric_cloud: str,
-00009e10: 2069 6d61 6765 5f69 643a 2073 7472 293a   image_id: str):
-00009e20: 0a20 2020 2023 2054 6573 7473 2062 7563  .    # Tests buc
-00009e30: 6b65 7420 6d6f 756e 7469 6e67 206f 6e20  ket mounting on 
-00009e40: 646f 636b 6572 2063 6f6e 7461 696e 6572  docker container
-00009e50: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
-00009e60: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
-00009e70: 2020 2020 7469 6d65 7374 616d 7020 3d20      timestamp = 
-00009e80: 7374 7228 7469 6d65 2e74 696d 6528 2929  str(time.time())
-00009e90: 2e72 6570 6c61 6365 2827 2e27 2c20 2727  .replace('.', ''
-00009ea0: 290a 2020 2020 7374 6f72 6167 655f 6e61  ).    storage_na
-00009eb0: 6d65 203d 2066 2773 6b79 2d74 6573 742d  me = f'sky-test-
-00009ec0: 7b74 696d 6573 7461 6d70 7d27 0a20 2020  {timestamp}'.   
-00009ed0: 2074 656d 706c 6174 655f 7374 7220 3d20   template_str = 
-00009ee0: 7061 7468 6c69 622e 5061 7468 280a 2020  pathlib.Path(.  
-00009ef0: 2020 2020 2020 2774 6573 7473 2f74 6573        'tests/tes
-00009f00: 745f 7961 6d6c 732f 7465 7374 5f73 746f  t_yamls/test_sto
-00009f10: 7261 6765 5f6d 6f75 6e74 696e 672e 7961  rage_mounting.ya
-00009f20: 6d6c 2e6a 3227 292e 7265 6164 5f74 6578  ml.j2').read_tex
-00009f30: 7428 290a 2020 2020 7465 6d70 6c61 7465  t().    template
-00009f40: 203d 206a 696e 6a61 322e 5465 6d70 6c61   = jinja2.Templa
-00009f50: 7465 2874 656d 706c 6174 655f 7374 7229  te(template_str)
-00009f60: 0a20 2020 2063 6f6e 7465 6e74 203d 2074  .    content = t
-00009f70: 656d 706c 6174 652e 7265 6e64 6572 2873  emplate.render(s
-00009f80: 746f 7261 6765 5f6e 616d 653d 7374 6f72  torage_name=stor
-00009f90: 6167 655f 6e61 6d65 290a 2020 2020 7769  age_name).    wi
-00009fa0: 7468 2074 656d 7066 696c 652e 4e61 6d65  th tempfile.Name
-00009fb0: 6454 656d 706f 7261 7279 4669 6c65 2873  dTemporaryFile(s
-00009fc0: 7566 6669 783d 272e 7961 6d6c 272c 206d  uffix='.yaml', m
-00009fd0: 6f64 653d 2777 2729 2061 7320 663a 0a20  ode='w') as f:. 
-00009fe0: 2020 2020 2020 2066 2e77 7269 7465 2863         f.write(c
-00009ff0: 6f6e 7465 6e74 290a 2020 2020 2020 2020  ontent).        
-0000a000: 662e 666c 7573 6828 290a 2020 2020 2020  f.flush().      
-0000a010: 2020 6669 6c65 5f70 6174 6820 3d20 662e    file_path = f.
-0000a020: 6e61 6d65 0a20 2020 2020 2020 2074 6573  name.        tes
-0000a030: 745f 636f 6d6d 616e 6473 203d 205b 0a20  t_commands = [. 
-0000a040: 2020 2020 2020 2020 2020 202a 7374 6f72             *stor
-0000a050: 6167 655f 7365 7475 705f 636f 6d6d 616e  age_setup_comman
-0000a060: 6473 2c0a 2020 2020 2020 2020 2020 2020  ds,.            
-0000a070: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
-0000a080: 2d63 207b 6e61 6d65 7d20 2d2d 636c 6f75  -c {name} --clou
-0000a090: 6420 7b67 656e 6572 6963 5f63 6c6f 7564  d {generic_cloud
-0000a0a0: 7d20 2d2d 696d 6167 652d 6964 207b 696d  } --image-id {im
-0000a0b0: 6167 655f 6964 7d20 7b66 696c 655f 7061  age_id} {file_pa
-0000a0c0: 7468 7d27 2c0a 2020 2020 2020 2020 2020  th}',.          
-0000a0d0: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
-0000a0e0: 6d65 7d20 3120 2d2d 7374 6174 7573 272c  me} 1 --status',
-0000a0f0: 2020 2320 456e 7375 7265 206a 6f62 2073    # Ensure job s
-0000a100: 7563 6365 6564 6564 2e0a 2020 2020 2020  ucceeded..      
-0000a110: 2020 2020 2020 6627 6177 7320 7333 206c        f'aws s3 l
-0000a120: 7320 7b73 746f 7261 6765 5f6e 616d 657d  s {storage_name}
-0000a130: 2f68 656c 6c6f 2e74 7874 207c 7c20 270a  /hello.txt || '.
-0000a140: 2020 2020 2020 2020 2020 2020 6627 6773              f'gs
-0000a150: 7574 696c 206c 7320 6773 3a2f 2f7b 7374  util ls gs://{st
-0000a160: 6f72 6167 655f 6e61 6d65 7d2f 6865 6c6c  orage_name}/hell
-0000a170: 6f2e 7478 7427 2c0a 2020 2020 2020 2020  o.txt',.        
-0000a180: 5d0a 2020 2020 2020 2020 7465 7374 203d  ].        test =
-0000a190: 2054 6573 7428 0a20 2020 2020 2020 2020   Test(.         
-0000a1a0: 2020 2027 646f 636b 6572 5f73 746f 7261     'docker_stora
-0000a1b0: 6765 5f6d 6f75 6e74 7327 2c0a 2020 2020  ge_mounts',.    
-0000a1c0: 2020 2020 2020 2020 7465 7374 5f63 6f6d          test_com
-0000a1d0: 6d61 6e64 732c 0a20 2020 2020 2020 2020  mands,.         
-0000a1e0: 2020 2066 2773 6b79 2064 6f77 6e20 2d79     f'sky down -y
-0000a1f0: 207b 6e61 6d65 7d3b 2073 6b79 2073 746f   {name}; sky sto
-0000a200: 7261 6765 2064 656c 6574 6520 2d79 207b  rage delete -y {
-0000a210: 7374 6f72 6167 655f 6e61 6d65 7d27 2c0a  storage_name}',.
-0000a220: 2020 2020 2020 2020 2020 2020 7469 6d65              time
-0000a230: 6f75 743d 3230 202a 2036 302c 2020 2320  out=20 * 60,  # 
-0000a240: 3230 206d 696e 730a 2020 2020 2020 2020  20 mins.        
-0000a250: 290a 2020 2020 2020 2020 7275 6e5f 6f6e  ).        run_on
-0000a260: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
-0000a270: 7079 7465 7374 2e6d 6172 6b2e 636c 6f75  pytest.mark.clou
-0000a280: 6466 6c61 7265 0a64 6566 2074 6573 745f  dflare.def test_
-0000a290: 636c 6f75 6466 6c61 7265 5f73 746f 7261  cloudflare_stora
-0000a2a0: 6765 5f6d 6f75 6e74 7328 6765 6e65 7269  ge_mounts(generi
-0000a2b0: 635f 636c 6f75 643a 2073 7472 293a 0a20  c_cloud: str):. 
-0000a2c0: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
-0000a2d0: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
-0000a2e0: 2020 7374 6f72 6167 655f 6e61 6d65 203d    storage_name =
-0000a2f0: 2066 2773 6b79 2d74 6573 742d 7b69 6e74   f'sky-test-{int
-0000a300: 2874 696d 652e 7469 6d65 2829 297d 270a  (time.time())}'.
-0000a310: 2020 2020 7465 6d70 6c61 7465 5f73 7472      template_str
-0000a320: 203d 2070 6174 686c 6962 2e50 6174 6828   = pathlib.Path(
-0000a330: 0a20 2020 2020 2020 2027 7465 7374 732f  .        'tests/
-0000a340: 7465 7374 5f79 616d 6c73 2f74 6573 745f  test_yamls/test_
-0000a350: 7232 5f73 746f 7261 6765 5f6d 6f75 6e74  r2_storage_mount
-0000a360: 696e 672e 7961 6d6c 2729 2e72 6561 645f  ing.yaml').read_
-0000a370: 7465 7874 2829 0a20 2020 2074 656d 706c  text().    templ
-0000a380: 6174 6520 3d20 6a69 6e6a 6132 2e54 656d  ate = jinja2.Tem
-0000a390: 706c 6174 6528 7465 6d70 6c61 7465 5f73  plate(template_s
-0000a3a0: 7472 290a 2020 2020 636f 6e74 656e 7420  tr).    content 
-0000a3b0: 3d20 7465 6d70 6c61 7465 2e72 656e 6465  = template.rende
-0000a3c0: 7228 7374 6f72 6167 655f 6e61 6d65 3d73  r(storage_name=s
-0000a3d0: 746f 7261 6765 5f6e 616d 6529 0a20 2020  torage_name).   
-0000a3e0: 2065 6e64 706f 696e 745f 7572 6c20 3d20   endpoint_url = 
-0000a3f0: 636c 6f75 6466 6c61 7265 2e63 7265 6174  cloudflare.creat
-0000a400: 655f 656e 6470 6f69 6e74 2829 0a20 2020  e_endpoint().   
-0000a410: 2077 6974 6820 7465 6d70 6669 6c65 2e4e   with tempfile.N
-0000a420: 616d 6564 5465 6d70 6f72 6172 7946 696c  amedTemporaryFil
-0000a430: 6528 7375 6666 6978 3d27 2e79 616d 6c27  e(suffix='.yaml'
-0000a440: 2c20 6d6f 6465 3d27 7727 2920 6173 2066  , mode='w') as f
-0000a450: 3a0a 2020 2020 2020 2020 662e 7772 6974  :.        f.writ
-0000a460: 6528 636f 6e74 656e 7429 0a20 2020 2020  e(content).     
-0000a470: 2020 2066 2e66 6c75 7368 2829 0a20 2020     f.flush().   
-0000a480: 2020 2020 2066 696c 655f 7061 7468 203d       file_path =
-0000a490: 2066 2e6e 616d 650a 2020 2020 2020 2020   f.name.        
-0000a4a0: 7465 7374 5f63 6f6d 6d61 6e64 7320 3d20  test_commands = 
-0000a4b0: 5b0a 2020 2020 2020 2020 2020 2020 2a73  [.            *s
-0000a4c0: 746f 7261 6765 5f73 6574 7570 5f63 6f6d  torage_setup_com
-0000a4d0: 6d61 6e64 732c 0a20 2020 2020 2020 2020  mands,.         
-0000a4e0: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
-0000a4f0: 2d79 202d 6320 7b6e 616d 657d 202d 2d63  -y -c {name} --c
-0000a500: 6c6f 7564 207b 6765 6e65 7269 635f 636c  loud {generic_cl
-0000a510: 6f75 647d 207b 6669 6c65 5f70 6174 687d  oud} {file_path}
-0000a520: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0000a530: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-0000a540: 2031 202d 2d73 7461 7475 7327 2c20 2023   1 --status',  #
-0000a550: 2045 6e73 7572 6520 6a6f 6220 7375 6363   Ensure job succ
-0000a560: 6565 6465 642e 0a20 2020 2020 2020 2020  eeded..         
-0000a570: 2020 2066 2741 5753 5f53 4841 5245 445f     f'AWS_SHARED_
-0000a580: 4352 4544 454e 5449 414c 535f 4649 4c45  CREDENTIALS_FILE
-0000a590: 3d7b 636c 6f75 6466 6c61 7265 2e52 325f  ={cloudflare.R2_
-0000a5a0: 4352 4544 454e 5449 414c 535f 5041 5448  CREDENTIALS_PATH
-0000a5b0: 7d20 6177 7320 7333 206c 7320 7333 3a2f  } aws s3 ls s3:/
-0000a5c0: 2f7b 7374 6f72 6167 655f 6e61 6d65 7d2f  /{storage_name}/
-0000a5d0: 6865 6c6c 6f2e 7478 7420 2d2d 656e 6470  hello.txt --endp
-0000a5e0: 6f69 6e74 207b 656e 6470 6f69 6e74 5f75  oint {endpoint_u
-0000a5f0: 726c 7d20 2d2d 7072 6f66 696c 653d 7232  rl} --profile=r2
-0000a600: 270a 2020 2020 2020 2020 5d0a 0a20 2020  '.        ]..   
-0000a610: 2020 2020 2074 6573 7420 3d20 5465 7374       test = Test
-0000a620: 280a 2020 2020 2020 2020 2020 2020 2763  (.            'c
-0000a630: 6c6f 7564 666c 6172 655f 7374 6f72 6167  loudflare_storag
-0000a640: 655f 6d6f 756e 7473 272c 0a20 2020 2020  e_mounts',.     
-0000a650: 2020 2020 2020 2074 6573 745f 636f 6d6d         test_comm
-0000a660: 616e 6473 2c0a 2020 2020 2020 2020 2020  ands,.          
-0000a670: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
-0000a680: 7b6e 616d 657d 3b20 736b 7920 7374 6f72  {name}; sky stor
-0000a690: 6167 6520 6465 6c65 7465 202d 7920 7b73  age delete -y {s
-0000a6a0: 746f 7261 6765 5f6e 616d 657d 272c 0a20  torage_name}',. 
-0000a6b0: 2020 2020 2020 2020 2020 2074 696d 656f             timeo
-0000a6c0: 7574 3d32 3020 2a20 3630 2c20 2023 2032  ut=20 * 60,  # 2
-0000a6d0: 3020 6d69 6e73 0a20 2020 2020 2020 2029  0 mins.        )
-0000a6e0: 0a20 2020 2020 2020 2072 756e 5f6f 6e65  .        run_one
-0000a6f0: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
-0000a700: 7974 6573 742e 6d61 726b 2e69 626d 0a64  ytest.mark.ibm.d
-0000a710: 6566 2074 6573 745f 6962 6d5f 7374 6f72  ef test_ibm_stor
-0000a720: 6167 655f 6d6f 756e 7473 2829 3a0a 2020  age_mounts():.  
-0000a730: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
-0000a740: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
-0000a750: 2073 746f 7261 6765 5f6e 616d 6520 3d20   storage_name = 
-0000a760: 6627 736b 792d 7465 7374 2d7b 696e 7428  f'sky-test-{int(
-0000a770: 7469 6d65 2e74 696d 6528 2929 7d27 0a20  time.time())}'. 
-0000a780: 2020 2062 7563 6b65 745f 7263 6c6f 6e65     bucket_rclone
-0000a790: 5f70 726f 6669 6c65 203d 2052 636c 6f6e  _profile = Rclon
-0000a7a0: 652e 6765 6e65 7261 7465 5f72 636c 6f6e  e.generate_rclon
-0000a7b0: 655f 6275 636b 6574 5f70 726f 6669 6c65  e_bucket_profile
-0000a7c0: 5f6e 616d 6528 0a20 2020 2020 2020 2073  _name(.        s
-0000a7d0: 746f 7261 6765 5f6e 616d 652c 2052 636c  torage_name, Rcl
-0000a7e0: 6f6e 652e 5263 6c6f 6e65 436c 6f75 6473  one.RcloneClouds
-0000a7f0: 2e49 424d 290a 2020 2020 7465 6d70 6c61  .IBM).    templa
-0000a800: 7465 5f73 7472 203d 2070 6174 686c 6962  te_str = pathlib
-0000a810: 2e50 6174 6828 0a20 2020 2020 2020 2027  .Path(.        '
-0000a820: 7465 7374 732f 7465 7374 5f79 616d 6c73  tests/test_yamls
-0000a830: 2f74 6573 745f 6962 6d5f 636f 735f 7374  /test_ibm_cos_st
-0000a840: 6f72 6167 655f 6d6f 756e 7469 6e67 2e79  orage_mounting.y
-0000a850: 616d 6c27 292e 7265 6164 5f74 6578 7428  aml').read_text(
-0000a860: 290a 2020 2020 7465 6d70 6c61 7465 203d  ).    template =
-0000a870: 206a 696e 6a61 322e 5465 6d70 6c61 7465   jinja2.Template
-0000a880: 2874 656d 706c 6174 655f 7374 7229 0a20  (template_str). 
-0000a890: 2020 2063 6f6e 7465 6e74 203d 2074 656d     content = tem
-0000a8a0: 706c 6174 652e 7265 6e64 6572 2873 746f  plate.render(sto
-0000a8b0: 7261 6765 5f6e 616d 653d 7374 6f72 6167  rage_name=storag
-0000a8c0: 655f 6e61 6d65 290a 2020 2020 7769 7468  e_name).    with
-0000a8d0: 2074 656d 7066 696c 652e 4e61 6d65 6454   tempfile.NamedT
-0000a8e0: 656d 706f 7261 7279 4669 6c65 2873 7566  emporaryFile(suf
-0000a8f0: 6669 783d 272e 7961 6d6c 272c 206d 6f64  fix='.yaml', mod
-0000a900: 653d 2777 2729 2061 7320 663a 0a20 2020  e='w') as f:.   
-0000a910: 2020 2020 2066 2e77 7269 7465 2863 6f6e       f.write(con
-0000a920: 7465 6e74 290a 2020 2020 2020 2020 662e  tent).        f.
-0000a930: 666c 7573 6828 290a 2020 2020 2020 2020  flush().        
-0000a940: 6669 6c65 5f70 6174 6820 3d20 662e 6e61  file_path = f.na
-0000a950: 6d65 0a20 2020 2020 2020 2074 6573 745f  me.        test_
-0000a960: 636f 6d6d 616e 6473 203d 205b 0a20 2020  commands = [.   
-0000a970: 2020 2020 2020 2020 202a 7374 6f72 6167           *storag
-0000a980: 655f 7365 7475 705f 636f 6d6d 616e 6473  e_setup_commands
-0000a990: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0000a9a0: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
-0000a9b0: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
-0000a9c0: 6962 6d20 7b66 696c 655f 7061 7468 7d27  ibm {file_path}'
-0000a9d0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0000a9e0: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-0000a9f0: 3120 2d2d 7374 6174 7573 272c 2020 2320  1 --status',  # 
-0000aa00: 456e 7375 7265 206a 6f62 2073 7563 6365  Ensure job succe
-0000aa10: 6564 6564 2e0a 2020 2020 2020 2020 2020  eded..          
-0000aa20: 2020 6627 7263 6c6f 6e65 206c 7320 7b62    f'rclone ls {b
-0000aa30: 7563 6b65 745f 7263 6c6f 6e65 5f70 726f  ucket_rclone_pro
-0000aa40: 6669 6c65 7d3a 7b73 746f 7261 6765 5f6e  file}:{storage_n
-0000aa50: 616d 657d 2f68 656c 6c6f 2e74 7874 272c  ame}/hello.txt',
-0000aa60: 0a20 2020 2020 2020 205d 0a20 2020 2020  .        ].     
-0000aa70: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
-0000aa80: 2020 2020 2020 2020 2020 2020 2769 626d              'ibm
-0000aa90: 5f73 746f 7261 6765 5f6d 6f75 6e74 7327  _storage_mounts'
-0000aaa0: 2c0a 2020 2020 2020 2020 2020 2020 7465  ,.            te
-0000aab0: 7374 5f63 6f6d 6d61 6e64 732c 0a20 2020  st_commands,.   
-0000aac0: 2020 2020 2020 2020 2066 2773 6b79 2064           f'sky d
-0000aad0: 6f77 6e20 2d79 207b 6e61 6d65 7d3b 2073  own -y {name}; s
-0000aae0: 6b79 2073 746f 7261 6765 2064 656c 6574  ky storage delet
-0000aaf0: 6520 2d79 207b 7374 6f72 6167 655f 6e61  e -y {storage_na
-0000ab00: 6d65 7d27 2c0a 2020 2020 2020 2020 2020  me}',.          
-0000ab10: 2020 7469 6d65 6f75 743d 3230 202a 2036    timeout=20 * 6
-0000ab20: 302c 2020 2320 3230 206d 696e 730a 2020  0,  # 20 mins.  
-0000ab30: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0000ab40: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-0000ab50: 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d  t)...# ---------
-0000ab60: 2d20 434c 4920 6c6f 6773 202d 2d2d 2d2d  - CLI logs -----
-0000ab70: 2d2d 2d2d 2d0a 4070 7974 6573 742e 6d61  -----.@pytest.ma
-0000ab80: 726b 2e6e 6f5f 7363 7020 2023 2053 4350  rk.no_scp  # SCP
-0000ab90: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
-0000aba0: 7420 6e75 6d5f 6e6f 6465 7320 3e20 3120  t num_nodes > 1 
-0000abb0: 7965 742e 2052 756e 2074 6573 745f 7363  yet. Run test_sc
-0000abc0: 705f 6c6f 6773 2069 6e73 7465 6164 2e0a  p_logs instead..
-0000abd0: 6465 6620 7465 7374 5f63 6c69 5f6c 6f67  def test_cli_log
-0000abe0: 7328 6765 6e65 7269 635f 636c 6f75 643a  s(generic_cloud:
-0000abf0: 2073 7472 293a 0a20 2020 206e 616d 6520   str):.    name 
-0000ac00: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
-0000ac10: 616d 6528 290a 2020 2020 6e75 6d5f 6e6f  ame().    num_no
-0000ac20: 6465 7320 3d20 320a 2020 2020 6966 2067  des = 2.    if g
-0000ac30: 656e 6572 6963 5f63 6c6f 7564 203d 3d20  eneric_cloud == 
-0000ac40: 276b 7562 6572 6e65 7465 7327 3a0a 2020  'kubernetes':.  
-0000ac50: 2020 2020 2020 2320 4b75 6265 726e 6574        # Kubernet
-0000ac60: 6573 2064 6f65 7320 6e6f 7420 7375 7070  es does not supp
-0000ac70: 6f72 7420 6d75 6c74 692d 6e6f 6465 0a20  ort multi-node. 
-0000ac80: 2020 2020 2020 206e 756d 5f6e 6f64 6573         num_nodes
-0000ac90: 203d 2031 0a20 2020 2074 696d 6573 7461   = 1.    timesta
-0000aca0: 6d70 203d 2074 696d 652e 7469 6d65 2829  mp = time.time()
-0000acb0: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
-0000acc0: 2827 636c 695f 6c6f 6773 272c 205b 0a20  ('cli_logs', [. 
-0000acd0: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
-0000ace0: 6e63 6820 2d79 202d 6320 7b6e 616d 657d  nch -y -c {name}
-0000acf0: 202d 2d63 6c6f 7564 207b 6765 6e65 7269   --cloud {generi
-0000ad00: 635f 636c 6f75 647d 202d 2d6e 756d 2d6e  c_cloud} --num-n
-0000ad10: 6f64 6573 207b 6e75 6d5f 6e6f 6465 737d  odes {num_nodes}
-0000ad20: 2022 6563 686f 207b 7469 6d65 7374 616d   "echo {timestam
-0000ad30: 707d 2031 2227 2c0a 2020 2020 2020 2020  p} 1"',.        
-0000ad40: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
-0000ad50: 7d20 2265 6368 6f20 7b74 696d 6573 7461  } "echo {timesta
-0000ad60: 6d70 7d20 3222 272c 0a20 2020 2020 2020  mp} 2"',.       
-0000ad70: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
-0000ad80: 657d 2022 6563 686f 207b 7469 6d65 7374  e} "echo {timest
-0000ad90: 616d 707d 2033 2227 2c0a 2020 2020 2020  amp} 3"',.      
-0000ada0: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
-0000adb0: 6d65 7d20 2265 6368 6f20 7b74 696d 6573  me} "echo {times
-0000adc0: 7461 6d70 7d20 3422 272c 0a20 2020 2020  tamp} 4"',.     
-0000add0: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
-0000ade0: 616d 657d 2032 202d 2d73 7461 7475 7327  ame} 2 --status'
-0000adf0: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
-0000ae00: 6c6f 6773 207b 6e61 6d65 7d20 3320 3420  logs {name} 3 4 
-0000ae10: 2d2d 7379 6e63 2d64 6f77 6e27 2c0a 2020  --sync-down',.  
-0000ae20: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
-0000ae30: 207b 6e61 6d65 7d20 2a20 2d2d 7379 6e63   {name} * --sync
-0000ae40: 2d64 6f77 6e27 2c0a 2020 2020 2020 2020  -down',.        
-0000ae50: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
-0000ae60: 7d20 3120 7c20 6772 6570 2022 7b74 696d  } 1 | grep "{tim
-0000ae70: 6573 7461 6d70 7d20 3122 272c 0a20 2020  estamp} 1"',.   
-0000ae80: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-0000ae90: 7b6e 616d 657d 207c 2067 7265 7020 227b  {name} | grep "{
-0000aea0: 7469 6d65 7374 616d 707d 2034 2227 2c0a  timestamp} 4"',.
-0000aeb0: 2020 2020 5d2c 2066 2773 6b79 2064 6f77      ], f'sky dow
-0000aec0: 6e20 2d79 207b 6e61 6d65 7d27 290a 2020  n -y {name}').  
-0000aed0: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
-0000aee0: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
-0000aef0: 6172 6b2e 7363 700a 6465 6620 7465 7374  ark.scp.def test
-0000af00: 5f73 6370 5f6c 6f67 7328 293a 0a20 2020  _scp_logs():.   
-0000af10: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
-0000af20: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
-0000af30: 7469 6d65 7374 616d 7020 3d20 7469 6d65  timestamp = time
-0000af40: 2e74 696d 6528 290a 2020 2020 7465 7374  .time().    test
-0000af50: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-0000af60: 2027 5343 505f 636c 695f 6c6f 6773 272c   'SCP_cli_logs',
-0000af70: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
-0000af80: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
-0000af90: 6e63 6820 2d79 202d 6320 7b6e 616d 657d  nch -y -c {name}
-0000afa0: 207b 5343 505f 5459 5045 7d20 2265 6368   {SCP_TYPE} "ech
-0000afb0: 6f20 7b74 696d 6573 7461 6d70 7d20 3122  o {timestamp} 1"
-0000afc0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0000afd0: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
-0000afe0: 2022 6563 686f 207b 7469 6d65 7374 616d   "echo {timestam
-0000aff0: 707d 2032 2227 2c0a 2020 2020 2020 2020  p} 2"',.        
-0000b000: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
-0000b010: 6e61 6d65 7d20 2265 6368 6f20 7b74 696d  name} "echo {tim
-0000b020: 6573 7461 6d70 7d20 3322 272c 0a20 2020  estamp} 3"',.   
-0000b030: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
-0000b040: 7865 6320 7b6e 616d 657d 2022 6563 686f  xec {name} "echo
-0000b050: 207b 7469 6d65 7374 616d 707d 2034 2227   {timestamp} 4"'
-0000b060: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0000b070: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-0000b080: 3220 2d2d 7374 6174 7573 272c 0a20 2020  2 --status',.   
-0000b090: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-0000b0a0: 6f67 7320 7b6e 616d 657d 2033 2034 202d  ogs {name} 3 4 -
-0000b0b0: 2d73 796e 632d 646f 776e 272c 0a20 2020  -sync-down',.   
-0000b0c0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-0000b0d0: 6f67 7320 7b6e 616d 657d 202a 202d 2d73  ogs {name} * --s
-0000b0e0: 796e 632d 646f 776e 272c 0a20 2020 2020  ync-down',.     
-0000b0f0: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-0000b100: 7320 7b6e 616d 657d 2031 207c 2067 7265  s {name} 1 | gre
-0000b110: 7020 227b 7469 6d65 7374 616d 707d 2031  p "{timestamp} 1
-0000b120: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-0000b130: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
-0000b140: 7d20 7c20 6772 6570 2022 7b74 696d 6573  } | grep "{times
-0000b150: 7461 6d70 7d20 3422 272c 0a20 2020 2020  tamp} 4"',.     
-0000b160: 2020 205d 2c0a 2020 2020 2020 2020 6627     ],.        f'
-0000b170: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
-0000b180: 657d 272c 0a20 2020 2029 0a20 2020 2072  e}',.    ).    r
-0000b190: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
-0000b1a0: 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d  )...# ----------
-0000b1b0: 204a 6f62 2051 7565 7565 2e20 2d2d 2d2d   Job Queue. ----
-0000b1c0: 2d2d 2d2d 2d2d 0a40 7079 7465 7374 2e6d  ------.@pytest.m
-0000b1d0: 6172 6b2e 6e6f 5f66 6c75 6964 7374 6163  ark.no_fluidstac
-0000b1e0: 6b20 2023 2046 6c75 6964 5374 6163 6b20  k  # FluidStack 
-0000b1f0: 4443 2068 6173 206c 6f77 2061 7661 696c  DC has low avail
-0000b200: 6162 696c 6974 7920 6f66 2054 3420 4750  ability of T4 GP
-0000b210: 5573 0a40 7079 7465 7374 2e6d 6172 6b2e  Us.@pytest.mark.
-0000b220: 6e6f 5f6c 616d 6264 615f 636c 6f75 6420  no_lambda_cloud 
-0000b230: 2023 204c 616d 6264 6120 436c 6f75 6420   # Lambda Cloud 
-0000b240: 646f 6573 206e 6f74 2068 6176 6520 5434  does not have T4
-0000b250: 2067 7075 730a 4070 7974 6573 742e 6d61   gpus.@pytest.ma
-0000b260: 726b 2e6e 6f5f 6962 6d20 2023 2049 424d  rk.no_ibm  # IBM
-0000b270: 2043 6c6f 7564 2064 6f65 7320 6e6f 7420   Cloud does not 
-0000b280: 6861 7665 2054 3420 6770 7573 2e20 7275  have T4 gpus. ru
-0000b290: 6e20 7465 7374 5f69 626d 5f6a 6f62 5f71  n test_ibm_job_q
-0000b2a0: 7565 7565 2069 6e73 7465 6164 0a40 7079  ueue instead.@py
-0000b2b0: 7465 7374 2e6d 6172 6b2e 6e6f 5f73 6370  test.mark.no_scp
-0000b2c0: 2020 2320 5343 5020 646f 6573 206e 6f74    # SCP does not
-0000b2d0: 2068 6176 6520 5434 2067 7075 732e 2052   have T4 gpus. R
-0000b2e0: 756e 2074 6573 745f 7363 705f 6a6f 625f  un test_scp_job_
-0000b2f0: 7175 6575 6520 696e 7374 6561 640a 4070  queue instead.@p
-0000b300: 7974 6573 742e 6d61 726b 2e6e 6f5f 7061  ytest.mark.no_pa
-0000b310: 7065 7273 7061 6365 2020 2320 5061 7065  perspace  # Pape
-0000b320: 7273 7061 6365 2064 6f65 7320 6e6f 7420  rspace does not 
-0000b330: 6861 7665 2054 3420 6770 7573 2e0a 4070  have T4 gpus..@p
-0000b340: 7974 6573 742e 6d61 726b 2e6e 6f5f 6f63  ytest.mark.no_oc
-0000b350: 6920 2023 204f 4349 2064 6f65 7320 6e6f  i  # OCI does no
-0000b360: 7420 6861 7665 2054 3420 6770 7573 0a64  t have T4 gpus.d
-0000b370: 6566 2074 6573 745f 6a6f 625f 7175 6575  ef test_job_queu
-0000b380: 6528 6765 6e65 7269 635f 636c 6f75 643a  e(generic_cloud:
-0000b390: 2073 7472 293a 0a20 2020 206e 616d 6520   str):.    name 
-0000b3a0: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
-0000b3b0: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
-0000b3c0: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
-0000b3d0: 6a6f 625f 7175 6575 6527 2c0a 2020 2020  job_queue',.    
-0000b3e0: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
-0000b3f0: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
-0000b400: 7920 2d63 207b 6e61 6d65 7d20 2d2d 636c  y -c {name} --cl
-0000b410: 6f75 6420 7b67 656e 6572 6963 5f63 6c6f  oud {generic_clo
-0000b420: 7564 7d20 6578 616d 706c 6573 2f6a 6f62  ud} examples/job
-0000b430: 5f71 7565 7565 2f63 6c75 7374 6572 2e79  _queue/cluster.y
-0000b440: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-0000b450: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
-0000b460: 6d65 7d20 2d6e 207b 6e61 6d65 7d2d 3120  me} -n {name}-1 
-0000b470: 2d64 2065 7861 6d70 6c65 732f 6a6f 625f  -d examples/job_
-0000b480: 7175 6575 652f 6a6f 622e 7961 6d6c 272c  queue/job.yaml',
-0000b490: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000b4a0: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
-0000b4b0: 6e20 7b6e 616d 657d 2d32 202d 6420 6578  n {name}-2 -d ex
-0000b4c0: 616d 706c 6573 2f6a 6f62 5f71 7565 7565  amples/job_queue
-0000b4d0: 2f6a 6f62 2e79 616d 6c27 2c0a 2020 2020  /job.yaml',.    
-0000b4e0: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
-0000b4f0: 6563 207b 6e61 6d65 7d20 2d6e 207b 6e61  ec {name} -n {na
-0000b500: 6d65 7d2d 3320 2d64 2065 7861 6d70 6c65  me}-3 -d example
-0000b510: 732f 6a6f 625f 7175 6575 652f 6a6f 622e  s/job_queue/job.
-0000b520: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
-0000b530: 2020 2066 2773 3d24 2873 6b79 2071 7565     f's=$(sky que
-0000b540: 7565 207b 6e61 6d65 7d29 3b20 6563 686f  ue {name}); echo
-0000b550: 2022 2473 223b 2065 6368 6f3b 2065 6368   "$s"; echo; ech
-0000b560: 6f3b 2065 6368 6f20 2224 7322 207c 2067  o; echo "$s" | g
-0000b570: 7265 7020 7b6e 616d 657d 2d31 207c 2067  rep {name}-1 | g
-0000b580: 7265 7020 5255 4e4e 494e 4727 2c0a 2020  rep RUNNING',.  
-0000b590: 2020 2020 2020 2020 2020 6627 733d 2428            f's=$(
-0000b5a0: 736b 7920 7175 6575 6520 7b6e 616d 657d  sky queue {name}
-0000b5b0: 293b 2065 6368 6f20 2224 7322 3b20 6563  ); echo "$s"; ec
-0000b5c0: 686f 3b20 6563 686f 3b20 6563 686f 2022  ho; echo; echo "
-0000b5d0: 2473 2220 7c20 6772 6570 207b 6e61 6d65  $s" | grep {name
-0000b5e0: 7d2d 3220 7c20 6772 6570 2052 554e 4e49  }-2 | grep RUNNI
-0000b5f0: 4e47 272c 0a20 2020 2020 2020 2020 2020  NG',.           
-0000b600: 2066 2773 3d24 2873 6b79 2071 7565 7565   f's=$(sky queue
-0000b610: 207b 6e61 6d65 7d29 3b20 6563 686f 2022   {name}); echo "
-0000b620: 2473 223b 2065 6368 6f3b 2065 6368 6f3b  $s"; echo; echo;
-0000b630: 2065 6368 6f20 2224 7322 207c 2067 7265   echo "$s" | gre
-0000b640: 7020 7b6e 616d 657d 2d33 207c 2067 7265  p {name}-3 | gre
-0000b650: 7020 5045 4e44 494e 4727 2c0a 2020 2020  p PENDING',.    
-0000b660: 2020 2020 2020 2020 6627 736b 7920 6361          f'sky ca
-0000b670: 6e63 656c 202d 7920 7b6e 616d 657d 2032  ncel -y {name} 2
-0000b680: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
-0000b690: 736c 6565 7020 3527 2c0a 2020 2020 2020  sleep 5',.      
-0000b6a0: 2020 2020 2020 6627 733d 2428 736b 7920        f's=$(sky 
-0000b6b0: 7175 6575 6520 7b6e 616d 657d 293b 2065  queue {name}); e
-0000b6c0: 6368 6f20 2224 7322 3b20 6563 686f 3b20  cho "$s"; echo; 
-0000b6d0: 6563 686f 3b20 6563 686f 2022 2473 2220  echo; echo "$s" 
-0000b6e0: 7c20 6772 6570 207b 6e61 6d65 7d2d 3320  | grep {name}-3 
-0000b6f0: 7c20 6772 6570 2052 554e 4e49 4e47 272c  | grep RUNNING',
-0000b700: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000b710: 6b79 2063 616e 6365 6c20 2d79 207b 6e61  ky cancel -y {na
-0000b720: 6d65 7d20 3327 2c0a 2020 2020 2020 2020  me} 3',.        
-0000b730: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
-0000b740: 6e61 6d65 7d20 2d2d 6770 7573 2054 343a  name} --gpus T4:
-0000b750: 302e 3220 225b 5b20 5c24 534b 5950 494c  0.2 "[[ \$SKYPIL
-0000b760: 4f54 5f4e 554d 5f47 5055 535f 5045 525f  OT_NUM_GPUS_PER_
-0000b770: 4e4f 4445 202d 6571 2031 205d 5d20 7c7c  NODE -eq 1 ]] ||
-0000b780: 2065 7869 7420 3122 272c 0a20 2020 2020   exit 1"',.     
-0000b790: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
-0000b7a0: 6320 7b6e 616d 657d 202d 2d67 7075 7320  c {name} --gpus 
-0000b7b0: 5434 3a31 2022 5b5b 205c 2453 4b59 5049  T4:1 "[[ \$SKYPI
-0000b7c0: 4c4f 545f 4e55 4d5f 4750 5553 5f50 4552  LOT_NUM_GPUS_PER
-0000b7d0: 5f4e 4f44 4520 2d65 7120 3120 5d5d 207c  _NODE -eq 1 ]] |
-0000b7e0: 7c20 6578 6974 2031 2227 2c0a 2020 2020  | exit 1"',.    
-0000b7f0: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
-0000b800: 6773 207b 6e61 6d65 7d20 3420 2d2d 7374  gs {name} 4 --st
-0000b810: 6174 7573 272c 0a20 2020 2020 2020 2020  atus',.         
-0000b820: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
-0000b830: 616d 657d 2035 202d 2d73 7461 7475 7327  ame} 5 --status'
-0000b840: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
-0000b850: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
-0000b860: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
-0000b870: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
-0000b880: 7374 2874 6573 7429 0a0a 0a23 202d 2d2d  st(test)...# ---
-0000b890: 2d2d 2d2d 2d2d 2d20 4a6f 6220 5175 6575  ------- Job Queu
-0000b8a0: 6520 7769 7468 2044 6f63 6b65 722e 202d  e with Docker. -
-0000b8b0: 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974 6573  ---------.@pytes
-0000b8c0: 742e 6d61 726b 2e6e 6f5f 666c 7569 6473  t.mark.no_fluids
-0000b8d0: 7461 636b 2020 2320 466c 7569 6453 7461  tack  # FluidSta
-0000b8e0: 636b 2064 6f65 7320 6e6f 7420 7375 7070  ck does not supp
-0000b8f0: 6f72 7420 646f 636b 6572 2066 6f72 206e  ort docker for n
-0000b900: 6f77 0a40 7079 7465 7374 2e6d 6172 6b2e  ow.@pytest.mark.
-0000b910: 6e6f 5f6c 616d 6264 615f 636c 6f75 6420  no_lambda_cloud 
-0000b920: 2023 2044 6f65 736e 2774 2073 7570 706f   # Doesn't suppo
-0000b930: 7274 204c 616d 6264 6120 436c 6f75 6420  rt Lambda Cloud 
-0000b940: 666f 7220 6e6f 770a 4070 7974 6573 742e  for now.@pytest.
-0000b950: 6d61 726b 2e6e 6f5f 6962 6d20 2023 2044  mark.no_ibm  # D
-0000b960: 6f65 736e 2774 2073 7570 706f 7274 2049  oesn't support I
-0000b970: 424d 2043 6c6f 7564 2066 6f72 206e 6f77  BM Cloud for now
-0000b980: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
-0000b990: 5f70 6170 6572 7370 6163 6520 2023 2050  _paperspace  # P
-0000b9a0: 6170 6572 7370 6163 6520 646f 6573 6e27  aperspace doesn'
-0000b9b0: 7420 6861 7665 2054 3420 4750 5573 0a40  t have T4 GPUs.@
-0000b9c0: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f73  pytest.mark.no_s
-0000b9d0: 6370 2020 2320 446f 6573 6e27 7420 7375  cp  # Doesn't su
-0000b9e0: 7070 6f72 7420 5343 5020 666f 7220 6e6f  pport SCP for no
-0000b9f0: 770a 4070 7974 6573 742e 6d61 726b 2e6e  w.@pytest.mark.n
-0000ba00: 6f5f 6f63 6920 2023 2044 6f65 736e 2774  o_oci  # Doesn't
-0000ba10: 2073 7570 706f 7274 204f 4349 2066 6f72   support OCI for
-0000ba20: 206e 6f77 0a40 7079 7465 7374 2e6d 6172   now.@pytest.mar
-0000ba30: 6b2e 6e6f 5f6b 7562 6572 6e65 7465 7320  k.no_kubernetes 
-0000ba40: 2023 2044 6f65 736e 2774 2073 7570 706f   # Doesn't suppo
-0000ba50: 7274 204b 7562 6572 6e65 7465 7320 666f  rt Kubernetes fo
-0000ba60: 7220 6e6f 770a 4070 7974 6573 742e 6d61  r now.@pytest.ma
-0000ba70: 726b 2e70 6172 616d 6574 7269 7a65 280a  rk.parametrize(.
-0000ba80: 2020 2020 2269 6d61 6765 5f69 6422 2c0a      "image_id",.
-0000ba90: 2020 2020 5b0a 2020 2020 2020 2020 2264      [.        "d
-0000baa0: 6f63 6b65 723a 6e76 6964 6961 2f63 7564  ocker:nvidia/cud
-0000bab0: 613a 3131 2e38 2e30 2d64 6576 656c 2d75  a:11.8.0-devel-u
-0000bac0: 6275 6e74 7531 382e 3034 222c 0a20 2020  buntu18.04",.   
-0000bad0: 2020 2020 2022 646f 636b 6572 3a75 6275       "docker:ubu
-0000bae0: 6e74 753a 3138 2e30 3422 2c0a 2020 2020  ntu:18.04",.    
-0000baf0: 2020 2020 2320 5465 7374 206c 6174 6573      # Test lates
-0000bb00: 7420 696d 6167 6520 7769 7468 2070 7974  t image with pyt
-0000bb10: 686f 6e20 332e 3131 2069 6e73 7461 6c6c  hon 3.11 install
-0000bb20: 6564 2062 7920 6465 6661 756c 742e 0a20  ed by default.. 
-0000bb30: 2020 2020 2020 2023 2044 6f65 7320 6e6f         # Does no
-0000bb40: 7420 776f 726b 2066 6f72 2070 7974 686f  t work for pytho
-0000bb50: 6e20 332e 3132 2064 7565 2074 6f20 7261  n 3.12 due to ra
-0000bb60: 7927 7320 7265 7175 6972 656d 656e 7420  y's requirement 
-0000bb70: 666f 7220 332e 3131 2e0a 2020 2020 2020  for 3.11..      
-0000bb80: 2020 2764 6f63 6b65 723a 636f 6e74 696e    'docker:contin
-0000bb90: 7575 6d69 6f2f 6d69 6e69 636f 6e64 6133  uumio/miniconda3
-0000bba0: 3a32 342e 312e 322d 3027 2c0a 2020 2020  :24.1.2-0',.    
-0000bbb0: 5d29 0a64 6566 2074 6573 745f 6a6f 625f  ]).def test_job_
-0000bbc0: 7175 6575 655f 7769 7468 5f64 6f63 6b65  queue_with_docke
-0000bbd0: 7228 6765 6e65 7269 635f 636c 6f75 643a  r(generic_cloud:
-0000bbe0: 2073 7472 2c20 696d 6167 655f 6964 3a20   str, image_id: 
-0000bbf0: 7374 7229 3a0a 2020 2020 6e61 6d65 203d  str):.    name =
-0000bc00: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
-0000bc10: 6d65 2829 202b 2069 6d61 6765 5f69 645b  me() + image_id[
-0000bc20: 6c65 6e28 2764 6f63 6b65 723a 2729 3a5d  len('docker:'):]
-0000bc30: 5b3a 345d 0a20 2020 2074 6f74 616c 5f74  [:4].    total_t
-0000bc40: 696d 656f 7574 5f6d 696e 7574 6573 203d  imeout_minutes =
-0000bc50: 2034 3020 6966 2067 656e 6572 6963 5f63   40 if generic_c
-0000bc60: 6c6f 7564 203d 3d20 2761 7a75 7265 2720  loud == 'azure' 
-0000bc70: 656c 7365 2031 350a 2020 2020 7469 6d65  else 15.    time
-0000bc80: 5f74 6f5f 736c 6565 7020 3d20 3330 3020  _to_sleep = 300 
-0000bc90: 6966 2067 656e 6572 6963 5f63 6c6f 7564  if generic_cloud
-0000bca0: 203d 3d20 2761 7a75 7265 2720 656c 7365   == 'azure' else
-0000bcb0: 2031 3830 0a20 2020 2074 6573 7420 3d20   180.    test = 
-0000bcc0: 5465 7374 280a 2020 2020 2020 2020 276a  Test(.        'j
-0000bcd0: 6f62 5f71 7565 7565 5f77 6974 685f 646f  ob_queue_with_do
-0000bce0: 636b 6572 272c 0a20 2020 2020 2020 205b  cker',.        [
-0000bcf0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000bd00: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
-0000bd10: 7b6e 616d 657d 202d 2d63 6c6f 7564 207b  {name} --cloud {
-0000bd20: 6765 6e65 7269 635f 636c 6f75 647d 202d  generic_cloud} -
-0000bd30: 2d69 6d61 6765 2d69 6420 7b69 6d61 6765  -image-id {image
-0000bd40: 5f69 647d 2065 7861 6d70 6c65 732f 6a6f  _id} examples/jo
-0000bd50: 625f 7175 6575 652f 636c 7573 7465 725f  b_queue/cluster_
-0000bd60: 646f 636b 6572 2e79 616d 6c27 2c0a 2020  docker.yaml',.  
-0000bd70: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0000bd80: 6578 6563 207b 6e61 6d65 7d20 2d6e 207b  exec {name} -n {
-0000bd90: 6e61 6d65 7d2d 3120 2d64 202d 2d69 6d61  name}-1 -d --ima
-0000bda0: 6765 2d69 6420 7b69 6d61 6765 5f69 647d  ge-id {image_id}
-0000bdb0: 202d 2d65 6e76 2054 494d 455f 544f 5f53   --env TIME_TO_S
-0000bdc0: 4c45 4550 3d7b 7469 6d65 5f74 6f5f 736c  LEEP={time_to_sl
-0000bdd0: 6565 707d 2065 7861 6d70 6c65 732f 6a6f  eep} examples/jo
-0000bde0: 625f 7175 6575 652f 6a6f 625f 646f 636b  b_queue/job_dock
-0000bdf0: 6572 2e79 616d 6c27 2c0a 2020 2020 2020  er.yaml',.      
-0000be00: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
-0000be10: 207b 6e61 6d65 7d20 2d6e 207b 6e61 6d65   {name} -n {name
-0000be20: 7d2d 3220 2d64 202d 2d69 6d61 6765 2d69  }-2 -d --image-i
-0000be30: 6420 7b69 6d61 6765 5f69 647d 202d 2d65  d {image_id} --e
-0000be40: 6e76 2054 494d 455f 544f 5f53 4c45 4550  nv TIME_TO_SLEEP
-0000be50: 3d7b 7469 6d65 5f74 6f5f 736c 6565 707d  ={time_to_sleep}
-0000be60: 2065 7861 6d70 6c65 732f 6a6f 625f 7175   examples/job_qu
-0000be70: 6575 652f 6a6f 625f 646f 636b 6572 2e79  eue/job_docker.y
-0000be80: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-0000be90: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
-0000bea0: 6d65 7d20 2d6e 207b 6e61 6d65 7d2d 3320  me} -n {name}-3 
-0000beb0: 2d64 202d 2d69 6d61 6765 2d69 6420 7b69  -d --image-id {i
-0000bec0: 6d61 6765 5f69 647d 202d 2d65 6e76 2054  mage_id} --env T
-0000bed0: 494d 455f 544f 5f53 4c45 4550 3d7b 7469  IME_TO_SLEEP={ti
-0000bee0: 6d65 5f74 6f5f 736c 6565 707d 2065 7861  me_to_sleep} exa
-0000bef0: 6d70 6c65 732f 6a6f 625f 7175 6575 652f  mples/job_queue/
-0000bf00: 6a6f 625f 646f 636b 6572 2e79 616d 6c27  job_docker.yaml'
-0000bf10: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0000bf20: 733d 2428 736b 7920 7175 6575 6520 7b6e  s=$(sky queue {n
-0000bf30: 616d 657d 293b 2065 6368 6f20 2224 7322  ame}); echo "$s"
-0000bf40: 3b20 6563 686f 3b20 6563 686f 3b20 6563  ; echo; echo; ec
-0000bf50: 686f 2022 2473 2220 7c20 6772 6570 207b  ho "$s" | grep {
-0000bf60: 6e61 6d65 7d2d 3120 7c20 6772 6570 2052  name}-1 | grep R
-0000bf70: 554e 4e49 4e47 272c 0a20 2020 2020 2020  UNNING',.       
-0000bf80: 2020 2020 2066 2773 3d24 2873 6b79 2071       f's=$(sky q
-0000bf90: 7565 7565 207b 6e61 6d65 7d29 3b20 6563  ueue {name}); ec
-0000bfa0: 686f 2022 2473 223b 2065 6368 6f3b 2065  ho "$s"; echo; e
-0000bfb0: 6368 6f3b 2065 6368 6f20 2224 7322 207c  cho; echo "$s" |
-0000bfc0: 2067 7265 7020 7b6e 616d 657d 2d32 207c   grep {name}-2 |
-0000bfd0: 2067 7265 7020 5255 4e4e 494e 4727 2c0a   grep RUNNING',.
-0000bfe0: 2020 2020 2020 2020 2020 2020 6627 733d              f's=
-0000bff0: 2428 736b 7920 7175 6575 6520 7b6e 616d  $(sky queue {nam
-0000c000: 657d 293b 2065 6368 6f20 2224 7322 3b20  e}); echo "$s"; 
-0000c010: 6563 686f 3b20 6563 686f 3b20 6563 686f  echo; echo; echo
-0000c020: 2022 2473 2220 7c20 6772 6570 207b 6e61   "$s" | grep {na
-0000c030: 6d65 7d2d 3320 7c20 6772 6570 2050 454e  me}-3 | grep PEN
-0000c040: 4449 4e47 272c 0a20 2020 2020 2020 2020  DING',.         
-0000c050: 2020 2066 2773 6b79 2063 616e 6365 6c20     f'sky cancel 
-0000c060: 2d79 207b 6e61 6d65 7d20 3227 2c0a 2020  -y {name} 2',.  
-0000c070: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
-0000c080: 2035 272c 0a20 2020 2020 2020 2020 2020   5',.           
-0000c090: 2066 2773 3d24 2873 6b79 2071 7565 7565   f's=$(sky queue
-0000c0a0: 207b 6e61 6d65 7d29 3b20 6563 686f 2022   {name}); echo "
-0000c0b0: 2473 223b 2065 6368 6f3b 2065 6368 6f3b  $s"; echo; echo;
-0000c0c0: 2065 6368 6f20 2224 7322 207c 2067 7265   echo "$s" | gre
-0000c0d0: 7020 7b6e 616d 657d 2d33 207c 2067 7265  p {name}-3 | gre
-0000c0e0: 7020 5255 4e4e 494e 4727 2c0a 2020 2020  p RUNNING',.    
-0000c0f0: 2020 2020 2020 2020 6627 736b 7920 6361          f'sky ca
-0000c100: 6e63 656c 202d 7920 7b6e 616d 657d 2033  ncel -y {name} 3
-0000c110: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
-0000c120: 204d 616b 6520 7375 7265 2074 6865 2047   Make sure the G
-0000c130: 5055 2069 7320 7374 696c 6c20 7669 7369  PU is still visi
-0000c140: 626c 6520 746f 2074 6865 2063 6f6e 7461  ble to the conta
-0000c150: 696e 6572 2e0a 2020 2020 2020 2020 2020  iner..          
-0000c160: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
-0000c170: 6d65 7d20 2d2d 696d 6167 652d 6964 207b  me} --image-id {
-0000c180: 696d 6167 655f 6964 7d20 6e76 6964 6961  image_id} nvidia
-0000c190: 2d73 6d69 207c 2067 7265 7020 2254 6573  -smi | grep "Tes
-0000c1a0: 6c61 2054 3422 272c 0a20 2020 2020 2020  la T4"',.       
-0000c1b0: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-0000c1c0: 7b6e 616d 657d 2034 202d 2d73 7461 7475  {name} 4 --statu
-0000c1d0: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
-0000c1e0: 6627 736b 7920 7374 6f70 202d 7920 7b6e  f'sky stop -y {n
-0000c1f0: 616d 657d 272c 0a20 2020 2020 2020 2020  ame}',.         
-0000c200: 2020 2023 204d 616b 6520 7375 7265 2074     # Make sure t
-0000c210: 6865 206a 6f62 2073 7461 7475 7320 7072  he job status pr
-0000c220: 6573 6572 7665 2061 6674 6572 2073 746f  eserve after sto
-0000c230: 7020 616e 6420 7374 6172 7420 7468 650a  p and start the.
-0000c240: 2020 2020 2020 2020 2020 2020 2320 636c              # cl
-0000c250: 7573 7465 722e 2054 6869 7320 6973 2061  uster. This is a
-0000c260: 6c73 6f20 6120 7465 7374 2066 6f72 2074  lso a test for t
-0000c270: 6865 2064 6f63 6b65 7220 636f 6e74 6169  he docker contai
-0000c280: 6e65 7220 746f 2062 650a 2020 2020 2020  ner to be.      
-0000c290: 2020 2020 2020 2320 7072 6573 6572 7665        # preserve
-0000c2a0: 6420 6166 7465 7220 7374 6f70 2061 6e64  d after stop and
-0000c2b0: 2073 7461 7274 2e0a 2020 2020 2020 2020   start..        
-0000c2c0: 2020 2020 6627 736b 7920 7374 6172 7420      f'sky start 
-0000c2d0: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
-0000c2e0: 2020 2020 2020 2020 6627 733d 2428 736b          f's=$(sk
-0000c2f0: 7920 7175 6575 6520 7b6e 616d 657d 293b  y queue {name});
-0000c300: 2065 6368 6f20 2224 7322 3b20 6563 686f   echo "$s"; echo
-0000c310: 3b20 6563 686f 3b20 6563 686f 2022 2473  ; echo; echo "$s
-0000c320: 2220 7c20 6772 6570 207b 6e61 6d65 7d2d  " | grep {name}-
-0000c330: 3120 7c20 6772 6570 2046 4149 4c45 4427  1 | grep FAILED'
-0000c340: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0000c350: 733d 2428 736b 7920 7175 6575 6520 7b6e  s=$(sky queue {n
-0000c360: 616d 657d 293b 2065 6368 6f20 2224 7322  ame}); echo "$s"
-0000c370: 3b20 6563 686f 3b20 6563 686f 3b20 6563  ; echo; echo; ec
-0000c380: 686f 2022 2473 2220 7c20 6772 6570 207b  ho "$s" | grep {
-0000c390: 6e61 6d65 7d2d 3220 7c20 6772 6570 2043  name}-2 | grep C
-0000c3a0: 414e 4345 4c4c 4544 272c 0a20 2020 2020  ANCELLED',.     
-0000c3b0: 2020 2020 2020 2066 2773 3d24 2873 6b79         f's=$(sky
-0000c3c0: 2071 7565 7565 207b 6e61 6d65 7d29 3b20   queue {name}); 
-0000c3d0: 6563 686f 2022 2473 223b 2065 6368 6f3b  echo "$s"; echo;
-0000c3e0: 2065 6368 6f3b 2065 6368 6f20 2224 7322   echo; echo "$s"
-0000c3f0: 207c 2067 7265 7020 7b6e 616d 657d 2d33   | grep {name}-3
-0000c400: 207c 2067 7265 7020 4341 4e43 454c 4c45   | grep CANCELLE
-0000c410: 4427 2c0a 2020 2020 2020 2020 2020 2020  D',.            
-0000c420: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
-0000c430: 7d20 2d2d 6770 7573 2054 343a 302e 3220  } --gpus T4:0.2 
-0000c440: 225b 5b20 5c24 534b 5950 494c 4f54 5f4e  "[[ \$SKYPILOT_N
-0000c450: 554d 5f47 5055 535f 5045 525f 4e4f 4445  UM_GPUS_PER_NODE
-0000c460: 202d 6571 2031 205d 5d20 7c7c 2065 7869   -eq 1 ]] || exi
-0000c470: 7420 3122 272c 0a20 2020 2020 2020 2020  t 1"',.         
-0000c480: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
-0000c490: 616d 657d 202d 2d67 7075 7320 5434 3a31  ame} --gpus T4:1
-0000c4a0: 2022 5b5b 205c 2453 4b59 5049 4c4f 545f   "[[ \$SKYPILOT_
-0000c4b0: 4e55 4d5f 4750 5553 5f50 4552 5f4e 4f44  NUM_GPUS_PER_NOD
-0000c4c0: 4520 2d65 7120 3120 5d5d 207c 7c20 6578  E -eq 1 ]] || ex
-0000c4d0: 6974 2031 2227 2c0a 2020 2020 2020 2020  it 1"',.        
-0000c4e0: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
-0000c4f0: 6e61 6d65 7d20 3520 2d2d 7374 6174 7573  name} 5 --status
-0000c500: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0000c510: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-0000c520: 2036 202d 2d73 7461 7475 7327 2c0a 2020   6 --status',.  
-0000c530: 2020 2020 2020 2020 2020 2320 4d61 6b65            # Make
-0000c540: 2073 7572 6520 6974 2069 7320 7374 696c   sure it is stil
-0000c550: 6c20 7669 7369 626c 6520 6166 7465 7220  l visible after 
-0000c560: 616e 2073 746f 7020 2620 7374 6172 7420  an stop & start 
-0000c570: 6379 636c 652e 0a20 2020 2020 2020 2020  cycle..         
-0000c580: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
-0000c590: 616d 657d 202d 2d69 6d61 6765 2d69 6420  ame} --image-id 
-0000c5a0: 7b69 6d61 6765 5f69 647d 206e 7669 6469  {image_id} nvidi
-0000c5b0: 612d 736d 6920 7c20 6772 6570 2022 5465  a-smi | grep "Te
-0000c5c0: 736c 6120 5434 2227 2c0a 2020 2020 2020  sla T4"',.      
-0000c5d0: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
-0000c5e0: 207b 6e61 6d65 7d20 3720 2d2d 7374 6174   {name} 7 --stat
-0000c5f0: 7573 270a 2020 2020 2020 2020 5d2c 0a20  us'.        ],. 
-0000c600: 2020 2020 2020 2066 2773 6b79 2064 6f77         f'sky dow
-0000c610: 6e20 2d79 207b 6e61 6d65 7d27 2c0a 2020  n -y {name}',.  
-0000c620: 2020 2020 2020 7469 6d65 6f75 743d 746f        timeout=to
-0000c630: 7461 6c5f 7469 6d65 6f75 745f 6d69 6e75  tal_timeout_minu
-0000c640: 7465 7320 2a20 3630 2c0a 2020 2020 290a  tes * 60,.    ).
-0000c650: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
-0000c660: 2874 6573 7429 0a0a 0a40 7079 7465 7374  (test)...@pytest
-0000c670: 2e6d 6172 6b2e 6c61 6d62 6461 5f63 6c6f  .mark.lambda_clo
-0000c680: 7564 0a64 6566 2074 6573 745f 6c61 6d62  ud.def test_lamb
-0000c690: 6461 5f6a 6f62 5f71 7565 7565 2829 3a0a  da_job_queue():.
-0000c6a0: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
-0000c6b0: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
-0000c6c0: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
-0000c6d0: 2020 2020 2020 2020 276c 616d 6264 615f          'lambda_
-0000c6e0: 6a6f 625f 7175 6575 6527 2c0a 2020 2020  job_queue',.    
-0000c6f0: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
-0000c700: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
-0000c710: 7920 2d63 207b 6e61 6d65 7d20 7b4c 414d  y -c {name} {LAM
-0000c720: 4244 415f 5459 5045 7d20 6578 616d 706c  BDA_TYPE} exampl
-0000c730: 6573 2f6a 6f62 5f71 7565 7565 2f63 6c75  es/job_queue/clu
-0000c740: 7374 6572 2e79 616d 6c27 2c0a 2020 2020  ster.yaml',.    
-0000c750: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
-0000c760: 6563 207b 6e61 6d65 7d20 2d6e 207b 6e61  ec {name} -n {na
-0000c770: 6d65 7d2d 3120 2d2d 6770 7573 2041 3130  me}-1 --gpus A10
-0000c780: 3a30 2e35 202d 6420 6578 616d 706c 6573  :0.5 -d examples
-0000c790: 2f6a 6f62 5f71 7565 7565 2f6a 6f62 2e79  /job_queue/job.y
-0000c7a0: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-0000c7b0: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
-0000c7c0: 6d65 7d20 2d6e 207b 6e61 6d65 7d2d 3220  me} -n {name}-2 
-0000c7d0: 2d2d 6770 7573 2041 3130 3a30 2e35 202d  --gpus A10:0.5 -
-0000c7e0: 6420 6578 616d 706c 6573 2f6a 6f62 5f71  d examples/job_q
-0000c7f0: 7565 7565 2f6a 6f62 2e79 616d 6c27 2c0a  ueue/job.yaml',.
-0000c800: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0000c810: 7920 6578 6563 207b 6e61 6d65 7d20 2d6e  y exec {name} -n
-0000c820: 207b 6e61 6d65 7d2d 3320 2d2d 6770 7573   {name}-3 --gpus
-0000c830: 2041 3130 3a30 2e35 202d 6420 6578 616d   A10:0.5 -d exam
-0000c840: 706c 6573 2f6a 6f62 5f71 7565 7565 2f6a  ples/job_queue/j
-0000c850: 6f62 2e79 616d 6c27 2c0a 2020 2020 2020  ob.yaml',.      
-0000c860: 2020 2020 2020 6627 736b 7920 7175 6575        f'sky queu
-0000c870: 6520 7b6e 616d 657d 207c 2067 7265 7020  e {name} | grep 
-0000c880: 7b6e 616d 657d 2d31 207c 2067 7265 7020  {name}-1 | grep 
-0000c890: 5255 4e4e 494e 4727 2c0a 2020 2020 2020  RUNNING',.      
-0000c8a0: 2020 2020 2020 6627 736b 7920 7175 6575        f'sky queu
-0000c8b0: 6520 7b6e 616d 657d 207c 2067 7265 7020  e {name} | grep 
-0000c8c0: 7b6e 616d 657d 2d32 207c 2067 7265 7020  {name}-2 | grep 
-0000c8d0: 5255 4e4e 494e 4727 2c0a 2020 2020 2020  RUNNING',.      
-0000c8e0: 2020 2020 2020 6627 736b 7920 7175 6575        f'sky queu
-0000c8f0: 6520 7b6e 616d 657d 207c 2067 7265 7020  e {name} | grep 
-0000c900: 7b6e 616d 657d 2d33 207c 2067 7265 7020  {name}-3 | grep 
-0000c910: 5045 4e44 494e 4727 2c0a 2020 2020 2020  PENDING',.      
-0000c920: 2020 2020 2020 6627 736b 7920 6361 6e63        f'sky canc
-0000c930: 656c 202d 7920 7b6e 616d 657d 2032 272c  el -y {name} 2',
-0000c940: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
-0000c950: 6565 7020 3527 2c0a 2020 2020 2020 2020  eep 5',.        
-0000c960: 2020 2020 6627 736b 7920 7175 6575 6520      f'sky queue 
-0000c970: 7b6e 616d 657d 207c 2067 7265 7020 7b6e  {name} | grep {n
-0000c980: 616d 657d 2d33 207c 2067 7265 7020 5255  ame}-3 | grep RU
-0000c990: 4e4e 494e 4727 2c0a 2020 2020 2020 2020  NNING',.        
-0000c9a0: 2020 2020 6627 736b 7920 6361 6e63 656c      f'sky cancel
-0000c9b0: 202d 7920 7b6e 616d 657d 2033 272c 0a20   -y {name} 3',. 
-0000c9c0: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-0000c9d0: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
-0000c9e0: 7b6e 616d 657d 272c 0a20 2020 2029 0a20  {name}',.    ). 
-0000c9f0: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-0000ca00: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
-0000ca10: 6d61 726b 2e69 626d 0a64 6566 2074 6573  mark.ibm.def tes
-0000ca20: 745f 6962 6d5f 6a6f 625f 7175 6575 6528  t_ibm_job_queue(
-0000ca30: 293a 0a20 2020 206e 616d 6520 3d20 5f67  ):.    name = _g
-0000ca40: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
-0000ca50: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
-0000ca60: 7428 0a20 2020 2020 2020 2027 6962 6d5f  t(.        'ibm_
-0000ca70: 6a6f 625f 7175 6575 6527 2c0a 2020 2020  job_queue',.    
-0000ca80: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
-0000ca90: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
-0000caa0: 7920 2d63 207b 6e61 6d65 7d20 2d2d 636c  y -c {name} --cl
-0000cab0: 6f75 6420 6962 6d20 2d2d 6770 7573 2076  oud ibm --gpus v
-0000cac0: 3130 3027 2c0a 2020 2020 2020 2020 2020  100',.          
-0000cad0: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
-0000cae0: 6d65 7d20 2d6e 207b 6e61 6d65 7d2d 3120  me} -n {name}-1 
-0000caf0: 2d2d 636c 6f75 6420 6962 6d20 2d64 2065  --cloud ibm -d e
-0000cb00: 7861 6d70 6c65 732f 6a6f 625f 7175 6575  xamples/job_queu
-0000cb10: 652f 6a6f 625f 6962 6d2e 7961 6d6c 272c  e/job_ibm.yaml',
-0000cb20: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000cb30: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
-0000cb40: 6e20 7b6e 616d 657d 2d32 202d 2d63 6c6f  n {name}-2 --clo
-0000cb50: 7564 2069 626d 202d 6420 6578 616d 706c  ud ibm -d exampl
-0000cb60: 6573 2f6a 6f62 5f71 7565 7565 2f6a 6f62  es/job_queue/job
-0000cb70: 5f69 626d 2e79 616d 6c27 2c0a 2020 2020  _ibm.yaml',.    
-0000cb80: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
-0000cb90: 6563 207b 6e61 6d65 7d20 2d6e 207b 6e61  ec {name} -n {na
-0000cba0: 6d65 7d2d 3320 2d2d 636c 6f75 6420 6962  me}-3 --cloud ib
-0000cbb0: 6d20 2d64 2065 7861 6d70 6c65 732f 6a6f  m -d examples/jo
-0000cbc0: 625f 7175 6575 652f 6a6f 625f 6962 6d2e  b_queue/job_ibm.
-0000cbd0: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
-0000cbe0: 2020 2066 2773 6b79 2071 7565 7565 207b     f'sky queue {
-0000cbf0: 6e61 6d65 7d20 7c20 6772 6570 207b 6e61  name} | grep {na
-0000cc00: 6d65 7d2d 3120 7c20 6772 6570 2052 554e  me}-1 | grep RUN
-0000cc10: 4e49 4e47 272c 0a20 2020 2020 2020 2020  NING',.         
-0000cc20: 2020 2066 2773 6b79 2071 7565 7565 207b     f'sky queue {
-0000cc30: 6e61 6d65 7d20 7c20 6772 6570 207b 6e61  name} | grep {na
-0000cc40: 6d65 7d2d 3220 7c20 6772 6570 2052 554e  me}-2 | grep RUN
-0000cc50: 4e49 4e47 272c 0a20 2020 2020 2020 2020  NING',.         
-0000cc60: 2020 2066 2773 6b79 2071 7565 7565 207b     f'sky queue {
-0000cc70: 6e61 6d65 7d20 7c20 6772 6570 207b 6e61  name} | grep {na
-0000cc80: 6d65 7d2d 3320 7c20 6772 6570 2050 454e  me}-3 | grep PEN
-0000cc90: 4449 4e47 272c 0a20 2020 2020 2020 2020  DING',.         
-0000cca0: 2020 2066 2773 6b79 2063 616e 6365 6c20     f'sky cancel 
-0000ccb0: 2d79 207b 6e61 6d65 7d20 3227 2c0a 2020  -y {name} 2',.  
-0000ccc0: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
-0000ccd0: 2035 272c 0a20 2020 2020 2020 2020 2020   5',.           
-0000cce0: 2066 2773 6b79 2071 7565 7565 207b 6e61   f'sky queue {na
-0000ccf0: 6d65 7d20 7c20 6772 6570 207b 6e61 6d65  me} | grep {name
-0000cd00: 7d2d 3320 7c20 6772 6570 2052 554e 4e49  }-3 | grep RUNNI
-0000cd10: 4e47 272c 0a20 2020 2020 2020 2020 2020  NG',.           
-0000cd20: 2066 2773 6b79 2063 616e 6365 6c20 2d79   f'sky cancel -y
-0000cd30: 207b 6e61 6d65 7d20 3327 2c0a 2020 2020   {name} 3',.    
-0000cd40: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
-0000cd50: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
-0000cd60: 6d65 7d27 2c0a 2020 2020 290a 2020 2020  me}',.    ).    
-0000cd70: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-0000cd80: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
-0000cd90: 6b2e 7363 700a 6465 6620 7465 7374 5f73  k.scp.def test_s
-0000cda0: 6370 5f6a 6f62 5f71 7565 7565 2829 3a0a  cp_job_queue():.
-0000cdb0: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
-0000cdc0: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
-0000cdd0: 2020 206e 756d 5f6f 665f 6770 755f 6c61     num_of_gpu_la
-0000cde0: 756e 6368 203d 2031 0a20 2020 206e 756d  unch = 1.    num
-0000cdf0: 5f6f 665f 6770 755f 6578 6563 203d 2030  _of_gpu_exec = 0
-0000ce00: 2e35 0a20 2020 2074 6573 7420 3d20 5465  .5.    test = Te
-0000ce10: 7374 280a 2020 2020 2020 2020 2753 4350  st(.        'SCP
-0000ce20: 5f6a 6f62 5f71 7565 7565 272c 0a20 2020  _job_queue',.   
-0000ce30: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
-0000ce40: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
-0000ce50: 2d79 202d 6320 7b6e 616d 657d 207b 5343  -y -c {name} {SC
-0000ce60: 505f 5459 5045 7d20 7b53 4350 5f47 5055  P_TYPE} {SCP_GPU
-0000ce70: 5f56 3130 307d 3a7b 6e75 6d5f 6f66 5f67  _V100}:{num_of_g
-0000ce80: 7075 5f6c 6175 6e63 687d 2065 7861 6d70  pu_launch} examp
-0000ce90: 6c65 732f 6a6f 625f 7175 6575 652f 636c  les/job_queue/cl
-0000cea0: 7573 7465 722e 7961 6d6c 272c 0a20 2020  uster.yaml',.   
-0000ceb0: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
-0000cec0: 7865 6320 7b6e 616d 657d 202d 6e20 7b6e  xec {name} -n {n
-0000ced0: 616d 657d 2d31 207b 5343 505f 4750 555f  ame}-1 {SCP_GPU_
-0000cee0: 5631 3030 7d3a 7b6e 756d 5f6f 665f 6770  V100}:{num_of_gp
-0000cef0: 755f 6578 6563 7d20 2d64 2065 7861 6d70  u_exec} -d examp
-0000cf00: 6c65 732f 6a6f 625f 7175 6575 652f 6a6f  les/job_queue/jo
-0000cf10: 622e 7961 6d6c 272c 0a20 2020 2020 2020  b.yaml',.       
-0000cf20: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
-0000cf30: 7b6e 616d 657d 202d 6e20 7b6e 616d 657d  {name} -n {name}
-0000cf40: 2d32 207b 5343 505f 4750 555f 5631 3030  -2 {SCP_GPU_V100
-0000cf50: 7d3a 7b6e 756d 5f6f 665f 6770 755f 6578  }:{num_of_gpu_ex
-0000cf60: 6563 7d20 2d64 2065 7861 6d70 6c65 732f  ec} -d examples/
-0000cf70: 6a6f 625f 7175 6575 652f 6a6f 622e 7961  job_queue/job.ya
-0000cf80: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
-0000cf90: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
-0000cfa0: 657d 202d 6e20 7b6e 616d 657d 2d33 207b  e} -n {name}-3 {
-0000cfb0: 5343 505f 4750 555f 5631 3030 7d3a 7b6e  SCP_GPU_V100}:{n
-0000cfc0: 756d 5f6f 665f 6770 755f 6578 6563 7d20  um_of_gpu_exec} 
-0000cfd0: 2d64 2065 7861 6d70 6c65 732f 6a6f 625f  -d examples/job_
-0000cfe0: 7175 6575 652f 6a6f 622e 7961 6d6c 272c  queue/job.yaml',
-0000cff0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000d000: 6b79 2071 7565 7565 207b 6e61 6d65 7d20  ky queue {name} 
-0000d010: 7c20 6772 6570 207b 6e61 6d65 7d2d 3120  | grep {name}-1 
-0000d020: 7c20 6772 6570 2052 554e 4e49 4e47 272c  | grep RUNNING',
-0000d030: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000d040: 6b79 2071 7565 7565 207b 6e61 6d65 7d20  ky queue {name} 
-0000d050: 7c20 6772 6570 207b 6e61 6d65 7d2d 3220  | grep {name}-2 
-0000d060: 7c20 6772 6570 2052 554e 4e49 4e47 272c  | grep RUNNING',
-0000d070: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000d080: 6b79 2071 7565 7565 207b 6e61 6d65 7d20  ky queue {name} 
-0000d090: 7c20 6772 6570 207b 6e61 6d65 7d2d 3320  | grep {name}-3 
-0000d0a0: 7c20 6772 6570 2050 454e 4449 4e47 272c  | grep PENDING',
-0000d0b0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000d0c0: 6b79 2063 616e 6365 6c20 2d79 207b 6e61  ky cancel -y {na
-0000d0d0: 6d65 7d20 3227 2c0a 2020 2020 2020 2020  me} 2',.        
-0000d0e0: 2020 2020 2773 6c65 6570 2035 272c 0a20      'sleep 5',. 
-0000d0f0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-0000d100: 2071 7565 7565 207b 6e61 6d65 7d20 7c20   queue {name} | 
-0000d110: 6772 6570 207b 6e61 6d65 7d2d 3320 7c20  grep {name}-3 | 
-0000d120: 6772 6570 2052 554e 4e49 4e47 272c 0a20  grep RUNNING',. 
-0000d130: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-0000d140: 2063 616e 6365 6c20 2d79 207b 6e61 6d65   cancel -y {name
-0000d150: 7d20 3327 2c0a 2020 2020 2020 2020 5d2c  } 3',.        ],
-0000d160: 0a20 2020 2020 2020 2066 2773 6b79 2064  .        f'sky d
-0000d170: 6f77 6e20 2d79 207b 6e61 6d65 7d27 2c0a  own -y {name}',.
-0000d180: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
-0000d190: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
-0000d1a0: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f66  pytest.mark.no_f
-0000d1b0: 6c75 6964 7374 6163 6b20 2023 2046 6c75  luidstack  # Flu
-0000d1c0: 6964 5374 6163 6b20 4443 2068 6173 206c  idStack DC has l
-0000d1d0: 6f77 2061 7661 696c 6162 696c 6974 7920  ow availability 
-0000d1e0: 6f66 2054 3420 4750 5573 0a40 7079 7465  of T4 GPUs.@pyte
-0000d1f0: 7374 2e6d 6172 6b2e 6e6f 5f6c 616d 6264  st.mark.no_lambd
-0000d200: 615f 636c 6f75 6420 2023 204c 616d 6264  a_cloud  # Lambd
-0000d210: 6120 436c 6f75 6420 646f 6573 206e 6f74  a Cloud does not
-0000d220: 2068 6176 6520 5434 2067 7075 730a 4070   have T4 gpus.@p
-0000d230: 7974 6573 742e 6d61 726b 2e6e 6f5f 6962  ytest.mark.no_ib
-0000d240: 6d20 2023 2049 424d 2043 6c6f 7564 2064  m  # IBM Cloud d
-0000d250: 6f65 7320 6e6f 7420 6861 7665 2054 3420  oes not have T4 
-0000d260: 6770 7573 2e20 7275 6e20 7465 7374 5f69  gpus. run test_i
-0000d270: 626d 5f6a 6f62 5f71 7565 7565 5f6d 756c  bm_job_queue_mul
-0000d280: 7469 6e6f 6465 2069 6e73 7465 6164 0a40  tinode instead.@
-0000d290: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f70  pytest.mark.no_p
-0000d2a0: 6170 6572 7370 6163 6520 2023 2050 6170  aperspace  # Pap
-0000d2b0: 6572 7370 6163 6520 646f 6573 206e 6f74  erspace does not
-0000d2c0: 2068 6176 6520 5434 2067 7075 732e 0a40   have T4 gpus..@
-0000d2d0: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f73  pytest.mark.no_s
-0000d2e0: 6370 2020 2320 5343 5020 646f 6573 206e  cp  # SCP does n
-0000d2f0: 6f74 2073 7570 706f 7274 206e 756d 5f6e  ot support num_n
-0000d300: 6f64 6573 203e 2031 2079 6574 0a40 7079  odes > 1 yet.@py
-0000d310: 7465 7374 2e6d 6172 6b2e 6e6f 5f6f 6369  test.mark.no_oci
-0000d320: 2020 2320 4f43 4920 436c 6f75 6420 646f    # OCI Cloud do
-0000d330: 6573 206e 6f74 2068 6176 6520 5434 2067  es not have T4 g
-0000d340: 7075 732e 0a40 7079 7465 7374 2e6d 6172  pus..@pytest.mar
-0000d350: 6b2e 6e6f 5f6b 7562 6572 6e65 7465 7320  k.no_kubernetes 
-0000d360: 2023 204b 7562 6572 6e65 7465 7320 6e6f   # Kubernetes no
-0000d370: 7420 7375 7070 6f72 7420 6e75 6d5f 6e6f  t support num_no
-0000d380: 6465 7320 3e20 3120 7965 740a 6465 6620  des > 1 yet.def 
-0000d390: 7465 7374 5f6a 6f62 5f71 7565 7565 5f6d  test_job_queue_m
-0000d3a0: 756c 7469 6e6f 6465 2867 656e 6572 6963  ultinode(generic
-0000d3b0: 5f63 6c6f 7564 3a20 7374 7229 3a0a 2020  _cloud: str):.  
-0000d3c0: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
-0000d3d0: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
-0000d3e0: 2074 6f74 616c 5f74 696d 656f 7574 5f6d   total_timeout_m
-0000d3f0: 696e 7574 6573 203d 2033 3020 6966 2067  inutes = 30 if g
-0000d400: 656e 6572 6963 5f63 6c6f 7564 203d 3d20  eneric_cloud == 
-0000d410: 2761 7a75 7265 2720 656c 7365 2031 350a  'azure' else 15.
-0000d420: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
-0000d430: 0a20 2020 2020 2020 2027 6a6f 625f 7175  .        'job_qu
-0000d440: 6575 655f 6d75 6c74 696e 6f64 6527 2c0a  eue_multinode',.
-0000d450: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
-0000d460: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
-0000d470: 6368 202d 7920 2d63 207b 6e61 6d65 7d20  ch -y -c {name} 
-0000d480: 2d2d 636c 6f75 6420 7b67 656e 6572 6963  --cloud {generic
-0000d490: 5f63 6c6f 7564 7d20 6578 616d 706c 6573  _cloud} examples
-0000d4a0: 2f6a 6f62 5f71 7565 7565 2f63 6c75 7374  /job_queue/clust
-0000d4b0: 6572 5f6d 756c 7469 6e6f 6465 2e79 616d  er_multinode.yam
-0000d4c0: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
-0000d4d0: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
-0000d4e0: 7d20 2d6e 207b 6e61 6d65 7d2d 3120 2d64  } -n {name}-1 -d
-0000d4f0: 2065 7861 6d70 6c65 732f 6a6f 625f 7175   examples/job_qu
-0000d500: 6575 652f 6a6f 625f 6d75 6c74 696e 6f64  eue/job_multinod
-0000d510: 652e 7961 6d6c 272c 0a20 2020 2020 2020  e.yaml',.       
-0000d520: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
-0000d530: 7b6e 616d 657d 202d 6e20 7b6e 616d 657d  {name} -n {name}
-0000d540: 2d32 202d 6420 6578 616d 706c 6573 2f6a  -2 -d examples/j
-0000d550: 6f62 5f71 7565 7565 2f6a 6f62 5f6d 756c  ob_queue/job_mul
-0000d560: 7469 6e6f 6465 2e79 616d 6c27 2c0a 2020  tinode.yaml',.  
-0000d570: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0000d580: 6c61 756e 6368 202d 6320 7b6e 616d 657d  launch -c {name}
-0000d590: 202d 6e20 7b6e 616d 657d 2d33 202d 2d64   -n {name}-3 --d
-0000d5a0: 6574 6163 682d 7365 7475 7020 2d64 2065  etach-setup -d e
-0000d5b0: 7861 6d70 6c65 732f 6a6f 625f 7175 6575  xamples/job_queu
-0000d5c0: 652f 6a6f 625f 6d75 6c74 696e 6f64 652e  e/job_multinode.
-0000d5d0: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
-0000d5e0: 2020 2066 2773 3d24 2873 6b79 2071 7565     f's=$(sky que
-0000d5f0: 7565 207b 6e61 6d65 7d29 2026 2620 6563  ue {name}) && ec
-0000d600: 686f 2022 2473 2220 2626 2028 6563 686f  ho "$s" && (echo
-0000d610: 2022 2473 2220 7c20 6772 6570 207b 6e61   "$s" | grep {na
-0000d620: 6d65 7d2d 3120 7c20 6772 6570 2052 554e  me}-1 | grep RUN
-0000d630: 4e49 4e47 2927 2c0a 2020 2020 2020 2020  NING)',.        
-0000d640: 2020 2020 6627 733d 2428 736b 7920 7175      f's=$(sky qu
-0000d650: 6575 6520 7b6e 616d 657d 2920 2626 2065  eue {name}) && e
-0000d660: 6368 6f20 2224 7322 2026 2620 2865 6368  cho "$s" && (ech
-0000d670: 6f20 2224 7322 207c 2067 7265 7020 7b6e  o "$s" | grep {n
-0000d680: 616d 657d 2d32 207c 2067 7265 7020 5255  ame}-2 | grep RU
-0000d690: 4e4e 494e 4729 272c 0a20 2020 2020 2020  NNING)',.       
-0000d6a0: 2020 2020 2066 2773 3d24 2873 6b79 2071       f's=$(sky q
-0000d6b0: 7565 7565 207b 6e61 6d65 7d29 2026 2620  ueue {name}) && 
-0000d6c0: 6563 686f 2022 2473 2220 2626 2028 6563  echo "$s" && (ec
-0000d6d0: 686f 2022 2473 2220 7c20 6772 6570 207b  ho "$s" | grep {
-0000d6e0: 6e61 6d65 7d2d 3320 7c20 6772 6570 2050  name}-3 | grep P
-0000d6f0: 454e 4449 4e47 2927 2c0a 2020 2020 2020  ENDING)',.      
-0000d700: 2020 2020 2020 2773 6c65 6570 2039 3027        'sleep 90'
-0000d710: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0000d720: 736b 7920 6361 6e63 656c 202d 7920 7b6e  sky cancel -y {n
-0000d730: 616d 657d 2031 272c 0a20 2020 2020 2020  ame} 1',.       
-0000d740: 2020 2020 2027 736c 6565 7020 3527 2c0a       'sleep 5',.
-0000d750: 2020 2020 2020 2020 2020 2020 6627 733d              f's=
-0000d760: 2428 736b 7920 7175 6575 6520 7b6e 616d  $(sky queue {nam
-0000d770: 657d 293b 2065 6368 6f20 2224 7322 3b20  e}); echo "$s"; 
-0000d780: 6563 686f 3b20 6563 686f 3b20 6563 686f  echo; echo; echo
-0000d790: 2022 2473 2220 7c20 6772 6570 207b 6e61   "$s" | grep {na
-0000d7a0: 6d65 7d2d 3320 7c20 6772 6570 2053 4554  me}-3 | grep SET
-0000d7b0: 5449 4e47 5f55 5027 2c0a 2020 2020 2020  TING_UP',.      
-0000d7c0: 2020 2020 2020 6627 736b 7920 6361 6e63        f'sky canc
-0000d7d0: 656c 202d 7920 7b6e 616d 657d 2031 2032  el -y {name} 1 2
-0000d7e0: 2033 272c 0a20 2020 2020 2020 2020 2020   3',.           
-0000d7f0: 2066 2773 6b79 206c 6175 6e63 6820 2d63   f'sky launch -c
-0000d800: 207b 6e61 6d65 7d20 2d6e 207b 6e61 6d65   {name} -n {name
-0000d810: 7d2d 3420 2d2d 6465 7461 6368 2d73 6574  }-4 --detach-set
-0000d820: 7570 202d 6420 6578 616d 706c 6573 2f6a  up -d examples/j
-0000d830: 6f62 5f71 7565 7565 2f6a 6f62 5f6d 756c  ob_queue/job_mul
-0000d840: 7469 6e6f 6465 2e79 616d 6c27 2c0a 2020  tinode.yaml',.  
-0000d850: 2020 2020 2020 2020 2020 2320 5465 7374            # Test
-0000d860: 2074 6865 206a 6f62 2073 7461 7475 7320   the job status 
-0000d870: 6973 2063 6f72 7265 6374 6c79 2073 6574  is correctly set
-0000d880: 2074 6f20 5345 5454 494e 475f 5550 2c20   to SETTING_UP, 
-0000d890: 6475 7269 6e67 2074 6865 2073 6574 7570  during the setup
-0000d8a0: 2069 7320 7275 6e6e 696e 672c 0a20 2020   is running,.   
-0000d8b0: 2020 2020 2020 2020 2023 2061 6e64 2074           # and t
-0000d8c0: 6865 206a 6f62 2063 616e 2062 6520 6361  he job can be ca
-0000d8d0: 6e63 656c 6c65 6420 6475 7269 6e67 2074  ncelled during t
-0000d8e0: 6865 2073 6574 7570 2e0a 2020 2020 2020  he setup..      
-0000d8f0: 2020 2020 2020 2773 6c65 6570 2035 272c        'sleep 5',
-0000d900: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000d910: 3d24 2873 6b79 2071 7565 7565 207b 6e61  =$(sky queue {na
-0000d920: 6d65 7d29 2026 2620 6563 686f 2022 2473  me}) && echo "$s
-0000d930: 2220 2626 2028 6563 686f 2022 2473 2220  " && (echo "$s" 
-0000d940: 7c20 6772 6570 207b 6e61 6d65 7d2d 3420  | grep {name}-4 
-0000d950: 7c20 6772 6570 2053 4554 5449 4e47 5f55  | grep SETTING_U
-0000d960: 5029 272c 0a20 2020 2020 2020 2020 2020  P)',.           
-0000d970: 2066 2773 6b79 2063 616e 6365 6c20 2d79   f'sky cancel -y
-0000d980: 207b 6e61 6d65 7d20 3427 2c0a 2020 2020   {name} 4',.    
-0000d990: 2020 2020 2020 2020 6627 733d 2428 736b          f's=$(sk
-0000d9a0: 7920 7175 6575 6520 7b6e 616d 657d 2920  y queue {name}) 
-0000d9b0: 2626 2065 6368 6f20 2224 7322 2026 2620  && echo "$s" && 
-0000d9c0: 2865 6368 6f20 2224 7322 207c 2067 7265  (echo "$s" | gre
-0000d9d0: 7020 7b6e 616d 657d 2d34 207c 2067 7265  p {name}-4 | gre
-0000d9e0: 7020 4341 4e43 454c 4c45 4429 272c 0a20  p CANCELLED)',. 
-0000d9f0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-0000da00: 2065 7865 6320 7b6e 616d 657d 202d 2d67   exec {name} --g
-0000da10: 7075 7320 5434 3a30 2e32 2022 5b5b 205c  pus T4:0.2 "[[ \
-0000da20: 2453 4b59 5049 4c4f 545f 4e55 4d5f 4750  $SKYPILOT_NUM_GP
-0000da30: 5553 5f50 4552 5f4e 4f44 4520 2d65 7120  US_PER_NODE -eq 
-0000da40: 3120 5d5d 207c 7c20 6578 6974 2031 2227  1 ]] || exit 1"'
-0000da50: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0000da60: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
-0000da70: 2d2d 6770 7573 2054 343a 302e 3220 2d2d  --gpus T4:0.2 --
-0000da80: 6e75 6d2d 6e6f 6465 7320 3220 225b 5b20  num-nodes 2 "[[ 
-0000da90: 5c24 534b 5950 494c 4f54 5f4e 554d 5f47  \$SKYPILOT_NUM_G
-0000daa0: 5055 535f 5045 525f 4e4f 4445 202d 6571  PUS_PER_NODE -eq
-0000dab0: 2031 205d 5d20 7c7c 2065 7869 7420 3122   1 ]] || exit 1"
-0000dac0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0000dad0: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
-0000dae0: 202d 2d67 7075 7320 5434 3a31 202d 2d6e   --gpus T4:1 --n
-0000daf0: 756d 2d6e 6f64 6573 2032 2022 5b5b 205c  um-nodes 2 "[[ \
-0000db00: 2453 4b59 5049 4c4f 545f 4e55 4d5f 4750  $SKYPILOT_NUM_GP
-0000db10: 5553 5f50 4552 5f4e 4f44 4520 2d65 7120  US_PER_NODE -eq 
-0000db20: 3120 5d5d 207c 7c20 6578 6974 2031 2227  1 ]] || exit 1"'
-0000db30: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0000db40: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-0000db50: 3520 2d2d 7374 6174 7573 272c 0a20 2020  5 --status',.   
-0000db60: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-0000db70: 6f67 7320 7b6e 616d 657d 2036 202d 2d73  ogs {name} 6 --s
-0000db80: 7461 7475 7327 2c0a 2020 2020 2020 2020  tatus',.        
-0000db90: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
-0000dba0: 6e61 6d65 7d20 3720 2d2d 7374 6174 7573  name} 7 --status
-0000dbb0: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
-0000dbc0: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
-0000dbd0: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
-0000dbe0: 2020 2020 2074 696d 656f 7574 3d74 6f74       timeout=tot
-0000dbf0: 616c 5f74 696d 656f 7574 5f6d 696e 7574  al_timeout_minut
-0000dc00: 6573 202a 2036 302c 0a20 2020 2029 0a20  es * 60,.    ). 
-0000dc10: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-0000dc20: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
-0000dc30: 6d61 726b 2e6e 6f5f 6c61 6d62 6461 5f63  mark.no_lambda_c
-0000dc40: 6c6f 7564 2020 2320 4e6f 204c 616d 6264  loud  # No Lambd
-0000dc50: 6120 436c 6f75 6420 564d 2068 6173 2038  a Cloud VM has 8
-0000dc60: 2043 5055 730a 6465 6620 7465 7374 5f6c   CPUs.def test_l
-0000dc70: 6172 6765 5f6a 6f62 5f71 7565 7565 2867  arge_job_queue(g
-0000dc80: 656e 6572 6963 5f63 6c6f 7564 3a20 7374  eneric_cloud: st
-0000dc90: 7229 3a0a 2020 2020 6e61 6d65 203d 205f  r):.    name = _
-0000dca0: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
-0000dcb0: 2829 0a20 2020 2074 6573 7420 3d20 5465  ().    test = Te
-0000dcc0: 7374 280a 2020 2020 2020 2020 276c 6172  st(.        'lar
-0000dcd0: 6765 5f6a 6f62 5f71 7565 7565 272c 0a20  ge_job_queue',. 
-0000dce0: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-0000dcf0: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
-0000dd00: 6820 2d79 202d 6320 7b6e 616d 657d 202d  h -y -c {name} -
-0000dd10: 2d63 7075 7320 3820 2d2d 636c 6f75 6420  -cpus 8 --cloud 
-0000dd20: 7b67 656e 6572 6963 5f63 6c6f 7564 7d27  {generic_cloud}'
-0000dd30: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0000dd40: 666f 7220 6920 696e 2060 7365 7120 3120  for i in `seq 1 
-0000dd50: 3735 603b 2064 6f20 736b 7920 6578 6563  75`; do sky exec
-0000dd60: 207b 6e61 6d65 7d20 2d6e 207b 6e61 6d65   {name} -n {name
-0000dd70: 7d2d 2469 202d 6420 2265 6368 6f20 2469  }-$i -d "echo $i
-0000dd80: 3b20 736c 6565 7020 3130 3030 3030 3030  ; sleep 10000000
-0000dd90: 3022 3b20 646f 6e65 272c 0a20 2020 2020  0"; done',.     
-0000dda0: 2020 2020 2020 2066 2773 6b79 2063 616e         f'sky can
-0000ddb0: 6365 6c20 2d79 207b 6e61 6d65 7d20 3120  cel -y {name} 1 
-0000ddc0: 3220 3320 3420 3520 3620 3720 3820 3920  2 3 4 5 6 7 8 9 
-0000ddd0: 3130 2031 3120 3132 2031 3320 3134 2031  10 11 12 13 14 1
-0000dde0: 3520 3136 272c 0a20 2020 2020 2020 2020  5 16',.         
-0000ddf0: 2020 2027 736c 6565 7020 3930 272c 0a20     'sleep 90',. 
-0000de00: 2020 2020 2020 2020 2020 2023 2045 6163             # Eac
-0000de10: 6820 6a6f 6220 7461 6b65 7320 302e 3520  h job takes 0.5 
-0000de20: 4350 5520 616e 6420 7468 6520 6465 6661  CPU and the defa
-0000de30: 756c 7420 564d 2068 6173 2038 2043 5055  ult VM has 8 CPU
-0000de40: 732c 2073 6f20 7468 6572 6520 7368 6f75  s, so there shou
-0000de50: 6c64 2062 6520 3820 2f20 302e 3520 3d20  ld be 8 / 0.5 = 
-0000de60: 3136 206a 6f62 7320 7275 6e6e 696e 672e  16 jobs running.
-0000de70: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
-0000de80: 6865 2066 6972 7374 2031 3620 6a6f 6273  he first 16 jobs
-0000de90: 2061 7265 2063 616e 6365 6c65 642c 2073   are canceled, s
-0000dea0: 6f20 7468 6572 6520 7368 6f75 6c64 2062  o there should b
-0000deb0: 6520 3735 202d 2033 3220 3d20 3433 206a  e 75 - 32 = 43 j
-0000dec0: 6f62 7320 5045 4e44 494e 472e 0a20 2020  obs PENDING..   
-0000ded0: 2020 2020 2020 2020 2066 2773 3d24 2873           f's=$(s
-0000dee0: 6b79 2071 7565 7565 207b 6e61 6d65 7d29  ky queue {name})
-0000def0: 3b20 6563 686f 2022 2473 223b 2065 6368  ; echo "$s"; ech
-0000df00: 6f3b 2065 6368 6f3b 2065 6368 6f20 2224  o; echo; echo "$
-0000df10: 7322 207c 2067 7265 7020 2d76 2067 7265  s" | grep -v gre
-0000df20: 7020 7c20 6772 6570 2050 454e 4449 4e47  p | grep PENDING
-0000df30: 207c 2077 6320 2d6c 207c 2067 7265 7020   | wc -l | grep 
-0000df40: 3433 272c 0a20 2020 2020 2020 2020 2020  43',.           
-0000df50: 2023 204d 616b 6520 7375 7265 2074 6865   # Make sure the
-0000df60: 206a 6f62 7320 6172 6520 7363 6865 6475   jobs are schedu
-0000df70: 6c65 6420 696e 2046 4946 4f20 6f72 6465  led in FIFO orde
-0000df80: 720a 2020 2020 2020 2020 2020 2020 2a5b  r.            *[
-0000df90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000dfa0: 2066 2773 3d24 2873 6b79 2071 7565 7565   f's=$(sky queue
-0000dfb0: 207b 6e61 6d65 7d29 3b20 6563 686f 2022   {name}); echo "
-0000dfc0: 2473 223b 2065 6368 6f3b 2065 6368 6f3b  $s"; echo; echo;
-0000dfd0: 2065 6368 6f20 2224 7322 207c 2067 7265   echo "$s" | gre
-0000dfe0: 7020 7b6e 616d 657d 2d7b 697d 207c 2067  p {name}-{i} | g
-0000dff0: 7265 7020 4341 4e43 454c 4c45 4427 0a20  rep CANCELLED'. 
-0000e000: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0000e010: 6f72 2069 2069 6e20 7261 6e67 6528 312c  or i in range(1,
-0000e020: 2031 3729 0a20 2020 2020 2020 2020 2020   17).           
-0000e030: 205d 2c0a 2020 2020 2020 2020 2020 2020   ],.            
-0000e040: 2a5b 0a20 2020 2020 2020 2020 2020 2020  *[.             
-0000e050: 2020 2066 2773 3d24 2873 6b79 2071 7565     f's=$(sky que
-0000e060: 7565 207b 6e61 6d65 7d29 3b20 6563 686f  ue {name}); echo
-0000e070: 2022 2473 223b 2065 6368 6f3b 2065 6368   "$s"; echo; ech
-0000e080: 6f3b 2065 6368 6f20 2224 7322 207c 2067  o; echo "$s" | g
-0000e090: 7265 7020 7b6e 616d 657d 2d7b 697d 207c  rep {name}-{i} |
-0000e0a0: 2067 7265 7020 5255 4e4e 494e 4727 0a20   grep RUNNING'. 
-0000e0b0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0000e0c0: 6f72 2069 2069 6e20 7261 6e67 6528 3137  or i in range(17
-0000e0d0: 2c20 3333 290a 2020 2020 2020 2020 2020  , 33).          
-0000e0e0: 2020 5d2c 0a20 2020 2020 2020 2020 2020    ],.           
-0000e0f0: 202a 5b0a 2020 2020 2020 2020 2020 2020   *[.            
-0000e100: 2020 2020 6627 733d 2428 736b 7920 7175      f's=$(sky qu
-0000e110: 6575 6520 7b6e 616d 657d 293b 2065 6368  eue {name}); ech
-0000e120: 6f20 2224 7322 3b20 6563 686f 3b20 6563  o "$s"; echo; ec
-0000e130: 686f 3b20 6563 686f 2022 2473 2220 7c20  ho; echo "$s" | 
-0000e140: 6772 6570 207b 6e61 6d65 7d2d 7b69 7d20  grep {name}-{i} 
-0000e150: 7c20 6772 6570 2050 454e 4449 4e47 270a  | grep PENDING'.
-0000e160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e170: 666f 7220 6920 696e 2072 616e 6765 2833  for i in range(3
-0000e180: 332c 2037 3529 0a20 2020 2020 2020 2020  3, 75).         
-0000e190: 2020 205d 2c0a 2020 2020 2020 2020 2020     ],.          
-0000e1a0: 2020 6627 736b 7920 6361 6e63 656c 202d    f'sky cancel -
-0000e1b0: 7920 7b6e 616d 657d 2033 3320 3335 2033  y {name} 33 35 3
-0000e1c0: 3720 3339 2031 3720 3138 2031 3927 2c0a  7 39 17 18 19',.
-0000e1d0: 2020 2020 2020 2020 2020 2020 2a5b 0a20              *[. 
-0000e1e0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0000e1f0: 2773 3d24 2873 6b79 2071 7565 7565 207b  's=$(sky queue {
-0000e200: 6e61 6d65 7d29 3b20 6563 686f 2022 2473  name}); echo "$s
-0000e210: 223b 2065 6368 6f3b 2065 6368 6f3b 2065  "; echo; echo; e
-0000e220: 6368 6f20 2224 7322 207c 2067 7265 7020  cho "$s" | grep 
-0000e230: 7b6e 616d 657d 2d7b 697d 207c 2067 7265  {name}-{i} | gre
-0000e240: 7020 4341 4e43 454c 4c45 4427 0a20 2020  p CANCELLED'.   
-0000e250: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-0000e260: 2069 2069 6e20 7261 6e67 6528 3333 2c20   i in range(33, 
-0000e270: 3430 2c20 3229 0a20 2020 2020 2020 2020  40, 2).         
-0000e280: 2020 205d 2c0a 2020 2020 2020 2020 2020     ],.          
-0000e290: 2020 2773 6c65 6570 2031 3027 2c0a 2020    'sleep 10',.  
-0000e2a0: 2020 2020 2020 2020 2020 2a5b 0a20 2020            *[.   
-0000e2b0: 2020 2020 2020 2020 2020 2020 2066 2773               f's
-0000e2c0: 3d24 2873 6b79 2071 7565 7565 207b 6e61  =$(sky queue {na
-0000e2d0: 6d65 7d29 3b20 6563 686f 2022 2473 223b  me}); echo "$s";
-0000e2e0: 2065 6368 6f3b 2065 6368 6f3b 2065 6368   echo; echo; ech
-0000e2f0: 6f20 2224 7322 207c 2067 7265 7020 7b6e  o "$s" | grep {n
-0000e300: 616d 657d 2d7b 697d 207c 2067 7265 7020  ame}-{i} | grep 
-0000e310: 5255 4e4e 494e 4727 0a20 2020 2020 2020  RUNNING'.       
-0000e320: 2020 2020 2020 2020 2066 6f72 2069 2069           for i i
-0000e330: 6e20 5b33 342c 2033 362c 2033 385d 0a20  n [34, 36, 38]. 
-0000e340: 2020 2020 2020 2020 2020 205d 2c0a 2020             ],.  
-0000e350: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-0000e360: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
-0000e370: 6e61 6d65 7d27 2c0a 2020 2020 2020 2020  name}',.        
-0000e380: 7469 6d65 6f75 743d 3235 202a 2036 302c  timeout=25 * 60,
-0000e390: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
-0000e3a0: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
-0000e3b0: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
-0000e3c0: 6c61 6d62 6461 5f63 6c6f 7564 2020 2320  lambda_cloud  # 
-0000e3d0: 4e6f 204c 616d 6264 6120 436c 6f75 6420  No Lambda Cloud 
-0000e3e0: 564d 2068 6173 2038 2043 5055 730a 6465  VM has 8 CPUs.de
-0000e3f0: 6620 7465 7374 5f66 6173 745f 6c61 7267  f test_fast_larg
-0000e400: 655f 6a6f 625f 7175 6575 6528 6765 6e65  e_job_queue(gene
-0000e410: 7269 635f 636c 6f75 643a 2073 7472 293a  ric_cloud: str):
-0000e420: 0a20 2020 2023 2054 6869 7320 6973 2074  .    # This is t
-0000e430: 6f20 7465 7374 2074 6865 206a 6f62 7320  o test the jobs 
-0000e440: 6361 6e20 6265 2073 6368 6564 756c 6564  can be scheduled
-0000e450: 2071 7569 636b 6c79 2077 6865 6e20 7468   quickly when th
-0000e460: 6572 6520 6172 6520 6d61 6e79 206a 6f62  ere are many job
-0000e470: 7320 696e 2074 6865 2071 7565 7565 2e0a  s in the queue..
-0000e480: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
-0000e490: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
-0000e4a0: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
-0000e4b0: 2020 2020 2020 2020 2766 6173 745f 6c61          'fast_la
-0000e4c0: 7267 655f 6a6f 625f 7175 6575 6527 2c0a  rge_job_queue',.
-0000e4d0: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
-0000e4e0: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
-0000e4f0: 6368 202d 7920 2d63 207b 6e61 6d65 7d20  ch -y -c {name} 
-0000e500: 2d2d 6370 7573 2038 202d 2d63 6c6f 7564  --cpus 8 --cloud
-0000e510: 207b 6765 6e65 7269 635f 636c 6f75 647d   {generic_cloud}
-0000e520: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0000e530: 2766 6f72 2069 2069 6e20 6073 6571 2031  'for i in `seq 1
-0000e540: 2033 3260 3b20 646f 2073 6b79 2065 7865   32`; do sky exe
-0000e550: 6320 7b6e 616d 657d 202d 6e20 7b6e 616d  c {name} -n {nam
-0000e560: 657d 2d24 6920 2d64 2022 6563 686f 2024  e}-$i -d "echo $
-0000e570: 6922 3b20 646f 6e65 272c 0a20 2020 2020  i"; done',.     
-0000e580: 2020 2020 2020 2027 736c 6565 7020 3630         'sleep 60
-0000e590: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0000e5a0: 2773 3d24 2873 6b79 2071 7565 7565 207b  's=$(sky queue {
-0000e5b0: 6e61 6d65 7d29 3b20 6563 686f 2022 2473  name}); echo "$s
-0000e5c0: 223b 2065 6368 6f3b 2065 6368 6f3b 2065  "; echo; echo; e
-0000e5d0: 6368 6f20 2224 7322 207c 2067 7265 7020  cho "$s" | grep 
-0000e5e0: 2d76 2067 7265 7020 7c20 6772 6570 2053  -v grep | grep S
-0000e5f0: 5543 4345 4544 4544 207c 2077 6320 2d6c  UCCEEDED | wc -l
-0000e600: 207c 2067 7265 7020 3332 272c 0a20 2020   | grep 32',.   
-0000e610: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-0000e620: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
-0000e630: 616d 657d 272c 0a20 2020 2020 2020 2074  ame}',.        t
-0000e640: 696d 656f 7574 3d32 3020 2a20 3630 2c0a  imeout=20 * 60,.
-0000e650: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
-0000e660: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
-0000e670: 7079 7465 7374 2e6d 6172 6b2e 6962 6d0a  pytest.mark.ibm.
-0000e680: 6465 6620 7465 7374 5f69 626d 5f6a 6f62  def test_ibm_job
-0000e690: 5f71 7565 7565 5f6d 756c 7469 6e6f 6465  _queue_multinode
-0000e6a0: 2829 3a0a 2020 2020 6e61 6d65 203d 205f  ():.    name = _
-0000e6b0: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
-0000e6c0: 2829 0a20 2020 2074 6173 6b5f 6669 6c65  ().    task_file
-0000e6d0: 203d 2027 6578 616d 706c 6573 2f6a 6f62   = 'examples/job
-0000e6e0: 5f71 7565 7565 2f6a 6f62 5f6d 756c 7469  _queue/job_multi
-0000e6f0: 6e6f 6465 5f69 626d 2e79 616d 6c27 0a20  node_ibm.yaml'. 
-0000e700: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
-0000e710: 2020 2020 2020 2020 2769 626d 5f6a 6f62          'ibm_job
-0000e720: 5f71 7565 7565 5f6d 756c 7469 6e6f 6465  _queue_multinode
-0000e730: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
-0000e740: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-0000e750: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
-0000e760: 657d 202d 2d63 6c6f 7564 2069 626d 202d  e} --cloud ibm -
-0000e770: 2d67 7075 7320 7631 3030 202d 2d6e 756d  -gpus v100 --num
-0000e780: 2d6e 6f64 6573 2032 272c 0a20 2020 2020  -nodes 2',.     
-0000e790: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
-0000e7a0: 6320 7b6e 616d 657d 202d 6e20 7b6e 616d  c {name} -n {nam
-0000e7b0: 657d 2d31 202d 6420 7b74 6173 6b5f 6669  e}-1 -d {task_fi
-0000e7c0: 6c65 7d27 2c0a 2020 2020 2020 2020 2020  le}',.          
-0000e7d0: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
-0000e7e0: 6d65 7d20 2d6e 207b 6e61 6d65 7d2d 3220  me} -n {name}-2 
-0000e7f0: 2d64 207b 7461 736b 5f66 696c 657d 272c  -d {task_file}',
-0000e800: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000e810: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
-0000e820: 7b6e 616d 657d 202d 6e20 7b6e 616d 657d  {name} -n {name}
-0000e830: 2d33 202d 2d64 6574 6163 682d 7365 7475  -3 --detach-setu
-0000e840: 7020 2d64 207b 7461 736b 5f66 696c 657d  p -d {task_file}
-0000e850: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0000e860: 2773 3d24 2873 6b79 2071 7565 7565 207b  's=$(sky queue {
-0000e870: 6e61 6d65 7d29 2026 2620 7072 696e 7466  name}) && printf
-0000e880: 2022 2473 2220 2626 2028 6563 686f 2022   "$s" && (echo "
-0000e890: 2473 2220 7c20 6772 6570 207b 6e61 6d65  $s" | grep {name
-0000e8a0: 7d2d 3120 7c20 6772 6570 2052 554e 4e49  }-1 | grep RUNNI
-0000e8b0: 4e47 2927 2c0a 2020 2020 2020 2020 2020  NG)',.          
-0000e8c0: 2020 6627 733d 2428 736b 7920 7175 6575    f's=$(sky queu
-0000e8d0: 6520 7b6e 616d 657d 2920 2626 2070 7269  e {name}) && pri
-0000e8e0: 6e74 6620 2224 7322 2026 2620 2865 6368  ntf "$s" && (ech
-0000e8f0: 6f20 2224 7322 207c 2067 7265 7020 7b6e  o "$s" | grep {n
-0000e900: 616d 657d 2d32 207c 2067 7265 7020 5255  ame}-2 | grep RU
-0000e910: 4e4e 494e 4729 272c 0a20 2020 2020 2020  NNING)',.       
-0000e920: 2020 2020 2066 2773 3d24 2873 6b79 2071       f's=$(sky q
-0000e930: 7565 7565 207b 6e61 6d65 7d29 2026 2620  ueue {name}) && 
-0000e940: 7072 696e 7466 2022 2473 2220 2626 2028  printf "$s" && (
-0000e950: 6563 686f 2022 2473 2220 7c20 6772 6570  echo "$s" | grep
-0000e960: 207b 6e61 6d65 7d2d 3320 7c20 6772 6570   {name}-3 | grep
-0000e970: 2053 4554 5449 4e47 5f55 5029 272c 0a20   SETTING_UP)',. 
-0000e980: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
-0000e990: 7020 3930 272c 0a20 2020 2020 2020 2020  p 90',.         
-0000e9a0: 2020 2066 2773 3d24 2873 6b79 2071 7565     f's=$(sky que
-0000e9b0: 7565 207b 6e61 6d65 7d29 2026 2620 7072  ue {name}) && pr
-0000e9c0: 696e 7466 2022 2473 2220 2626 2028 6563  intf "$s" && (ec
-0000e9d0: 686f 2022 2473 2220 7c20 6772 6570 207b  ho "$s" | grep {
-0000e9e0: 6e61 6d65 7d2d 3320 7c20 6772 6570 2050  name}-3 | grep P
-0000e9f0: 454e 4449 4e47 2927 2c0a 2020 2020 2020  ENDING)',.      
-0000ea00: 2020 2020 2020 6627 736b 7920 6361 6e63        f'sky canc
-0000ea10: 656c 202d 7920 7b6e 616d 657d 2031 272c  el -y {name} 1',
-0000ea20: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
-0000ea30: 6565 7020 3527 2c0a 2020 2020 2020 2020  eep 5',.        
-0000ea40: 2020 2020 6627 736b 7920 7175 6575 6520      f'sky queue 
-0000ea50: 7b6e 616d 657d 207c 2067 7265 7020 7b6e  {name} | grep {n
-0000ea60: 616d 657d 2d33 207c 2067 7265 7020 5255  ame}-3 | grep RU
-0000ea70: 4e4e 494e 4727 2c0a 2020 2020 2020 2020  NNING',.        
-0000ea80: 2020 2020 6627 736b 7920 6361 6e63 656c      f'sky cancel
-0000ea90: 202d 7920 7b6e 616d 657d 2031 2032 2033   -y {name} 1 2 3
-0000eaa0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0000eab0: 2773 6b79 206c 6175 6e63 6820 2d63 207b  'sky launch -c {
-0000eac0: 6e61 6d65 7d20 2d6e 207b 6e61 6d65 7d2d  name} -n {name}-
-0000ead0: 3420 2d2d 6465 7461 6368 2d73 6574 7570  4 --detach-setup
-0000eae0: 202d 6420 7b74 6173 6b5f 6669 6c65 7d27   -d {task_file}'
-0000eaf0: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-0000eb00: 5465 7374 2074 6865 206a 6f62 2073 7461  Test the job sta
-0000eb10: 7475 7320 6973 2063 6f72 7265 6374 6c79  tus is correctly
-0000eb20: 2073 6574 2074 6f20 5345 5454 494e 475f   set to SETTING_
-0000eb30: 5550 2c20 6475 7269 6e67 2074 6865 2073  UP, during the s
-0000eb40: 6574 7570 2069 7320 7275 6e6e 696e 672c  etup is running,
-0000eb50: 0a20 2020 2020 2020 2020 2020 2023 2061  .            # a
-0000eb60: 6e64 2074 6865 206a 6f62 2063 616e 2062  nd the job can b
-0000eb70: 6520 6361 6e63 656c 6c65 6420 6475 7269  e cancelled duri
-0000eb80: 6e67 2074 6865 2073 6574 7570 2e0a 2020  ng the setup..  
-0000eb90: 2020 2020 2020 2020 2020 6627 733d 2428            f's=$(
-0000eba0: 736b 7920 7175 6575 6520 7b6e 616d 657d  sky queue {name}
-0000ebb0: 2920 2626 2070 7269 6e74 6620 2224 7322  ) && printf "$s"
-0000ebc0: 2026 2620 2865 6368 6f20 2224 7322 207c   && (echo "$s" |
-0000ebd0: 2067 7265 7020 7b6e 616d 657d 2d34 207c   grep {name}-4 |
-0000ebe0: 2067 7265 7020 5345 5454 494e 475f 5550   grep SETTING_UP
-0000ebf0: 2927 2c0a 2020 2020 2020 2020 2020 2020  )',.            
-0000ec00: 6627 736b 7920 6361 6e63 656c 202d 7920  f'sky cancel -y 
-0000ec10: 7b6e 616d 657d 2034 272c 0a20 2020 2020  {name} 4',.     
-0000ec20: 2020 2020 2020 2066 2773 3d24 2873 6b79         f's=$(sky
-0000ec30: 2071 7565 7565 207b 6e61 6d65 7d29 2026   queue {name}) &
-0000ec40: 2620 7072 696e 7466 2022 2473 2220 2626  & printf "$s" &&
-0000ec50: 2028 6563 686f 2022 2473 2220 7c20 6772   (echo "$s" | gr
-0000ec60: 6570 207b 6e61 6d65 7d2d 3420 7c20 6772  ep {name}-4 | gr
-0000ec70: 6570 2043 414e 4345 4c4c 4544 2927 2c0a  ep CANCELLED)',.
-0000ec80: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0000ec90: 7920 6578 6563 207b 6e61 6d65 7d20 2d2d  y exec {name} --
-0000eca0: 6770 7573 2076 3130 303a 302e 3220 225b  gpus v100:0.2 "[
-0000ecb0: 5b20 5c24 534b 5950 494c 4f54 5f4e 554d  [ \$SKYPILOT_NUM
-0000ecc0: 5f47 5055 535f 5045 525f 4e4f 4445 202d  _GPUS_PER_NODE -
-0000ecd0: 6571 2031 205d 5d20 7c7c 2065 7869 7420  eq 1 ]] || exit 
-0000ece0: 3122 272c 0a20 2020 2020 2020 2020 2020  1"',.           
-0000ecf0: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
-0000ed00: 657d 202d 2d67 7075 7320 7631 3030 3a30  e} --gpus v100:0
-0000ed10: 2e32 202d 2d6e 756d 2d6e 6f64 6573 2032  .2 --num-nodes 2
-0000ed20: 2022 5b5b 205c 2453 4b59 5049 4c4f 545f   "[[ \$SKYPILOT_
-0000ed30: 4e55 4d5f 4750 5553 5f50 4552 5f4e 4f44  NUM_GPUS_PER_NOD
-0000ed40: 4520 2d65 7120 3120 5d5d 207c 7c20 6578  E -eq 1 ]] || ex
-0000ed50: 6974 2031 2227 2c0a 2020 2020 2020 2020  it 1"',.        
-0000ed60: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
-0000ed70: 6e61 6d65 7d20 2d2d 6770 7573 2076 3130  name} --gpus v10
-0000ed80: 303a 3120 2d2d 6e75 6d2d 6e6f 6465 7320  0:1 --num-nodes 
-0000ed90: 3220 225b 5b20 5c24 534b 5950 494c 4f54  2 "[[ \$SKYPILOT
-0000eda0: 5f4e 554d 5f47 5055 535f 5045 525f 4e4f  _NUM_GPUS_PER_NO
-0000edb0: 4445 202d 6571 2031 205d 5d20 7c7c 2065  DE -eq 1 ]] || e
-0000edc0: 7869 7420 3122 272c 0a20 2020 2020 2020  xit 1"',.       
-0000edd0: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-0000ede0: 7b6e 616d 657d 2035 202d 2d73 7461 7475  {name} 5 --statu
-0000edf0: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
-0000ee00: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
-0000ee10: 7d20 3620 2d2d 7374 6174 7573 272c 0a20  } 6 --status',. 
-0000ee20: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-0000ee30: 206c 6f67 7320 7b6e 616d 657d 2037 202d   logs {name} 7 -
-0000ee40: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
-0000ee50: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
-0000ee60: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
-0000ee70: 7d27 2c0a 2020 2020 2020 2020 7469 6d65  }',.        time
-0000ee80: 6f75 743d 3230 202a 2036 302c 2020 2320  out=20 * 60,  # 
-0000ee90: 3230 206d 696e 730a 2020 2020 290a 2020  20 mins.    ).  
-0000eea0: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
-0000eeb0: 6573 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d  est)...# -------
-0000eec0: 2d2d 2d20 446f 636b 6572 2077 6974 6820  --- Docker with 
-0000eed0: 7072 6569 6e73 7461 6c6c 6564 2070 6163  preinstalled pac
-0000eee0: 6b61 6765 2e20 2d2d 2d2d 2d2d 2d2d 2d2d  kage. ----------
-0000eef0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
-0000ef00: 5f66 6c75 6964 7374 6163 6b20 2023 2044  _fluidstack  # D
-0000ef10: 6f65 736e 2774 2073 7570 706f 7274 2046  oesn't support F
-0000ef20: 6c75 6964 7374 6163 6b20 666f 7220 6e6f  luidstack for no
-0000ef30: 770a 4070 7974 6573 742e 6d61 726b 2e6e  w.@pytest.mark.n
-0000ef40: 6f5f 6c61 6d62 6461 5f63 6c6f 7564 2020  o_lambda_cloud  
-0000ef50: 2320 446f 6573 6e27 7420 7375 7070 6f72  # Doesn't suppor
-0000ef60: 7420 4c61 6d62 6461 2043 6c6f 7564 2066  t Lambda Cloud f
-0000ef70: 6f72 206e 6f77 0a40 7079 7465 7374 2e6d  or now.@pytest.m
-0000ef80: 6172 6b2e 6e6f 5f69 626d 2020 2320 446f  ark.no_ibm  # Do
-0000ef90: 6573 6e27 7420 7375 7070 6f72 7420 4942  esn't support IB
-0000efa0: 4d20 436c 6f75 6420 666f 7220 6e6f 770a  M Cloud for now.
-0000efb0: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
-0000efc0: 7363 7020 2023 2044 6f65 736e 2774 2073  scp  # Doesn't s
-0000efd0: 7570 706f 7274 2053 4350 2066 6f72 206e  upport SCP for n
-0000efe0: 6f77 0a40 7079 7465 7374 2e6d 6172 6b2e  ow.@pytest.mark.
-0000eff0: 6e6f 5f6f 6369 2020 2320 446f 6573 6e27  no_oci  # Doesn'
-0000f000: 7420 7375 7070 6f72 7420 4f43 4920 666f  t support OCI fo
-0000f010: 7220 6e6f 770a 4070 7974 6573 742e 6d61  r now.@pytest.ma
-0000f020: 726b 2e6e 6f5f 6b75 6265 726e 6574 6573  rk.no_kubernetes
-0000f030: 2020 2320 446f 6573 6e27 7420 7375 7070    # Doesn't supp
-0000f040: 6f72 7420 4b75 6265 726e 6574 6573 2066  ort Kubernetes f
-0000f050: 6f72 206e 6f77 0a23 2054 4f44 4f28 7a68  or now.# TODO(zh
-0000f060: 7775 293a 2077 6520 7368 6f75 6c64 2066  wu): we should f
-0000f070: 6978 2074 6869 7320 666f 7220 6b75 6265  ix this for kube
-0000f080: 726e 6574 6573 0a64 6566 2074 6573 745f  rnetes.def test_
-0000f090: 646f 636b 6572 5f70 7265 696e 7374 616c  docker_preinstal
-0000f0a0: 6c65 645f 7061 636b 6167 6528 6765 6e65  led_package(gene
-0000f0b0: 7269 635f 636c 6f75 643a 2073 7472 293a  ric_cloud: str):
-0000f0c0: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
-0000f0d0: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
-0000f0e0: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
-0000f0f0: 0a20 2020 2020 2020 2027 646f 636b 6572  .        'docker
-0000f100: 5f77 6974 685f 7072 6569 6e73 7461 6c6c  _with_preinstall
-0000f110: 6564 5f70 6163 6b61 6765 272c 0a20 2020  ed_package',.   
-0000f120: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
-0000f130: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
-0000f140: 2d79 202d 6320 7b6e 616d 657d 202d 2d63  -y -c {name} --c
-0000f150: 6c6f 7564 207b 6765 6e65 7269 635f 636c  loud {generic_cl
-0000f160: 6f75 647d 202d 2d69 6d61 6765 2d69 6420  oud} --image-id 
-0000f170: 646f 636b 6572 3a6e 6769 6e78 272c 0a20  docker:nginx',. 
-0000f180: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-0000f190: 2065 7865 6320 7b6e 616d 657d 2022 6e67   exec {name} "ng
-0000f1a0: 696e 7820 2d56 2227 2c0a 2020 2020 2020  inx -V"',.      
-0000f1b0: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
-0000f1c0: 207b 6e61 6d65 7d20 3120 2d2d 7374 6174   {name} 1 --stat
-0000f1d0: 7573 272c 0a20 2020 2020 2020 2020 2020  us',.           
-0000f1e0: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
-0000f1f0: 657d 2077 686f 616d 6920 7c20 6772 6570  e} whoami | grep
-0000f200: 2072 6f6f 7427 2c0a 2020 2020 2020 2020   root',.        
-0000f210: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
-0000f220: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
-0000f230: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
-0000f240: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
-0000f250: 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20 5375  .# ---------- Su
-0000f260: 626d 6974 7469 6e67 206d 756c 7469 706c  bmitting multipl
-0000f270: 6520 7461 736b 7320 746f 2074 6865 2073  e tasks to the s
-0000f280: 616d 6520 636c 7573 7465 722e 202d 2d2d  ame cluster. ---
-0000f290: 2d2d 2d2d 2d2d 2d0a 4070 7974 6573 742e  -------.@pytest.
-0000f2a0: 6d61 726b 2e6e 6f5f 666c 7569 6473 7461  mark.no_fluidsta
-0000f2b0: 636b 2020 2320 466c 7569 6453 7461 636b  ck  # FluidStack
-0000f2c0: 2044 4320 6861 7320 6c6f 7720 6176 6169   DC has low avai
-0000f2d0: 6c61 6269 6c69 7479 206f 6620 5434 2047  lability of T4 G
-0000f2e0: 5055 730a 4070 7974 6573 742e 6d61 726b  PUs.@pytest.mark
-0000f2f0: 2e6e 6f5f 6c61 6d62 6461 5f63 6c6f 7564  .no_lambda_cloud
-0000f300: 2020 2320 4c61 6d62 6461 2043 6c6f 7564    # Lambda Cloud
-0000f310: 2064 6f65 7320 6e6f 7420 6861 7665 2054   does not have T
-0000f320: 3420 6770 7573 0a40 7079 7465 7374 2e6d  4 gpus.@pytest.m
-0000f330: 6172 6b2e 6e6f 5f70 6170 6572 7370 6163  ark.no_paperspac
-0000f340: 6520 2023 2050 6170 6572 7370 6163 6520  e  # Paperspace 
-0000f350: 646f 6573 206e 6f74 2068 6176 6520 5434  does not have T4
-0000f360: 2067 7075 730a 4070 7974 6573 742e 6d61   gpus.@pytest.ma
-0000f370: 726b 2e6e 6f5f 6962 6d20 2023 2049 424d  rk.no_ibm  # IBM
-0000f380: 2043 6c6f 7564 2064 6f65 7320 6e6f 7420   Cloud does not 
-0000f390: 6861 7665 2054 3420 6770 7573 0a40 7079  have T4 gpus.@py
-0000f3a0: 7465 7374 2e6d 6172 6b2e 6e6f 5f73 6370  test.mark.no_scp
-0000f3b0: 2020 2320 5343 5020 646f 6573 206e 6f74    # SCP does not
-0000f3c0: 2073 7570 706f 7274 206e 756d 5f6e 6f64   support num_nod
-0000f3d0: 6573 203e 2031 2079 6574 0a40 7079 7465  es > 1 yet.@pyte
-0000f3e0: 7374 2e6d 6172 6b2e 6e6f 5f6f 6369 2020  st.mark.no_oci  
-0000f3f0: 2320 4f43 4920 436c 6f75 6420 646f 6573  # OCI Cloud does
-0000f400: 206e 6f74 2068 6176 6520 5434 2067 7075   not have T4 gpu
-0000f410: 730a 6465 6620 7465 7374 5f6d 756c 7469  s.def test_multi
-0000f420: 5f65 6368 6f28 6765 6e65 7269 635f 636c  _echo(generic_cl
-0000f430: 6f75 643a 2073 7472 293a 0a20 2020 206e  oud: str):.    n
-0000f440: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
-0000f450: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
-0000f460: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
-0000f470: 2020 2027 6d75 6c74 695f 6563 686f 272c     'multi_echo',
-0000f480: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
-0000f490: 2020 2020 2020 2066 2770 7974 686f 6e20         f'python 
-0000f4a0: 6578 616d 706c 6573 2f6d 756c 7469 5f65  examples/multi_e
-0000f4b0: 6368 6f2e 7079 207b 6e61 6d65 7d20 7b67  cho.py {name} {g
-0000f4c0: 656e 6572 6963 5f63 6c6f 7564 7d27 2c0a  eneric_cloud}',.
-0000f4d0: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
-0000f4e0: 6570 2031 3230 272c 0a20 2020 2020 2020  ep 120',.       
-0000f4f0: 205d 202b 0a20 2020 2020 2020 2023 2045   ] +.        # E
-0000f500: 6e73 7572 6520 6a6f 6273 2073 7563 6365  nsure jobs succe
-0000f510: 6564 6564 2e0a 2020 2020 2020 2020 5b66  eded..        [f
-0000f520: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-0000f530: 207b 6920 2b20 317d 202d 2d73 7461 7475   {i + 1} --statu
-0000f540: 7327 2066 6f72 2069 2069 6e20 7261 6e67  s' for i in rang
-0000f550: 6528 3332 295d 202b 0a20 2020 2020 2020  e(32)] +.       
-0000f560: 2023 2045 6e73 7572 6520 6d6f 6e69 746f   # Ensure monito
-0000f570: 722f 6175 746f 7363 616c 6572 2064 6964  r/autoscaler did
-0000f580: 6e27 7420 6372 6173 6820 6f6e 2074 6865  n't crash on the
-0000f590: 2027 6173 7365 7274 206e 6f74 0a20 2020   'assert not.   
-0000f5a0: 2020 2020 2023 2075 6e66 756c 6669 6c6c       # unfulfill
-0000f5b0: 6564 2720 6572 726f 722e 2020 4966 2070  ed' error.  If p
-0000f5c0: 726f 6365 7373 206e 6f74 2066 6f75 6e64  rocess not found
-0000f5d0: 2c20 6772 6570 2d3e 7373 6820 7265 7475  , grep->ssh retu
-0000f5e0: 726e 7320 312e 0a20 2020 2020 2020 205b  rns 1..        [
-0000f5f0: 6627 7373 6820 7b6e 616d 657d 205c 2770  f'ssh {name} \'p
-0000f600: 7320 6175 7820 7c20 6772 6570 2022 5b2f  s aux | grep "[/
-0000f610: 5d22 6d6f 6e69 746f 722e 7079 5c27 275d  ]"monitor.py\'']
-0000f620: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
-0000f630: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
-0000f640: 0a20 2020 2020 2020 2074 696d 656f 7574  .        timeout
-0000f650: 3d32 3020 2a20 3630 2c0a 2020 2020 290a  =20 * 60,.    ).
-0000f660: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
-0000f670: 2874 6573 7429 0a0a 0a23 202d 2d2d 2d2d  (test)...# -----
-0000f680: 2d2d 2d2d 2d20 5461 736b 3a20 3120 6e6f  ----- Task: 1 no
-0000f690: 6465 2074 7261 696e 696e 672e 202d 2d2d  de training. ---
-0000f6a0: 2d2d 2d2d 2d2d 2d0a 4070 7974 6573 742e  -------.@pytest.
-0000f6b0: 6d61 726b 2e6e 6f5f 6c61 6d62 6461 5f63  mark.no_lambda_c
-0000f6c0: 6c6f 7564 2020 2320 4c61 6d62 6461 2043  loud  # Lambda C
-0000f6d0: 6c6f 7564 2064 6f65 7320 6e6f 7420 6861  loud does not ha
-0000f6e0: 7665 2056 3130 3020 6770 7573 0a40 7079  ve V100 gpus.@py
-0000f6f0: 7465 7374 2e6d 6172 6b2e 6e6f 5f69 626d  test.mark.no_ibm
-0000f700: 2020 2320 4942 4d20 636c 6f75 6420 6375    # IBM cloud cu
-0000f710: 7272 656e 746c 7920 646f 6573 6e27 7420  rrently doesn't 
-0000f720: 7072 6f76 6964 6520 7075 626c 6963 2069  provide public i
-0000f730: 6d61 6765 2077 6974 6820 4355 4441 0a40  mage with CUDA.@
-0000f740: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f73  pytest.mark.no_s
-0000f750: 6370 2020 2320 5343 5020 646f 6573 206e  cp  # SCP does n
-0000f760: 6f74 2068 6176 6520 5631 3030 2028 3136  ot have V100 (16
-0000f770: 4742 2920 4750 5573 2e20 5275 6e20 7465  GB) GPUs. Run te
-0000f780: 7374 5f73 6370 5f68 7567 6769 6e67 6661  st_scp_huggingfa
-0000f790: 6365 2069 6e73 7465 6164 2e0a 6465 6620  ce instead..def 
-0000f7a0: 7465 7374 5f68 7567 6769 6e67 6661 6365  test_huggingface
-0000f7b0: 2867 656e 6572 6963 5f63 6c6f 7564 3a20  (generic_cloud: 
-0000f7c0: 7374 7229 3a0a 2020 2020 6e61 6d65 203d  str):.    name =
-0000f7d0: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
-0000f7e0: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
-0000f7f0: 5465 7374 280a 2020 2020 2020 2020 2768  Test(.        'h
-0000f800: 7567 6769 6e67 6661 6365 5f67 6c75 655f  uggingface_glue_
-0000f810: 696d 6462 5f61 7070 272c 0a20 2020 2020  imdb_app',.     
-0000f820: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
-0000f830: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
-0000f840: 202d 6320 7b6e 616d 657d 202d 2d63 6c6f   -c {name} --clo
-0000f850: 7564 207b 6765 6e65 7269 635f 636c 6f75  ud {generic_clou
-0000f860: 647d 2065 7861 6d70 6c65 732f 6875 6767  d} examples/hugg
-0000f870: 696e 6766 6163 655f 676c 7565 5f69 6d64  ingface_glue_imd
-0000f880: 625f 6170 702e 7961 6d6c 272c 0a20 2020  b_app.yaml',.   
-0000f890: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-0000f8a0: 6f67 7320 7b6e 616d 657d 2031 202d 2d73  ogs {name} 1 --s
-0000f8b0: 7461 7475 7327 2c20 2023 2045 6e73 7572  tatus',  # Ensur
-0000f8c0: 6520 7468 6520 6a6f 6220 7375 6363 6565  e the job succee
-0000f8d0: 6465 642e 0a20 2020 2020 2020 2020 2020  ded..           
-0000f8e0: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
-0000f8f0: 657d 2065 7861 6d70 6c65 732f 6875 6767  e} examples/hugg
-0000f900: 696e 6766 6163 655f 676c 7565 5f69 6d64  ingface_glue_imd
-0000f910: 625f 6170 702e 7961 6d6c 272c 0a20 2020  b_app.yaml',.   
-0000f920: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-0000f930: 6f67 7320 7b6e 616d 657d 2032 202d 2d73  ogs {name} 2 --s
-0000f940: 7461 7475 7327 2c20 2023 2045 6e73 7572  tatus',  # Ensur
-0000f950: 6520 7468 6520 6a6f 6220 7375 6363 6565  e the job succee
-0000f960: 6465 642e 0a20 2020 2020 2020 205d 2c0a  ded..        ],.
-0000f970: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
-0000f980: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
-0000f990: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
-0000f9a0: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
-0000f9b0: 7974 6573 742e 6d61 726b 2e6c 616d 6264  ytest.mark.lambd
-0000f9c0: 615f 636c 6f75 640a 6465 6620 7465 7374  a_cloud.def test
-0000f9d0: 5f6c 616d 6264 615f 6875 6767 696e 6766  _lambda_huggingf
-0000f9e0: 6163 6528 6765 6e65 7269 635f 636c 6f75  ace(generic_clou
-0000f9f0: 643a 2073 7472 293a 0a20 2020 206e 616d  d: str):.    nam
-0000fa00: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
-0000fa10: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
-0000fa20: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-0000fa30: 2027 6c61 6d62 6461 5f68 7567 6769 6e67   'lambda_hugging
-0000fa40: 6661 6365 5f67 6c75 655f 696d 6462 5f61  face_glue_imdb_a
-0000fa50: 7070 272c 0a20 2020 2020 2020 205b 0a20  pp',.        [. 
-0000fa60: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-0000fa70: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
-0000fa80: 616d 657d 207b 4c41 4d42 4441 5f54 5950  ame} {LAMBDA_TYP
-0000fa90: 457d 2065 7861 6d70 6c65 732f 6875 6767  E} examples/hugg
-0000faa0: 696e 6766 6163 655f 676c 7565 5f69 6d64  ingface_glue_imd
-0000fab0: 625f 6170 702e 7961 6d6c 272c 0a20 2020  b_app.yaml',.   
-0000fac0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-0000fad0: 6f67 7320 7b6e 616d 657d 2031 202d 2d73  ogs {name} 1 --s
-0000fae0: 7461 7475 7327 2c20 2023 2045 6e73 7572  tatus',  # Ensur
-0000faf0: 6520 7468 6520 6a6f 6220 7375 6363 6565  e the job succee
-0000fb00: 6465 642e 0a20 2020 2020 2020 2020 2020  ded..           
-0000fb10: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
-0000fb20: 657d 207b 4c41 4d42 4441 5f54 5950 457d  e} {LAMBDA_TYPE}
-0000fb30: 2065 7861 6d70 6c65 732f 6875 6767 696e   examples/huggin
-0000fb40: 6766 6163 655f 676c 7565 5f69 6d64 625f  gface_glue_imdb_
-0000fb50: 6170 702e 7961 6d6c 272c 0a20 2020 2020  app.yaml',.     
-0000fb60: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-0000fb70: 7320 7b6e 616d 657d 2032 202d 2d73 7461  s {name} 2 --sta
-0000fb80: 7475 7327 2c20 2023 2045 6e73 7572 6520  tus',  # Ensure 
-0000fb90: 7468 6520 6a6f 6220 7375 6363 6565 6465  the job succeede
-0000fba0: 642e 0a20 2020 2020 2020 205d 2c0a 2020  d..        ],.  
-0000fbb0: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
-0000fbc0: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
-0000fbd0: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
-0000fbe0: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
-0000fbf0: 6573 742e 6d61 726b 2e73 6370 0a64 6566  est.mark.scp.def
-0000fc00: 2074 6573 745f 7363 705f 6875 6767 696e   test_scp_huggin
-0000fc10: 6766 6163 6528 6765 6e65 7269 635f 636c  gface(generic_cl
-0000fc20: 6f75 643a 2073 7472 293a 0a20 2020 206e  oud: str):.    n
-0000fc30: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
-0000fc40: 6572 5f6e 616d 6528 290a 2020 2020 6e75  er_name().    nu
-0000fc50: 6d5f 6f66 5f67 7075 5f6c 6175 6e63 6820  m_of_gpu_launch 
-0000fc60: 3d20 310a 2020 2020 7465 7374 203d 2054  = 1.    test = T
-0000fc70: 6573 7428 0a20 2020 2020 2020 2027 5343  est(.        'SC
-0000fc80: 505f 6875 6767 696e 6766 6163 655f 676c  P_huggingface_gl
-0000fc90: 7565 5f69 6d64 625f 6170 7027 2c0a 2020  ue_imdb_app',.  
-0000fca0: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
-0000fcb0: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
-0000fcc0: 202d 7920 2d63 207b 6e61 6d65 7d20 7b53   -y -c {name} {S
-0000fcd0: 4350 5f54 5950 457d 207b 5343 505f 4750  CP_TYPE} {SCP_GP
-0000fce0: 555f 5631 3030 7d3a 7b6e 756d 5f6f 665f  U_V100}:{num_of_
-0000fcf0: 6770 755f 6c61 756e 6368 7d20 6578 616d  gpu_launch} exam
-0000fd00: 706c 6573 2f68 7567 6769 6e67 6661 6365  ples/huggingface
-0000fd10: 5f67 6c75 655f 696d 6462 5f61 7070 2e79  _glue_imdb_app.y
-0000fd20: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-0000fd30: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
-0000fd40: 6d65 7d20 3120 2d2d 7374 6174 7573 272c  me} 1 --status',
-0000fd50: 2020 2320 456e 7375 7265 2074 6865 206a    # Ensure the j
-0000fd60: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
-0000fd70: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0000fd80: 6578 6563 207b 6e61 6d65 7d20 7b53 4350  exec {name} {SCP
-0000fd90: 5f54 5950 457d 207b 5343 505f 4750 555f  _TYPE} {SCP_GPU_
-0000fda0: 5631 3030 7d3a 7b6e 756d 5f6f 665f 6770  V100}:{num_of_gp
-0000fdb0: 755f 6c61 756e 6368 7d20 6578 616d 706c  u_launch} exampl
-0000fdc0: 6573 2f68 7567 6769 6e67 6661 6365 5f67  es/huggingface_g
-0000fdd0: 6c75 655f 696d 6462 5f61 7070 2e79 616d  lue_imdb_app.yam
-0000fde0: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
-0000fdf0: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
-0000fe00: 7d20 3220 2d2d 7374 6174 7573 272c 2020  } 2 --status',  
-0000fe10: 2320 456e 7375 7265 2074 6865 206a 6f62  # Ensure the job
-0000fe20: 2073 7563 6365 6564 6564 2e0a 2020 2020   succeeded..    
-0000fe30: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
-0000fe40: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
-0000fe50: 6d65 7d27 2c0a 2020 2020 290a 2020 2020  me}',.    ).    
-0000fe60: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-0000fe70: 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d  t)...# ---------
-0000fe80: 2d20 496e 6665 7265 6e74 6961 2e20 2d2d  - Inferentia. --
-0000fe90: 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465 7374  --------.@pytest
-0000fea0: 2e6d 6172 6b2e 6177 730a 6465 6620 7465  .mark.aws.def te
-0000feb0: 7374 5f69 6e66 6572 656e 7469 6128 293a  st_inferentia():
-0000fec0: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
-0000fed0: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
-0000fee0: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
-0000fef0: 0a20 2020 2020 2020 2027 7465 7374 5f69  .        'test_i
-0000ff00: 6e66 6572 656e 7469 6127 2c0a 2020 2020  nferentia',.    
-0000ff10: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
-0000ff20: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
-0000ff30: 7920 2d63 207b 6e61 6d65 7d20 2d74 2069  y -c {name} -t i
-0000ff40: 6e66 322e 786c 6172 6765 202d 2d20 6563  nf2.xlarge -- ec
-0000ff50: 686f 2068 6927 2c0a 2020 2020 2020 2020  ho hi',.        
-0000ff60: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
-0000ff70: 6e61 6d65 7d20 2d2d 6770 7573 2049 6e66  name} --gpus Inf
-0000ff80: 6572 656e 7469 613a 3120 6563 686f 2068  erentia:1 echo h
-0000ff90: 6927 2c0a 2020 2020 2020 2020 2020 2020  i',.            
-0000ffa0: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
-0000ffb0: 7d20 3120 2d2d 7374 6174 7573 272c 2020  } 1 --status',  
-0000ffc0: 2320 456e 7375 7265 2074 6865 206a 6f62  # Ensure the job
-0000ffd0: 2073 7563 6365 6564 6564 2e0a 2020 2020   succeeded..    
-0000ffe0: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
-0000fff0: 6773 207b 6e61 6d65 7d20 3220 2d2d 7374  gs {name} 2 --st
-00010000: 6174 7573 272c 2020 2320 456e 7375 7265  atus',  # Ensure
-00010010: 2074 6865 206a 6f62 2073 7563 6365 6564   the job succeed
-00010020: 6564 2e0a 2020 2020 2020 2020 5d2c 0a20  ed..        ],. 
-00010030: 2020 2020 2020 2066 2773 6b79 2064 6f77         f'sky dow
-00010040: 6e20 2d79 207b 6e61 6d65 7d27 2c0a 2020  n -y {name}',.  
-00010050: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
-00010060: 7465 7374 2874 6573 7429 0a0a 0a23 202d  test(test)...# -
-00010070: 2d2d 2d2d 2d2d 2d2d 2d20 5450 552e 202d  --------- TPU. -
-00010080: 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974 6573  ---------.@pytes
-00010090: 742e 6d61 726b 2e67 6370 0a40 7079 7465  t.mark.gcp.@pyte
-000100a0: 7374 2e6d 6172 6b2e 7470 750a 6465 6620  st.mark.tpu.def 
-000100b0: 7465 7374 5f74 7075 2829 3a0a 2020 2020  test_tpu():.    
-000100c0: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
-000100d0: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
-000100e0: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
-000100f0: 2020 2020 2774 7075 5f61 7070 272c 0a20      'tpu_app',. 
-00010100: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-00010110: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
-00010120: 6820 2d79 202d 6320 7b6e 616d 657d 2065  h -y -c {name} e
-00010130: 7861 6d70 6c65 732f 7470 752f 7470 755f  xamples/tpu/tpu_
-00010140: 6170 702e 7961 6d6c 272c 0a20 2020 2020  app.yaml',.     
-00010150: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-00010160: 7320 7b6e 616d 657d 2031 272c 2020 2320  s {name} 1',  # 
-00010170: 456e 7375 7265 2074 6865 206a 6f62 2066  Ensure the job f
-00010180: 696e 6973 6865 642e 0a20 2020 2020 2020  inished..       
-00010190: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-000101a0: 7b6e 616d 657d 2031 202d 2d73 7461 7475  {name} 1 --statu
-000101b0: 7327 2c20 2023 2045 6e73 7572 6520 7468  s',  # Ensure th
-000101c0: 6520 6a6f 6220 7375 6363 6565 6465 642e  e job succeeded.
-000101d0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-000101e0: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
-000101f0: 7b6e 616d 657d 2065 7861 6d70 6c65 732f  {name} examples/
-00010200: 7470 752f 7470 755f 6170 702e 7961 6d6c  tpu/tpu_app.yaml
-00010210: 207c 2067 7265 7020 2254 5055 202e 2a20   | grep "TPU .* 
-00010220: 616c 7265 6164 7920 6578 6973 7473 2227  already exists"'
-00010230: 2c20 2023 2045 6e73 7572 6520 736b 7920  ,  # Ensure sky 
-00010240: 6c61 756e 6368 2077 6f6e 2774 2063 7265  launch won't cre
-00010250: 6174 6520 616e 6f74 6865 7220 5450 552e  ate another TPU.
-00010260: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
-00010270: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
-00010280: 7920 7b6e 616d 657d 272c 0a20 2020 2020  y {name}',.     
-00010290: 2020 2074 696d 656f 7574 3d33 3020 2a20     timeout=30 * 
-000102a0: 3630 2c20 2023 2063 616e 2074 616b 6520  60,  # can take 
-000102b0: 3e32 3020 6d69 6e73 0a20 2020 2029 0a20  >20 mins.    ). 
-000102c0: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-000102d0: 7465 7374 290a 0a0a 2320 2d2d 2d2d 2d2d  test)...# ------
-000102e0: 2d2d 2d2d 2054 5055 2056 4d2e 202d 2d2d  ---- TPU VM. ---
-000102f0: 2d2d 2d2d 2d2d 2d0a 4070 7974 6573 742e  -------.@pytest.
-00010300: 6d61 726b 2e67 6370 0a40 7079 7465 7374  mark.gcp.@pytest
-00010310: 2e6d 6172 6b2e 7470 750a 6465 6620 7465  .mark.tpu.def te
-00010320: 7374 5f74 7075 5f76 6d28 293a 0a20 2020  st_tpu_vm():.   
-00010330: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
-00010340: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
-00010350: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
-00010360: 2020 2020 2027 7470 755f 766d 5f61 7070       'tpu_vm_app
-00010370: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
-00010380: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00010390: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
-000103a0: 657d 2065 7861 6d70 6c65 732f 7470 752f  e} examples/tpu/
-000103b0: 7470 7576 6d5f 6d6e 6973 742e 7961 6d6c  tpuvm_mnist.yaml
-000103c0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-000103d0: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-000103e0: 2031 272c 2020 2320 456e 7375 7265 2074   1',  # Ensure t
-000103f0: 6865 206a 6f62 2066 696e 6973 6865 642e  he job finished.
-00010400: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00010410: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
-00010420: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
-00010430: 6e73 7572 6520 7468 6520 6a6f 6220 7375  nsure the job su
-00010440: 6363 6565 6465 642e 0a20 2020 2020 2020  cceeded..       
-00010450: 2020 2020 2066 2773 6b79 2073 746f 7020       f'sky stop 
-00010460: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
-00010470: 2020 2020 2020 2020 6627 733d 2428 736b          f's=$(sk
-00010480: 7920 7374 6174 7573 207b 6e61 6d65 7d20  y status {name} 
-00010490: 2d2d 7265 6672 6573 6829 3b20 6563 686f  --refresh); echo
-000104a0: 2022 2473 223b 2065 6368 6f3b 2065 6368   "$s"; echo; ech
-000104b0: 6f3b 2065 6368 6f20 2224 7322 2020 7c20  o; echo "$s"  | 
-000104c0: 6772 6570 207b 6e61 6d65 7d20 7c20 6772  grep {name} | gr
-000104d0: 6570 2053 544f 5050 4544 272c 2020 2320  ep STOPPED',  # 
-000104e0: 456e 7375 7265 2074 6865 2063 6c75 7374  Ensure the clust
-000104f0: 6572 2069 7320 5354 4f50 5045 442e 0a20  er is STOPPED.. 
-00010500: 2020 2020 2020 2020 2020 2023 2055 7365             # Use
-00010510: 2072 6574 7279 3a20 6775 6172 6420 6167   retry: guard ag
-00010520: 6169 6e73 7420 7472 616e 7369 656e 7420  ainst transient 
-00010530: 6572 726f 7273 206f 6273 6572 7665 6420  errors observed 
-00010540: 666f 720a 2020 2020 2020 2020 2020 2020  for.            
-00010550: 2320 6a75 7374 2d73 746f 7070 6564 2054  # just-stopped T
-00010560: 5055 2056 4d73 2028 2339 3632 292e 0a20  PU VMs (#962).. 
-00010570: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00010580: 2073 7461 7274 202d 2d72 6574 7279 2d75   start --retry-u
-00010590: 6e74 696c 2d75 7020 2d79 207b 6e61 6d65  ntil-up -y {name
-000105a0: 7d27 2c0a 2020 2020 2020 2020 2020 2020  }',.            
-000105b0: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
-000105c0: 7d20 6578 616d 706c 6573 2f74 7075 2f74  } examples/tpu/t
-000105d0: 7075 766d 5f6d 6e69 7374 2e79 616d 6c27  puvm_mnist.yaml'
-000105e0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-000105f0: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-00010600: 3220 2d2d 7374 6174 7573 272c 2020 2320  2 --status',  # 
-00010610: 456e 7375 7265 2074 6865 206a 6f62 2073  Ensure the job s
-00010620: 7563 6365 6564 6564 2e0a 2020 2020 2020  ucceeded..      
-00010630: 2020 2020 2020 6627 736b 7920 7374 6f70        f'sky stop
-00010640: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
-00010650: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-00010660: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
-00010670: 616d 657d 272c 0a20 2020 2020 2020 2074  ame}',.        t
-00010680: 696d 656f 7574 3d33 3020 2a20 3630 2c20  imeout=30 * 60, 
-00010690: 2023 2063 616e 2074 616b 6520 3330 206d   # can take 30 m
-000106a0: 696e 730a 2020 2020 290a 2020 2020 7275  ins.    ).    ru
-000106b0: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
-000106c0: 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20  ...# ---------- 
-000106d0: 5450 5520 564d 2050 6f64 2e20 2d2d 2d2d  TPU VM Pod. ----
-000106e0: 2d2d 2d2d 2d2d 0a40 7079 7465 7374 2e6d  ------.@pytest.m
-000106f0: 6172 6b2e 6763 700a 4070 7974 6573 742e  ark.gcp.@pytest.
-00010700: 6d61 726b 2e74 7075 0a64 6566 2074 6573  mark.tpu.def tes
-00010710: 745f 7470 755f 766d 5f70 6f64 2829 3a0a  t_tpu_vm_pod():.
-00010720: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
-00010730: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
-00010740: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
-00010750: 2020 2020 2020 2020 2774 7075 5f70 6f64          'tpu_pod
-00010760: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
-00010770: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00010780: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
-00010790: 657d 2065 7861 6d70 6c65 732f 7470 752f  e} examples/tpu/
-000107a0: 7470 7576 6d5f 6d6e 6973 742e 7961 6d6c  tpuvm_mnist.yaml
-000107b0: 202d 2d67 7075 7320 7470 752d 7632 2d33   --gpus tpu-v2-3
-000107c0: 3220 2d2d 7573 652d 7370 6f74 202d 2d7a  2 --use-spot --z
-000107d0: 6f6e 6520 6575 726f 7065 2d77 6573 7434  one europe-west4
-000107e0: 2d61 272c 0a20 2020 2020 2020 2020 2020  -a',.           
-000107f0: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
-00010800: 657d 2031 272c 2020 2320 456e 7375 7265  e} 1',  # Ensure
-00010810: 2074 6865 206a 6f62 2066 696e 6973 6865   the job finishe
-00010820: 642e 0a20 2020 2020 2020 2020 2020 2066  d..            f
-00010830: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-00010840: 2031 202d 2d73 7461 7475 7327 2c20 2023   1 --status',  #
-00010850: 2045 6e73 7572 6520 7468 6520 6a6f 6220   Ensure the job 
-00010860: 7375 6363 6565 6465 642e 0a20 2020 2020  succeeded..     
-00010870: 2020 205d 2c0a 2020 2020 2020 2020 6627     ],.        f'
-00010880: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
-00010890: 657d 272c 0a20 2020 2020 2020 2074 696d  e}',.        tim
-000108a0: 656f 7574 3d33 3020 2a20 3630 2c20 2023  eout=30 * 60,  #
-000108b0: 2063 616e 2074 616b 6520 3330 206d 696e   can take 30 min
-000108c0: 730a 2020 2020 290a 2020 2020 7275 6e5f  s.    ).    run_
-000108d0: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
-000108e0: 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20 5369  .# ---------- Si
-000108f0: 6d70 6c65 2061 7070 732e 202d 2d2d 2d2d  mple apps. -----
-00010900: 2d2d 2d2d 2d0a 4070 7974 6573 742e 6d61  -----.@pytest.ma
-00010910: 726b 2e6e 6f5f 7363 7020 2023 2053 4350  rk.no_scp  # SCP
-00010920: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
-00010930: 7420 6e75 6d5f 6e6f 6465 7320 3e20 3120  t num_nodes > 1 
-00010940: 7965 740a 6465 6620 7465 7374 5f6d 756c  yet.def test_mul
-00010950: 7469 5f68 6f73 746e 616d 6528 6765 6e65  ti_hostname(gene
-00010960: 7269 635f 636c 6f75 643a 2073 7472 293a  ric_cloud: str):
-00010970: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
-00010980: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
-00010990: 2020 2020 746f 7461 6c5f 7469 6d65 6f75      total_timeou
-000109a0: 745f 6d69 6e75 7465 7320 3d20 3235 2069  t_minutes = 25 i
-000109b0: 6620 6765 6e65 7269 635f 636c 6f75 6420  f generic_cloud 
-000109c0: 3d3d 2027 617a 7572 6527 2065 6c73 6520  == 'azure' else 
-000109d0: 3135 0a20 2020 2074 6573 7420 3d20 5465  15.    test = Te
-000109e0: 7374 280a 2020 2020 2020 2020 276d 756c  st(.        'mul
-000109f0: 7469 5f68 6f73 746e 616d 6527 2c0a 2020  ti_hostname',.  
-00010a00: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
-00010a10: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
-00010a20: 202d 7920 2d63 207b 6e61 6d65 7d20 2d2d   -y -c {name} --
-00010a30: 636c 6f75 6420 7b67 656e 6572 6963 5f63  cloud {generic_c
-00010a40: 6c6f 7564 7d20 6578 616d 706c 6573 2f6d  loud} examples/m
-00010a50: 756c 7469 5f68 6f73 746e 616d 652e 7961  ulti_hostname.ya
-00010a60: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
-00010a70: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
-00010a80: 657d 2031 202d 2d73 7461 7475 7327 2c20  e} 1 --status', 
-00010a90: 2023 2045 6e73 7572 6520 7468 6520 6a6f   # Ensure the jo
-00010aa0: 6220 7375 6363 6565 6465 642e 0a20 2020  b succeeded..   
-00010ab0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00010ac0: 6f67 7320 7b6e 616d 657d 2031 207c 2067  ogs {name} 1 | g
-00010ad0: 7265 7020 224d 7920 686f 7374 6e61 6d65  rep "My hostname
-00010ae0: 3a22 207c 2077 6320 2d6c 207c 2067 7265  :" | wc -l | gre
-00010af0: 7020 3227 2c20 2023 2045 6e73 7572 6520  p 2',  # Ensure 
-00010b00: 7468 6572 6520 6172 6520 3220 686f 7374  there are 2 host
-00010b10: 732e 0a20 2020 2020 2020 2020 2020 2066  s..            f
-00010b20: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
-00010b30: 2065 7861 6d70 6c65 732f 6d75 6c74 695f   examples/multi_
-00010b40: 686f 7374 6e61 6d65 2e79 616d 6c27 2c0a  hostname.yaml',.
-00010b50: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00010b60: 7920 6c6f 6773 207b 6e61 6d65 7d20 3220  y logs {name} 2 
-00010b70: 2d2d 7374 6174 7573 272c 2020 2320 456e  --status',  # En
-00010b80: 7375 7265 2074 6865 206a 6f62 2073 7563  sure the job suc
-00010b90: 6365 6564 6564 2e0a 2020 2020 2020 2020  ceeded..        
-00010ba0: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
-00010bb0: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
-00010bc0: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
-00010bd0: 743d 5f67 6574 5f74 696d 656f 7574 2867  t=_get_timeout(g
-00010be0: 656e 6572 6963 5f63 6c6f 7564 2c20 746f  eneric_cloud, to
-00010bf0: 7461 6c5f 7469 6d65 6f75 745f 6d69 6e75  tal_timeout_minu
-00010c00: 7465 7320 2a20 3630 292c 0a20 2020 2029  tes * 60),.    )
-00010c10: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
-00010c20: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
-00010c30: 742e 6d61 726b 2e6e 6f5f 7363 7020 2023  t.mark.no_scp  #
-00010c40: 2053 4350 2064 6f65 7320 6e6f 7420 7375   SCP does not su
-00010c50: 7070 6f72 7420 6e75 6d5f 6e6f 6465 7320  pport num_nodes 
-00010c60: 3e20 3120 7965 740a 6465 6620 7465 7374  > 1 yet.def test
-00010c70: 5f6d 756c 7469 5f6e 6f64 655f 6661 696c  _multi_node_fail
-00010c80: 7572 6528 6765 6e65 7269 635f 636c 6f75  ure(generic_clou
-00010c90: 643a 2073 7472 293a 0a20 2020 206e 616d  d: str):.    nam
-00010ca0: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
-00010cb0: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
-00010cc0: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-00010cd0: 2027 6d75 6c74 695f 6e6f 6465 5f66 6169   'multi_node_fai
-00010ce0: 6c75 7265 272c 0a20 2020 2020 2020 205b  lure',.        [
-00010cf0: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
-00010d00: 4f44 4f28 7a68 7775 293a 2077 6520 7573  ODO(zhwu): we us
-00010d10: 6520 6d75 6c74 692d 7468 7265 6164 2074  e multi-thread t
-00010d20: 6f20 7275 6e20 7468 6520 636f 6d6d 616e  o run the comman
-00010d30: 6473 2069 6e20 7365 7475 700a 2020 2020  ds in setup.    
-00010d40: 2020 2020 2020 2020 2320 636f 6d6d 616e          # comman
-00010d50: 6473 2069 6e20 7061 7261 6c6c 656c 2c20  ds in parallel, 
-00010d60: 7768 6963 6820 6d61 6b65 7320 6974 2069  which makes it i
-00010d70: 6d70 6f73 7369 626c 6520 746f 2066 6169  mpossible to fai
-00010d80: 6c20 6661 7374 0a20 2020 2020 2020 2020  l fast.         
-00010d90: 2020 2023 2077 6865 6e20 6f6e 6520 6f66     # when one of
-00010da0: 2074 6865 206e 6f64 6573 2066 6169 6c73   the nodes fails
-00010db0: 2e20 5765 2073 686f 756c 6420 6669 7820  . We should fix 
-00010dc0: 7468 6973 2069 6e20 7468 6520 6675 7475  this in the futu
-00010dd0: 7265 2e0a 2020 2020 2020 2020 2020 2020  re..            
-00010de0: 2320 5468 6520 2d2d 6465 7461 6368 2d73  # The --detach-s
-00010df0: 6574 7570 2076 6572 7369 6f6e 2063 616e  etup version can
-00010e00: 2066 6169 6c20 6661 7374 2c20 6173 2074   fail fast, as t
-00010e10: 6865 2073 6574 7570 2069 730a 2020 2020  he setup is.    
-00010e20: 2020 2020 2020 2020 2320 7375 626d 6974          # submit
-00010e30: 7465 6420 746f 2074 6865 2072 656d 6f74  ted to the remot
-00010e40: 6520 6d61 6368 696e 652c 2077 6869 6368  e machine, which
-00010e50: 2064 6f65 7320 6e6f 7420 7573 6520 6d75   does not use mu
-00010e60: 6c74 692d 7468 7265 6164 2e0a 2020 2020  lti-thread..    
-00010e70: 2020 2020 2020 2020 2320 5265 6665 7220          # Refer 
-00010e80: 746f 2074 6865 2063 6f6d 6d65 6e74 2069  to the comment i
-00010e90: 6e20 6073 7562 7072 6f63 6573 735f 7574  n `subprocess_ut
-00010ea0: 696c 732e 7275 6e5f 696e 5f70 6172 616c  ils.run_in_paral
-00010eb0: 6c65 6c60 2e0a 2020 2020 2020 2020 2020  lel`..          
-00010ec0: 2020 2320 6627 736b 7920 6c61 756e 6368    # f'sky launch
-00010ed0: 202d 7920 2d63 207b 6e61 6d65 7d20 2d2d   -y -c {name} --
-00010ee0: 636c 6f75 6420 7b67 656e 6572 6963 5f63  cloud {generic_c
-00010ef0: 6c6f 7564 7d20 7465 7374 732f 7465 7374  loud} tests/test
-00010f00: 5f79 616d 6c73 2f66 6169 6c65 645f 776f  _yamls/failed_wo
-00010f10: 726b 6572 5f73 6574 7570 2e79 616d 6c20  rker_setup.yaml 
-00010f20: 2626 2065 7869 7420 3127 2c20 2023 2045  && exit 1',  # E
-00010f30: 6e73 7572 6520 7468 6520 6a6f 6220 7365  nsure the job se
-00010f40: 7475 7020 6661 696c 6564 2e0a 2020 2020  tup failed..    
-00010f50: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
-00010f60: 756e 6368 202d 7920 2d63 207b 6e61 6d65  unch -y -c {name
-00010f70: 7d20 2d2d 636c 6f75 6420 7b67 656e 6572  } --cloud {gener
-00010f80: 6963 5f63 6c6f 7564 7d20 2d2d 6465 7461  ic_cloud} --deta
-00010f90: 6368 2d73 6574 7570 2074 6573 7473 2f74  ch-setup tests/t
-00010fa0: 6573 745f 7961 6d6c 732f 6661 696c 6564  est_yamls/failed
-00010fb0: 5f77 6f72 6b65 725f 7365 7475 702e 7961  _worker_setup.ya
-00010fc0: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
-00010fd0: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
-00010fe0: 657d 2031 202d 2d73 7461 7475 7320 7c20  e} 1 --status | 
-00010ff0: 6772 6570 2046 4149 4c45 445f 5345 5455  grep FAILED_SETU
-00011000: 5027 2c20 2023 2045 6e73 7572 6520 7468  P',  # Ensure th
-00011010: 6520 6a6f 6220 7365 7475 7020 6661 696c  e job setup fail
-00011020: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
-00011030: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
-00011040: 7d20 7465 7374 732f 7465 7374 5f79 616d  } tests/test_yam
-00011050: 6c73 2f66 6169 6c65 645f 776f 726b 6572  ls/failed_worker
-00011060: 5f72 756e 2e79 616d 6c27 2c0a 2020 2020  _run.yaml',.    
-00011070: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
-00011080: 6773 207b 6e61 6d65 7d20 3220 2d2d 7374  gs {name} 2 --st
-00011090: 6174 7573 207c 2067 7265 7020 4641 494c  atus | grep FAIL
-000110a0: 4544 272c 2020 2320 456e 7375 7265 2074  ED',  # Ensure t
-000110b0: 6865 206a 6f62 2066 6169 6c65 642e 0a20  he job failed.. 
-000110c0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-000110d0: 206c 6f67 7320 7b6e 616d 657d 2032 207c   logs {name} 2 |
-000110e0: 2067 7265 7020 224d 7920 686f 7374 6e61   grep "My hostna
-000110f0: 6d65 3a22 207c 2077 6320 2d6c 207c 2067  me:" | wc -l | g
-00011100: 7265 7020 3227 2c20 2023 2045 6e73 7572  rep 2',  # Ensur
-00011110: 6520 7468 6572 6520 3220 6f66 2074 6865  e there 2 of the
-00011120: 2068 6f73 7473 2070 7269 6e74 6564 2074   hosts printed t
-00011130: 6865 6972 2068 6f73 746e 616d 652e 0a20  heir hostname.. 
-00011140: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-00011150: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
-00011160: 7b6e 616d 657d 272c 0a20 2020 2029 0a20  {name}',.    ). 
-00011170: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-00011180: 7465 7374 290a 0a0a 2320 2d2d 2d2d 2d2d  test)...# ------
-00011190: 2d2d 2d2d 2057 6562 2061 7070 7320 7769  ---- Web apps wi
-000111a0: 7468 2063 7573 746f 6d20 706f 7274 7320  th custom ports 
-000111b0: 6f6e 2047 4350 2e20 2d2d 2d2d 2d2d 2d2d  on GCP. --------
-000111c0: 2d2d 0a40 7079 7465 7374 2e6d 6172 6b2e  --.@pytest.mark.
-000111d0: 6763 700a 6465 6620 7465 7374 5f67 6370  gcp.def test_gcp
-000111e0: 5f68 7474 705f 7365 7276 6572 5f77 6974  _http_server_wit
-000111f0: 685f 6375 7374 6f6d 5f70 6f72 7473 2829  h_custom_ports()
-00011200: 3a0a 2020 2020 6e61 6d65 203d 205f 6765  :.    name = _ge
-00011210: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
-00011220: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
-00011230: 280a 2020 2020 2020 2020 2767 6370 5f68  (.        'gcp_h
-00011240: 7474 705f 7365 7276 6572 5f77 6974 685f  ttp_server_with_
-00011250: 6375 7374 6f6d 5f70 6f72 7473 272c 0a20  custom_ports',. 
-00011260: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-00011270: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
-00011280: 6820 2d79 202d 6420 2d63 207b 6e61 6d65  h -y -d -c {name
-00011290: 7d20 2d2d 636c 6f75 6420 6763 7020 6578  } --cloud gcp ex
-000112a0: 616d 706c 6573 2f68 7474 705f 7365 7276  amples/http_serv
-000112b0: 6572 5f77 6974 685f 6375 7374 6f6d 5f70  er_with_custom_p
-000112c0: 6f72 7473 2f74 6173 6b2e 7961 6d6c 272c  orts/task.yaml',
-000112d0: 0a20 2020 2020 2020 2020 2020 2066 2775  .            f'u
-000112e0: 6e74 696c 2053 4b59 5049 4c4f 545f 4445  ntil SKYPILOT_DE
-000112f0: 4255 473d 3020 736b 7920 7374 6174 7573  BUG=0 sky status
-00011300: 202d 2d65 6e64 706f 696e 7420 3333 3832   --endpoint 3382
-00011310: 3820 7b6e 616d 657d 3b20 646f 2073 6c65  8 {name}; do sle
-00011320: 6570 2031 303b 2064 6f6e 6527 2c0a 2020  ep 10; done',.  
-00011330: 2020 2020 2020 2020 2020 2320 5265 7472            # Retr
-00011340: 7920 6120 6665 7720 7469 6d65 7320 746f  y a few times to
-00011350: 2061 766f 6964 2066 6c61 6b69 6e65 7373   avoid flakiness
-00011360: 2069 6e20 706f 7274 7320 6265 696e 6720   in ports being 
-00011370: 6f70 656e 2e0a 2020 2020 2020 2020 2020  open..          
-00011380: 2020 6627 6970 3d24 2853 4b59 5049 4c4f    f'ip=$(SKYPILO
-00011390: 545f 4445 4255 473d 3020 736b 7920 7374  T_DEBUG=0 sky st
-000113a0: 6174 7573 202d 2d65 6e64 706f 696e 7420  atus --endpoint 
-000113b0: 3333 3832 3820 7b6e 616d 657d 293b 2073  33828 {name}); s
-000113c0: 7563 6365 7373 3d66 616c 7365 3b20 666f  uccess=false; fo
-000113d0: 7220 6920 696e 2024 2873 6571 2031 2035  r i in $(seq 1 5
-000113e0: 293b 2064 6f20 6966 2063 7572 6c20 2469  ); do if curl $i
-000113f0: 7020 7c20 6772 6570 2022 3c68 313e 5468  p | grep "<h1>Th
-00011400: 6973 2069 7320 6120 6465 6d6f 2048 544d  is is a demo HTM
-00011410: 4c20 7061 6765 2e3c 2f68 313e 223b 2074  L page.</h1>"; t
-00011420: 6865 6e20 7375 6363 6573 733d 7472 7565  hen success=true
-00011430: 3b20 6272 6561 6b3b 2066 693b 2073 6c65  ; break; fi; sle
-00011440: 6570 2031 303b 2064 6f6e 653b 2069 6620  ep 10; done; if 
-00011450: 5b20 2224 7375 6363 6573 7322 203d 2066  [ "$success" = f
-00011460: 616c 7365 205d 3b20 7468 656e 2065 7869  alse ]; then exi
-00011470: 7420 313b 2066 6927 2c0a 2020 2020 2020  t 1; fi',.      
-00011480: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
-00011490: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
-000114a0: 7d27 2c0a 2020 2020 290a 2020 2020 7275  }',.    ).    ru
-000114b0: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
-000114c0: 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20  ...# ---------- 
-000114d0: 5765 6220 6170 7073 2077 6974 6820 6375  Web apps with cu
-000114e0: 7374 6f6d 2070 6f72 7473 206f 6e20 4157  stom ports on AW
-000114f0: 532e 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070  S. ----------.@p
-00011500: 7974 6573 742e 6d61 726b 2e61 7773 0a64  ytest.mark.aws.d
-00011510: 6566 2074 6573 745f 6177 735f 6874 7470  ef test_aws_http
-00011520: 5f73 6572 7665 725f 7769 7468 5f63 7573  _server_with_cus
-00011530: 746f 6d5f 706f 7274 7328 293a 0a20 2020  tom_ports():.   
-00011540: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
-00011550: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
-00011560: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
-00011570: 2020 2020 2027 6177 735f 6874 7470 5f73       'aws_http_s
-00011580: 6572 7665 725f 7769 7468 5f63 7573 746f  erver_with_custo
-00011590: 6d5f 706f 7274 7327 2c0a 2020 2020 2020  m_ports',.      
-000115a0: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
-000115b0: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
-000115c0: 2d64 202d 6320 7b6e 616d 657d 202d 2d63  -d -c {name} --c
-000115d0: 6c6f 7564 2061 7773 2065 7861 6d70 6c65  loud aws example
-000115e0: 732f 6874 7470 5f73 6572 7665 725f 7769  s/http_server_wi
-000115f0: 7468 5f63 7573 746f 6d5f 706f 7274 732f  th_custom_ports/
-00011600: 7461 736b 2e79 616d 6c27 2c0a 2020 2020  task.yaml',.    
-00011610: 2020 2020 2020 2020 6627 756e 7469 6c20          f'until 
-00011620: 534b 5950 494c 4f54 5f44 4542 5547 3d30  SKYPILOT_DEBUG=0
-00011630: 2073 6b79 2073 7461 7475 7320 2d2d 656e   sky status --en
-00011640: 6470 6f69 6e74 2033 3338 3238 207b 6e61  dpoint 33828 {na
-00011650: 6d65 7d3b 2064 6f20 736c 6565 7020 3130  me}; do sleep 10
-00011660: 3b20 646f 6e65 272c 0a20 2020 2020 2020  ; done',.       
-00011670: 2020 2020 2023 2052 6574 7279 2061 2066       # Retry a f
-00011680: 6577 2074 696d 6573 2074 6f20 6176 6f69  ew times to avoi
-00011690: 6420 666c 616b 696e 6573 7320 696e 2070  d flakiness in p
-000116a0: 6f72 7473 2062 6569 6e67 206f 7065 6e2e  orts being open.
-000116b0: 0a20 2020 2020 2020 2020 2020 2066 2769  .            f'i
-000116c0: 703d 2428 534b 5950 494c 4f54 5f44 4542  p=$(SKYPILOT_DEB
-000116d0: 5547 3d30 2073 6b79 2073 7461 7475 7320  UG=0 sky status 
-000116e0: 2d2d 656e 6470 6f69 6e74 2033 3338 3238  --endpoint 33828
-000116f0: 207b 6e61 6d65 7d29 3b20 7375 6363 6573   {name}); succes
-00011700: 733d 6661 6c73 653b 2066 6f72 2069 2069  s=false; for i i
-00011710: 6e20 2428 7365 7120 3120 3529 3b20 646f  n $(seq 1 5); do
-00011720: 2069 6620 6375 726c 2024 6970 207c 2067   if curl $ip | g
-00011730: 7265 7020 223c 6831 3e54 6869 7320 6973  rep "<h1>This is
-00011740: 2061 2064 656d 6f20 4854 4d4c 2070 6167   a demo HTML pag
-00011750: 652e 3c2f 6831 3e22 3b20 7468 656e 2073  e.</h1>"; then s
-00011760: 7563 6365 7373 3d74 7275 653b 2062 7265  uccess=true; bre
-00011770: 616b 3b20 6669 3b20 736c 6565 7020 3130  ak; fi; sleep 10
-00011780: 3b20 646f 6e65 3b20 6966 205b 2022 2473  ; done; if [ "$s
-00011790: 7563 6365 7373 2220 3d20 6661 6c73 6520  uccess" = false 
-000117a0: 5d3b 2074 6865 6e20 6578 6974 2031 3b20  ]; then exit 1; 
-000117b0: 6669 270a 2020 2020 2020 2020 5d2c 0a20  fi'.        ],. 
-000117c0: 2020 2020 2020 2066 2773 6b79 2064 6f77         f'sky dow
-000117d0: 6e20 2d79 207b 6e61 6d65 7d27 2c0a 2020  n -y {name}',.  
-000117e0: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
-000117f0: 7465 7374 2874 6573 7429 0a0a 0a23 202d  test(test)...# -
-00011800: 2d2d 2d2d 2d2d 2d2d 2d20 5765 6220 6170  --------- Web ap
-00011810: 7073 2077 6974 6820 6375 7374 6f6d 2070  ps with custom p
-00011820: 6f72 7473 206f 6e20 417a 7572 652e 202d  orts on Azure. -
-00011830: 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974 6573  ---------.@pytes
-00011840: 742e 6d61 726b 2e61 7a75 7265 0a64 6566  t.mark.azure.def
-00011850: 2074 6573 745f 617a 7572 655f 6874 7470   test_azure_http
-00011860: 5f73 6572 7665 725f 7769 7468 5f63 7573  _server_with_cus
-00011870: 746f 6d5f 706f 7274 7328 293a 0a20 2020  tom_ports():.   
-00011880: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
-00011890: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
-000118a0: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
-000118b0: 2020 2020 2027 617a 7572 655f 6874 7470       'azure_http
-000118c0: 5f73 6572 7665 725f 7769 7468 5f63 7573  _server_with_cus
-000118d0: 746f 6d5f 706f 7274 7327 2c0a 2020 2020  tom_ports',.    
-000118e0: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
-000118f0: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
-00011900: 7920 2d64 202d 6320 7b6e 616d 657d 202d  y -d -c {name} -
-00011910: 2d63 6c6f 7564 2061 7a75 7265 2065 7861  -cloud azure exa
-00011920: 6d70 6c65 732f 6874 7470 5f73 6572 7665  mples/http_serve
-00011930: 725f 7769 7468 5f63 7573 746f 6d5f 706f  r_with_custom_po
-00011940: 7274 732f 7461 736b 2e79 616d 6c27 2c0a  rts/task.yaml',.
-00011950: 2020 2020 2020 2020 2020 2020 6627 756e              f'un
-00011960: 7469 6c20 534b 5950 494c 4f54 5f44 4542  til SKYPILOT_DEB
-00011970: 5547 3d30 2073 6b79 2073 7461 7475 7320  UG=0 sky status 
-00011980: 2d2d 656e 6470 6f69 6e74 2033 3338 3238  --endpoint 33828
-00011990: 207b 6e61 6d65 7d3b 2064 6f20 736c 6565   {name}; do slee
-000119a0: 7020 3130 3b20 646f 6e65 272c 0a20 2020  p 10; done',.   
-000119b0: 2020 2020 2020 2020 2023 2052 6574 7279           # Retry
-000119c0: 2061 2066 6577 2074 696d 6573 2074 6f20   a few times to 
-000119d0: 6176 6f69 6420 666c 616b 696e 6573 7320  avoid flakiness 
-000119e0: 696e 2070 6f72 7473 2062 6569 6e67 206f  in ports being o
-000119f0: 7065 6e2e 0a20 2020 2020 2020 2020 2020  pen..           
-00011a00: 2066 2769 703d 2428 534b 5950 494c 4f54   f'ip=$(SKYPILOT
-00011a10: 5f44 4542 5547 3d30 2073 6b79 2073 7461  _DEBUG=0 sky sta
-00011a20: 7475 7320 2d2d 656e 6470 6f69 6e74 2033  tus --endpoint 3
-00011a30: 3338 3238 207b 6e61 6d65 7d29 3b20 7375  3828 {name}); su
-00011a40: 6363 6573 733d 6661 6c73 653b 2066 6f72  ccess=false; for
-00011a50: 2069 2069 6e20 2428 7365 7120 3120 3529   i in $(seq 1 5)
-00011a60: 3b20 646f 2069 6620 6375 726c 2024 6970  ; do if curl $ip
-00011a70: 207c 2067 7265 7020 223c 6831 3e54 6869   | grep "<h1>Thi
-00011a80: 7320 6973 2061 2064 656d 6f20 4854 4d4c  s is a demo HTML
-00011a90: 2070 6167 652e 3c2f 6831 3e22 3b20 7468   page.</h1>"; th
-00011aa0: 656e 2073 7563 6365 7373 3d74 7275 653b  en success=true;
-00011ab0: 2062 7265 616b 3b20 6669 3b20 736c 6565   break; fi; slee
-00011ac0: 7020 3130 3b20 646f 6e65 3b20 6966 205b  p 10; done; if [
-00011ad0: 2022 2473 7563 6365 7373 2220 3d20 6661   "$success" = fa
-00011ae0: 6c73 6520 5d3b 2074 6865 6e20 6578 6974  lse ]; then exit
-00011af0: 2031 3b20 6669 270a 2020 2020 2020 2020   1; fi'.        
-00011b00: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
-00011b10: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
-00011b20: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
-00011b30: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
-00011b40: 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20 5765  .# ---------- We
-00011b50: 6220 6170 7073 2077 6974 6820 6375 7374  b apps with cust
-00011b60: 6f6d 2070 6f72 7473 206f 6e20 4b75 6265  om ports on Kube
-00011b70: 726e 6574 6573 2e20 2d2d 2d2d 2d2d 2d2d  rnetes. --------
-00011b80: 2d2d 0a40 7079 7465 7374 2e6d 6172 6b2e  --.@pytest.mark.
-00011b90: 6b75 6265 726e 6574 6573 0a64 6566 2074  kubernetes.def t
-00011ba0: 6573 745f 6b75 6265 726e 6574 6573 5f68  est_kubernetes_h
-00011bb0: 7474 705f 7365 7276 6572 5f77 6974 685f  ttp_server_with_
-00011bc0: 6375 7374 6f6d 5f70 6f72 7473 2829 3a0a  custom_ports():.
-00011bd0: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
-00011be0: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
-00011bf0: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
-00011c00: 2020 2020 2020 2020 276b 7562 6572 6e65          'kuberne
-00011c10: 7465 735f 6874 7470 5f73 6572 7665 725f  tes_http_server_
-00011c20: 7769 7468 5f63 7573 746f 6d5f 706f 7274  with_custom_port
-00011c30: 7327 2c0a 2020 2020 2020 2020 5b0a 2020  s',.        [.  
-00011c40: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00011c50: 6c61 756e 6368 202d 7920 2d64 202d 6320  launch -y -d -c 
-00011c60: 7b6e 616d 657d 202d 2d63 6c6f 7564 206b  {name} --cloud k
-00011c70: 7562 6572 6e65 7465 7320 6578 616d 706c  ubernetes exampl
-00011c80: 6573 2f68 7474 705f 7365 7276 6572 5f77  es/http_server_w
-00011c90: 6974 685f 6375 7374 6f6d 5f70 6f72 7473  ith_custom_ports
-00011ca0: 2f74 6173 6b2e 7961 6d6c 272c 0a20 2020  /task.yaml',.   
-00011cb0: 2020 2020 2020 2020 2066 2775 6e74 696c           f'until
-00011cc0: 2053 4b59 5049 4c4f 545f 4445 4255 473d   SKYPILOT_DEBUG=
-00011cd0: 3020 736b 7920 7374 6174 7573 202d 2d65  0 sky status --e
-00011ce0: 6e64 706f 696e 7420 3333 3832 3820 7b6e  ndpoint 33828 {n
-00011cf0: 616d 657d 3b20 646f 2073 6c65 6570 2031  ame}; do sleep 1
-00011d00: 303b 2064 6f6e 6527 2c0a 2020 2020 2020  0; done',.      
-00011d10: 2020 2020 2020 2320 5265 7472 7920 6120        # Retry a 
-00011d20: 6665 7720 7469 6d65 7320 746f 2061 766f  few times to avo
-00011d30: 6964 2066 6c61 6b69 6e65 7373 2069 6e20  id flakiness in 
-00011d40: 706f 7274 7320 6265 696e 6720 6f70 656e  ports being open
-00011d50: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
-00011d60: 6970 3d24 2853 4b59 5049 4c4f 545f 4445  ip=$(SKYPILOT_DE
-00011d70: 4255 473d 3020 736b 7920 7374 6174 7573  BUG=0 sky status
-00011d80: 202d 2d65 6e64 706f 696e 7420 3333 3832   --endpoint 3382
-00011d90: 3820 7b6e 616d 657d 293b 2073 7563 6365  8 {name}); succe
-00011da0: 7373 3d66 616c 7365 3b20 666f 7220 6920  ss=false; for i 
-00011db0: 696e 2024 2873 6571 2031 2031 3030 293b  in $(seq 1 100);
-00011dc0: 2064 6f20 6966 2063 7572 6c20 2469 7020   do if curl $ip 
-00011dd0: 7c20 6772 6570 2022 3c68 313e 5468 6973  | grep "<h1>This
-00011de0: 2069 7320 6120 6465 6d6f 2048 544d 4c20   is a demo HTML 
-00011df0: 7061 6765 2e3c 2f68 313e 223b 2074 6865  page.</h1>"; the
-00011e00: 6e20 7375 6363 6573 733d 7472 7565 3b20  n success=true; 
-00011e10: 6272 6561 6b3b 2066 693b 2073 6c65 6570  break; fi; sleep
-00011e20: 2035 3b20 646f 6e65 3b20 6966 205b 2022   5; done; if [ "
-00011e30: 2473 7563 6365 7373 2220 3d20 6661 6c73  $success" = fals
-00011e40: 6520 5d3b 2074 6865 6e20 6578 6974 2031  e ]; then exit 1
-00011e50: 3b20 6669 270a 2020 2020 2020 2020 5d2c  ; fi'.        ],
-00011e60: 0a20 2020 2020 2020 2066 2773 6b79 2064  .        f'sky d
-00011e70: 6f77 6e20 2d79 207b 6e61 6d65 7d27 2c0a  own -y {name}',.
-00011e80: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
-00011e90: 655f 7465 7374 2874 6573 7429 0a0a 0a23  e_test(test)...#
-00011ea0: 202d 2d2d 2d2d 2d2d 2d2d 2d20 5765 6220   ---------- Web 
-00011eb0: 6170 7073 2077 6974 6820 6375 7374 6f6d  apps with custom
-00011ec0: 2070 6f72 7473 206f 6e20 5061 7065 7273   ports on Papers
-00011ed0: 7061 6365 2e20 2d2d 2d2d 2d2d 2d2d 2d2d  pace. ----------
-00011ee0: 0a40 7079 7465 7374 2e6d 6172 6b2e 7061  .@pytest.mark.pa
-00011ef0: 7065 7273 7061 6365 0a64 6566 2074 6573  perspace.def tes
-00011f00: 745f 7061 7065 7273 7061 6365 5f68 7474  t_paperspace_htt
-00011f10: 705f 7365 7276 6572 5f77 6974 685f 6375  p_server_with_cu
-00011f20: 7374 6f6d 5f70 6f72 7473 2829 3a0a 2020  stom_ports():.  
-00011f30: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
-00011f40: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
-00011f50: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
-00011f60: 2020 2020 2020 2770 6170 6572 7370 6163        'paperspac
-00011f70: 655f 6874 7470 5f73 6572 7665 725f 7769  e_http_server_wi
-00011f80: 7468 5f63 7573 746f 6d5f 706f 7274 7327  th_custom_ports'
-00011f90: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
-00011fa0: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
-00011fb0: 756e 6368 202d 7920 2d64 202d 6320 7b6e  unch -y -d -c {n
-00011fc0: 616d 657d 202d 2d63 6c6f 7564 2070 6170  ame} --cloud pap
-00011fd0: 6572 7370 6163 6520 6578 616d 706c 6573  erspace examples
-00011fe0: 2f68 7474 705f 7365 7276 6572 5f77 6974  /http_server_wit
-00011ff0: 685f 6375 7374 6f6d 5f70 6f72 7473 2f74  h_custom_ports/t
-00012000: 6173 6b2e 7961 6d6c 272c 0a20 2020 2020  ask.yaml',.     
-00012010: 2020 2020 2020 2066 2775 6e74 696c 2053         f'until S
-00012020: 4b59 5049 4c4f 545f 4445 4255 473d 3020  KYPILOT_DEBUG=0 
-00012030: 736b 7920 7374 6174 7573 202d 2d65 6e64  sky status --end
-00012040: 706f 696e 7420 3333 3832 3820 7b6e 616d  point 33828 {nam
-00012050: 657d 3b20 646f 2073 6c65 6570 2031 303b  e}; do sleep 10;
-00012060: 2064 6f6e 6527 2c0a 2020 2020 2020 2020   done',.        
-00012070: 2020 2020 2320 5265 7472 7920 6120 6665      # Retry a fe
-00012080: 7720 7469 6d65 7320 746f 2061 766f 6964  w times to avoid
-00012090: 2066 6c61 6b69 6e65 7373 2069 6e20 706f   flakiness in po
-000120a0: 7274 7320 6265 696e 6720 6f70 656e 2e0a  rts being open..
-000120b0: 2020 2020 2020 2020 2020 2020 6627 6970              f'ip
-000120c0: 3d24 2853 4b59 5049 4c4f 545f 4445 4255  =$(SKYPILOT_DEBU
-000120d0: 473d 3020 736b 7920 7374 6174 7573 202d  G=0 sky status -
-000120e0: 2d65 6e64 706f 696e 7420 3333 3832 3820  -endpoint 33828 
-000120f0: 7b6e 616d 657d 293b 2073 7563 6365 7373  {name}); success
-00012100: 3d66 616c 7365 3b20 666f 7220 6920 696e  =false; for i in
-00012110: 2024 2873 6571 2031 2035 293b 2064 6f20   $(seq 1 5); do 
-00012120: 6966 2063 7572 6c20 2469 7020 7c20 6772  if curl $ip | gr
-00012130: 6570 2022 3c68 313e 5468 6973 2069 7320  ep "<h1>This is 
-00012140: 6120 6465 6d6f 2048 544d 4c20 7061 6765  a demo HTML page
-00012150: 2e3c 2f68 313e 223b 2074 6865 6e20 7375  .</h1>"; then su
-00012160: 6363 6573 733d 7472 7565 3b20 6272 6561  ccess=true; brea
-00012170: 6b3b 2066 693b 2073 6c65 6570 2031 303b  k; fi; sleep 10;
-00012180: 2064 6f6e 653b 2069 6620 5b20 2224 7375   done; if [ "$su
-00012190: 6363 6573 7322 203d 2066 616c 7365 205d  ccess" = false ]
-000121a0: 3b20 7468 656e 2065 7869 7420 313b 2066  ; then exit 1; f
-000121b0: 6927 2c0a 2020 2020 2020 2020 5d2c 0a20  i',.        ],. 
-000121c0: 2020 2020 2020 2066 2773 6b79 2064 6f77         f'sky dow
-000121d0: 6e20 2d79 207b 6e61 6d65 7d27 2c0a 2020  n -y {name}',.  
-000121e0: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
-000121f0: 7465 7374 2874 6573 7429 0a0a 0a23 202d  test(test)...# -
-00012200: 2d2d 2d2d 2d2d 2d2d 2d20 4c61 6265 6c73  --------- Labels
-00012210: 2066 726f 6d20 7461 736b 206f 6e20 4157   from task on AW
-00012220: 5320 2869 6e73 7461 6e63 655f 7461 6773  S (instance_tags
-00012230: 2920 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079  ) ----------.@py
-00012240: 7465 7374 2e6d 6172 6b2e 6177 730a 6465  test.mark.aws.de
-00012250: 6620 7465 7374 5f74 6173 6b5f 6c61 6265  f test_task_labe
-00012260: 6c73 5f61 7773 2829 3a0a 2020 2020 6e61  ls_aws():.    na
-00012270: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
-00012280: 725f 6e61 6d65 2829 0a20 2020 2074 656d  r_name().    tem
-00012290: 706c 6174 655f 7374 7220 3d20 7061 7468  plate_str = path
-000122a0: 6c69 622e 5061 7468 280a 2020 2020 2020  lib.Path(.      
-000122b0: 2020 2774 6573 7473 2f74 6573 745f 7961    'tests/test_ya
-000122c0: 6d6c 732f 7465 7374 5f6c 6162 656c 732e  mls/test_labels.
-000122d0: 7961 6d6c 2e6a 3227 292e 7265 6164 5f74  yaml.j2').read_t
-000122e0: 6578 7428 290a 2020 2020 7465 6d70 6c61  ext().    templa
-000122f0: 7465 203d 206a 696e 6a61 322e 5465 6d70  te = jinja2.Temp
-00012300: 6c61 7465 2874 656d 706c 6174 655f 7374  late(template_st
-00012310: 7229 0a20 2020 2063 6f6e 7465 6e74 203d  r).    content =
-00012320: 2074 656d 706c 6174 652e 7265 6e64 6572   template.render
-00012330: 2863 6c6f 7564 3d27 6177 7327 2c20 7265  (cloud='aws', re
-00012340: 6769 6f6e 3d27 7573 2d65 6173 742d 3127  gion='us-east-1'
-00012350: 290a 2020 2020 7769 7468 2074 656d 7066  ).    with tempf
-00012360: 696c 652e 4e61 6d65 6454 656d 706f 7261  ile.NamedTempora
-00012370: 7279 4669 6c65 2873 7566 6669 783d 272e  ryFile(suffix='.
-00012380: 7961 6d6c 272c 206d 6f64 653d 2777 2729  yaml', mode='w')
-00012390: 2061 7320 663a 0a20 2020 2020 2020 2066   as f:.        f
-000123a0: 2e77 7269 7465 2863 6f6e 7465 6e74 290a  .write(content).
-000123b0: 2020 2020 2020 2020 662e 666c 7573 6828          f.flush(
-000123c0: 290a 2020 2020 2020 2020 6669 6c65 5f70  ).        file_p
-000123d0: 6174 6820 3d20 662e 6e61 6d65 0a20 2020  ath = f.name.   
-000123e0: 2020 2020 2074 6573 7420 3d20 5465 7374       test = Test
-000123f0: 280a 2020 2020 2020 2020 2020 2020 2774  (.            't
-00012400: 6173 6b5f 6c61 6265 6c73 5f61 7773 272c  ask_labels_aws',
-00012410: 0a20 2020 2020 2020 2020 2020 205b 0a20  .            [. 
-00012420: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00012430: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
-00012440: 6320 7b6e 616d 657d 207b 6669 6c65 5f70  c {name} {file_p
-00012450: 6174 687d 272c 0a20 2020 2020 2020 2020  ath}',.         
-00012460: 2020 2020 2020 2023 2056 6572 6966 7920         # Verify 
-00012470: 7769 7468 2061 7773 2063 6c69 2074 6861  with aws cli tha
-00012480: 7420 7468 6520 7461 6773 2061 7265 2073  t the tags are s
-00012490: 6574 2e0a 2020 2020 2020 2020 2020 2020  et..            
-000124a0: 2020 2020 2761 7773 2065 6332 2064 6573      'aws ec2 des
-000124b0: 6372 6962 652d 696e 7374 616e 6365 7320  cribe-instances 
-000124c0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-000124d0: 2020 272d 2d71 7565 7279 2022 5265 7365    '--query "Rese
-000124e0: 7276 6174 696f 6e73 5b2a 5d2e 496e 7374  rvations[*].Inst
-000124f0: 616e 6365 735b 2a5d 2e49 6e73 7461 6e63  ances[*].Instanc
-00012500: 6549 6422 2027 0a20 2020 2020 2020 2020  eId" '.         
-00012510: 2020 2020 2020 2027 2d2d 6669 6c74 6572         '--filter
-00012520: 7320 224e 616d 653d 696e 7374 616e 6365  s "Name=instance
-00012530: 2d73 7461 7465 2d6e 616d 652c 5661 6c75  -state-name,Valu
-00012540: 6573 3d72 756e 6e69 6e67 2220 270a 2020  es=running" '.  
-00012550: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-00012560: 2d2d 6669 6c74 6572 7320 224e 616d 653d  --filters "Name=
-00012570: 7461 673a 736b 7970 696c 6f74 2d63 6c75  tag:skypilot-clu
-00012580: 7374 6572 2d6e 616d 652c 5661 6c75 6573  ster-name,Values
-00012590: 3d7b 6e61 6d65 7d2a 2220 270a 2020 2020  ={name}*" '.    
-000125a0: 2020 2020 2020 2020 2020 2020 272d 2d66              '--f
-000125b0: 696c 7465 7273 2022 4e61 6d65 3d74 6167  ilters "Name=tag
-000125c0: 3a69 6e6c 696e 656c 6162 656c 312c 5661  :inlinelabel1,Va
-000125d0: 6c75 6573 3d69 6e6c 696e 6576 616c 7565  lues=inlinevalue
-000125e0: 3122 2027 0a20 2020 2020 2020 2020 2020  1" '.           
-000125f0: 2020 2020 2027 2d2d 6669 6c74 6572 7320       '--filters 
-00012600: 224e 616d 653d 7461 673a 696e 6c69 6e65  "Name=tag:inline
-00012610: 6c61 6265 6c32 2c56 616c 7565 733d 696e  label2,Values=in
-00012620: 6c69 6e65 7661 6c75 6532 2220 270a 2020  linevalue2" '.  
-00012630: 2020 2020 2020 2020 2020 2020 2020 272d                '-
-00012640: 2d72 6567 696f 6e20 7573 2d65 6173 742d  -region us-east-
-00012650: 3120 2d2d 6f75 7470 7574 2074 6578 7427  1 --output text'
-00012660: 2c0a 2020 2020 2020 2020 2020 2020 5d2c  ,.            ],
-00012670: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00012680: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
-00012690: 7d27 2c0a 2020 2020 2020 2020 290a 2020  }',.        ).  
-000126a0: 2020 2020 2020 7275 6e5f 6f6e 655f 7465        run_one_te
-000126b0: 7374 2874 6573 7429 0a0a 0a23 202d 2d2d  st(test)...# ---
-000126c0: 2d2d 2d2d 2d2d 2d20 4c61 6265 6c73 2066  ------- Labels f
-000126d0: 726f 6d20 7461 736b 206f 6e20 4743 5020  rom task on GCP 
-000126e0: 286c 6162 656c 7329 202d 2d2d 2d2d 2d2d  (labels) -------
-000126f0: 2d2d 2d0a 4070 7974 6573 742e 6d61 726b  ---.@pytest.mark
-00012700: 2e67 6370 0a64 6566 2074 6573 745f 7461  .gcp.def test_ta
-00012710: 736b 5f6c 6162 656c 735f 6763 7028 293a  sk_labels_gcp():
-00012720: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
-00012730: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
-00012740: 2020 2020 7465 6d70 6c61 7465 5f73 7472      template_str
-00012750: 203d 2070 6174 686c 6962 2e50 6174 6828   = pathlib.Path(
-00012760: 0a20 2020 2020 2020 2027 7465 7374 732f  .        'tests/
-00012770: 7465 7374 5f79 616d 6c73 2f74 6573 745f  test_yamls/test_
-00012780: 6c61 6265 6c73 2e79 616d 6c2e 6a32 2729  labels.yaml.j2')
-00012790: 2e72 6561 645f 7465 7874 2829 0a20 2020  .read_text().   
-000127a0: 2074 656d 706c 6174 6520 3d20 6a69 6e6a   template = jinj
-000127b0: 6132 2e54 656d 706c 6174 6528 7465 6d70  a2.Template(temp
-000127c0: 6c61 7465 5f73 7472 290a 2020 2020 636f  late_str).    co
-000127d0: 6e74 656e 7420 3d20 7465 6d70 6c61 7465  ntent = template
-000127e0: 2e72 656e 6465 7228 636c 6f75 643d 2767  .render(cloud='g
-000127f0: 6370 2729 0a20 2020 2077 6974 6820 7465  cp').    with te
-00012800: 6d70 6669 6c65 2e4e 616d 6564 5465 6d70  mpfile.NamedTemp
-00012810: 6f72 6172 7946 696c 6528 7375 6666 6978  oraryFile(suffix
-00012820: 3d27 2e79 616d 6c27 2c20 6d6f 6465 3d27  ='.yaml', mode='
-00012830: 7727 2920 6173 2066 3a0a 2020 2020 2020  w') as f:.      
-00012840: 2020 662e 7772 6974 6528 636f 6e74 656e    f.write(conten
-00012850: 7429 0a20 2020 2020 2020 2066 2e66 6c75  t).        f.flu
-00012860: 7368 2829 0a20 2020 2020 2020 2066 696c  sh().        fil
-00012870: 655f 7061 7468 203d 2066 2e6e 616d 650a  e_path = f.name.
-00012880: 2020 2020 2020 2020 7465 7374 203d 2054          test = T
-00012890: 6573 7428 0a20 2020 2020 2020 2020 2020  est(.           
-000128a0: 2027 7461 736b 5f6c 6162 656c 735f 6763   'task_labels_gc
-000128b0: 7027 2c0a 2020 2020 2020 2020 2020 2020  p',.            
-000128c0: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
-000128d0: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
-000128e0: 7920 2d63 207b 6e61 6d65 7d20 7b66 696c  y -c {name} {fil
-000128f0: 655f 7061 7468 7d27 2c0a 2020 2020 2020  e_path}',.      
-00012900: 2020 2020 2020 2020 2020 2320 5665 7269            # Veri
-00012910: 6679 2077 6974 6820 6763 6c6f 7564 2063  fy with gcloud c
-00012920: 6c69 2074 6861 7420 7468 6520 7461 6773  li that the tags
-00012930: 2061 7265 2073 6574 0a20 2020 2020 2020   are set.       
-00012940: 2020 2020 2020 2020 2066 2767 636c 6f75           f'gclou
-00012950: 6420 636f 6d70 7574 6520 696e 7374 616e  d compute instan
-00012960: 6365 7320 6c69 7374 202d 2d66 696c 7465  ces list --filte
-00012970: 723d 226e 616d 657e 5c27 5e7b 6e61 6d65  r="name~\'^{name
-00012980: 7d5c 2720 414e 4420 270a 2020 2020 2020  }\' AND '.      
-00012990: 2020 2020 2020 2020 2020 276c 6162 656c            'label
-000129a0: 732e 696e 6c69 6e65 6c61 6265 6c31 3d5c  s.inlinelabel1=\
-000129b0: 2769 6e6c 696e 6576 616c 7565 315c 2720  'inlinevalue1\' 
-000129c0: 414e 4420 270a 2020 2020 2020 2020 2020  AND '.          
-000129d0: 2020 2020 2020 276c 6162 656c 732e 696e        'labels.in
-000129e0: 6c69 6e65 6c61 6265 6c32 3d5c 2769 6e6c  linelabel2=\'inl
-000129f0: 696e 6576 616c 7565 325c 2722 2027 0a20  inevalue2\'" '. 
-00012a00: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-00012a10: 2d2d 666f 726d 6174 3d22 7661 6c75 6528  --format="value(
-00012a20: 6e61 6d65 2922 207c 2067 7265 7020 2e27  name)" | grep .'
-00012a30: 2c0a 2020 2020 2020 2020 2020 2020 5d2c  ,.            ],
-00012a40: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00012a50: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
-00012a60: 7d27 2c0a 2020 2020 2020 2020 290a 2020  }',.        ).  
-00012a70: 2020 2020 2020 7275 6e5f 6f6e 655f 7465        run_one_te
-00012a80: 7374 2874 6573 7429 0a0a 0a23 202d 2d2d  st(test)...# ---
-00012a90: 2d2d 2d2d 2d2d 2d20 4c61 6265 6c73 2066  ------- Labels f
-00012aa0: 726f 6d20 7461 736b 206f 6e20 4b75 6265  rom task on Kube
-00012ab0: 726e 6574 6573 2028 6c61 6265 6c73 2920  rnetes (labels) 
-00012ac0: 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465  ----------.@pyte
-00012ad0: 7374 2e6d 6172 6b2e 6b75 6265 726e 6574  st.mark.kubernet
-00012ae0: 6573 0a64 6566 2074 6573 745f 7461 736b  es.def test_task
-00012af0: 5f6c 6162 656c 735f 6b75 6265 726e 6574  _labels_kubernet
-00012b00: 6573 2829 3a0a 2020 2020 6e61 6d65 203d  es():.    name =
-00012b10: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
-00012b20: 6d65 2829 0a20 2020 2074 656d 706c 6174  me().    templat
-00012b30: 655f 7374 7220 3d20 7061 7468 6c69 622e  e_str = pathlib.
-00012b40: 5061 7468 280a 2020 2020 2020 2020 2774  Path(.        't
-00012b50: 6573 7473 2f74 6573 745f 7961 6d6c 732f  ests/test_yamls/
-00012b60: 7465 7374 5f6c 6162 656c 732e 7961 6d6c  test_labels.yaml
-00012b70: 2e6a 3227 292e 7265 6164 5f74 6578 7428  .j2').read_text(
-00012b80: 290a 2020 2020 7465 6d70 6c61 7465 203d  ).    template =
-00012b90: 206a 696e 6a61 322e 5465 6d70 6c61 7465   jinja2.Template
-00012ba0: 2874 656d 706c 6174 655f 7374 7229 0a20  (template_str). 
-00012bb0: 2020 2063 6f6e 7465 6e74 203d 2074 656d     content = tem
-00012bc0: 706c 6174 652e 7265 6e64 6572 2863 6c6f  plate.render(clo
-00012bd0: 7564 3d27 6b75 6265 726e 6574 6573 2729  ud='kubernetes')
-00012be0: 0a20 2020 2077 6974 6820 7465 6d70 6669  .    with tempfi
-00012bf0: 6c65 2e4e 616d 6564 5465 6d70 6f72 6172  le.NamedTemporar
-00012c00: 7946 696c 6528 7375 6666 6978 3d27 2e79  yFile(suffix='.y
-00012c10: 616d 6c27 2c20 6d6f 6465 3d27 7727 2920  aml', mode='w') 
-00012c20: 6173 2066 3a0a 2020 2020 2020 2020 662e  as f:.        f.
-00012c30: 7772 6974 6528 636f 6e74 656e 7429 0a20  write(content). 
-00012c40: 2020 2020 2020 2066 2e66 6c75 7368 2829         f.flush()
-00012c50: 0a20 2020 2020 2020 2066 696c 655f 7061  .        file_pa
-00012c60: 7468 203d 2066 2e6e 616d 650a 2020 2020  th = f.name.    
-00012c70: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
-00012c80: 0a20 2020 2020 2020 2020 2020 2027 7461  .            'ta
-00012c90: 736b 5f6c 6162 656c 735f 6b75 6265 726e  sk_labels_kubern
-00012ca0: 6574 6573 272c 0a20 2020 2020 2020 2020  etes',.         
-00012cb0: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
-00012cc0: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
-00012cd0: 6820 2d79 202d 6320 7b6e 616d 657d 207b  h -y -c {name} {
-00012ce0: 6669 6c65 5f70 6174 687d 272c 0a20 2020  file_path}',.   
-00012cf0: 2020 2020 2020 2020 2020 2020 2023 2056               # V
-00012d00: 6572 6966 7920 7769 7468 206b 7562 6563  erify with kubec
-00012d10: 746c 2074 6861 7420 7468 6520 6c61 6265  tl that the labe
-00012d20: 6c73 2061 7265 2073 6574 2e0a 2020 2020  ls are set..    
-00012d30: 2020 2020 2020 2020 2020 2020 276b 7562              'kub
-00012d40: 6563 746c 2067 6574 2070 6f64 7320 270a  ectl get pods '.
-00012d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012d60: 272d 2d73 656c 6563 746f 7220 696e 6c69  '--selector inli
-00012d70: 6e65 6c61 6265 6c31 3d69 6e6c 696e 6576  nelabel1=inlinev
-00012d80: 616c 7565 3120 270a 2020 2020 2020 2020  alue1 '.        
-00012d90: 2020 2020 2020 2020 272d 2d73 656c 6563          '--selec
-00012da0: 746f 7220 696e 6c69 6e65 6c61 6265 6c32  tor inlinelabel2
-00012db0: 3d69 6e6c 696e 6576 616c 7565 3220 270a  =inlinevalue2 '.
-00012dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012dd0: 272d 6f20 6a73 6f6e 7061 7468 3d5c 277b  '-o jsonpath=\'{
-00012de0: 2e69 7465 6d73 5b2a 5d2e 6d65 7461 6461  .items[*].metada
-00012df0: 7461 2e6e 616d 657d 5c27 207c 2027 0a20  ta.name}\' | '. 
-00012e00: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00012e10: 2767 7265 7020 5c27 5e7b 6e61 6d65 7d5c  'grep \'^{name}\
-00012e20: 2727 0a20 2020 2020 2020 2020 2020 205d  ''.            ]
-00012e30: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00012e40: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
-00012e50: 657d 272c 0a20 2020 2020 2020 2029 0a20  e}',.        ). 
-00012e60: 2020 2020 2020 2072 756e 5f6f 6e65 5f74         run_one_t
-00012e70: 6573 7428 7465 7374 290a 0a0a 2320 2d2d  est(test)...# --
-00012e80: 2d2d 2d2d 2d2d 2d2d 2054 6173 6b3a 206e  -------- Task: n
-00012e90: 3d32 206e 6f64 6573 2077 6974 6820 7365  =2 nodes with se
-00012ea0: 7475 7073 2e20 2d2d 2d2d 2d2d 2d2d 2d2d  tups. ----------
-00012eb0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
-00012ec0: 5f6c 616d 6264 615f 636c 6f75 6420 2023  _lambda_cloud  #
-00012ed0: 204c 616d 6264 6120 436c 6f75 6420 646f   Lambda Cloud do
-00012ee0: 6573 206e 6f74 2068 6176 6520 5631 3030  es not have V100
-00012ef0: 2067 7075 730a 4070 7974 6573 742e 6d61   gpus.@pytest.ma
-00012f00: 726b 2e6e 6f5f 6962 6d20 2023 2049 424d  rk.no_ibm  # IBM
-00012f10: 2063 6c6f 7564 2063 7572 7265 6e74 6c79   cloud currently
-00012f20: 2064 6f65 736e 2774 2070 726f 7669 6465   doesn't provide
-00012f30: 2070 7562 6c69 6320 696d 6167 6520 7769   public image wi
-00012f40: 7468 2043 5544 410a 4070 7974 6573 742e  th CUDA.@pytest.
-00012f50: 6d61 726b 2e6e 6f5f 7363 7020 2023 2053  mark.no_scp  # S
-00012f60: 4350 2064 6f65 7320 6e6f 7420 7375 7070  CP does not supp
-00012f70: 6f72 7420 6e75 6d5f 6e6f 6465 7320 3e20  ort num_nodes > 
-00012f80: 3120 7965 740a 4070 7974 6573 742e 6d61  1 yet.@pytest.ma
-00012f90: 726b 2e73 6b69 7028 0a20 2020 2072 6561  rk.skip(.    rea
-00012fa0: 736f 6e3d 0a20 2020 2027 5468 6520 7265  son=.    'The re
-00012fb0: 736e 6574 5f64 6973 7472 6962 7574 6564  snet_distributed
-00012fc0: 5f74 665f 6170 7020 6973 2066 6c61 6b79  _tf_app is flaky
-00012fd0: 2c20 6475 6520 746f 2069 7420 6661 696c  , due to it fail
-00012fe0: 696e 6720 746f 2064 6574 6563 7420 4750  ing to detect GP
-00012ff0: 5573 2e27 290a 6465 6620 7465 7374 5f64  Us.').def test_d
-00013000: 6973 7472 6962 7574 6564 5f74 6628 6765  istributed_tf(ge
-00013010: 6e65 7269 635f 636c 6f75 643a 2073 7472  neric_cloud: str
-00013020: 293a 0a20 2020 206e 616d 6520 3d20 5f67  ):.    name = _g
-00013030: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
-00013040: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
-00013050: 7428 0a20 2020 2020 2020 2027 7265 736e  t(.        'resn
-00013060: 6574 5f64 6973 7472 6962 7574 6564 5f74  et_distributed_t
-00013070: 665f 6170 7027 2c0a 2020 2020 2020 2020  f_app',.        
-00013080: 5b0a 2020 2020 2020 2020 2020 2020 2320  [.            # 
-00013090: 4e4f 5445 3a20 7275 6e6e 696e 6720 6974  NOTE: running it
-000130a0: 2074 7769 6365 2077 696c 6c20 6861 6e67   twice will hang
-000130b0: 2028 736f 6d65 7469 6d65 733f 2920 2d20   (sometimes?) - 
-000130c0: 616e 2061 7070 2d6c 6576 656c 2062 7567  an app-level bug
-000130d0: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
-000130e0: 7079 7468 6f6e 2065 7861 6d70 6c65 732f  python examples/
-000130f0: 7265 736e 6574 5f64 6973 7472 6962 7574  resnet_distribut
-00013100: 6564 5f74 665f 6170 702e 7079 207b 6e61  ed_tf_app.py {na
-00013110: 6d65 7d20 7b67 656e 6572 6963 5f63 6c6f  me} {generic_clo
-00013120: 7564 7d27 2c0a 2020 2020 2020 2020 2020  ud}',.          
-00013130: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
-00013140: 6d65 7d20 3120 2d2d 7374 6174 7573 272c  me} 1 --status',
-00013150: 2020 2320 456e 7375 7265 2074 6865 206a    # Ensure the j
-00013160: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
-00013170: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-00013180: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
-00013190: 6e61 6d65 7d27 2c0a 2020 2020 2020 2020  name}',.        
-000131a0: 7469 6d65 6f75 743d 3235 202a 2036 302c  timeout=25 * 60,
-000131b0: 2020 2320 3235 206d 696e 7320 2869 7420    # 25 mins (it 
-000131c0: 7461 6b65 7320 6172 6f75 6e64 207e 3139  takes around ~19
-000131d0: 206d 696e 7329 0a20 2020 2029 0a20 2020   mins).    ).   
-000131e0: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
-000131f0: 7374 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d  st)...# --------
-00013200: 2d2d 2054 6573 7469 6e67 2047 4350 2073  -- Testing GCP s
-00013210: 7461 7274 2061 6e64 2073 746f 7020 696e  tart and stop in
-00013220: 7374 616e 6365 7320 2d2d 2d2d 2d2d 2d2d  stances --------
-00013230: 2d2d 0a40 7079 7465 7374 2e6d 6172 6b2e  --.@pytest.mark.
-00013240: 6763 700a 6465 6620 7465 7374 5f67 6370  gcp.def test_gcp
-00013250: 5f73 7461 7274 5f73 746f 7028 293a 0a20  _start_stop():. 
-00013260: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
-00013270: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
-00013280: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
-00013290: 2020 2020 2020 2027 6763 702d 7374 6172         'gcp-star
-000132a0: 742d 7374 6f70 272c 0a20 2020 2020 2020  t-stop',.       
-000132b0: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
-000132c0: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
-000132d0: 6320 7b6e 616d 657d 2065 7861 6d70 6c65  c {name} example
-000132e0: 732f 6763 705f 7374 6172 745f 7374 6f70  s/gcp_start_stop
-000132f0: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
-00013300: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
-00013310: 6e61 6d65 7d20 3120 2d2d 7374 6174 7573  name} 1 --status
-00013320: 272c 2020 2320 456e 7375 7265 2074 6865  ',  # Ensure the
-00013330: 206a 6f62 2073 7563 6365 6564 6564 2e0a   job succeeded..
-00013340: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00013350: 7920 6578 6563 207b 6e61 6d65 7d20 6578  y exec {name} ex
-00013360: 616d 706c 6573 2f67 6370 5f73 7461 7274  amples/gcp_start
-00013370: 5f73 746f 702e 7961 6d6c 272c 0a20 2020  _stop.yaml',.   
-00013380: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00013390: 6f67 7320 7b6e 616d 657d 2032 202d 2d73  ogs {name} 2 --s
-000133a0: 7461 7475 7327 2c20 2023 2045 6e73 7572  tatus',  # Ensur
-000133b0: 6520 7468 6520 6a6f 6220 7375 6363 6565  e the job succee
-000133c0: 6465 642e 0a20 2020 2020 2020 2020 2020  ded..           
-000133d0: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
-000133e0: 657d 2022 7072 6c69 6d69 7420 2d6e 202d  e} "prlimit -n -
-000133f0: 2d70 6964 3d5c 2428 7067 7265 7020 2d66  -pid=\$(pgrep -f
-00013400: 205c 2772 6179 6c65 742f 7261 796c 6574   \'raylet/raylet
-00013410: 202d 2d72 6179 6c65 745f 736f 636b 6574   --raylet_socket
-00013420: 5f6e 616d 655c 2729 207c 2067 7265 7020  _name\') | grep 
-00013430: 5c27 225c 2731 3034 3835 3736 2031 3034  \'"\'1048576 104
-00013440: 3835 3736 5c27 225c 2722 272c 2020 2320  8576\'"\'"',  # 
-00013450: 456e 7375 7265 2074 6865 2072 6179 6c65  Ensure the rayle
-00013460: 7420 7072 6f63 6573 7320 6861 7320 7468  t process has th
-00013470: 6520 636f 7272 6563 7420 6669 6c65 2064  e correct file d
-00013480: 6573 6372 6970 746f 7220 6c69 6d69 742e  escriptor limit.
-00013490: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-000134a0: 6b79 206c 6f67 7320 7b6e 616d 657d 2033  ky logs {name} 3
-000134b0: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
-000134c0: 6e73 7572 6520 7468 6520 6a6f 6220 7375  nsure the job su
-000134d0: 6363 6565 6465 642e 0a20 2020 2020 2020  cceeded..       
-000134e0: 2020 2020 2066 2773 6b79 2073 746f 7020       f'sky stop 
-000134f0: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
-00013500: 2020 2020 2020 2020 6627 736c 6565 7020          f'sleep 
-00013510: 3230 272c 0a20 2020 2020 2020 2020 2020  20',.           
-00013520: 2066 2773 6b79 2073 7461 7274 202d 7920   f'sky start -y 
-00013530: 7b6e 616d 657d 202d 6920 3127 2c0a 2020  {name} -i 1',.  
-00013540: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00013550: 6578 6563 207b 6e61 6d65 7d20 6578 616d  exec {name} exam
-00013560: 706c 6573 2f67 6370 5f73 7461 7274 5f73  ples/gcp_start_s
-00013570: 746f 702e 7961 6d6c 272c 0a20 2020 2020  top.yaml',.     
-00013580: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-00013590: 7320 7b6e 616d 657d 2034 202d 2d73 7461  s {name} 4 --sta
-000135a0: 7475 7327 2c20 2023 2045 6e73 7572 6520  tus',  # Ensure 
-000135b0: 7468 6520 6a6f 6220 7375 6363 6565 6465  the job succeede
-000135c0: 642e 0a20 2020 2020 2020 2020 2020 2027  d..            '
-000135d0: 736c 6565 7020 3138 3027 2c0a 2020 2020  sleep 180',.    
-000135e0: 2020 2020 2020 2020 6627 736b 7920 7374          f'sky st
-000135f0: 6174 7573 202d 7220 7b6e 616d 657d 207c  atus -r {name} |
-00013600: 2067 7265 7020 2249 4e49 545c 7c53 544f   grep "INIT\|STO
-00013610: 5050 4544 2227 2c0a 2020 2020 2020 2020  PPED"',.        
-00013620: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
-00013630: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
-00013640: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
-00013650: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
-00013660: 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20 5465  .# ---------- Te
-00013670: 7374 696e 6720 417a 7572 6520 7374 6172  sting Azure star
-00013680: 7420 616e 6420 7374 6f70 2069 6e73 7461  t and stop insta
-00013690: 6e63 6573 202d 2d2d 2d2d 2d2d 2d2d 2d0a  nces ----------.
-000136a0: 4070 7974 6573 742e 6d61 726b 2e61 7a75  @pytest.mark.azu
-000136b0: 7265 0a64 6566 2074 6573 745f 617a 7572  re.def test_azur
-000136c0: 655f 7374 6172 745f 7374 6f70 2829 3a0a  e_start_stop():.
-000136d0: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
-000136e0: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
-000136f0: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
-00013700: 2020 2020 2020 2020 2761 7a75 7265 2d73          'azure-s
-00013710: 7461 7274 2d73 746f 7027 2c0a 2020 2020  tart-stop',.    
-00013720: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
-00013730: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
-00013740: 7920 2d63 207b 6e61 6d65 7d20 6578 616d  y -c {name} exam
-00013750: 706c 6573 2f61 7a75 7265 5f73 7461 7274  ples/azure_start
-00013760: 5f73 746f 702e 7961 6d6c 272c 0a20 2020  _stop.yaml',.   
-00013770: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
-00013780: 7865 6320 7b6e 616d 657d 2065 7861 6d70  xec {name} examp
-00013790: 6c65 732f 617a 7572 655f 7374 6172 745f  les/azure_start_
-000137a0: 7374 6f70 2e79 616d 6c27 2c0a 2020 2020  stop.yaml',.    
-000137b0: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
-000137c0: 6773 207b 6e61 6d65 7d20 3120 2d2d 7374  gs {name} 1 --st
-000137d0: 6174 7573 272c 2020 2320 456e 7375 7265  atus',  # Ensure
-000137e0: 2074 6865 206a 6f62 2073 7563 6365 6564   the job succeed
-000137f0: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
-00013800: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
-00013810: 7d20 2270 726c 696d 6974 202d 6e20 2d2d  } "prlimit -n --
-00013820: 7069 643d 5c24 2870 6772 6570 202d 6620  pid=\$(pgrep -f 
-00013830: 5c27 7261 796c 6574 2f72 6179 6c65 7420  \'raylet/raylet 
-00013840: 2d2d 7261 796c 6574 5f73 6f63 6b65 745f  --raylet_socket_
-00013850: 6e61 6d65 5c27 2920 7c20 6772 6570 205c  name\') | grep \
-00013860: 2722 5c27 3130 3438 3537 3620 3130 3438  '"\'1048576 1048
-00013870: 3537 365c 2722 5c27 2227 2c20 2023 2045  576\'"\'"',  # E
-00013880: 6e73 7572 6520 7468 6520 7261 796c 6574  nsure the raylet
-00013890: 2070 726f 6365 7373 2068 6173 2074 6865   process has the
-000138a0: 2063 6f72 7265 6374 2066 696c 6520 6465   correct file de
-000138b0: 7363 7269 7074 6f72 206c 696d 6974 2e0a  scriptor limit..
-000138c0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-000138d0: 7920 6c6f 6773 207b 6e61 6d65 7d20 3220  y logs {name} 2 
-000138e0: 2d2d 7374 6174 7573 272c 2020 2320 456e  --status',  # En
-000138f0: 7375 7265 2074 6865 206a 6f62 2073 7563  sure the job suc
-00013900: 6365 6564 6564 2e0a 2020 2020 2020 2020  ceeded..        
-00013910: 2020 2020 6627 736b 7920 7374 6f70 202d      f'sky stop -
-00013920: 7920 7b6e 616d 657d 272c 0a20 2020 2020  y {name}',.     
-00013930: 2020 2020 2020 2066 2773 6b79 2073 7461         f'sky sta
-00013940: 7274 202d 7920 7b6e 616d 657d 202d 6920  rt -y {name} -i 
-00013950: 3127 2c0a 2020 2020 2020 2020 2020 2020  1',.            
-00013960: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
-00013970: 7d20 6578 616d 706c 6573 2f61 7a75 7265  } examples/azure
-00013980: 5f73 7461 7274 5f73 746f 702e 7961 6d6c  _start_stop.yaml
-00013990: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-000139a0: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-000139b0: 2033 202d 2d73 7461 7475 7327 2c20 2023   3 --status',  #
-000139c0: 2045 6e73 7572 6520 7468 6520 6a6f 6220   Ensure the job 
-000139d0: 7375 6363 6565 6465 642e 0a20 2020 2020  succeeded..     
-000139e0: 2020 2020 2020 2027 736c 6565 7020 3230         'sleep 20
-000139f0: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
-00013a00: 6627 733d 2428 736b 7920 7374 6174 7573  f's=$(sky status
-00013a10: 202d 7220 7b6e 616d 657d 2920 2626 2065   -r {name}) && e
-00013a20: 6368 6f20 2473 2026 2620 6563 686f 2024  cho $s && echo $
-00013a30: 7320 7c20 6772 6570 2022 494e 4954 5c7c  s | grep "INIT\|
-00013a40: 5354 4f50 5045 4422 270a 2020 2020 2020  STOPPED"'.      
-00013a50: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
-00013a60: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
-00013a70: 7d27 2c0a 2020 2020 2020 2020 7469 6d65  }',.        time
-00013a80: 6f75 743d 3330 202a 2036 302c 2020 2320  out=30 * 60,  # 
-00013a90: 3330 206d 696e 730a 2020 2020 290a 2020  30 mins.    ).  
-00013aa0: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
-00013ab0: 6573 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d  est)...# -------
-00013ac0: 2d2d 2d20 5465 7374 696e 6720 4175 746f  --- Testing Auto
-00013ad0: 7374 6f70 7069 6e67 202d 2d2d 2d2d 2d2d  stopping -------
-00013ae0: 2d2d 2d0a 4070 7974 6573 742e 6d61 726b  ---.@pytest.mark
-00013af0: 2e6e 6f5f 666c 7569 6473 7461 636b 2020  .no_fluidstack  
-00013b00: 2320 466c 7569 6453 7461 636b 2064 6f65  # FluidStack doe
-00013b10: 7320 6e6f 7420 7375 7070 6f72 7420 7374  s not support st
-00013b20: 6f70 7069 6e67 2069 6e20 536b 7950 696c  opping in SkyPil
-00013b30: 6f74 2069 6d70 6c65 6d65 6e74 6174 696f  ot implementatio
-00013b40: 6e0a 4070 7974 6573 742e 6d61 726b 2e6e  n.@pytest.mark.n
-00013b50: 6f5f 6c61 6d62 6461 5f63 6c6f 7564 2020  o_lambda_cloud  
-00013b60: 2320 4c61 6d62 6461 2043 6c6f 7564 2064  # Lambda Cloud d
-00013b70: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
-00013b80: 7374 6f70 7069 6e67 2069 6e73 7461 6e63  stopping instanc
-00013b90: 6573 0a40 7079 7465 7374 2e6d 6172 6b2e  es.@pytest.mark.
-00013ba0: 6e6f 5f69 626d 2020 2320 4649 5828 4942  no_ibm  # FIX(IB
-00013bb0: 4d29 2073 706f 7261 6469 6361 6c6c 7920  M) sporadically 
-00013bc0: 6661 696c 732c 2061 7320 7265 7374 6172  fails, as restar
-00013bd0: 7465 6420 776f 726b 6572 7320 7374 6179  ted workers stay
-00013be0: 2075 6e69 6e69 7469 616c 697a 6564 2069   uninitialized i
-00013bf0: 6e64 6566 696e 6974 656c 790a 4070 7974  ndefinitely.@pyt
-00013c00: 6573 742e 6d61 726b 2e6e 6f5f 7363 7020  est.mark.no_scp 
-00013c10: 2023 2053 4350 2064 6f65 7320 6e6f 7420   # SCP does not 
-00013c20: 7375 7070 6f72 7420 6e75 6d5f 6e6f 6465  support num_node
-00013c30: 7320 3e20 3120 7965 740a 4070 7974 6573  s > 1 yet.@pytes
-00013c40: 742e 6d61 726b 2e6e 6f5f 6b75 6265 726e  t.mark.no_kubern
-00013c50: 6574 6573 2020 2320 4b75 6265 726e 6574  etes  # Kubernet
-00013c60: 6573 2064 6f65 7320 6e6f 7420 6175 746f  es does not auto
-00013c70: 7374 6f70 2079 6574 0a64 6566 2074 6573  stop yet.def tes
-00013c80: 745f 6175 746f 7374 6f70 2867 656e 6572  t_autostop(gener
-00013c90: 6963 5f63 6c6f 7564 3a20 7374 7229 3a0a  ic_cloud: str):.
-00013ca0: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
-00013cb0: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
-00013cc0: 2020 2023 2041 7a75 7265 2074 616b 6573     # Azure takes
-00013cd0: 207e 2037 6d31 3573 2028 3433 3573 2920   ~ 7m15s (435s) 
-00013ce0: 746f 2061 7574 6f73 746f 7020 6120 564d  to autostop a VM
-00013cf0: 2c20 736f 2068 6572 6520 7765 2075 7365  , so here we use
-00013d00: 2036 3030 2074 6f20 656e 7375 7265 0a20   600 to ensure. 
-00013d10: 2020 2023 2074 6865 2056 4d20 6973 2073     # the VM is s
-00013d20: 746f 7070 6564 2e0a 2020 2020 6175 746f  topped..    auto
-00013d30: 7374 6f70 5f74 696d 656f 7574 203d 2036  stop_timeout = 6
-00013d40: 3030 2069 6620 6765 6e65 7269 635f 636c  00 if generic_cl
-00013d50: 6f75 6420 3d3d 2027 617a 7572 6527 2065  oud == 'azure' e
-00013d60: 6c73 6520 3235 300a 2020 2020 2320 4c61  lse 250.    # La
-00013d70: 756e 6368 696e 6720 616e 6420 7374 6172  unching and star
-00013d80: 7469 6e67 2041 7a75 7265 2063 6c75 7374  ting Azure clust
-00013d90: 6572 7320 6361 6e20 7461 6b65 2061 206c  ers can take a l
-00013da0: 6f6e 6720 7469 6d65 2074 6f6f 2e20 652e  ong time too. e.
-00013db0: 672e 2c20 7265 7374 6172 740a 2020 2020  g., restart.    
-00013dc0: 2320 6120 7374 6f70 7065 6420 417a 7572  # a stopped Azur
-00013dd0: 6520 636c 7573 7465 7220 6361 6e20 7461  e cluster can ta
-00013de0: 6b65 2037 6d2e 2053 6f20 7765 2073 6574  ke 7m. So we set
-00013df0: 2074 6865 2074 6f74 616c 2074 696d 656f   the total timeo
-00013e00: 7574 2074 6f20 3730 6d2e 0a20 2020 2074  ut to 70m..    t
-00013e10: 6f74 616c 5f74 696d 656f 7574 5f6d 696e  otal_timeout_min
-00013e20: 7574 6573 203d 2037 3020 6966 2067 656e  utes = 70 if gen
-00013e30: 6572 6963 5f63 6c6f 7564 203d 3d20 2761  eric_cloud == 'a
-00013e40: 7a75 7265 2720 656c 7365 2032 300a 2020  zure' else 20.  
-00013e50: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
-00013e60: 2020 2020 2020 2027 6175 746f 7374 6f70         'autostop
-00013e70: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
-00013e80: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00013e90: 6175 6e63 6820 2d79 202d 6420 2d63 207b  aunch -y -d -c {
-00013ea0: 6e61 6d65 7d20 2d2d 6e75 6d2d 6e6f 6465  name} --num-node
-00013eb0: 7320 3220 2d2d 636c 6f75 6420 7b67 656e  s 2 --cloud {gen
-00013ec0: 6572 6963 5f63 6c6f 7564 7d20 7465 7374  eric_cloud} test
-00013ed0: 732f 7465 7374 5f79 616d 6c73 2f6d 696e  s/test_yamls/min
-00013ee0: 696d 616c 2e79 616d 6c27 2c0a 2020 2020  imal.yaml',.    
-00013ef0: 2020 2020 2020 2020 6627 736b 7920 6175          f'sky au
-00013f00: 746f 7374 6f70 202d 7920 7b6e 616d 657d  tostop -y {name}
-00013f10: 202d 6920 3127 2c0a 0a20 2020 2020 2020   -i 1',..       
-00013f20: 2020 2020 2023 2045 6e73 7572 6520 6175       # Ensure au
-00013f30: 746f 7374 6f70 2069 7320 7365 742e 0a20  tostop is set.. 
-00013f40: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00013f50: 2073 7461 7475 7320 7c20 6772 6570 207b   status | grep {
-00013f60: 6e61 6d65 7d20 7c20 6772 6570 2022 316d  name} | grep "1m
-00013f70: 2227 2c0a 0a20 2020 2020 2020 2020 2020  "',..           
-00013f80: 2023 2045 6e73 7572 6520 7468 6520 636c   # Ensure the cl
-00013f90: 7573 7465 7220 6973 206e 6f74 2073 746f  uster is not sto
-00013fa0: 7070 6564 2065 6172 6c79 2e0a 2020 2020  pped early..    
-00013fb0: 2020 2020 2020 2020 2773 6c65 6570 2034          'sleep 4
-00013fc0: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
-00013fd0: 6627 733d 2428 736b 7920 7374 6174 7573  f's=$(sky status
-00013fe0: 207b 6e61 6d65 7d20 2d2d 7265 6672 6573   {name} --refres
-00013ff0: 6829 3b20 6563 686f 2022 2473 223b 2065  h); echo "$s"; e
-00014000: 6368 6f3b 2065 6368 6f3b 2065 6368 6f20  cho; echo; echo 
-00014010: 2224 7322 2020 7c20 6772 6570 207b 6e61  "$s"  | grep {na
-00014020: 6d65 7d20 7c20 6772 6570 2055 5027 2c0a  me} | grep UP',.
-00014030: 0a20 2020 2020 2020 2020 2020 2023 2045  .            # E
-00014040: 6e73 7572 6520 7468 6520 636c 7573 7465  nsure the cluste
-00014050: 7220 6973 2053 544f 5050 4544 2e0a 2020  r is STOPPED..  
-00014060: 2020 2020 2020 2020 2020 6627 736c 6565            f'slee
-00014070: 7020 7b61 7574 6f73 746f 705f 7469 6d65  p {autostop_time
-00014080: 6f75 747d 272c 0a20 2020 2020 2020 2020  out}',.         
-00014090: 2020 2066 2773 3d24 2873 6b79 2073 7461     f's=$(sky sta
-000140a0: 7475 7320 7b6e 616d 657d 202d 2d72 6566  tus {name} --ref
-000140b0: 7265 7368 293b 2065 6368 6f20 2224 7322  resh); echo "$s"
-000140c0: 3b20 6563 686f 3b20 6563 686f 3b20 6563  ; echo; echo; ec
-000140d0: 686f 2022 2473 2220 207c 2067 7265 7020  ho "$s"  | grep 
-000140e0: 7b6e 616d 657d 207c 2067 7265 7020 5354  {name} | grep ST
-000140f0: 4f50 5045 4427 2c0a 0a20 2020 2020 2020  OPPED',..       
-00014100: 2020 2020 2023 2045 6e73 7572 6520 7468       # Ensure th
-00014110: 6520 636c 7573 7465 7220 6973 2055 5020  e cluster is UP 
-00014120: 616e 6420 7468 6520 6175 746f 7374 6f70  and the autostop
-00014130: 2073 6574 7469 6e67 2069 7320 7265 7365   setting is rese
-00014140: 7420 2827 2d27 292e 0a20 2020 2020 2020  t ('-')..       
-00014150: 2020 2020 2066 2773 6b79 2073 7461 7274       f'sky start
-00014160: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
-00014170: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
-00014180: 7461 7475 7320 7c20 6772 6570 207b 6e61  tatus | grep {na
-00014190: 6d65 7d20 7c20 6772 6570 202d 4520 2255  me} | grep -E "U
-000141a0: 505c 732b 2d22 272c 0a0a 2020 2020 2020  P\s+-"',..      
-000141b0: 2020 2020 2020 2320 456e 7375 7265 2074        # Ensure t
-000141c0: 6865 206a 6f62 2073 7563 6365 6564 6564  he job succeeded
-000141d0: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
-000141e0: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
-000141f0: 7465 7374 732f 7465 7374 5f79 616d 6c73  tests/test_yamls
-00014200: 2f6d 696e 696d 616c 2e79 616d 6c27 2c0a  /minimal.yaml',.
-00014210: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00014220: 7920 6c6f 6773 207b 6e61 6d65 7d20 3220  y logs {name} 2 
-00014230: 2d2d 7374 6174 7573 272c 0a0a 2020 2020  --status',..    
-00014240: 2020 2020 2020 2020 2320 5465 7374 2072          # Test r
-00014250: 6573 7461 7274 696e 6720 7468 6520 6964  estarting the id
-00014260: 6c65 6e65 7373 2074 696d 6572 2076 6961  leness timer via
-00014270: 2072 6573 6574 3a0a 2020 2020 2020 2020   reset:.        
-00014280: 2020 2020 6627 736b 7920 6175 746f 7374      f'sky autost
-00014290: 6f70 202d 7920 7b6e 616d 657d 202d 6920  op -y {name} -i 
-000142a0: 3127 2c20 2023 2049 646c 656e 6573 7320  1',  # Idleness 
-000142b0: 7374 6172 7473 2063 6f75 6e74 696e 672e  starts counting.
-000142c0: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
-000142d0: 6565 7020 3430 272c 2020 2320 416c 6d6f  eep 40',  # Almo
-000142e0: 7374 2072 6561 6368 6564 2074 6865 2074  st reached the t
-000142f0: 6872 6573 686f 6c64 2e0a 2020 2020 2020  hreshold..      
-00014300: 2020 2020 2020 6627 736b 7920 6175 746f        f'sky auto
-00014310: 7374 6f70 202d 7920 7b6e 616d 657d 202d  stop -y {name} -
-00014320: 6920 3127 2c20 2023 2053 686f 756c 6420  i 1',  # Should 
-00014330: 7265 7374 6172 7420 7468 6520 7469 6d65  restart the time
-00014340: 722e 0a20 2020 2020 2020 2020 2020 2027  r..            '
-00014350: 736c 6565 7020 3430 272c 0a20 2020 2020  sleep 40',.     
-00014360: 2020 2020 2020 2066 2773 3d24 2873 6b79         f's=$(sky
-00014370: 2073 7461 7475 7320 7b6e 616d 657d 202d   status {name} -
-00014380: 2d72 6566 7265 7368 293b 2065 6368 6f20  -refresh); echo 
-00014390: 2224 7322 3b20 6563 686f 3b20 6563 686f  "$s"; echo; echo
-000143a0: 3b20 6563 686f 2022 2473 2220 7c20 6772  ; echo "$s" | gr
-000143b0: 6570 207b 6e61 6d65 7d20 7c20 6772 6570  ep {name} | grep
-000143c0: 2055 5027 2c0a 2020 2020 2020 2020 2020   UP',.          
-000143d0: 2020 6627 736c 6565 7020 7b61 7574 6f73    f'sleep {autos
-000143e0: 746f 705f 7469 6d65 6f75 747d 272c 0a20  top_timeout}',. 
-000143f0: 2020 2020 2020 2020 2020 2066 2773 3d24             f's=$
-00014400: 2873 6b79 2073 7461 7475 7320 7b6e 616d  (sky status {nam
-00014410: 657d 202d 2d72 6566 7265 7368 293b 2065  e} --refresh); e
-00014420: 6368 6f20 2224 7322 3b20 6563 686f 3b20  cho "$s"; echo; 
-00014430: 6563 686f 3b20 6563 686f 2022 2473 2220  echo; echo "$s" 
-00014440: 207c 2067 7265 7020 7b6e 616d 657d 207c   | grep {name} |
-00014450: 2067 7265 7020 5354 4f50 5045 4427 2c0a   grep STOPPED',.
-00014460: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
-00014470: 6573 7420 7265 7374 6172 7469 6e67 2074  est restarting t
-00014480: 6865 2069 646c 656e 6573 7320 7469 6d65  he idleness time
-00014490: 7220 7669 6120 6578 6563 3a0a 2020 2020  r via exec:.    
-000144a0: 2020 2020 2020 2020 6627 736b 7920 7374          f'sky st
-000144b0: 6172 7420 2d79 207b 6e61 6d65 7d27 2c0a  art -y {name}',.
-000144c0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-000144d0: 7920 7374 6174 7573 207c 2067 7265 7020  y status | grep 
-000144e0: 7b6e 616d 657d 207c 2067 7265 7020 2d45  {name} | grep -E
-000144f0: 2022 5550 5c73 2b2d 2227 2c0a 2020 2020   "UP\s+-"',.    
-00014500: 2020 2020 2020 2020 6627 736b 7920 6175          f'sky au
-00014510: 746f 7374 6f70 202d 7920 7b6e 616d 657d  tostop -y {name}
-00014520: 202d 6920 3127 2c20 2023 2049 646c 656e   -i 1',  # Idlen
-00014530: 6573 7320 7374 6172 7473 2063 6f75 6e74  ess starts count
-00014540: 696e 672e 0a20 2020 2020 2020 2020 2020  ing..           
-00014550: 2027 736c 6565 7020 3435 272c 2020 2320   'sleep 45',  # 
-00014560: 416c 6d6f 7374 2072 6561 6368 6564 2074  Almost reached t
-00014570: 6865 2074 6872 6573 686f 6c64 2e0a 2020  he threshold..  
-00014580: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00014590: 6578 6563 207b 6e61 6d65 7d20 6563 686f  exec {name} echo
-000145a0: 2068 6927 2c20 2023 2053 686f 756c 6420   hi',  # Should 
-000145b0: 7265 7374 6172 7420 7468 6520 7469 6d65  restart the time
-000145c0: 722e 0a20 2020 2020 2020 2020 2020 2027  r..            '
-000145d0: 736c 6565 7020 3435 272c 0a20 2020 2020  sleep 45',.     
-000145e0: 2020 2020 2020 2066 2773 3d24 2873 6b79         f's=$(sky
-000145f0: 2073 7461 7475 7320 7b6e 616d 657d 202d   status {name} -
-00014600: 2d72 6566 7265 7368 293b 2065 6368 6f20  -refresh); echo 
-00014610: 2224 7322 3b20 6563 686f 3b20 6563 686f  "$s"; echo; echo
-00014620: 3b20 6563 686f 2022 2473 2220 207c 2067  ; echo "$s"  | g
-00014630: 7265 7020 7b6e 616d 657d 207c 2067 7265  rep {name} | gre
-00014640: 7020 5550 272c 0a20 2020 2020 2020 2020  p UP',.         
-00014650: 2020 2066 2773 6c65 6570 207b 6175 746f     f'sleep {auto
-00014660: 7374 6f70 5f74 696d 656f 7574 7d27 2c0a  stop_timeout}',.
-00014670: 2020 2020 2020 2020 2020 2020 6627 733d              f's=
-00014680: 2428 736b 7920 7374 6174 7573 207b 6e61  $(sky status {na
-00014690: 6d65 7d20 2d2d 7265 6672 6573 6829 3b20  me} --refresh); 
-000146a0: 6563 686f 2022 2473 223b 2065 6368 6f3b  echo "$s"; echo;
-000146b0: 2065 6368 6f3b 2065 6368 6f20 2224 7322   echo; echo "$s"
-000146c0: 2020 7c20 6772 6570 207b 6e61 6d65 7d20    | grep {name} 
-000146d0: 7c20 6772 6570 2053 544f 5050 4544 272c  | grep STOPPED',
-000146e0: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
-000146f0: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
-00014700: 7920 7b6e 616d 657d 272c 0a20 2020 2020  y {name}',.     
-00014710: 2020 2074 696d 656f 7574 3d74 6f74 616c     timeout=total
-00014720: 5f74 696d 656f 7574 5f6d 696e 7574 6573  _timeout_minutes
-00014730: 202a 2036 302c 0a20 2020 2029 0a20 2020   * 60,.    ).   
-00014740: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
-00014750: 7374 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d  st)...# --------
-00014760: 2d2d 2054 6573 7469 6e67 2041 7574 6f64  -- Testing Autod
-00014770: 6f77 6e69 6e67 202d 2d2d 2d2d 2d2d 2d2d  owning ---------
-00014780: 2d0a 4070 7974 6573 742e 6d61 726b 2e6e  -.@pytest.mark.n
-00014790: 6f5f 666c 7569 6473 7461 636b 2020 2320  o_fluidstack  # 
-000147a0: 466c 7569 6453 7461 636b 2064 6f65 7320  FluidStack does 
-000147b0: 6e6f 7420 7375 7070 6f72 7420 7374 6f70  not support stop
-000147c0: 7069 6e67 2069 6e20 536b 7950 696c 6f74  ping in SkyPilot
-000147d0: 2069 6d70 6c65 6d65 6e74 6174 696f 6e0a   implementation.
-000147e0: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
-000147f0: 7363 7020 2023 2053 4350 2064 6f65 7320  scp  # SCP does 
-00014800: 6e6f 7420 7375 7070 6f72 7420 6e75 6d5f  not support num_
-00014810: 6e6f 6465 7320 3e20 3120 7965 742e 2052  nodes > 1 yet. R
-00014820: 756e 2074 6573 745f 7363 705f 6175 746f  un test_scp_auto
-00014830: 646f 776e 2069 6e73 7465 6164 2e0a 6465  down instead..de
-00014840: 6620 7465 7374 5f61 7574 6f64 6f77 6e28  f test_autodown(
-00014850: 6765 6e65 7269 635f 636c 6f75 643a 2073  generic_cloud: s
-00014860: 7472 293a 0a20 2020 206e 616d 6520 3d20  tr):.    name = 
-00014870: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
-00014880: 6528 290a 2020 2020 2320 417a 7572 6520  e().    # Azure 
-00014890: 7461 6b65 7320 7e20 3133 6d33 3073 2028  takes ~ 13m30s (
-000148a0: 3831 3073 2920 746f 2061 7574 6f64 6f77  810s) to autodow
-000148b0: 6e20 6120 564d 2c20 736f 2068 6572 6520  n a VM, so here 
-000148c0: 7765 2075 7365 2039 3030 2074 6f20 656e  we use 900 to en
-000148d0: 7375 7265 0a20 2020 2023 2074 6865 2056  sure.    # the V
-000148e0: 4d20 6973 2074 6572 6d69 6e61 7465 642e  M is terminated.
-000148f0: 0a20 2020 2061 7574 6f64 6f77 6e5f 7469  .    autodown_ti
-00014900: 6d65 6f75 7420 3d20 3930 3020 6966 2067  meout = 900 if g
-00014910: 656e 6572 6963 5f63 6c6f 7564 203d 3d20  eneric_cloud == 
-00014920: 2761 7a75 7265 2720 656c 7365 2032 3430  'azure' else 240
-00014930: 0a20 2020 2074 6f74 616c 5f74 696d 656f  .    total_timeo
-00014940: 7574 5f6d 696e 7574 6573 203d 2039 3020  ut_minutes = 90 
-00014950: 6966 2067 656e 6572 6963 5f63 6c6f 7564  if generic_cloud
-00014960: 203d 3d20 2761 7a75 7265 2720 656c 7365   == 'azure' else
-00014970: 2032 300a 2020 2020 7465 7374 203d 2054   20.    test = T
-00014980: 6573 7428 0a20 2020 2020 2020 2027 6175  est(.        'au
-00014990: 746f 646f 776e 272c 0a20 2020 2020 2020  todown',.       
-000149a0: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
-000149b0: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
-000149c0: 6420 2d63 207b 6e61 6d65 7d20 2d2d 6e75  d -c {name} --nu
-000149d0: 6d2d 6e6f 6465 7320 3220 2d2d 636c 6f75  m-nodes 2 --clou
-000149e0: 6420 7b67 656e 6572 6963 5f63 6c6f 7564  d {generic_cloud
-000149f0: 7d20 7465 7374 732f 7465 7374 5f79 616d  } tests/test_yam
-00014a00: 6c73 2f6d 696e 696d 616c 2e79 616d 6c27  ls/minimal.yaml'
-00014a10: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00014a20: 736b 7920 6175 746f 7374 6f70 202d 7920  sky autostop -y 
-00014a30: 7b6e 616d 657d 202d 2d64 6f77 6e20 2d69  {name} --down -i
-00014a40: 2031 272c 0a20 2020 2020 2020 2020 2020   1',.           
-00014a50: 2023 2045 6e73 7572 6520 6175 746f 7374   # Ensure autost
-00014a60: 6f70 2069 7320 7365 742e 0a20 2020 2020  op is set..     
-00014a70: 2020 2020 2020 2066 2773 6b79 2073 7461         f'sky sta
-00014a80: 7475 7320 7c20 6772 6570 207b 6e61 6d65  tus | grep {name
-00014a90: 7d20 7c20 6772 6570 2022 316d 2028 646f  } | grep "1m (do
-00014aa0: 776e 2922 272c 0a20 2020 2020 2020 2020  wn)"',.         
-00014ab0: 2020 2023 2045 6e73 7572 6520 7468 6520     # Ensure the 
-00014ac0: 636c 7573 7465 7220 6973 206e 6f74 2074  cluster is not t
-00014ad0: 6572 6d69 6e61 7465 6420 6561 726c 792e  erminated early.
-00014ae0: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
-00014af0: 6565 7020 3430 272c 0a20 2020 2020 2020  eep 40',.       
-00014b00: 2020 2020 2066 2773 3d24 2873 6b79 2073       f's=$(sky s
-00014b10: 7461 7475 7320 7b6e 616d 657d 202d 2d72  tatus {name} --r
-00014b20: 6566 7265 7368 293b 2065 6368 6f20 2224  efresh); echo "$
-00014b30: 7322 3b20 6563 686f 3b20 6563 686f 3b20  s"; echo; echo; 
-00014b40: 6563 686f 2022 2473 2220 207c 2067 7265  echo "$s"  | gre
-00014b50: 7020 7b6e 616d 657d 207c 2067 7265 7020  p {name} | grep 
-00014b60: 5550 272c 0a20 2020 2020 2020 2020 2020  UP',.           
-00014b70: 2023 2045 6e73 7572 6520 7468 6520 636c   # Ensure the cl
-00014b80: 7573 7465 7220 6973 2074 6572 6d69 6e61  uster is termina
-00014b90: 7465 642e 0a20 2020 2020 2020 2020 2020  ted..           
-00014ba0: 2066 2773 6c65 6570 207b 6175 746f 646f   f'sleep {autodo
-00014bb0: 776e 5f74 696d 656f 7574 7d27 2c0a 2020  wn_timeout}',.  
-00014bc0: 2020 2020 2020 2020 2020 6627 733d 2428            f's=$(
-00014bd0: 534b 5950 494c 4f54 5f44 4542 5547 3d30  SKYPILOT_DEBUG=0
-00014be0: 2073 6b79 2073 7461 7475 7320 7b6e 616d   sky status {nam
-00014bf0: 657d 202d 2d72 6566 7265 7368 2920 2626  e} --refresh) &&
-00014c00: 2065 6368 6f20 2224 7322 2026 2620 7b7b   echo "$s" && {{
-00014c10: 2065 6368 6f20 2224 7322 207c 2067 7265   echo "$s" | gre
-00014c20: 7020 7b6e 616d 657d 207c 2067 7265 7020  p {name} | grep 
-00014c30: 2241 7574 6f64 6f77 6e65 6420 636c 7573  "Autodowned clus
-00014c40: 7465 725c 7c74 6572 6d69 6e61 7465 6420  ter\|terminated 
-00014c50: 6f6e 2074 6865 2063 6c6f 7564 223b 207d  on the cloud"; }
-00014c60: 7d20 7c7c 207b 7b20 6563 686f 2022 2473  } || {{ echo "$s
-00014c70: 2220 7c20 6772 6570 207b 6e61 6d65 7d20  " | grep {name} 
-00014c80: 2626 2065 7869 7420 3120 7c7c 2065 7869  && exit 1 || exi
-00014c90: 7420 303b 207d 7d27 2c0a 2020 2020 2020  t 0; }}',.      
-00014ca0: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
-00014cb0: 6368 202d 7920 2d64 202d 6320 7b6e 616d  ch -y -d -c {nam
-00014cc0: 657d 202d 2d63 6c6f 7564 207b 6765 6e65  e} --cloud {gene
-00014cd0: 7269 635f 636c 6f75 647d 202d 2d6e 756d  ric_cloud} --num
-00014ce0: 2d6e 6f64 6573 2032 202d 2d64 6f77 6e20  -nodes 2 --down 
-00014cf0: 7465 7374 732f 7465 7374 5f79 616d 6c73  tests/test_yamls
-00014d00: 2f6d 696e 696d 616c 2e79 616d 6c27 2c0a  /minimal.yaml',.
-00014d10: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00014d20: 7920 7374 6174 7573 207c 2067 7265 7020  y status | grep 
-00014d30: 7b6e 616d 657d 207c 2067 7265 7020 5550  {name} | grep UP
-00014d40: 272c 2020 2320 456e 7375 7265 2074 6865  ',  # Ensure the
-00014d50: 2063 6c75 7374 6572 2069 7320 5550 2e0a   cluster is UP..
-00014d60: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00014d70: 7920 6578 6563 207b 6e61 6d65 7d20 2d2d  y exec {name} --
-00014d80: 636c 6f75 6420 7b67 656e 6572 6963 5f63  cloud {generic_c
-00014d90: 6c6f 7564 7d20 7465 7374 732f 7465 7374  loud} tests/test
-00014da0: 5f79 616d 6c73 2f6d 696e 696d 616c 2e79  _yamls/minimal.y
-00014db0: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-00014dc0: 2020 6627 736b 7920 7374 6174 7573 207c    f'sky status |
-00014dd0: 2067 7265 7020 7b6e 616d 657d 207c 2067   grep {name} | g
-00014de0: 7265 7020 2231 6d20 2864 6f77 6e29 2227  rep "1m (down)"'
-00014df0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00014e00: 736c 6565 7020 7b61 7574 6f64 6f77 6e5f  sleep {autodown_
-00014e10: 7469 6d65 6f75 747d 272c 0a20 2020 2020  timeout}',.     
-00014e20: 2020 2020 2020 2023 2045 6e73 7572 6520         # Ensure 
-00014e30: 7468 6520 636c 7573 7465 7220 6973 2074  the cluster is t
-00014e40: 6572 6d69 6e61 7465 642e 0a20 2020 2020  erminated..     
-00014e50: 2020 2020 2020 2066 2773 3d24 2853 4b59         f's=$(SKY
-00014e60: 5049 4c4f 545f 4445 4255 473d 3020 736b  PILOT_DEBUG=0 sk
-00014e70: 7920 7374 6174 7573 207b 6e61 6d65 7d20  y status {name} 
-00014e80: 2d2d 7265 6672 6573 6829 2026 2620 6563  --refresh) && ec
-00014e90: 686f 2022 2473 2220 2626 207b 7b20 6563  ho "$s" && {{ ec
-00014ea0: 686f 2022 2473 2220 7c20 6772 6570 207b  ho "$s" | grep {
-00014eb0: 6e61 6d65 7d20 7c20 6772 6570 2022 4175  name} | grep "Au
-00014ec0: 746f 646f 776e 6564 2063 6c75 7374 6572  todowned cluster
-00014ed0: 5c7c 7465 726d 696e 6174 6564 206f 6e20  \|terminated on 
-00014ee0: 7468 6520 636c 6f75 6422 3b20 7d7d 207c  the cloud"; }} |
-00014ef0: 7c20 7b7b 2065 6368 6f20 2224 7322 207c  | {{ echo "$s" |
-00014f00: 2067 7265 7020 7b6e 616d 657d 2026 2620   grep {name} && 
-00014f10: 6578 6974 2031 207c 7c20 6578 6974 2030  exit 1 || exit 0
-00014f20: 3b20 7d7d 272c 0a20 2020 2020 2020 2020  ; }}',.         
-00014f30: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
-00014f40: 2d79 202d 6420 2d63 207b 6e61 6d65 7d20  -y -d -c {name} 
-00014f50: 2d2d 636c 6f75 6420 7b67 656e 6572 6963  --cloud {generic
-00014f60: 5f63 6c6f 7564 7d20 2d2d 6e75 6d2d 6e6f  _cloud} --num-no
-00014f70: 6465 7320 3220 2d2d 646f 776e 2074 6573  des 2 --down tes
-00014f80: 7473 2f74 6573 745f 7961 6d6c 732f 6d69  ts/test_yamls/mi
-00014f90: 6e69 6d61 6c2e 7961 6d6c 272c 0a20 2020  nimal.yaml',.   
-00014fa0: 2020 2020 2020 2020 2066 2773 6b79 2061           f'sky a
-00014fb0: 7574 6f73 746f 7020 2d79 207b 6e61 6d65  utostop -y {name
-00014fc0: 7d20 2d2d 6361 6e63 656c 272c 0a20 2020  } --cancel',.   
-00014fd0: 2020 2020 2020 2020 2066 2773 6c65 6570           f'sleep
-00014fe0: 207b 6175 746f 646f 776e 5f74 696d 656f   {autodown_timeo
-00014ff0: 7574 7d27 2c0a 2020 2020 2020 2020 2020  ut}',.          
-00015000: 2020 2320 456e 7375 7265 2074 6865 2063    # Ensure the c
-00015010: 6c75 7374 6572 2069 7320 7374 696c 6c20  luster is still 
-00015020: 5550 2e0a 2020 2020 2020 2020 2020 2020  UP..            
-00015030: 6627 733d 2428 534b 5950 494c 4f54 5f44  f's=$(SKYPILOT_D
-00015040: 4542 5547 3d30 2073 6b79 2073 7461 7475  EBUG=0 sky statu
-00015050: 7320 7b6e 616d 657d 202d 2d72 6566 7265  s {name} --refre
-00015060: 7368 2920 2626 2065 6368 6f20 2224 7322  sh) && echo "$s"
-00015070: 2026 2620 6563 686f 2022 2473 2220 7c20   && echo "$s" | 
-00015080: 6772 6570 207b 6e61 6d65 7d20 7c20 6772  grep {name} | gr
-00015090: 6570 2055 5027 2c0a 2020 2020 2020 2020  ep UP',.        
-000150a0: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
-000150b0: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
-000150c0: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
-000150d0: 743d 746f 7461 6c5f 7469 6d65 6f75 745f  t=total_timeout_
-000150e0: 6d69 6e75 7465 7320 2a20 3630 2c0a 2020  minutes * 60,.  
-000150f0: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
-00015100: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
-00015110: 7465 7374 2e6d 6172 6b2e 7363 700a 6465  test.mark.scp.de
-00015120: 6620 7465 7374 5f73 6370 5f61 7574 6f64  f test_scp_autod
-00015130: 6f77 6e28 293a 0a20 2020 206e 616d 6520  own():.    name 
-00015140: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
-00015150: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
-00015160: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
-00015170: 5343 505f 6175 746f 646f 776e 272c 0a20  SCP_autodown',. 
-00015180: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-00015190: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
-000151a0: 6820 2d79 202d 6420 2d63 207b 6e61 6d65  h -y -d -c {name
-000151b0: 7d20 7b53 4350 5f54 5950 457d 2074 6573  } {SCP_TYPE} tes
-000151c0: 7473 2f74 6573 745f 7961 6d6c 732f 6d69  ts/test_yamls/mi
-000151d0: 6e69 6d61 6c2e 7961 6d6c 272c 0a20 2020  nimal.yaml',.   
-000151e0: 2020 2020 2020 2020 2066 2773 6b79 2061           f'sky a
-000151f0: 7574 6f73 746f 7020 2d79 207b 6e61 6d65  utostop -y {name
-00015200: 7d20 2d2d 646f 776e 202d 6920 3127 2c0a  } --down -i 1',.
-00015210: 2020 2020 2020 2020 2020 2020 2320 456e              # En
-00015220: 7375 7265 2061 7574 6f73 746f 7020 6973  sure autostop is
-00015230: 2073 6574 2e0a 2020 2020 2020 2020 2020   set..          
-00015240: 2020 6627 736b 7920 7374 6174 7573 207c    f'sky status |
-00015250: 2067 7265 7020 7b6e 616d 657d 207c 2067   grep {name} | g
-00015260: 7265 7020 2231 6d20 2864 6f77 6e29 2227  rep "1m (down)"'
-00015270: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-00015280: 456e 7375 7265 2074 6865 2063 6c75 7374  Ensure the clust
-00015290: 6572 2069 7320 6e6f 7420 7465 726d 696e  er is not termin
-000152a0: 6174 6564 2065 6172 6c79 2e0a 2020 2020  ated early..    
-000152b0: 2020 2020 2020 2020 2773 6c65 6570 2034          'sleep 4
-000152c0: 3527 2c0a 2020 2020 2020 2020 2020 2020  5',.            
-000152d0: 6627 736b 7920 7374 6174 7573 202d 2d72  f'sky status --r
-000152e0: 6566 7265 7368 207c 2067 7265 7020 7b6e  efresh | grep {n
-000152f0: 616d 657d 207c 2067 7265 7020 5550 272c  ame} | grep UP',
-00015300: 0a20 2020 2020 2020 2020 2020 2023 2045  .            # E
-00015310: 6e73 7572 6520 7468 6520 636c 7573 7465  nsure the cluste
-00015320: 7220 6973 2074 6572 6d69 6e61 7465 642e  r is terminated.
-00015330: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
-00015340: 6565 7020 3230 3027 2c0a 2020 2020 2020  eep 200',.      
-00015350: 2020 2020 2020 6627 733d 2428 534b 5950        f's=$(SKYP
-00015360: 494c 4f54 5f44 4542 5547 3d30 2073 6b79  ILOT_DEBUG=0 sky
-00015370: 2073 7461 7475 7320 2d2d 7265 6672 6573   status --refres
-00015380: 6829 2026 2620 7072 696e 7466 2022 2473  h) && printf "$s
-00015390: 2220 2626 207b 7b20 6563 686f 2022 2473  " && {{ echo "$s
-000153a0: 2220 7c20 6772 6570 207b 6e61 6d65 7d20  " | grep {name} 
-000153b0: 7c20 6772 6570 2022 4175 746f 646f 776e  | grep "Autodown
-000153c0: 6564 2063 6c75 7374 6572 5c7c 7465 726d  ed cluster\|term
-000153d0: 696e 6174 6564 206f 6e20 7468 6520 636c  inated on the cl
-000153e0: 6f75 6422 3b20 7d7d 207c 7c20 7b7b 2065  oud"; }} || {{ e
-000153f0: 6368 6f20 2224 7322 207c 2067 7265 7020  cho "$s" | grep 
-00015400: 7b6e 616d 657d 2026 2620 6578 6974 2031  {name} && exit 1
-00015410: 207c 7c20 6578 6974 2030 3b20 7d7d 272c   || exit 0; }}',
-00015420: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00015430: 6b79 206c 6175 6e63 6820 2d79 202d 6420  ky launch -y -d 
-00015440: 2d63 207b 6e61 6d65 7d20 7b53 4350 5f54  -c {name} {SCP_T
-00015450: 5950 457d 202d 2d64 6f77 6e20 7465 7374  YPE} --down test
-00015460: 732f 7465 7374 5f79 616d 6c73 2f6d 696e  s/test_yamls/min
-00015470: 696d 616c 2e79 616d 6c27 2c0a 2020 2020  imal.yaml',.    
-00015480: 2020 2020 2020 2020 6627 736b 7920 7374          f'sky st
-00015490: 6174 7573 207c 2067 7265 7020 7b6e 616d  atus | grep {nam
-000154a0: 657d 207c 2067 7265 7020 5550 272c 2020  e} | grep UP',  
-000154b0: 2320 456e 7375 7265 2074 6865 2063 6c75  # Ensure the clu
-000154c0: 7374 6572 2069 7320 5550 2e0a 2020 2020  ster is UP..    
-000154d0: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
-000154e0: 6563 207b 6e61 6d65 7d20 7b53 4350 5f54  ec {name} {SCP_T
-000154f0: 5950 457d 2074 6573 7473 2f74 6573 745f  YPE} tests/test_
-00015500: 7961 6d6c 732f 6d69 6e69 6d61 6c2e 7961  yamls/minimal.ya
-00015510: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
-00015520: 2066 2773 6b79 2073 7461 7475 7320 7c20   f'sky status | 
-00015530: 6772 6570 207b 6e61 6d65 7d20 7c20 6772  grep {name} | gr
-00015540: 6570 2022 316d 2028 646f 776e 2922 272c  ep "1m (down)"',
-00015550: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
-00015560: 6565 7020 3230 3027 2c0a 2020 2020 2020  eep 200',.      
-00015570: 2020 2020 2020 2320 456e 7375 7265 2074        # Ensure t
-00015580: 6865 2063 6c75 7374 6572 2069 7320 7465  he cluster is te
-00015590: 726d 696e 6174 6564 2e0a 2020 2020 2020  rminated..      
-000155a0: 2020 2020 2020 6627 733d 2428 534b 5950        f's=$(SKYP
-000155b0: 494c 4f54 5f44 4542 5547 3d30 2073 6b79  ILOT_DEBUG=0 sky
-000155c0: 2073 7461 7475 7320 2d2d 7265 6672 6573   status --refres
-000155d0: 6829 2026 2620 7072 696e 7466 2022 2473  h) && printf "$s
-000155e0: 2220 2626 207b 7b20 6563 686f 2022 2473  " && {{ echo "$s
-000155f0: 2220 7c20 6772 6570 207b 6e61 6d65 7d20  " | grep {name} 
-00015600: 7c20 6772 6570 2022 4175 746f 646f 776e  | grep "Autodown
-00015610: 6564 2063 6c75 7374 6572 5c7c 7465 726d  ed cluster\|term
-00015620: 696e 6174 6564 206f 6e20 7468 6520 636c  inated on the cl
-00015630: 6f75 6422 3b20 7d7d 207c 7c20 7b7b 2065  oud"; }} || {{ e
-00015640: 6368 6f20 2224 7322 207c 2067 7265 7020  cho "$s" | grep 
-00015650: 7b6e 616d 657d 2026 2620 6578 6974 2031  {name} && exit 1
-00015660: 207c 7c20 6578 6974 2030 3b20 7d7d 272c   || exit 0; }}',
-00015670: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00015680: 6b79 206c 6175 6e63 6820 2d79 202d 6420  ky launch -y -d 
-00015690: 2d63 207b 6e61 6d65 7d20 7b53 4350 5f54  -c {name} {SCP_T
-000156a0: 5950 457d 202d 2d64 6f77 6e20 7465 7374  YPE} --down test
-000156b0: 732f 7465 7374 5f79 616d 6c73 2f6d 696e  s/test_yamls/min
-000156c0: 696d 616c 2e79 616d 6c27 2c0a 2020 2020  imal.yaml',.    
-000156d0: 2020 2020 2020 2020 6627 736b 7920 6175          f'sky au
-000156e0: 746f 7374 6f70 202d 7920 7b6e 616d 657d  tostop -y {name}
-000156f0: 202d 2d63 616e 6365 6c27 2c0a 2020 2020   --cancel',.    
-00015700: 2020 2020 2020 2020 2773 6c65 6570 2032          'sleep 2
-00015710: 3030 272c 0a20 2020 2020 2020 2020 2020  00',.           
-00015720: 2023 2045 6e73 7572 6520 7468 6520 636c   # Ensure the cl
-00015730: 7573 7465 7220 6973 2073 7469 6c6c 2055  uster is still U
-00015740: 502e 0a20 2020 2020 2020 2020 2020 2066  P..            f
-00015750: 2773 3d24 2853 4b59 5049 4c4f 545f 4445  's=$(SKYPILOT_DE
-00015760: 4255 473d 3020 736b 7920 7374 6174 7573  BUG=0 sky status
-00015770: 202d 2d72 6566 7265 7368 2920 2626 2070   --refresh) && p
-00015780: 7269 6e74 6620 2224 7322 2026 2620 6563  rintf "$s" && ec
-00015790: 686f 2022 2473 2220 7c20 6772 6570 207b  ho "$s" | grep {
-000157a0: 6e61 6d65 7d20 7c20 6772 6570 2055 5027  name} | grep UP'
-000157b0: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
-000157c0: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
-000157d0: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
-000157e0: 2020 2020 7469 6d65 6f75 743d 3235 202a      timeout=25 *
-000157f0: 2036 302c 0a20 2020 2029 0a20 2020 2072   60,.    ).    r
-00015800: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
-00015810: 290a 0a0a 6465 6620 5f67 6574 5f63 616e  )...def _get_can
-00015820: 6365 6c5f 7461 736b 5f77 6974 685f 636c  cel_task_with_cl
-00015830: 6f75 6428 6e61 6d65 2c20 636c 6f75 642c  oud(name, cloud,
-00015840: 2074 696d 656f 7574 3d31 3520 2a20 3630   timeout=15 * 60
-00015850: 293a 0a20 2020 2074 6573 7420 3d20 5465  ):.    test = Te
-00015860: 7374 280a 2020 2020 2020 2020 6627 7b63  st(.        f'{c
-00015870: 6c6f 7564 7d2d 6361 6e63 656c 2d74 6173  loud}-cancel-tas
-00015880: 6b27 2c0a 2020 2020 2020 2020 5b0a 2020  k',.        [.  
-00015890: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-000158a0: 6c61 756e 6368 202d 6320 7b6e 616d 657d  launch -c {name}
-000158b0: 2065 7861 6d70 6c65 732f 7265 736e 6574   examples/resnet
-000158c0: 5f61 7070 2e79 616d 6c20 2d2d 636c 6f75  _app.yaml --clou
-000158d0: 6420 7b63 6c6f 7564 7d20 2d79 202d 6427  d {cloud} -y -d'
-000158e0: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-000158f0: 5761 6974 2074 6865 2047 5055 2070 726f  Wait the GPU pro
-00015900: 6365 7373 2074 6f20 7374 6172 742e 0a20  cess to start.. 
-00015910: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
-00015920: 7020 3630 272c 0a20 2020 2020 2020 2020  p 60',.         
-00015930: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
-00015940: 616d 657d 2022 6e76 6964 6961 2d73 6d69  ame} "nvidia-smi
-00015950: 207c 2067 7265 7020 7079 7468 6f6e 2227   | grep python"'
-00015960: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00015970: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-00015980: 3220 2d2d 7374 6174 7573 272c 2020 2320  2 --status',  # 
-00015990: 456e 7375 7265 2074 6865 206a 6f62 2073  Ensure the job s
-000159a0: 7563 6365 6564 6564 2e0a 2020 2020 2020  ucceeded..      
-000159b0: 2020 2020 2020 6627 736b 7920 6361 6e63        f'sky canc
-000159c0: 656c 202d 7920 7b6e 616d 657d 2031 272c  el -y {name} 1',
-000159d0: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
-000159e0: 6565 7020 3630 272c 0a20 2020 2020 2020  eep 60',.       
-000159f0: 2020 2020 2023 2063 6865 636b 2069 6620       # check if 
-00015a00: 7468 6520 7079 7468 6f6e 206a 6f62 2069  the python job i
-00015a10: 7320 676f 6e65 2e0a 2020 2020 2020 2020  s gone..        
-00015a20: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
-00015a30: 6e61 6d65 7d20 2221 206e 7669 6469 612d  name} "! nvidia-
-00015a40: 736d 6920 7c20 6772 6570 2070 7974 686f  smi | grep pytho
-00015a50: 6e22 272c 0a20 2020 2020 2020 2020 2020  n"',.           
-00015a60: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
-00015a70: 657d 2033 202d 2d73 7461 7475 7327 2c20  e} 3 --status', 
-00015a80: 2023 2045 6e73 7572 6520 7468 6520 6a6f   # Ensure the jo
-00015a90: 6220 7375 6363 6565 6465 642e 0a20 2020  b succeeded..   
-00015aa0: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-00015ab0: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
-00015ac0: 616d 657d 272c 0a20 2020 2020 2020 2074  ame}',.        t
-00015ad0: 696d 656f 7574 3d74 696d 656f 7574 2c0a  imeout=timeout,.
-00015ae0: 2020 2020 290a 2020 2020 7265 7475 726e      ).    return
-00015af0: 2074 6573 740a 0a0a 2320 2d2d 2d2d 2d2d   test...# ------
-00015b00: 2d2d 2d2d 2054 6573 7469 6e67 2060 736b  ---- Testing `sk
-00015b10: 7920 6361 6e63 656c 6020 2d2d 2d2d 2d2d  y cancel` ------
-00015b20: 2d2d 2d2d 0a40 7079 7465 7374 2e6d 6172  ----.@pytest.mar
-00015b30: 6b2e 6177 730a 4070 7974 6573 742e 6d61  k.aws.@pytest.ma
-00015b40: 726b 2e73 6b69 7028 0a20 2020 2072 6561  rk.skip(.    rea
-00015b50: 736f 6e3d 2754 6865 2072 6573 6e65 745f  son='The resnet_
-00015b60: 6170 7020 6973 2066 6c61 6b79 2c20 6475  app is flaky, du
-00015b70: 6520 746f 2054 4620 6661 696c 696e 6720  e to TF failing 
-00015b80: 746f 2064 6574 6563 7420 4750 5573 2e27  to detect GPUs.'
-00015b90: 290a 6465 6620 7465 7374 5f63 616e 6365  ).def test_cance
-00015ba0: 6c5f 6177 7328 293a 0a20 2020 206e 616d  l_aws():.    nam
-00015bb0: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
-00015bc0: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
-00015bd0: 203d 205f 6765 745f 6361 6e63 656c 5f74   = _get_cancel_t
-00015be0: 6173 6b5f 7769 7468 5f63 6c6f 7564 286e  ask_with_cloud(n
-00015bf0: 616d 652c 2027 6177 7327 290a 2020 2020  ame, 'aws').    
-00015c00: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-00015c10: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
-00015c20: 6b2e 6763 700a 4070 7974 6573 742e 6d61  k.gcp.@pytest.ma
-00015c30: 726b 2e73 6b69 7028 0a20 2020 2072 6561  rk.skip(.    rea
-00015c40: 736f 6e3d 2754 6865 2072 6573 6e65 745f  son='The resnet_
-00015c50: 6170 7020 6973 2066 6c61 6b79 2c20 6475  app is flaky, du
-00015c60: 6520 746f 2054 4620 6661 696c 696e 6720  e to TF failing 
-00015c70: 746f 2064 6574 6563 7420 4750 5573 2e27  to detect GPUs.'
-00015c80: 290a 6465 6620 7465 7374 5f63 616e 6365  ).def test_cance
-00015c90: 6c5f 6763 7028 293a 0a20 2020 206e 616d  l_gcp():.    nam
-00015ca0: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
-00015cb0: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
-00015cc0: 203d 205f 6765 745f 6361 6e63 656c 5f74   = _get_cancel_t
-00015cd0: 6173 6b5f 7769 7468 5f63 6c6f 7564 286e  ask_with_cloud(n
-00015ce0: 616d 652c 2027 6763 7027 290a 2020 2020  ame, 'gcp').    
-00015cf0: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-00015d00: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
-00015d10: 6b2e 617a 7572 650a 4070 7974 6573 742e  k.azure.@pytest.
-00015d20: 6d61 726b 2e73 6b69 7028 0a20 2020 2072  mark.skip(.    r
-00015d30: 6561 736f 6e3d 2754 6865 2072 6573 6e65  eason='The resne
-00015d40: 745f 6170 7020 6973 2066 6c61 6b79 2c20  t_app is flaky, 
-00015d50: 6475 6520 746f 2054 4620 6661 696c 696e  due to TF failin
-00015d60: 6720 746f 2064 6574 6563 7420 4750 5573  g to detect GPUs
-00015d70: 2e27 290a 6465 6620 7465 7374 5f63 616e  .').def test_can
-00015d80: 6365 6c5f 617a 7572 6528 293a 0a20 2020  cel_azure():.   
-00015d90: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
-00015da0: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
-00015db0: 7465 7374 203d 205f 6765 745f 6361 6e63  test = _get_canc
-00015dc0: 656c 5f74 6173 6b5f 7769 7468 5f63 6c6f  el_task_with_clo
-00015dd0: 7564 286e 616d 652c 2027 617a 7572 6527  ud(name, 'azure'
-00015de0: 2c20 7469 6d65 6f75 743d 3330 202a 2036  , timeout=30 * 6
-00015df0: 3029 0a20 2020 2072 756e 5f6f 6e65 5f74  0).    run_one_t
-00015e00: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
-00015e10: 6573 742e 6d61 726b 2e6e 6f5f 6c61 6d62  est.mark.no_lamb
-00015e20: 6461 5f63 6c6f 7564 2020 2320 4c61 6d62  da_cloud  # Lamb
-00015e30: 6461 2043 6c6f 7564 2064 6f65 7320 6e6f  da Cloud does no
-00015e40: 7420 6861 7665 2056 3130 3020 6770 7573  t have V100 gpus
-00015e50: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
-00015e60: 5f69 626d 2020 2320 4942 4d20 636c 6f75  _ibm  # IBM clou
-00015e70: 6420 6375 7272 656e 746c 7920 646f 6573  d currently does
-00015e80: 6e27 7420 7072 6f76 6964 6520 7075 626c  n't provide publ
-00015e90: 6963 2069 6d61 6765 2077 6974 6820 4355  ic image with CU
-00015ea0: 4441 0a40 7079 7465 7374 2e6d 6172 6b2e  DA.@pytest.mark.
-00015eb0: 6e6f 5f70 6170 6572 7370 6163 6520 2023  no_paperspace  #
-00015ec0: 2050 6170 6572 7370 6163 6520 6861 7320   Paperspace has 
-00015ed0: 6067 6e6f 6d65 2d73 6865 6c6c 6020 6f6e  `gnome-shell` on
-00015ee0: 206e 7669 6469 612d 736d 690a 4070 7974   nvidia-smi.@pyt
-00015ef0: 6573 742e 6d61 726b 2e6e 6f5f 7363 7020  est.mark.no_scp 
-00015f00: 2023 2053 4350 2064 6f65 7320 6e6f 7420   # SCP does not 
-00015f10: 7375 7070 6f72 7420 6e75 6d5f 6e6f 6465  support num_node
-00015f20: 7320 3e20 3120 7965 740a 6465 6620 7465  s > 1 yet.def te
-00015f30: 7374 5f63 616e 6365 6c5f 7079 746f 7263  st_cancel_pytorc
-00015f40: 6828 6765 6e65 7269 635f 636c 6f75 643a  h(generic_cloud:
-00015f50: 2073 7472 293a 0a20 2020 206e 616d 6520   str):.    name 
-00015f60: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
-00015f70: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
-00015f80: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
-00015f90: 6361 6e63 656c 2d70 7974 6f72 6368 272c  cancel-pytorch',
-00015fa0: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
-00015fb0: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
-00015fc0: 6e63 6820 2d63 207b 6e61 6d65 7d20 2d2d  nch -c {name} --
-00015fd0: 636c 6f75 6420 7b67 656e 6572 6963 5f63  cloud {generic_c
-00015fe0: 6c6f 7564 7d20 6578 616d 706c 6573 2f72  loud} examples/r
-00015ff0: 6573 6e65 745f 6469 7374 7269 6275 7465  esnet_distribute
-00016000: 645f 746f 7263 682e 7961 6d6c 202d 7920  d_torch.yaml -y 
-00016010: 2d64 272c 0a20 2020 2020 2020 2020 2020  -d',.           
-00016020: 2023 2057 6169 7420 7468 6520 4750 5520   # Wait the GPU 
-00016030: 7072 6f63 6573 7320 746f 2073 7461 7274  process to start
-00016040: 2e0a 2020 2020 2020 2020 2020 2020 2773  ..            's
-00016050: 6c65 6570 2039 3027 2c0a 2020 2020 2020  leep 90',.      
-00016060: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
-00016070: 207b 6e61 6d65 7d20 2228 6e76 6964 6961   {name} "(nvidia
-00016080: 2d73 6d69 207c 2067 7265 7020 7079 7468  -smi | grep pyth
-00016090: 6f6e 2920 7c7c 2027 0a20 2020 2020 2020  on) || '.       
-000160a0: 2020 2020 2023 2057 6865 6e20 7275 6e20       # When run 
-000160b0: 696e 7369 6465 2063 6f6e 7461 696e 6572  inside container
-000160c0: 2f6b 3873 2c20 6e76 6964 6961 2d73 6d69  /k8s, nvidia-smi
-000160d0: 2063 616e 6e6f 7420 7368 6f77 2070 726f   cannot show pro
-000160e0: 6365 7373 2069 6473 2e0a 2020 2020 2020  cess ids..      
-000160f0: 2020 2020 2020 2320 5365 6520 6874 7470        # See http
-00016100: 733a 2f2f 6769 7468 7562 2e63 6f6d 2f4e  s://github.com/N
-00016110: 5649 4449 412f 6e76 6964 6961 2d64 6f63  VIDIA/nvidia-doc
-00016120: 6b65 722f 6973 7375 6573 2f31 3739 0a20  ker/issues/179. 
-00016130: 2020 2020 2020 2020 2020 2023 2054 6f20             # To 
-00016140: 776f 726b 2061 726f 756e 642c 2077 6520  work around, we 
-00016150: 6368 6563 6b20 6966 2047 5055 2075 7469  check if GPU uti
-00016160: 6c69 7a61 7469 6f6e 2069 7320 6772 6561  lization is grea
-00016170: 7465 7220 7468 616e 2030 2e0a 2020 2020  ter than 0..    
-00016180: 2020 2020 2020 2020 6627 5b20 5c24 286e          f'[ \$(n
-00016190: 7669 6469 612d 736d 6920 2d2d 7175 6572  vidia-smi --quer
-000161a0: 792d 6770 753d 7574 696c 697a 6174 696f  y-gpu=utilizatio
-000161b0: 6e2e 6770 7520 2d2d 666f 726d 6174 3d63  n.gpu --format=c
-000161c0: 7376 2c6e 6f68 6561 6465 722c 6e6f 756e  sv,noheader,noun
-000161d0: 6974 7329 202d 6774 2030 205d 2227 2c0a  its) -gt 0 ]"',.
-000161e0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-000161f0: 7920 6c6f 6773 207b 6e61 6d65 7d20 3220  y logs {name} 2 
-00016200: 2d2d 7374 6174 7573 272c 2020 2320 456e  --status',  # En
-00016210: 7375 7265 2074 6865 206a 6f62 2073 7563  sure the job suc
-00016220: 6365 6564 6564 2e0a 2020 2020 2020 2020  ceeded..        
-00016230: 2020 2020 6627 736b 7920 6361 6e63 656c      f'sky cancel
-00016240: 202d 7920 7b6e 616d 657d 2031 272c 0a20   -y {name} 1',. 
-00016250: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
-00016260: 7020 3630 272c 0a20 2020 2020 2020 2020  p 60',.         
-00016270: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
-00016280: 616d 657d 2022 286e 7669 6469 612d 736d  ame} "(nvidia-sm
-00016290: 6920 7c20 6772 6570 205c 274e 6f20 7275  i | grep \'No ru
-000162a0: 6e6e 696e 6720 7072 6f63 6573 735c 2729  nning process\')
-000162b0: 207c 7c20 270a 2020 2020 2020 2020 2020   || '.          
-000162c0: 2020 2320 456e 7375 7265 2058 6f72 6720    # Ensure Xorg 
-000162d0: 6973 2074 6865 206f 6e6c 7920 7072 6f63  is the only proc
-000162e0: 6573 7320 7275 6e6e 696e 672e 0a20 2020  ess running..   
-000162f0: 2020 2020 2020 2020 2027 5b20 5c24 286e           '[ \$(n
-00016300: 7669 6469 612d 736d 6920 7c20 6772 6570  vidia-smi | grep
-00016310: 202d 4120 3130 2050 726f 6365 7373 6573   -A 10 Processes
-00016320: 207c 2067 7265 7020 2d41 2031 3020 3d3d   | grep -A 10 ==
-00016330: 3d20 7c20 6772 6570 202d 7620 586f 7267  = | grep -v Xorg
-00016340: 2920 2d65 7120 3220 5d22 272c 0a20 2020  ) -eq 2 ]"',.   
-00016350: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00016360: 6f67 7320 7b6e 616d 657d 2033 202d 2d73  ogs {name} 3 --s
-00016370: 7461 7475 7327 2c20 2023 2045 6e73 7572  tatus',  # Ensur
-00016380: 6520 7468 6520 6a6f 6220 7375 6363 6565  e the job succee
-00016390: 6465 642e 0a20 2020 2020 2020 205d 2c0a  ded..        ],.
-000163a0: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
-000163b0: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
-000163c0: 2020 2020 2020 2074 696d 656f 7574 3d32         timeout=2
-000163d0: 3020 2a20 3630 2c0a 2020 2020 290a 2020  0 * 60,.    ).  
-000163e0: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
-000163f0: 6573 7429 0a0a 0a23 2063 616e 2774 2075  est)...# can't u
-00016400: 7365 2060 5f67 6574 5f63 616e 6365 6c5f  se `_get_cancel_
-00016410: 7461 736b 5f77 6974 685f 636c 6f75 6428  task_with_cloud(
-00016420: 2960 2c20 6173 2063 6f6d 6d61 6e64 2060  )`, as command `
-00016430: 6e76 6964 6961 2d73 6d69 600a 2320 7265  nvidia-smi`.# re
-00016440: 7175 6972 6573 2061 2043 5544 4120 7075  quires a CUDA pu
-00016450: 626c 6963 2069 6d61 6765 2c20 7768 6963  blic image, whic
-00016460: 6820 4942 4d20 646f 6573 6e27 7420 6f66  h IBM doesn't of
-00016470: 6665 720a 4070 7974 6573 742e 6d61 726b  fer.@pytest.mark
-00016480: 2e69 626d 0a64 6566 2074 6573 745f 6361  .ibm.def test_ca
-00016490: 6e63 656c 5f69 626d 2829 3a0a 2020 2020  ncel_ibm():.    
-000164a0: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
-000164b0: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
-000164c0: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
-000164d0: 2020 2020 2769 626d 2d63 616e 6365 6c2d      'ibm-cancel-
-000164e0: 7461 736b 272c 0a20 2020 2020 2020 205b  task',.        [
-000164f0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00016500: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
-00016510: 7b6e 616d 657d 202d 2d63 6c6f 7564 2069  {name} --cloud i
-00016520: 626d 2065 7861 6d70 6c65 732f 6d69 6e69  bm examples/mini
-00016530: 6d61 6c2e 7961 6d6c 272c 0a20 2020 2020  mal.yaml',.     
-00016540: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
-00016550: 6320 7b6e 616d 657d 202d 6e20 7b6e 616d  c {name} -n {nam
-00016560: 657d 2d31 202d 6420 2022 7768 696c 6520  e}-1 -d  "while 
-00016570: 7472 7565 3b20 646f 2065 6368 6f20 5c27  true; do echo \'
-00016580: 4865 6c6c 6f20 536b 7950 696c 6f74 5c27  Hello SkyPilot\'
-00016590: 3b20 736c 6565 7020 323b 2064 6f6e 6522  ; sleep 2; done"
-000165a0: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
-000165b0: 736c 6565 7020 3230 272c 0a20 2020 2020  sleep 20',.     
-000165c0: 2020 2020 2020 2066 2773 6b79 2071 7565         f'sky que
-000165d0: 7565 207b 6e61 6d65 7d20 7c20 6772 6570  ue {name} | grep
-000165e0: 207b 6e61 6d65 7d2d 3120 7c20 6772 6570   {name}-1 | grep
-000165f0: 2052 554e 4e49 4e47 272c 0a20 2020 2020   RUNNING',.     
-00016600: 2020 2020 2020 2066 2773 6b79 2063 616e         f'sky can
-00016610: 6365 6c20 2d79 207b 6e61 6d65 7d20 3227  cel -y {name} 2'
-00016620: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00016630: 736c 6565 7020 3527 2c0a 2020 2020 2020  sleep 5',.      
-00016640: 2020 2020 2020 6627 736b 7920 7175 6575        f'sky queu
-00016650: 6520 7b6e 616d 657d 207c 2067 7265 7020  e {name} | grep 
-00016660: 7b6e 616d 657d 2d31 207c 2067 7265 7020  {name}-1 | grep 
-00016670: 4341 4e43 454c 4c45 4427 2c0a 2020 2020  CANCELLED',.    
-00016680: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
-00016690: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
-000166a0: 6d65 7d27 2c0a 2020 2020 290a 2020 2020  me}',.    ).    
-000166b0: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-000166c0: 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d  t)...# ---------
-000166d0: 2d20 5465 7374 696e 6720 7573 652d 7370  - Testing use-sp
-000166e0: 6f74 206f 7074 696f 6e20 2d2d 2d2d 2d2d  ot option ------
-000166f0: 2d2d 2d2d 0a40 7079 7465 7374 2e6d 6172  ----.@pytest.mar
-00016700: 6b2e 6e6f 5f66 6c75 6964 7374 6163 6b20  k.no_fluidstack 
-00016710: 2023 2046 6c75 6964 5374 6163 6b20 646f   # FluidStack do
-00016720: 6573 206e 6f74 2073 7570 706f 7274 2073  es not support s
-00016730: 706f 7420 696e 7374 616e 6365 730a 4070  pot instances.@p
-00016740: 7974 6573 742e 6d61 726b 2e6e 6f5f 617a  ytest.mark.no_az
-00016750: 7572 6520 2023 2041 7a75 7265 2064 6f65  ure  # Azure doe
-00016760: 7320 6e6f 7420 7375 7070 6f72 7420 7370  s not support sp
-00016770: 6f74 2069 6e73 7461 6e63 6573 0a40 7079  ot instances.@py
-00016780: 7465 7374 2e6d 6172 6b2e 6e6f 5f6c 616d  test.mark.no_lam
-00016790: 6264 615f 636c 6f75 6420 2023 204c 616d  bda_cloud  # Lam
-000167a0: 6264 6120 436c 6f75 6420 646f 6573 206e  bda Cloud does n
-000167b0: 6f74 2073 7570 706f 7274 2073 706f 7420  ot support spot 
-000167c0: 696e 7374 616e 6365 730a 4070 7974 6573  instances.@pytes
-000167d0: 742e 6d61 726b 2e6e 6f5f 7061 7065 7273  t.mark.no_papers
-000167e0: 7061 6365 2020 2320 5061 7065 7273 7061  pace  # Paperspa
-000167f0: 6365 2064 6f65 7320 6e6f 7420 7375 7070  ce does not supp
-00016800: 6f72 7420 7370 6f74 2069 6e73 7461 6e63  ort spot instanc
-00016810: 6573 0a40 7079 7465 7374 2e6d 6172 6b2e  es.@pytest.mark.
-00016820: 6e6f 5f69 626d 2020 2320 4942 4d20 436c  no_ibm  # IBM Cl
-00016830: 6f75 6420 646f 6573 206e 6f74 2073 7570  oud does not sup
-00016840: 706f 7274 2073 706f 7420 696e 7374 616e  port spot instan
-00016850: 6365 730a 4070 7974 6573 742e 6d61 726b  ces.@pytest.mark
-00016860: 2e6e 6f5f 7363 7020 2023 2053 4350 2064  .no_scp  # SCP d
+000021d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000021e0: 7a6f 6e65 3d4e 6f6e 6529 0a0a 2020 2020  zone=None)..    
+000021f0: 6f72 6967 696e 616c 5f72 6573 6f75 7263  original_resourc
+00002200: 6573 203d 2073 6b79 2e52 6573 6f75 7263  es = sky.Resourc
+00002210: 6573 2863 6c6f 7564 3d73 6b79 2e47 4350  es(cloud=sky.GCP
+00002220: 2829 2c0a 2020 2020 2020 2020 2020 2020  (),.            
+00002230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002240: 2020 2020 2020 2020 2020 2069 6e73 7461             insta
+00002250: 6e63 655f 7479 7065 3d27 6132 2d75 6c74  nce_type='a2-ult
+00002260: 7261 6770 752d 3167 272c 0a20 2020 2020  ragpu-1g',.     
+00002270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002290: 2020 6163 6365 6c65 7261 746f 7273 3d7b    accelerators={
+000022a0: 2741 3130 302d 3830 4742 273a 2031 7d2c  'A100-80GB': 1},
+000022b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000022c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000022d0: 2020 2020 2020 2020 7573 655f 7370 6f74          use_spot
+000022e0: 3d54 7275 6529 0a0a 2020 2020 2320 4669  =True)..    # Fi
+000022f0: 6c74 6572 2074 6865 2072 6567 696f 6e73  lter the regions
+00002300: 2077 6974 6820 7072 6f78 7920 636f 6d6d   with proxy comm
+00002310: 616e 6420 696e 207e 2f2e 736b 792f 636f  and in ~/.sky/co
+00002320: 6e66 6967 2e79 616d 6c2e 0a20 2020 2066  nfig.yaml..    f
+00002330: 696c 7465 7265 645f 7265 6769 6f6e 7320  iltered_regions 
+00002340: 3d20 6f72 6967 696e 616c 5f72 6573 6f75  = original_resou
+00002350: 7263 6573 2e67 6574 5f76 616c 6964 5f72  rces.get_valid_r
+00002360: 6567 696f 6e73 5f66 6f72 5f6c 6175 6e63  egions_for_launc
+00002370: 6861 626c 6528 290a 2020 2020 6361 6e64  hable().    cand
+00002380: 6964 6174 655f 7265 6769 6f6e 7320 3d20  idate_regions = 
+00002390: 5b0a 2020 2020 2020 2020 7265 6769 6f6e  [.        region
+000023a0: 2066 6f72 2072 6567 696f 6e20 696e 2063   for region in c
+000023b0: 616e 6469 6461 7465 5f72 6567 696f 6e73  andidate_regions
+000023c0: 0a20 2020 2020 2020 2069 6620 7265 6769  .        if regi
+000023d0: 6f6e 2e6e 616d 6520 696e 2066 696c 7465  on.name in filte
+000023e0: 7265 645f 7265 6769 6f6e 730a 2020 2020  red_regions.    
+000023f0: 5d0a 0a20 2020 2066 6f72 2072 6567 696f  ]..    for regio
+00002400: 6e20 696e 2063 616e 6469 6461 7465 5f72  n in candidate_r
+00002410: 6567 696f 6e73 3a0a 2020 2020 2020 2020  egions:.        
+00002420: 6966 206e 6f74 2047 4350 2e63 6865 636b  if not GCP.check
+00002430: 5f71 756f 7461 5f61 7661 696c 6162 6c65  _quota_available
+00002440: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00002450: 2020 6f72 6967 696e 616c 5f72 6573 6f75    original_resou
+00002460: 7263 6573 2e63 6f70 7928 7265 6769 6f6e  rces.copy(region
+00002470: 3d72 6567 696f 6e2e 6e61 6d65 2929 3a0a  =region.name)):.
+00002480: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00002490: 726e 2072 6567 696f 6e2e 6e61 6d65 0a0a  rn region.name..
+000024a0: 2020 2020 7265 7475 726e 204e 6f6e 650a      return None.
+000024b0: 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2044  ..# ---------- D
+000024c0: 7279 2072 756e 3a20 3220 5461 736b 7320  ry run: 2 Tasks 
+000024d0: 696e 2061 2063 6861 696e 2e20 2d2d 2d2d  in a chain. ----
+000024e0: 2d2d 2d2d 2d2d 0a40 7079 7465 7374 2e6d  ------.@pytest.m
+000024f0: 6172 6b2e 6e6f 5f66 6c75 6964 7374 6163  ark.no_fluidstac
+00002500: 6b20 2023 7265 7175 6972 6573 2047 4350  k  #requires GCP
+00002510: 2061 6e64 2041 5753 2073 6574 2075 700a   and AWS set up.
+00002520: 6465 6620 7465 7374 5f65 7861 6d70 6c65  def test_example
+00002530: 5f61 7070 2829 3a0a 2020 2020 7465 7374  _app():.    test
+00002540: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
+00002550: 2027 6578 616d 706c 655f 6170 7027 2c0a   'example_app',.
+00002560: 2020 2020 2020 2020 5b27 7079 7468 6f6e          ['python
+00002570: 2065 7861 6d70 6c65 732f 6578 616d 706c   examples/exampl
+00002580: 655f 6170 702e 7079 275d 2c0a 2020 2020  e_app.py'],.    
+00002590: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
+000025a0: 7374 2874 6573 7429 0a0a 0a23 202d 2d2d  st(test)...# ---
+000025b0: 2d2d 2d2d 2d2d 2d20 4120 6d69 6e69 6d61  ------- A minima
+000025c0: 6c20 7461 736b 202d 2d2d 2d2d 2d2d 2d2d  l task ---------
+000025d0: 2d0a 6465 6620 7465 7374 5f6d 696e 696d  -.def test_minim
+000025e0: 616c 2867 656e 6572 6963 5f63 6c6f 7564  al(generic_cloud
+000025f0: 3a20 7374 7229 3a0a 2020 2020 6e61 6d65  : str):.    name
+00002600: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
+00002610: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
+00002620: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+00002630: 276d 696e 696d 616c 272c 0a20 2020 2020  'minimal',.     
+00002640: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+00002650: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
+00002660: 202d 6320 7b6e 616d 657d 202d 2d63 6c6f   -c {name} --clo
+00002670: 7564 207b 6765 6e65 7269 635f 636c 6f75  ud {generic_clou
+00002680: 647d 2074 6573 7473 2f74 6573 745f 7961  d} tests/test_ya
+00002690: 6d6c 732f 6d69 6e69 6d61 6c2e 7961 6d6c  mls/minimal.yaml
+000026a0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+000026b0: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
+000026c0: 2031 202d 2d73 7461 7475 7327 2c0a 2020   1 --status',.  
+000026d0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+000026e0: 6c6f 6773 207b 6e61 6d65 7d20 2d2d 7374  logs {name} --st
+000026f0: 6174 7573 207c 2067 7265 7020 224a 6f62  atus | grep "Job
+00002700: 2031 3a20 5355 4343 4545 4445 4422 272c   1: SUCCEEDED"',
+00002710: 2020 2320 4571 7569 7661 6c65 6e74 2e0a    # Equivalent..
+00002720: 2020 2020 2020 2020 2020 2020 2320 4368              # Ch
+00002730: 6563 6b20 7468 6520 6c6f 6773 2064 6f77  eck the logs dow
+00002740: 6e6c 6f61 6469 6e67 0a20 2020 2020 2020  nloading.       
+00002750: 2020 2020 2066 276c 6f67 5f70 6174 683d       f'log_path=
+00002760: 2428 736b 7920 6c6f 6773 207b 6e61 6d65  $(sky logs {name
+00002770: 7d20 3120 2d2d 7379 6e63 2d64 6f77 6e20  } 1 --sync-down 
+00002780: 7c20 6772 6570 2022 4a6f 6220 3120 6c6f  | grep "Job 1 lo
+00002790: 6773 3a22 207c 2073 6564 202d 4520 2273  gs:" | sed -E "s
+000027a0: 2f5e 2e2a 4a6f 6220 3120 6c6f 6773 3a20  /^.*Job 1 logs: 
+000027b0: 282e 2a29 5c5c 7831 625c 5c5b 306d 2f5c  (.*)\\x1b\\[0m/\
+000027c0: 5c31 2f67 2229 2026 2620 6563 686f 2022  \1/g") && echo "
+000027d0: 246c 6f67 5f70 6174 6822 2026 2620 7465  $log_path" && te
+000027e0: 7374 202d 6620 246c 6f67 5f70 6174 682f  st -f $log_path/
+000027f0: 7275 6e2e 6c6f 6727 2c0a 2020 2020 2020  run.log',.      
+00002800: 2020 2020 2020 2320 456e 7375 7265 2074        # Ensure t
+00002810: 6865 2072 6179 6c65 7420 7072 6f63 6573  he raylet proces
+00002820: 7320 6861 7320 7468 6520 636f 7272 6563  s has the correc
+00002830: 7420 6669 6c65 2064 6573 6372 6970 746f  t file descripto
+00002840: 7220 6c69 6d69 742e 0a20 2020 2020 2020  r limit..       
+00002850: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
+00002860: 7b6e 616d 657d 2022 7072 6c69 6d69 7420  {name} "prlimit 
+00002870: 2d6e 202d 2d70 6964 3d5c 2428 7067 7265  -n --pid=\$(pgre
+00002880: 7020 2d66 205c 2772 6179 6c65 742f 7261  p -f \'raylet/ra
+00002890: 796c 6574 202d 2d72 6179 6c65 745f 736f  ylet --raylet_so
+000028a0: 636b 6574 5f6e 616d 655c 2729 207c 2067  cket_name\') | g
+000028b0: 7265 7020 5c27 225c 2731 3034 3835 3736  rep \'"\'1048576
+000028c0: 2031 3034 3835 3736 5c27 225c 2722 272c   1048576\'"\'"',
+000028d0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+000028e0: 6b79 206c 6f67 7320 7b6e 616d 657d 2032  ky logs {name} 2
+000028f0: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
+00002900: 6e73 7572 6520 7468 6520 6a6f 6220 7375  nsure the job su
+00002910: 6363 6565 6465 642e 0a20 2020 2020 2020  cceeded..       
+00002920: 2020 2020 2023 2043 6865 636b 2074 6865       # Check the
+00002930: 2063 6c75 7374 6572 2069 6e66 6f0a 2020   cluster info.  
+00002940: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00002950: 6578 6563 207b 6e61 6d65 7d20 5c27 6563  exec {name} \'ec
+00002960: 686f 2022 2453 4b59 5049 4c4f 545f 434c  ho "$SKYPILOT_CL
+00002970: 5553 5445 525f 494e 464f 2220 7c20 6a71  USTER_INFO" | jq
+00002980: 202e 636c 7573 7465 725f 6e61 6d65 207c   .cluster_name |
+00002990: 2067 7265 7020 7b6e 616d 657d 5c27 272c   grep {name}\'',
+000029a0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+000029b0: 6b79 206c 6f67 7320 7b6e 616d 657d 2033  ky logs {name} 3
+000029c0: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
+000029d0: 6e73 7572 6520 7468 6520 6a6f 6220 7375  nsure the job su
+000029e0: 6363 6565 6465 642e 0a20 2020 2020 2020  cceeded..       
+000029f0: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
+00002a00: 7b6e 616d 657d 205c 2765 6368 6f20 2224  {name} \'echo "$
+00002a10: 534b 5950 494c 4f54 5f43 4c55 5354 4552  SKYPILOT_CLUSTER
+00002a20: 5f49 4e46 4f22 207c 206a 7120 2e63 6c6f  _INFO" | jq .clo
+00002a30: 7564 207c 2067 7265 7020 2d69 207b 6765  ud | grep -i {ge
+00002a40: 6e65 7269 635f 636c 6f75 647d 5c27 272c  neric_cloud}\'',
+00002a50: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00002a60: 6b79 206c 6f67 7320 7b6e 616d 657d 2034  ky logs {name} 4
+00002a70: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
+00002a80: 6e73 7572 6520 7468 6520 6a6f 6220 7375  nsure the job su
+00002a90: 6363 6565 6465 642e 0a20 2020 2020 2020  cceeded..       
+00002aa0: 205d 2c0a 2020 2020 2020 2020 6627 736b   ],.        f'sk
+00002ab0: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
+00002ac0: 272c 0a20 2020 2020 2020 205f 6765 745f  ',.        _get_
+00002ad0: 7469 6d65 6f75 7428 6765 6e65 7269 635f  timeout(generic_
+00002ae0: 636c 6f75 6429 2c0a 2020 2020 290a 2020  cloud),.    ).  
+00002af0: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+00002b00: 6573 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d  est)...# -------
+00002b10: 2d2d 2d20 5465 7374 2072 6567 696f 6e20  --- Test region 
+00002b20: 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465  ----------.@pyte
+00002b30: 7374 2e6d 6172 6b2e 6177 730a 6465 6620  st.mark.aws.def 
+00002b40: 7465 7374 5f61 7773 5f72 6567 696f 6e28  test_aws_region(
+00002b50: 293a 0a20 2020 206e 616d 6520 3d20 5f67  ):.    name = _g
+00002b60: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
+00002b70: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
+00002b80: 7428 0a20 2020 2020 2020 2027 6177 735f  t(.        'aws_
+00002b90: 7265 6769 6f6e 272c 0a20 2020 2020 2020  region',.       
+00002ba0: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
+00002bb0: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
+00002bc0: 6320 7b6e 616d 657d 202d 2d72 6567 696f  c {name} --regio
+00002bd0: 6e20 7573 2d65 6173 742d 3220 6578 616d  n us-east-2 exam
+00002be0: 706c 6573 2f6d 696e 696d 616c 2e79 616d  ples/minimal.yam
+00002bf0: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+00002c00: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
+00002c10: 7d20 6578 616d 706c 6573 2f6d 696e 696d  } examples/minim
+00002c20: 616c 2e79 616d 6c27 2c0a 2020 2020 2020  al.yaml',.      
+00002c30: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
+00002c40: 207b 6e61 6d65 7d20 3120 2d2d 7374 6174   {name} 1 --stat
+00002c50: 7573 272c 2020 2320 456e 7375 7265 2074  us',  # Ensure t
+00002c60: 6865 206a 6f62 2073 7563 6365 6564 6564  he job succeeded
+00002c70: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
+00002c80: 736b 7920 7374 6174 7573 202d 2d61 6c6c  sky status --all
+00002c90: 207c 2067 7265 7020 7b6e 616d 657d 207c   | grep {name} |
+00002ca0: 2067 7265 7020 7573 2d65 6173 742d 3227   grep us-east-2'
+00002cb0: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
+00002cc0: 7265 6769 6f6e 2069 7320 636f 7272 6563  region is correc
+00002cd0: 742e 0a20 2020 2020 2020 2020 2020 2066  t..            f
+00002ce0: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+00002cf0: 205c 2765 6368 6f20 2453 4b59 5049 4c4f   \'echo $SKYPILO
+00002d00: 545f 434c 5553 5445 525f 494e 464f 207c  T_CLUSTER_INFO |
+00002d10: 206a 7120 2e72 6567 696f 6e20 7c20 6772   jq .region | gr
+00002d20: 6570 2075 732d 6561 7374 2d32 5c27 272c  ep us-east-2\'',
+00002d30: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00002d40: 6b79 206c 6f67 7320 7b6e 616d 657d 2032  ky logs {name} 2
+00002d50: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
+00002d60: 6e73 7572 6520 7468 6520 6a6f 6220 7375  nsure the job su
+00002d70: 6363 6565 6465 642e 0a20 2020 2020 2020  cceeded..       
+00002d80: 205d 2c0a 2020 2020 2020 2020 6627 736b   ],.        f'sk
+00002d90: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
+00002da0: 272c 0a20 2020 2029 0a20 2020 2072 756e  ',.    ).    run
+00002db0: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
+00002dc0: 0a0a 4070 7974 6573 742e 6d61 726b 2e67  ..@pytest.mark.g
+00002dd0: 6370 0a64 6566 2074 6573 745f 6763 705f  cp.def test_gcp_
+00002de0: 7265 6769 6f6e 5f61 6e64 5f73 6572 7669  region_and_servi
+00002df0: 6365 5f61 6363 6f75 6e74 2829 3a0a 2020  ce_account():.  
+00002e00: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
+00002e10: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
+00002e20: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+00002e30: 2020 2020 2020 2767 6370 5f72 6567 696f        'gcp_regio
+00002e40: 6e27 2c0a 2020 2020 2020 2020 5b0a 2020  n',.        [.  
+00002e50: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00002e60: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
+00002e70: 6d65 7d20 2d2d 7265 6769 6f6e 2075 732d  me} --region us-
+00002e80: 6365 6e74 7261 6c31 202d 2d63 6c6f 7564  central1 --cloud
+00002e90: 2067 6370 2074 6573 7473 2f74 6573 745f   gcp tests/test_
+00002ea0: 7961 6d6c 732f 6d69 6e69 6d61 6c2e 7961  yamls/minimal.ya
+00002eb0: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
+00002ec0: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
+00002ed0: 657d 2074 6573 7473 2f74 6573 745f 7961  e} tests/test_ya
+00002ee0: 6d6c 732f 6d69 6e69 6d61 6c2e 7961 6d6c  mls/minimal.yaml
+00002ef0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00002f00: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
+00002f10: 2031 202d 2d73 7461 7475 7327 2c20 2023   1 --status',  #
+00002f20: 2045 6e73 7572 6520 7468 6520 6a6f 6220   Ensure the job 
+00002f30: 7375 6363 6565 6465 642e 0a20 2020 2020  succeeded..     
+00002f40: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
+00002f50: 6320 7b6e 616d 657d 205c 2763 7572 6c20  c {name} \'curl 
+00002f60: 2d48 2022 4d65 7461 6461 7461 2d46 6c61  -H "Metadata-Fla
+00002f70: 766f 723a 2047 6f6f 676c 6522 2022 6874  vor: Google" "ht
+00002f80: 7470 3a2f 2f6d 6574 6164 6174 612e 676f  tp://metadata.go
+00002f90: 6f67 6c65 2e69 6e74 6572 6e61 6c2f 636f  ogle.internal/co
+00002fa0: 6d70 7574 654d 6574 6164 6174 612f 7631  mputeMetadata/v1
+00002fb0: 2f69 6e73 7461 6e63 652f 7365 7276 6963  /instance/servic
+00002fc0: 652d 6163 636f 756e 7473 2f64 6566 6175  e-accounts/defau
+00002fd0: 6c74 2f69 6465 6e74 6974 793f 666f 726d  lt/identity?form
+00002fe0: 6174 3d73 7461 6e64 6172 6426 6175 6469  at=standard&audi
+00002ff0: 656e 6365 3d67 6370 225c 2727 2c0a 2020  ence=gcp"\'',.  
+00003000: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00003010: 6c6f 6773 207b 6e61 6d65 7d20 3220 2d2d  logs {name} 2 --
+00003020: 7374 6174 7573 272c 2020 2320 456e 7375  status',  # Ensu
+00003030: 7265 2074 6865 206a 6f62 2073 7563 6365  re the job succe
+00003040: 6564 6564 2e0a 2020 2020 2020 2020 2020  eded..          
+00003050: 2020 6627 736b 7920 7374 6174 7573 202d    f'sky status -
+00003060: 2d61 6c6c 207c 2067 7265 7020 7b6e 616d  -all | grep {nam
+00003070: 657d 207c 2067 7265 7020 7573 2d63 656e  e} | grep us-cen
+00003080: 7472 616c 3127 2c20 2023 2045 6e73 7572  tral1',  # Ensur
+00003090: 6520 7468 6520 7265 6769 6f6e 2069 7320  e the region is 
+000030a0: 636f 7272 6563 742e 0a20 2020 2020 2020  correct..       
+000030b0: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
+000030c0: 7b6e 616d 657d 205c 2765 6368 6f20 2453  {name} \'echo $S
+000030d0: 4b59 5049 4c4f 545f 434c 5553 5445 525f  KYPILOT_CLUSTER_
+000030e0: 494e 464f 207c 206a 7120 2e72 6567 696f  INFO | jq .regio
+000030f0: 6e20 7c20 6772 6570 2075 732d 6365 6e74  n | grep us-cent
+00003100: 7261 6c31 5c27 272c 0a20 2020 2020 2020  ral1\'',.       
+00003110: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+00003120: 7b6e 616d 657d 2033 202d 2d73 7461 7475  {name} 3 --statu
+00003130: 7327 2c20 2023 2045 6e73 7572 6520 7468  s',  # Ensure th
+00003140: 6520 6a6f 6220 7375 6363 6565 6465 642e  e job succeeded.
+00003150: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
+00003160: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
+00003170: 7920 7b6e 616d 657d 272c 0a20 2020 2029  y {name}',.    )
+00003180: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
+00003190: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
+000031a0: 742e 6d61 726b 2e69 626d 0a64 6566 2074  t.mark.ibm.def t
+000031b0: 6573 745f 6962 6d5f 7265 6769 6f6e 2829  est_ibm_region()
+000031c0: 3a0a 2020 2020 6e61 6d65 203d 205f 6765  :.    name = _ge
+000031d0: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
+000031e0: 0a20 2020 2072 6567 696f 6e20 3d20 2765  .    region = 'e
+000031f0: 752d 6465 270a 2020 2020 7465 7374 203d  u-de'.    test =
+00003200: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
+00003210: 7265 6769 6f6e 272c 0a20 2020 2020 2020  region',.       
+00003220: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
+00003230: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
+00003240: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
+00003250: 2069 626d 202d 2d72 6567 696f 6e20 7b72   ibm --region {r
+00003260: 6567 696f 6e7d 2065 7861 6d70 6c65 732f  egion} examples/
+00003270: 6d69 6e69 6d61 6c2e 7961 6d6c 272c 0a20  minimal.yaml',. 
+00003280: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00003290: 2065 7865 6320 7b6e 616d 657d 202d 2d63   exec {name} --c
+000032a0: 6c6f 7564 2069 626d 2065 7861 6d70 6c65  loud ibm example
+000032b0: 732f 6d69 6e69 6d61 6c2e 7961 6d6c 272c  s/minimal.yaml',
+000032c0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+000032d0: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
+000032e0: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
+000032f0: 6e73 7572 6520 7468 6520 6a6f 6220 7375  nsure the job su
+00003300: 6363 6565 6465 642e 0a20 2020 2020 2020  cceeded..       
+00003310: 2020 2020 2066 2773 6b79 2073 7461 7475       f'sky statu
+00003320: 7320 2d2d 616c 6c20 7c20 6772 6570 207b  s --all | grep {
+00003330: 6e61 6d65 7d20 7c20 6772 6570 207b 7265  name} | grep {re
+00003340: 6769 6f6e 7d27 2c20 2023 2045 6e73 7572  gion}',  # Ensur
+00003350: 6520 7468 6520 7265 6769 6f6e 2069 7320  e the region is 
+00003360: 636f 7272 6563 742e 0a20 2020 2020 2020  correct..       
+00003370: 205d 2c0a 2020 2020 2020 2020 6627 736b   ],.        f'sk
+00003380: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
+00003390: 272c 0a20 2020 2029 0a20 2020 2072 756e  ',.    ).    run
+000033a0: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
+000033b0: 0a0a 4070 7974 6573 742e 6d61 726b 2e61  ..@pytest.mark.a
+000033c0: 7a75 7265 0a64 6566 2074 6573 745f 617a  zure.def test_az
+000033d0: 7572 655f 7265 6769 6f6e 2829 3a0a 2020  ure_region():.  
+000033e0: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
+000033f0: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
+00003400: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+00003410: 2020 2020 2020 2761 7a75 7265 5f72 6567        'azure_reg
+00003420: 696f 6e27 2c0a 2020 2020 2020 2020 5b0a  ion',.        [.
+00003430: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00003440: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
+00003450: 6e61 6d65 7d20 2d2d 7265 6769 6f6e 2065  name} --region e
+00003460: 6173 7475 7332 202d 2d63 6c6f 7564 2061  astus2 --cloud a
+00003470: 7a75 7265 2074 6573 7473 2f74 6573 745f  zure tests/test_
+00003480: 7961 6d6c 732f 6d69 6e69 6d61 6c2e 7961  yamls/minimal.ya
+00003490: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
+000034a0: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
+000034b0: 657d 2074 6573 7473 2f74 6573 745f 7961  e} tests/test_ya
+000034c0: 6d6c 732f 6d69 6e69 6d61 6c2e 7961 6d6c  mls/minimal.yaml
+000034d0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+000034e0: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
+000034f0: 2031 202d 2d73 7461 7475 7327 2c20 2023   1 --status',  #
+00003500: 2045 6e73 7572 6520 7468 6520 6a6f 6220   Ensure the job 
+00003510: 7375 6363 6565 6465 642e 0a20 2020 2020  succeeded..     
+00003520: 2020 2020 2020 2066 2773 6b79 2073 7461         f'sky sta
+00003530: 7475 7320 2d2d 616c 6c20 7c20 6772 6570  tus --all | grep
+00003540: 207b 6e61 6d65 7d20 7c20 6772 6570 2065   {name} | grep e
+00003550: 6173 7475 7332 272c 2020 2320 456e 7375  astus2',  # Ensu
+00003560: 7265 2074 6865 2072 6567 696f 6e20 6973  re the region is
+00003570: 2063 6f72 7265 6374 2e0a 2020 2020 2020   correct..      
+00003580: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
+00003590: 207b 6e61 6d65 7d20 5c27 6563 686f 2024   {name} \'echo $
+000035a0: 534b 5950 494c 4f54 5f43 4c55 5354 4552  SKYPILOT_CLUSTER
+000035b0: 5f49 4e46 4f20 7c20 6a71 202e 7265 6769  _INFO | jq .regi
+000035c0: 6f6e 207c 2067 7265 7020 6561 7374 7573  on | grep eastus
+000035d0: 325c 2727 2c0a 2020 2020 2020 2020 2020  2\'',.          
+000035e0: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+000035f0: 6d65 7d20 3220 2d2d 7374 6174 7573 272c  me} 2 --status',
+00003600: 2020 2320 456e 7375 7265 2074 6865 206a    # Ensure the j
+00003610: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
+00003620: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00003630: 6578 6563 207b 6e61 6d65 7d20 5c27 6563  exec {name} \'ec
+00003640: 686f 2024 534b 5950 494c 4f54 5f43 4c55  ho $SKYPILOT_CLU
+00003650: 5354 4552 5f49 4e46 4f20 7c20 6a71 202e  STER_INFO | jq .
+00003660: 7a6f 6e65 207c 2067 7265 7020 6e75 6c6c  zone | grep null
+00003670: 5c27 272c 0a20 2020 2020 2020 2020 2020  \'',.           
+00003680: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
+00003690: 657d 2033 202d 2d73 7461 7475 7327 2c20  e} 3 --status', 
+000036a0: 2023 2045 6e73 7572 6520 7468 6520 6a6f   # Ensure the jo
+000036b0: 6220 7375 6363 6565 6465 642e 0a20 2020  b succeeded..   
+000036c0: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
+000036d0: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
+000036e0: 616d 657d 272c 0a20 2020 2029 0a20 2020  ame}',.    ).   
+000036f0: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
+00003700: 7374 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d  st)...# --------
+00003710: 2d2d 2054 6573 7420 7a6f 6e65 202d 2d2d  -- Test zone ---
+00003720: 2d2d 2d2d 2d2d 2d0a 4070 7974 6573 742e  -------.@pytest.
+00003730: 6d61 726b 2e61 7773 0a64 6566 2074 6573  mark.aws.def tes
+00003740: 745f 6177 735f 7a6f 6e65 2829 3a0a 2020  t_aws_zone():.  
+00003750: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
+00003760: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
+00003770: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+00003780: 2020 2020 2020 2761 7773 5f7a 6f6e 6527        'aws_zone'
+00003790: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
+000037a0: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
+000037b0: 756e 6368 202d 7920 2d63 207b 6e61 6d65  unch -y -c {name
+000037c0: 7d20 6578 616d 706c 6573 2f6d 696e 696d  } examples/minim
+000037d0: 616c 2e79 616d 6c20 2d2d 7a6f 6e65 2075  al.yaml --zone u
+000037e0: 732d 6561 7374 2d32 6227 2c0a 2020 2020  s-east-2b',.    
+000037f0: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
+00003800: 6563 207b 6e61 6d65 7d20 6578 616d 706c  ec {name} exampl
+00003810: 6573 2f6d 696e 696d 616c 2e79 616d 6c20  es/minimal.yaml 
+00003820: 2d2d 7a6f 6e65 2075 732d 6561 7374 2d32  --zone us-east-2
+00003830: 6227 2c0a 2020 2020 2020 2020 2020 2020  b',.            
+00003840: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+00003850: 7d20 3120 2d2d 7374 6174 7573 272c 2020  } 1 --status',  
+00003860: 2320 456e 7375 7265 2074 6865 206a 6f62  # Ensure the job
+00003870: 2073 7563 6365 6564 6564 2e0a 2020 2020   succeeded..    
+00003880: 2020 2020 2020 2020 6627 736b 7920 7374          f'sky st
+00003890: 6174 7573 202d 2d61 6c6c 207c 2067 7265  atus --all | gre
+000038a0: 7020 7b6e 616d 657d 207c 2067 7265 7020  p {name} | grep 
+000038b0: 7573 2d65 6173 742d 3262 272c 2020 2320  us-east-2b',  # 
+000038c0: 456e 7375 7265 2074 6865 207a 6f6e 6520  Ensure the zone 
+000038d0: 6973 2063 6f72 7265 6374 2e0a 2020 2020  is correct..    
+000038e0: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
+000038f0: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
+00003900: 6d65 7d27 2c0a 2020 2020 290a 2020 2020  me}',.    ).    
+00003910: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
+00003920: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
+00003930: 6b2e 6962 6d0a 6465 6620 7465 7374 5f69  k.ibm.def test_i
+00003940: 626d 5f7a 6f6e 6528 293a 0a20 2020 206e  bm_zone():.    n
+00003950: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
+00003960: 6572 5f6e 616d 6528 290a 2020 2020 7a6f  er_name().    zo
+00003970: 6e65 203d 2027 6575 2d64 652d 3227 0a20  ne = 'eu-de-2'. 
+00003980: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
+00003990: 2020 2020 2020 2020 277a 6f6e 6527 2c0a          'zone',.
+000039a0: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
+000039b0: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
+000039c0: 6368 202d 7920 2d63 207b 6e61 6d65 7d20  ch -y -c {name} 
+000039d0: 2d2d 636c 6f75 6420 6962 6d20 6578 616d  --cloud ibm exam
+000039e0: 706c 6573 2f6d 696e 696d 616c 2e79 616d  ples/minimal.yam
+000039f0: 6c20 2d2d 7a6f 6e65 207b 7a6f 6e65 7d27  l --zone {zone}'
+00003a00: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00003a10: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
+00003a20: 2d2d 636c 6f75 6420 6962 6d20 6578 616d  --cloud ibm exam
+00003a30: 706c 6573 2f6d 696e 696d 616c 2e79 616d  ples/minimal.yam
+00003a40: 6c20 2d2d 7a6f 6e65 207b 7a6f 6e65 7d27  l --zone {zone}'
+00003a50: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00003a60: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
+00003a70: 3120 2d2d 7374 6174 7573 272c 2020 2320  1 --status',  # 
+00003a80: 456e 7375 7265 2074 6865 206a 6f62 2073  Ensure the job s
+00003a90: 7563 6365 6564 6564 2e0a 2020 2020 2020  ucceeded..      
+00003aa0: 2020 2020 2020 6627 736b 7920 7374 6174        f'sky stat
+00003ab0: 7573 202d 2d61 6c6c 207c 2067 7265 7020  us --all | grep 
+00003ac0: 7b6e 616d 657d 207c 2067 7265 7020 7b7a  {name} | grep {z
+00003ad0: 6f6e 657d 272c 2020 2320 456e 7375 7265  one}',  # Ensure
+00003ae0: 2074 6865 207a 6f6e 6520 6973 2063 6f72   the zone is cor
+00003af0: 7265 6374 2e0a 2020 2020 2020 2020 5d2c  rect..        ],
+00003b00: 0a20 2020 2020 2020 2066 2773 6b79 2064  .        f'sky d
+00003b10: 6f77 6e20 2d79 207b 6e61 6d65 7d20 7b6e  own -y {name} {n
+00003b20: 616d 657d 2d32 207b 6e61 6d65 7d2d 3327  ame}-2 {name}-3'
+00003b30: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
+00003b40: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
+00003b50: 0a40 7079 7465 7374 2e6d 6172 6b2e 6763  .@pytest.mark.gc
+00003b60: 700a 6465 6620 7465 7374 5f67 6370 5f7a  p.def test_gcp_z
+00003b70: 6f6e 6528 293a 0a20 2020 206e 616d 6520  one():.    name 
+00003b80: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
+00003b90: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
+00003ba0: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
+00003bb0: 6763 705f 7a6f 6e65 272c 0a20 2020 2020  gcp_zone',.     
+00003bc0: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+00003bd0: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
+00003be0: 202d 6320 7b6e 616d 657d 202d 2d7a 6f6e   -c {name} --zon
+00003bf0: 6520 7573 2d63 656e 7472 616c 312d 6120  e us-central1-a 
+00003c00: 2d2d 636c 6f75 6420 6763 7020 7465 7374  --cloud gcp test
+00003c10: 732f 7465 7374 5f79 616d 6c73 2f6d 696e  s/test_yamls/min
+00003c20: 696d 616c 2e79 616d 6c27 2c0a 2020 2020  imal.yaml',.    
+00003c30: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
+00003c40: 6563 207b 6e61 6d65 7d20 2d2d 7a6f 6e65  ec {name} --zone
+00003c50: 2075 732d 6365 6e74 7261 6c31 2d61 202d   us-central1-a -
+00003c60: 2d63 6c6f 7564 2067 6370 2074 6573 7473  -cloud gcp tests
+00003c70: 2f74 6573 745f 7961 6d6c 732f 6d69 6e69  /test_yamls/mini
+00003c80: 6d61 6c2e 7961 6d6c 272c 0a20 2020 2020  mal.yaml',.     
+00003c90: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+00003ca0: 7320 7b6e 616d 657d 2031 202d 2d73 7461  s {name} 1 --sta
+00003cb0: 7475 7327 2c20 2023 2045 6e73 7572 6520  tus',  # Ensure 
+00003cc0: 7468 6520 6a6f 6220 7375 6363 6565 6465  the job succeede
+00003cd0: 642e 0a20 2020 2020 2020 2020 2020 2066  d..            f
+00003ce0: 2773 6b79 2073 7461 7475 7320 2d2d 616c  'sky status --al
+00003cf0: 6c20 7c20 6772 6570 207b 6e61 6d65 7d20  l | grep {name} 
+00003d00: 7c20 6772 6570 2075 732d 6365 6e74 7261  | grep us-centra
+00003d10: 6c31 2d61 272c 2020 2320 456e 7375 7265  l1-a',  # Ensure
+00003d20: 2074 6865 207a 6f6e 6520 6973 2063 6f72   the zone is cor
+00003d30: 7265 6374 2e0a 2020 2020 2020 2020 5d2c  rect..        ],
+00003d40: 0a20 2020 2020 2020 2066 2773 6b79 2064  .        f'sky d
+00003d50: 6f77 6e20 2d79 207b 6e61 6d65 7d27 2c0a  own -y {name}',.
+00003d60: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
+00003d70: 655f 7465 7374 2874 6573 7429 0a0a 0a23  e_test(test)...#
+00003d80: 202d 2d2d 2d2d 2d2d 2d2d 2d20 5465 7374   ---------- Test
+00003d90: 2074 6865 2069 6d61 6765 202d 2d2d 2d2d   the image -----
+00003da0: 2d2d 2d2d 2d0a 4070 7974 6573 742e 6d61  -----.@pytest.ma
+00003db0: 726b 2e61 7773 0a64 6566 2074 6573 745f  rk.aws.def test_
+00003dc0: 6177 735f 696d 6167 6573 2829 3a0a 2020  aws_images():.  
+00003dd0: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
+00003de0: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
+00003df0: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+00003e00: 2020 2020 2020 2761 7773 5f69 6d61 6765        'aws_image
+00003e10: 7327 2c0a 2020 2020 2020 2020 5b0a 2020  s',.        [.  
+00003e20: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00003e30: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
+00003e40: 6d65 7d20 2d2d 696d 6167 652d 6964 2073  me} --image-id s
+00003e50: 6b79 7069 6c6f 743a 6770 752d 7562 756e  kypilot:gpu-ubun
+00003e60: 7475 2d31 3830 3420 6578 616d 706c 6573  tu-1804 examples
+00003e70: 2f6d 696e 696d 616c 2e79 616d 6c27 2c0a  /minimal.yaml',.
+00003e80: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00003e90: 7920 6c6f 6773 207b 6e61 6d65 7d20 3120  y logs {name} 1 
+00003ea0: 2d2d 7374 6174 7573 272c 2020 2320 456e  --status',  # En
+00003eb0: 7375 7265 2074 6865 206a 6f62 2073 7563  sure the job suc
+00003ec0: 6365 6564 6564 2e0a 2020 2020 2020 2020  ceeded..        
+00003ed0: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
+00003ee0: 202d 6320 7b6e 616d 657d 202d 2d69 6d61   -c {name} --ima
+00003ef0: 6765 2d69 6420 736b 7970 696c 6f74 3a67  ge-id skypilot:g
+00003f00: 7075 2d75 6275 6e74 752d 3230 3034 2065  pu-ubuntu-2004 e
+00003f10: 7861 6d70 6c65 732f 6d69 6e69 6d61 6c2e  xamples/minimal.
+00003f20: 7961 6d6c 2026 2620 6578 6974 2031 207c  yaml && exit 1 |
+00003f30: 7c20 7472 7565 272c 0a20 2020 2020 2020  | true',.       
+00003f40: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
+00003f50: 6820 2d79 202d 6320 7b6e 616d 657d 2065  h -y -c {name} e
+00003f60: 7861 6d70 6c65 732f 6d69 6e69 6d61 6c2e  xamples/minimal.
+00003f70: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+00003f80: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+00003f90: 616d 657d 2032 202d 2d73 7461 7475 7327  ame} 2 --status'
+00003fa0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00003fb0: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
+00003fc0: 2d2d 7374 6174 7573 207c 2067 7265 7020  --status | grep 
+00003fd0: 224a 6f62 2032 3a20 5355 4343 4545 4445  "Job 2: SUCCEEDE
+00003fe0: 4422 272c 2020 2320 4571 7569 7661 6c65  D"',  # Equivale
+00003ff0: 6e74 2e0a 2020 2020 2020 2020 2020 2020  nt..            
+00004000: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
+00004010: 7d20 5c27 6563 686f 2024 534b 5950 494c  } \'echo $SKYPIL
+00004020: 4f54 5f43 4c55 5354 4552 5f49 4e46 4f20  OT_CLUSTER_INFO 
+00004030: 7c20 6a71 202e 636c 6f75 6420 7c20 6772  | jq .cloud | gr
+00004040: 6570 202d 6920 6177 735c 2727 2c0a 2020  ep -i aws\'',.  
+00004050: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00004060: 6c6f 6773 207b 6e61 6d65 7d20 3320 2d2d  logs {name} 3 --
+00004070: 7374 6174 7573 272c 2020 2320 456e 7375  status',  # Ensu
+00004080: 7265 2074 6865 206a 6f62 2073 7563 6365  re the job succe
+00004090: 6564 6564 2e0a 2020 2020 2020 2020 5d2c  eded..        ],
+000040a0: 0a20 2020 2020 2020 2066 2773 6b79 2064  .        f'sky d
+000040b0: 6f77 6e20 2d79 207b 6e61 6d65 7d27 2c0a  own -y {name}',.
+000040c0: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
+000040d0: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
+000040e0: 7079 7465 7374 2e6d 6172 6b2e 6763 700a  pytest.mark.gcp.
+000040f0: 6465 6620 7465 7374 5f67 6370 5f69 6d61  def test_gcp_ima
+00004100: 6765 7328 293a 0a20 2020 206e 616d 6520  ges():.    name 
+00004110: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
+00004120: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
+00004130: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
+00004140: 6763 705f 696d 6167 6573 272c 0a20 2020  gcp_images',.   
+00004150: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
+00004160: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
+00004170: 2d79 202d 6320 7b6e 616d 657d 202d 2d69  -y -c {name} --i
+00004180: 6d61 6765 2d69 6420 736b 7970 696c 6f74  mage-id skypilot
+00004190: 3a67 7075 2d64 6562 6961 6e2d 3130 202d  :gpu-debian-10 -
+000041a0: 2d63 6c6f 7564 2067 6370 2074 6573 7473  -cloud gcp tests
+000041b0: 2f74 6573 745f 7961 6d6c 732f 6d69 6e69  /test_yamls/mini
+000041c0: 6d61 6c2e 7961 6d6c 272c 0a20 2020 2020  mal.yaml',.     
+000041d0: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+000041e0: 7320 7b6e 616d 657d 2031 202d 2d73 7461  s {name} 1 --sta
+000041f0: 7475 7327 2c20 2023 2045 6e73 7572 6520  tus',  # Ensure 
+00004200: 7468 6520 6a6f 6220 7375 6363 6565 6465  the job succeede
+00004210: 642e 0a20 2020 2020 2020 2020 2020 2066  d..            f
+00004220: 2773 6b79 206c 6175 6e63 6820 2d63 207b  'sky launch -c {
+00004230: 6e61 6d65 7d20 2d2d 696d 6167 652d 6964  name} --image-id
+00004240: 2073 6b79 7069 6c6f 743a 6370 752d 6465   skypilot:cpu-de
+00004250: 6269 616e 2d31 3020 2d2d 636c 6f75 6420  bian-10 --cloud 
+00004260: 6763 7020 7465 7374 732f 7465 7374 5f79  gcp tests/test_y
+00004270: 616d 6c73 2f6d 696e 696d 616c 2e79 616d  amls/minimal.yam
+00004280: 6c20 2626 2065 7869 7420 3120 7c7c 2074  l && exit 1 || t
+00004290: 7275 6527 2c0a 2020 2020 2020 2020 2020  rue',.          
+000042a0: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
+000042b0: 7920 2d63 207b 6e61 6d65 7d20 7465 7374  y -c {name} test
+000042c0: 732f 7465 7374 5f79 616d 6c73 2f6d 696e  s/test_yamls/min
+000042d0: 696d 616c 2e79 616d 6c27 2c0a 2020 2020  imal.yaml',.    
+000042e0: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+000042f0: 6773 207b 6e61 6d65 7d20 3220 2d2d 7374  gs {name} 2 --st
+00004300: 6174 7573 272c 0a20 2020 2020 2020 2020  atus',.         
+00004310: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+00004320: 616d 657d 202d 2d73 7461 7475 7320 7c20  ame} --status | 
+00004330: 6772 6570 2022 4a6f 6220 323a 2053 5543  grep "Job 2: SUC
+00004340: 4345 4544 4544 2227 2c20 2023 2045 7175  CEEDED"',  # Equ
+00004350: 6976 616c 656e 742e 0a20 2020 2020 2020  ivalent..       
+00004360: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
+00004370: 7b6e 616d 657d 205c 2765 6368 6f20 2453  {name} \'echo $S
+00004380: 4b59 5049 4c4f 545f 434c 5553 5445 525f  KYPILOT_CLUSTER_
+00004390: 494e 464f 207c 206a 7120 2e63 6c6f 7564  INFO | jq .cloud
+000043a0: 207c 2067 7265 7020 2d69 2067 6370 5c27   | grep -i gcp\'
+000043b0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+000043c0: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
+000043d0: 2033 202d 2d73 7461 7475 7327 2c20 2023   3 --status',  #
+000043e0: 2045 6e73 7572 6520 7468 6520 6a6f 6220   Ensure the job 
+000043f0: 7375 6363 6565 6465 642e 0a20 2020 2020  succeeded..     
+00004400: 2020 205d 2c0a 2020 2020 2020 2020 6627     ],.        f'
+00004410: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
+00004420: 657d 272c 0a20 2020 2029 0a20 2020 2072  e}',.    ).    r
+00004430: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
+00004440: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
+00004450: 2e61 7a75 7265 0a64 6566 2074 6573 745f  .azure.def test_
+00004460: 617a 7572 655f 696d 6167 6573 2829 3a0a  azure_images():.
+00004470: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
+00004480: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
+00004490: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
+000044a0: 2020 2020 2020 2020 2761 7a75 7265 5f69          'azure_i
+000044b0: 6d61 6765 7327 2c0a 2020 2020 2020 2020  mages',.        
+000044c0: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
+000044d0: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
+000044e0: 207b 6e61 6d65 7d20 2d2d 696d 6167 652d   {name} --image-
+000044f0: 6964 2073 6b79 7069 6c6f 743a 6770 752d  id skypilot:gpu-
+00004500: 7562 756e 7475 2d32 3230 3420 2d2d 636c  ubuntu-2204 --cl
+00004510: 6f75 6420 617a 7572 6520 7465 7374 732f  oud azure tests/
+00004520: 7465 7374 5f79 616d 6c73 2f6d 696e 696d  test_yamls/minim
+00004530: 616c 2e79 616d 6c27 2c0a 2020 2020 2020  al.yaml',.      
+00004540: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
+00004550: 207b 6e61 6d65 7d20 3120 2d2d 7374 6174   {name} 1 --stat
+00004560: 7573 272c 2020 2320 456e 7375 7265 2074  us',  # Ensure t
+00004570: 6865 206a 6f62 2073 7563 6365 6564 6564  he job succeeded
+00004580: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
+00004590: 736b 7920 6c61 756e 6368 202d 6320 7b6e  sky launch -c {n
+000045a0: 616d 657d 202d 2d69 6d61 6765 2d69 6420  ame} --image-id 
+000045b0: 736b 7970 696c 6f74 3a76 312d 7562 756e  skypilot:v1-ubun
+000045c0: 7475 2d32 3030 3420 2d2d 636c 6f75 6420  tu-2004 --cloud 
+000045d0: 617a 7572 6520 7465 7374 732f 7465 7374  azure tests/test
+000045e0: 5f79 616d 6c73 2f6d 696e 696d 616c 2e79  _yamls/minimal.y
+000045f0: 616d 6c20 2626 2065 7869 7420 3120 7c7c  aml && exit 1 ||
+00004600: 2074 7275 6527 2c0a 2020 2020 2020 2020   true',.        
+00004610: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
+00004620: 202d 7920 2d63 207b 6e61 6d65 7d20 7465   -y -c {name} te
+00004630: 7374 732f 7465 7374 5f79 616d 6c73 2f6d  sts/test_yamls/m
+00004640: 696e 696d 616c 2e79 616d 6c27 2c0a 2020  inimal.yaml',.  
+00004650: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00004660: 6c6f 6773 207b 6e61 6d65 7d20 3220 2d2d  logs {name} 2 --
+00004670: 7374 6174 7573 272c 0a20 2020 2020 2020  status',.       
+00004680: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+00004690: 7b6e 616d 657d 202d 2d73 7461 7475 7320  {name} --status 
+000046a0: 7c20 6772 6570 2022 4a6f 6220 323a 2053  | grep "Job 2: S
+000046b0: 5543 4345 4544 4544 2227 2c20 2023 2045  UCCEEDED"',  # E
+000046c0: 7175 6976 616c 656e 742e 0a20 2020 2020  quivalent..     
+000046d0: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
+000046e0: 6320 7b6e 616d 657d 205c 2765 6368 6f20  c {name} \'echo 
+000046f0: 2453 4b59 5049 4c4f 545f 434c 5553 5445  $SKYPILOT_CLUSTE
+00004700: 525f 494e 464f 207c 206a 7120 2e63 6c6f  R_INFO | jq .clo
+00004710: 7564 207c 2067 7265 7020 2d69 2061 7a75  ud | grep -i azu
+00004720: 7265 5c27 272c 0a20 2020 2020 2020 2020  re\'',.         
+00004730: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+00004740: 616d 657d 2033 202d 2d73 7461 7475 7327  ame} 3 --status'
+00004750: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
+00004760: 6a6f 6220 7375 6363 6565 6465 642e 0a20  job succeeded.. 
+00004770: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
+00004780: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
+00004790: 7b6e 616d 657d 272c 0a20 2020 2029 0a20  {name}',.    ). 
+000047a0: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+000047b0: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
+000047c0: 6d61 726b 2e61 7773 0a64 6566 2074 6573  mark.aws.def tes
+000047d0: 745f 6177 735f 696d 6167 655f 6964 5f64  t_aws_image_id_d
+000047e0: 6963 7428 293a 0a20 2020 206e 616d 6520  ict():.    name 
+000047f0: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
+00004800: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
+00004810: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
+00004820: 6177 735f 696d 6167 655f 6964 5f64 6963  aws_image_id_dic
+00004830: 7427 2c0a 2020 2020 2020 2020 5b0a 2020  t',.        [.  
+00004840: 2020 2020 2020 2020 2020 2320 5573 6520            # Use 
+00004850: 696d 6167 6520 6964 2064 6963 742e 0a20  image id dict.. 
+00004860: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00004870: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
+00004880: 616d 657d 2065 7861 6d70 6c65 732f 7065  ame} examples/pe
+00004890: 725f 7265 6769 6f6e 5f69 6d61 6765 732e  r_region_images.
+000048a0: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+000048b0: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
+000048c0: 616d 657d 2065 7861 6d70 6c65 732f 7065  ame} examples/pe
+000048d0: 725f 7265 6769 6f6e 5f69 6d61 6765 732e  r_region_images.
+000048e0: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+000048f0: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
+00004900: 616d 657d 2022 6c73 207e 2227 2c0a 2020  ame} "ls ~"',.  
+00004910: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00004920: 6c6f 6773 207b 6e61 6d65 7d20 3120 2d2d  logs {name} 1 --
+00004930: 7374 6174 7573 272c 0a20 2020 2020 2020  status',.       
+00004940: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+00004950: 7b6e 616d 657d 2032 202d 2d73 7461 7475  {name} 2 --statu
+00004960: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
+00004970: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+00004980: 7d20 3320 2d2d 7374 6174 7573 272c 0a20  } 3 --status',. 
+00004990: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
+000049a0: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
+000049b0: 7b6e 616d 657d 272c 0a20 2020 2029 0a20  {name}',.    ). 
+000049c0: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+000049d0: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
+000049e0: 6d61 726b 2e67 6370 0a64 6566 2074 6573  mark.gcp.def tes
+000049f0: 745f 6763 705f 696d 6167 655f 6964 5f64  t_gcp_image_id_d
+00004a00: 6963 7428 293a 0a20 2020 206e 616d 6520  ict():.    name 
+00004a10: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
+00004a20: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
+00004a30: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
+00004a40: 6763 705f 696d 6167 655f 6964 5f64 6963  gcp_image_id_dic
+00004a50: 7427 2c0a 2020 2020 2020 2020 5b0a 2020  t',.        [.  
+00004a60: 2020 2020 2020 2020 2020 2320 5573 6520            # Use 
+00004a70: 696d 6167 6520 6964 2064 6963 742e 0a20  image id dict.. 
+00004a80: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00004a90: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
+00004aa0: 616d 657d 2074 6573 7473 2f74 6573 745f  ame} tests/test_
+00004ab0: 7961 6d6c 732f 6763 705f 7065 725f 7265  yamls/gcp_per_re
+00004ac0: 6769 6f6e 5f69 6d61 6765 732e 7961 6d6c  gion_images.yaml
+00004ad0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00004ae0: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+00004af0: 2074 6573 7473 2f74 6573 745f 7961 6d6c   tests/test_yaml
+00004b00: 732f 6763 705f 7065 725f 7265 6769 6f6e  s/gcp_per_region
+00004b10: 5f69 6d61 6765 732e 7961 6d6c 272c 0a20  _images.yaml',. 
+00004b20: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00004b30: 2065 7865 6320 7b6e 616d 657d 2022 6c73   exec {name} "ls
+00004b40: 207e 2227 2c0a 2020 2020 2020 2020 2020   ~"',.          
+00004b50: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+00004b60: 6d65 7d20 3120 2d2d 7374 6174 7573 272c  me} 1 --status',
+00004b70: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00004b80: 6b79 206c 6f67 7320 7b6e 616d 657d 2032  ky logs {name} 2
+00004b90: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
+00004ba0: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+00004bb0: 6773 207b 6e61 6d65 7d20 3320 2d2d 7374  gs {name} 3 --st
+00004bc0: 6174 7573 272c 0a20 2020 2020 2020 205d  atus',.        ]
+00004bd0: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
+00004be0: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
+00004bf0: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+00004c00: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+00004c10: 4070 7974 6573 742e 6d61 726b 2e61 7773  @pytest.mark.aws
+00004c20: 0a64 6566 2074 6573 745f 6177 735f 696d  .def test_aws_im
+00004c30: 6167 655f 6964 5f64 6963 745f 7265 6769  age_id_dict_regi
+00004c40: 6f6e 2829 3a0a 2020 2020 6e61 6d65 203d  on():.    name =
+00004c50: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
+00004c60: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
+00004c70: 5465 7374 280a 2020 2020 2020 2020 2761  Test(.        'a
+00004c80: 7773 5f69 6d61 6765 5f69 645f 6469 6374  ws_image_id_dict
+00004c90: 5f72 6567 696f 6e27 2c0a 2020 2020 2020  _region',.      
+00004ca0: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
+00004cb0: 2320 5941 4d4c 2068 6173 0a20 2020 2020  # YAML has.     
+00004cc0: 2020 2020 2020 2023 2020 2069 6d61 6765         #   image
+00004cd0: 5f69 643a 0a20 2020 2020 2020 2020 2020  _id:.           
+00004ce0: 2023 2020 2020 2020 2075 732d 7765 7374   #       us-west
+00004cf0: 2d32 3a20 736b 7970 696c 6f74 3a67 7075  -2: skypilot:gpu
+00004d00: 2d75 6275 6e74 752d 3138 3034 0a20 2020  -ubuntu-1804.   
+00004d10: 2020 2020 2020 2020 2023 2020 2020 2020           #      
+00004d20: 2075 732d 6561 7374 2d32 3a20 736b 7970   us-east-2: skyp
+00004d30: 696c 6f74 3a67 7075 2d75 6275 6e74 752d  ilot:gpu-ubuntu-
+00004d40: 3230 3034 0a20 2020 2020 2020 2020 2020  2004.           
+00004d50: 2023 2055 7365 2072 6567 696f 6e20 746f   # Use region to
+00004d60: 2066 696c 7465 7220 696d 6167 655f 6964   filter image_id
+00004d70: 2064 6963 742e 0a20 2020 2020 2020 2020   dict..         
+00004d80: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
+00004d90: 2d79 202d 6320 7b6e 616d 657d 202d 2d72  -y -c {name} --r
+00004da0: 6567 696f 6e20 7573 2d65 6173 742d 3120  egion us-east-1 
+00004db0: 6578 616d 706c 6573 2f70 6572 5f72 6567  examples/per_reg
+00004dc0: 696f 6e5f 696d 6167 6573 2e79 616d 6c20  ion_images.yaml 
+00004dd0: 2626 2065 7869 7420 3120 7c7c 2074 7275  && exit 1 || tru
+00004de0: 6527 2c0a 2020 2020 2020 2020 2020 2020  e',.            
+00004df0: 6627 736b 7920 7374 6174 7573 207c 2067  f'sky status | g
+00004e00: 7265 7020 7b6e 616d 657d 2026 2620 6578  rep {name} && ex
+00004e10: 6974 2031 207c 7c20 7472 7565 272c 2020  it 1 || true',  
+00004e20: 2320 456e 7375 7265 2074 6865 2063 6c75  # Ensure the clu
+00004e30: 7374 6572 2069 7320 6e6f 7420 6372 6561  ster is not crea
+00004e40: 7465 642e 0a20 2020 2020 2020 2020 2020  ted..           
+00004e50: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
+00004e60: 202d 6320 7b6e 616d 657d 202d 2d72 6567   -c {name} --reg
+00004e70: 696f 6e20 7573 2d65 6173 742d 3220 6578  ion us-east-2 ex
+00004e80: 616d 706c 6573 2f70 6572 5f72 6567 696f  amples/per_regio
+00004e90: 6e5f 696d 6167 6573 2e79 616d 6c27 2c0a  n_images.yaml',.
+00004ea0: 2020 2020 2020 2020 2020 2020 2320 5368              # Sh
+00004eb0: 6f75 6c64 2073 7563 6365 7373 2062 6563  ould success bec
+00004ec0: 6175 7365 2074 6865 2069 6d61 6765 2069  ause the image i
+00004ed0: 6420 6d61 7463 6820 666f 7220 7468 6520  d match for the 
+00004ee0: 7265 6769 6f6e 2e0a 2020 2020 2020 2020  region..        
+00004ef0: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
+00004f00: 202d 6320 7b6e 616d 657d 202d 2d69 6d61   -c {name} --ima
+00004f10: 6765 2d69 6420 736b 7970 696c 6f74 3a67  ge-id skypilot:g
+00004f20: 7075 2d75 6275 6e74 752d 3230 3034 2065  pu-ubuntu-2004 e
+00004f30: 7861 6d70 6c65 732f 6d69 6e69 6d61 6c2e  xamples/minimal.
+00004f40: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+00004f50: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
+00004f60: 616d 657d 202d 2d69 6d61 6765 2d69 6420  ame} --image-id 
+00004f70: 736b 7970 696c 6f74 3a67 7075 2d75 6275  skypilot:gpu-ubu
+00004f80: 6e74 752d 3230 3034 2065 7861 6d70 6c65  ntu-2004 example
+00004f90: 732f 6d69 6e69 6d61 6c2e 7961 6d6c 272c  s/minimal.yaml',
+00004fa0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00004fb0: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
+00004fc0: 2d69 6d61 6765 2d69 6420 736b 7970 696c  -image-id skypil
+00004fd0: 6f74 3a67 7075 2d75 6275 6e74 752d 3138  ot:gpu-ubuntu-18
+00004fe0: 3034 2065 7861 6d70 6c65 732f 6d69 6e69  04 examples/mini
+00004ff0: 6d61 6c2e 7961 6d6c 2026 2620 6578 6974  mal.yaml && exit
+00005000: 2031 207c 7c20 7472 7565 272c 0a20 2020   1 || true',.   
+00005010: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00005020: 6f67 7320 7b6e 616d 657d 2031 202d 2d73  ogs {name} 1 --s
+00005030: 7461 7475 7327 2c0a 2020 2020 2020 2020  tatus',.        
+00005040: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
+00005050: 6e61 6d65 7d20 3220 2d2d 7374 6174 7573  name} 2 --status
+00005060: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00005070: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
+00005080: 2033 202d 2d73 7461 7475 7327 2c0a 2020   3 --status',.  
+00005090: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+000050a0: 7374 6174 7573 202d 2d61 6c6c 207c 2067  status --all | g
+000050b0: 7265 7020 7b6e 616d 657d 207c 2067 7265  rep {name} | gre
+000050c0: 7020 7573 2d65 6173 742d 3227 2c20 2023  p us-east-2',  #
+000050d0: 2045 6e73 7572 6520 7468 6520 7265 6769   Ensure the regi
+000050e0: 6f6e 2069 7320 636f 7272 6563 742e 0a20  on is correct.. 
+000050f0: 2020 2020 2020 2020 2020 2023 2045 6e73             # Ens
+00005100: 7572 6520 6578 6563 2077 6f72 6b73 2e0a  ure exec works..
+00005110: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00005120: 7920 6578 6563 207b 6e61 6d65 7d20 2d2d  y exec {name} --
+00005130: 7265 6769 6f6e 2075 732d 6561 7374 2d32  region us-east-2
+00005140: 2065 7861 6d70 6c65 732f 7065 725f 7265   examples/per_re
+00005150: 6769 6f6e 5f69 6d61 6765 732e 7961 6d6c  gion_images.yaml
+00005160: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00005170: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+00005180: 2065 7861 6d70 6c65 732f 7065 725f 7265   examples/per_re
+00005190: 6769 6f6e 5f69 6d61 6765 732e 7961 6d6c  gion_images.yaml
+000051a0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+000051b0: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+000051c0: 202d 2d63 6c6f 7564 2061 7773 202d 2d72   --cloud aws --r
+000051d0: 6567 696f 6e20 7573 2d65 6173 742d 3220  egion us-east-2 
+000051e0: 226c 7320 7e22 272c 0a20 2020 2020 2020  "ls ~"',.       
+000051f0: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
+00005200: 7b6e 616d 657d 2022 6c73 207e 2227 2c0a  {name} "ls ~"',.
+00005210: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00005220: 7920 6c6f 6773 207b 6e61 6d65 7d20 3420  y logs {name} 4 
+00005230: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
+00005240: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+00005250: 7320 7b6e 616d 657d 2035 202d 2d73 7461  s {name} 5 --sta
+00005260: 7475 7327 2c0a 2020 2020 2020 2020 2020  tus',.          
+00005270: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+00005280: 6d65 7d20 3620 2d2d 7374 6174 7573 272c  me} 6 --status',
+00005290: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+000052a0: 6b79 206c 6f67 7320 7b6e 616d 657d 2037  ky logs {name} 7
+000052b0: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
+000052c0: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
+000052d0: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
+000052e0: 6d65 7d27 2c0a 2020 2020 290a 2020 2020  me}',.    ).    
+000052f0: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
+00005300: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
+00005310: 6b2e 6763 700a 6465 6620 7465 7374 5f67  k.gcp.def test_g
+00005320: 6370 5f69 6d61 6765 5f69 645f 6469 6374  cp_image_id_dict
+00005330: 5f72 6567 696f 6e28 293a 0a20 2020 206e  _region():.    n
+00005340: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
+00005350: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
+00005360: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+00005370: 2020 2027 6763 705f 696d 6167 655f 6964     'gcp_image_id
+00005380: 5f64 6963 745f 7265 6769 6f6e 272c 0a20  _dict_region',. 
+00005390: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
+000053a0: 2020 2020 2023 2055 7365 2072 6567 696f       # Use regio
+000053b0: 6e20 746f 2066 696c 7465 7220 696d 6167  n to filter imag
+000053c0: 655f 6964 2064 6963 742e 0a20 2020 2020  e_id dict..     
+000053d0: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
+000053e0: 6e63 6820 2d79 202d 6320 7b6e 616d 657d  nch -y -c {name}
+000053f0: 202d 2d72 6567 696f 6e20 7573 2d65 6173   --region us-eas
+00005400: 7431 2074 6573 7473 2f74 6573 745f 7961  t1 tests/test_ya
+00005410: 6d6c 732f 6763 705f 7065 725f 7265 6769  mls/gcp_per_regi
+00005420: 6f6e 5f69 6d61 6765 732e 7961 6d6c 2026  on_images.yaml &
+00005430: 2620 6578 6974 2031 207c 7c20 7472 7565  & exit 1 || true
+00005440: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00005450: 2773 6b79 2073 7461 7475 7320 7c20 6772  'sky status | gr
+00005460: 6570 207b 6e61 6d65 7d20 2626 2065 7869  ep {name} && exi
+00005470: 7420 3120 7c7c 2074 7275 6527 2c20 2023  t 1 || true',  #
+00005480: 2045 6e73 7572 6520 7468 6520 636c 7573   Ensure the clus
+00005490: 7465 7220 6973 206e 6f74 2063 7265 6174  ter is not creat
+000054a0: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
+000054b0: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
+000054c0: 2d63 207b 6e61 6d65 7d20 2d2d 7265 6769  -c {name} --regi
+000054d0: 6f6e 2075 732d 7765 7374 3320 7465 7374  on us-west3 test
+000054e0: 732f 7465 7374 5f79 616d 6c73 2f67 6370  s/test_yamls/gcp
+000054f0: 5f70 6572 5f72 6567 696f 6e5f 696d 6167  _per_region_imag
+00005500: 6573 2e79 616d 6c27 2c0a 2020 2020 2020  es.yaml',.      
+00005510: 2020 2020 2020 2320 5368 6f75 6c64 2073        # Should s
+00005520: 7563 6365 7373 2062 6563 6175 7365 2074  uccess because t
+00005530: 6865 2069 6d61 6765 2069 6420 6d61 7463  he image id matc
+00005540: 6820 666f 7220 7468 6520 7265 6769 6f6e  h for the region
+00005550: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
+00005560: 736b 7920 6c61 756e 6368 202d 6320 7b6e  sky launch -c {n
+00005570: 616d 657d 202d 2d63 6c6f 7564 2067 6370  ame} --cloud gcp
+00005580: 202d 2d69 6d61 6765 2d69 6420 7072 6f6a   --image-id proj
+00005590: 6563 7473 2f75 6275 6e74 752d 6f73 2d63  ects/ubuntu-os-c
+000055a0: 6c6f 7564 2f67 6c6f 6261 6c2f 696d 6167  loud/global/imag
+000055b0: 6573 2f75 6275 6e74 752d 3138 3034 2d62  es/ubuntu-1804-b
+000055c0: 696f 6e69 632d 7632 3032 3330 3131 3220  ionic-v20230112 
+000055d0: 7465 7374 732f 7465 7374 5f79 616d 6c73  tests/test_yamls
+000055e0: 2f6d 696e 696d 616c 2e79 616d 6c27 2c0a  /minimal.yaml',.
+000055f0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00005600: 7920 6578 6563 207b 6e61 6d65 7d20 2d2d  y exec {name} --
+00005610: 636c 6f75 6420 6763 7020 2d2d 696d 6167  cloud gcp --imag
+00005620: 652d 6964 2070 726f 6a65 6374 732f 7562  e-id projects/ub
+00005630: 756e 7475 2d6f 732d 636c 6f75 642f 676c  untu-os-cloud/gl
+00005640: 6f62 616c 2f69 6d61 6765 732f 7562 756e  obal/images/ubun
+00005650: 7475 2d31 3830 342d 6269 6f6e 6963 2d76  tu-1804-bionic-v
+00005660: 3230 3233 3031 3132 2074 6573 7473 2f74  20230112 tests/t
+00005670: 6573 745f 7961 6d6c 732f 6d69 6e69 6d61  est_yamls/minima
+00005680: 6c2e 7961 6d6c 272c 0a20 2020 2020 2020  l.yaml',.       
+00005690: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
+000056a0: 7b6e 616d 657d 202d 2d63 6c6f 7564 2067  {name} --cloud g
+000056b0: 6370 202d 2d69 6d61 6765 2d69 6420 736b  cp --image-id sk
+000056c0: 7970 696c 6f74 3a63 7075 2d64 6562 6961  ypilot:cpu-debia
+000056d0: 6e2d 3130 2074 6573 7473 2f74 6573 745f  n-10 tests/test_
+000056e0: 7961 6d6c 732f 6d69 6e69 6d61 6c2e 7961  yamls/minimal.ya
+000056f0: 6d6c 2026 2620 6578 6974 2031 207c 7c20  ml && exit 1 || 
+00005700: 7472 7565 272c 0a20 2020 2020 2020 2020  true',.         
+00005710: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+00005720: 616d 657d 2031 202d 2d73 7461 7475 7327  ame} 1 --status'
+00005730: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00005740: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
+00005750: 3220 2d2d 7374 6174 7573 272c 0a20 2020  2 --status',.   
+00005760: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00005770: 6f67 7320 7b6e 616d 657d 2033 202d 2d73  ogs {name} 3 --s
+00005780: 7461 7475 7327 2c0a 2020 2020 2020 2020  tatus',.        
+00005790: 2020 2020 6627 736b 7920 7374 6174 7573      f'sky status
+000057a0: 202d 2d61 6c6c 207c 2067 7265 7020 7b6e   --all | grep {n
+000057b0: 616d 657d 207c 2067 7265 7020 7573 2d77  ame} | grep us-w
+000057c0: 6573 7433 272c 2020 2320 456e 7375 7265  est3',  # Ensure
+000057d0: 2074 6865 2072 6567 696f 6e20 6973 2063   the region is c
+000057e0: 6f72 7265 6374 2e0a 2020 2020 2020 2020  orrect..        
+000057f0: 2020 2020 2320 456e 7375 7265 2065 7865      # Ensure exe
+00005800: 6320 776f 726b 732e 0a20 2020 2020 2020  c works..       
+00005810: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
+00005820: 7b6e 616d 657d 202d 2d72 6567 696f 6e20  {name} --region 
+00005830: 7573 2d77 6573 7433 2074 6573 7473 2f74  us-west3 tests/t
+00005840: 6573 745f 7961 6d6c 732f 6763 705f 7065  est_yamls/gcp_pe
+00005850: 725f 7265 6769 6f6e 5f69 6d61 6765 732e  r_region_images.
+00005860: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+00005870: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
+00005880: 616d 657d 2074 6573 7473 2f74 6573 745f  ame} tests/test_
+00005890: 7961 6d6c 732f 6763 705f 7065 725f 7265  yamls/gcp_per_re
+000058a0: 6769 6f6e 5f69 6d61 6765 732e 7961 6d6c  gion_images.yaml
+000058b0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+000058c0: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+000058d0: 202d 2d63 6c6f 7564 2067 6370 202d 2d72   --cloud gcp --r
+000058e0: 6567 696f 6e20 7573 2d77 6573 7433 2022  egion us-west3 "
+000058f0: 6c73 207e 2227 2c0a 2020 2020 2020 2020  ls ~"',.        
+00005900: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
+00005910: 6e61 6d65 7d20 226c 7320 7e22 272c 0a20  name} "ls ~"',. 
+00005920: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00005930: 206c 6f67 7320 7b6e 616d 657d 2034 202d   logs {name} 4 -
+00005940: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
+00005950: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
+00005960: 207b 6e61 6d65 7d20 3520 2d2d 7374 6174   {name} 5 --stat
+00005970: 7573 272c 0a20 2020 2020 2020 2020 2020  us',.           
+00005980: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
+00005990: 657d 2036 202d 2d73 7461 7475 7327 2c0a  e} 6 --status',.
+000059a0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+000059b0: 7920 6c6f 6773 207b 6e61 6d65 7d20 3720  y logs {name} 7 
+000059c0: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
+000059d0: 2020 205d 2c0a 2020 2020 2020 2020 6627     ],.        f'
+000059e0: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
+000059f0: 657d 272c 0a20 2020 2029 0a20 2020 2072  e}',.    ).    r
+00005a00: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
+00005a10: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
+00005a20: 2e61 7773 0a64 6566 2074 6573 745f 6177  .aws.def test_aw
+00005a30: 735f 696d 6167 655f 6964 5f64 6963 745f  s_image_id_dict_
+00005a40: 7a6f 6e65 2829 3a0a 2020 2020 6e61 6d65  zone():.    name
+00005a50: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
+00005a60: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
+00005a70: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+00005a80: 2761 7773 5f69 6d61 6765 5f69 645f 6469  'aws_image_id_di
+00005a90: 6374 5f7a 6f6e 6527 2c0a 2020 2020 2020  ct_zone',.      
+00005aa0: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
+00005ab0: 2320 5941 4d4c 2068 6173 0a20 2020 2020  # YAML has.     
+00005ac0: 2020 2020 2020 2023 2020 2069 6d61 6765         #   image
+00005ad0: 5f69 643a 0a20 2020 2020 2020 2020 2020  _id:.           
+00005ae0: 2023 2020 2020 2020 2075 732d 7765 7374   #       us-west
+00005af0: 2d32 3a20 736b 7970 696c 6f74 3a67 7075  -2: skypilot:gpu
+00005b00: 2d75 6275 6e74 752d 3138 3034 0a20 2020  -ubuntu-1804.   
+00005b10: 2020 2020 2020 2020 2023 2020 2020 2020           #      
+00005b20: 2075 732d 6561 7374 2d32 3a20 736b 7970   us-east-2: skyp
+00005b30: 696c 6f74 3a67 7075 2d75 6275 6e74 752d  ilot:gpu-ubuntu-
+00005b40: 3230 3034 0a20 2020 2020 2020 2020 2020  2004.           
+00005b50: 2023 2055 7365 207a 6f6e 6520 746f 2066   # Use zone to f
+00005b60: 696c 7465 7220 696d 6167 655f 6964 2064  ilter image_id d
+00005b70: 6963 742e 0a20 2020 2020 2020 2020 2020  ict..           
+00005b80: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
+00005b90: 202d 6320 7b6e 616d 657d 202d 2d7a 6f6e   -c {name} --zon
+00005ba0: 6520 7573 2d65 6173 742d 3162 2065 7861  e us-east-1b exa
+00005bb0: 6d70 6c65 732f 7065 725f 7265 6769 6f6e  mples/per_region
+00005bc0: 5f69 6d61 6765 732e 7961 6d6c 2026 2620  _images.yaml && 
+00005bd0: 6578 6974 2031 207c 7c20 7472 7565 272c  exit 1 || true',
+00005be0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00005bf0: 6b79 2073 7461 7475 7320 7c20 6772 6570  ky status | grep
+00005c00: 207b 6e61 6d65 7d20 2626 2065 7869 7420   {name} && exit 
+00005c10: 3120 7c7c 2074 7275 6527 2c20 2023 2045  1 || true',  # E
+00005c20: 6e73 7572 6520 7468 6520 636c 7573 7465  nsure the cluste
+00005c30: 7220 6973 206e 6f74 2063 7265 6174 6564  r is not created
+00005c40: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
+00005c50: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
+00005c60: 207b 6e61 6d65 7d20 2d2d 7a6f 6e65 2075   {name} --zone u
+00005c70: 732d 6561 7374 2d32 6120 6578 616d 706c  s-east-2a exampl
+00005c80: 6573 2f70 6572 5f72 6567 696f 6e5f 696d  es/per_region_im
+00005c90: 6167 6573 2e79 616d 6c27 2c0a 2020 2020  ages.yaml',.    
+00005ca0: 2020 2020 2020 2020 2320 5368 6f75 6c64          # Should
+00005cb0: 2073 7563 6365 7373 2062 6563 6175 7365   success because
+00005cc0: 2074 6865 2069 6d61 6765 2069 6420 6d61   the image id ma
+00005cd0: 7463 6820 666f 7220 7468 6520 7a6f 6e65  tch for the zone
+00005ce0: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
+00005cf0: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
+00005d00: 207b 6e61 6d65 7d20 2d2d 696d 6167 652d   {name} --image-
+00005d10: 6964 2073 6b79 7069 6c6f 743a 6770 752d  id skypilot:gpu-
+00005d20: 7562 756e 7475 2d32 3030 3420 6578 616d  ubuntu-2004 exam
+00005d30: 706c 6573 2f6d 696e 696d 616c 2e79 616d  ples/minimal.yam
+00005d40: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+00005d50: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
+00005d60: 7d20 2d2d 696d 6167 652d 6964 2073 6b79  } --image-id sky
+00005d70: 7069 6c6f 743a 6770 752d 7562 756e 7475  pilot:gpu-ubuntu
+00005d80: 2d32 3030 3420 6578 616d 706c 6573 2f6d  -2004 examples/m
+00005d90: 696e 696d 616c 2e79 616d 6c27 2c0a 2020  inimal.yaml',.  
+00005da0: 2020 2020 2020 2020 2020 2320 4661 696c            # Fail
+00005db0: 2064 7565 2074 6f20 696d 6167 6520 6964   due to image id
+00005dc0: 206d 6973 6d61 7463 682e 0a20 2020 2020   mismatch..     
+00005dd0: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
+00005de0: 6320 7b6e 616d 657d 202d 2d69 6d61 6765  c {name} --image
+00005df0: 2d69 6420 736b 7970 696c 6f74 3a67 7075  -id skypilot:gpu
+00005e00: 2d75 6275 6e74 752d 3138 3034 2065 7861  -ubuntu-1804 exa
+00005e10: 6d70 6c65 732f 6d69 6e69 6d61 6c2e 7961  mples/minimal.ya
+00005e20: 6d6c 2026 2620 6578 6974 2031 207c 7c20  ml && exit 1 || 
+00005e30: 7472 7565 272c 0a20 2020 2020 2020 2020  true',.         
+00005e40: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+00005e50: 616d 657d 2031 202d 2d73 7461 7475 7327  ame} 1 --status'
+00005e60: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00005e70: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
+00005e80: 3220 2d2d 7374 6174 7573 272c 0a20 2020  2 --status',.   
+00005e90: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00005ea0: 6f67 7320 7b6e 616d 657d 2033 202d 2d73  ogs {name} 3 --s
+00005eb0: 7461 7475 7327 2c0a 2020 2020 2020 2020  tatus',.        
+00005ec0: 2020 2020 6627 736b 7920 7374 6174 7573      f'sky status
+00005ed0: 202d 2d61 6c6c 207c 2067 7265 7020 7b6e   --all | grep {n
+00005ee0: 616d 657d 207c 2067 7265 7020 7573 2d65  ame} | grep us-e
+00005ef0: 6173 742d 3261 272c 2020 2320 456e 7375  ast-2a',  # Ensu
+00005f00: 7265 2074 6865 207a 6f6e 6520 6973 2063  re the zone is c
+00005f10: 6f72 7265 6374 2e0a 2020 2020 2020 2020  orrect..        
+00005f20: 2020 2020 2320 456e 7375 7265 2065 7865      # Ensure exe
+00005f30: 6320 776f 726b 732e 0a20 2020 2020 2020  c works..       
+00005f40: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
+00005f50: 7b6e 616d 657d 202d 2d7a 6f6e 6520 7573  {name} --zone us
+00005f60: 2d65 6173 742d 3261 2065 7861 6d70 6c65  -east-2a example
+00005f70: 732f 7065 725f 7265 6769 6f6e 5f69 6d61  s/per_region_ima
+00005f80: 6765 732e 7961 6d6c 272c 0a20 2020 2020  ges.yaml',.     
+00005f90: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
+00005fa0: 6320 7b6e 616d 657d 2065 7861 6d70 6c65  c {name} example
+00005fb0: 732f 7065 725f 7265 6769 6f6e 5f69 6d61  s/per_region_ima
+00005fc0: 6765 732e 7961 6d6c 272c 0a20 2020 2020  ges.yaml',.     
+00005fd0: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
+00005fe0: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
+00005ff0: 2061 7773 202d 2d72 6567 696f 6e20 7573   aws --region us
+00006000: 2d65 6173 742d 3220 226c 7320 7e22 272c  -east-2 "ls ~"',
+00006010: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00006020: 6b79 2065 7865 6320 7b6e 616d 657d 2022  ky exec {name} "
+00006030: 6c73 207e 2227 2c0a 2020 2020 2020 2020  ls ~"',.        
+00006040: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
+00006050: 6e61 6d65 7d20 3420 2d2d 7374 6174 7573  name} 4 --status
+00006060: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00006070: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
+00006080: 2035 202d 2d73 7461 7475 7327 2c0a 2020   5 --status',.  
+00006090: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+000060a0: 6c6f 6773 207b 6e61 6d65 7d20 3620 2d2d  logs {name} 6 --
+000060b0: 7374 6174 7573 272c 0a20 2020 2020 2020  status',.       
+000060c0: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+000060d0: 7b6e 616d 657d 2037 202d 2d73 7461 7475  {name} 7 --statu
+000060e0: 7327 2c0a 2020 2020 2020 2020 5d2c 0a20  s',.        ],. 
+000060f0: 2020 2020 2020 2066 2773 6b79 2064 6f77         f'sky dow
+00006100: 6e20 2d79 207b 6e61 6d65 7d27 2c0a 2020  n -y {name}',.  
+00006110: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
+00006120: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
+00006130: 7465 7374 2e6d 6172 6b2e 6763 700a 6465  test.mark.gcp.de
+00006140: 6620 7465 7374 5f67 6370 5f69 6d61 6765  f test_gcp_image
+00006150: 5f69 645f 6469 6374 5f7a 6f6e 6528 293a  _id_dict_zone():
+00006160: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
+00006170: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
+00006180: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
+00006190: 0a20 2020 2020 2020 2027 6763 705f 696d  .        'gcp_im
+000061a0: 6167 655f 6964 5f64 6963 745f 7a6f 6e65  age_id_dict_zone
+000061b0: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
+000061c0: 2020 2020 2020 2020 2023 2055 7365 207a           # Use z
+000061d0: 6f6e 6520 746f 2066 696c 7465 7220 696d  one to filter im
+000061e0: 6167 655f 6964 2064 6963 742e 0a20 2020  age_id dict..   
+000061f0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00006200: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
+00006210: 657d 202d 2d7a 6f6e 6520 7573 2d65 6173  e} --zone us-eas
+00006220: 7431 2d61 2074 6573 7473 2f74 6573 745f  t1-a tests/test_
+00006230: 7961 6d6c 732f 6763 705f 7065 725f 7265  yamls/gcp_per_re
+00006240: 6769 6f6e 5f69 6d61 6765 732e 7961 6d6c  gion_images.yaml
+00006250: 2026 2620 6578 6974 2031 207c 7c20 7472   && exit 1 || tr
+00006260: 7565 272c 0a20 2020 2020 2020 2020 2020  ue',.           
+00006270: 2066 2773 6b79 2073 7461 7475 7320 7c20   f'sky status | 
+00006280: 6772 6570 207b 6e61 6d65 7d20 2626 2065  grep {name} && e
+00006290: 7869 7420 3120 7c7c 2074 7275 6527 2c20  xit 1 || true', 
+000062a0: 2023 2045 6e73 7572 6520 7468 6520 636c   # Ensure the cl
+000062b0: 7573 7465 7220 6973 206e 6f74 2063 7265  uster is not cre
+000062c0: 6174 6564 2e0a 2020 2020 2020 2020 2020  ated..          
+000062d0: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
+000062e0: 7920 2d63 207b 6e61 6d65 7d20 2d2d 7a6f  y -c {name} --zo
+000062f0: 6e65 2075 732d 6365 6e74 7261 6c31 2d61  ne us-central1-a
+00006300: 2074 6573 7473 2f74 6573 745f 7961 6d6c   tests/test_yaml
+00006310: 732f 6763 705f 7065 725f 7265 6769 6f6e  s/gcp_per_region
+00006320: 5f69 6d61 6765 732e 7961 6d6c 272c 0a20  _images.yaml',. 
+00006330: 2020 2020 2020 2020 2020 2023 2053 686f             # Sho
+00006340: 756c 6420 7375 6363 6573 7320 6265 6361  uld success beca
+00006350: 7573 6520 7468 6520 696d 6167 6520 6964  use the image id
+00006360: 206d 6174 6368 2066 6f72 2074 6865 207a   match for the z
+00006370: 6f6e 652e 0a20 2020 2020 2020 2020 2020  one..           
+00006380: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
+00006390: 202d 6320 7b6e 616d 657d 202d 2d63 6c6f   -c {name} --clo
+000063a0: 7564 2067 6370 202d 2d69 6d61 6765 2d69  ud gcp --image-i
+000063b0: 6420 736b 7970 696c 6f74 3a63 7075 2d64  d skypilot:cpu-d
+000063c0: 6562 6961 6e2d 3130 2074 6573 7473 2f74  ebian-10 tests/t
+000063d0: 6573 745f 7961 6d6c 732f 6d69 6e69 6d61  est_yamls/minima
+000063e0: 6c2e 7961 6d6c 272c 0a20 2020 2020 2020  l.yaml',.       
+000063f0: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
+00006400: 7b6e 616d 657d 202d 2d63 6c6f 7564 2067  {name} --cloud g
+00006410: 6370 202d 2d69 6d61 6765 2d69 6420 736b  cp --image-id sk
+00006420: 7970 696c 6f74 3a63 7075 2d64 6562 6961  ypilot:cpu-debia
+00006430: 6e2d 3130 2074 6573 7473 2f74 6573 745f  n-10 tests/test_
+00006440: 7961 6d6c 732f 6d69 6e69 6d61 6c2e 7961  yamls/minimal.ya
+00006450: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
+00006460: 2023 2046 6169 6c20 6475 6520 746f 2069   # Fail due to i
+00006470: 6d61 6765 2069 6420 6d69 736d 6174 6368  mage id mismatch
+00006480: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
+00006490: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
+000064a0: 2d2d 636c 6f75 6420 6763 7020 2d2d 696d  --cloud gcp --im
+000064b0: 6167 652d 6964 2073 6b79 7069 6c6f 743a  age-id skypilot:
+000064c0: 6770 752d 6465 6269 616e 2d31 3020 7465  gpu-debian-10 te
+000064d0: 7374 732f 7465 7374 5f79 616d 6c73 2f6d  sts/test_yamls/m
+000064e0: 696e 696d 616c 2e79 616d 6c20 2626 2065  inimal.yaml && e
+000064f0: 7869 7420 3120 7c7c 2074 7275 6527 2c0a  xit 1 || true',.
+00006500: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00006510: 7920 6c6f 6773 207b 6e61 6d65 7d20 3120  y logs {name} 1 
+00006520: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
+00006530: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+00006540: 7320 7b6e 616d 657d 2032 202d 2d73 7461  s {name} 2 --sta
+00006550: 7475 7327 2c0a 2020 2020 2020 2020 2020  tus',.          
+00006560: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+00006570: 6d65 7d20 3320 2d2d 7374 6174 7573 272c  me} 3 --status',
+00006580: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00006590: 6b79 2073 7461 7475 7320 2d2d 616c 6c20  ky status --all 
+000065a0: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
+000065b0: 6772 6570 2075 732d 6365 6e74 7261 6c31  grep us-central1
+000065c0: 272c 2020 2320 456e 7375 7265 2074 6865  ',  # Ensure the
+000065d0: 207a 6f6e 6520 6973 2063 6f72 7265 6374   zone is correct
+000065e0: 2e0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+000065f0: 456e 7375 7265 2065 7865 6320 776f 726b  Ensure exec work
+00006600: 732e 0a20 2020 2020 2020 2020 2020 2066  s..            f
+00006610: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+00006620: 202d 2d63 6c6f 7564 2067 6370 202d 2d7a   --cloud gcp --z
+00006630: 6f6e 6520 7573 2d63 656e 7472 616c 312d  one us-central1-
+00006640: 6120 7465 7374 732f 7465 7374 5f79 616d  a tests/test_yam
+00006650: 6c73 2f67 6370 5f70 6572 5f72 6567 696f  ls/gcp_per_regio
+00006660: 6e5f 696d 6167 6573 2e79 616d 6c27 2c0a  n_images.yaml',.
+00006670: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00006680: 7920 6578 6563 207b 6e61 6d65 7d20 7465  y exec {name} te
+00006690: 7374 732f 7465 7374 5f79 616d 6c73 2f67  sts/test_yamls/g
+000066a0: 6370 5f70 6572 5f72 6567 696f 6e5f 696d  cp_per_region_im
+000066b0: 6167 6573 2e79 616d 6c27 2c0a 2020 2020  ages.yaml',.    
+000066c0: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
+000066d0: 6563 207b 6e61 6d65 7d20 2d2d 636c 6f75  ec {name} --clou
+000066e0: 6420 6763 7020 2d2d 7265 6769 6f6e 2075  d gcp --region u
+000066f0: 732d 6365 6e74 7261 6c31 2022 6c73 207e  s-central1 "ls ~
+00006700: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+00006710: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
+00006720: 7d20 226c 7320 7e22 272c 0a20 2020 2020  } "ls ~"',.     
+00006730: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+00006740: 7320 7b6e 616d 657d 2034 202d 2d73 7461  s {name} 4 --sta
+00006750: 7475 7327 2c0a 2020 2020 2020 2020 2020  tus',.          
+00006760: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+00006770: 6d65 7d20 3520 2d2d 7374 6174 7573 272c  me} 5 --status',
+00006780: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00006790: 6b79 206c 6f67 7320 7b6e 616d 657d 2036  ky logs {name} 6
+000067a0: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
+000067b0: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+000067c0: 6773 207b 6e61 6d65 7d20 3720 2d2d 7374  gs {name} 7 --st
+000067d0: 6174 7573 272c 0a20 2020 2020 2020 205d  atus',.        ]
+000067e0: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
+000067f0: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
+00006800: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+00006810: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+00006820: 4070 7974 6573 742e 6d61 726b 2e61 7773  @pytest.mark.aws
+00006830: 0a64 6566 2074 6573 745f 636c 6f6e 655f  .def test_clone_
+00006840: 6469 736b 5f61 7773 2829 3a0a 2020 2020  disk_aws():.    
+00006850: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
+00006860: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
+00006870: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+00006880: 2020 2020 2763 6c6f 6e65 5f64 6973 6b5f      'clone_disk_
+00006890: 6177 7327 2c0a 2020 2020 2020 2020 5b0a  aws',.        [.
+000068a0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+000068b0: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
+000068c0: 6e61 6d65 7d20 2d2d 636c 6f75 6420 6177  name} --cloud aw
+000068d0: 7320 2d2d 7265 6769 6f6e 2075 732d 6561  s --region us-ea
+000068e0: 7374 2d32 202d 2d72 6574 7279 2d75 6e74  st-2 --retry-unt
+000068f0: 696c 2d75 7020 2265 6368 6f20 6865 6c6c  il-up "echo hell
+00006900: 6f20 3e20 7e2f 7573 6572 5f66 696c 652e  o > ~/user_file.
+00006910: 7478 7422 272c 0a20 2020 2020 2020 2020  txt"',.         
+00006920: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
+00006930: 2d2d 636c 6f6e 652d 6469 736b 2d66 726f  --clone-disk-fro
+00006940: 6d20 7b6e 616d 657d 202d 7920 2d63 207b  m {name} -y -c {
+00006950: 6e61 6d65 7d2d 636c 6f6e 6520 2626 2065  name}-clone && e
+00006960: 7869 7420 3120 7c7c 2074 7275 6527 2c0a  xit 1 || true',.
+00006970: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00006980: 7920 7374 6f70 207b 6e61 6d65 7d20 2d79  y stop {name} -y
+00006990: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
+000069a0: 736c 6565 7020 3630 272c 0a20 2020 2020  sleep 60',.     
+000069b0: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
+000069c0: 6e63 6820 2d2d 636c 6f6e 652d 6469 736b  nch --clone-disk
+000069d0: 2d66 726f 6d20 7b6e 616d 657d 202d 7920  -from {name} -y 
+000069e0: 2d63 207b 6e61 6d65 7d2d 636c 6f6e 6520  -c {name}-clone 
+000069f0: 2d2d 636c 6f75 6420 6177 7320 2d64 202d  --cloud aws -d -
+00006a00: 2d72 6567 696f 6e20 7573 2d65 6173 742d  -region us-east-
+00006a10: 3220 2263 6174 207e 2f75 7365 725f 6669  2 "cat ~/user_fi
+00006a20: 6c65 2e74 7874 207c 2067 7265 7020 6865  le.txt | grep he
+00006a30: 6c6c 6f22 272c 0a20 2020 2020 2020 2020  llo"',.         
+00006a40: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
+00006a50: 2d2d 636c 6f6e 652d 6469 736b 2d66 726f  --clone-disk-fro
+00006a60: 6d20 7b6e 616d 657d 202d 7920 2d63 207b  m {name} -y -c {
+00006a70: 6e61 6d65 7d2d 636c 6f6e 652d 3220 2d2d  name}-clone-2 --
+00006a80: 636c 6f75 6420 6177 7320 2d64 202d 2d72  cloud aws -d --r
+00006a90: 6567 696f 6e20 7573 2d65 6173 742d 3220  egion us-east-2 
+00006aa0: 2263 6174 207e 2f75 7365 725f 6669 6c65  "cat ~/user_file
+00006ab0: 2e74 7874 207c 2067 7265 7020 6865 6c6c  .txt | grep hell
+00006ac0: 6f22 272c 0a20 2020 2020 2020 2020 2020  o"',.           
+00006ad0: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
+00006ae0: 657d 2d63 6c6f 6e65 2031 202d 2d73 7461  e}-clone 1 --sta
+00006af0: 7475 7327 2c0a 2020 2020 2020 2020 2020  tus',.          
+00006b00: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+00006b10: 6d65 7d2d 636c 6f6e 652d 3220 3120 2d2d  me}-clone-2 1 --
+00006b20: 7374 6174 7573 272c 0a20 2020 2020 2020  status',.       
+00006b30: 205d 2c0a 2020 2020 2020 2020 6627 736b   ],.        f'sk
+00006b40: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
+00006b50: 207b 6e61 6d65 7d2d 636c 6f6e 6520 7b6e   {name}-clone {n
+00006b60: 616d 657d 2d63 6c6f 6e65 2d32 272c 0a20  ame}-clone-2',. 
+00006b70: 2020 2020 2020 2074 696d 656f 7574 3d33         timeout=3
+00006b80: 3020 2a20 3630 2c0a 2020 2020 290a 2020  0 * 60,.    ).  
+00006b90: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+00006ba0: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
+00006bb0: 6172 6b2e 6763 700a 6465 6620 7465 7374  ark.gcp.def test
+00006bc0: 5f63 6c6f 6e65 5f64 6973 6b5f 6763 7028  _clone_disk_gcp(
+00006bd0: 293a 0a20 2020 206e 616d 6520 3d20 5f67  ):.    name = _g
+00006be0: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
+00006bf0: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
+00006c00: 7428 0a20 2020 2020 2020 2027 636c 6f6e  t(.        'clon
+00006c10: 655f 6469 736b 5f67 6370 272c 0a20 2020  e_disk_gcp',.   
+00006c20: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
+00006c30: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
+00006c40: 2d79 202d 6320 7b6e 616d 657d 202d 2d63  -y -c {name} --c
+00006c50: 6c6f 7564 2067 6370 202d 2d7a 6f6e 6520  loud gcp --zone 
+00006c60: 7573 2d65 6173 7431 2d62 202d 2d72 6574  us-east1-b --ret
+00006c70: 7279 2d75 6e74 696c 2d75 7020 2265 6368  ry-until-up "ech
+00006c80: 6f20 6865 6c6c 6f20 3e20 7e2f 7573 6572  o hello > ~/user
+00006c90: 5f66 696c 652e 7478 7422 272c 0a20 2020  _file.txt"',.   
+00006ca0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00006cb0: 6175 6e63 6820 2d2d 636c 6f6e 652d 6469  aunch --clone-di
+00006cc0: 736b 2d66 726f 6d20 7b6e 616d 657d 202d  sk-from {name} -
+00006cd0: 7920 2d63 207b 6e61 6d65 7d2d 636c 6f6e  y -c {name}-clon
+00006ce0: 6520 2626 2065 7869 7420 3120 7c7c 2074  e && exit 1 || t
+00006cf0: 7275 6527 2c0a 2020 2020 2020 2020 2020  rue',.          
+00006d00: 2020 6627 736b 7920 7374 6f70 207b 6e61    f'sky stop {na
+00006d10: 6d65 7d20 2d79 272c 0a20 2020 2020 2020  me} -y',.       
+00006d20: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
+00006d30: 6820 2d2d 636c 6f6e 652d 6469 736b 2d66  h --clone-disk-f
+00006d40: 726f 6d20 7b6e 616d 657d 202d 7920 2d63  rom {name} -y -c
+00006d50: 207b 6e61 6d65 7d2d 636c 6f6e 6520 2d2d   {name}-clone --
+00006d60: 636c 6f75 6420 6763 7020 2d2d 7a6f 6e65  cloud gcp --zone
+00006d70: 2075 732d 6365 6e74 7261 6c31 2d61 2022   us-central1-a "
+00006d80: 6361 7420 7e2f 7573 6572 5f66 696c 652e  cat ~/user_file.
+00006d90: 7478 7420 7c20 6772 6570 2068 656c 6c6f  txt | grep hello
+00006da0: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+00006db0: 6627 736b 7920 6c61 756e 6368 202d 2d63  f'sky launch --c
+00006dc0: 6c6f 6e65 2d64 6973 6b2d 6672 6f6d 207b  lone-disk-from {
+00006dd0: 6e61 6d65 7d20 2d79 202d 6320 7b6e 616d  name} -y -c {nam
+00006de0: 657d 2d63 6c6f 6e65 2d32 202d 2d63 6c6f  e}-clone-2 --clo
+00006df0: 7564 2067 6370 202d 2d7a 6f6e 6520 7573  ud gcp --zone us
+00006e00: 2d65 6173 7431 2d62 2022 6361 7420 7e2f  -east1-b "cat ~/
+00006e10: 7573 6572 5f66 696c 652e 7478 7420 7c20  user_file.txt | 
+00006e20: 6772 6570 2068 656c 6c6f 2227 2c0a 2020  grep hello"',.  
+00006e30: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00006e40: 6c6f 6773 207b 6e61 6d65 7d2d 636c 6f6e  logs {name}-clon
+00006e50: 6520 3120 2d2d 7374 6174 7573 272c 0a20  e 1 --status',. 
+00006e60: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00006e70: 206c 6f67 7320 7b6e 616d 657d 2d63 6c6f   logs {name}-clo
+00006e80: 6e65 2d32 2031 202d 2d73 7461 7475 7327  ne-2 1 --status'
+00006e90: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
+00006ea0: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
+00006eb0: 2d79 207b 6e61 6d65 7d20 7b6e 616d 657d  -y {name} {name}
+00006ec0: 2d63 6c6f 6e65 207b 6e61 6d65 7d2d 636c  -clone {name}-cl
+00006ed0: 6f6e 652d 3227 2c0a 2020 2020 290a 2020  one-2',.    ).  
+00006ee0: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+00006ef0: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
+00006f00: 6172 6b2e 6177 730a 6465 6620 7465 7374  ark.aws.def test
+00006f10: 5f69 6d61 6765 5f6e 6f5f 636f 6e64 6128  _image_no_conda(
+00006f20: 293a 0a20 2020 206e 616d 6520 3d20 5f67  ):.    name = _g
+00006f30: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
+00006f40: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
+00006f50: 7428 0a20 2020 2020 2020 2027 696d 6167  t(.        'imag
+00006f60: 655f 6e6f 5f63 6f6e 6461 272c 0a20 2020  e_no_conda',.   
+00006f70: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
+00006f80: 2020 2023 2055 7365 2069 6d61 6765 2069     # Use image i
+00006f90: 6420 6469 6374 2e0a 2020 2020 2020 2020  d dict..        
+00006fa0: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
+00006fb0: 202d 7920 2d63 207b 6e61 6d65 7d20 2d2d   -y -c {name} --
+00006fc0: 7265 6769 6f6e 2075 732d 6561 7374 2d32  region us-east-2
+00006fd0: 2065 7861 6d70 6c65 732f 7065 725f 7265   examples/per_re
+00006fe0: 6769 6f6e 5f69 6d61 6765 732e 7961 6d6c  gion_images.yaml
+00006ff0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00007000: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
+00007010: 2031 202d 2d73 7461 7475 7327 2c0a 2020   1 --status',.  
+00007020: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00007030: 7374 6f70 207b 6e61 6d65 7d20 2d79 272c  stop {name} -y',
+00007040: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00007050: 6b79 2073 7461 7274 207b 6e61 6d65 7d20  ky start {name} 
+00007060: 2d79 272c 0a20 2020 2020 2020 2020 2020  -y',.           
+00007070: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
+00007080: 657d 2065 7861 6d70 6c65 732f 7065 725f  e} examples/per_
+00007090: 7265 6769 6f6e 5f69 6d61 6765 732e 7961  region_images.ya
+000070a0: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
+000070b0: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
+000070c0: 657d 2032 202d 2d73 7461 7475 7327 2c0a  e} 2 --status',.
+000070d0: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
+000070e0: 2020 2066 2773 6b79 2064 6f77 6e20 2d79     f'sky down -y
+000070f0: 207b 6e61 6d65 7d27 2c0a 2020 2020 290a   {name}',.    ).
+00007100: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
+00007110: 2874 6573 7429 0a0a 0a40 7079 7465 7374  (test)...@pytest
+00007120: 2e6d 6172 6b2e 6e6f 5f6b 7562 6572 6e65  .mark.no_kuberne
+00007130: 7465 7320 2023 204b 7562 6572 6e65 7465  tes  # Kubernete
+00007140: 7320 646f 6573 206e 6f74 2073 7570 706f  s does not suppo
+00007150: 7274 2073 746f 7070 696e 6720 696e 7374  rt stopping inst
+00007160: 616e 6365 730a 6465 6620 7465 7374 5f63  ances.def test_c
+00007170: 7573 746f 6d5f 6465 6661 756c 745f 636f  ustom_default_co
+00007180: 6e64 615f 656e 7628 6765 6e65 7269 635f  nda_env(generic_
+00007190: 636c 6f75 643a 2073 7472 293a 0a20 2020  cloud: str):.   
+000071a0: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
+000071b0: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
+000071c0: 7465 7374 203d 2054 6573 7428 2763 7573  test = Test('cus
+000071d0: 746f 6d5f 6465 6661 756c 745f 636f 6e64  tom_default_cond
+000071e0: 615f 656e 7627 2c20 5b0a 2020 2020 2020  a_env', [.      
+000071f0: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
+00007200: 6320 7b6e 616d 657d 202d 7920 2d2d 636c  c {name} -y --cl
+00007210: 6f75 6420 7b67 656e 6572 6963 5f63 6c6f  oud {generic_clo
+00007220: 7564 7d20 7465 7374 732f 7465 7374 5f79  ud} tests/test_y
+00007230: 616d 6c73 2f74 6573 745f 6375 7374 6f6d  amls/test_custom
+00007240: 5f64 6566 6175 6c74 5f63 6f6e 6461 5f65  _default_conda_e
+00007250: 6e76 2e79 616d 6c27 2c0a 2020 2020 2020  nv.yaml',.      
+00007260: 2020 6627 736b 7920 7374 6174 7573 202d    f'sky status -
+00007270: 7220 7b6e 616d 657d 207c 2067 7265 7020  r {name} | grep 
+00007280: 2255 5022 272c 0a20 2020 2020 2020 2066  "UP"',.        f
+00007290: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
+000072a0: 2031 202d 2d73 7461 7475 7327 2c0a 2020   1 --status',.  
+000072b0: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
+000072c0: 207b 6e61 6d65 7d20 3120 2d2d 6e6f 2d66   {name} 1 --no-f
+000072d0: 6f6c 6c6f 7720 7c20 6772 6570 202d 5020  ollow | grep -P 
+000072e0: 226d 7965 6e76 5c5c 732b 5c5c 2a22 272c  "myenv\\s+\\*"',
+000072f0: 0a20 2020 2020 2020 2066 2773 6b79 2065  .        f'sky e
+00007300: 7865 6320 7b6e 616d 657d 2074 6573 7473  xec {name} tests
+00007310: 2f74 6573 745f 7961 6d6c 732f 7465 7374  /test_yamls/test
+00007320: 5f63 7573 746f 6d5f 6465 6661 756c 745f  _custom_default_
+00007330: 636f 6e64 615f 656e 762e 7961 6d6c 272c  conda_env.yaml',
+00007340: 0a20 2020 2020 2020 2066 2773 6b79 206c  .        f'sky l
+00007350: 6f67 7320 7b6e 616d 657d 2032 202d 2d73  ogs {name} 2 --s
+00007360: 7461 7475 7327 2c0a 2020 2020 2020 2020  tatus',.        
+00007370: 6627 736b 7920 6175 746f 7374 6f70 202d  f'sky autostop -
+00007380: 7920 2d69 2030 207b 6e61 6d65 7d27 2c0a  y -i 0 {name}',.
+00007390: 2020 2020 2020 2020 2773 6c65 6570 2036          'sleep 6
+000073a0: 3027 2c0a 2020 2020 2020 2020 6627 736b  0',.        f'sk
+000073b0: 7920 7374 6174 7573 202d 7220 7b6e 616d  y status -r {nam
+000073c0: 657d 207c 2067 7265 7020 2253 544f 5050  e} | grep "STOPP
+000073d0: 4544 2227 2c0a 2020 2020 2020 2020 6627  ED"',.        f'
+000073e0: 736b 7920 7374 6172 7420 2d79 207b 6e61  sky start -y {na
+000073f0: 6d65 7d27 2c0a 2020 2020 2020 2020 6627  me}',.        f'
+00007400: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
+00007410: 3220 2d2d 6e6f 2d66 6f6c 6c6f 7720 7c20  2 --no-follow | 
+00007420: 6772 6570 202d 5020 226d 7965 6e76 5c5c  grep -P "myenv\\
+00007430: 732b 5c5c 2a22 272c 0a20 2020 2020 2020  s+\\*"',.       
+00007440: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
+00007450: 657d 2074 6573 7473 2f74 6573 745f 7961  e} tests/test_ya
+00007460: 6d6c 732f 7465 7374 5f63 7573 746f 6d5f  mls/test_custom_
+00007470: 6465 6661 756c 745f 636f 6e64 615f 656e  default_conda_en
+00007480: 762e 7961 6d6c 272c 0a20 2020 2020 2020  v.yaml',.       
+00007490: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
+000074a0: 657d 2033 202d 2d73 7461 7475 7327 2c0a  e} 3 --status',.
+000074b0: 2020 2020 5d2c 2066 2773 6b79 2064 6f77      ], f'sky dow
+000074c0: 6e20 2d79 207b 6e61 6d65 7d27 290a 2020  n -y {name}').  
+000074d0: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+000074e0: 6573 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d  est)...# -------
+000074f0: 2d2d 2d2d 2d20 5465 7374 2073 7461 6c65  ----- Test stale
+00007500: 206a 6f62 202d 2d2d 2d2d 2d2d 2d2d 2d2d   job -----------
+00007510: 2d0a 4070 7974 6573 742e 6d61 726b 2e6e  -.@pytest.mark.n
+00007520: 6f5f 666c 7569 6473 7461 636b 2020 2320  o_fluidstack  # 
+00007530: 466c 7569 6453 7461 636b 2064 6f65 7320  FluidStack does 
+00007540: 6e6f 7420 7375 7070 6f72 7420 7374 6f70  not support stop
+00007550: 7069 6e67 2069 6e73 7461 6e63 6573 2069  ping instances i
+00007560: 6e20 536b 7950 696c 6f74 2069 6d70 6c65  n SkyPilot imple
+00007570: 6d65 6e74 6174 696f 6e0a 4070 7974 6573  mentation.@pytes
+00007580: 742e 6d61 726b 2e6e 6f5f 6c61 6d62 6461  t.mark.no_lambda
+00007590: 5f63 6c6f 7564 2020 2320 4c61 6d62 6461  _cloud  # Lambda
+000075a0: 2043 6c6f 7564 2064 6f65 7320 6e6f 7420   Cloud does not 
+000075b0: 7375 7070 6f72 7420 7374 6f70 7069 6e67  support stopping
+000075c0: 2069 6e73 7461 6e63 6573 0a40 7079 7465   instances.@pyte
+000075d0: 7374 2e6d 6172 6b2e 6e6f 5f6b 7562 6572  st.mark.no_kuber
+000075e0: 6e65 7465 7320 2023 204b 7562 6572 6e65  netes  # Kuberne
+000075f0: 7465 7320 646f 6573 206e 6f74 2073 7570  tes does not sup
+00007600: 706f 7274 2073 746f 7070 696e 6720 696e  port stopping in
+00007610: 7374 616e 6365 730a 6465 6620 7465 7374  stances.def test
+00007620: 5f73 7461 6c65 5f6a 6f62 2867 656e 6572  _stale_job(gener
+00007630: 6963 5f63 6c6f 7564 3a20 7374 7229 3a0a  ic_cloud: str):.
+00007640: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
+00007650: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
+00007660: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
+00007670: 2020 2020 2020 2020 2773 7461 6c65 5f6a          'stale_j
+00007680: 6f62 272c 0a20 2020 2020 2020 205b 0a20  ob',.        [. 
+00007690: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+000076a0: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
+000076b0: 616d 657d 202d 2d63 6c6f 7564 207b 6765  ame} --cloud {ge
+000076c0: 6e65 7269 635f 636c 6f75 647d 2022 6563  neric_cloud} "ec
+000076d0: 686f 2068 6922 272c 0a20 2020 2020 2020  ho hi"',.       
+000076e0: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
+000076f0: 7b6e 616d 657d 202d 6420 2265 6368 6f20  {name} -d "echo 
+00007700: 7374 6172 743b 2073 6c65 6570 2031 3030  start; sleep 100
+00007710: 3030 2227 2c0a 2020 2020 2020 2020 2020  00"',.          
+00007720: 2020 6627 736b 7920 7374 6f70 207b 6e61    f'sky stop {na
+00007730: 6d65 7d20 2d79 272c 0a20 2020 2020 2020  me} -y',.       
+00007740: 2020 2020 2027 736c 6565 7020 3130 3027       'sleep 100'
+00007750: 2c20 2023 2045 6e73 7572 6520 7468 6973  ,  # Ensure this
+00007760: 2069 7320 6c61 7267 6520 656e 6f75 6768   is large enough
+00007770: 2c20 656c 7365 2047 4350 206c 6561 6b73  , else GCP leaks
+00007780: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
+00007790: 736b 7920 7374 6172 7420 7b6e 616d 657d  sky start {name}
+000077a0: 202d 7927 2c0a 2020 2020 2020 2020 2020   -y',.          
+000077b0: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+000077c0: 6d65 7d20 3120 2d2d 7374 6174 7573 272c  me} 1 --status',
+000077d0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+000077e0: 3d24 2873 6b79 2071 7565 7565 207b 6e61  =$(sky queue {na
+000077f0: 6d65 7d29 3b20 6563 686f 2022 2473 223b  me}); echo "$s";
+00007800: 2065 6368 6f3b 2065 6368 6f3b 2065 6368   echo; echo; ech
+00007810: 6f20 2224 7322 207c 2067 7265 7020 4641  o "$s" | grep FA
+00007820: 494c 4544 272c 0a20 2020 2020 2020 205d  ILED',.        ]
+00007830: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
+00007840: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
+00007850: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+00007860: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+00007870: 4070 7974 6573 742e 6d61 726b 2e61 7773  @pytest.mark.aws
+00007880: 0a64 6566 2074 6573 745f 6177 735f 7374  .def test_aws_st
+00007890: 616c 655f 6a6f 625f 6d61 6e75 616c 5f72  ale_job_manual_r
+000078a0: 6573 7461 7274 2829 3a0a 2020 2020 6e61  estart():.    na
+000078b0: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
+000078c0: 725f 6e61 6d65 2829 0a20 2020 206e 616d  r_name().    nam
+000078d0: 655f 6f6e 5f63 6c6f 7564 203d 2063 6f6d  e_on_cloud = com
+000078e0: 6d6f 6e5f 7574 696c 732e 6d61 6b65 5f63  mon_utils.make_c
+000078f0: 6c75 7374 6572 5f6e 616d 655f 6f6e 5f63  luster_name_on_c
+00007900: 6c6f 7564 280a 2020 2020 2020 2020 6e61  loud(.        na
+00007910: 6d65 2c20 736b 792e 4157 532e 6d61 785f  me, sky.AWS.max_
+00007920: 636c 7573 7465 725f 6e61 6d65 5f6c 656e  cluster_name_len
+00007930: 6774 6828 2929 0a20 2020 2072 6567 696f  gth()).    regio
+00007940: 6e20 3d20 2775 732d 6561 7374 2d32 270a  n = 'us-east-2'.
+00007950: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
+00007960: 0a20 2020 2020 2020 2027 6177 735f 7374  .        'aws_st
+00007970: 616c 655f 6a6f 625f 6d61 6e75 616c 5f72  ale_job_manual_r
+00007980: 6573 7461 7274 272c 0a20 2020 2020 2020  estart',.       
+00007990: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
+000079a0: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
+000079b0: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
+000079c0: 2061 7773 202d 2d72 6567 696f 6e20 7b72   aws --region {r
+000079d0: 6567 696f 6e7d 2022 6563 686f 2068 6922  egion} "echo hi"
+000079e0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+000079f0: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+00007a00: 202d 6420 2265 6368 6f20 7374 6172 743b   -d "echo start;
+00007a10: 2073 6c65 6570 2031 3030 3030 2227 2c0a   sleep 10000"',.
+00007a20: 2020 2020 2020 2020 2020 2020 2320 5374              # St
+00007a30: 6f70 2074 6865 2063 6c75 7374 6572 206d  op the cluster m
+00007a40: 616e 7561 6c6c 792e 0a20 2020 2020 2020  anually..       
+00007a50: 2020 2020 2066 2769 643d 6061 7773 2065       f'id=`aws e
+00007a60: 6332 2064 6573 6372 6962 652d 696e 7374  c2 describe-inst
+00007a70: 616e 6365 7320 2d2d 7265 6769 6f6e 207b  ances --region {
+00007a80: 7265 6769 6f6e 7d20 2d2d 6669 6c74 6572  region} --filter
+00007a90: 7320 270a 2020 2020 2020 2020 2020 2020  s '.            
+00007aa0: 6627 4e61 6d65 3d74 6167 3a72 6179 2d63  f'Name=tag:ray-c
+00007ab0: 6c75 7374 6572 2d6e 616d 652c 5661 6c75  luster-name,Valu
+00007ac0: 6573 3d7b 6e61 6d65 5f6f 6e5f 636c 6f75  es={name_on_clou
+00007ad0: 647d 2027 0a20 2020 2020 2020 2020 2020  d} '.           
+00007ae0: 2066 272d 2d71 7565 7279 2052 6573 6572   f'--query Reser
+00007af0: 7661 7469 6f6e 735b 5d2e 496e 7374 616e  vations[].Instan
+00007b00: 6365 735b 5d2e 496e 7374 616e 6365 4964  ces[].InstanceId
+00007b10: 2027 0a20 2020 2020 2020 2020 2020 2027   '.            '
+00007b20: 2d2d 6f75 7470 7574 2074 6578 7460 3b20  --output text`; 
+00007b30: 270a 2020 2020 2020 2020 2020 2020 6627  '.            f'
+00007b40: 6177 7320 6563 3220 7374 6f70 2d69 6e73  aws ec2 stop-ins
+00007b50: 7461 6e63 6573 202d 2d72 6567 696f 6e20  tances --region 
+00007b60: 7b72 6567 696f 6e7d 2027 0a20 2020 2020  {region} '.     
+00007b70: 2020 2020 2020 2027 2d2d 696e 7374 616e         '--instan
+00007b80: 6365 2d69 6473 2024 6964 272c 0a20 2020  ce-ids $id',.   
+00007b90: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
+00007ba0: 3430 272c 0a20 2020 2020 2020 2020 2020  40',.           
+00007bb0: 2066 2773 6b79 206c 6175 6e63 6820 2d63   f'sky launch -c
+00007bc0: 207b 6e61 6d65 7d20 2d79 2022 6563 686f   {name} -y "echo
+00007bd0: 2068 6922 272c 0a20 2020 2020 2020 2020   hi"',.         
+00007be0: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+00007bf0: 616d 657d 2031 202d 2d73 7461 7475 7327  ame} 1 --status'
+00007c00: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00007c10: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
+00007c20: 3320 2d2d 7374 6174 7573 272c 0a20 2020  3 --status',.   
+00007c30: 2020 2020 2020 2020 2023 2045 6e73 7572           # Ensur
+00007c40: 6520 7468 6520 736b 796c 6574 2075 7064  e the skylet upd
+00007c50: 6174 6564 2074 6865 2073 7461 6c65 206a  ated the stale j
+00007c60: 6f62 2073 7461 7475 732e 0a20 2020 2020  ob status..     
+00007c70: 2020 2020 2020 2066 2773 6c65 6570 207b         f'sleep {
+00007c80: 6576 656e 7473 2e4a 6f62 5363 6865 6475  events.JobSchedu
+00007c90: 6c65 7245 7665 6e74 2e45 5645 4e54 5f49  lerEvent.EVENT_I
+00007ca0: 4e54 4552 5641 4c5f 5345 434f 4e44 537d  NTERVAL_SECONDS}
+00007cb0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00007cc0: 2773 3d24 2873 6b79 2071 7565 7565 207b  's=$(sky queue {
+00007cd0: 6e61 6d65 7d29 3b20 6563 686f 2022 2473  name}); echo "$s
+00007ce0: 223b 2065 6368 6f3b 2065 6368 6f3b 2065  "; echo; echo; e
+00007cf0: 6368 6f20 2224 7322 207c 2067 7265 7020  cho "$s" | grep 
+00007d00: 4641 494c 4544 272c 0a20 2020 2020 2020  FAILED',.       
+00007d10: 205d 2c0a 2020 2020 2020 2020 6627 736b   ],.        f'sk
+00007d20: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
+00007d30: 272c 0a20 2020 2029 0a20 2020 2072 756e  ',.    ).    run
+00007d40: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
+00007d50: 0a0a 4070 7974 6573 742e 6d61 726b 2e67  ..@pytest.mark.g
+00007d60: 6370 0a64 6566 2074 6573 745f 6763 705f  cp.def test_gcp_
+00007d70: 7374 616c 655f 6a6f 625f 6d61 6e75 616c  stale_job_manual
+00007d80: 5f72 6573 7461 7274 2829 3a0a 2020 2020  _restart():.    
+00007d90: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
+00007da0: 7465 725f 6e61 6d65 2829 0a20 2020 206e  ter_name().    n
+00007db0: 616d 655f 6f6e 5f63 6c6f 7564 203d 2063  ame_on_cloud = c
+00007dc0: 6f6d 6d6f 6e5f 7574 696c 732e 6d61 6b65  ommon_utils.make
+00007dd0: 5f63 6c75 7374 6572 5f6e 616d 655f 6f6e  _cluster_name_on
+00007de0: 5f63 6c6f 7564 280a 2020 2020 2020 2020  _cloud(.        
+00007df0: 6e61 6d65 2c20 736b 792e 4743 502e 6d61  name, sky.GCP.ma
+00007e00: 785f 636c 7573 7465 725f 6e61 6d65 5f6c  x_cluster_name_l
+00007e10: 656e 6774 6828 2929 0a20 2020 207a 6f6e  ength()).    zon
+00007e20: 6520 3d20 2775 732d 7765 7374 322d 6127  e = 'us-west2-a'
+00007e30: 0a20 2020 2071 7565 7279 5f63 6d64 203d  .    query_cmd =
+00007e40: 2028 6627 6763 6c6f 7564 2063 6f6d 7075   (f'gcloud compu
+00007e50: 7465 2069 6e73 7461 6e63 6573 206c 6973  te instances lis
+00007e60: 7420 2d2d 6669 6c74 6572 3d27 0a20 2020  t --filter='.   
+00007e70: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+00007e80: 2228 6c61 6265 6c73 2e72 6179 2d63 6c75  "(labels.ray-clu
+00007e90: 7374 6572 2d6e 616d 653d 7b6e 616d 655f  ster-name={name_
+00007ea0: 6f6e 5f63 6c6f 7564 7d29 2220 270a 2020  on_cloud})" '.  
+00007eb0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00007ec0: 272d 2d7a 6f6e 6573 3d7b 7a6f 6e65 7d20  '--zones={zone} 
+00007ed0: 2d2d 666f 726d 6174 3d22 7661 6c75 6528  --format="value(
+00007ee0: 6e61 6d65 2922 2729 0a20 2020 2073 746f  name)"').    sto
+00007ef0: 705f 636d 6420 3d20 2866 2767 636c 6f75  p_cmd = (f'gclou
+00007f00: 6420 636f 6d70 7574 6520 696e 7374 616e  d compute instan
+00007f10: 6365 7320 7374 6f70 202d 2d7a 6f6e 653d  ces stop --zone=
+00007f20: 7b7a 6f6e 657d 270a 2020 2020 2020 2020  {zone}'.        
+00007f30: 2020 2020 2020 2020 6627 202d 2d71 7569          f' --qui
+00007f40: 6574 2024 287b 7175 6572 795f 636d 647d  et $({query_cmd}
+00007f50: 2927 290a 2020 2020 7465 7374 203d 2054  )').    test = T
+00007f60: 6573 7428 0a20 2020 2020 2020 2027 6763  est(.        'gc
+00007f70: 705f 7374 616c 655f 6a6f 625f 6d61 6e75  p_stale_job_manu
+00007f80: 616c 5f72 6573 7461 7274 272c 0a20 2020  al_restart',.   
+00007f90: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
+00007fa0: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
+00007fb0: 2d79 202d 6320 7b6e 616d 657d 202d 2d63  -y -c {name} --c
+00007fc0: 6c6f 7564 2067 6370 202d 2d7a 6f6e 6520  loud gcp --zone 
+00007fd0: 7b7a 6f6e 657d 2022 6563 686f 2068 6922  {zone} "echo hi"
+00007fe0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00007ff0: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+00008000: 202d 6420 2265 6368 6f20 7374 6172 743b   -d "echo start;
+00008010: 2073 6c65 6570 2031 3030 3030 2227 2c0a   sleep 10000"',.
+00008020: 2020 2020 2020 2020 2020 2020 2320 5374              # St
+00008030: 6f70 2074 6865 2063 6c75 7374 6572 206d  op the cluster m
+00008040: 616e 7561 6c6c 792e 0a20 2020 2020 2020  anually..       
+00008050: 2020 2020 2073 746f 705f 636d 642c 0a20       stop_cmd,. 
+00008060: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+00008070: 7020 3430 272c 0a20 2020 2020 2020 2020  p 40',.         
+00008080: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
+00008090: 2d63 207b 6e61 6d65 7d20 2d79 2022 6563  -c {name} -y "ec
+000080a0: 686f 2068 6922 272c 0a20 2020 2020 2020  ho hi"',.       
+000080b0: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+000080c0: 7b6e 616d 657d 2031 202d 2d73 7461 7475  {name} 1 --statu
+000080d0: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
+000080e0: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+000080f0: 7d20 3320 2d2d 7374 6174 7573 272c 0a20  } 3 --status',. 
+00008100: 2020 2020 2020 2020 2020 2023 2045 6e73             # Ens
+00008110: 7572 6520 7468 6520 736b 796c 6574 2075  ure the skylet u
+00008120: 7064 6174 6564 2074 6865 2073 7461 6c65  pdated the stale
+00008130: 206a 6f62 2073 7461 7475 732e 0a20 2020   job status..   
+00008140: 2020 2020 2020 2020 2066 2773 6c65 6570           f'sleep
+00008150: 207b 6576 656e 7473 2e4a 6f62 5363 6865   {events.JobSche
+00008160: 6475 6c65 7245 7665 6e74 2e45 5645 4e54  dulerEvent.EVENT
+00008170: 5f49 4e54 4552 5641 4c5f 5345 434f 4e44  _INTERVAL_SECOND
+00008180: 537d 272c 0a20 2020 2020 2020 2020 2020  S}',.           
+00008190: 2066 2773 3d24 2873 6b79 2071 7565 7565   f's=$(sky queue
+000081a0: 207b 6e61 6d65 7d29 3b20 6563 686f 2022   {name}); echo "
+000081b0: 2473 223b 2065 6368 6f3b 2065 6368 6f3b  $s"; echo; echo;
+000081c0: 2065 6368 6f20 2224 7322 207c 2067 7265   echo "$s" | gre
+000081d0: 7020 4641 494c 4544 272c 0a20 2020 2020  p FAILED',.     
+000081e0: 2020 205d 2c0a 2020 2020 2020 2020 6627     ],.        f'
+000081f0: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
+00008200: 657d 272c 0a20 2020 2029 0a20 2020 2072  e}',.    ).    r
+00008210: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
+00008220: 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d  )...# ----------
+00008230: 2043 6865 636b 2053 6b79 2773 2065 6e76   Check Sky's env
+00008240: 6972 6f6e 6d65 6e74 2076 6172 6961 626c  ironment variabl
+00008250: 6573 3b20 776f 726b 6469 722e 202d 2d2d  es; workdir. ---
+00008260: 2d2d 2d2d 2d2d 2d0a 4070 7974 6573 742e  -------.@pytest.
+00008270: 6d61 726b 2e6e 6f5f 666c 7569 6473 7461  mark.no_fluidsta
+00008280: 636b 2020 2320 5265 7175 6972 6573 2061  ck  # Requires a
+00008290: 6d61 7a6f 6e20 5333 0a40 7079 7465 7374  mazon S3.@pytest
+000082a0: 2e6d 6172 6b2e 6e6f 5f73 6370 2020 2320  .mark.no_scp  # 
+000082b0: 5343 5020 646f 6573 206e 6f74 2073 7570  SCP does not sup
+000082c0: 706f 7274 206e 756d 5f6e 6f64 6573 203e  port num_nodes >
+000082d0: 2031 2079 6574 0a64 6566 2074 6573 745f   1 yet.def test_
+000082e0: 656e 765f 6368 6563 6b28 6765 6e65 7269  env_check(generi
+000082f0: 635f 636c 6f75 643a 2073 7472 293a 0a20  c_cloud: str):. 
+00008300: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
+00008310: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
+00008320: 2020 746f 7461 6c5f 7469 6d65 6f75 745f    total_timeout_
+00008330: 6d69 6e75 7465 7320 3d20 3235 2069 6620  minutes = 25 if 
+00008340: 6765 6e65 7269 635f 636c 6f75 6420 3d3d  generic_cloud ==
+00008350: 2027 617a 7572 6527 2065 6c73 6520 3135   'azure' else 15
+00008360: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
+00008370: 280a 2020 2020 2020 2020 2765 6e76 5f63  (.        'env_c
+00008380: 6865 636b 272c 0a20 2020 2020 2020 205b  heck',.        [
+00008390: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+000083a0: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
+000083b0: 7b6e 616d 657d 202d 2d63 6c6f 7564 207b  {name} --cloud {
+000083c0: 6765 6e65 7269 635f 636c 6f75 647d 202d  generic_cloud} -
+000083d0: 2d64 6574 6163 682d 7365 7475 7020 6578  -detach-setup ex
+000083e0: 616d 706c 6573 2f65 6e76 5f63 6865 636b  amples/env_check
+000083f0: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
+00008400: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
+00008410: 6e61 6d65 7d20 3120 2d2d 7374 6174 7573  name} 1 --status
+00008420: 272c 2020 2320 456e 7375 7265 2074 6865  ',  # Ensure the
+00008430: 206a 6f62 2073 7563 6365 6564 6564 2e0a   job succeeded..
+00008440: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
+00008450: 2020 2066 2773 6b79 2064 6f77 6e20 2d79     f'sky down -y
+00008460: 207b 6e61 6d65 7d27 2c0a 2020 2020 2020   {name}',.      
+00008470: 2020 7469 6d65 6f75 743d 746f 7461 6c5f    timeout=total_
+00008480: 7469 6d65 6f75 745f 6d69 6e75 7465 7320  timeout_minutes 
+00008490: 2a20 3630 2c0a 2020 2020 290a 2020 2020  * 60,.    ).    
+000084a0: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
+000084b0: 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d  t)...# ---------
+000084c0: 2d20 6669 6c65 5f6d 6f75 6e74 7320 2d2d  - file_mounts --
+000084d0: 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465 7374  --------.@pytest
+000084e0: 2e6d 6172 6b2e 6e6f 5f73 6370 2020 2320  .mark.no_scp  # 
+000084f0: 5343 5020 646f 6573 206e 6f74 2073 7570  SCP does not sup
+00008500: 706f 7274 206e 756d 5f6e 6f64 6573 203e  port num_nodes >
+00008510: 2031 2079 6574 2e20 5275 6e20 7465 7374   1 yet. Run test
+00008520: 5f73 6370 5f66 696c 655f 6d6f 756e 7473  _scp_file_mounts
+00008530: 2069 6e73 7465 6164 2e0a 6465 6620 7465   instead..def te
+00008540: 7374 5f66 696c 655f 6d6f 756e 7473 2867  st_file_mounts(g
+00008550: 656e 6572 6963 5f63 6c6f 7564 3a20 7374  eneric_cloud: st
+00008560: 7229 3a0a 2020 2020 6e61 6d65 203d 205f  r):.    name = _
+00008570: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
+00008580: 2829 0a20 2020 2065 7874 7261 5f66 6c61  ().    extra_fla
+00008590: 6773 203d 2027 270a 2020 2020 6966 2067  gs = ''.    if g
+000085a0: 656e 6572 6963 5f63 6c6f 7564 2069 6e20  eneric_cloud in 
+000085b0: 276b 7562 6572 6e65 7465 7327 3a0a 2020  'kubernetes':.  
+000085c0: 2020 2020 2020 2320 4b75 6265 726e 6574        # Kubernet
+000085d0: 6573 2064 6f65 7320 6e6f 7420 7375 7070  es does not supp
+000085e0: 6f72 7420 6d75 6c74 692d 6e6f 6465 0a20  ort multi-node. 
+000085f0: 2020 2020 2020 2023 204e 4f54 453a 2054         # NOTE: T
+00008600: 6869 7320 7465 7374 2077 696c 6c20 6661  his test will fa
+00008610: 696c 2069 6620 796f 7520 6861 7665 2061  il if you have a
+00008620: 204b 7562 6572 6e65 7465 7320 636c 7573   Kubernetes clus
+00008630: 7465 7220 7275 6e6e 696e 6720 6f6e 0a20  ter running on. 
+00008640: 2020 2020 2020 2023 2020 6172 6d36 3420         #  arm64 
+00008650: 2865 2e67 2e2c 2041 7070 6c65 2053 696c  (e.g., Apple Sil
+00008660: 6963 6f6e 2920 7369 6e63 6520 676f 6f66  icon) since goof
+00008670: 7973 2064 6f65 7320 6e6f 7420 776f 726b  ys does not work
+00008680: 206f 6e20 6172 6d36 342e 0a20 2020 2020   on arm64..     
+00008690: 2020 2065 7874 7261 5f66 6c61 6773 203d     extra_flags =
+000086a0: 2027 2d2d 6e75 6d2d 6e6f 6465 7320 3127   '--num-nodes 1'
+000086b0: 0a20 2020 2074 6573 745f 636f 6d6d 616e  .    test_comman
+000086c0: 6473 203d 205b 0a20 2020 2020 2020 202a  ds = [.        *
+000086d0: 7374 6f72 6167 655f 7365 7475 705f 636f  storage_setup_co
+000086e0: 6d6d 616e 6473 2c0a 2020 2020 2020 2020  mmands,.        
+000086f0: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
+00008700: 2d63 207b 6e61 6d65 7d20 2d2d 636c 6f75  -c {name} --clou
+00008710: 6420 7b67 656e 6572 6963 5f63 6c6f 7564  d {generic_cloud
+00008720: 7d20 7b65 7874 7261 5f66 6c61 6773 7d20  } {extra_flags} 
+00008730: 6578 616d 706c 6573 2f75 7369 6e67 5f66  examples/using_f
+00008740: 696c 655f 6d6f 756e 7473 2e79 616d 6c27  ile_mounts.yaml'
+00008750: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
+00008760: 6c6f 6773 207b 6e61 6d65 7d20 3120 2d2d  logs {name} 1 --
+00008770: 7374 6174 7573 272c 2020 2320 456e 7375  status',  # Ensu
+00008780: 7265 2074 6865 206a 6f62 2073 7563 6365  re the job succe
+00008790: 6564 6564 2e0a 2020 2020 5d0a 2020 2020  eded..    ].    
+000087a0: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
+000087b0: 2020 2020 2027 7573 696e 675f 6669 6c65       'using_file
+000087c0: 5f6d 6f75 6e74 7327 2c0a 2020 2020 2020  _mounts',.      
+000087d0: 2020 7465 7374 5f63 6f6d 6d61 6e64 732c    test_commands,
+000087e0: 0a20 2020 2020 2020 2066 2773 6b79 2064  .        f'sky d
+000087f0: 6f77 6e20 2d79 207b 6e61 6d65 7d27 2c0a  own -y {name}',.
+00008800: 2020 2020 2020 2020 5f67 6574 5f74 696d          _get_tim
+00008810: 656f 7574 2867 656e 6572 6963 5f63 6c6f  eout(generic_clo
+00008820: 7564 2c20 3230 202a 2036 3029 2c20 2023  ud, 20 * 60),  #
+00008830: 2032 3020 6d69 6e73 0a20 2020 2029 0a20   20 mins.    ). 
+00008840: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+00008850: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
+00008860: 6d61 726b 2e73 6370 0a64 6566 2074 6573  mark.scp.def tes
+00008870: 745f 7363 705f 6669 6c65 5f6d 6f75 6e74  t_scp_file_mount
+00008880: 7328 293a 0a20 2020 206e 616d 6520 3d20  s():.    name = 
+00008890: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
+000088a0: 6528 290a 2020 2020 7465 7374 5f63 6f6d  e().    test_com
+000088b0: 6d61 6e64 7320 3d20 5b0a 2020 2020 2020  mands = [.      
+000088c0: 2020 2a73 746f 7261 6765 5f73 6574 7570    *storage_setup
+000088d0: 5f63 6f6d 6d61 6e64 732c 0a20 2020 2020  _commands,.     
+000088e0: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
+000088f0: 2d79 202d 6320 7b6e 616d 657d 207b 5343  -y -c {name} {SC
+00008900: 505f 5459 5045 7d20 2d2d 6e75 6d2d 6e6f  P_TYPE} --num-no
+00008910: 6465 7320 3120 6578 616d 706c 6573 2f75  des 1 examples/u
+00008920: 7369 6e67 5f66 696c 655f 6d6f 756e 7473  sing_file_mounts
+00008930: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
+00008940: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+00008950: 7d20 3120 2d2d 7374 6174 7573 272c 2020  } 1 --status',  
+00008960: 2320 456e 7375 7265 2074 6865 206a 6f62  # Ensure the job
+00008970: 2073 7563 6365 6564 6564 2e0a 2020 2020   succeeded..    
+00008980: 5d0a 2020 2020 7465 7374 203d 2054 6573  ].    test = Tes
+00008990: 7428 0a20 2020 2020 2020 2027 5343 505f  t(.        'SCP_
+000089a0: 7573 696e 675f 6669 6c65 5f6d 6f75 6e74  using_file_mount
+000089b0: 7327 2c0a 2020 2020 2020 2020 7465 7374  s',.        test
+000089c0: 5f63 6f6d 6d61 6e64 732c 0a20 2020 2020  _commands,.     
+000089d0: 2020 2066 2773 6b79 2064 6f77 6e20 2d79     f'sky down -y
+000089e0: 207b 6e61 6d65 7d27 2c0a 2020 2020 2020   {name}',.      
+000089f0: 2020 7469 6d65 6f75 743d 3230 202a 2036    timeout=20 * 6
+00008a00: 302c 2020 2320 3230 206d 696e 730a 2020  0,  # 20 mins.  
+00008a10: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
+00008a20: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
+00008a30: 7465 7374 2e6d 6172 6b2e 6e6f 5f66 6c75  test.mark.no_flu
+00008a40: 6964 7374 6163 6b20 2023 2052 6571 7569  idstack  # Requi
+00008a50: 7265 7320 4743 5020 746f 2062 6520 656e  res GCP to be en
+00008a60: 6162 6c65 640a 6465 6620 7465 7374 5f75  abled.def test_u
+00008a70: 7369 6e67 5f66 696c 655f 6d6f 756e 7473  sing_file_mounts
+00008a80: 5f77 6974 685f 656e 765f 7661 7273 2867  _with_env_vars(g
+00008a90: 656e 6572 6963 5f63 6c6f 7564 3a20 7374  eneric_cloud: st
+00008aa0: 7229 3a0a 2020 2020 6e61 6d65 203d 205f  r):.    name = _
+00008ab0: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
+00008ac0: 2829 0a20 2020 2073 746f 7261 6765 5f6e  ().    storage_n
+00008ad0: 616d 6520 3d20 5465 7374 5374 6f72 6167  ame = TestStorag
+00008ae0: 6557 6974 6843 7265 6465 6e74 6961 6c73  eWithCredentials
+00008af0: 2e67 656e 6572 6174 655f 6275 636b 6574  .generate_bucket
+00008b00: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
+00008b10: 5f63 6f6d 6d61 6e64 7320 3d20 5b0a 2020  _commands = [.  
+00008b20: 2020 2020 2020 2a73 746f 7261 6765 5f73        *storage_s
+00008b30: 6574 7570 5f63 6f6d 6d61 6e64 732c 0a20  etup_commands,. 
+00008b40: 2020 2020 2020 2028 6627 736b 7920 6c61         (f'sky la
+00008b50: 756e 6368 202d 7920 2d63 207b 6e61 6d65  unch -y -c {name
+00008b60: 7d20 2d2d 6370 7573 2032 2b20 2d2d 636c  } --cpus 2+ --cl
+00008b70: 6f75 6420 7b67 656e 6572 6963 5f63 6c6f  oud {generic_clo
+00008b80: 7564 7d20 270a 2020 2020 2020 2020 2027  ud} '.         '
+00008b90: 6578 616d 706c 6573 2f75 7369 6e67 5f66  examples/using_f
+00008ba0: 696c 655f 6d6f 756e 7473 5f77 6974 685f  ile_mounts_with_
+00008bb0: 656e 765f 7661 7273 2e79 616d 6c20 270a  env_vars.yaml '.
+00008bc0: 2020 2020 2020 2020 2066 272d 2d65 6e76           f'--env
+00008bd0: 204d 595f 4255 434b 4554 3d7b 7374 6f72   MY_BUCKET={stor
+00008be0: 6167 655f 6e61 6d65 7d27 292c 0a20 2020  age_name}'),.   
+00008bf0: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+00008c00: 7b6e 616d 657d 2031 202d 2d73 7461 7475  {name} 1 --statu
+00008c10: 7327 2c20 2023 2045 6e73 7572 6520 7468  s',  # Ensure th
+00008c20: 6520 6a6f 6220 7375 6363 6565 6465 642e  e job succeeded.
+00008c30: 0a20 2020 2020 2020 2023 204f 7665 7272  .        # Overr
+00008c40: 6964 6520 7769 7468 202d 2d65 6e76 3a0a  ide with --env:.
+00008c50: 2020 2020 2020 2020 2866 2773 6b79 206c          (f'sky l
+00008c60: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
+00008c70: 657d 2d32 202d 2d63 7075 7320 322b 202d  e}-2 --cpus 2+ -
+00008c80: 2d63 6c6f 7564 207b 6765 6e65 7269 635f  -cloud {generic_
+00008c90: 636c 6f75 647d 2027 0a20 2020 2020 2020  cloud} '.       
+00008ca0: 2020 2765 7861 6d70 6c65 732f 7573 696e    'examples/usin
+00008cb0: 675f 6669 6c65 5f6d 6f75 6e74 735f 7769  g_file_mounts_wi
+00008cc0: 7468 5f65 6e76 5f76 6172 732e 7961 6d6c  th_env_vars.yaml
+00008cd0: 2027 0a20 2020 2020 2020 2020 6627 2d2d   '.         f'--
+00008ce0: 656e 7620 4d59 5f42 5543 4b45 543d 7b73  env MY_BUCKET={s
+00008cf0: 746f 7261 6765 5f6e 616d 657d 2027 0a20  torage_name} '. 
+00008d00: 2020 2020 2020 2020 272d 2d65 6e76 204d          '--env M
+00008d10: 595f 4c4f 4341 4c5f 5041 5448 3d74 6d70  Y_LOCAL_PATH=tmp
+00008d20: 6669 6c65 2729 2c0a 2020 2020 2020 2020  file'),.        
+00008d30: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+00008d40: 7d2d 3220 3120 2d2d 7374 6174 7573 272c  }-2 1 --status',
+00008d50: 2020 2320 456e 7375 7265 2074 6865 206a    # Ensure the j
+00008d60: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
+00008d70: 2020 5d0a 2020 2020 7465 7374 203d 2054    ].    test = T
+00008d80: 6573 7428 0a20 2020 2020 2020 2027 7573  est(.        'us
+00008d90: 696e 675f 6669 6c65 5f6d 6f75 6e74 735f  ing_file_mounts_
+00008da0: 7769 7468 5f65 6e76 5f76 6172 7327 2c0a  with_env_vars',.
+00008db0: 2020 2020 2020 2020 7465 7374 5f63 6f6d          test_com
+00008dc0: 6d61 6e64 732c 0a20 2020 2020 2020 2028  mands,.        (
+00008dd0: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
+00008de0: 616d 657d 207b 6e61 6d65 7d2d 3227 2c0a  ame} {name}-2',.
+00008df0: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
+00008e00: 746f 7261 6765 2064 656c 6574 6520 2d79  torage delete -y
+00008e10: 207b 7374 6f72 6167 655f 6e61 6d65 7d20   {storage_name} 
+00008e20: 7b73 746f 7261 6765 5f6e 616d 657d 2d32  {storage_name}-2
+00008e30: 2729 2c0a 2020 2020 2020 2020 7469 6d65  '),.        time
+00008e40: 6f75 743d 3230 202a 2036 302c 2020 2320  out=20 * 60,  # 
+00008e50: 3230 206d 696e 730a 2020 2020 290a 2020  20 mins.    ).  
+00008e60: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+00008e70: 6573 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d  est)...# -------
+00008e80: 2d2d 2d20 7374 6f72 6167 6520 2d2d 2d2d  --- storage ----
+00008e90: 2d2d 2d2d 2d2d 0a40 7079 7465 7374 2e6d  ------.@pytest.m
+00008ea0: 6172 6b2e 6177 730a 6465 6620 7465 7374  ark.aws.def test
+00008eb0: 5f61 7773 5f73 746f 7261 6765 5f6d 6f75  _aws_storage_mou
+00008ec0: 6e74 735f 7769 7468 5f73 746f 7028 293a  nts_with_stop():
+00008ed0: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
+00008ee0: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
+00008ef0: 2020 2020 7374 6f72 6167 655f 6e61 6d65      storage_name
+00008f00: 203d 2066 2773 6b79 2d74 6573 742d 7b69   = f'sky-test-{i
+00008f10: 6e74 2874 696d 652e 7469 6d65 2829 297d  nt(time.time())}
+00008f20: 270a 2020 2020 7465 6d70 6c61 7465 5f73  '.    template_s
+00008f30: 7472 203d 2070 6174 686c 6962 2e50 6174  tr = pathlib.Pat
+00008f40: 6828 0a20 2020 2020 2020 2027 7465 7374  h(.        'test
+00008f50: 732f 7465 7374 5f79 616d 6c73 2f74 6573  s/test_yamls/tes
+00008f60: 745f 7374 6f72 6167 655f 6d6f 756e 7469  t_storage_mounti
+00008f70: 6e67 2e79 616d 6c2e 6a32 2729 2e72 6561  ng.yaml.j2').rea
+00008f80: 645f 7465 7874 2829 0a20 2020 2074 656d  d_text().    tem
+00008f90: 706c 6174 6520 3d20 6a69 6e6a 6132 2e54  plate = jinja2.T
+00008fa0: 656d 706c 6174 6528 7465 6d70 6c61 7465  emplate(template
+00008fb0: 5f73 7472 290a 2020 2020 636f 6e74 656e  _str).    conten
+00008fc0: 7420 3d20 7465 6d70 6c61 7465 2e72 656e  t = template.ren
+00008fd0: 6465 7228 7374 6f72 6167 655f 6e61 6d65  der(storage_name
+00008fe0: 3d73 746f 7261 6765 5f6e 616d 6529 0a20  =storage_name). 
+00008ff0: 2020 2077 6974 6820 7465 6d70 6669 6c65     with tempfile
+00009000: 2e4e 616d 6564 5465 6d70 6f72 6172 7946  .NamedTemporaryF
+00009010: 696c 6528 7375 6666 6978 3d27 2e79 616d  ile(suffix='.yam
+00009020: 6c27 2c20 6d6f 6465 3d27 7727 2920 6173  l', mode='w') as
+00009030: 2066 3a0a 2020 2020 2020 2020 662e 7772   f:.        f.wr
+00009040: 6974 6528 636f 6e74 656e 7429 0a20 2020  ite(content).   
+00009050: 2020 2020 2066 2e66 6c75 7368 2829 0a20       f.flush(). 
+00009060: 2020 2020 2020 2066 696c 655f 7061 7468         file_path
+00009070: 203d 2066 2e6e 616d 650a 2020 2020 2020   = f.name.      
+00009080: 2020 7465 7374 5f63 6f6d 6d61 6e64 7320    test_commands 
+00009090: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
+000090a0: 2a73 746f 7261 6765 5f73 6574 7570 5f63  *storage_setup_c
+000090b0: 6f6d 6d61 6e64 732c 0a20 2020 2020 2020  ommands,.       
+000090c0: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
+000090d0: 6820 2d79 202d 6320 7b6e 616d 657d 202d  h -y -c {name} -
+000090e0: 2d63 6c6f 7564 2061 7773 207b 6669 6c65  -cloud aws {file
+000090f0: 5f70 6174 687d 272c 0a20 2020 2020 2020  _path}',.       
+00009100: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+00009110: 7b6e 616d 657d 2031 202d 2d73 7461 7475  {name} 1 --statu
+00009120: 7327 2c20 2023 2045 6e73 7572 6520 6a6f  s',  # Ensure jo
+00009130: 6220 7375 6363 6565 6465 642e 0a20 2020  b succeeded..   
+00009140: 2020 2020 2020 2020 2066 2761 7773 2073           f'aws s
+00009150: 3320 6c73 207b 7374 6f72 6167 655f 6e61  3 ls {storage_na
+00009160: 6d65 7d2f 6865 6c6c 6f2e 7478 7427 2c0a  me}/hello.txt',.
+00009170: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00009180: 7920 7374 6f70 202d 7920 7b6e 616d 657d  y stop -y {name}
+00009190: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+000091a0: 2773 6b79 2073 7461 7274 202d 7920 7b6e  'sky start -y {n
+000091b0: 616d 657d 272c 0a20 2020 2020 2020 2020  ame}',.         
+000091c0: 2020 2023 2043 6865 636b 2069 6620 6865     # Check if he
+000091d0: 6c6c 6f2e 7478 7420 6672 6f6d 206d 6f75  llo.txt from mou
+000091e0: 6e74 696e 6720 6275 636b 6574 2065 7869  nting bucket exi
+000091f0: 7374 7320 6166 7465 7220 7265 7374 6172  sts after restar
+00009200: 7420 696e 0a20 2020 2020 2020 2020 2020  t in.           
+00009210: 2023 2074 6865 206d 6f75 6e74 6564 2064   # the mounted d
+00009220: 6972 6563 746f 7279 0a20 2020 2020 2020  irectory.       
+00009230: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
+00009240: 7b6e 616d 657d 202d 2d20 2273 6574 202d  {name} -- "set -
+00009250: 6578 3b20 6c73 202f 6d6f 756e 745f 7072  ex; ls /mount_pr
+00009260: 6976 6174 655f 6d6f 756e 742f 6865 6c6c  ivate_mount/hell
+00009270: 6f2e 7478 7422 270a 2020 2020 2020 2020  o.txt"'.        
+00009280: 5d0a 2020 2020 2020 2020 7465 7374 203d  ].        test =
+00009290: 2054 6573 7428 0a20 2020 2020 2020 2020   Test(.         
+000092a0: 2020 2027 6177 735f 7374 6f72 6167 655f     'aws_storage_
+000092b0: 6d6f 756e 7473 272c 0a20 2020 2020 2020  mounts',.       
+000092c0: 2020 2020 2074 6573 745f 636f 6d6d 616e       test_comman
+000092d0: 6473 2c0a 2020 2020 2020 2020 2020 2020  ds,.            
+000092e0: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
+000092f0: 616d 657d 3b20 736b 7920 7374 6f72 6167  ame}; sky storag
+00009300: 6520 6465 6c65 7465 202d 7920 7b73 746f  e delete -y {sto
+00009310: 7261 6765 5f6e 616d 657d 272c 0a20 2020  rage_name}',.   
+00009320: 2020 2020 2020 2020 2074 696d 656f 7574           timeout
+00009330: 3d32 3020 2a20 3630 2c20 2023 2032 3020  =20 * 60,  # 20 
+00009340: 6d69 6e73 0a20 2020 2020 2020 2029 0a20  mins.        ). 
+00009350: 2020 2020 2020 2072 756e 5f6f 6e65 5f74         run_one_t
+00009360: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
+00009370: 6573 742e 6d61 726b 2e67 6370 0a64 6566  est.mark.gcp.def
+00009380: 2074 6573 745f 6763 705f 7374 6f72 6167   test_gcp_storag
+00009390: 655f 6d6f 756e 7473 5f77 6974 685f 7374  e_mounts_with_st
+000093a0: 6f70 2829 3a0a 2020 2020 6e61 6d65 203d  op():.    name =
+000093b0: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
+000093c0: 6d65 2829 0a20 2020 2073 746f 7261 6765  me().    storage
+000093d0: 5f6e 616d 6520 3d20 6627 736b 792d 7465  _name = f'sky-te
+000093e0: 7374 2d7b 696e 7428 7469 6d65 2e74 696d  st-{int(time.tim
+000093f0: 6528 2929 7d27 0a20 2020 2074 656d 706c  e())}'.    templ
+00009400: 6174 655f 7374 7220 3d20 7061 7468 6c69  ate_str = pathli
+00009410: 622e 5061 7468 280a 2020 2020 2020 2020  b.Path(.        
+00009420: 2774 6573 7473 2f74 6573 745f 7961 6d6c  'tests/test_yaml
+00009430: 732f 7465 7374 5f73 746f 7261 6765 5f6d  s/test_storage_m
+00009440: 6f75 6e74 696e 672e 7961 6d6c 2e6a 3227  ounting.yaml.j2'
+00009450: 292e 7265 6164 5f74 6578 7428 290a 2020  ).read_text().  
+00009460: 2020 7465 6d70 6c61 7465 203d 206a 696e    template = jin
+00009470: 6a61 322e 5465 6d70 6c61 7465 2874 656d  ja2.Template(tem
+00009480: 706c 6174 655f 7374 7229 0a20 2020 2063  plate_str).    c
+00009490: 6f6e 7465 6e74 203d 2074 656d 706c 6174  ontent = templat
+000094a0: 652e 7265 6e64 6572 2873 746f 7261 6765  e.render(storage
+000094b0: 5f6e 616d 653d 7374 6f72 6167 655f 6e61  _name=storage_na
+000094c0: 6d65 290a 2020 2020 7769 7468 2074 656d  me).    with tem
+000094d0: 7066 696c 652e 4e61 6d65 6454 656d 706f  pfile.NamedTempo
+000094e0: 7261 7279 4669 6c65 2873 7566 6669 783d  raryFile(suffix=
+000094f0: 272e 7961 6d6c 272c 206d 6f64 653d 2777  '.yaml', mode='w
+00009500: 2729 2061 7320 663a 0a20 2020 2020 2020  ') as f:.       
+00009510: 2066 2e77 7269 7465 2863 6f6e 7465 6e74   f.write(content
+00009520: 290a 2020 2020 2020 2020 662e 666c 7573  ).        f.flus
+00009530: 6828 290a 2020 2020 2020 2020 6669 6c65  h().        file
+00009540: 5f70 6174 6820 3d20 662e 6e61 6d65 0a20  _path = f.name. 
+00009550: 2020 2020 2020 2074 6573 745f 636f 6d6d         test_comm
+00009560: 616e 6473 203d 205b 0a20 2020 2020 2020  ands = [.       
+00009570: 2020 2020 202a 7374 6f72 6167 655f 7365       *storage_se
+00009580: 7475 705f 636f 6d6d 616e 6473 2c0a 2020  tup_commands,.  
+00009590: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+000095a0: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
+000095b0: 6d65 7d20 2d2d 636c 6f75 6420 6763 7020  me} --cloud gcp 
+000095c0: 7b66 696c 655f 7061 7468 7d27 2c0a 2020  {file_path}',.  
+000095d0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+000095e0: 6c6f 6773 207b 6e61 6d65 7d20 3120 2d2d  logs {name} 1 --
+000095f0: 7374 6174 7573 272c 2020 2320 456e 7375  status',  # Ensu
+00009600: 7265 206a 6f62 2073 7563 6365 6564 6564  re job succeeded
+00009610: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
+00009620: 6773 7574 696c 206c 7320 6773 3a2f 2f7b  gsutil ls gs://{
+00009630: 7374 6f72 6167 655f 6e61 6d65 7d2f 6865  storage_name}/he
+00009640: 6c6c 6f2e 7478 7427 2c0a 2020 2020 2020  llo.txt',.      
+00009650: 2020 2020 2020 6627 736b 7920 7374 6f70        f'sky stop
+00009660: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
+00009670: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
+00009680: 7461 7274 202d 7920 7b6e 616d 657d 272c  tart -y {name}',
+00009690: 0a20 2020 2020 2020 2020 2020 2023 2043  .            # C
+000096a0: 6865 636b 2069 6620 6865 6c6c 6f2e 7478  heck if hello.tx
+000096b0: 7420 6672 6f6d 206d 6f75 6e74 696e 6720  t from mounting 
+000096c0: 6275 636b 6574 2065 7869 7374 7320 6166  bucket exists af
+000096d0: 7465 7220 7265 7374 6172 7420 696e 0a20  ter restart in. 
+000096e0: 2020 2020 2020 2020 2020 2023 2074 6865             # the
+000096f0: 206d 6f75 6e74 6564 2064 6972 6563 746f   mounted directo
+00009700: 7279 0a20 2020 2020 2020 2020 2020 2066  ry.            f
+00009710: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+00009720: 202d 2d20 2273 6574 202d 6578 3b20 6c73   -- "set -ex; ls
+00009730: 202f 6d6f 756e 745f 7072 6976 6174 655f   /mount_private_
+00009740: 6d6f 756e 742f 6865 6c6c 6f2e 7478 7422  mount/hello.txt"
+00009750: 270a 2020 2020 2020 2020 5d0a 2020 2020  '.        ].    
+00009760: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
+00009770: 0a20 2020 2020 2020 2020 2020 2027 6763  .            'gc
+00009780: 705f 7374 6f72 6167 655f 6d6f 756e 7473  p_storage_mounts
+00009790: 272c 0a20 2020 2020 2020 2020 2020 2074  ',.            t
+000097a0: 6573 745f 636f 6d6d 616e 6473 2c0a 2020  est_commands,.  
+000097b0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+000097c0: 646f 776e 202d 7920 7b6e 616d 657d 3b20  down -y {name}; 
+000097d0: 736b 7920 7374 6f72 6167 6520 6465 6c65  sky storage dele
+000097e0: 7465 202d 7920 7b73 746f 7261 6765 5f6e  te -y {storage_n
+000097f0: 616d 657d 272c 0a20 2020 2020 2020 2020  ame}',.         
+00009800: 2020 2074 696d 656f 7574 3d32 3020 2a20     timeout=20 * 
+00009810: 3630 2c20 2023 2032 3020 6d69 6e73 0a20  60,  # 20 mins. 
+00009820: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00009830: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
+00009840: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
+00009850: 726b 2e6b 7562 6572 6e65 7465 730a 6465  rk.kubernetes.de
+00009860: 6620 7465 7374 5f6b 7562 6572 6e65 7465  f test_kubernete
+00009870: 735f 7374 6f72 6167 655f 6d6f 756e 7473  s_storage_mounts
+00009880: 2829 3a0a 2020 2020 2320 5465 7374 7320  ():.    # Tests 
+00009890: 6275 636b 6574 206d 6f75 6e74 696e 6720  bucket mounting 
+000098a0: 6f6e 206b 3873 2c20 6173 7375 6d69 6e67  on k8s, assuming
+000098b0: 2053 3320 6973 2063 6f6e 6669 6775 7265   S3 is configure
+000098c0: 642e 0a20 2020 2023 2054 6869 7320 7465  d..    # This te
+000098d0: 7374 2077 696c 6c20 6661 696c 2069 6620  st will fail if 
+000098e0: 7275 6e20 6f6e 206e 6f6e 2078 3836 5f36  run on non x86_6
+000098f0: 3420 6172 6368 6974 6563 7475 7265 2c20  4 architecture, 
+00009900: 7369 6e63 6520 676f 6f66 7973 2069 730a  since goofys is.
+00009910: 2020 2020 2320 6275 696c 7420 666f 7220      # built for 
+00009920: 7838 365f 3634 206f 6e6c 792e 0a20 2020  x86_64 only..   
+00009930: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
+00009940: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
+00009950: 7374 6f72 6167 655f 6e61 6d65 203d 2066  storage_name = f
+00009960: 2773 6b79 2d74 6573 742d 7b69 6e74 2874  'sky-test-{int(t
+00009970: 696d 652e 7469 6d65 2829 297d 270a 2020  ime.time())}'.  
+00009980: 2020 7465 6d70 6c61 7465 5f73 7472 203d    template_str =
+00009990: 2070 6174 686c 6962 2e50 6174 6828 0a20   pathlib.Path(. 
+000099a0: 2020 2020 2020 2027 7465 7374 732f 7465         'tests/te
+000099b0: 7374 5f79 616d 6c73 2f74 6573 745f 7374  st_yamls/test_st
+000099c0: 6f72 6167 655f 6d6f 756e 7469 6e67 2e79  orage_mounting.y
+000099d0: 616d 6c2e 6a32 2729 2e72 6561 645f 7465  aml.j2').read_te
+000099e0: 7874 2829 0a20 2020 2074 656d 706c 6174  xt().    templat
+000099f0: 6520 3d20 6a69 6e6a 6132 2e54 656d 706c  e = jinja2.Templ
+00009a00: 6174 6528 7465 6d70 6c61 7465 5f73 7472  ate(template_str
+00009a10: 290a 2020 2020 636f 6e74 656e 7420 3d20  ).    content = 
+00009a20: 7465 6d70 6c61 7465 2e72 656e 6465 7228  template.render(
+00009a30: 7374 6f72 6167 655f 6e61 6d65 3d73 746f  storage_name=sto
+00009a40: 7261 6765 5f6e 616d 6529 0a20 2020 2077  rage_name).    w
+00009a50: 6974 6820 7465 6d70 6669 6c65 2e4e 616d  ith tempfile.Nam
+00009a60: 6564 5465 6d70 6f72 6172 7946 696c 6528  edTemporaryFile(
+00009a70: 7375 6666 6978 3d27 2e79 616d 6c27 2c20  suffix='.yaml', 
+00009a80: 6d6f 6465 3d27 7727 2920 6173 2066 3a0a  mode='w') as f:.
+00009a90: 2020 2020 2020 2020 662e 7772 6974 6528          f.write(
+00009aa0: 636f 6e74 656e 7429 0a20 2020 2020 2020  content).       
+00009ab0: 2066 2e66 6c75 7368 2829 0a20 2020 2020   f.flush().     
+00009ac0: 2020 2066 696c 655f 7061 7468 203d 2066     file_path = f
+00009ad0: 2e6e 616d 650a 2020 2020 2020 2020 7465  .name.        te
+00009ae0: 7374 5f63 6f6d 6d61 6e64 7320 3d20 5b0a  st_commands = [.
+00009af0: 2020 2020 2020 2020 2020 2020 2a73 746f              *sto
+00009b00: 7261 6765 5f73 6574 7570 5f63 6f6d 6d61  rage_setup_comma
+00009b10: 6e64 732c 0a20 2020 2020 2020 2020 2020  nds,.           
+00009b20: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
+00009b30: 202d 6320 7b6e 616d 657d 202d 2d63 6c6f   -c {name} --clo
+00009b40: 7564 206b 7562 6572 6e65 7465 7320 7b66  ud kubernetes {f
+00009b50: 696c 655f 7061 7468 7d27 2c0a 2020 2020  ile_path}',.    
+00009b60: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+00009b70: 6773 207b 6e61 6d65 7d20 3120 2d2d 7374  gs {name} 1 --st
+00009b80: 6174 7573 272c 2020 2320 456e 7375 7265  atus',  # Ensure
+00009b90: 206a 6f62 2073 7563 6365 6564 6564 2e0a   job succeeded..
+00009ba0: 2020 2020 2020 2020 2020 2020 6627 6177              f'aw
+00009bb0: 7320 7333 206c 7320 7b73 746f 7261 6765  s s3 ls {storage
+00009bc0: 5f6e 616d 657d 2f68 656c 6c6f 2e74 7874  _name}/hello.txt
+00009bd0: 207c 7c20 270a 2020 2020 2020 2020 2020   || '.          
+00009be0: 2020 6627 6773 7574 696c 206c 7320 6773    f'gsutil ls gs
+00009bf0: 3a2f 2f7b 7374 6f72 6167 655f 6e61 6d65  ://{storage_name
+00009c00: 7d2f 6865 6c6c 6f2e 7478 7427 2c0a 2020  }/hello.txt',.  
+00009c10: 2020 2020 2020 5d0a 2020 2020 2020 2020        ].        
+00009c20: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
+00009c30: 2020 2020 2020 2020 2027 6b75 6265 726e           'kubern
+00009c40: 6574 6573 5f73 746f 7261 6765 5f6d 6f75  etes_storage_mou
+00009c50: 6e74 7327 2c0a 2020 2020 2020 2020 2020  nts',.          
+00009c60: 2020 7465 7374 5f63 6f6d 6d61 6e64 732c    test_commands,
+00009c70: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00009c80: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
+00009c90: 7d3b 2073 6b79 2073 746f 7261 6765 2064  }; sky storage d
+00009ca0: 656c 6574 6520 2d79 207b 7374 6f72 6167  elete -y {storag
+00009cb0: 655f 6e61 6d65 7d27 2c0a 2020 2020 2020  e_name}',.      
+00009cc0: 2020 2020 2020 7469 6d65 6f75 743d 3230        timeout=20
+00009cd0: 202a 2036 302c 2020 2320 3230 206d 696e   * 60,  # 20 min
+00009ce0: 730a 2020 2020 2020 2020 290a 2020 2020  s.        ).    
+00009cf0: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
+00009d00: 2874 6573 7429 0a0a 0a40 7079 7465 7374  (test)...@pytest
+00009d10: 2e6d 6172 6b2e 7061 7261 6d65 7472 697a  .mark.parametriz
+00009d20: 6528 0a20 2020 2027 696d 6167 655f 6964  e(.    'image_id
+00009d30: 272c 0a20 2020 205b 0a20 2020 2020 2020  ',.    [.       
+00009d40: 2027 646f 636b 6572 3a6e 7669 6469 612f   'docker:nvidia/
+00009d50: 6375 6461 3a31 312e 382e 302d 6465 7665  cuda:11.8.0-deve
+00009d60: 6c2d 7562 756e 7475 3138 2e30 3427 2c0a  l-ubuntu18.04',.
+00009d70: 2020 2020 2020 2020 2764 6f63 6b65 723a          'docker:
+00009d80: 7562 756e 7475 3a31 382e 3034 272c 0a20  ubuntu:18.04',. 
+00009d90: 2020 2020 2020 2023 2054 6573 7420 6c61         # Test la
+00009da0: 7465 7374 2069 6d61 6765 2077 6974 6820  test image with 
+00009db0: 7079 7468 6f6e 2033 2e31 3120 696e 7374  python 3.11 inst
+00009dc0: 616c 6c65 6420 6279 2064 6566 6175 6c74  alled by default
+00009dd0: 2e0a 2020 2020 2020 2020 2320 446f 6573  ..        # Does
+00009de0: 206e 6f74 2077 6f72 6b20 666f 7220 7079   not work for py
+00009df0: 7468 6f6e 2033 2e31 3220 6475 6520 746f  thon 3.12 due to
+00009e00: 2072 6179 2773 2072 6571 7569 7265 6d65   ray's requireme
+00009e10: 6e74 2066 6f72 2033 2e31 312e 0a20 2020  nt for 3.11..   
+00009e20: 2020 2020 2027 646f 636b 6572 3a63 6f6e       'docker:con
+00009e30: 7469 6e75 756d 696f 2f6d 696e 6963 6f6e  tinuumio/minicon
+00009e40: 6461 333a 3234 2e31 2e32 2d30 272c 0a20  da3:24.1.2-0',. 
+00009e50: 2020 205d 290a 6465 6620 7465 7374 5f64     ]).def test_d
+00009e60: 6f63 6b65 725f 7374 6f72 6167 655f 6d6f  ocker_storage_mo
+00009e70: 756e 7473 2867 656e 6572 6963 5f63 6c6f  unts(generic_clo
+00009e80: 7564 3a20 7374 722c 2069 6d61 6765 5f69  ud: str, image_i
+00009e90: 643a 2073 7472 293a 0a20 2020 2023 2054  d: str):.    # T
+00009ea0: 6573 7473 2062 7563 6b65 7420 6d6f 756e  ests bucket moun
+00009eb0: 7469 6e67 206f 6e20 646f 636b 6572 2063  ting on docker c
+00009ec0: 6f6e 7461 696e 6572 0a20 2020 206e 616d  ontainer.    nam
+00009ed0: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
+00009ee0: 5f6e 616d 6528 290a 2020 2020 7469 6d65  _name().    time
+00009ef0: 7374 616d 7020 3d20 7374 7228 7469 6d65  stamp = str(time
+00009f00: 2e74 696d 6528 2929 2e72 6570 6c61 6365  .time()).replace
+00009f10: 2827 2e27 2c20 2727 290a 2020 2020 7374  ('.', '').    st
+00009f20: 6f72 6167 655f 6e61 6d65 203d 2066 2773  orage_name = f's
+00009f30: 6b79 2d74 6573 742d 7b74 696d 6573 7461  ky-test-{timesta
+00009f40: 6d70 7d27 0a20 2020 2074 656d 706c 6174  mp}'.    templat
+00009f50: 655f 7374 7220 3d20 7061 7468 6c69 622e  e_str = pathlib.
+00009f60: 5061 7468 280a 2020 2020 2020 2020 2774  Path(.        't
+00009f70: 6573 7473 2f74 6573 745f 7961 6d6c 732f  ests/test_yamls/
+00009f80: 7465 7374 5f73 746f 7261 6765 5f6d 6f75  test_storage_mou
+00009f90: 6e74 696e 672e 7961 6d6c 2e6a 3227 292e  nting.yaml.j2').
+00009fa0: 7265 6164 5f74 6578 7428 290a 2020 2020  read_text().    
+00009fb0: 7465 6d70 6c61 7465 203d 206a 696e 6a61  template = jinja
+00009fc0: 322e 5465 6d70 6c61 7465 2874 656d 706c  2.Template(templ
+00009fd0: 6174 655f 7374 7229 0a20 2020 2063 6f6e  ate_str).    con
+00009fe0: 7465 6e74 203d 2074 656d 706c 6174 652e  tent = template.
+00009ff0: 7265 6e64 6572 2873 746f 7261 6765 5f6e  render(storage_n
+0000a000: 616d 653d 7374 6f72 6167 655f 6e61 6d65  ame=storage_name
+0000a010: 290a 2020 2020 7769 7468 2074 656d 7066  ).    with tempf
+0000a020: 696c 652e 4e61 6d65 6454 656d 706f 7261  ile.NamedTempora
+0000a030: 7279 4669 6c65 2873 7566 6669 783d 272e  ryFile(suffix='.
+0000a040: 7961 6d6c 272c 206d 6f64 653d 2777 2729  yaml', mode='w')
+0000a050: 2061 7320 663a 0a20 2020 2020 2020 2066   as f:.        f
+0000a060: 2e77 7269 7465 2863 6f6e 7465 6e74 290a  .write(content).
+0000a070: 2020 2020 2020 2020 662e 666c 7573 6828          f.flush(
+0000a080: 290a 2020 2020 2020 2020 6669 6c65 5f70  ).        file_p
+0000a090: 6174 6820 3d20 662e 6e61 6d65 0a20 2020  ath = f.name.   
+0000a0a0: 2020 2020 2074 6573 745f 636f 6d6d 616e       test_comman
+0000a0b0: 6473 203d 205b 0a20 2020 2020 2020 2020  ds = [.         
+0000a0c0: 2020 202a 7374 6f72 6167 655f 7365 7475     *storage_setu
+0000a0d0: 705f 636f 6d6d 616e 6473 2c0a 2020 2020  p_commands,.    
+0000a0e0: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
+0000a0f0: 756e 6368 202d 7920 2d63 207b 6e61 6d65  unch -y -c {name
+0000a100: 7d20 2d2d 636c 6f75 6420 7b67 656e 6572  } --cloud {gener
+0000a110: 6963 5f63 6c6f 7564 7d20 2d2d 696d 6167  ic_cloud} --imag
+0000a120: 652d 6964 207b 696d 6167 655f 6964 7d20  e-id {image_id} 
+0000a130: 7b66 696c 655f 7061 7468 7d27 2c0a 2020  {file_path}',.  
+0000a140: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0000a150: 6c6f 6773 207b 6e61 6d65 7d20 3120 2d2d  logs {name} 1 --
+0000a160: 7374 6174 7573 272c 2020 2320 456e 7375  status',  # Ensu
+0000a170: 7265 206a 6f62 2073 7563 6365 6564 6564  re job succeeded
+0000a180: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
+0000a190: 6177 7320 7333 206c 7320 7b73 746f 7261  aws s3 ls {stora
+0000a1a0: 6765 5f6e 616d 657d 2f68 656c 6c6f 2e74  ge_name}/hello.t
+0000a1b0: 7874 207c 7c20 270a 2020 2020 2020 2020  xt || '.        
+0000a1c0: 2020 2020 6627 6773 7574 696c 206c 7320      f'gsutil ls 
+0000a1d0: 6773 3a2f 2f7b 7374 6f72 6167 655f 6e61  gs://{storage_na
+0000a1e0: 6d65 7d2f 6865 6c6c 6f2e 7478 7427 2c0a  me}/hello.txt',.
+0000a1f0: 2020 2020 2020 2020 5d0a 2020 2020 2020          ].      
+0000a200: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
+0000a210: 2020 2020 2020 2020 2020 2027 646f 636b             'dock
+0000a220: 6572 5f73 746f 7261 6765 5f6d 6f75 6e74  er_storage_mount
+0000a230: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
+0000a240: 7465 7374 5f63 6f6d 6d61 6e64 732c 0a20  test_commands,. 
+0000a250: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0000a260: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d3b   down -y {name};
+0000a270: 2073 6b79 2073 746f 7261 6765 2064 656c   sky storage del
+0000a280: 6574 6520 2d79 207b 7374 6f72 6167 655f  ete -y {storage_
+0000a290: 6e61 6d65 7d27 2c0a 2020 2020 2020 2020  name}',.        
+0000a2a0: 2020 2020 7469 6d65 6f75 743d 3230 202a      timeout=20 *
+0000a2b0: 2036 302c 2020 2320 3230 206d 696e 730a   60,  # 20 mins.
+0000a2c0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0000a2d0: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+0000a2e0: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
+0000a2f0: 6172 6b2e 636c 6f75 6466 6c61 7265 0a64  ark.cloudflare.d
+0000a300: 6566 2074 6573 745f 636c 6f75 6466 6c61  ef test_cloudfla
+0000a310: 7265 5f73 746f 7261 6765 5f6d 6f75 6e74  re_storage_mount
+0000a320: 7328 6765 6e65 7269 635f 636c 6f75 643a  s(generic_cloud:
+0000a330: 2073 7472 293a 0a20 2020 206e 616d 6520   str):.    name 
+0000a340: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
+0000a350: 616d 6528 290a 2020 2020 7374 6f72 6167  ame().    storag
+0000a360: 655f 6e61 6d65 203d 2066 2773 6b79 2d74  e_name = f'sky-t
+0000a370: 6573 742d 7b69 6e74 2874 696d 652e 7469  est-{int(time.ti
+0000a380: 6d65 2829 297d 270a 2020 2020 7465 6d70  me())}'.    temp
+0000a390: 6c61 7465 5f73 7472 203d 2070 6174 686c  late_str = pathl
+0000a3a0: 6962 2e50 6174 6828 0a20 2020 2020 2020  ib.Path(.       
+0000a3b0: 2027 7465 7374 732f 7465 7374 5f79 616d   'tests/test_yam
+0000a3c0: 6c73 2f74 6573 745f 7232 5f73 746f 7261  ls/test_r2_stora
+0000a3d0: 6765 5f6d 6f75 6e74 696e 672e 7961 6d6c  ge_mounting.yaml
+0000a3e0: 2729 2e72 6561 645f 7465 7874 2829 0a20  ').read_text(). 
+0000a3f0: 2020 2074 656d 706c 6174 6520 3d20 6a69     template = ji
+0000a400: 6e6a 6132 2e54 656d 706c 6174 6528 7465  nja2.Template(te
+0000a410: 6d70 6c61 7465 5f73 7472 290a 2020 2020  mplate_str).    
+0000a420: 636f 6e74 656e 7420 3d20 7465 6d70 6c61  content = templa
+0000a430: 7465 2e72 656e 6465 7228 7374 6f72 6167  te.render(storag
+0000a440: 655f 6e61 6d65 3d73 746f 7261 6765 5f6e  e_name=storage_n
+0000a450: 616d 6529 0a20 2020 2065 6e64 706f 696e  ame).    endpoin
+0000a460: 745f 7572 6c20 3d20 636c 6f75 6466 6c61  t_url = cloudfla
+0000a470: 7265 2e63 7265 6174 655f 656e 6470 6f69  re.create_endpoi
+0000a480: 6e74 2829 0a20 2020 2077 6974 6820 7465  nt().    with te
+0000a490: 6d70 6669 6c65 2e4e 616d 6564 5465 6d70  mpfile.NamedTemp
+0000a4a0: 6f72 6172 7946 696c 6528 7375 6666 6978  oraryFile(suffix
+0000a4b0: 3d27 2e79 616d 6c27 2c20 6d6f 6465 3d27  ='.yaml', mode='
+0000a4c0: 7727 2920 6173 2066 3a0a 2020 2020 2020  w') as f:.      
+0000a4d0: 2020 662e 7772 6974 6528 636f 6e74 656e    f.write(conten
+0000a4e0: 7429 0a20 2020 2020 2020 2066 2e66 6c75  t).        f.flu
+0000a4f0: 7368 2829 0a20 2020 2020 2020 2066 696c  sh().        fil
+0000a500: 655f 7061 7468 203d 2066 2e6e 616d 650a  e_path = f.name.
+0000a510: 2020 2020 2020 2020 7465 7374 5f63 6f6d          test_com
+0000a520: 6d61 6e64 7320 3d20 5b0a 2020 2020 2020  mands = [.      
+0000a530: 2020 2020 2020 2a73 746f 7261 6765 5f73        *storage_s
+0000a540: 6574 7570 5f63 6f6d 6d61 6e64 732c 0a20  etup_commands,. 
+0000a550: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0000a560: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
+0000a570: 616d 657d 202d 2d63 6c6f 7564 207b 6765  ame} --cloud {ge
+0000a580: 6e65 7269 635f 636c 6f75 647d 207b 6669  neric_cloud} {fi
+0000a590: 6c65 5f70 6174 687d 272c 0a20 2020 2020  le_path}',.     
+0000a5a0: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+0000a5b0: 7320 7b6e 616d 657d 2031 202d 2d73 7461  s {name} 1 --sta
+0000a5c0: 7475 7327 2c20 2023 2045 6e73 7572 6520  tus',  # Ensure 
+0000a5d0: 6a6f 6220 7375 6363 6565 6465 642e 0a20  job succeeded.. 
+0000a5e0: 2020 2020 2020 2020 2020 2066 2741 5753             f'AWS
+0000a5f0: 5f53 4841 5245 445f 4352 4544 454e 5449  _SHARED_CREDENTI
+0000a600: 414c 535f 4649 4c45 3d7b 636c 6f75 6466  ALS_FILE={cloudf
+0000a610: 6c61 7265 2e52 325f 4352 4544 454e 5449  lare.R2_CREDENTI
+0000a620: 414c 535f 5041 5448 7d20 6177 7320 7333  ALS_PATH} aws s3
+0000a630: 206c 7320 7333 3a2f 2f7b 7374 6f72 6167   ls s3://{storag
+0000a640: 655f 6e61 6d65 7d2f 6865 6c6c 6f2e 7478  e_name}/hello.tx
+0000a650: 7420 2d2d 656e 6470 6f69 6e74 207b 656e  t --endpoint {en
+0000a660: 6470 6f69 6e74 5f75 726c 7d20 2d2d 7072  dpoint_url} --pr
+0000a670: 6f66 696c 653d 7232 270a 2020 2020 2020  ofile=r2'.      
+0000a680: 2020 5d0a 0a20 2020 2020 2020 2074 6573    ]..        tes
+0000a690: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
+0000a6a0: 2020 2020 2020 2763 6c6f 7564 666c 6172        'cloudflar
+0000a6b0: 655f 7374 6f72 6167 655f 6d6f 756e 7473  e_storage_mounts
+0000a6c0: 272c 0a20 2020 2020 2020 2020 2020 2074  ',.            t
+0000a6d0: 6573 745f 636f 6d6d 616e 6473 2c0a 2020  est_commands,.  
+0000a6e0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0000a6f0: 646f 776e 202d 7920 7b6e 616d 657d 3b20  down -y {name}; 
+0000a700: 736b 7920 7374 6f72 6167 6520 6465 6c65  sky storage dele
+0000a710: 7465 202d 7920 7b73 746f 7261 6765 5f6e  te -y {storage_n
+0000a720: 616d 657d 272c 0a20 2020 2020 2020 2020  ame}',.         
+0000a730: 2020 2074 696d 656f 7574 3d32 3020 2a20     timeout=20 * 
+0000a740: 3630 2c20 2023 2032 3020 6d69 6e73 0a20  60,  # 20 mins. 
+0000a750: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0000a760: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
+0000a770: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
+0000a780: 726b 2e69 626d 0a64 6566 2074 6573 745f  rk.ibm.def test_
+0000a790: 6962 6d5f 7374 6f72 6167 655f 6d6f 756e  ibm_storage_moun
+0000a7a0: 7473 2829 3a0a 2020 2020 6e61 6d65 203d  ts():.    name =
+0000a7b0: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
+0000a7c0: 6d65 2829 0a20 2020 2073 746f 7261 6765  me().    storage
+0000a7d0: 5f6e 616d 6520 3d20 6627 736b 792d 7465  _name = f'sky-te
+0000a7e0: 7374 2d7b 696e 7428 7469 6d65 2e74 696d  st-{int(time.tim
+0000a7f0: 6528 2929 7d27 0a20 2020 2062 7563 6b65  e())}'.    bucke
+0000a800: 745f 7263 6c6f 6e65 5f70 726f 6669 6c65  t_rclone_profile
+0000a810: 203d 2052 636c 6f6e 652e 6765 6e65 7261   = Rclone.genera
+0000a820: 7465 5f72 636c 6f6e 655f 6275 636b 6574  te_rclone_bucket
+0000a830: 5f70 726f 6669 6c65 5f6e 616d 6528 0a20  _profile_name(. 
+0000a840: 2020 2020 2020 2073 746f 7261 6765 5f6e         storage_n
+0000a850: 616d 652c 2052 636c 6f6e 652e 5263 6c6f  ame, Rclone.Rclo
+0000a860: 6e65 436c 6f75 6473 2e49 424d 290a 2020  neClouds.IBM).  
+0000a870: 2020 7465 6d70 6c61 7465 5f73 7472 203d    template_str =
+0000a880: 2070 6174 686c 6962 2e50 6174 6828 0a20   pathlib.Path(. 
+0000a890: 2020 2020 2020 2027 7465 7374 732f 7465         'tests/te
+0000a8a0: 7374 5f79 616d 6c73 2f74 6573 745f 6962  st_yamls/test_ib
+0000a8b0: 6d5f 636f 735f 7374 6f72 6167 655f 6d6f  m_cos_storage_mo
+0000a8c0: 756e 7469 6e67 2e79 616d 6c27 292e 7265  unting.yaml').re
+0000a8d0: 6164 5f74 6578 7428 290a 2020 2020 7465  ad_text().    te
+0000a8e0: 6d70 6c61 7465 203d 206a 696e 6a61 322e  mplate = jinja2.
+0000a8f0: 5465 6d70 6c61 7465 2874 656d 706c 6174  Template(templat
+0000a900: 655f 7374 7229 0a20 2020 2063 6f6e 7465  e_str).    conte
+0000a910: 6e74 203d 2074 656d 706c 6174 652e 7265  nt = template.re
+0000a920: 6e64 6572 2873 746f 7261 6765 5f6e 616d  nder(storage_nam
+0000a930: 653d 7374 6f72 6167 655f 6e61 6d65 290a  e=storage_name).
+0000a940: 2020 2020 7769 7468 2074 656d 7066 696c      with tempfil
+0000a950: 652e 4e61 6d65 6454 656d 706f 7261 7279  e.NamedTemporary
+0000a960: 4669 6c65 2873 7566 6669 783d 272e 7961  File(suffix='.ya
+0000a970: 6d6c 272c 206d 6f64 653d 2777 2729 2061  ml', mode='w') a
+0000a980: 7320 663a 0a20 2020 2020 2020 2066 2e77  s f:.        f.w
+0000a990: 7269 7465 2863 6f6e 7465 6e74 290a 2020  rite(content).  
+0000a9a0: 2020 2020 2020 662e 666c 7573 6828 290a        f.flush().
+0000a9b0: 2020 2020 2020 2020 6669 6c65 5f70 6174          file_pat
+0000a9c0: 6820 3d20 662e 6e61 6d65 0a20 2020 2020  h = f.name.     
+0000a9d0: 2020 2074 6573 745f 636f 6d6d 616e 6473     test_commands
+0000a9e0: 203d 205b 0a20 2020 2020 2020 2020 2020   = [.           
+0000a9f0: 202a 7374 6f72 6167 655f 7365 7475 705f   *storage_setup_
+0000aa00: 636f 6d6d 616e 6473 2c0a 2020 2020 2020  commands,.      
+0000aa10: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
+0000aa20: 6368 202d 7920 2d63 207b 6e61 6d65 7d20  ch -y -c {name} 
+0000aa30: 2d2d 636c 6f75 6420 6962 6d20 7b66 696c  --cloud ibm {fil
+0000aa40: 655f 7061 7468 7d27 2c0a 2020 2020 2020  e_path}',.      
+0000aa50: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
+0000aa60: 207b 6e61 6d65 7d20 3120 2d2d 7374 6174   {name} 1 --stat
+0000aa70: 7573 272c 2020 2320 456e 7375 7265 206a  us',  # Ensure j
+0000aa80: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
+0000aa90: 2020 2020 2020 2020 2020 6627 7263 6c6f            f'rclo
+0000aaa0: 6e65 206c 7320 7b62 7563 6b65 745f 7263  ne ls {bucket_rc
+0000aab0: 6c6f 6e65 5f70 726f 6669 6c65 7d3a 7b73  lone_profile}:{s
+0000aac0: 746f 7261 6765 5f6e 616d 657d 2f68 656c  torage_name}/hel
+0000aad0: 6c6f 2e74 7874 272c 0a20 2020 2020 2020  lo.txt',.       
+0000aae0: 205d 0a20 2020 2020 2020 2074 6573 7420   ].        test 
+0000aaf0: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+0000ab00: 2020 2020 2769 626d 5f73 746f 7261 6765      'ibm_storage
+0000ab10: 5f6d 6f75 6e74 7327 2c0a 2020 2020 2020  _mounts',.      
+0000ab20: 2020 2020 2020 7465 7374 5f63 6f6d 6d61        test_comma
+0000ab30: 6e64 732c 0a20 2020 2020 2020 2020 2020  nds,.           
+0000ab40: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
+0000ab50: 6e61 6d65 7d3b 2073 6b79 2073 746f 7261  name}; sky stora
+0000ab60: 6765 2064 656c 6574 6520 2d79 207b 7374  ge delete -y {st
+0000ab70: 6f72 6167 655f 6e61 6d65 7d27 2c0a 2020  orage_name}',.  
+0000ab80: 2020 2020 2020 2020 2020 7469 6d65 6f75            timeou
+0000ab90: 743d 3230 202a 2036 302c 2020 2320 3230  t=20 * 60,  # 20
+0000aba0: 206d 696e 730a 2020 2020 2020 2020 290a   mins.        ).
+0000abb0: 2020 2020 2020 2020 7275 6e5f 6f6e 655f          run_one_
+0000abc0: 7465 7374 2874 6573 7429 0a0a 0a23 202d  test(test)...# -
+0000abd0: 2d2d 2d2d 2d2d 2d2d 2d20 434c 4920 6c6f  --------- CLI lo
+0000abe0: 6773 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070  gs ----------.@p
+0000abf0: 7974 6573 742e 6d61 726b 2e6e 6f5f 7363  ytest.mark.no_sc
+0000ac00: 7020 2023 2053 4350 2064 6f65 7320 6e6f  p  # SCP does no
+0000ac10: 7420 7375 7070 6f72 7420 6e75 6d5f 6e6f  t support num_no
+0000ac20: 6465 7320 3e20 3120 7965 742e 2052 756e  des > 1 yet. Run
+0000ac30: 2074 6573 745f 7363 705f 6c6f 6773 2069   test_scp_logs i
+0000ac40: 6e73 7465 6164 2e0a 6465 6620 7465 7374  nstead..def test
+0000ac50: 5f63 6c69 5f6c 6f67 7328 6765 6e65 7269  _cli_logs(generi
+0000ac60: 635f 636c 6f75 643a 2073 7472 293a 0a20  c_cloud: str):. 
+0000ac70: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
+0000ac80: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
+0000ac90: 2020 6e75 6d5f 6e6f 6465 7320 3d20 320a    num_nodes = 2.
+0000aca0: 2020 2020 6966 2067 656e 6572 6963 5f63      if generic_c
+0000acb0: 6c6f 7564 203d 3d20 276b 7562 6572 6e65  loud == 'kuberne
+0000acc0: 7465 7327 3a0a 2020 2020 2020 2020 2320  tes':.        # 
+0000acd0: 4b75 6265 726e 6574 6573 2064 6f65 7320  Kubernetes does 
+0000ace0: 6e6f 7420 7375 7070 6f72 7420 6d75 6c74  not support mult
+0000acf0: 692d 6e6f 6465 0a20 2020 2020 2020 206e  i-node.        n
+0000ad00: 756d 5f6e 6f64 6573 203d 2031 0a20 2020  um_nodes = 1.   
+0000ad10: 2074 696d 6573 7461 6d70 203d 2074 696d   timestamp = tim
+0000ad20: 652e 7469 6d65 2829 0a20 2020 2074 6573  e.time().    tes
+0000ad30: 7420 3d20 5465 7374 2827 636c 695f 6c6f  t = Test('cli_lo
+0000ad40: 6773 272c 205b 0a20 2020 2020 2020 2066  gs', [.        f
+0000ad50: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
+0000ad60: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
+0000ad70: 207b 6765 6e65 7269 635f 636c 6f75 647d   {generic_cloud}
+0000ad80: 202d 2d6e 756d 2d6e 6f64 6573 207b 6e75   --num-nodes {nu
+0000ad90: 6d5f 6e6f 6465 737d 2022 6563 686f 207b  m_nodes} "echo {
+0000ada0: 7469 6d65 7374 616d 707d 2031 2227 2c0a  timestamp} 1"',.
+0000adb0: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
+0000adc0: 6563 207b 6e61 6d65 7d20 2265 6368 6f20  ec {name} "echo 
+0000add0: 7b74 696d 6573 7461 6d70 7d20 3222 272c  {timestamp} 2"',
+0000ade0: 0a20 2020 2020 2020 2066 2773 6b79 2065  .        f'sky e
+0000adf0: 7865 6320 7b6e 616d 657d 2022 6563 686f  xec {name} "echo
+0000ae00: 207b 7469 6d65 7374 616d 707d 2033 2227   {timestamp} 3"'
+0000ae10: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
+0000ae20: 6578 6563 207b 6e61 6d65 7d20 2265 6368  exec {name} "ech
+0000ae30: 6f20 7b74 696d 6573 7461 6d70 7d20 3422  o {timestamp} 4"
+0000ae40: 272c 0a20 2020 2020 2020 2066 2773 6b79  ',.        f'sky
+0000ae50: 206c 6f67 7320 7b6e 616d 657d 2032 202d   logs {name} 2 -
+0000ae60: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
+0000ae70: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+0000ae80: 6d65 7d20 3320 3420 2d2d 7379 6e63 2d64  me} 3 4 --sync-d
+0000ae90: 6f77 6e27 2c0a 2020 2020 2020 2020 6627  own',.        f'
+0000aea0: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
+0000aeb0: 2a20 2d2d 7379 6e63 2d64 6f77 6e27 2c0a  * --sync-down',.
+0000aec0: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+0000aed0: 6773 207b 6e61 6d65 7d20 3120 7c20 6772  gs {name} 1 | gr
+0000aee0: 6570 2022 7b74 696d 6573 7461 6d70 7d20  ep "{timestamp} 
+0000aef0: 3122 272c 0a20 2020 2020 2020 2066 2773  1"',.        f's
+0000af00: 6b79 206c 6f67 7320 7b6e 616d 657d 207c  ky logs {name} |
+0000af10: 2067 7265 7020 227b 7469 6d65 7374 616d   grep "{timestam
+0000af20: 707d 2034 2227 2c0a 2020 2020 5d2c 2066  p} 4"',.    ], f
+0000af30: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
+0000af40: 6d65 7d27 290a 2020 2020 7275 6e5f 6f6e  me}').    run_on
+0000af50: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
+0000af60: 7079 7465 7374 2e6d 6172 6b2e 7363 700a  pytest.mark.scp.
+0000af70: 6465 6620 7465 7374 5f73 6370 5f6c 6f67  def test_scp_log
+0000af80: 7328 293a 0a20 2020 206e 616d 6520 3d20  s():.    name = 
+0000af90: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
+0000afa0: 6528 290a 2020 2020 7469 6d65 7374 616d  e().    timestam
+0000afb0: 7020 3d20 7469 6d65 2e74 696d 6528 290a  p = time.time().
+0000afc0: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
+0000afd0: 0a20 2020 2020 2020 2027 5343 505f 636c  .        'SCP_cl
+0000afe0: 695f 6c6f 6773 272c 0a20 2020 2020 2020  i_logs',.       
+0000aff0: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
+0000b000: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
+0000b010: 6320 7b6e 616d 657d 207b 5343 505f 5459  c {name} {SCP_TY
+0000b020: 5045 7d20 2265 6368 6f20 7b74 696d 6573  PE} "echo {times
+0000b030: 7461 6d70 7d20 3122 272c 0a20 2020 2020  tamp} 1"',.     
+0000b040: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
+0000b050: 6320 7b6e 616d 657d 2022 6563 686f 207b  c {name} "echo {
+0000b060: 7469 6d65 7374 616d 707d 2032 2227 2c0a  timestamp} 2"',.
+0000b070: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000b080: 7920 6578 6563 207b 6e61 6d65 7d20 2265  y exec {name} "e
+0000b090: 6368 6f20 7b74 696d 6573 7461 6d70 7d20  cho {timestamp} 
+0000b0a0: 3322 272c 0a20 2020 2020 2020 2020 2020  3"',.           
+0000b0b0: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
+0000b0c0: 657d 2022 6563 686f 207b 7469 6d65 7374  e} "echo {timest
+0000b0d0: 616d 707d 2034 2227 2c0a 2020 2020 2020  amp} 4"',.      
+0000b0e0: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
+0000b0f0: 207b 6e61 6d65 7d20 3220 2d2d 7374 6174   {name} 2 --stat
+0000b100: 7573 272c 0a20 2020 2020 2020 2020 2020  us',.           
+0000b110: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
+0000b120: 657d 2033 2034 202d 2d73 796e 632d 646f  e} 3 4 --sync-do
+0000b130: 776e 272c 0a20 2020 2020 2020 2020 2020  wn',.           
+0000b140: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
+0000b150: 657d 202a 202d 2d73 796e 632d 646f 776e  e} * --sync-down
+0000b160: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0000b170: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
+0000b180: 2031 207c 2067 7265 7020 227b 7469 6d65   1 | grep "{time
+0000b190: 7374 616d 707d 2031 2227 2c0a 2020 2020  stamp} 1"',.    
+0000b1a0: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+0000b1b0: 6773 207b 6e61 6d65 7d20 7c20 6772 6570  gs {name} | grep
+0000b1c0: 2022 7b74 696d 6573 7461 6d70 7d20 3422   "{timestamp} 4"
+0000b1d0: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
+0000b1e0: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
+0000b1f0: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
+0000b200: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
+0000b210: 6573 7428 7465 7374 290a 0a0a 2320 2d2d  est(test)...# --
+0000b220: 2d2d 2d2d 2d2d 2d2d 204a 6f62 2051 7565  -------- Job Que
+0000b230: 7565 2e20 2d2d 2d2d 2d2d 2d2d 2d2d 0a40  ue. ----------.@
+0000b240: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f66  pytest.mark.no_f
+0000b250: 6c75 6964 7374 6163 6b20 2023 2046 6c75  luidstack  # Flu
+0000b260: 6964 5374 6163 6b20 4443 2068 6173 206c  idStack DC has l
+0000b270: 6f77 2061 7661 696c 6162 696c 6974 7920  ow availability 
+0000b280: 6f66 2054 3420 4750 5573 0a40 7079 7465  of T4 GPUs.@pyte
+0000b290: 7374 2e6d 6172 6b2e 6e6f 5f6c 616d 6264  st.mark.no_lambd
+0000b2a0: 615f 636c 6f75 6420 2023 204c 616d 6264  a_cloud  # Lambd
+0000b2b0: 6120 436c 6f75 6420 646f 6573 206e 6f74  a Cloud does not
+0000b2c0: 2068 6176 6520 5434 2067 7075 730a 4070   have T4 gpus.@p
+0000b2d0: 7974 6573 742e 6d61 726b 2e6e 6f5f 6962  ytest.mark.no_ib
+0000b2e0: 6d20 2023 2049 424d 2043 6c6f 7564 2064  m  # IBM Cloud d
+0000b2f0: 6f65 7320 6e6f 7420 6861 7665 2054 3420  oes not have T4 
+0000b300: 6770 7573 2e20 7275 6e20 7465 7374 5f69  gpus. run test_i
+0000b310: 626d 5f6a 6f62 5f71 7565 7565 2069 6e73  bm_job_queue ins
+0000b320: 7465 6164 0a40 7079 7465 7374 2e6d 6172  tead.@pytest.mar
+0000b330: 6b2e 6e6f 5f73 6370 2020 2320 5343 5020  k.no_scp  # SCP 
+0000b340: 646f 6573 206e 6f74 2068 6176 6520 5434  does not have T4
+0000b350: 2067 7075 732e 2052 756e 2074 6573 745f   gpus. Run test_
+0000b360: 7363 705f 6a6f 625f 7175 6575 6520 696e  scp_job_queue in
+0000b370: 7374 6561 640a 4070 7974 6573 742e 6d61  stead.@pytest.ma
+0000b380: 726b 2e6e 6f5f 7061 7065 7273 7061 6365  rk.no_paperspace
+0000b390: 2020 2320 5061 7065 7273 7061 6365 2064    # Paperspace d
+0000b3a0: 6f65 7320 6e6f 7420 6861 7665 2054 3420  oes not have T4 
+0000b3b0: 6770 7573 2e0a 4070 7974 6573 742e 6d61  gpus..@pytest.ma
+0000b3c0: 726b 2e6e 6f5f 6f63 6920 2023 204f 4349  rk.no_oci  # OCI
+0000b3d0: 2064 6f65 7320 6e6f 7420 6861 7665 2054   does not have T
+0000b3e0: 3420 6770 7573 0a64 6566 2074 6573 745f  4 gpus.def test_
+0000b3f0: 6a6f 625f 7175 6575 6528 6765 6e65 7269  job_queue(generi
+0000b400: 635f 636c 6f75 643a 2073 7472 293a 0a20  c_cloud: str):. 
+0000b410: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
+0000b420: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
+0000b430: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
+0000b440: 2020 2020 2020 2027 6a6f 625f 7175 6575         'job_queu
+0000b450: 6527 2c0a 2020 2020 2020 2020 5b0a 2020  e',.        [.  
+0000b460: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0000b470: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
+0000b480: 6d65 7d20 2d2d 636c 6f75 6420 7b67 656e  me} --cloud {gen
+0000b490: 6572 6963 5f63 6c6f 7564 7d20 6578 616d  eric_cloud} exam
+0000b4a0: 706c 6573 2f6a 6f62 5f71 7565 7565 2f63  ples/job_queue/c
+0000b4b0: 6c75 7374 6572 2e79 616d 6c27 2c0a 2020  luster.yaml',.  
+0000b4c0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0000b4d0: 6578 6563 207b 6e61 6d65 7d20 2d6e 207b  exec {name} -n {
+0000b4e0: 6e61 6d65 7d2d 3120 2d64 2065 7861 6d70  name}-1 -d examp
+0000b4f0: 6c65 732f 6a6f 625f 7175 6575 652f 6a6f  les/job_queue/jo
+0000b500: 622e 7961 6d6c 272c 0a20 2020 2020 2020  b.yaml',.       
+0000b510: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
+0000b520: 7b6e 616d 657d 202d 6e20 7b6e 616d 657d  {name} -n {name}
+0000b530: 2d32 202d 6420 6578 616d 706c 6573 2f6a  -2 -d examples/j
+0000b540: 6f62 5f71 7565 7565 2f6a 6f62 2e79 616d  ob_queue/job.yam
+0000b550: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+0000b560: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
+0000b570: 7d20 2d6e 207b 6e61 6d65 7d2d 3320 2d64  } -n {name}-3 -d
+0000b580: 2065 7861 6d70 6c65 732f 6a6f 625f 7175   examples/job_qu
+0000b590: 6575 652f 6a6f 622e 7961 6d6c 272c 0a20  eue/job.yaml',. 
+0000b5a0: 2020 2020 2020 2020 2020 2066 2773 3d24             f's=$
+0000b5b0: 2873 6b79 2071 7565 7565 207b 6e61 6d65  (sky queue {name
+0000b5c0: 7d29 3b20 6563 686f 2022 2473 223b 2065  }); echo "$s"; e
+0000b5d0: 6368 6f3b 2065 6368 6f3b 2065 6368 6f20  cho; echo; echo 
+0000b5e0: 2224 7322 207c 2067 7265 7020 7b6e 616d  "$s" | grep {nam
+0000b5f0: 657d 2d31 207c 2067 7265 7020 5255 4e4e  e}-1 | grep RUNN
+0000b600: 494e 4727 2c0a 2020 2020 2020 2020 2020  ING',.          
+0000b610: 2020 6627 733d 2428 736b 7920 7175 6575    f's=$(sky queu
+0000b620: 6520 7b6e 616d 657d 293b 2065 6368 6f20  e {name}); echo 
+0000b630: 2224 7322 3b20 6563 686f 3b20 6563 686f  "$s"; echo; echo
+0000b640: 3b20 6563 686f 2022 2473 2220 7c20 6772  ; echo "$s" | gr
+0000b650: 6570 207b 6e61 6d65 7d2d 3220 7c20 6772  ep {name}-2 | gr
+0000b660: 6570 2052 554e 4e49 4e47 272c 0a20 2020  ep RUNNING',.   
+0000b670: 2020 2020 2020 2020 2066 2773 3d24 2873           f's=$(s
+0000b680: 6b79 2071 7565 7565 207b 6e61 6d65 7d29  ky queue {name})
+0000b690: 3b20 6563 686f 2022 2473 223b 2065 6368  ; echo "$s"; ech
+0000b6a0: 6f3b 2065 6368 6f3b 2065 6368 6f20 2224  o; echo; echo "$
+0000b6b0: 7322 207c 2067 7265 7020 7b6e 616d 657d  s" | grep {name}
+0000b6c0: 2d33 207c 2067 7265 7020 5045 4e44 494e  -3 | grep PENDIN
+0000b6d0: 4727 2c0a 2020 2020 2020 2020 2020 2020  G',.            
+0000b6e0: 6627 736b 7920 6361 6e63 656c 202d 7920  f'sky cancel -y 
+0000b6f0: 7b6e 616d 657d 2032 272c 0a20 2020 2020  {name} 2',.     
+0000b700: 2020 2020 2020 2027 736c 6565 7020 3527         'sleep 5'
+0000b710: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0000b720: 733d 2428 736b 7920 7175 6575 6520 7b6e  s=$(sky queue {n
+0000b730: 616d 657d 293b 2065 6368 6f20 2224 7322  ame}); echo "$s"
+0000b740: 3b20 6563 686f 3b20 6563 686f 3b20 6563  ; echo; echo; ec
+0000b750: 686f 2022 2473 2220 7c20 6772 6570 207b  ho "$s" | grep {
+0000b760: 6e61 6d65 7d2d 3320 7c20 6772 6570 2052  name}-3 | grep R
+0000b770: 554e 4e49 4e47 272c 0a20 2020 2020 2020  UNNING',.       
+0000b780: 2020 2020 2066 2773 6b79 2063 616e 6365       f'sky cance
+0000b790: 6c20 2d79 207b 6e61 6d65 7d20 3327 2c0a  l -y {name} 3',.
+0000b7a0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000b7b0: 7920 6578 6563 207b 6e61 6d65 7d20 2d2d  y exec {name} --
+0000b7c0: 6770 7573 2054 343a 302e 3220 225b 5b20  gpus T4:0.2 "[[ 
+0000b7d0: 5c24 534b 5950 494c 4f54 5f4e 554d 5f47  \$SKYPILOT_NUM_G
+0000b7e0: 5055 535f 5045 525f 4e4f 4445 202d 6571  PUS_PER_NODE -eq
+0000b7f0: 2031 205d 5d20 7c7c 2065 7869 7420 3122   1 ]] || exit 1"
+0000b800: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0000b810: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+0000b820: 202d 2d67 7075 7320 5434 3a31 2022 5b5b   --gpus T4:1 "[[
+0000b830: 205c 2453 4b59 5049 4c4f 545f 4e55 4d5f   \$SKYPILOT_NUM_
+0000b840: 4750 5553 5f50 4552 5f4e 4f44 4520 2d65  GPUS_PER_NODE -e
+0000b850: 7120 3120 5d5d 207c 7c20 6578 6974 2031  q 1 ]] || exit 1
+0000b860: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+0000b870: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+0000b880: 7d20 3420 2d2d 7374 6174 7573 272c 0a20  } 4 --status',. 
+0000b890: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0000b8a0: 206c 6f67 7320 7b6e 616d 657d 2035 202d   logs {name} 5 -
+0000b8b0: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
+0000b8c0: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
+0000b8d0: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
+0000b8e0: 7d27 2c0a 2020 2020 290a 2020 2020 7275  }',.    ).    ru
+0000b8f0: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
+0000b900: 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20  ...# ---------- 
+0000b910: 4a6f 6220 5175 6575 6520 7769 7468 2044  Job Queue with D
+0000b920: 6f63 6b65 722e 202d 2d2d 2d2d 2d2d 2d2d  ocker. ---------
+0000b930: 2d0a 4070 7974 6573 742e 6d61 726b 2e6e  -.@pytest.mark.n
+0000b940: 6f5f 666c 7569 6473 7461 636b 2020 2320  o_fluidstack  # 
+0000b950: 466c 7569 6453 7461 636b 2064 6f65 7320  FluidStack does 
+0000b960: 6e6f 7420 7375 7070 6f72 7420 646f 636b  not support dock
+0000b970: 6572 2066 6f72 206e 6f77 0a40 7079 7465  er for now.@pyte
+0000b980: 7374 2e6d 6172 6b2e 6e6f 5f6c 616d 6264  st.mark.no_lambd
+0000b990: 615f 636c 6f75 6420 2023 2044 6f65 736e  a_cloud  # Doesn
+0000b9a0: 2774 2073 7570 706f 7274 204c 616d 6264  't support Lambd
+0000b9b0: 6120 436c 6f75 6420 666f 7220 6e6f 770a  a Cloud for now.
+0000b9c0: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+0000b9d0: 6962 6d20 2023 2044 6f65 736e 2774 2073  ibm  # Doesn't s
+0000b9e0: 7570 706f 7274 2049 424d 2043 6c6f 7564  upport IBM Cloud
+0000b9f0: 2066 6f72 206e 6f77 0a40 7079 7465 7374   for now.@pytest
+0000ba00: 2e6d 6172 6b2e 6e6f 5f70 6170 6572 7370  .mark.no_papersp
+0000ba10: 6163 6520 2023 2050 6170 6572 7370 6163  ace  # Paperspac
+0000ba20: 6520 646f 6573 6e27 7420 6861 7665 2054  e doesn't have T
+0000ba30: 3420 4750 5573 0a40 7079 7465 7374 2e6d  4 GPUs.@pytest.m
+0000ba40: 6172 6b2e 6e6f 5f73 6370 2020 2320 446f  ark.no_scp  # Do
+0000ba50: 6573 6e27 7420 7375 7070 6f72 7420 5343  esn't support SC
+0000ba60: 5020 666f 7220 6e6f 770a 4070 7974 6573  P for now.@pytes
+0000ba70: 742e 6d61 726b 2e6e 6f5f 6f63 6920 2023  t.mark.no_oci  #
+0000ba80: 2044 6f65 736e 2774 2073 7570 706f 7274   Doesn't support
+0000ba90: 204f 4349 2066 6f72 206e 6f77 0a40 7079   OCI for now.@py
+0000baa0: 7465 7374 2e6d 6172 6b2e 6e6f 5f6b 7562  test.mark.no_kub
+0000bab0: 6572 6e65 7465 7320 2023 2044 6f65 736e  ernetes  # Doesn
+0000bac0: 2774 2073 7570 706f 7274 204b 7562 6572  't support Kuber
+0000bad0: 6e65 7465 7320 666f 7220 6e6f 770a 4070  netes for now.@p
+0000bae0: 7974 6573 742e 6d61 726b 2e70 6172 616d  ytest.mark.param
+0000baf0: 6574 7269 7a65 280a 2020 2020 2769 6d61  etrize(.    'ima
+0000bb00: 6765 5f69 6427 2c0a 2020 2020 5b0a 2020  ge_id',.    [.  
+0000bb10: 2020 2020 2020 2764 6f63 6b65 723a 6e76        'docker:nv
+0000bb20: 6964 6961 2f63 7564 613a 3131 2e38 2e30  idia/cuda:11.8.0
+0000bb30: 2d64 6576 656c 2d75 6275 6e74 7531 382e  -devel-ubuntu18.
+0000bb40: 3034 272c 0a20 2020 2020 2020 2027 646f  04',.        'do
+0000bb50: 636b 6572 3a75 6275 6e74 753a 3138 2e30  cker:ubuntu:18.0
+0000bb60: 3427 2c0a 2020 2020 2020 2020 2320 5465  4',.        # Te
+0000bb70: 7374 206c 6174 6573 7420 696d 6167 6520  st latest image 
+0000bb80: 7769 7468 2070 7974 686f 6e20 332e 3131  with python 3.11
+0000bb90: 2069 6e73 7461 6c6c 6564 2062 7920 6465   installed by de
+0000bba0: 6661 756c 742e 0a20 2020 2020 2020 2023  fault..        #
+0000bbb0: 2044 6f65 7320 6e6f 7420 776f 726b 2066   Does not work f
+0000bbc0: 6f72 2070 7974 686f 6e20 332e 3132 2064  or python 3.12 d
+0000bbd0: 7565 2074 6f20 7261 7927 7320 7265 7175  ue to ray's requ
+0000bbe0: 6972 656d 656e 7420 666f 7220 332e 3131  irement for 3.11
+0000bbf0: 2e0a 2020 2020 2020 2020 2764 6f63 6b65  ..        'docke
+0000bc00: 723a 636f 6e74 696e 7575 6d69 6f2f 6d69  r:continuumio/mi
+0000bc10: 6e69 636f 6e64 6133 3a32 342e 312e 322d  niconda3:24.1.2-
+0000bc20: 3027 2c0a 2020 2020 5d29 0a64 6566 2074  0',.    ]).def t
+0000bc30: 6573 745f 6a6f 625f 7175 6575 655f 7769  est_job_queue_wi
+0000bc40: 7468 5f64 6f63 6b65 7228 6765 6e65 7269  th_docker(generi
+0000bc50: 635f 636c 6f75 643a 2073 7472 2c20 696d  c_cloud: str, im
+0000bc60: 6167 655f 6964 3a20 7374 7229 3a0a 2020  age_id: str):.  
+0000bc70: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
+0000bc80: 7573 7465 725f 6e61 6d65 2829 202b 2069  uster_name() + i
+0000bc90: 6d61 6765 5f69 645b 6c65 6e28 2764 6f63  mage_id[len('doc
+0000bca0: 6b65 723a 2729 3a5d 5b3a 345d 0a20 2020  ker:'):][:4].   
+0000bcb0: 2074 6f74 616c 5f74 696d 656f 7574 5f6d   total_timeout_m
+0000bcc0: 696e 7574 6573 203d 2034 3020 6966 2067  inutes = 40 if g
+0000bcd0: 656e 6572 6963 5f63 6c6f 7564 203d 3d20  eneric_cloud == 
+0000bce0: 2761 7a75 7265 2720 656c 7365 2031 350a  'azure' else 15.
+0000bcf0: 2020 2020 7469 6d65 5f74 6f5f 736c 6565      time_to_slee
+0000bd00: 7020 3d20 3330 3020 6966 2067 656e 6572  p = 300 if gener
+0000bd10: 6963 5f63 6c6f 7564 203d 3d20 2761 7a75  ic_cloud == 'azu
+0000bd20: 7265 2720 656c 7365 2031 3830 0a20 2020  re' else 180.   
+0000bd30: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+0000bd40: 2020 2020 2020 276a 6f62 5f71 7565 7565        'job_queue
+0000bd50: 5f77 6974 685f 646f 636b 6572 272c 0a20  _with_docker',. 
+0000bd60: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
+0000bd70: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
+0000bd80: 6820 2d79 202d 6320 7b6e 616d 657d 202d  h -y -c {name} -
+0000bd90: 2d63 6c6f 7564 207b 6765 6e65 7269 635f  -cloud {generic_
+0000bda0: 636c 6f75 647d 202d 2d69 6d61 6765 2d69  cloud} --image-i
+0000bdb0: 6420 7b69 6d61 6765 5f69 647d 2065 7861  d {image_id} exa
+0000bdc0: 6d70 6c65 732f 6a6f 625f 7175 6575 652f  mples/job_queue/
+0000bdd0: 636c 7573 7465 725f 646f 636b 6572 2e79  cluster_docker.y
+0000bde0: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+0000bdf0: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
+0000be00: 6d65 7d20 2d6e 207b 6e61 6d65 7d2d 3120  me} -n {name}-1 
+0000be10: 2d64 202d 2d69 6d61 6765 2d69 6420 7b69  -d --image-id {i
+0000be20: 6d61 6765 5f69 647d 202d 2d65 6e76 2054  mage_id} --env T
+0000be30: 494d 455f 544f 5f53 4c45 4550 3d7b 7469  IME_TO_SLEEP={ti
+0000be40: 6d65 5f74 6f5f 736c 6565 707d 2065 7861  me_to_sleep} exa
+0000be50: 6d70 6c65 732f 6a6f 625f 7175 6575 652f  mples/job_queue/
+0000be60: 6a6f 625f 646f 636b 6572 2e79 616d 6c27  job_docker.yaml'
+0000be70: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0000be80: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
+0000be90: 2d6e 207b 6e61 6d65 7d2d 3220 2d64 202d  -n {name}-2 -d -
+0000bea0: 2d69 6d61 6765 2d69 6420 7b69 6d61 6765  -image-id {image
+0000beb0: 5f69 647d 202d 2d65 6e76 2054 494d 455f  _id} --env TIME_
+0000bec0: 544f 5f53 4c45 4550 3d7b 7469 6d65 5f74  TO_SLEEP={time_t
+0000bed0: 6f5f 736c 6565 707d 2065 7861 6d70 6c65  o_sleep} example
+0000bee0: 732f 6a6f 625f 7175 6575 652f 6a6f 625f  s/job_queue/job_
+0000bef0: 646f 636b 6572 2e79 616d 6c27 2c0a 2020  docker.yaml',.  
+0000bf00: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0000bf10: 6578 6563 207b 6e61 6d65 7d20 2d6e 207b  exec {name} -n {
+0000bf20: 6e61 6d65 7d2d 3320 2d64 202d 2d69 6d61  name}-3 -d --ima
+0000bf30: 6765 2d69 6420 7b69 6d61 6765 5f69 647d  ge-id {image_id}
+0000bf40: 202d 2d65 6e76 2054 494d 455f 544f 5f53   --env TIME_TO_S
+0000bf50: 4c45 4550 3d7b 7469 6d65 5f74 6f5f 736c  LEEP={time_to_sl
+0000bf60: 6565 707d 2065 7861 6d70 6c65 732f 6a6f  eep} examples/jo
+0000bf70: 625f 7175 6575 652f 6a6f 625f 646f 636b  b_queue/job_dock
+0000bf80: 6572 2e79 616d 6c27 2c0a 2020 2020 2020  er.yaml',.      
+0000bf90: 2020 2020 2020 6627 733d 2428 736b 7920        f's=$(sky 
+0000bfa0: 7175 6575 6520 7b6e 616d 657d 293b 2065  queue {name}); e
+0000bfb0: 6368 6f20 2224 7322 3b20 6563 686f 3b20  cho "$s"; echo; 
+0000bfc0: 6563 686f 3b20 6563 686f 2022 2473 2220  echo; echo "$s" 
+0000bfd0: 7c20 6772 6570 207b 6e61 6d65 7d2d 3120  | grep {name}-1 
+0000bfe0: 7c20 6772 6570 2052 554e 4e49 4e47 272c  | grep RUNNING',
+0000bff0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000c000: 3d24 2873 6b79 2071 7565 7565 207b 6e61  =$(sky queue {na
+0000c010: 6d65 7d29 3b20 6563 686f 2022 2473 223b  me}); echo "$s";
+0000c020: 2065 6368 6f3b 2065 6368 6f3b 2065 6368   echo; echo; ech
+0000c030: 6f20 2224 7322 207c 2067 7265 7020 7b6e  o "$s" | grep {n
+0000c040: 616d 657d 2d32 207c 2067 7265 7020 5255  ame}-2 | grep RU
+0000c050: 4e4e 494e 4727 2c0a 2020 2020 2020 2020  NNING',.        
+0000c060: 2020 2020 6627 733d 2428 736b 7920 7175      f's=$(sky qu
+0000c070: 6575 6520 7b6e 616d 657d 293b 2065 6368  eue {name}); ech
+0000c080: 6f20 2224 7322 3b20 6563 686f 3b20 6563  o "$s"; echo; ec
+0000c090: 686f 3b20 6563 686f 2022 2473 2220 7c20  ho; echo "$s" | 
+0000c0a0: 6772 6570 207b 6e61 6d65 7d2d 3320 7c20  grep {name}-3 | 
+0000c0b0: 6772 6570 2050 454e 4449 4e47 272c 0a20  grep PENDING',. 
+0000c0c0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0000c0d0: 2063 616e 6365 6c20 2d79 207b 6e61 6d65   cancel -y {name
+0000c0e0: 7d20 3227 2c0a 2020 2020 2020 2020 2020  } 2',.          
+0000c0f0: 2020 2773 6c65 6570 2035 272c 0a20 2020    'sleep 5',.   
+0000c100: 2020 2020 2020 2020 2066 2773 3d24 2873           f's=$(s
+0000c110: 6b79 2071 7565 7565 207b 6e61 6d65 7d29  ky queue {name})
+0000c120: 3b20 6563 686f 2022 2473 223b 2065 6368  ; echo "$s"; ech
+0000c130: 6f3b 2065 6368 6f3b 2065 6368 6f20 2224  o; echo; echo "$
+0000c140: 7322 207c 2067 7265 7020 7b6e 616d 657d  s" | grep {name}
+0000c150: 2d33 207c 2067 7265 7020 5255 4e4e 494e  -3 | grep RUNNIN
+0000c160: 4727 2c0a 2020 2020 2020 2020 2020 2020  G',.            
+0000c170: 6627 736b 7920 6361 6e63 656c 202d 7920  f'sky cancel -y 
+0000c180: 7b6e 616d 657d 2033 272c 0a20 2020 2020  {name} 3',.     
+0000c190: 2020 2020 2020 2023 204d 616b 6520 7375         # Make su
+0000c1a0: 7265 2074 6865 2047 5055 2069 7320 7374  re the GPU is st
+0000c1b0: 696c 6c20 7669 7369 626c 6520 746f 2074  ill visible to t
+0000c1c0: 6865 2063 6f6e 7461 696e 6572 2e0a 2020  he container..  
+0000c1d0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0000c1e0: 6578 6563 207b 6e61 6d65 7d20 2d2d 696d  exec {name} --im
+0000c1f0: 6167 652d 6964 207b 696d 6167 655f 6964  age-id {image_id
+0000c200: 7d20 6e76 6964 6961 2d73 6d69 207c 2067  } nvidia-smi | g
+0000c210: 7265 7020 2254 6573 6c61 2054 3422 272c  rep "Tesla T4"',
+0000c220: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000c230: 6b79 206c 6f67 7320 7b6e 616d 657d 2034  ky logs {name} 4
+0000c240: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
+0000c250: 2020 2020 2020 2020 6627 736b 7920 7374          f'sky st
+0000c260: 6f70 202d 7920 7b6e 616d 657d 272c 0a20  op -y {name}',. 
+0000c270: 2020 2020 2020 2020 2020 2023 204d 616b             # Mak
+0000c280: 6520 7375 7265 2074 6865 206a 6f62 2073  e sure the job s
+0000c290: 7461 7475 7320 7072 6573 6572 7665 2061  tatus preserve a
+0000c2a0: 6674 6572 2073 746f 7020 616e 6420 7374  fter stop and st
+0000c2b0: 6172 7420 7468 650a 2020 2020 2020 2020  art the.        
+0000c2c0: 2020 2020 2320 636c 7573 7465 722e 2054      # cluster. T
+0000c2d0: 6869 7320 6973 2061 6c73 6f20 6120 7465  his is also a te
+0000c2e0: 7374 2066 6f72 2074 6865 2064 6f63 6b65  st for the docke
+0000c2f0: 7220 636f 6e74 6169 6e65 7220 746f 2062  r container to b
+0000c300: 650a 2020 2020 2020 2020 2020 2020 2320  e.            # 
+0000c310: 7072 6573 6572 7665 6420 6166 7465 7220  preserved after 
+0000c320: 7374 6f70 2061 6e64 2073 7461 7274 2e0a  stop and start..
+0000c330: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000c340: 7920 7374 6172 7420 2d79 207b 6e61 6d65  y start -y {name
+0000c350: 7d27 2c0a 2020 2020 2020 2020 2020 2020  }',.            
+0000c360: 6627 733d 2428 736b 7920 7175 6575 6520  f's=$(sky queue 
+0000c370: 7b6e 616d 657d 293b 2065 6368 6f20 2224  {name}); echo "$
+0000c380: 7322 3b20 6563 686f 3b20 6563 686f 3b20  s"; echo; echo; 
+0000c390: 6563 686f 2022 2473 2220 7c20 6772 6570  echo "$s" | grep
+0000c3a0: 207b 6e61 6d65 7d2d 3120 7c20 6772 6570   {name}-1 | grep
+0000c3b0: 2046 4149 4c45 4427 2c0a 2020 2020 2020   FAILED',.      
+0000c3c0: 2020 2020 2020 6627 733d 2428 736b 7920        f's=$(sky 
+0000c3d0: 7175 6575 6520 7b6e 616d 657d 293b 2065  queue {name}); e
+0000c3e0: 6368 6f20 2224 7322 3b20 6563 686f 3b20  cho "$s"; echo; 
+0000c3f0: 6563 686f 3b20 6563 686f 2022 2473 2220  echo; echo "$s" 
+0000c400: 7c20 6772 6570 207b 6e61 6d65 7d2d 3220  | grep {name}-2 
+0000c410: 7c20 6772 6570 2043 414e 4345 4c4c 4544  | grep CANCELLED
+0000c420: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0000c430: 2773 3d24 2873 6b79 2071 7565 7565 207b  's=$(sky queue {
+0000c440: 6e61 6d65 7d29 3b20 6563 686f 2022 2473  name}); echo "$s
+0000c450: 223b 2065 6368 6f3b 2065 6368 6f3b 2065  "; echo; echo; e
+0000c460: 6368 6f20 2224 7322 207c 2067 7265 7020  cho "$s" | grep 
+0000c470: 7b6e 616d 657d 2d33 207c 2067 7265 7020  {name}-3 | grep 
+0000c480: 4341 4e43 454c 4c45 4427 2c0a 2020 2020  CANCELLED',.    
+0000c490: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
+0000c4a0: 6563 207b 6e61 6d65 7d20 2d2d 6770 7573  ec {name} --gpus
+0000c4b0: 2054 343a 302e 3220 225b 5b20 5c24 534b   T4:0.2 "[[ \$SK
+0000c4c0: 5950 494c 4f54 5f4e 554d 5f47 5055 535f  YPILOT_NUM_GPUS_
+0000c4d0: 5045 525f 4e4f 4445 202d 6571 2031 205d  PER_NODE -eq 1 ]
+0000c4e0: 5d20 7c7c 2065 7869 7420 3122 272c 0a20  ] || exit 1"',. 
+0000c4f0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0000c500: 2065 7865 6320 7b6e 616d 657d 202d 2d67   exec {name} --g
+0000c510: 7075 7320 5434 3a31 2022 5b5b 205c 2453  pus T4:1 "[[ \$S
+0000c520: 4b59 5049 4c4f 545f 4e55 4d5f 4750 5553  KYPILOT_NUM_GPUS
+0000c530: 5f50 4552 5f4e 4f44 4520 2d65 7120 3120  _PER_NODE -eq 1 
+0000c540: 5d5d 207c 7c20 6578 6974 2031 2227 2c0a  ]] || exit 1"',.
+0000c550: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000c560: 7920 6c6f 6773 207b 6e61 6d65 7d20 3520  y logs {name} 5 
+0000c570: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
+0000c580: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+0000c590: 7320 7b6e 616d 657d 2036 202d 2d73 7461  s {name} 6 --sta
+0000c5a0: 7475 7327 2c0a 2020 2020 2020 2020 2020  tus',.          
+0000c5b0: 2020 2320 4d61 6b65 2073 7572 6520 6974    # Make sure it
+0000c5c0: 2069 7320 7374 696c 6c20 7669 7369 626c   is still visibl
+0000c5d0: 6520 6166 7465 7220 616e 2073 746f 7020  e after an stop 
+0000c5e0: 2620 7374 6172 7420 6379 636c 652e 0a20  & start cycle.. 
+0000c5f0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0000c600: 2065 7865 6320 7b6e 616d 657d 202d 2d69   exec {name} --i
+0000c610: 6d61 6765 2d69 6420 7b69 6d61 6765 5f69  mage-id {image_i
+0000c620: 647d 206e 7669 6469 612d 736d 6920 7c20  d} nvidia-smi | 
+0000c630: 6772 6570 2022 5465 736c 6120 5434 2227  grep "Tesla T4"'
+0000c640: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0000c650: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
+0000c660: 3720 2d2d 7374 6174 7573 270a 2020 2020  7 --status'.    
+0000c670: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
+0000c680: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
+0000c690: 6d65 7d27 2c0a 2020 2020 2020 2020 7469  me}',.        ti
+0000c6a0: 6d65 6f75 743d 746f 7461 6c5f 7469 6d65  meout=total_time
+0000c6b0: 6f75 745f 6d69 6e75 7465 7320 2a20 3630  out_minutes * 60
+0000c6c0: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
+0000c6d0: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
+0000c6e0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6c61  .@pytest.mark.la
+0000c6f0: 6d62 6461 5f63 6c6f 7564 0a64 6566 2074  mbda_cloud.def t
+0000c700: 6573 745f 6c61 6d62 6461 5f6a 6f62 5f71  est_lambda_job_q
+0000c710: 7565 7565 2829 3a0a 2020 2020 6e61 6d65  ueue():.    name
+0000c720: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
+0000c730: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
+0000c740: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+0000c750: 276c 616d 6264 615f 6a6f 625f 7175 6575  'lambda_job_queu
+0000c760: 6527 2c0a 2020 2020 2020 2020 5b0a 2020  e',.        [.  
+0000c770: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0000c780: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
+0000c790: 6d65 7d20 7b4c 414d 4244 415f 5459 5045  me} {LAMBDA_TYPE
+0000c7a0: 7d20 6578 616d 706c 6573 2f6a 6f62 5f71  } examples/job_q
+0000c7b0: 7565 7565 2f63 6c75 7374 6572 2e79 616d  ueue/cluster.yam
+0000c7c0: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+0000c7d0: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
+0000c7e0: 7d20 2d6e 207b 6e61 6d65 7d2d 3120 2d2d  } -n {name}-1 --
+0000c7f0: 6770 7573 2041 3130 3a30 2e35 202d 6420  gpus A10:0.5 -d 
+0000c800: 6578 616d 706c 6573 2f6a 6f62 5f71 7565  examples/job_que
+0000c810: 7565 2f6a 6f62 2e79 616d 6c27 2c0a 2020  ue/job.yaml',.  
+0000c820: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0000c830: 6578 6563 207b 6e61 6d65 7d20 2d6e 207b  exec {name} -n {
+0000c840: 6e61 6d65 7d2d 3220 2d2d 6770 7573 2041  name}-2 --gpus A
+0000c850: 3130 3a30 2e35 202d 6420 6578 616d 706c  10:0.5 -d exampl
+0000c860: 6573 2f6a 6f62 5f71 7565 7565 2f6a 6f62  es/job_queue/job
+0000c870: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
+0000c880: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
+0000c890: 6e61 6d65 7d20 2d6e 207b 6e61 6d65 7d2d  name} -n {name}-
+0000c8a0: 3320 2d2d 6770 7573 2041 3130 3a30 2e35  3 --gpus A10:0.5
+0000c8b0: 202d 6420 6578 616d 706c 6573 2f6a 6f62   -d examples/job
+0000c8c0: 5f71 7565 7565 2f6a 6f62 2e79 616d 6c27  _queue/job.yaml'
+0000c8d0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0000c8e0: 736b 7920 7175 6575 6520 7b6e 616d 657d  sky queue {name}
+0000c8f0: 207c 2067 7265 7020 7b6e 616d 657d 2d31   | grep {name}-1
+0000c900: 207c 2067 7265 7020 5255 4e4e 494e 4727   | grep RUNNING'
+0000c910: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0000c920: 736b 7920 7175 6575 6520 7b6e 616d 657d  sky queue {name}
+0000c930: 207c 2067 7265 7020 7b6e 616d 657d 2d32   | grep {name}-2
+0000c940: 207c 2067 7265 7020 5255 4e4e 494e 4727   | grep RUNNING'
+0000c950: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0000c960: 736b 7920 7175 6575 6520 7b6e 616d 657d  sky queue {name}
+0000c970: 207c 2067 7265 7020 7b6e 616d 657d 2d33   | grep {name}-3
+0000c980: 207c 2067 7265 7020 5045 4e44 494e 4727   | grep PENDING'
+0000c990: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0000c9a0: 736b 7920 6361 6e63 656c 202d 7920 7b6e  sky cancel -y {n
+0000c9b0: 616d 657d 2032 272c 0a20 2020 2020 2020  ame} 2',.       
+0000c9c0: 2020 2020 2027 736c 6565 7020 3527 2c0a       'sleep 5',.
+0000c9d0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000c9e0: 7920 7175 6575 6520 7b6e 616d 657d 207c  y queue {name} |
+0000c9f0: 2067 7265 7020 7b6e 616d 657d 2d33 207c   grep {name}-3 |
+0000ca00: 2067 7265 7020 5255 4e4e 494e 4727 2c0a   grep RUNNING',.
+0000ca10: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000ca20: 7920 6361 6e63 656c 202d 7920 7b6e 616d  y cancel -y {nam
+0000ca30: 657d 2033 272c 0a20 2020 2020 2020 205d  e} 3',.        ]
+0000ca40: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
+0000ca50: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
+0000ca60: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+0000ca70: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+0000ca80: 4070 7974 6573 742e 6d61 726b 2e69 626d  @pytest.mark.ibm
+0000ca90: 0a64 6566 2074 6573 745f 6962 6d5f 6a6f  .def test_ibm_jo
+0000caa0: 625f 7175 6575 6528 293a 0a20 2020 206e  b_queue():.    n
+0000cab0: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
+0000cac0: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
+0000cad0: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+0000cae0: 2020 2027 6962 6d5f 6a6f 625f 7175 6575     'ibm_job_queu
+0000caf0: 6527 2c0a 2020 2020 2020 2020 5b0a 2020  e',.        [.  
+0000cb00: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0000cb10: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
+0000cb20: 6d65 7d20 2d2d 636c 6f75 6420 6962 6d20  me} --cloud ibm 
+0000cb30: 2d2d 6770 7573 2076 3130 3027 2c0a 2020  --gpus v100',.  
+0000cb40: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0000cb50: 6578 6563 207b 6e61 6d65 7d20 2d6e 207b  exec {name} -n {
+0000cb60: 6e61 6d65 7d2d 3120 2d2d 636c 6f75 6420  name}-1 --cloud 
+0000cb70: 6962 6d20 2d64 2065 7861 6d70 6c65 732f  ibm -d examples/
+0000cb80: 6a6f 625f 7175 6575 652f 6a6f 625f 6962  job_queue/job_ib
+0000cb90: 6d2e 7961 6d6c 272c 0a20 2020 2020 2020  m.yaml',.       
+0000cba0: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
+0000cbb0: 7b6e 616d 657d 202d 6e20 7b6e 616d 657d  {name} -n {name}
+0000cbc0: 2d32 202d 2d63 6c6f 7564 2069 626d 202d  -2 --cloud ibm -
+0000cbd0: 6420 6578 616d 706c 6573 2f6a 6f62 5f71  d examples/job_q
+0000cbe0: 7565 7565 2f6a 6f62 5f69 626d 2e79 616d  ueue/job_ibm.yam
+0000cbf0: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+0000cc00: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
+0000cc10: 7d20 2d6e 207b 6e61 6d65 7d2d 3320 2d2d  } -n {name}-3 --
+0000cc20: 636c 6f75 6420 6962 6d20 2d64 2065 7861  cloud ibm -d exa
+0000cc30: 6d70 6c65 732f 6a6f 625f 7175 6575 652f  mples/job_queue/
+0000cc40: 6a6f 625f 6962 6d2e 7961 6d6c 272c 0a20  job_ibm.yaml',. 
+0000cc50: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0000cc60: 2071 7565 7565 207b 6e61 6d65 7d20 7c20   queue {name} | 
+0000cc70: 6772 6570 207b 6e61 6d65 7d2d 3120 7c20  grep {name}-1 | 
+0000cc80: 6772 6570 2052 554e 4e49 4e47 272c 0a20  grep RUNNING',. 
+0000cc90: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0000cca0: 2071 7565 7565 207b 6e61 6d65 7d20 7c20   queue {name} | 
+0000ccb0: 6772 6570 207b 6e61 6d65 7d2d 3220 7c20  grep {name}-2 | 
+0000ccc0: 6772 6570 2052 554e 4e49 4e47 272c 0a20  grep RUNNING',. 
+0000ccd0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0000cce0: 2071 7565 7565 207b 6e61 6d65 7d20 7c20   queue {name} | 
+0000ccf0: 6772 6570 207b 6e61 6d65 7d2d 3320 7c20  grep {name}-3 | 
+0000cd00: 6772 6570 2050 454e 4449 4e47 272c 0a20  grep PENDING',. 
+0000cd10: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0000cd20: 2063 616e 6365 6c20 2d79 207b 6e61 6d65   cancel -y {name
+0000cd30: 7d20 3227 2c0a 2020 2020 2020 2020 2020  } 2',.          
+0000cd40: 2020 2773 6c65 6570 2035 272c 0a20 2020    'sleep 5',.   
+0000cd50: 2020 2020 2020 2020 2066 2773 6b79 2071           f'sky q
+0000cd60: 7565 7565 207b 6e61 6d65 7d20 7c20 6772  ueue {name} | gr
+0000cd70: 6570 207b 6e61 6d65 7d2d 3320 7c20 6772  ep {name}-3 | gr
+0000cd80: 6570 2052 554e 4e49 4e47 272c 0a20 2020  ep RUNNING',.   
+0000cd90: 2020 2020 2020 2020 2066 2773 6b79 2063           f'sky c
+0000cda0: 616e 6365 6c20 2d79 207b 6e61 6d65 7d20  ancel -y {name} 
+0000cdb0: 3327 2c0a 2020 2020 2020 2020 5d2c 0a20  3',.        ],. 
+0000cdc0: 2020 2020 2020 2066 2773 6b79 2064 6f77         f'sky dow
+0000cdd0: 6e20 2d79 207b 6e61 6d65 7d27 2c0a 2020  n -y {name}',.  
+0000cde0: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
+0000cdf0: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
+0000ce00: 7465 7374 2e6d 6172 6b2e 7363 700a 6465  test.mark.scp.de
+0000ce10: 6620 7465 7374 5f73 6370 5f6a 6f62 5f71  f test_scp_job_q
+0000ce20: 7565 7565 2829 3a0a 2020 2020 6e61 6d65  ueue():.    name
+0000ce30: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
+0000ce40: 6e61 6d65 2829 0a20 2020 206e 756d 5f6f  name().    num_o
+0000ce50: 665f 6770 755f 6c61 756e 6368 203d 2031  f_gpu_launch = 1
+0000ce60: 0a20 2020 206e 756d 5f6f 665f 6770 755f  .    num_of_gpu_
+0000ce70: 6578 6563 203d 2030 2e35 0a20 2020 2074  exec = 0.5.    t
+0000ce80: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+0000ce90: 2020 2020 2753 4350 5f6a 6f62 5f71 7565      'SCP_job_que
+0000cea0: 7565 272c 0a20 2020 2020 2020 205b 0a20  ue',.        [. 
+0000ceb0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0000cec0: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
+0000ced0: 616d 657d 207b 5343 505f 5459 5045 7d20  ame} {SCP_TYPE} 
+0000cee0: 7b53 4350 5f47 5055 5f56 3130 307d 3a7b  {SCP_GPU_V100}:{
+0000cef0: 6e75 6d5f 6f66 5f67 7075 5f6c 6175 6e63  num_of_gpu_launc
+0000cf00: 687d 2065 7861 6d70 6c65 732f 6a6f 625f  h} examples/job_
+0000cf10: 7175 6575 652f 636c 7573 7465 722e 7961  queue/cluster.ya
+0000cf20: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
+0000cf30: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
+0000cf40: 657d 202d 6e20 7b6e 616d 657d 2d31 207b  e} -n {name}-1 {
+0000cf50: 5343 505f 4750 555f 5631 3030 7d3a 7b6e  SCP_GPU_V100}:{n
+0000cf60: 756d 5f6f 665f 6770 755f 6578 6563 7d20  um_of_gpu_exec} 
+0000cf70: 2d64 2065 7861 6d70 6c65 732f 6a6f 625f  -d examples/job_
+0000cf80: 7175 6575 652f 6a6f 622e 7961 6d6c 272c  queue/job.yaml',
+0000cf90: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000cfa0: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
+0000cfb0: 6e20 7b6e 616d 657d 2d32 207b 5343 505f  n {name}-2 {SCP_
+0000cfc0: 4750 555f 5631 3030 7d3a 7b6e 756d 5f6f  GPU_V100}:{num_o
+0000cfd0: 665f 6770 755f 6578 6563 7d20 2d64 2065  f_gpu_exec} -d e
+0000cfe0: 7861 6d70 6c65 732f 6a6f 625f 7175 6575  xamples/job_queu
+0000cff0: 652f 6a6f 622e 7961 6d6c 272c 0a20 2020  e/job.yaml',.   
+0000d000: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
+0000d010: 7865 6320 7b6e 616d 657d 202d 6e20 7b6e  xec {name} -n {n
+0000d020: 616d 657d 2d33 207b 5343 505f 4750 555f  ame}-3 {SCP_GPU_
+0000d030: 5631 3030 7d3a 7b6e 756d 5f6f 665f 6770  V100}:{num_of_gp
+0000d040: 755f 6578 6563 7d20 2d64 2065 7861 6d70  u_exec} -d examp
+0000d050: 6c65 732f 6a6f 625f 7175 6575 652f 6a6f  les/job_queue/jo
+0000d060: 622e 7961 6d6c 272c 0a20 2020 2020 2020  b.yaml',.       
+0000d070: 2020 2020 2066 2773 6b79 2071 7565 7565       f'sky queue
+0000d080: 207b 6e61 6d65 7d20 7c20 6772 6570 207b   {name} | grep {
+0000d090: 6e61 6d65 7d2d 3120 7c20 6772 6570 2052  name}-1 | grep R
+0000d0a0: 554e 4e49 4e47 272c 0a20 2020 2020 2020  UNNING',.       
+0000d0b0: 2020 2020 2066 2773 6b79 2071 7565 7565       f'sky queue
+0000d0c0: 207b 6e61 6d65 7d20 7c20 6772 6570 207b   {name} | grep {
+0000d0d0: 6e61 6d65 7d2d 3220 7c20 6772 6570 2052  name}-2 | grep R
+0000d0e0: 554e 4e49 4e47 272c 0a20 2020 2020 2020  UNNING',.       
+0000d0f0: 2020 2020 2066 2773 6b79 2071 7565 7565       f'sky queue
+0000d100: 207b 6e61 6d65 7d20 7c20 6772 6570 207b   {name} | grep {
+0000d110: 6e61 6d65 7d2d 3320 7c20 6772 6570 2050  name}-3 | grep P
+0000d120: 454e 4449 4e47 272c 0a20 2020 2020 2020  ENDING',.       
+0000d130: 2020 2020 2066 2773 6b79 2063 616e 6365       f'sky cance
+0000d140: 6c20 2d79 207b 6e61 6d65 7d20 3227 2c0a  l -y {name} 2',.
+0000d150: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
+0000d160: 6570 2035 272c 0a20 2020 2020 2020 2020  ep 5',.         
+0000d170: 2020 2066 2773 6b79 2071 7565 7565 207b     f'sky queue {
+0000d180: 6e61 6d65 7d20 7c20 6772 6570 207b 6e61  name} | grep {na
+0000d190: 6d65 7d2d 3320 7c20 6772 6570 2052 554e  me}-3 | grep RUN
+0000d1a0: 4e49 4e47 272c 0a20 2020 2020 2020 2020  NING',.         
+0000d1b0: 2020 2066 2773 6b79 2063 616e 6365 6c20     f'sky cancel 
+0000d1c0: 2d79 207b 6e61 6d65 7d20 3327 2c0a 2020  -y {name} 3',.  
+0000d1d0: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
+0000d1e0: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
+0000d1f0: 6e61 6d65 7d27 2c0a 2020 2020 290a 2020  name}',.    ).  
+0000d200: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+0000d210: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
+0000d220: 6172 6b2e 6e6f 5f66 6c75 6964 7374 6163  ark.no_fluidstac
+0000d230: 6b20 2023 2046 6c75 6964 5374 6163 6b20  k  # FluidStack 
+0000d240: 4443 2068 6173 206c 6f77 2061 7661 696c  DC has low avail
+0000d250: 6162 696c 6974 7920 6f66 2054 3420 4750  ability of T4 GP
+0000d260: 5573 0a40 7079 7465 7374 2e6d 6172 6b2e  Us.@pytest.mark.
+0000d270: 6e6f 5f6c 616d 6264 615f 636c 6f75 6420  no_lambda_cloud 
+0000d280: 2023 204c 616d 6264 6120 436c 6f75 6420   # Lambda Cloud 
+0000d290: 646f 6573 206e 6f74 2068 6176 6520 5434  does not have T4
+0000d2a0: 2067 7075 730a 4070 7974 6573 742e 6d61   gpus.@pytest.ma
+0000d2b0: 726b 2e6e 6f5f 6962 6d20 2023 2049 424d  rk.no_ibm  # IBM
+0000d2c0: 2043 6c6f 7564 2064 6f65 7320 6e6f 7420   Cloud does not 
+0000d2d0: 6861 7665 2054 3420 6770 7573 2e20 7275  have T4 gpus. ru
+0000d2e0: 6e20 7465 7374 5f69 626d 5f6a 6f62 5f71  n test_ibm_job_q
+0000d2f0: 7565 7565 5f6d 756c 7469 6e6f 6465 2069  ueue_multinode i
+0000d300: 6e73 7465 6164 0a40 7079 7465 7374 2e6d  nstead.@pytest.m
+0000d310: 6172 6b2e 6e6f 5f70 6170 6572 7370 6163  ark.no_paperspac
+0000d320: 6520 2023 2050 6170 6572 7370 6163 6520  e  # Paperspace 
+0000d330: 646f 6573 206e 6f74 2068 6176 6520 5434  does not have T4
+0000d340: 2067 7075 732e 0a40 7079 7465 7374 2e6d   gpus..@pytest.m
+0000d350: 6172 6b2e 6e6f 5f73 6370 2020 2320 5343  ark.no_scp  # SC
+0000d360: 5020 646f 6573 206e 6f74 2073 7570 706f  P does not suppo
+0000d370: 7274 206e 756d 5f6e 6f64 6573 203e 2031  rt num_nodes > 1
+0000d380: 2079 6574 0a40 7079 7465 7374 2e6d 6172   yet.@pytest.mar
+0000d390: 6b2e 6e6f 5f6f 6369 2020 2320 4f43 4920  k.no_oci  # OCI 
+0000d3a0: 436c 6f75 6420 646f 6573 206e 6f74 2068  Cloud does not h
+0000d3b0: 6176 6520 5434 2067 7075 732e 0a40 7079  ave T4 gpus..@py
+0000d3c0: 7465 7374 2e6d 6172 6b2e 6e6f 5f6b 7562  test.mark.no_kub
+0000d3d0: 6572 6e65 7465 7320 2023 204b 7562 6572  ernetes  # Kuber
+0000d3e0: 6e65 7465 7320 6e6f 7420 7375 7070 6f72  netes not suppor
+0000d3f0: 7420 6e75 6d5f 6e6f 6465 7320 3e20 3120  t num_nodes > 1 
+0000d400: 7965 740a 6465 6620 7465 7374 5f6a 6f62  yet.def test_job
+0000d410: 5f71 7565 7565 5f6d 756c 7469 6e6f 6465  _queue_multinode
+0000d420: 2867 656e 6572 6963 5f63 6c6f 7564 3a20  (generic_cloud: 
+0000d430: 7374 7229 3a0a 2020 2020 6e61 6d65 203d  str):.    name =
+0000d440: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
+0000d450: 6d65 2829 0a20 2020 2074 6f74 616c 5f74  me().    total_t
+0000d460: 696d 656f 7574 5f6d 696e 7574 6573 203d  imeout_minutes =
+0000d470: 2033 3020 6966 2067 656e 6572 6963 5f63   30 if generic_c
+0000d480: 6c6f 7564 203d 3d20 2761 7a75 7265 2720  loud == 'azure' 
+0000d490: 656c 7365 2031 350a 2020 2020 7465 7374  else 15.    test
+0000d4a0: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
+0000d4b0: 2027 6a6f 625f 7175 6575 655f 6d75 6c74   'job_queue_mult
+0000d4c0: 696e 6f64 6527 2c0a 2020 2020 2020 2020  inode',.        
+0000d4d0: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
+0000d4e0: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
+0000d4f0: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
+0000d500: 7b67 656e 6572 6963 5f63 6c6f 7564 7d20  {generic_cloud} 
+0000d510: 6578 616d 706c 6573 2f6a 6f62 5f71 7565  examples/job_que
+0000d520: 7565 2f63 6c75 7374 6572 5f6d 756c 7469  ue/cluster_multi
+0000d530: 6e6f 6465 2e79 616d 6c27 2c0a 2020 2020  node.yaml',.    
+0000d540: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
+0000d550: 6563 207b 6e61 6d65 7d20 2d6e 207b 6e61  ec {name} -n {na
+0000d560: 6d65 7d2d 3120 2d64 2065 7861 6d70 6c65  me}-1 -d example
+0000d570: 732f 6a6f 625f 7175 6575 652f 6a6f 625f  s/job_queue/job_
+0000d580: 6d75 6c74 696e 6f64 652e 7961 6d6c 272c  multinode.yaml',
+0000d590: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000d5a0: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
+0000d5b0: 6e20 7b6e 616d 657d 2d32 202d 6420 6578  n {name}-2 -d ex
+0000d5c0: 616d 706c 6573 2f6a 6f62 5f71 7565 7565  amples/job_queue
+0000d5d0: 2f6a 6f62 5f6d 756c 7469 6e6f 6465 2e79  /job_multinode.y
+0000d5e0: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+0000d5f0: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
+0000d600: 6320 7b6e 616d 657d 202d 6e20 7b6e 616d  c {name} -n {nam
+0000d610: 657d 2d33 202d 2d64 6574 6163 682d 7365  e}-3 --detach-se
+0000d620: 7475 7020 2d64 2065 7861 6d70 6c65 732f  tup -d examples/
+0000d630: 6a6f 625f 7175 6575 652f 6a6f 625f 6d75  job_queue/job_mu
+0000d640: 6c74 696e 6f64 652e 7961 6d6c 272c 0a20  ltinode.yaml',. 
+0000d650: 2020 2020 2020 2020 2020 2066 2773 3d24             f's=$
+0000d660: 2873 6b79 2071 7565 7565 207b 6e61 6d65  (sky queue {name
+0000d670: 7d29 2026 2620 6563 686f 2022 2473 2220  }) && echo "$s" 
+0000d680: 2626 2028 6563 686f 2022 2473 2220 7c20  && (echo "$s" | 
+0000d690: 6772 6570 207b 6e61 6d65 7d2d 3120 7c20  grep {name}-1 | 
+0000d6a0: 6772 6570 2052 554e 4e49 4e47 2927 2c0a  grep RUNNING)',.
+0000d6b0: 2020 2020 2020 2020 2020 2020 6627 733d              f's=
+0000d6c0: 2428 736b 7920 7175 6575 6520 7b6e 616d  $(sky queue {nam
+0000d6d0: 657d 2920 2626 2065 6368 6f20 2224 7322  e}) && echo "$s"
+0000d6e0: 2026 2620 2865 6368 6f20 2224 7322 207c   && (echo "$s" |
+0000d6f0: 2067 7265 7020 7b6e 616d 657d 2d32 207c   grep {name}-2 |
+0000d700: 2067 7265 7020 5255 4e4e 494e 4729 272c   grep RUNNING)',
+0000d710: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000d720: 3d24 2873 6b79 2071 7565 7565 207b 6e61  =$(sky queue {na
+0000d730: 6d65 7d29 2026 2620 6563 686f 2022 2473  me}) && echo "$s
+0000d740: 2220 2626 2028 6563 686f 2022 2473 2220  " && (echo "$s" 
+0000d750: 7c20 6772 6570 207b 6e61 6d65 7d2d 3320  | grep {name}-3 
+0000d760: 7c20 6772 6570 2050 454e 4449 4e47 2927  | grep PENDING)'
+0000d770: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
+0000d780: 6c65 6570 2039 3027 2c0a 2020 2020 2020  leep 90',.      
+0000d790: 2020 2020 2020 6627 736b 7920 6361 6e63        f'sky canc
+0000d7a0: 656c 202d 7920 7b6e 616d 657d 2031 272c  el -y {name} 1',
+0000d7b0: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
+0000d7c0: 6565 7020 3527 2c0a 2020 2020 2020 2020  eep 5',.        
+0000d7d0: 2020 2020 6627 733d 2428 736b 7920 7175      f's=$(sky qu
+0000d7e0: 6575 6520 7b6e 616d 657d 293b 2065 6368  eue {name}); ech
+0000d7f0: 6f20 2224 7322 3b20 6563 686f 3b20 6563  o "$s"; echo; ec
+0000d800: 686f 3b20 6563 686f 2022 2473 2220 7c20  ho; echo "$s" | 
+0000d810: 6772 6570 207b 6e61 6d65 7d2d 3320 7c20  grep {name}-3 | 
+0000d820: 6772 6570 2053 4554 5449 4e47 5f55 5027  grep SETTING_UP'
+0000d830: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0000d840: 736b 7920 6361 6e63 656c 202d 7920 7b6e  sky cancel -y {n
+0000d850: 616d 657d 2031 2032 2033 272c 0a20 2020  ame} 1 2 3',.   
+0000d860: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+0000d870: 6175 6e63 6820 2d63 207b 6e61 6d65 7d20  aunch -c {name} 
+0000d880: 2d6e 207b 6e61 6d65 7d2d 3420 2d2d 6465  -n {name}-4 --de
+0000d890: 7461 6368 2d73 6574 7570 202d 6420 6578  tach-setup -d ex
+0000d8a0: 616d 706c 6573 2f6a 6f62 5f71 7565 7565  amples/job_queue
+0000d8b0: 2f6a 6f62 5f6d 756c 7469 6e6f 6465 2e79  /job_multinode.y
+0000d8c0: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+0000d8d0: 2020 2320 5465 7374 2074 6865 206a 6f62    # Test the job
+0000d8e0: 2073 7461 7475 7320 6973 2063 6f72 7265   status is corre
+0000d8f0: 6374 6c79 2073 6574 2074 6f20 5345 5454  ctly set to SETT
+0000d900: 494e 475f 5550 2c20 6475 7269 6e67 2074  ING_UP, during t
+0000d910: 6865 2073 6574 7570 2069 7320 7275 6e6e  he setup is runn
+0000d920: 696e 672c 0a20 2020 2020 2020 2020 2020  ing,.           
+0000d930: 2023 2061 6e64 2074 6865 206a 6f62 2063   # and the job c
+0000d940: 616e 2062 6520 6361 6e63 656c 6c65 6420  an be cancelled 
+0000d950: 6475 7269 6e67 2074 6865 2073 6574 7570  during the setup
+0000d960: 2e0a 2020 2020 2020 2020 2020 2020 2773  ..            's
+0000d970: 6c65 6570 2035 272c 0a20 2020 2020 2020  leep 5',.       
+0000d980: 2020 2020 2066 2773 3d24 2873 6b79 2071       f's=$(sky q
+0000d990: 7565 7565 207b 6e61 6d65 7d29 2026 2620  ueue {name}) && 
+0000d9a0: 6563 686f 2022 2473 2220 2626 2028 6563  echo "$s" && (ec
+0000d9b0: 686f 2022 2473 2220 7c20 6772 6570 207b  ho "$s" | grep {
+0000d9c0: 6e61 6d65 7d2d 3420 7c20 6772 6570 2053  name}-4 | grep S
+0000d9d0: 4554 5449 4e47 5f55 5029 272c 0a20 2020  ETTING_UP)',.   
+0000d9e0: 2020 2020 2020 2020 2066 2773 6b79 2063           f'sky c
+0000d9f0: 616e 6365 6c20 2d79 207b 6e61 6d65 7d20  ancel -y {name} 
+0000da00: 3427 2c0a 2020 2020 2020 2020 2020 2020  4',.            
+0000da10: 6627 733d 2428 736b 7920 7175 6575 6520  f's=$(sky queue 
+0000da20: 7b6e 616d 657d 2920 2626 2065 6368 6f20  {name}) && echo 
+0000da30: 2224 7322 2026 2620 2865 6368 6f20 2224  "$s" && (echo "$
+0000da40: 7322 207c 2067 7265 7020 7b6e 616d 657d  s" | grep {name}
+0000da50: 2d34 207c 2067 7265 7020 4341 4e43 454c  -4 | grep CANCEL
+0000da60: 4c45 4429 272c 0a20 2020 2020 2020 2020  LED)',.         
+0000da70: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
+0000da80: 616d 657d 202d 2d67 7075 7320 5434 3a30  ame} --gpus T4:0
+0000da90: 2e32 2022 5b5b 205c 2453 4b59 5049 4c4f  .2 "[[ \$SKYPILO
+0000daa0: 545f 4e55 4d5f 4750 5553 5f50 4552 5f4e  T_NUM_GPUS_PER_N
+0000dab0: 4f44 4520 2d65 7120 3120 5d5d 207c 7c20  ODE -eq 1 ]] || 
+0000dac0: 6578 6974 2031 2227 2c0a 2020 2020 2020  exit 1"',.      
+0000dad0: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
+0000dae0: 207b 6e61 6d65 7d20 2d2d 6770 7573 2054   {name} --gpus T
+0000daf0: 343a 302e 3220 2d2d 6e75 6d2d 6e6f 6465  4:0.2 --num-node
+0000db00: 7320 3220 225b 5b20 5c24 534b 5950 494c  s 2 "[[ \$SKYPIL
+0000db10: 4f54 5f4e 554d 5f47 5055 535f 5045 525f  OT_NUM_GPUS_PER_
+0000db20: 4e4f 4445 202d 6571 2031 205d 5d20 7c7c  NODE -eq 1 ]] ||
+0000db30: 2065 7869 7420 3122 272c 0a20 2020 2020   exit 1"',.     
+0000db40: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
+0000db50: 6320 7b6e 616d 657d 202d 2d67 7075 7320  c {name} --gpus 
+0000db60: 5434 3a31 202d 2d6e 756d 2d6e 6f64 6573  T4:1 --num-nodes
+0000db70: 2032 2022 5b5b 205c 2453 4b59 5049 4c4f   2 "[[ \$SKYPILO
+0000db80: 545f 4e55 4d5f 4750 5553 5f50 4552 5f4e  T_NUM_GPUS_PER_N
+0000db90: 4f44 4520 2d65 7120 3120 5d5d 207c 7c20  ODE -eq 1 ]] || 
+0000dba0: 6578 6974 2031 2227 2c0a 2020 2020 2020  exit 1"',.      
+0000dbb0: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
+0000dbc0: 207b 6e61 6d65 7d20 3520 2d2d 7374 6174   {name} 5 --stat
+0000dbd0: 7573 272c 0a20 2020 2020 2020 2020 2020  us',.           
+0000dbe0: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
+0000dbf0: 657d 2036 202d 2d73 7461 7475 7327 2c0a  e} 6 --status',.
+0000dc00: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000dc10: 7920 6c6f 6773 207b 6e61 6d65 7d20 3720  y logs {name} 7 
+0000dc20: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
+0000dc30: 2020 205d 2c0a 2020 2020 2020 2020 6627     ],.        f'
+0000dc40: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
+0000dc50: 657d 272c 0a20 2020 2020 2020 2074 696d  e}',.        tim
+0000dc60: 656f 7574 3d74 6f74 616c 5f74 696d 656f  eout=total_timeo
+0000dc70: 7574 5f6d 696e 7574 6573 202a 2036 302c  ut_minutes * 60,
+0000dc80: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+0000dc90: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+0000dca0: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+0000dcb0: 6c61 6d62 6461 5f63 6c6f 7564 2020 2320  lambda_cloud  # 
+0000dcc0: 4e6f 204c 616d 6264 6120 436c 6f75 6420  No Lambda Cloud 
+0000dcd0: 564d 2068 6173 2038 2043 5055 730a 6465  VM has 8 CPUs.de
+0000dce0: 6620 7465 7374 5f6c 6172 6765 5f6a 6f62  f test_large_job
+0000dcf0: 5f71 7565 7565 2867 656e 6572 6963 5f63  _queue(generic_c
+0000dd00: 6c6f 7564 3a20 7374 7229 3a0a 2020 2020  loud: str):.    
+0000dd10: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
+0000dd20: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
+0000dd30: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+0000dd40: 2020 2020 276c 6172 6765 5f6a 6f62 5f71      'large_job_q
+0000dd50: 7565 7565 272c 0a20 2020 2020 2020 205b  ueue',.        [
+0000dd60: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000dd70: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
+0000dd80: 7b6e 616d 657d 202d 2d63 7075 7320 3820  {name} --cpus 8 
+0000dd90: 2d2d 636c 6f75 6420 7b67 656e 6572 6963  --cloud {generic
+0000dda0: 5f63 6c6f 7564 7d27 2c0a 2020 2020 2020  _cloud}',.      
+0000ddb0: 2020 2020 2020 6627 666f 7220 6920 696e        f'for i in
+0000ddc0: 2060 7365 7120 3120 3735 603b 2064 6f20   `seq 1 75`; do 
+0000ddd0: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
+0000dde0: 2d6e 207b 6e61 6d65 7d2d 2469 202d 6420  -n {name}-$i -d 
+0000ddf0: 2265 6368 6f20 2469 3b20 736c 6565 7020  "echo $i; sleep 
+0000de00: 3130 3030 3030 3030 3022 3b20 646f 6e65  100000000"; done
+0000de10: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0000de20: 2773 6b79 2063 616e 6365 6c20 2d79 207b  'sky cancel -y {
+0000de30: 6e61 6d65 7d20 3120 3220 3320 3420 3520  name} 1 2 3 4 5 
+0000de40: 3620 3720 3820 3920 3130 2031 3120 3132  6 7 8 9 10 11 12
+0000de50: 2031 3320 3134 2031 3520 3136 272c 0a20   13 14 15 16',. 
+0000de60: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+0000de70: 7020 3930 272c 0a20 2020 2020 2020 2020  p 90',.         
+0000de80: 2020 2023 2045 6163 6820 6a6f 6220 7461     # Each job ta
+0000de90: 6b65 7320 302e 3520 4350 5520 616e 6420  kes 0.5 CPU and 
+0000dea0: 7468 6520 6465 6661 756c 7420 564d 2068  the default VM h
+0000deb0: 6173 2038 2043 5055 732c 2073 6f20 7468  as 8 CPUs, so th
+0000dec0: 6572 6520 7368 6f75 6c64 2062 6520 3820  ere should be 8 
+0000ded0: 2f20 302e 3520 3d20 3136 206a 6f62 7320  / 0.5 = 16 jobs 
+0000dee0: 7275 6e6e 696e 672e 0a20 2020 2020 2020  running..       
+0000def0: 2020 2020 2023 2054 6865 2066 6972 7374       # The first
+0000df00: 2031 3620 6a6f 6273 2061 7265 2063 616e   16 jobs are can
+0000df10: 6365 6c65 642c 2073 6f20 7468 6572 6520  celed, so there 
+0000df20: 7368 6f75 6c64 2062 6520 3735 202d 2033  should be 75 - 3
+0000df30: 3220 3d20 3433 206a 6f62 7320 5045 4e44  2 = 43 jobs PEND
+0000df40: 494e 472e 0a20 2020 2020 2020 2020 2020  ING..           
+0000df50: 2066 2773 3d24 2873 6b79 2071 7565 7565   f's=$(sky queue
+0000df60: 207b 6e61 6d65 7d29 3b20 6563 686f 2022   {name}); echo "
+0000df70: 2473 223b 2065 6368 6f3b 2065 6368 6f3b  $s"; echo; echo;
+0000df80: 2065 6368 6f20 2224 7322 207c 2067 7265   echo "$s" | gre
+0000df90: 7020 2d76 2067 7265 7020 7c20 6772 6570  p -v grep | grep
+0000dfa0: 2050 454e 4449 4e47 207c 2077 6320 2d6c   PENDING | wc -l
+0000dfb0: 207c 2067 7265 7020 3433 272c 0a20 2020   | grep 43',.   
+0000dfc0: 2020 2020 2020 2020 2023 204d 616b 6520           # Make 
+0000dfd0: 7375 7265 2074 6865 206a 6f62 7320 6172  sure the jobs ar
+0000dfe0: 6520 7363 6865 6475 6c65 6420 696e 2046  e scheduled in F
+0000dff0: 4946 4f20 6f72 6465 720a 2020 2020 2020  IFO order.      
+0000e000: 2020 2020 2020 2a5b 0a20 2020 2020 2020        *[.       
+0000e010: 2020 2020 2020 2020 2066 2773 3d24 2873           f's=$(s
+0000e020: 6b79 2071 7565 7565 207b 6e61 6d65 7d29  ky queue {name})
+0000e030: 3b20 6563 686f 2022 2473 223b 2065 6368  ; echo "$s"; ech
+0000e040: 6f3b 2065 6368 6f3b 2065 6368 6f20 2224  o; echo; echo "$
+0000e050: 7322 207c 2067 7265 7020 7b6e 616d 657d  s" | grep {name}
+0000e060: 2d7b 697d 207c 2067 7265 7020 4341 4e43  -{i} | grep CANC
+0000e070: 454c 4c45 4427 0a20 2020 2020 2020 2020  ELLED'.         
+0000e080: 2020 2020 2020 2066 6f72 2069 2069 6e20         for i in 
+0000e090: 7261 6e67 6528 312c 2031 3729 0a20 2020  range(1, 17).   
+0000e0a0: 2020 2020 2020 2020 205d 2c0a 2020 2020           ],.    
+0000e0b0: 2020 2020 2020 2020 2a5b 0a20 2020 2020          *[.     
+0000e0c0: 2020 2020 2020 2020 2020 2066 2773 3d24             f's=$
+0000e0d0: 2873 6b79 2071 7565 7565 207b 6e61 6d65  (sky queue {name
+0000e0e0: 7d29 3b20 6563 686f 2022 2473 223b 2065  }); echo "$s"; e
+0000e0f0: 6368 6f3b 2065 6368 6f3b 2065 6368 6f20  cho; echo; echo 
+0000e100: 2224 7322 207c 2067 7265 7020 7b6e 616d  "$s" | grep {nam
+0000e110: 657d 2d7b 697d 207c 2067 7265 7020 5255  e}-{i} | grep RU
+0000e120: 4e4e 494e 4727 0a20 2020 2020 2020 2020  NNING'.         
+0000e130: 2020 2020 2020 2066 6f72 2069 2069 6e20         for i in 
+0000e140: 7261 6e67 6528 3137 2c20 3333 290a 2020  range(17, 33).  
+0000e150: 2020 2020 2020 2020 2020 5d2c 0a20 2020            ],.   
+0000e160: 2020 2020 2020 2020 202a 5b0a 2020 2020           *[.    
+0000e170: 2020 2020 2020 2020 2020 2020 6627 733d              f's=
+0000e180: 2428 736b 7920 7175 6575 6520 7b6e 616d  $(sky queue {nam
+0000e190: 657d 293b 2065 6368 6f20 2224 7322 3b20  e}); echo "$s"; 
+0000e1a0: 6563 686f 3b20 6563 686f 3b20 6563 686f  echo; echo; echo
+0000e1b0: 2022 2473 2220 7c20 6772 6570 207b 6e61   "$s" | grep {na
+0000e1c0: 6d65 7d2d 7b69 7d20 7c20 6772 6570 2050  me}-{i} | grep P
+0000e1d0: 454e 4449 4e47 270a 2020 2020 2020 2020  ENDING'.        
+0000e1e0: 2020 2020 2020 2020 666f 7220 6920 696e          for i in
+0000e1f0: 2072 616e 6765 2833 332c 2037 3529 0a20   range(33, 75). 
+0000e200: 2020 2020 2020 2020 2020 205d 2c0a 2020             ],.  
+0000e210: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0000e220: 6361 6e63 656c 202d 7920 7b6e 616d 657d  cancel -y {name}
+0000e230: 2033 3320 3335 2033 3720 3339 2031 3720   33 35 37 39 17 
+0000e240: 3138 2031 3927 2c0a 2020 2020 2020 2020  18 19',.        
+0000e250: 2020 2020 2a5b 0a20 2020 2020 2020 2020      *[.         
+0000e260: 2020 2020 2020 2066 2773 3d24 2873 6b79         f's=$(sky
+0000e270: 2071 7565 7565 207b 6e61 6d65 7d29 3b20   queue {name}); 
+0000e280: 6563 686f 2022 2473 223b 2065 6368 6f3b  echo "$s"; echo;
+0000e290: 2065 6368 6f3b 2065 6368 6f20 2224 7322   echo; echo "$s"
+0000e2a0: 207c 2067 7265 7020 7b6e 616d 657d 2d7b   | grep {name}-{
+0000e2b0: 697d 207c 2067 7265 7020 4341 4e43 454c  i} | grep CANCEL
+0000e2c0: 4c45 4427 0a20 2020 2020 2020 2020 2020  LED'.           
+0000e2d0: 2020 2020 2066 6f72 2069 2069 6e20 7261       for i in ra
+0000e2e0: 6e67 6528 3333 2c20 3430 2c20 3229 0a20  nge(33, 40, 2). 
+0000e2f0: 2020 2020 2020 2020 2020 205d 2c0a 2020             ],.  
+0000e300: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
+0000e310: 2031 3027 2c0a 2020 2020 2020 2020 2020   10',.          
+0000e320: 2020 2a5b 0a20 2020 2020 2020 2020 2020    *[.           
+0000e330: 2020 2020 2066 2773 3d24 2873 6b79 2071       f's=$(sky q
+0000e340: 7565 7565 207b 6e61 6d65 7d29 3b20 6563  ueue {name}); ec
+0000e350: 686f 2022 2473 223b 2065 6368 6f3b 2065  ho "$s"; echo; e
+0000e360: 6368 6f3b 2065 6368 6f20 2224 7322 207c  cho; echo "$s" |
+0000e370: 2067 7265 7020 7b6e 616d 657d 2d7b 697d   grep {name}-{i}
+0000e380: 207c 2067 7265 7020 5255 4e4e 494e 4727   | grep RUNNING'
+0000e390: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000e3a0: 2066 6f72 2069 2069 6e20 5b33 342c 2033   for i in [34, 3
+0000e3b0: 362c 2033 385d 0a20 2020 2020 2020 2020  6, 38].         
+0000e3c0: 2020 205d 2c0a 2020 2020 2020 2020 5d2c     ],.        ],
+0000e3d0: 0a20 2020 2020 2020 2066 2773 6b79 2064  .        f'sky d
+0000e3e0: 6f77 6e20 2d79 207b 6e61 6d65 7d27 2c0a  own -y {name}',.
+0000e3f0: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
+0000e400: 3235 202a 2036 302c 0a20 2020 2029 0a20  25 * 60,.    ). 
+0000e410: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+0000e420: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
+0000e430: 6d61 726b 2e6e 6f5f 6c61 6d62 6461 5f63  mark.no_lambda_c
+0000e440: 6c6f 7564 2020 2320 4e6f 204c 616d 6264  loud  # No Lambd
+0000e450: 6120 436c 6f75 6420 564d 2068 6173 2038  a Cloud VM has 8
+0000e460: 2043 5055 730a 6465 6620 7465 7374 5f66   CPUs.def test_f
+0000e470: 6173 745f 6c61 7267 655f 6a6f 625f 7175  ast_large_job_qu
+0000e480: 6575 6528 6765 6e65 7269 635f 636c 6f75  eue(generic_clou
+0000e490: 643a 2073 7472 293a 0a20 2020 2023 2054  d: str):.    # T
+0000e4a0: 6869 7320 6973 2074 6f20 7465 7374 2074  his is to test t
+0000e4b0: 6865 206a 6f62 7320 6361 6e20 6265 2073  he jobs can be s
+0000e4c0: 6368 6564 756c 6564 2071 7569 636b 6c79  cheduled quickly
+0000e4d0: 2077 6865 6e20 7468 6572 6520 6172 6520   when there are 
+0000e4e0: 6d61 6e79 206a 6f62 7320 696e 2074 6865  many jobs in the
+0000e4f0: 2071 7565 7565 2e0a 2020 2020 6e61 6d65   queue..    name
+0000e500: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
+0000e510: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
+0000e520: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+0000e530: 2766 6173 745f 6c61 7267 655f 6a6f 625f  'fast_large_job_
+0000e540: 7175 6575 6527 2c0a 2020 2020 2020 2020  queue',.        
+0000e550: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
+0000e560: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
+0000e570: 207b 6e61 6d65 7d20 2d2d 6370 7573 2038   {name} --cpus 8
+0000e580: 202d 2d63 6c6f 7564 207b 6765 6e65 7269   --cloud {generi
+0000e590: 635f 636c 6f75 647d 272c 0a20 2020 2020  c_cloud}',.     
+0000e5a0: 2020 2020 2020 2066 2766 6f72 2069 2069         f'for i i
+0000e5b0: 6e20 6073 6571 2031 2033 3260 3b20 646f  n `seq 1 32`; do
+0000e5c0: 2073 6b79 2065 7865 6320 7b6e 616d 657d   sky exec {name}
+0000e5d0: 202d 6e20 7b6e 616d 657d 2d24 6920 2d64   -n {name}-$i -d
+0000e5e0: 2022 6563 686f 2024 6922 3b20 646f 6e65   "echo $i"; done
+0000e5f0: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
+0000e600: 736c 6565 7020 3630 272c 0a20 2020 2020  sleep 60',.     
+0000e610: 2020 2020 2020 2066 2773 3d24 2873 6b79         f's=$(sky
+0000e620: 2071 7565 7565 207b 6e61 6d65 7d29 3b20   queue {name}); 
+0000e630: 6563 686f 2022 2473 223b 2065 6368 6f3b  echo "$s"; echo;
+0000e640: 2065 6368 6f3b 2065 6368 6f20 2224 7322   echo; echo "$s"
+0000e650: 207c 2067 7265 7020 2d76 2067 7265 7020   | grep -v grep 
+0000e660: 7c20 6772 6570 2053 5543 4345 4544 4544  | grep SUCCEEDED
+0000e670: 207c 2077 6320 2d6c 207c 2067 7265 7020   | wc -l | grep 
+0000e680: 3332 272c 0a20 2020 2020 2020 205d 2c0a  32',.        ],.
+0000e690: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
+0000e6a0: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
+0000e6b0: 2020 2020 2020 2074 696d 656f 7574 3d32         timeout=2
+0000e6c0: 3020 2a20 3630 2c0a 2020 2020 290a 2020  0 * 60,.    ).  
+0000e6d0: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+0000e6e0: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
+0000e6f0: 6172 6b2e 6962 6d0a 6465 6620 7465 7374  ark.ibm.def test
+0000e700: 5f69 626d 5f6a 6f62 5f71 7565 7565 5f6d  _ibm_job_queue_m
+0000e710: 756c 7469 6e6f 6465 2829 3a0a 2020 2020  ultinode():.    
+0000e720: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
+0000e730: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
+0000e740: 6173 6b5f 6669 6c65 203d 2027 6578 616d  ask_file = 'exam
+0000e750: 706c 6573 2f6a 6f62 5f71 7565 7565 2f6a  ples/job_queue/j
+0000e760: 6f62 5f6d 756c 7469 6e6f 6465 5f69 626d  ob_multinode_ibm
+0000e770: 2e79 616d 6c27 0a20 2020 2074 6573 7420  .yaml'.    test 
+0000e780: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+0000e790: 2769 626d 5f6a 6f62 5f71 7565 7565 5f6d  'ibm_job_queue_m
+0000e7a0: 756c 7469 6e6f 6465 272c 0a20 2020 2020  ultinode',.     
+0000e7b0: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+0000e7c0: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
+0000e7d0: 202d 6320 7b6e 616d 657d 202d 2d63 6c6f   -c {name} --clo
+0000e7e0: 7564 2069 626d 202d 2d67 7075 7320 7631  ud ibm --gpus v1
+0000e7f0: 3030 202d 2d6e 756d 2d6e 6f64 6573 2032  00 --num-nodes 2
+0000e800: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0000e810: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+0000e820: 202d 6e20 7b6e 616d 657d 2d31 202d 6420   -n {name}-1 -d 
+0000e830: 7b74 6173 6b5f 6669 6c65 7d27 2c0a 2020  {task_file}',.  
+0000e840: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0000e850: 6578 6563 207b 6e61 6d65 7d20 2d6e 207b  exec {name} -n {
+0000e860: 6e61 6d65 7d2d 3220 2d64 207b 7461 736b  name}-2 -d {task
+0000e870: 5f66 696c 657d 272c 0a20 2020 2020 2020  _file}',.       
+0000e880: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
+0000e890: 6820 2d79 202d 6320 7b6e 616d 657d 202d  h -y -c {name} -
+0000e8a0: 6e20 7b6e 616d 657d 2d33 202d 2d64 6574  n {name}-3 --det
+0000e8b0: 6163 682d 7365 7475 7020 2d64 207b 7461  ach-setup -d {ta
+0000e8c0: 736b 5f66 696c 657d 272c 0a20 2020 2020  sk_file}',.     
+0000e8d0: 2020 2020 2020 2066 2773 3d24 2873 6b79         f's=$(sky
+0000e8e0: 2071 7565 7565 207b 6e61 6d65 7d29 2026   queue {name}) &
+0000e8f0: 2620 7072 696e 7466 2022 2473 2220 2626  & printf "$s" &&
+0000e900: 2028 6563 686f 2022 2473 2220 7c20 6772   (echo "$s" | gr
+0000e910: 6570 207b 6e61 6d65 7d2d 3120 7c20 6772  ep {name}-1 | gr
+0000e920: 6570 2052 554e 4e49 4e47 2927 2c0a 2020  ep RUNNING)',.  
+0000e930: 2020 2020 2020 2020 2020 6627 733d 2428            f's=$(
+0000e940: 736b 7920 7175 6575 6520 7b6e 616d 657d  sky queue {name}
+0000e950: 2920 2626 2070 7269 6e74 6620 2224 7322  ) && printf "$s"
+0000e960: 2026 2620 2865 6368 6f20 2224 7322 207c   && (echo "$s" |
+0000e970: 2067 7265 7020 7b6e 616d 657d 2d32 207c   grep {name}-2 |
+0000e980: 2067 7265 7020 5255 4e4e 494e 4729 272c   grep RUNNING)',
+0000e990: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000e9a0: 3d24 2873 6b79 2071 7565 7565 207b 6e61  =$(sky queue {na
+0000e9b0: 6d65 7d29 2026 2620 7072 696e 7466 2022  me}) && printf "
+0000e9c0: 2473 2220 2626 2028 6563 686f 2022 2473  $s" && (echo "$s
+0000e9d0: 2220 7c20 6772 6570 207b 6e61 6d65 7d2d  " | grep {name}-
+0000e9e0: 3320 7c20 6772 6570 2053 4554 5449 4e47  3 | grep SETTING
+0000e9f0: 5f55 5029 272c 0a20 2020 2020 2020 2020  _UP)',.         
+0000ea00: 2020 2027 736c 6565 7020 3930 272c 0a20     'sleep 90',. 
+0000ea10: 2020 2020 2020 2020 2020 2066 2773 3d24             f's=$
+0000ea20: 2873 6b79 2071 7565 7565 207b 6e61 6d65  (sky queue {name
+0000ea30: 7d29 2026 2620 7072 696e 7466 2022 2473  }) && printf "$s
+0000ea40: 2220 2626 2028 6563 686f 2022 2473 2220  " && (echo "$s" 
+0000ea50: 7c20 6772 6570 207b 6e61 6d65 7d2d 3320  | grep {name}-3 
+0000ea60: 7c20 6772 6570 2050 454e 4449 4e47 2927  | grep PENDING)'
+0000ea70: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0000ea80: 736b 7920 6361 6e63 656c 202d 7920 7b6e  sky cancel -y {n
+0000ea90: 616d 657d 2031 272c 0a20 2020 2020 2020  ame} 1',.       
+0000eaa0: 2020 2020 2027 736c 6565 7020 3527 2c0a       'sleep 5',.
+0000eab0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000eac0: 7920 7175 6575 6520 7b6e 616d 657d 207c  y queue {name} |
+0000ead0: 2067 7265 7020 7b6e 616d 657d 2d33 207c   grep {name}-3 |
+0000eae0: 2067 7265 7020 5255 4e4e 494e 4727 2c0a   grep RUNNING',.
+0000eaf0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000eb00: 7920 6361 6e63 656c 202d 7920 7b6e 616d  y cancel -y {nam
+0000eb10: 657d 2031 2032 2033 272c 0a20 2020 2020  e} 1 2 3',.     
+0000eb20: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
+0000eb30: 6e63 6820 2d63 207b 6e61 6d65 7d20 2d6e  nch -c {name} -n
+0000eb40: 207b 6e61 6d65 7d2d 3420 2d2d 6465 7461   {name}-4 --deta
+0000eb50: 6368 2d73 6574 7570 202d 6420 7b74 6173  ch-setup -d {tas
+0000eb60: 6b5f 6669 6c65 7d27 2c0a 2020 2020 2020  k_file}',.      
+0000eb70: 2020 2020 2020 2320 5465 7374 2074 6865        # Test the
+0000eb80: 206a 6f62 2073 7461 7475 7320 6973 2063   job status is c
+0000eb90: 6f72 7265 6374 6c79 2073 6574 2074 6f20  orrectly set to 
+0000eba0: 5345 5454 494e 475f 5550 2c20 6475 7269  SETTING_UP, duri
+0000ebb0: 6e67 2074 6865 2073 6574 7570 2069 7320  ng the setup is 
+0000ebc0: 7275 6e6e 696e 672c 0a20 2020 2020 2020  running,.       
+0000ebd0: 2020 2020 2023 2061 6e64 2074 6865 206a       # and the j
+0000ebe0: 6f62 2063 616e 2062 6520 6361 6e63 656c  ob can be cancel
+0000ebf0: 6c65 6420 6475 7269 6e67 2074 6865 2073  led during the s
+0000ec00: 6574 7570 2e0a 2020 2020 2020 2020 2020  etup..          
+0000ec10: 2020 6627 733d 2428 736b 7920 7175 6575    f's=$(sky queu
+0000ec20: 6520 7b6e 616d 657d 2920 2626 2070 7269  e {name}) && pri
+0000ec30: 6e74 6620 2224 7322 2026 2620 2865 6368  ntf "$s" && (ech
+0000ec40: 6f20 2224 7322 207c 2067 7265 7020 7b6e  o "$s" | grep {n
+0000ec50: 616d 657d 2d34 207c 2067 7265 7020 5345  ame}-4 | grep SE
+0000ec60: 5454 494e 475f 5550 2927 2c0a 2020 2020  TTING_UP)',.    
+0000ec70: 2020 2020 2020 2020 6627 736b 7920 6361          f'sky ca
+0000ec80: 6e63 656c 202d 7920 7b6e 616d 657d 2034  ncel -y {name} 4
+0000ec90: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0000eca0: 2773 3d24 2873 6b79 2071 7565 7565 207b  's=$(sky queue {
+0000ecb0: 6e61 6d65 7d29 2026 2620 7072 696e 7466  name}) && printf
+0000ecc0: 2022 2473 2220 2626 2028 6563 686f 2022   "$s" && (echo "
+0000ecd0: 2473 2220 7c20 6772 6570 207b 6e61 6d65  $s" | grep {name
+0000ece0: 7d2d 3420 7c20 6772 6570 2043 414e 4345  }-4 | grep CANCE
+0000ecf0: 4c4c 4544 2927 2c0a 2020 2020 2020 2020  LLED)',.        
+0000ed00: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
+0000ed10: 6e61 6d65 7d20 2d2d 6770 7573 2076 3130  name} --gpus v10
+0000ed20: 303a 302e 3220 225b 5b20 5c24 534b 5950  0:0.2 "[[ \$SKYP
+0000ed30: 494c 4f54 5f4e 554d 5f47 5055 535f 5045  ILOT_NUM_GPUS_PE
+0000ed40: 525f 4e4f 4445 202d 6571 2031 205d 5d20  R_NODE -eq 1 ]] 
+0000ed50: 7c7c 2065 7869 7420 3122 272c 0a20 2020  || exit 1"',.   
+0000ed60: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
+0000ed70: 7865 6320 7b6e 616d 657d 202d 2d67 7075  xec {name} --gpu
+0000ed80: 7320 7631 3030 3a30 2e32 202d 2d6e 756d  s v100:0.2 --num
+0000ed90: 2d6e 6f64 6573 2032 2022 5b5b 205c 2453  -nodes 2 "[[ \$S
+0000eda0: 4b59 5049 4c4f 545f 4e55 4d5f 4750 5553  KYPILOT_NUM_GPUS
+0000edb0: 5f50 4552 5f4e 4f44 4520 2d65 7120 3120  _PER_NODE -eq 1 
+0000edc0: 5d5d 207c 7c20 6578 6974 2031 2227 2c0a  ]] || exit 1"',.
+0000edd0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000ede0: 7920 6578 6563 207b 6e61 6d65 7d20 2d2d  y exec {name} --
+0000edf0: 6770 7573 2076 3130 303a 3120 2d2d 6e75  gpus v100:1 --nu
+0000ee00: 6d2d 6e6f 6465 7320 3220 225b 5b20 5c24  m-nodes 2 "[[ \$
+0000ee10: 534b 5950 494c 4f54 5f4e 554d 5f47 5055  SKYPILOT_NUM_GPU
+0000ee20: 535f 5045 525f 4e4f 4445 202d 6571 2031  S_PER_NODE -eq 1
+0000ee30: 205d 5d20 7c7c 2065 7869 7420 3122 272c   ]] || exit 1"',
+0000ee40: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000ee50: 6b79 206c 6f67 7320 7b6e 616d 657d 2035  ky logs {name} 5
+0000ee60: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
+0000ee70: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+0000ee80: 6773 207b 6e61 6d65 7d20 3620 2d2d 7374  gs {name} 6 --st
+0000ee90: 6174 7573 272c 0a20 2020 2020 2020 2020  atus',.         
+0000eea0: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+0000eeb0: 616d 657d 2037 202d 2d73 7461 7475 7327  ame} 7 --status'
+0000eec0: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
+0000eed0: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
+0000eee0: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
+0000eef0: 2020 2020 7469 6d65 6f75 743d 3230 202a      timeout=20 *
+0000ef00: 2036 302c 2020 2320 3230 206d 696e 730a   60,  # 20 mins.
+0000ef10: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
+0000ef20: 655f 7465 7374 2874 6573 7429 0a0a 0a23  e_test(test)...#
+0000ef30: 202d 2d2d 2d2d 2d2d 2d2d 2d20 446f 636b   ---------- Dock
+0000ef40: 6572 2077 6974 6820 7072 6569 6e73 7461  er with preinsta
+0000ef50: 6c6c 6564 2070 6163 6b61 6765 2e20 2d2d  lled package. --
+0000ef60: 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465 7374  --------.@pytest
+0000ef70: 2e6d 6172 6b2e 6e6f 5f66 6c75 6964 7374  .mark.no_fluidst
+0000ef80: 6163 6b20 2023 2044 6f65 736e 2774 2073  ack  # Doesn't s
+0000ef90: 7570 706f 7274 2046 6c75 6964 7374 6163  upport Fluidstac
+0000efa0: 6b20 666f 7220 6e6f 770a 4070 7974 6573  k for now.@pytes
+0000efb0: 742e 6d61 726b 2e6e 6f5f 6c61 6d62 6461  t.mark.no_lambda
+0000efc0: 5f63 6c6f 7564 2020 2320 446f 6573 6e27  _cloud  # Doesn'
+0000efd0: 7420 7375 7070 6f72 7420 4c61 6d62 6461  t support Lambda
+0000efe0: 2043 6c6f 7564 2066 6f72 206e 6f77 0a40   Cloud for now.@
+0000eff0: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f69  pytest.mark.no_i
+0000f000: 626d 2020 2320 446f 6573 6e27 7420 7375  bm  # Doesn't su
+0000f010: 7070 6f72 7420 4942 4d20 436c 6f75 6420  pport IBM Cloud 
+0000f020: 666f 7220 6e6f 770a 4070 7974 6573 742e  for now.@pytest.
+0000f030: 6d61 726b 2e6e 6f5f 7363 7020 2023 2044  mark.no_scp  # D
+0000f040: 6f65 736e 2774 2073 7570 706f 7274 2053  oesn't support S
+0000f050: 4350 2066 6f72 206e 6f77 0a40 7079 7465  CP for now.@pyte
+0000f060: 7374 2e6d 6172 6b2e 6e6f 5f6f 6369 2020  st.mark.no_oci  
+0000f070: 2320 446f 6573 6e27 7420 7375 7070 6f72  # Doesn't suppor
+0000f080: 7420 4f43 4920 666f 7220 6e6f 770a 4070  t OCI for now.@p
+0000f090: 7974 6573 742e 6d61 726b 2e6e 6f5f 6b75  ytest.mark.no_ku
+0000f0a0: 6265 726e 6574 6573 2020 2320 446f 6573  bernetes  # Does
+0000f0b0: 6e27 7420 7375 7070 6f72 7420 4b75 6265  n't support Kube
+0000f0c0: 726e 6574 6573 2066 6f72 206e 6f77 0a23  rnetes for now.#
+0000f0d0: 2054 4f44 4f28 7a68 7775 293a 2077 6520   TODO(zhwu): we 
+0000f0e0: 7368 6f75 6c64 2066 6978 2074 6869 7320  should fix this 
+0000f0f0: 666f 7220 6b75 6265 726e 6574 6573 0a64  for kubernetes.d
+0000f100: 6566 2074 6573 745f 646f 636b 6572 5f70  ef test_docker_p
+0000f110: 7265 696e 7374 616c 6c65 645f 7061 636b  reinstalled_pack
+0000f120: 6167 6528 6765 6e65 7269 635f 636c 6f75  age(generic_clou
+0000f130: 643a 2073 7472 293a 0a20 2020 206e 616d  d: str):.    nam
+0000f140: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
+0000f150: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
+0000f160: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
+0000f170: 2027 646f 636b 6572 5f77 6974 685f 7072   'docker_with_pr
+0000f180: 6569 6e73 7461 6c6c 6564 5f70 6163 6b61  einstalled_packa
+0000f190: 6765 272c 0a20 2020 2020 2020 205b 0a20  ge',.        [. 
+0000f1a0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0000f1b0: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
+0000f1c0: 616d 657d 202d 2d63 6c6f 7564 207b 6765  ame} --cloud {ge
+0000f1d0: 6e65 7269 635f 636c 6f75 647d 202d 2d69  neric_cloud} --i
+0000f1e0: 6d61 6765 2d69 6420 646f 636b 6572 3a6e  mage-id docker:n
+0000f1f0: 6769 6e78 272c 0a20 2020 2020 2020 2020  ginx',.         
+0000f200: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
+0000f210: 616d 657d 2022 6e67 696e 7820 2d56 2227  ame} "nginx -V"'
+0000f220: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0000f230: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
+0000f240: 3120 2d2d 7374 6174 7573 272c 0a20 2020  1 --status',.   
+0000f250: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
+0000f260: 7865 6320 7b6e 616d 657d 2077 686f 616d  xec {name} whoam
+0000f270: 6920 7c20 6772 6570 2072 6f6f 7427 2c0a  i | grep root',.
+0000f280: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
+0000f290: 2020 2066 2773 6b79 2064 6f77 6e20 2d79     f'sky down -y
+0000f2a0: 207b 6e61 6d65 7d27 2c0a 2020 2020 290a   {name}',.    ).
+0000f2b0: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
+0000f2c0: 2874 6573 7429 0a0a 0a23 202d 2d2d 2d2d  (test)...# -----
+0000f2d0: 2d2d 2d2d 2d20 5375 626d 6974 7469 6e67  ----- Submitting
+0000f2e0: 206d 756c 7469 706c 6520 7461 736b 7320   multiple tasks 
+0000f2f0: 746f 2074 6865 2073 616d 6520 636c 7573  to the same clus
+0000f300: 7465 722e 202d 2d2d 2d2d 2d2d 2d2d 2d0a  ter. ----------.
+0000f310: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+0000f320: 666c 7569 6473 7461 636b 2020 2320 466c  fluidstack  # Fl
+0000f330: 7569 6453 7461 636b 2044 4320 6861 7320  uidStack DC has 
+0000f340: 6c6f 7720 6176 6169 6c61 6269 6c69 7479  low availability
+0000f350: 206f 6620 5434 2047 5055 730a 4070 7974   of T4 GPUs.@pyt
+0000f360: 6573 742e 6d61 726b 2e6e 6f5f 6c61 6d62  est.mark.no_lamb
+0000f370: 6461 5f63 6c6f 7564 2020 2320 4c61 6d62  da_cloud  # Lamb
+0000f380: 6461 2043 6c6f 7564 2064 6f65 7320 6e6f  da Cloud does no
+0000f390: 7420 6861 7665 2054 3420 6770 7573 0a40  t have T4 gpus.@
+0000f3a0: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f70  pytest.mark.no_p
+0000f3b0: 6170 6572 7370 6163 6520 2023 2050 6170  aperspace  # Pap
+0000f3c0: 6572 7370 6163 6520 646f 6573 206e 6f74  erspace does not
+0000f3d0: 2068 6176 6520 5434 2067 7075 730a 4070   have T4 gpus.@p
+0000f3e0: 7974 6573 742e 6d61 726b 2e6e 6f5f 6962  ytest.mark.no_ib
+0000f3f0: 6d20 2023 2049 424d 2043 6c6f 7564 2064  m  # IBM Cloud d
+0000f400: 6f65 7320 6e6f 7420 6861 7665 2054 3420  oes not have T4 
+0000f410: 6770 7573 0a40 7079 7465 7374 2e6d 6172  gpus.@pytest.mar
+0000f420: 6b2e 6e6f 5f73 6370 2020 2320 5343 5020  k.no_scp  # SCP 
+0000f430: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
+0000f440: 206e 756d 5f6e 6f64 6573 203e 2031 2079   num_nodes > 1 y
+0000f450: 6574 0a40 7079 7465 7374 2e6d 6172 6b2e  et.@pytest.mark.
+0000f460: 6e6f 5f6f 6369 2020 2320 4f43 4920 436c  no_oci  # OCI Cl
+0000f470: 6f75 6420 646f 6573 206e 6f74 2068 6176  oud does not hav
+0000f480: 6520 5434 2067 7075 730a 6465 6620 7465  e T4 gpus.def te
+0000f490: 7374 5f6d 756c 7469 5f65 6368 6f28 6765  st_multi_echo(ge
+0000f4a0: 6e65 7269 635f 636c 6f75 643a 2073 7472  neric_cloud: str
+0000f4b0: 293a 0a20 2020 206e 616d 6520 3d20 5f67  ):.    name = _g
+0000f4c0: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
+0000f4d0: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
+0000f4e0: 7428 0a20 2020 2020 2020 2027 6d75 6c74  t(.        'mult
+0000f4f0: 695f 6563 686f 272c 0a20 2020 2020 2020  i_echo',.       
+0000f500: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
+0000f510: 2770 7974 686f 6e20 6578 616d 706c 6573  'python examples
+0000f520: 2f6d 756c 7469 5f65 6368 6f2e 7079 207b  /multi_echo.py {
+0000f530: 6e61 6d65 7d20 7b67 656e 6572 6963 5f63  name} {generic_c
+0000f540: 6c6f 7564 7d27 2c0a 2020 2020 2020 2020  loud}',.        
+0000f550: 2020 2020 2773 6c65 6570 2031 3230 272c      'sleep 120',
+0000f560: 0a20 2020 2020 2020 205d 202b 0a20 2020  .        ] +.   
+0000f570: 2020 2020 2023 2045 6e73 7572 6520 6a6f       # Ensure jo
+0000f580: 6273 2073 7563 6365 6564 6564 2e0a 2020  bs succeeded..  
+0000f590: 2020 2020 2020 5b66 2773 6b79 206c 6f67        [f'sky log
+0000f5a0: 7320 7b6e 616d 657d 207b 6920 2b20 317d  s {name} {i + 1}
+0000f5b0: 202d 2d73 7461 7475 7327 2066 6f72 2069   --status' for i
+0000f5c0: 2069 6e20 7261 6e67 6528 3332 295d 202b   in range(32)] +
+0000f5d0: 0a20 2020 2020 2020 2023 2045 6e73 7572  .        # Ensur
+0000f5e0: 6520 6d6f 6e69 746f 722f 6175 746f 7363  e monitor/autosc
+0000f5f0: 616c 6572 2064 6964 6e27 7420 6372 6173  aler didn't cras
+0000f600: 6820 6f6e 2074 6865 2027 6173 7365 7274  h on the 'assert
+0000f610: 206e 6f74 0a20 2020 2020 2020 2023 2075   not.        # u
+0000f620: 6e66 756c 6669 6c6c 6564 2720 6572 726f  nfulfilled' erro
+0000f630: 722e 2020 4966 2070 726f 6365 7373 206e  r.  If process n
+0000f640: 6f74 2066 6f75 6e64 2c20 6772 6570 2d3e  ot found, grep->
+0000f650: 7373 6820 7265 7475 726e 7320 312e 0a20  ssh returns 1.. 
+0000f660: 2020 2020 2020 205b 6627 7373 6820 7b6e         [f'ssh {n
+0000f670: 616d 657d 205c 2770 7320 6175 7820 7c20  ame} \'ps aux | 
+0000f680: 6772 6570 2022 5b2f 5d22 6d6f 6e69 746f  grep "[/]"monito
+0000f690: 722e 7079 5c27 275d 2c0a 2020 2020 2020  r.py\''],.      
+0000f6a0: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
+0000f6b0: 7b6e 616d 657d 272c 0a20 2020 2020 2020  {name}',.       
+0000f6c0: 2074 696d 656f 7574 3d32 3020 2a20 3630   timeout=20 * 60
+0000f6d0: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
+0000f6e0: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
+0000f6f0: 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20 5461  .# ---------- Ta
+0000f700: 736b 3a20 3120 6e6f 6465 2074 7261 696e  sk: 1 node train
+0000f710: 696e 672e 202d 2d2d 2d2d 2d2d 2d2d 2d0a  ing. ----------.
+0000f720: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+0000f730: 6c61 6d62 6461 5f63 6c6f 7564 2020 2320  lambda_cloud  # 
+0000f740: 4c61 6d62 6461 2043 6c6f 7564 2064 6f65  Lambda Cloud doe
+0000f750: 7320 6e6f 7420 6861 7665 2056 3130 3020  s not have V100 
+0000f760: 6770 7573 0a40 7079 7465 7374 2e6d 6172  gpus.@pytest.mar
+0000f770: 6b2e 6e6f 5f69 626d 2020 2320 4942 4d20  k.no_ibm  # IBM 
+0000f780: 636c 6f75 6420 6375 7272 656e 746c 7920  cloud currently 
+0000f790: 646f 6573 6e27 7420 7072 6f76 6964 6520  doesn't provide 
+0000f7a0: 7075 626c 6963 2069 6d61 6765 2077 6974  public image wit
+0000f7b0: 6820 4355 4441 0a40 7079 7465 7374 2e6d  h CUDA.@pytest.m
+0000f7c0: 6172 6b2e 6e6f 5f73 6370 2020 2320 5343  ark.no_scp  # SC
+0000f7d0: 5020 646f 6573 206e 6f74 2068 6176 6520  P does not have 
+0000f7e0: 5631 3030 2028 3136 4742 2920 4750 5573  V100 (16GB) GPUs
+0000f7f0: 2e20 5275 6e20 7465 7374 5f73 6370 5f68  . Run test_scp_h
+0000f800: 7567 6769 6e67 6661 6365 2069 6e73 7465  uggingface inste
+0000f810: 6164 2e0a 6465 6620 7465 7374 5f68 7567  ad..def test_hug
+0000f820: 6769 6e67 6661 6365 2867 656e 6572 6963  gingface(generic
+0000f830: 5f63 6c6f 7564 3a20 7374 7229 3a0a 2020  _cloud: str):.  
+0000f840: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
+0000f850: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
+0000f860: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+0000f870: 2020 2020 2020 2768 7567 6769 6e67 6661        'huggingfa
+0000f880: 6365 5f67 6c75 655f 696d 6462 5f61 7070  ce_glue_imdb_app
+0000f890: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
+0000f8a0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+0000f8b0: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
+0000f8c0: 657d 202d 2d63 6c6f 7564 207b 6765 6e65  e} --cloud {gene
+0000f8d0: 7269 635f 636c 6f75 647d 2065 7861 6d70  ric_cloud} examp
+0000f8e0: 6c65 732f 6875 6767 696e 6766 6163 655f  les/huggingface_
+0000f8f0: 676c 7565 5f69 6d64 625f 6170 702e 7961  glue_imdb_app.ya
+0000f900: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
+0000f910: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
+0000f920: 657d 2031 202d 2d73 7461 7475 7327 2c20  e} 1 --status', 
+0000f930: 2023 2045 6e73 7572 6520 7468 6520 6a6f   # Ensure the jo
+0000f940: 6220 7375 6363 6565 6465 642e 0a20 2020  b succeeded..   
+0000f950: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
+0000f960: 7865 6320 7b6e 616d 657d 2065 7861 6d70  xec {name} examp
+0000f970: 6c65 732f 6875 6767 696e 6766 6163 655f  les/huggingface_
+0000f980: 676c 7565 5f69 6d64 625f 6170 702e 7961  glue_imdb_app.ya
+0000f990: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
+0000f9a0: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
+0000f9b0: 657d 2032 202d 2d73 7461 7475 7327 2c20  e} 2 --status', 
+0000f9c0: 2023 2045 6e73 7572 6520 7468 6520 6a6f   # Ensure the jo
+0000f9d0: 6220 7375 6363 6565 6465 642e 0a20 2020  b succeeded..   
+0000f9e0: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
+0000f9f0: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
+0000fa00: 616d 657d 272c 0a20 2020 2029 0a20 2020  ame}',.    ).   
+0000fa10: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
+0000fa20: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
+0000fa30: 726b 2e6c 616d 6264 615f 636c 6f75 640a  rk.lambda_cloud.
+0000fa40: 6465 6620 7465 7374 5f6c 616d 6264 615f  def test_lambda_
+0000fa50: 6875 6767 696e 6766 6163 6528 6765 6e65  huggingface(gene
+0000fa60: 7269 635f 636c 6f75 643a 2073 7472 293a  ric_cloud: str):
+0000fa70: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
+0000fa80: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
+0000fa90: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
+0000faa0: 0a20 2020 2020 2020 2027 6c61 6d62 6461  .        'lambda
+0000fab0: 5f68 7567 6769 6e67 6661 6365 5f67 6c75  _huggingface_glu
+0000fac0: 655f 696d 6462 5f61 7070 272c 0a20 2020  e_imdb_app',.   
+0000fad0: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
+0000fae0: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
+0000faf0: 2d79 202d 6320 7b6e 616d 657d 207b 4c41  -y -c {name} {LA
+0000fb00: 4d42 4441 5f54 5950 457d 2065 7861 6d70  MBDA_TYPE} examp
+0000fb10: 6c65 732f 6875 6767 696e 6766 6163 655f  les/huggingface_
+0000fb20: 676c 7565 5f69 6d64 625f 6170 702e 7961  glue_imdb_app.ya
+0000fb30: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
+0000fb40: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
+0000fb50: 657d 2031 202d 2d73 7461 7475 7327 2c20  e} 1 --status', 
+0000fb60: 2023 2045 6e73 7572 6520 7468 6520 6a6f   # Ensure the jo
+0000fb70: 6220 7375 6363 6565 6465 642e 0a20 2020  b succeeded..   
+0000fb80: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
+0000fb90: 7865 6320 7b6e 616d 657d 207b 4c41 4d42  xec {name} {LAMB
+0000fba0: 4441 5f54 5950 457d 2065 7861 6d70 6c65  DA_TYPE} example
+0000fbb0: 732f 6875 6767 696e 6766 6163 655f 676c  s/huggingface_gl
+0000fbc0: 7565 5f69 6d64 625f 6170 702e 7961 6d6c  ue_imdb_app.yaml
+0000fbd0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0000fbe0: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
+0000fbf0: 2032 202d 2d73 7461 7475 7327 2c20 2023   2 --status',  #
+0000fc00: 2045 6e73 7572 6520 7468 6520 6a6f 6220   Ensure the job 
+0000fc10: 7375 6363 6565 6465 642e 0a20 2020 2020  succeeded..     
+0000fc20: 2020 205d 2c0a 2020 2020 2020 2020 6627     ],.        f'
+0000fc30: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
+0000fc40: 657d 272c 0a20 2020 2029 0a20 2020 2072  e}',.    ).    r
+0000fc50: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
+0000fc60: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
+0000fc70: 2e73 6370 0a64 6566 2074 6573 745f 7363  .scp.def test_sc
+0000fc80: 705f 6875 6767 696e 6766 6163 6528 6765  p_huggingface(ge
+0000fc90: 6e65 7269 635f 636c 6f75 643a 2073 7472  neric_cloud: str
+0000fca0: 293a 0a20 2020 206e 616d 6520 3d20 5f67  ):.    name = _g
+0000fcb0: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
+0000fcc0: 290a 2020 2020 6e75 6d5f 6f66 5f67 7075  ).    num_of_gpu
+0000fcd0: 5f6c 6175 6e63 6820 3d20 310a 2020 2020  _launch = 1.    
+0000fce0: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
+0000fcf0: 2020 2020 2027 5343 505f 6875 6767 696e       'SCP_huggin
+0000fd00: 6766 6163 655f 676c 7565 5f69 6d64 625f  gface_glue_imdb_
+0000fd10: 6170 7027 2c0a 2020 2020 2020 2020 5b0a  app',.        [.
+0000fd20: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000fd30: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
+0000fd40: 6e61 6d65 7d20 7b53 4350 5f54 5950 457d  name} {SCP_TYPE}
+0000fd50: 207b 5343 505f 4750 555f 5631 3030 7d3a   {SCP_GPU_V100}:
+0000fd60: 7b6e 756d 5f6f 665f 6770 755f 6c61 756e  {num_of_gpu_laun
+0000fd70: 6368 7d20 6578 616d 706c 6573 2f68 7567  ch} examples/hug
+0000fd80: 6769 6e67 6661 6365 5f67 6c75 655f 696d  gingface_glue_im
+0000fd90: 6462 5f61 7070 2e79 616d 6c27 2c0a 2020  db_app.yaml',.  
+0000fda0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0000fdb0: 6c6f 6773 207b 6e61 6d65 7d20 3120 2d2d  logs {name} 1 --
+0000fdc0: 7374 6174 7573 272c 2020 2320 456e 7375  status',  # Ensu
+0000fdd0: 7265 2074 6865 206a 6f62 2073 7563 6365  re the job succe
+0000fde0: 6564 6564 2e0a 2020 2020 2020 2020 2020  eded..          
+0000fdf0: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
+0000fe00: 6d65 7d20 7b53 4350 5f54 5950 457d 207b  me} {SCP_TYPE} {
+0000fe10: 5343 505f 4750 555f 5631 3030 7d3a 7b6e  SCP_GPU_V100}:{n
+0000fe20: 756d 5f6f 665f 6770 755f 6c61 756e 6368  um_of_gpu_launch
+0000fe30: 7d20 6578 616d 706c 6573 2f68 7567 6769  } examples/huggi
+0000fe40: 6e67 6661 6365 5f67 6c75 655f 696d 6462  ngface_glue_imdb
+0000fe50: 5f61 7070 2e79 616d 6c27 2c0a 2020 2020  _app.yaml',.    
+0000fe60: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+0000fe70: 6773 207b 6e61 6d65 7d20 3220 2d2d 7374  gs {name} 2 --st
+0000fe80: 6174 7573 272c 2020 2320 456e 7375 7265  atus',  # Ensure
+0000fe90: 2074 6865 206a 6f62 2073 7563 6365 6564   the job succeed
+0000fea0: 6564 2e0a 2020 2020 2020 2020 5d2c 0a20  ed..        ],. 
+0000feb0: 2020 2020 2020 2066 2773 6b79 2064 6f77         f'sky dow
+0000fec0: 6e20 2d79 207b 6e61 6d65 7d27 2c0a 2020  n -y {name}',.  
+0000fed0: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
+0000fee0: 7465 7374 2874 6573 7429 0a0a 0a23 202d  test(test)...# -
+0000fef0: 2d2d 2d2d 2d2d 2d2d 2d20 496e 6665 7265  --------- Infere
+0000ff00: 6e74 6961 2e20 2d2d 2d2d 2d2d 2d2d 2d2d  ntia. ----------
+0000ff10: 0a40 7079 7465 7374 2e6d 6172 6b2e 6177  .@pytest.mark.aw
+0000ff20: 730a 6465 6620 7465 7374 5f69 6e66 6572  s.def test_infer
+0000ff30: 656e 7469 6128 293a 0a20 2020 206e 616d  entia():.    nam
+0000ff40: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
+0000ff50: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
+0000ff60: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
+0000ff70: 2027 7465 7374 5f69 6e66 6572 656e 7469   'test_inferenti
+0000ff80: 6127 2c0a 2020 2020 2020 2020 5b0a 2020  a',.        [.  
+0000ff90: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0000ffa0: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
+0000ffb0: 6d65 7d20 2d74 2069 6e66 322e 786c 6172  me} -t inf2.xlar
+0000ffc0: 6765 202d 2d20 6563 686f 2068 6927 2c0a  ge -- echo hi',.
+0000ffd0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000ffe0: 7920 6578 6563 207b 6e61 6d65 7d20 2d2d  y exec {name} --
+0000fff0: 6770 7573 2049 6e66 6572 656e 7469 613a  gpus Inferentia:
+00010000: 3120 6563 686f 2068 6927 2c0a 2020 2020  1 echo hi',.    
+00010010: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+00010020: 6773 207b 6e61 6d65 7d20 3120 2d2d 7374  gs {name} 1 --st
+00010030: 6174 7573 272c 2020 2320 456e 7375 7265  atus',  # Ensure
+00010040: 2074 6865 206a 6f62 2073 7563 6365 6564   the job succeed
+00010050: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
+00010060: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+00010070: 7d20 3220 2d2d 7374 6174 7573 272c 2020  } 2 --status',  
+00010080: 2320 456e 7375 7265 2074 6865 206a 6f62  # Ensure the job
+00010090: 2073 7563 6365 6564 6564 2e0a 2020 2020   succeeded..    
+000100a0: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
+000100b0: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
+000100c0: 6d65 7d27 2c0a 2020 2020 290a 2020 2020  me}',.    ).    
+000100d0: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
+000100e0: 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d  t)...# ---------
+000100f0: 2d20 5450 552e 202d 2d2d 2d2d 2d2d 2d2d  - TPU. ---------
+00010100: 2d0a 4070 7974 6573 742e 6d61 726b 2e67  -.@pytest.mark.g
+00010110: 6370 0a40 7079 7465 7374 2e6d 6172 6b2e  cp.@pytest.mark.
+00010120: 7470 750a 6465 6620 7465 7374 5f74 7075  tpu.def test_tpu
+00010130: 2829 3a0a 2020 2020 6e61 6d65 203d 205f  ():.    name = _
+00010140: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
+00010150: 2829 0a20 2020 2074 6573 7420 3d20 5465  ().    test = Te
+00010160: 7374 280a 2020 2020 2020 2020 2774 7075  st(.        'tpu
+00010170: 5f61 7070 272c 0a20 2020 2020 2020 205b  _app',.        [
+00010180: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00010190: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
+000101a0: 7b6e 616d 657d 2065 7861 6d70 6c65 732f  {name} examples/
+000101b0: 7470 752f 7470 755f 6170 702e 7961 6d6c  tpu/tpu_app.yaml
+000101c0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+000101d0: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
+000101e0: 2031 272c 2020 2320 456e 7375 7265 2074   1',  # Ensure t
+000101f0: 6865 206a 6f62 2066 696e 6973 6865 642e  he job finished.
+00010200: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00010210: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
+00010220: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
+00010230: 6e73 7572 6520 7468 6520 6a6f 6220 7375  nsure the job su
+00010240: 6363 6565 6465 642e 0a20 2020 2020 2020  cceeded..       
+00010250: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
+00010260: 6820 2d79 202d 6320 7b6e 616d 657d 2065  h -y -c {name} e
+00010270: 7861 6d70 6c65 732f 7470 752f 7470 755f  xamples/tpu/tpu_
+00010280: 6170 702e 7961 6d6c 207c 2067 7265 7020  app.yaml | grep 
+00010290: 2254 5055 202e 2a20 616c 7265 6164 7920  "TPU .* already 
+000102a0: 6578 6973 7473 2227 2c20 2023 2045 6e73  exists"',  # Ens
+000102b0: 7572 6520 736b 7920 6c61 756e 6368 2077  ure sky launch w
+000102c0: 6f6e 2774 2063 7265 6174 6520 616e 6f74  on't create anot
+000102d0: 6865 7220 5450 552e 0a20 2020 2020 2020  her TPU..       
+000102e0: 205d 2c0a 2020 2020 2020 2020 6627 736b   ],.        f'sk
+000102f0: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
+00010300: 272c 0a20 2020 2020 2020 2074 696d 656f  ',.        timeo
+00010310: 7574 3d33 3020 2a20 3630 2c20 2023 2063  ut=30 * 60,  # c
+00010320: 616e 2074 616b 6520 3e32 3020 6d69 6e73  an take >20 mins
+00010330: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+00010340: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+00010350: 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054 5055  # ---------- TPU
+00010360: 2056 4d2e 202d 2d2d 2d2d 2d2d 2d2d 2d0a   VM. ----------.
+00010370: 4070 7974 6573 742e 6d61 726b 2e67 6370  @pytest.mark.gcp
+00010380: 0a40 7079 7465 7374 2e6d 6172 6b2e 7470  .@pytest.mark.tp
+00010390: 750a 6465 6620 7465 7374 5f74 7075 5f76  u.def test_tpu_v
+000103a0: 6d28 293a 0a20 2020 206e 616d 6520 3d20  m():.    name = 
+000103b0: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
+000103c0: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
+000103d0: 6573 7428 0a20 2020 2020 2020 2027 7470  est(.        'tp
+000103e0: 755f 766d 5f61 7070 272c 0a20 2020 2020  u_vm_app',.     
+000103f0: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+00010400: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
+00010410: 202d 6320 7b6e 616d 657d 2065 7861 6d70   -c {name} examp
+00010420: 6c65 732f 7470 752f 7470 7576 6d5f 6d6e  les/tpu/tpuvm_mn
+00010430: 6973 742e 7961 6d6c 272c 0a20 2020 2020  ist.yaml',.     
+00010440: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+00010450: 7320 7b6e 616d 657d 2031 272c 2020 2320  s {name} 1',  # 
+00010460: 456e 7375 7265 2074 6865 206a 6f62 2066  Ensure the job f
+00010470: 696e 6973 6865 642e 0a20 2020 2020 2020  inished..       
+00010480: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+00010490: 7b6e 616d 657d 2031 202d 2d73 7461 7475  {name} 1 --statu
+000104a0: 7327 2c20 2023 2045 6e73 7572 6520 7468  s',  # Ensure th
+000104b0: 6520 6a6f 6220 7375 6363 6565 6465 642e  e job succeeded.
+000104c0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+000104d0: 6b79 2073 746f 7020 2d79 207b 6e61 6d65  ky stop -y {name
+000104e0: 7d27 2c0a 2020 2020 2020 2020 2020 2020  }',.            
+000104f0: 6627 733d 2428 736b 7920 7374 6174 7573  f's=$(sky status
+00010500: 207b 6e61 6d65 7d20 2d2d 7265 6672 6573   {name} --refres
+00010510: 6829 3b20 6563 686f 2022 2473 223b 2065  h); echo "$s"; e
+00010520: 6368 6f3b 2065 6368 6f3b 2065 6368 6f20  cho; echo; echo 
+00010530: 2224 7322 2020 7c20 6772 6570 207b 6e61  "$s"  | grep {na
+00010540: 6d65 7d20 7c20 6772 6570 2053 544f 5050  me} | grep STOPP
+00010550: 4544 272c 2020 2320 456e 7375 7265 2074  ED',  # Ensure t
+00010560: 6865 2063 6c75 7374 6572 2069 7320 5354  he cluster is ST
+00010570: 4f50 5045 442e 0a20 2020 2020 2020 2020  OPPED..         
+00010580: 2020 2023 2055 7365 2072 6574 7279 3a20     # Use retry: 
+00010590: 6775 6172 6420 6167 6169 6e73 7420 7472  guard against tr
+000105a0: 616e 7369 656e 7420 6572 726f 7273 206f  ansient errors o
+000105b0: 6273 6572 7665 6420 666f 720a 2020 2020  bserved for.    
+000105c0: 2020 2020 2020 2020 2320 6a75 7374 2d73          # just-s
+000105d0: 746f 7070 6564 2054 5055 2056 4d73 2028  topped TPU VMs (
+000105e0: 2339 3632 292e 0a20 2020 2020 2020 2020  #962)..         
+000105f0: 2020 2066 2773 6b79 2073 7461 7274 202d     f'sky start -
+00010600: 2d72 6574 7279 2d75 6e74 696c 2d75 7020  -retry-until-up 
+00010610: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
+00010620: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
+00010630: 6563 207b 6e61 6d65 7d20 6578 616d 706c  ec {name} exampl
+00010640: 6573 2f74 7075 2f74 7075 766d 5f6d 6e69  es/tpu/tpuvm_mni
+00010650: 7374 2e79 616d 6c27 2c0a 2020 2020 2020  st.yaml',.      
+00010660: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
+00010670: 207b 6e61 6d65 7d20 3220 2d2d 7374 6174   {name} 2 --stat
+00010680: 7573 272c 2020 2320 456e 7375 7265 2074  us',  # Ensure t
+00010690: 6865 206a 6f62 2073 7563 6365 6564 6564  he job succeeded
+000106a0: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
+000106b0: 736b 7920 7374 6f70 202d 7920 7b6e 616d  sky stop -y {nam
+000106c0: 657d 272c 0a20 2020 2020 2020 205d 2c0a  e}',.        ],.
+000106d0: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
+000106e0: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
+000106f0: 2020 2020 2020 2074 696d 656f 7574 3d33         timeout=3
+00010700: 3020 2a20 3630 2c20 2023 2063 616e 2074  0 * 60,  # can t
+00010710: 616b 6520 3330 206d 696e 730a 2020 2020  ake 30 mins.    
+00010720: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
+00010730: 7374 2874 6573 7429 0a0a 0a23 202d 2d2d  st(test)...# ---
+00010740: 2d2d 2d2d 2d2d 2d20 5450 5520 564d 2050  ------- TPU VM P
+00010750: 6f64 2e20 2d2d 2d2d 2d2d 2d2d 2d2d 0a40  od. ----------.@
+00010760: 7079 7465 7374 2e6d 6172 6b2e 6763 700a  pytest.mark.gcp.
+00010770: 4070 7974 6573 742e 6d61 726b 2e74 7075  @pytest.mark.tpu
+00010780: 0a64 6566 2074 6573 745f 7470 755f 766d  .def test_tpu_vm
+00010790: 5f70 6f64 2829 3a0a 2020 2020 6e61 6d65  _pod():.    name
+000107a0: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
+000107b0: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
+000107c0: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+000107d0: 2774 7075 5f70 6f64 272c 0a20 2020 2020  'tpu_pod',.     
+000107e0: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+000107f0: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
+00010800: 202d 6320 7b6e 616d 657d 2065 7861 6d70   -c {name} examp
+00010810: 6c65 732f 7470 752f 7470 7576 6d5f 6d6e  les/tpu/tpuvm_mn
+00010820: 6973 742e 7961 6d6c 202d 2d67 7075 7320  ist.yaml --gpus 
+00010830: 7470 752d 7632 2d33 3220 2d2d 7573 652d  tpu-v2-32 --use-
+00010840: 7370 6f74 202d 2d7a 6f6e 6520 6575 726f  spot --zone euro
+00010850: 7065 2d77 6573 7434 2d61 272c 0a20 2020  pe-west4-a',.   
+00010860: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00010870: 6f67 7320 7b6e 616d 657d 2031 272c 2020  ogs {name} 1',  
+00010880: 2320 456e 7375 7265 2074 6865 206a 6f62  # Ensure the job
+00010890: 2066 696e 6973 6865 642e 0a20 2020 2020   finished..     
+000108a0: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+000108b0: 7320 7b6e 616d 657d 2031 202d 2d73 7461  s {name} 1 --sta
+000108c0: 7475 7327 2c20 2023 2045 6e73 7572 6520  tus',  # Ensure 
+000108d0: 7468 6520 6a6f 6220 7375 6363 6565 6465  the job succeede
+000108e0: 642e 0a20 2020 2020 2020 205d 2c0a 2020  d..        ],.  
+000108f0: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
+00010900: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
+00010910: 2020 2020 2074 696d 656f 7574 3d33 3020       timeout=30 
+00010920: 2a20 3630 2c20 2023 2063 616e 2074 616b  * 60,  # can tak
+00010930: 6520 3330 206d 696e 730a 2020 2020 290a  e 30 mins.    ).
+00010940: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
+00010950: 2874 6573 7429 0a0a 0a23 202d 2d2d 2d2d  (test)...# -----
+00010960: 2d2d 2d2d 2d20 5369 6d70 6c65 2061 7070  ----- Simple app
+00010970: 732e 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070  s. ----------.@p
+00010980: 7974 6573 742e 6d61 726b 2e6e 6f5f 7363  ytest.mark.no_sc
+00010990: 7020 2023 2053 4350 2064 6f65 7320 6e6f  p  # SCP does no
+000109a0: 7420 7375 7070 6f72 7420 6e75 6d5f 6e6f  t support num_no
+000109b0: 6465 7320 3e20 3120 7965 740a 6465 6620  des > 1 yet.def 
+000109c0: 7465 7374 5f6d 756c 7469 5f68 6f73 746e  test_multi_hostn
+000109d0: 616d 6528 6765 6e65 7269 635f 636c 6f75  ame(generic_clou
+000109e0: 643a 2073 7472 293a 0a20 2020 206e 616d  d: str):.    nam
+000109f0: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
+00010a00: 5f6e 616d 6528 290a 2020 2020 746f 7461  _name().    tota
+00010a10: 6c5f 7469 6d65 6f75 745f 6d69 6e75 7465  l_timeout_minute
+00010a20: 7320 3d20 3235 2069 6620 6765 6e65 7269  s = 25 if generi
+00010a30: 635f 636c 6f75 6420 3d3d 2027 617a 7572  c_cloud == 'azur
+00010a40: 6527 2065 6c73 6520 3135 0a20 2020 2074  e' else 15.    t
+00010a50: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+00010a60: 2020 2020 276d 756c 7469 5f68 6f73 746e      'multi_hostn
+00010a70: 616d 6527 2c0a 2020 2020 2020 2020 5b0a  ame',.        [.
+00010a80: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00010a90: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
+00010aa0: 6e61 6d65 7d20 2d2d 636c 6f75 6420 7b67  name} --cloud {g
+00010ab0: 656e 6572 6963 5f63 6c6f 7564 7d20 6578  eneric_cloud} ex
+00010ac0: 616d 706c 6573 2f6d 756c 7469 5f68 6f73  amples/multi_hos
+00010ad0: 746e 616d 652e 7961 6d6c 272c 0a20 2020  tname.yaml',.   
+00010ae0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00010af0: 6f67 7320 7b6e 616d 657d 2031 202d 2d73  ogs {name} 1 --s
+00010b00: 7461 7475 7327 2c20 2023 2045 6e73 7572  tatus',  # Ensur
+00010b10: 6520 7468 6520 6a6f 6220 7375 6363 6565  e the job succee
+00010b20: 6465 642e 0a20 2020 2020 2020 2020 2020  ded..           
+00010b30: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
+00010b40: 657d 2031 207c 2067 7265 7020 224d 7920  e} 1 | grep "My 
+00010b50: 686f 7374 6e61 6d65 3a22 207c 2077 6320  hostname:" | wc 
+00010b60: 2d6c 207c 2067 7265 7020 3227 2c20 2023  -l | grep 2',  #
+00010b70: 2045 6e73 7572 6520 7468 6572 6520 6172   Ensure there ar
+00010b80: 6520 3220 686f 7374 732e 0a20 2020 2020  e 2 hosts..     
+00010b90: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
+00010ba0: 6320 7b6e 616d 657d 2065 7861 6d70 6c65  c {name} example
+00010bb0: 732f 6d75 6c74 695f 686f 7374 6e61 6d65  s/multi_hostname
+00010bc0: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
+00010bd0: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
+00010be0: 6e61 6d65 7d20 3220 2d2d 7374 6174 7573  name} 2 --status
+00010bf0: 272c 2020 2320 456e 7375 7265 2074 6865  ',  # Ensure the
+00010c00: 206a 6f62 2073 7563 6365 6564 6564 2e0a   job succeeded..
+00010c10: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
+00010c20: 2020 2066 2773 6b79 2064 6f77 6e20 2d79     f'sky down -y
+00010c30: 207b 6e61 6d65 7d27 2c0a 2020 2020 2020   {name}',.      
+00010c40: 2020 7469 6d65 6f75 743d 5f67 6574 5f74    timeout=_get_t
+00010c50: 696d 656f 7574 2867 656e 6572 6963 5f63  imeout(generic_c
+00010c60: 6c6f 7564 2c20 746f 7461 6c5f 7469 6d65  loud, total_time
+00010c70: 6f75 745f 6d69 6e75 7465 7320 2a20 3630  out_minutes * 60
+00010c80: 292c 0a20 2020 2029 0a20 2020 2072 756e  ),.    ).    run
+00010c90: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
+00010ca0: 0a0a 4070 7974 6573 742e 6d61 726b 2e6e  ..@pytest.mark.n
+00010cb0: 6f5f 7363 7020 2023 2053 4350 2064 6f65  o_scp  # SCP doe
+00010cc0: 7320 6e6f 7420 7375 7070 6f72 7420 6e75  s not support nu
+00010cd0: 6d5f 6e6f 6465 7320 3e20 3120 7965 740a  m_nodes > 1 yet.
+00010ce0: 6465 6620 7465 7374 5f6d 756c 7469 5f6e  def test_multi_n
+00010cf0: 6f64 655f 6661 696c 7572 6528 6765 6e65  ode_failure(gene
+00010d00: 7269 635f 636c 6f75 643a 2073 7472 293a  ric_cloud: str):
+00010d10: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
+00010d20: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
+00010d30: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
+00010d40: 0a20 2020 2020 2020 2027 6d75 6c74 695f  .        'multi_
+00010d50: 6e6f 6465 5f66 6169 6c75 7265 272c 0a20  node_failure',. 
+00010d60: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
+00010d70: 2020 2020 2023 2054 4f44 4f28 7a68 7775       # TODO(zhwu
+00010d80: 293a 2077 6520 7573 6520 6d75 6c74 692d  ): we use multi-
+00010d90: 7468 7265 6164 2074 6f20 7275 6e20 7468  thread to run th
+00010da0: 6520 636f 6d6d 616e 6473 2069 6e20 7365  e commands in se
+00010db0: 7475 700a 2020 2020 2020 2020 2020 2020  tup.            
+00010dc0: 2320 636f 6d6d 616e 6473 2069 6e20 7061  # commands in pa
+00010dd0: 7261 6c6c 656c 2c20 7768 6963 6820 6d61  rallel, which ma
+00010de0: 6b65 7320 6974 2069 6d70 6f73 7369 626c  kes it impossibl
+00010df0: 6520 746f 2066 6169 6c20 6661 7374 0a20  e to fail fast. 
+00010e00: 2020 2020 2020 2020 2020 2023 2077 6865             # whe
+00010e10: 6e20 6f6e 6520 6f66 2074 6865 206e 6f64  n one of the nod
+00010e20: 6573 2066 6169 6c73 2e20 5765 2073 686f  es fails. We sho
+00010e30: 756c 6420 6669 7820 7468 6973 2069 6e20  uld fix this in 
+00010e40: 7468 6520 6675 7475 7265 2e0a 2020 2020  the future..    
+00010e50: 2020 2020 2020 2020 2320 5468 6520 2d2d          # The --
+00010e60: 6465 7461 6368 2d73 6574 7570 2076 6572  detach-setup ver
+00010e70: 7369 6f6e 2063 616e 2066 6169 6c20 6661  sion can fail fa
+00010e80: 7374 2c20 6173 2074 6865 2073 6574 7570  st, as the setup
+00010e90: 2069 730a 2020 2020 2020 2020 2020 2020   is.            
+00010ea0: 2320 7375 626d 6974 7465 6420 746f 2074  # submitted to t
+00010eb0: 6865 2072 656d 6f74 6520 6d61 6368 696e  he remote machin
+00010ec0: 652c 2077 6869 6368 2064 6f65 7320 6e6f  e, which does no
+00010ed0: 7420 7573 6520 6d75 6c74 692d 7468 7265  t use multi-thre
+00010ee0: 6164 2e0a 2020 2020 2020 2020 2020 2020  ad..            
+00010ef0: 2320 5265 6665 7220 746f 2074 6865 2063  # Refer to the c
+00010f00: 6f6d 6d65 6e74 2069 6e20 6073 7562 7072  omment in `subpr
+00010f10: 6f63 6573 735f 7574 696c 732e 7275 6e5f  ocess_utils.run_
+00010f20: 696e 5f70 6172 616c 6c65 6c60 2e0a 2020  in_parallel`..  
+00010f30: 2020 2020 2020 2020 2020 2320 6627 736b            # f'sk
+00010f40: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
+00010f50: 6e61 6d65 7d20 2d2d 636c 6f75 6420 7b67  name} --cloud {g
+00010f60: 656e 6572 6963 5f63 6c6f 7564 7d20 7465  eneric_cloud} te
+00010f70: 7374 732f 7465 7374 5f79 616d 6c73 2f66  sts/test_yamls/f
+00010f80: 6169 6c65 645f 776f 726b 6572 5f73 6574  ailed_worker_set
+00010f90: 7570 2e79 616d 6c20 2626 2065 7869 7420  up.yaml && exit 
+00010fa0: 3127 2c20 2023 2045 6e73 7572 6520 7468  1',  # Ensure th
+00010fb0: 6520 6a6f 6220 7365 7475 7020 6661 696c  e job setup fail
+00010fc0: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
+00010fd0: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
+00010fe0: 2d63 207b 6e61 6d65 7d20 2d2d 636c 6f75  -c {name} --clou
+00010ff0: 6420 7b67 656e 6572 6963 5f63 6c6f 7564  d {generic_cloud
+00011000: 7d20 2d2d 6465 7461 6368 2d73 6574 7570  } --detach-setup
+00011010: 2074 6573 7473 2f74 6573 745f 7961 6d6c   tests/test_yaml
+00011020: 732f 6661 696c 6564 5f77 6f72 6b65 725f  s/failed_worker_
+00011030: 7365 7475 702e 7961 6d6c 272c 0a20 2020  setup.yaml',.   
+00011040: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00011050: 6f67 7320 7b6e 616d 657d 2031 202d 2d73  ogs {name} 1 --s
+00011060: 7461 7475 7320 7c20 6772 6570 2046 4149  tatus | grep FAI
+00011070: 4c45 445f 5345 5455 5027 2c20 2023 2045  LED_SETUP',  # E
+00011080: 6e73 7572 6520 7468 6520 6a6f 6220 7365  nsure the job se
+00011090: 7475 7020 6661 696c 6564 2e0a 2020 2020  tup failed..    
+000110a0: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
+000110b0: 6563 207b 6e61 6d65 7d20 7465 7374 732f  ec {name} tests/
+000110c0: 7465 7374 5f79 616d 6c73 2f66 6169 6c65  test_yamls/faile
+000110d0: 645f 776f 726b 6572 5f72 756e 2e79 616d  d_worker_run.yam
+000110e0: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+000110f0: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+00011100: 7d20 3220 2d2d 7374 6174 7573 207c 2067  } 2 --status | g
+00011110: 7265 7020 4641 494c 4544 272c 2020 2320  rep FAILED',  # 
+00011120: 456e 7375 7265 2074 6865 206a 6f62 2066  Ensure the job f
+00011130: 6169 6c65 642e 0a20 2020 2020 2020 2020  ailed..         
+00011140: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+00011150: 616d 657d 2032 207c 2067 7265 7020 224d  ame} 2 | grep "M
+00011160: 7920 686f 7374 6e61 6d65 3a22 207c 2077  y hostname:" | w
+00011170: 6320 2d6c 207c 2067 7265 7020 3227 2c20  c -l | grep 2', 
+00011180: 2023 2045 6e73 7572 6520 7468 6572 6520   # Ensure there 
+00011190: 3220 6f66 2074 6865 2068 6f73 7473 2070  2 of the hosts p
+000111a0: 7269 6e74 6564 2074 6865 6972 2068 6f73  rinted their hos
+000111b0: 746e 616d 652e 0a20 2020 2020 2020 205d  tname..        ]
+000111c0: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
+000111d0: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
+000111e0: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+000111f0: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+00011200: 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2057 6562  # ---------- Web
+00011210: 2061 7070 7320 7769 7468 2063 7573 746f   apps with custo
+00011220: 6d20 706f 7274 7320 6f6e 2047 4350 2e20  m ports on GCP. 
+00011230: 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465  ----------.@pyte
+00011240: 7374 2e6d 6172 6b2e 6763 700a 6465 6620  st.mark.gcp.def 
+00011250: 7465 7374 5f67 6370 5f68 7474 705f 7365  test_gcp_http_se
+00011260: 7276 6572 5f77 6974 685f 6375 7374 6f6d  rver_with_custom
+00011270: 5f70 6f72 7473 2829 3a0a 2020 2020 6e61  _ports():.    na
+00011280: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
+00011290: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
+000112a0: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
+000112b0: 2020 2767 6370 5f68 7474 705f 7365 7276    'gcp_http_serv
+000112c0: 6572 5f77 6974 685f 6375 7374 6f6d 5f70  er_with_custom_p
+000112d0: 6f72 7473 272c 0a20 2020 2020 2020 205b  orts',.        [
+000112e0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+000112f0: 6b79 206c 6175 6e63 6820 2d79 202d 6420  ky launch -y -d 
+00011300: 2d63 207b 6e61 6d65 7d20 2d2d 636c 6f75  -c {name} --clou
+00011310: 6420 6763 7020 6578 616d 706c 6573 2f68  d gcp examples/h
+00011320: 7474 705f 7365 7276 6572 5f77 6974 685f  ttp_server_with_
+00011330: 6375 7374 6f6d 5f70 6f72 7473 2f74 6173  custom_ports/tas
+00011340: 6b2e 7961 6d6c 272c 0a20 2020 2020 2020  k.yaml',.       
+00011350: 2020 2020 2066 2775 6e74 696c 2053 4b59       f'until SKY
+00011360: 5049 4c4f 545f 4445 4255 473d 3020 736b  PILOT_DEBUG=0 sk
+00011370: 7920 7374 6174 7573 202d 2d65 6e64 706f  y status --endpo
+00011380: 696e 7420 3333 3832 3820 7b6e 616d 657d  int 33828 {name}
+00011390: 3b20 646f 2073 6c65 6570 2031 303b 2064  ; do sleep 10; d
+000113a0: 6f6e 6527 2c0a 2020 2020 2020 2020 2020  one',.          
+000113b0: 2020 2320 5265 7472 7920 6120 6665 7720    # Retry a few 
+000113c0: 7469 6d65 7320 746f 2061 766f 6964 2066  times to avoid f
+000113d0: 6c61 6b69 6e65 7373 2069 6e20 706f 7274  lakiness in port
+000113e0: 7320 6265 696e 6720 6f70 656e 2e0a 2020  s being open..  
+000113f0: 2020 2020 2020 2020 2020 6627 6970 3d24            f'ip=$
+00011400: 2853 4b59 5049 4c4f 545f 4445 4255 473d  (SKYPILOT_DEBUG=
+00011410: 3020 736b 7920 7374 6174 7573 202d 2d65  0 sky status --e
+00011420: 6e64 706f 696e 7420 3333 3832 3820 7b6e  ndpoint 33828 {n
+00011430: 616d 657d 293b 2073 7563 6365 7373 3d66  ame}); success=f
+00011440: 616c 7365 3b20 666f 7220 6920 696e 2024  alse; for i in $
+00011450: 2873 6571 2031 2035 293b 2064 6f20 6966  (seq 1 5); do if
+00011460: 2063 7572 6c20 2469 7020 7c20 6772 6570   curl $ip | grep
+00011470: 2022 3c68 313e 5468 6973 2069 7320 6120   "<h1>This is a 
+00011480: 6465 6d6f 2048 544d 4c20 7061 6765 2e3c  demo HTML page.<
+00011490: 2f68 313e 223b 2074 6865 6e20 7375 6363  /h1>"; then succ
+000114a0: 6573 733d 7472 7565 3b20 6272 6561 6b3b  ess=true; break;
+000114b0: 2066 693b 2073 6c65 6570 2031 303b 2064   fi; sleep 10; d
+000114c0: 6f6e 653b 2069 6620 5b20 2224 7375 6363  one; if [ "$succ
+000114d0: 6573 7322 203d 2066 616c 7365 205d 3b20  ess" = false ]; 
+000114e0: 7468 656e 2065 7869 7420 313b 2066 6927  then exit 1; fi'
+000114f0: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
+00011500: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
+00011510: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
+00011520: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
+00011530: 7374 2874 6573 7429 0a0a 0a23 202d 2d2d  st(test)...# ---
+00011540: 2d2d 2d2d 2d2d 2d20 5765 6220 6170 7073  ------- Web apps
+00011550: 2077 6974 6820 6375 7374 6f6d 2070 6f72   with custom por
+00011560: 7473 206f 6e20 4157 532e 202d 2d2d 2d2d  ts on AWS. -----
+00011570: 2d2d 2d2d 2d0a 4070 7974 6573 742e 6d61  -----.@pytest.ma
+00011580: 726b 2e61 7773 0a64 6566 2074 6573 745f  rk.aws.def test_
+00011590: 6177 735f 6874 7470 5f73 6572 7665 725f  aws_http_server_
+000115a0: 7769 7468 5f63 7573 746f 6d5f 706f 7274  with_custom_port
+000115b0: 7328 293a 0a20 2020 206e 616d 6520 3d20  s():.    name = 
+000115c0: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
+000115d0: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
+000115e0: 6573 7428 0a20 2020 2020 2020 2027 6177  est(.        'aw
+000115f0: 735f 6874 7470 5f73 6572 7665 725f 7769  s_http_server_wi
+00011600: 7468 5f63 7573 746f 6d5f 706f 7274 7327  th_custom_ports'
+00011610: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
+00011620: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
+00011630: 756e 6368 202d 7920 2d64 202d 6320 7b6e  unch -y -d -c {n
+00011640: 616d 657d 202d 2d63 6c6f 7564 2061 7773  ame} --cloud aws
+00011650: 2065 7861 6d70 6c65 732f 6874 7470 5f73   examples/http_s
+00011660: 6572 7665 725f 7769 7468 5f63 7573 746f  erver_with_custo
+00011670: 6d5f 706f 7274 732f 7461 736b 2e79 616d  m_ports/task.yam
+00011680: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+00011690: 6627 756e 7469 6c20 534b 5950 494c 4f54  f'until SKYPILOT
+000116a0: 5f44 4542 5547 3d30 2073 6b79 2073 7461  _DEBUG=0 sky sta
+000116b0: 7475 7320 2d2d 656e 6470 6f69 6e74 2033  tus --endpoint 3
+000116c0: 3338 3238 207b 6e61 6d65 7d3b 2064 6f20  3828 {name}; do 
+000116d0: 736c 6565 7020 3130 3b20 646f 6e65 272c  sleep 10; done',
+000116e0: 0a20 2020 2020 2020 2020 2020 2023 2052  .            # R
+000116f0: 6574 7279 2061 2066 6577 2074 696d 6573  etry a few times
+00011700: 2074 6f20 6176 6f69 6420 666c 616b 696e   to avoid flakin
+00011710: 6573 7320 696e 2070 6f72 7473 2062 6569  ess in ports bei
+00011720: 6e67 206f 7065 6e2e 0a20 2020 2020 2020  ng open..       
+00011730: 2020 2020 2066 2769 703d 2428 534b 5950       f'ip=$(SKYP
+00011740: 494c 4f54 5f44 4542 5547 3d30 2073 6b79  ILOT_DEBUG=0 sky
+00011750: 2073 7461 7475 7320 2d2d 656e 6470 6f69   status --endpoi
+00011760: 6e74 2033 3338 3238 207b 6e61 6d65 7d29  nt 33828 {name})
+00011770: 3b20 7375 6363 6573 733d 6661 6c73 653b  ; success=false;
+00011780: 2066 6f72 2069 2069 6e20 2428 7365 7120   for i in $(seq 
+00011790: 3120 3529 3b20 646f 2069 6620 6375 726c  1 5); do if curl
+000117a0: 2024 6970 207c 2067 7265 7020 223c 6831   $ip | grep "<h1
+000117b0: 3e54 6869 7320 6973 2061 2064 656d 6f20  >This is a demo 
+000117c0: 4854 4d4c 2070 6167 652e 3c2f 6831 3e22  HTML page.</h1>"
+000117d0: 3b20 7468 656e 2073 7563 6365 7373 3d74  ; then success=t
+000117e0: 7275 653b 2062 7265 616b 3b20 6669 3b20  rue; break; fi; 
+000117f0: 736c 6565 7020 3130 3b20 646f 6e65 3b20  sleep 10; done; 
+00011800: 6966 205b 2022 2473 7563 6365 7373 2220  if [ "$success" 
+00011810: 3d20 6661 6c73 6520 5d3b 2074 6865 6e20  = false ]; then 
+00011820: 6578 6974 2031 3b20 6669 270a 2020 2020  exit 1; fi'.    
+00011830: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
+00011840: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
+00011850: 6d65 7d27 2c0a 2020 2020 290a 2020 2020  me}',.    ).    
+00011860: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
+00011870: 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d  t)...# ---------
+00011880: 2d20 5765 6220 6170 7073 2077 6974 6820  - Web apps with 
+00011890: 6375 7374 6f6d 2070 6f72 7473 206f 6e20  custom ports on 
+000118a0: 417a 7572 652e 202d 2d2d 2d2d 2d2d 2d2d  Azure. ---------
+000118b0: 2d0a 4070 7974 6573 742e 6d61 726b 2e61  -.@pytest.mark.a
+000118c0: 7a75 7265 0a64 6566 2074 6573 745f 617a  zure.def test_az
+000118d0: 7572 655f 6874 7470 5f73 6572 7665 725f  ure_http_server_
+000118e0: 7769 7468 5f63 7573 746f 6d5f 706f 7274  with_custom_port
+000118f0: 7328 293a 0a20 2020 206e 616d 6520 3d20  s():.    name = 
+00011900: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
+00011910: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
+00011920: 6573 7428 0a20 2020 2020 2020 2027 617a  est(.        'az
+00011930: 7572 655f 6874 7470 5f73 6572 7665 725f  ure_http_server_
+00011940: 7769 7468 5f63 7573 746f 6d5f 706f 7274  with_custom_port
+00011950: 7327 2c0a 2020 2020 2020 2020 5b0a 2020  s',.        [.  
+00011960: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00011970: 6c61 756e 6368 202d 7920 2d64 202d 6320  launch -y -d -c 
+00011980: 7b6e 616d 657d 202d 2d63 6c6f 7564 2061  {name} --cloud a
+00011990: 7a75 7265 2065 7861 6d70 6c65 732f 6874  zure examples/ht
+000119a0: 7470 5f73 6572 7665 725f 7769 7468 5f63  tp_server_with_c
+000119b0: 7573 746f 6d5f 706f 7274 732f 7461 736b  ustom_ports/task
+000119c0: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
+000119d0: 2020 2020 6627 756e 7469 6c20 534b 5950      f'until SKYP
+000119e0: 494c 4f54 5f44 4542 5547 3d30 2073 6b79  ILOT_DEBUG=0 sky
+000119f0: 2073 7461 7475 7320 2d2d 656e 6470 6f69   status --endpoi
+00011a00: 6e74 2033 3338 3238 207b 6e61 6d65 7d3b  nt 33828 {name};
+00011a10: 2064 6f20 736c 6565 7020 3130 3b20 646f   do sleep 10; do
+00011a20: 6e65 272c 0a20 2020 2020 2020 2020 2020  ne',.           
+00011a30: 2023 2052 6574 7279 2061 2066 6577 2074   # Retry a few t
+00011a40: 696d 6573 2074 6f20 6176 6f69 6420 666c  imes to avoid fl
+00011a50: 616b 696e 6573 7320 696e 2070 6f72 7473  akiness in ports
+00011a60: 2062 6569 6e67 206f 7065 6e2e 0a20 2020   being open..   
+00011a70: 2020 2020 2020 2020 2066 2769 703d 2428           f'ip=$(
+00011a80: 534b 5950 494c 4f54 5f44 4542 5547 3d30  SKYPILOT_DEBUG=0
+00011a90: 2073 6b79 2073 7461 7475 7320 2d2d 656e   sky status --en
+00011aa0: 6470 6f69 6e74 2033 3338 3238 207b 6e61  dpoint 33828 {na
+00011ab0: 6d65 7d29 3b20 7375 6363 6573 733d 6661  me}); success=fa
+00011ac0: 6c73 653b 2066 6f72 2069 2069 6e20 2428  lse; for i in $(
+00011ad0: 7365 7120 3120 3529 3b20 646f 2069 6620  seq 1 5); do if 
+00011ae0: 6375 726c 2024 6970 207c 2067 7265 7020  curl $ip | grep 
+00011af0: 223c 6831 3e54 6869 7320 6973 2061 2064  "<h1>This is a d
+00011b00: 656d 6f20 4854 4d4c 2070 6167 652e 3c2f  emo HTML page.</
+00011b10: 6831 3e22 3b20 7468 656e 2073 7563 6365  h1>"; then succe
+00011b20: 7373 3d74 7275 653b 2062 7265 616b 3b20  ss=true; break; 
+00011b30: 6669 3b20 736c 6565 7020 3130 3b20 646f  fi; sleep 10; do
+00011b40: 6e65 3b20 6966 205b 2022 2473 7563 6365  ne; if [ "$succe
+00011b50: 7373 2220 3d20 6661 6c73 6520 5d3b 2074  ss" = false ]; t
+00011b60: 6865 6e20 6578 6974 2031 3b20 6669 270a  hen exit 1; fi'.
+00011b70: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
+00011b80: 2020 2066 2773 6b79 2064 6f77 6e20 2d79     f'sky down -y
+00011b90: 207b 6e61 6d65 7d27 2c0a 2020 2020 290a   {name}',.    ).
+00011ba0: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
+00011bb0: 2874 6573 7429 0a0a 0a23 202d 2d2d 2d2d  (test)...# -----
+00011bc0: 2d2d 2d2d 2d20 5765 6220 6170 7073 2077  ----- Web apps w
+00011bd0: 6974 6820 6375 7374 6f6d 2070 6f72 7473  ith custom ports
+00011be0: 206f 6e20 4b75 6265 726e 6574 6573 2e20   on Kubernetes. 
+00011bf0: 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465  ----------.@pyte
+00011c00: 7374 2e6d 6172 6b2e 6b75 6265 726e 6574  st.mark.kubernet
+00011c10: 6573 0a64 6566 2074 6573 745f 6b75 6265  es.def test_kube
+00011c20: 726e 6574 6573 5f68 7474 705f 7365 7276  rnetes_http_serv
+00011c30: 6572 5f77 6974 685f 6375 7374 6f6d 5f70  er_with_custom_p
+00011c40: 6f72 7473 2829 3a0a 2020 2020 6e61 6d65  orts():.    name
+00011c50: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
+00011c60: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
+00011c70: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+00011c80: 276b 7562 6572 6e65 7465 735f 6874 7470  'kubernetes_http
+00011c90: 5f73 6572 7665 725f 7769 7468 5f63 7573  _server_with_cus
+00011ca0: 746f 6d5f 706f 7274 7327 2c0a 2020 2020  tom_ports',.    
+00011cb0: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
+00011cc0: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
+00011cd0: 7920 2d64 202d 6320 7b6e 616d 657d 202d  y -d -c {name} -
+00011ce0: 2d63 6c6f 7564 206b 7562 6572 6e65 7465  -cloud kubernete
+00011cf0: 7320 6578 616d 706c 6573 2f68 7474 705f  s examples/http_
+00011d00: 7365 7276 6572 5f77 6974 685f 6375 7374  server_with_cust
+00011d10: 6f6d 5f70 6f72 7473 2f74 6173 6b2e 7961  om_ports/task.ya
+00011d20: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
+00011d30: 2066 2775 6e74 696c 2053 4b59 5049 4c4f   f'until SKYPILO
+00011d40: 545f 4445 4255 473d 3020 736b 7920 7374  T_DEBUG=0 sky st
+00011d50: 6174 7573 202d 2d65 6e64 706f 696e 7420  atus --endpoint 
+00011d60: 3333 3832 3820 7b6e 616d 657d 3b20 646f  33828 {name}; do
+00011d70: 2073 6c65 6570 2031 303b 2064 6f6e 6527   sleep 10; done'
+00011d80: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
+00011d90: 5265 7472 7920 6120 6665 7720 7469 6d65  Retry a few time
+00011da0: 7320 746f 2061 766f 6964 2066 6c61 6b69  s to avoid flaki
+00011db0: 6e65 7373 2069 6e20 706f 7274 7320 6265  ness in ports be
+00011dc0: 696e 6720 6f70 656e 2e0a 2020 2020 2020  ing open..      
+00011dd0: 2020 2020 2020 6627 6970 3d24 2853 4b59        f'ip=$(SKY
+00011de0: 5049 4c4f 545f 4445 4255 473d 3020 736b  PILOT_DEBUG=0 sk
+00011df0: 7920 7374 6174 7573 202d 2d65 6e64 706f  y status --endpo
+00011e00: 696e 7420 3333 3832 3820 7b6e 616d 657d  int 33828 {name}
+00011e10: 293b 2073 7563 6365 7373 3d66 616c 7365  ); success=false
+00011e20: 3b20 666f 7220 6920 696e 2024 2873 6571  ; for i in $(seq
+00011e30: 2031 2031 3030 293b 2064 6f20 6966 2063   1 100); do if c
+00011e40: 7572 6c20 2469 7020 7c20 6772 6570 2022  url $ip | grep "
+00011e50: 3c68 313e 5468 6973 2069 7320 6120 6465  <h1>This is a de
+00011e60: 6d6f 2048 544d 4c20 7061 6765 2e3c 2f68  mo HTML page.</h
+00011e70: 313e 223b 2074 6865 6e20 7375 6363 6573  1>"; then succes
+00011e80: 733d 7472 7565 3b20 6272 6561 6b3b 2066  s=true; break; f
+00011e90: 693b 2073 6c65 6570 2035 3b20 646f 6e65  i; sleep 5; done
+00011ea0: 3b20 6966 205b 2022 2473 7563 6365 7373  ; if [ "$success
+00011eb0: 2220 3d20 6661 6c73 6520 5d3b 2074 6865  " = false ]; the
+00011ec0: 6e20 6578 6974 2031 3b20 6669 270a 2020  n exit 1; fi'.  
+00011ed0: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
+00011ee0: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
+00011ef0: 6e61 6d65 7d27 2c0a 2020 2020 290a 2020  name}',.    ).  
+00011f00: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+00011f10: 6573 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d  est)...# -------
+00011f20: 2d2d 2d20 5765 6220 6170 7073 2077 6974  --- Web apps wit
+00011f30: 6820 6375 7374 6f6d 2070 6f72 7473 206f  h custom ports o
+00011f40: 6e20 5061 7065 7273 7061 6365 2e20 2d2d  n Paperspace. --
+00011f50: 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465 7374  --------.@pytest
+00011f60: 2e6d 6172 6b2e 7061 7065 7273 7061 6365  .mark.paperspace
+00011f70: 0a64 6566 2074 6573 745f 7061 7065 7273  .def test_papers
+00011f80: 7061 6365 5f68 7474 705f 7365 7276 6572  pace_http_server
+00011f90: 5f77 6974 685f 6375 7374 6f6d 5f70 6f72  _with_custom_por
+00011fa0: 7473 2829 3a0a 2020 2020 6e61 6d65 203d  ts():.    name =
+00011fb0: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
+00011fc0: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
+00011fd0: 5465 7374 280a 2020 2020 2020 2020 2770  Test(.        'p
+00011fe0: 6170 6572 7370 6163 655f 6874 7470 5f73  aperspace_http_s
+00011ff0: 6572 7665 725f 7769 7468 5f63 7573 746f  erver_with_custo
+00012000: 6d5f 706f 7274 7327 2c0a 2020 2020 2020  m_ports',.      
+00012010: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
+00012020: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
+00012030: 2d64 202d 6320 7b6e 616d 657d 202d 2d63  -d -c {name} --c
+00012040: 6c6f 7564 2070 6170 6572 7370 6163 6520  loud paperspace 
+00012050: 6578 616d 706c 6573 2f68 7474 705f 7365  examples/http_se
+00012060: 7276 6572 5f77 6974 685f 6375 7374 6f6d  rver_with_custom
+00012070: 5f70 6f72 7473 2f74 6173 6b2e 7961 6d6c  _ports/task.yaml
+00012080: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00012090: 2775 6e74 696c 2053 4b59 5049 4c4f 545f  'until SKYPILOT_
+000120a0: 4445 4255 473d 3020 736b 7920 7374 6174  DEBUG=0 sky stat
+000120b0: 7573 202d 2d65 6e64 706f 696e 7420 3333  us --endpoint 33
+000120c0: 3832 3820 7b6e 616d 657d 3b20 646f 2073  828 {name}; do s
+000120d0: 6c65 6570 2031 303b 2064 6f6e 6527 2c0a  leep 10; done',.
+000120e0: 2020 2020 2020 2020 2020 2020 2320 5265              # Re
+000120f0: 7472 7920 6120 6665 7720 7469 6d65 7320  try a few times 
+00012100: 746f 2061 766f 6964 2066 6c61 6b69 6e65  to avoid flakine
+00012110: 7373 2069 6e20 706f 7274 7320 6265 696e  ss in ports bein
+00012120: 6720 6f70 656e 2e0a 2020 2020 2020 2020  g open..        
+00012130: 2020 2020 6627 6970 3d24 2853 4b59 5049      f'ip=$(SKYPI
+00012140: 4c4f 545f 4445 4255 473d 3020 736b 7920  LOT_DEBUG=0 sky 
+00012150: 7374 6174 7573 202d 2d65 6e64 706f 696e  status --endpoin
+00012160: 7420 3333 3832 3820 7b6e 616d 657d 293b  t 33828 {name});
+00012170: 2073 7563 6365 7373 3d66 616c 7365 3b20   success=false; 
+00012180: 666f 7220 6920 696e 2024 2873 6571 2031  for i in $(seq 1
+00012190: 2035 293b 2064 6f20 6966 2063 7572 6c20   5); do if curl 
+000121a0: 2469 7020 7c20 6772 6570 2022 3c68 313e  $ip | grep "<h1>
+000121b0: 5468 6973 2069 7320 6120 6465 6d6f 2048  This is a demo H
+000121c0: 544d 4c20 7061 6765 2e3c 2f68 313e 223b  TML page.</h1>";
+000121d0: 2074 6865 6e20 7375 6363 6573 733d 7472   then success=tr
+000121e0: 7565 3b20 6272 6561 6b3b 2066 693b 2073  ue; break; fi; s
+000121f0: 6c65 6570 2031 303b 2064 6f6e 653b 2069  leep 10; done; i
+00012200: 6620 5b20 2224 7375 6363 6573 7322 203d  f [ "$success" =
+00012210: 2066 616c 7365 205d 3b20 7468 656e 2065   false ]; then e
+00012220: 7869 7420 313b 2066 6927 2c0a 2020 2020  xit 1; fi',.    
+00012230: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
+00012240: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
+00012250: 6d65 7d27 2c0a 2020 2020 290a 2020 2020  me}',.    ).    
+00012260: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
+00012270: 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d  t)...# ---------
+00012280: 2d20 4c61 6265 6c73 2066 726f 6d20 7461  - Labels from ta
+00012290: 736b 206f 6e20 4157 5320 2869 6e73 7461  sk on AWS (insta
+000122a0: 6e63 655f 7461 6773 2920 2d2d 2d2d 2d2d  nce_tags) ------
+000122b0: 2d2d 2d2d 0a40 7079 7465 7374 2e6d 6172  ----.@pytest.mar
+000122c0: 6b2e 6177 730a 6465 6620 7465 7374 5f74  k.aws.def test_t
+000122d0: 6173 6b5f 6c61 6265 6c73 5f61 7773 2829  ask_labels_aws()
+000122e0: 3a0a 2020 2020 6e61 6d65 203d 205f 6765  :.    name = _ge
+000122f0: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
+00012300: 0a20 2020 2074 656d 706c 6174 655f 7374  .    template_st
+00012310: 7220 3d20 7061 7468 6c69 622e 5061 7468  r = pathlib.Path
+00012320: 280a 2020 2020 2020 2020 2774 6573 7473  (.        'tests
+00012330: 2f74 6573 745f 7961 6d6c 732f 7465 7374  /test_yamls/test
+00012340: 5f6c 6162 656c 732e 7961 6d6c 2e6a 3227  _labels.yaml.j2'
+00012350: 292e 7265 6164 5f74 6578 7428 290a 2020  ).read_text().  
+00012360: 2020 7465 6d70 6c61 7465 203d 206a 696e    template = jin
+00012370: 6a61 322e 5465 6d70 6c61 7465 2874 656d  ja2.Template(tem
+00012380: 706c 6174 655f 7374 7229 0a20 2020 2063  plate_str).    c
+00012390: 6f6e 7465 6e74 203d 2074 656d 706c 6174  ontent = templat
+000123a0: 652e 7265 6e64 6572 2863 6c6f 7564 3d27  e.render(cloud='
+000123b0: 6177 7327 2c20 7265 6769 6f6e 3d27 7573  aws', region='us
+000123c0: 2d65 6173 742d 3127 290a 2020 2020 7769  -east-1').    wi
+000123d0: 7468 2074 656d 7066 696c 652e 4e61 6d65  th tempfile.Name
+000123e0: 6454 656d 706f 7261 7279 4669 6c65 2873  dTemporaryFile(s
+000123f0: 7566 6669 783d 272e 7961 6d6c 272c 206d  uffix='.yaml', m
+00012400: 6f64 653d 2777 2729 2061 7320 663a 0a20  ode='w') as f:. 
+00012410: 2020 2020 2020 2066 2e77 7269 7465 2863         f.write(c
+00012420: 6f6e 7465 6e74 290a 2020 2020 2020 2020  ontent).        
+00012430: 662e 666c 7573 6828 290a 2020 2020 2020  f.flush().      
+00012440: 2020 6669 6c65 5f70 6174 6820 3d20 662e    file_path = f.
+00012450: 6e61 6d65 0a20 2020 2020 2020 2074 6573  name.        tes
+00012460: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
+00012470: 2020 2020 2020 2774 6173 6b5f 6c61 6265        'task_labe
+00012480: 6c73 5f61 7773 272c 0a20 2020 2020 2020  ls_aws',.       
+00012490: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
+000124a0: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
+000124b0: 6e63 6820 2d79 202d 6320 7b6e 616d 657d  nch -y -c {name}
+000124c0: 207b 6669 6c65 5f70 6174 687d 272c 0a20   {file_path}',. 
+000124d0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+000124e0: 2056 6572 6966 7920 7769 7468 2061 7773   Verify with aws
+000124f0: 2063 6c69 2074 6861 7420 7468 6520 7461   cli that the ta
+00012500: 6773 2061 7265 2073 6574 2e0a 2020 2020  gs are set..    
+00012510: 2020 2020 2020 2020 2020 2020 2761 7773              'aws
+00012520: 2065 6332 2064 6573 6372 6962 652d 696e   ec2 describe-in
+00012530: 7374 616e 6365 7320 270a 2020 2020 2020  stances '.      
+00012540: 2020 2020 2020 2020 2020 272d 2d71 7565            '--que
+00012550: 7279 2022 5265 7365 7276 6174 696f 6e73  ry "Reservations
+00012560: 5b2a 5d2e 496e 7374 616e 6365 735b 2a5d  [*].Instances[*]
+00012570: 2e49 6e73 7461 6e63 6549 6422 2027 0a20  .InstanceId" '. 
+00012580: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00012590: 2d2d 6669 6c74 6572 7320 224e 616d 653d  --filters "Name=
+000125a0: 696e 7374 616e 6365 2d73 7461 7465 2d6e  instance-state-n
+000125b0: 616d 652c 5661 6c75 6573 3d72 756e 6e69  ame,Values=runni
+000125c0: 6e67 2220 270a 2020 2020 2020 2020 2020  ng" '.          
+000125d0: 2020 2020 2020 6627 2d2d 6669 6c74 6572        f'--filter
+000125e0: 7320 224e 616d 653d 7461 673a 736b 7970  s "Name=tag:skyp
+000125f0: 696c 6f74 2d63 6c75 7374 6572 2d6e 616d  ilot-cluster-nam
+00012600: 652c 5661 6c75 6573 3d7b 6e61 6d65 7d2a  e,Values={name}*
+00012610: 2220 270a 2020 2020 2020 2020 2020 2020  " '.            
+00012620: 2020 2020 272d 2d66 696c 7465 7273 2022      '--filters "
+00012630: 4e61 6d65 3d74 6167 3a69 6e6c 696e 656c  Name=tag:inlinel
+00012640: 6162 656c 312c 5661 6c75 6573 3d69 6e6c  abel1,Values=inl
+00012650: 696e 6576 616c 7565 3122 2027 0a20 2020  inevalue1" '.   
+00012660: 2020 2020 2020 2020 2020 2020 2027 2d2d               '--
+00012670: 6669 6c74 6572 7320 224e 616d 653d 7461  filters "Name=ta
+00012680: 673a 696e 6c69 6e65 6c61 6265 6c32 2c56  g:inlinelabel2,V
+00012690: 616c 7565 733d 696e 6c69 6e65 7661 6c75  alues=inlinevalu
+000126a0: 6532 2220 270a 2020 2020 2020 2020 2020  e2" '.          
+000126b0: 2020 2020 2020 272d 2d72 6567 696f 6e20        '--region 
+000126c0: 7573 2d65 6173 742d 3120 2d2d 6f75 7470  us-east-1 --outp
+000126d0: 7574 2074 6578 7427 2c0a 2020 2020 2020  ut text',.      
+000126e0: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
+000126f0: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
+00012700: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
+00012710: 2020 2020 290a 2020 2020 2020 2020 7275      ).        ru
+00012720: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
+00012730: 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20  ...# ---------- 
+00012740: 4c61 6265 6c73 2066 726f 6d20 7461 736b  Labels from task
+00012750: 206f 6e20 4743 5020 286c 6162 656c 7329   on GCP (labels)
+00012760: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974   ----------.@pyt
+00012770: 6573 742e 6d61 726b 2e67 6370 0a64 6566  est.mark.gcp.def
+00012780: 2074 6573 745f 7461 736b 5f6c 6162 656c   test_task_label
+00012790: 735f 6763 7028 293a 0a20 2020 206e 616d  s_gcp():.    nam
+000127a0: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
+000127b0: 5f6e 616d 6528 290a 2020 2020 7465 6d70  _name().    temp
+000127c0: 6c61 7465 5f73 7472 203d 2070 6174 686c  late_str = pathl
+000127d0: 6962 2e50 6174 6828 0a20 2020 2020 2020  ib.Path(.       
+000127e0: 2027 7465 7374 732f 7465 7374 5f79 616d   'tests/test_yam
+000127f0: 6c73 2f74 6573 745f 6c61 6265 6c73 2e79  ls/test_labels.y
+00012800: 616d 6c2e 6a32 2729 2e72 6561 645f 7465  aml.j2').read_te
+00012810: 7874 2829 0a20 2020 2074 656d 706c 6174  xt().    templat
+00012820: 6520 3d20 6a69 6e6a 6132 2e54 656d 706c  e = jinja2.Templ
+00012830: 6174 6528 7465 6d70 6c61 7465 5f73 7472  ate(template_str
+00012840: 290a 2020 2020 636f 6e74 656e 7420 3d20  ).    content = 
+00012850: 7465 6d70 6c61 7465 2e72 656e 6465 7228  template.render(
+00012860: 636c 6f75 643d 2767 6370 2729 0a20 2020  cloud='gcp').   
+00012870: 2077 6974 6820 7465 6d70 6669 6c65 2e4e   with tempfile.N
+00012880: 616d 6564 5465 6d70 6f72 6172 7946 696c  amedTemporaryFil
+00012890: 6528 7375 6666 6978 3d27 2e79 616d 6c27  e(suffix='.yaml'
+000128a0: 2c20 6d6f 6465 3d27 7727 2920 6173 2066  , mode='w') as f
+000128b0: 3a0a 2020 2020 2020 2020 662e 7772 6974  :.        f.writ
+000128c0: 6528 636f 6e74 656e 7429 0a20 2020 2020  e(content).     
+000128d0: 2020 2066 2e66 6c75 7368 2829 0a20 2020     f.flush().   
+000128e0: 2020 2020 2066 696c 655f 7061 7468 203d       file_path =
+000128f0: 2066 2e6e 616d 650a 2020 2020 2020 2020   f.name.        
+00012900: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
+00012910: 2020 2020 2020 2020 2027 7461 736b 5f6c           'task_l
+00012920: 6162 656c 735f 6763 7027 2c0a 2020 2020  abels_gcp',.    
+00012930: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
+00012940: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00012950: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
+00012960: 6d65 7d20 7b66 696c 655f 7061 7468 7d27  me} {file_path}'
+00012970: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00012980: 2020 2320 5665 7269 6679 2077 6974 6820    # Verify with 
+00012990: 6763 6c6f 7564 2063 6c69 2074 6861 7420  gcloud cli that 
+000129a0: 7468 6520 7461 6773 2061 7265 2073 6574  the tags are set
+000129b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000129c0: 2066 2767 636c 6f75 6420 636f 6d70 7574   f'gcloud comput
+000129d0: 6520 696e 7374 616e 6365 7320 6c69 7374  e instances list
+000129e0: 202d 2d66 696c 7465 723d 226e 616d 657e   --filter="name~
+000129f0: 5c27 5e7b 6e61 6d65 7d5c 2720 414e 4420  \'^{name}\' AND 
+00012a00: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+00012a10: 2020 276c 6162 656c 732e 696e 6c69 6e65    'labels.inline
+00012a20: 6c61 6265 6c31 3d5c 2769 6e6c 696e 6576  label1=\'inlinev
+00012a30: 616c 7565 315c 2720 414e 4420 270a 2020  alue1\' AND '.  
+00012a40: 2020 2020 2020 2020 2020 2020 2020 276c                'l
+00012a50: 6162 656c 732e 696e 6c69 6e65 6c61 6265  abels.inlinelabe
+00012a60: 6c32 3d5c 2769 6e6c 696e 6576 616c 7565  l2=\'inlinevalue
+00012a70: 325c 2722 2027 0a20 2020 2020 2020 2020  2\'" '.         
+00012a80: 2020 2020 2020 2027 2d2d 666f 726d 6174         '--format
+00012a90: 3d22 7661 6c75 6528 6e61 6d65 2922 207c  ="value(name)" |
+00012aa0: 2067 7265 7020 2e27 2c0a 2020 2020 2020   grep .',.      
+00012ab0: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
+00012ac0: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
+00012ad0: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
+00012ae0: 2020 2020 290a 2020 2020 2020 2020 7275      ).        ru
+00012af0: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
+00012b00: 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20  ...# ---------- 
+00012b10: 4c61 6265 6c73 2066 726f 6d20 7461 736b  Labels from task
+00012b20: 206f 6e20 4b75 6265 726e 6574 6573 2028   on Kubernetes (
+00012b30: 6c61 6265 6c73 2920 2d2d 2d2d 2d2d 2d2d  labels) --------
+00012b40: 2d2d 0a40 7079 7465 7374 2e6d 6172 6b2e  --.@pytest.mark.
+00012b50: 6b75 6265 726e 6574 6573 0a64 6566 2074  kubernetes.def t
+00012b60: 6573 745f 7461 736b 5f6c 6162 656c 735f  est_task_labels_
+00012b70: 6b75 6265 726e 6574 6573 2829 3a0a 2020  kubernetes():.  
+00012b80: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
+00012b90: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
+00012ba0: 2074 656d 706c 6174 655f 7374 7220 3d20   template_str = 
+00012bb0: 7061 7468 6c69 622e 5061 7468 280a 2020  pathlib.Path(.  
+00012bc0: 2020 2020 2020 2774 6573 7473 2f74 6573        'tests/tes
+00012bd0: 745f 7961 6d6c 732f 7465 7374 5f6c 6162  t_yamls/test_lab
+00012be0: 656c 732e 7961 6d6c 2e6a 3227 292e 7265  els.yaml.j2').re
+00012bf0: 6164 5f74 6578 7428 290a 2020 2020 7465  ad_text().    te
+00012c00: 6d70 6c61 7465 203d 206a 696e 6a61 322e  mplate = jinja2.
+00012c10: 5465 6d70 6c61 7465 2874 656d 706c 6174  Template(templat
+00012c20: 655f 7374 7229 0a20 2020 2063 6f6e 7465  e_str).    conte
+00012c30: 6e74 203d 2074 656d 706c 6174 652e 7265  nt = template.re
+00012c40: 6e64 6572 2863 6c6f 7564 3d27 6b75 6265  nder(cloud='kube
+00012c50: 726e 6574 6573 2729 0a20 2020 2077 6974  rnetes').    wit
+00012c60: 6820 7465 6d70 6669 6c65 2e4e 616d 6564  h tempfile.Named
+00012c70: 5465 6d70 6f72 6172 7946 696c 6528 7375  TemporaryFile(su
+00012c80: 6666 6978 3d27 2e79 616d 6c27 2c20 6d6f  ffix='.yaml', mo
+00012c90: 6465 3d27 7727 2920 6173 2066 3a0a 2020  de='w') as f:.  
+00012ca0: 2020 2020 2020 662e 7772 6974 6528 636f        f.write(co
+00012cb0: 6e74 656e 7429 0a20 2020 2020 2020 2066  ntent).        f
+00012cc0: 2e66 6c75 7368 2829 0a20 2020 2020 2020  .flush().       
+00012cd0: 2066 696c 655f 7061 7468 203d 2066 2e6e   file_path = f.n
+00012ce0: 616d 650a 2020 2020 2020 2020 7465 7374  ame.        test
+00012cf0: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
+00012d00: 2020 2020 2027 7461 736b 5f6c 6162 656c       'task_label
+00012d10: 735f 6b75 6265 726e 6574 6573 272c 0a20  s_kubernetes',. 
+00012d20: 2020 2020 2020 2020 2020 205b 0a20 2020             [.   
+00012d30: 2020 2020 2020 2020 2020 2020 2066 2773               f's
+00012d40: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
+00012d50: 7b6e 616d 657d 207b 6669 6c65 5f70 6174  {name} {file_pat
+00012d60: 687d 272c 0a20 2020 2020 2020 2020 2020  h}',.           
+00012d70: 2020 2020 2023 2056 6572 6966 7920 7769       # Verify wi
+00012d80: 7468 206b 7562 6563 746c 2074 6861 7420  th kubectl that 
+00012d90: 7468 6520 6c61 6265 6c73 2061 7265 2073  the labels are s
+00012da0: 6574 2e0a 2020 2020 2020 2020 2020 2020  et..            
+00012db0: 2020 2020 276b 7562 6563 746c 2067 6574      'kubectl get
+00012dc0: 2070 6f64 7320 270a 2020 2020 2020 2020   pods '.        
+00012dd0: 2020 2020 2020 2020 272d 2d73 656c 6563          '--selec
+00012de0: 746f 7220 696e 6c69 6e65 6c61 6265 6c31  tor inlinelabel1
+00012df0: 3d69 6e6c 696e 6576 616c 7565 3120 270a  =inlinevalue1 '.
+00012e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012e10: 272d 2d73 656c 6563 746f 7220 696e 6c69  '--selector inli
+00012e20: 6e65 6c61 6265 6c32 3d69 6e6c 696e 6576  nelabel2=inlinev
+00012e30: 616c 7565 3220 270a 2020 2020 2020 2020  alue2 '.        
+00012e40: 2020 2020 2020 2020 272d 6f20 6a73 6f6e          '-o json
+00012e50: 7061 7468 3d5c 277b 2e69 7465 6d73 5b2a  path=\'{.items[*
+00012e60: 5d2e 6d65 7461 6461 7461 2e6e 616d 657d  ].metadata.name}
+00012e70: 5c27 207c 2027 0a20 2020 2020 2020 2020  \' | '.         
+00012e80: 2020 2020 2020 2066 2767 7265 7020 5c27         f'grep \'
+00012e90: 5e7b 6e61 6d65 7d5c 2727 0a20 2020 2020  ^{name}\''.     
+00012ea0: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
+00012eb0: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
+00012ec0: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
+00012ed0: 2020 2020 2029 0a20 2020 2020 2020 2072       ).        r
+00012ee0: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
+00012ef0: 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d  )...# ----------
+00012f00: 2054 6173 6b3a 206e 3d32 206e 6f64 6573   Task: n=2 nodes
+00012f10: 2077 6974 6820 7365 7475 7073 2e20 2d2d   with setups. --
+00012f20: 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465 7374  --------.@pytest
+00012f30: 2e6d 6172 6b2e 6e6f 5f6c 616d 6264 615f  .mark.no_lambda_
+00012f40: 636c 6f75 6420 2023 204c 616d 6264 6120  cloud  # Lambda 
+00012f50: 436c 6f75 6420 646f 6573 206e 6f74 2068  Cloud does not h
+00012f60: 6176 6520 5631 3030 2067 7075 730a 4070  ave V100 gpus.@p
+00012f70: 7974 6573 742e 6d61 726b 2e6e 6f5f 6962  ytest.mark.no_ib
+00012f80: 6d20 2023 2049 424d 2063 6c6f 7564 2063  m  # IBM cloud c
+00012f90: 7572 7265 6e74 6c79 2064 6f65 736e 2774  urrently doesn't
+00012fa0: 2070 726f 7669 6465 2070 7562 6c69 6320   provide public 
+00012fb0: 696d 6167 6520 7769 7468 2043 5544 410a  image with CUDA.
+00012fc0: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+00012fd0: 7363 7020 2023 2053 4350 2064 6f65 7320  scp  # SCP does 
+00012fe0: 6e6f 7420 7375 7070 6f72 7420 6e75 6d5f  not support num_
+00012ff0: 6e6f 6465 7320 3e20 3120 7965 740a 4070  nodes > 1 yet.@p
+00013000: 7974 6573 742e 6d61 726b 2e73 6b69 7028  ytest.mark.skip(
+00013010: 0a20 2020 2072 6561 736f 6e3d 0a20 2020  .    reason=.   
+00013020: 2027 5468 6520 7265 736e 6574 5f64 6973   'The resnet_dis
+00013030: 7472 6962 7574 6564 5f74 665f 6170 7020  tributed_tf_app 
+00013040: 6973 2066 6c61 6b79 2c20 6475 6520 746f  is flaky, due to
+00013050: 2069 7420 6661 696c 696e 6720 746f 2064   it failing to d
+00013060: 6574 6563 7420 4750 5573 2e27 290a 6465  etect GPUs.').de
+00013070: 6620 7465 7374 5f64 6973 7472 6962 7574  f test_distribut
+00013080: 6564 5f74 6628 6765 6e65 7269 635f 636c  ed_tf(generic_cl
+00013090: 6f75 643a 2073 7472 293a 0a20 2020 206e  oud: str):.    n
+000130a0: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
+000130b0: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
+000130c0: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+000130d0: 2020 2027 7265 736e 6574 5f64 6973 7472     'resnet_distr
+000130e0: 6962 7574 6564 5f74 665f 6170 7027 2c0a  ibuted_tf_app',.
+000130f0: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
+00013100: 2020 2020 2020 2320 4e4f 5445 3a20 7275        # NOTE: ru
+00013110: 6e6e 696e 6720 6974 2074 7769 6365 2077  nning it twice w
+00013120: 696c 6c20 6861 6e67 2028 736f 6d65 7469  ill hang (someti
+00013130: 6d65 733f 2920 2d20 616e 2061 7070 2d6c  mes?) - an app-l
+00013140: 6576 656c 2062 7567 2e0a 2020 2020 2020  evel bug..      
+00013150: 2020 2020 2020 6627 7079 7468 6f6e 2065        f'python e
+00013160: 7861 6d70 6c65 732f 7265 736e 6574 5f64  xamples/resnet_d
+00013170: 6973 7472 6962 7574 6564 5f74 665f 6170  istributed_tf_ap
+00013180: 702e 7079 207b 6e61 6d65 7d20 7b67 656e  p.py {name} {gen
+00013190: 6572 6963 5f63 6c6f 7564 7d27 2c0a 2020  eric_cloud}',.  
+000131a0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+000131b0: 6c6f 6773 207b 6e61 6d65 7d20 3120 2d2d  logs {name} 1 --
+000131c0: 7374 6174 7573 272c 2020 2320 456e 7375  status',  # Ensu
+000131d0: 7265 2074 6865 206a 6f62 2073 7563 6365  re the job succe
+000131e0: 6564 6564 2e0a 2020 2020 2020 2020 5d2c  eded..        ],
+000131f0: 0a20 2020 2020 2020 2066 2773 6b79 2064  .        f'sky d
+00013200: 6f77 6e20 2d79 207b 6e61 6d65 7d27 2c0a  own -y {name}',.
+00013210: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
+00013220: 3235 202a 2036 302c 2020 2320 3235 206d  25 * 60,  # 25 m
+00013230: 696e 7320 2869 7420 7461 6b65 7320 6172  ins (it takes ar
+00013240: 6f75 6e64 207e 3139 206d 696e 7329 0a20  ound ~19 mins). 
+00013250: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
+00013260: 5f74 6573 7428 7465 7374 290a 0a0a 2320  _test(test)...# 
+00013270: 2d2d 2d2d 2d2d 2d2d 2d2d 2054 6573 7469  ---------- Testi
+00013280: 6e67 2047 4350 2073 7461 7274 2061 6e64  ng GCP start and
+00013290: 2073 746f 7020 696e 7374 616e 6365 7320   stop instances 
+000132a0: 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465  ----------.@pyte
+000132b0: 7374 2e6d 6172 6b2e 6763 700a 6465 6620  st.mark.gcp.def 
+000132c0: 7465 7374 5f67 6370 5f73 7461 7274 5f73  test_gcp_start_s
+000132d0: 746f 7028 293a 0a20 2020 206e 616d 6520  top():.    name 
+000132e0: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
+000132f0: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
+00013300: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
+00013310: 6763 702d 7374 6172 742d 7374 6f70 272c  gcp-start-stop',
+00013320: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
+00013330: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
+00013340: 6e63 6820 2d79 202d 6320 7b6e 616d 657d  nch -y -c {name}
+00013350: 2065 7861 6d70 6c65 732f 6763 705f 7374   examples/gcp_st
+00013360: 6172 745f 7374 6f70 2e79 616d 6c27 2c0a  art_stop.yaml',.
+00013370: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00013380: 7920 6c6f 6773 207b 6e61 6d65 7d20 3120  y logs {name} 1 
+00013390: 2d2d 7374 6174 7573 272c 2020 2320 456e  --status',  # En
+000133a0: 7375 7265 2074 6865 206a 6f62 2073 7563  sure the job suc
+000133b0: 6365 6564 6564 2e0a 2020 2020 2020 2020  ceeded..        
+000133c0: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
+000133d0: 6e61 6d65 7d20 6578 616d 706c 6573 2f67  name} examples/g
+000133e0: 6370 5f73 7461 7274 5f73 746f 702e 7961  cp_start_stop.ya
+000133f0: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
+00013400: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
+00013410: 657d 2032 202d 2d73 7461 7475 7327 2c20  e} 2 --status', 
+00013420: 2023 2045 6e73 7572 6520 7468 6520 6a6f   # Ensure the jo
+00013430: 6220 7375 6363 6565 6465 642e 0a20 2020  b succeeded..   
+00013440: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
+00013450: 7865 6320 7b6e 616d 657d 2022 7072 6c69  xec {name} "prli
+00013460: 6d69 7420 2d6e 202d 2d70 6964 3d5c 2428  mit -n --pid=\$(
+00013470: 7067 7265 7020 2d66 205c 2772 6179 6c65  pgrep -f \'rayle
+00013480: 742f 7261 796c 6574 202d 2d72 6179 6c65  t/raylet --rayle
+00013490: 745f 736f 636b 6574 5f6e 616d 655c 2729  t_socket_name\')
+000134a0: 207c 2067 7265 7020 5c27 225c 2731 3034   | grep \'"\'104
+000134b0: 3835 3736 2031 3034 3835 3736 5c27 225c  8576 1048576\'"\
+000134c0: 2722 272c 2020 2320 456e 7375 7265 2074  '"',  # Ensure t
+000134d0: 6865 2072 6179 6c65 7420 7072 6f63 6573  he raylet proces
+000134e0: 7320 6861 7320 7468 6520 636f 7272 6563  s has the correc
+000134f0: 7420 6669 6c65 2064 6573 6372 6970 746f  t file descripto
+00013500: 7220 6c69 6d69 742e 0a20 2020 2020 2020  r limit..       
+00013510: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+00013520: 7b6e 616d 657d 2033 202d 2d73 7461 7475  {name} 3 --statu
+00013530: 7327 2c20 2023 2045 6e73 7572 6520 7468  s',  # Ensure th
+00013540: 6520 6a6f 6220 7375 6363 6565 6465 642e  e job succeeded.
+00013550: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00013560: 6b79 2073 746f 7020 2d79 207b 6e61 6d65  ky stop -y {name
+00013570: 7d27 2c0a 2020 2020 2020 2020 2020 2020  }',.            
+00013580: 6627 736c 6565 7020 3230 272c 0a20 2020  f'sleep 20',.   
+00013590: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
+000135a0: 7461 7274 202d 7920 7b6e 616d 657d 202d  tart -y {name} -
+000135b0: 6920 3127 2c0a 2020 2020 2020 2020 2020  i 1',.          
+000135c0: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
+000135d0: 6d65 7d20 6578 616d 706c 6573 2f67 6370  me} examples/gcp
+000135e0: 5f73 7461 7274 5f73 746f 702e 7961 6d6c  _start_stop.yaml
+000135f0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00013600: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
+00013610: 2034 202d 2d73 7461 7475 7327 2c20 2023   4 --status',  #
+00013620: 2045 6e73 7572 6520 7468 6520 6a6f 6220   Ensure the job 
+00013630: 7375 6363 6565 6465 642e 0a20 2020 2020  succeeded..     
+00013640: 2020 2020 2020 2027 736c 6565 7020 3138         'sleep 18
+00013650: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
+00013660: 6627 736b 7920 7374 6174 7573 202d 7220  f'sky status -r 
+00013670: 7b6e 616d 657d 207c 2067 7265 7020 2249  {name} | grep "I
+00013680: 4e49 545c 7c53 544f 5050 4544 2227 2c0a  NIT\|STOPPED"',.
+00013690: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
+000136a0: 2020 2066 2773 6b79 2064 6f77 6e20 2d79     f'sky down -y
+000136b0: 207b 6e61 6d65 7d27 2c0a 2020 2020 290a   {name}',.    ).
+000136c0: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
+000136d0: 2874 6573 7429 0a0a 0a23 202d 2d2d 2d2d  (test)...# -----
+000136e0: 2d2d 2d2d 2d20 5465 7374 696e 6720 417a  ----- Testing Az
+000136f0: 7572 6520 7374 6172 7420 616e 6420 7374  ure start and st
+00013700: 6f70 2069 6e73 7461 6e63 6573 202d 2d2d  op instances ---
+00013710: 2d2d 2d2d 2d2d 2d0a 4070 7974 6573 742e  -------.@pytest.
+00013720: 6d61 726b 2e61 7a75 7265 0a64 6566 2074  mark.azure.def t
+00013730: 6573 745f 617a 7572 655f 7374 6172 745f  est_azure_start_
+00013740: 7374 6f70 2829 3a0a 2020 2020 6e61 6d65  stop():.    name
+00013750: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
+00013760: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
+00013770: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+00013780: 2761 7a75 7265 2d73 7461 7274 2d73 746f  'azure-start-sto
+00013790: 7027 2c0a 2020 2020 2020 2020 5b0a 2020  p',.        [.  
+000137a0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+000137b0: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
+000137c0: 6d65 7d20 6578 616d 706c 6573 2f61 7a75  me} examples/azu
+000137d0: 7265 5f73 7461 7274 5f73 746f 702e 7961  re_start_stop.ya
+000137e0: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
+000137f0: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
+00013800: 657d 2065 7861 6d70 6c65 732f 617a 7572  e} examples/azur
+00013810: 655f 7374 6172 745f 7374 6f70 2e79 616d  e_start_stop.yam
+00013820: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+00013830: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+00013840: 7d20 3120 2d2d 7374 6174 7573 272c 2020  } 1 --status',  
+00013850: 2320 456e 7375 7265 2074 6865 206a 6f62  # Ensure the job
+00013860: 2073 7563 6365 6564 6564 2e0a 2020 2020   succeeded..    
+00013870: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
+00013880: 6563 207b 6e61 6d65 7d20 2270 726c 696d  ec {name} "prlim
+00013890: 6974 202d 6e20 2d2d 7069 643d 5c24 2870  it -n --pid=\$(p
+000138a0: 6772 6570 202d 6620 5c27 7261 796c 6574  grep -f \'raylet
+000138b0: 2f72 6179 6c65 7420 2d2d 7261 796c 6574  /raylet --raylet
+000138c0: 5f73 6f63 6b65 745f 6e61 6d65 5c27 2920  _socket_name\') 
+000138d0: 7c20 6772 6570 205c 2722 5c27 3130 3438  | grep \'"\'1048
+000138e0: 3537 3620 3130 3438 3537 365c 2722 5c27  576 1048576\'"\'
+000138f0: 2227 2c20 2023 2045 6e73 7572 6520 7468  "',  # Ensure th
+00013900: 6520 7261 796c 6574 2070 726f 6365 7373  e raylet process
+00013910: 2068 6173 2074 6865 2063 6f72 7265 6374   has the correct
+00013920: 2066 696c 6520 6465 7363 7269 7074 6f72   file descriptor
+00013930: 206c 696d 6974 2e0a 2020 2020 2020 2020   limit..        
+00013940: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
+00013950: 6e61 6d65 7d20 3220 2d2d 7374 6174 7573  name} 2 --status
+00013960: 272c 2020 2320 456e 7375 7265 2074 6865  ',  # Ensure the
+00013970: 206a 6f62 2073 7563 6365 6564 6564 2e0a   job succeeded..
+00013980: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00013990: 7920 7374 6f70 202d 7920 7b6e 616d 657d  y stop -y {name}
+000139a0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+000139b0: 2773 6b79 2073 7461 7274 202d 7920 7b6e  'sky start -y {n
+000139c0: 616d 657d 202d 6920 3127 2c0a 2020 2020  ame} -i 1',.    
+000139d0: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
+000139e0: 6563 207b 6e61 6d65 7d20 6578 616d 706c  ec {name} exampl
+000139f0: 6573 2f61 7a75 7265 5f73 7461 7274 5f73  es/azure_start_s
+00013a00: 746f 702e 7961 6d6c 272c 0a20 2020 2020  top.yaml',.     
+00013a10: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+00013a20: 7320 7b6e 616d 657d 2033 202d 2d73 7461  s {name} 3 --sta
+00013a30: 7475 7327 2c20 2023 2045 6e73 7572 6520  tus',  # Ensure 
+00013a40: 7468 6520 6a6f 6220 7375 6363 6565 6465  the job succeede
+00013a50: 642e 0a20 2020 2020 2020 2020 2020 2027  d..            '
+00013a60: 736c 6565 7020 3230 3027 2c0a 2020 2020  sleep 200',.    
+00013a70: 2020 2020 2020 2020 6627 733d 2428 736b          f's=$(sk
+00013a80: 7920 7374 6174 7573 202d 7220 7b6e 616d  y status -r {nam
+00013a90: 657d 2920 2626 2065 6368 6f20 2224 7322  e}) && echo "$s"
+00013aa0: 2026 2620 6563 686f 2022 2473 2220 7c20   && echo "$s" | 
+00013ab0: 6772 6570 2022 494e 4954 5c7c 5354 4f50  grep "INIT\|STOP
+00013ac0: 5045 4422 270a 2020 2020 2020 2020 5d2c  PED"'.        ],
+00013ad0: 0a20 2020 2020 2020 2066 2773 6b79 2064  .        f'sky d
+00013ae0: 6f77 6e20 2d79 207b 6e61 6d65 7d27 2c0a  own -y {name}',.
+00013af0: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
+00013b00: 3330 202a 2036 302c 2020 2320 3330 206d  30 * 60,  # 30 m
+00013b10: 696e 730a 2020 2020 290a 2020 2020 7275  ins.    ).    ru
+00013b20: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
+00013b30: 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20  ...# ---------- 
+00013b40: 5465 7374 696e 6720 4175 746f 7374 6f70  Testing Autostop
+00013b50: 7069 6e67 202d 2d2d 2d2d 2d2d 2d2d 2d0a  ping ----------.
+00013b60: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+00013b70: 666c 7569 6473 7461 636b 2020 2320 466c  fluidstack  # Fl
+00013b80: 7569 6453 7461 636b 2064 6f65 7320 6e6f  uidStack does no
+00013b90: 7420 7375 7070 6f72 7420 7374 6f70 7069  t support stoppi
+00013ba0: 6e67 2069 6e20 536b 7950 696c 6f74 2069  ng in SkyPilot i
+00013bb0: 6d70 6c65 6d65 6e74 6174 696f 6e0a 4070  mplementation.@p
+00013bc0: 7974 6573 742e 6d61 726b 2e6e 6f5f 6c61  ytest.mark.no_la
+00013bd0: 6d62 6461 5f63 6c6f 7564 2020 2320 4c61  mbda_cloud  # La
+00013be0: 6d62 6461 2043 6c6f 7564 2064 6f65 7320  mbda Cloud does 
+00013bf0: 6e6f 7420 7375 7070 6f72 7420 7374 6f70  not support stop
+00013c00: 7069 6e67 2069 6e73 7461 6e63 6573 0a40  ping instances.@
+00013c10: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f69  pytest.mark.no_i
+00013c20: 626d 2020 2320 4649 5828 4942 4d29 2073  bm  # FIX(IBM) s
+00013c30: 706f 7261 6469 6361 6c6c 7920 6661 696c  poradically fail
+00013c40: 732c 2061 7320 7265 7374 6172 7465 6420  s, as restarted 
+00013c50: 776f 726b 6572 7320 7374 6179 2075 6e69  workers stay uni
+00013c60: 6e69 7469 616c 697a 6564 2069 6e64 6566  nitialized indef
+00013c70: 696e 6974 656c 790a 4070 7974 6573 742e  initely.@pytest.
+00013c80: 6d61 726b 2e6e 6f5f 7363 7020 2023 2053  mark.no_scp  # S
+00013c90: 4350 2064 6f65 7320 6e6f 7420 7375 7070  CP does not supp
+00013ca0: 6f72 7420 6e75 6d5f 6e6f 6465 7320 3e20  ort num_nodes > 
+00013cb0: 3120 7965 740a 4070 7974 6573 742e 6d61  1 yet.@pytest.ma
+00013cc0: 726b 2e6e 6f5f 6b75 6265 726e 6574 6573  rk.no_kubernetes
+00013cd0: 2020 2320 4b75 6265 726e 6574 6573 2064    # Kubernetes d
+00013ce0: 6f65 7320 6e6f 7420 6175 746f 7374 6f70  oes not autostop
+00013cf0: 2079 6574 0a64 6566 2074 6573 745f 6175   yet.def test_au
+00013d00: 746f 7374 6f70 2867 656e 6572 6963 5f63  tostop(generic_c
+00013d10: 6c6f 7564 3a20 7374 7229 3a0a 2020 2020  loud: str):.    
+00013d20: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
+00013d30: 7465 725f 6e61 6d65 2829 0a20 2020 2023  ter_name().    #
+00013d40: 2041 7a75 7265 2074 616b 6573 207e 2037   Azure takes ~ 7
+00013d50: 6d31 3573 2028 3433 3573 2920 746f 2061  m15s (435s) to a
+00013d60: 7574 6f73 746f 7020 6120 564d 2c20 736f  utostop a VM, so
+00013d70: 2068 6572 6520 7765 2075 7365 2036 3030   here we use 600
+00013d80: 2074 6f20 656e 7375 7265 0a20 2020 2023   to ensure.    #
+00013d90: 2074 6865 2056 4d20 6973 2073 746f 7070   the VM is stopp
+00013da0: 6564 2e0a 2020 2020 6175 746f 7374 6f70  ed..    autostop
+00013db0: 5f74 696d 656f 7574 203d 2036 3030 2069  _timeout = 600 i
+00013dc0: 6620 6765 6e65 7269 635f 636c 6f75 6420  f generic_cloud 
+00013dd0: 3d3d 2027 617a 7572 6527 2065 6c73 6520  == 'azure' else 
+00013de0: 3235 300a 2020 2020 2320 4c61 756e 6368  250.    # Launch
+00013df0: 696e 6720 616e 6420 7374 6172 7469 6e67  ing and starting
+00013e00: 2041 7a75 7265 2063 6c75 7374 6572 7320   Azure clusters 
+00013e10: 6361 6e20 7461 6b65 2061 206c 6f6e 6720  can take a long 
+00013e20: 7469 6d65 2074 6f6f 2e20 652e 672e 2c20  time too. e.g., 
+00013e30: 7265 7374 6172 740a 2020 2020 2320 6120  restart.    # a 
+00013e40: 7374 6f70 7065 6420 417a 7572 6520 636c  stopped Azure cl
+00013e50: 7573 7465 7220 6361 6e20 7461 6b65 2037  uster can take 7
+00013e60: 6d2e 2053 6f20 7765 2073 6574 2074 6865  m. So we set the
+00013e70: 2074 6f74 616c 2074 696d 656f 7574 2074   total timeout t
+00013e80: 6f20 3730 6d2e 0a20 2020 2074 6f74 616c  o 70m..    total
+00013e90: 5f74 696d 656f 7574 5f6d 696e 7574 6573  _timeout_minutes
+00013ea0: 203d 2037 3020 6966 2067 656e 6572 6963   = 70 if generic
+00013eb0: 5f63 6c6f 7564 203d 3d20 2761 7a75 7265  _cloud == 'azure
+00013ec0: 2720 656c 7365 2032 300a 2020 2020 7465  ' else 20.    te
+00013ed0: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+00013ee0: 2020 2027 6175 746f 7374 6f70 272c 0a20     'autostop',. 
+00013ef0: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
+00013f00: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
+00013f10: 6820 2d79 202d 6420 2d63 207b 6e61 6d65  h -y -d -c {name
+00013f20: 7d20 2d2d 6e75 6d2d 6e6f 6465 7320 3220  } --num-nodes 2 
+00013f30: 2d2d 636c 6f75 6420 7b67 656e 6572 6963  --cloud {generic
+00013f40: 5f63 6c6f 7564 7d20 7465 7374 732f 7465  _cloud} tests/te
+00013f50: 7374 5f79 616d 6c73 2f6d 696e 696d 616c  st_yamls/minimal
+00013f60: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
+00013f70: 2020 2020 6627 736b 7920 6175 746f 7374      f'sky autost
+00013f80: 6f70 202d 7920 7b6e 616d 657d 202d 6920  op -y {name} -i 
+00013f90: 3127 2c0a 0a20 2020 2020 2020 2020 2020  1',..           
+00013fa0: 2023 2045 6e73 7572 6520 6175 746f 7374   # Ensure autost
+00013fb0: 6f70 2069 7320 7365 742e 0a20 2020 2020  op is set..     
+00013fc0: 2020 2020 2020 2066 2773 6b79 2073 7461         f'sky sta
+00013fd0: 7475 7320 7c20 6772 6570 207b 6e61 6d65  tus | grep {name
+00013fe0: 7d20 7c20 6772 6570 2022 316d 2227 2c0a  } | grep "1m"',.
+00013ff0: 0a20 2020 2020 2020 2020 2020 2023 2045  .            # E
+00014000: 6e73 7572 6520 7468 6520 636c 7573 7465  nsure the cluste
+00014010: 7220 6973 206e 6f74 2073 746f 7070 6564  r is not stopped
+00014020: 2065 6172 6c79 2e0a 2020 2020 2020 2020   early..        
+00014030: 2020 2020 2773 6c65 6570 2034 3027 2c0a      'sleep 40',.
+00014040: 2020 2020 2020 2020 2020 2020 6627 733d              f's=
+00014050: 2428 736b 7920 7374 6174 7573 207b 6e61  $(sky status {na
+00014060: 6d65 7d20 2d2d 7265 6672 6573 6829 3b20  me} --refresh); 
+00014070: 6563 686f 2022 2473 223b 2065 6368 6f3b  echo "$s"; echo;
+00014080: 2065 6368 6f3b 2065 6368 6f20 2224 7322   echo; echo "$s"
+00014090: 2020 7c20 6772 6570 207b 6e61 6d65 7d20    | grep {name} 
+000140a0: 7c20 6772 6570 2055 5027 2c0a 0a20 2020  | grep UP',..   
+000140b0: 2020 2020 2020 2020 2023 2045 6e73 7572           # Ensur
+000140c0: 6520 7468 6520 636c 7573 7465 7220 6973  e the cluster is
+000140d0: 2053 544f 5050 4544 2e0a 2020 2020 2020   STOPPED..      
+000140e0: 2020 2020 2020 6627 736c 6565 7020 7b61        f'sleep {a
+000140f0: 7574 6f73 746f 705f 7469 6d65 6f75 747d  utostop_timeout}
+00014100: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00014110: 2773 3d24 2873 6b79 2073 7461 7475 7320  's=$(sky status 
+00014120: 7b6e 616d 657d 202d 2d72 6566 7265 7368  {name} --refresh
+00014130: 293b 2065 6368 6f20 2224 7322 3b20 6563  ); echo "$s"; ec
+00014140: 686f 3b20 6563 686f 3b20 6563 686f 2022  ho; echo; echo "
+00014150: 2473 2220 207c 2067 7265 7020 7b6e 616d  $s"  | grep {nam
+00014160: 657d 207c 2067 7265 7020 5354 4f50 5045  e} | grep STOPPE
+00014170: 4427 2c0a 0a20 2020 2020 2020 2020 2020  D',..           
+00014180: 2023 2045 6e73 7572 6520 7468 6520 636c   # Ensure the cl
+00014190: 7573 7465 7220 6973 2055 5020 616e 6420  uster is UP and 
+000141a0: 7468 6520 6175 746f 7374 6f70 2073 6574  the autostop set
+000141b0: 7469 6e67 2069 7320 7265 7365 7420 2827  ting is reset ('
+000141c0: 2d27 292e 0a20 2020 2020 2020 2020 2020  -')..           
+000141d0: 2066 2773 6b79 2073 7461 7274 202d 7920   f'sky start -y 
+000141e0: 7b6e 616d 657d 272c 0a20 2020 2020 2020  {name}',.       
+000141f0: 2020 2020 2066 2773 6b79 2073 7461 7475       f'sky statu
+00014200: 7320 7c20 6772 6570 207b 6e61 6d65 7d20  s | grep {name} 
+00014210: 7c20 6772 6570 202d 4520 2255 505c 732b  | grep -E "UP\s+
+00014220: 2d22 272c 0a0a 2020 2020 2020 2020 2020  -"',..          
+00014230: 2020 2320 456e 7375 7265 2074 6865 206a    # Ensure the j
+00014240: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
+00014250: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00014260: 6578 6563 207b 6e61 6d65 7d20 7465 7374  exec {name} test
+00014270: 732f 7465 7374 5f79 616d 6c73 2f6d 696e  s/test_yamls/min
+00014280: 696d 616c 2e79 616d 6c27 2c0a 2020 2020  imal.yaml',.    
+00014290: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+000142a0: 6773 207b 6e61 6d65 7d20 3220 2d2d 7374  gs {name} 2 --st
+000142b0: 6174 7573 272c 0a0a 2020 2020 2020 2020  atus',..        
+000142c0: 2020 2020 2320 5465 7374 2072 6573 7461      # Test resta
+000142d0: 7274 696e 6720 7468 6520 6964 6c65 6e65  rting the idlene
+000142e0: 7373 2074 696d 6572 2076 6961 2072 6573  ss timer via res
+000142f0: 6574 3a0a 2020 2020 2020 2020 2020 2020  et:.            
+00014300: 6627 736b 7920 6175 746f 7374 6f70 202d  f'sky autostop -
+00014310: 7920 7b6e 616d 657d 202d 6920 3127 2c20  y {name} -i 1', 
+00014320: 2023 2049 646c 656e 6573 7320 7374 6172   # Idleness star
+00014330: 7473 2063 6f75 6e74 696e 672e 0a20 2020  ts counting..   
+00014340: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
+00014350: 3430 272c 2020 2320 416c 6d6f 7374 2072  40',  # Almost r
+00014360: 6561 6368 6564 2074 6865 2074 6872 6573  eached the thres
+00014370: 686f 6c64 2e0a 2020 2020 2020 2020 2020  hold..          
+00014380: 2020 6627 736b 7920 6175 746f 7374 6f70    f'sky autostop
+00014390: 202d 7920 7b6e 616d 657d 202d 6920 3127   -y {name} -i 1'
+000143a0: 2c20 2023 2053 686f 756c 6420 7265 7374  ,  # Should rest
+000143b0: 6172 7420 7468 6520 7469 6d65 722e 0a20  art the timer.. 
+000143c0: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+000143d0: 7020 3430 272c 0a20 2020 2020 2020 2020  p 40',.         
+000143e0: 2020 2066 2773 3d24 2873 6b79 2073 7461     f's=$(sky sta
+000143f0: 7475 7320 7b6e 616d 657d 202d 2d72 6566  tus {name} --ref
+00014400: 7265 7368 293b 2065 6368 6f20 2224 7322  resh); echo "$s"
+00014410: 3b20 6563 686f 3b20 6563 686f 3b20 6563  ; echo; echo; ec
+00014420: 686f 2022 2473 2220 7c20 6772 6570 207b  ho "$s" | grep {
+00014430: 6e61 6d65 7d20 7c20 6772 6570 2055 5027  name} | grep UP'
+00014440: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00014450: 736c 6565 7020 7b61 7574 6f73 746f 705f  sleep {autostop_
+00014460: 7469 6d65 6f75 747d 272c 0a20 2020 2020  timeout}',.     
+00014470: 2020 2020 2020 2066 2773 3d24 2873 6b79         f's=$(sky
+00014480: 2073 7461 7475 7320 7b6e 616d 657d 202d   status {name} -
+00014490: 2d72 6566 7265 7368 293b 2065 6368 6f20  -refresh); echo 
+000144a0: 2224 7322 3b20 6563 686f 3b20 6563 686f  "$s"; echo; echo
+000144b0: 3b20 6563 686f 2022 2473 2220 207c 2067  ; echo "$s"  | g
+000144c0: 7265 7020 7b6e 616d 657d 207c 2067 7265  rep {name} | gre
+000144d0: 7020 5354 4f50 5045 4427 2c0a 0a20 2020  p STOPPED',..   
+000144e0: 2020 2020 2020 2020 2023 2054 6573 7420           # Test 
+000144f0: 7265 7374 6172 7469 6e67 2074 6865 2069  restarting the i
+00014500: 646c 656e 6573 7320 7469 6d65 7220 7669  dleness timer vi
+00014510: 6120 6578 6563 3a0a 2020 2020 2020 2020  a exec:.        
+00014520: 2020 2020 6627 736b 7920 7374 6172 7420      f'sky start 
+00014530: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
+00014540: 2020 2020 2020 2020 6627 736b 7920 7374          f'sky st
+00014550: 6174 7573 207c 2067 7265 7020 7b6e 616d  atus | grep {nam
+00014560: 657d 207c 2067 7265 7020 2d45 2022 5550  e} | grep -E "UP
+00014570: 5c73 2b2d 2227 2c0a 2020 2020 2020 2020  \s+-"',.        
+00014580: 2020 2020 6627 736b 7920 6175 746f 7374      f'sky autost
+00014590: 6f70 202d 7920 7b6e 616d 657d 202d 6920  op -y {name} -i 
+000145a0: 3127 2c20 2023 2049 646c 656e 6573 7320  1',  # Idleness 
+000145b0: 7374 6172 7473 2063 6f75 6e74 696e 672e  starts counting.
+000145c0: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
+000145d0: 6565 7020 3435 272c 2020 2320 416c 6d6f  eep 45',  # Almo
+000145e0: 7374 2072 6561 6368 6564 2074 6865 2074  st reached the t
+000145f0: 6872 6573 686f 6c64 2e0a 2020 2020 2020  hreshold..      
+00014600: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
+00014610: 207b 6e61 6d65 7d20 6563 686f 2068 6927   {name} echo hi'
+00014620: 2c20 2023 2053 686f 756c 6420 7265 7374  ,  # Should rest
+00014630: 6172 7420 7468 6520 7469 6d65 722e 0a20  art the timer.. 
+00014640: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+00014650: 7020 3435 272c 0a20 2020 2020 2020 2020  p 45',.         
+00014660: 2020 2066 2773 3d24 2873 6b79 2073 7461     f's=$(sky sta
+00014670: 7475 7320 7b6e 616d 657d 202d 2d72 6566  tus {name} --ref
+00014680: 7265 7368 293b 2065 6368 6f20 2224 7322  resh); echo "$s"
+00014690: 3b20 6563 686f 3b20 6563 686f 3b20 6563  ; echo; echo; ec
+000146a0: 686f 2022 2473 2220 207c 2067 7265 7020  ho "$s"  | grep 
+000146b0: 7b6e 616d 657d 207c 2067 7265 7020 5550  {name} | grep UP
+000146c0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+000146d0: 2773 6c65 6570 207b 6175 746f 7374 6f70  'sleep {autostop
+000146e0: 5f74 696d 656f 7574 7d27 2c0a 2020 2020  _timeout}',.    
+000146f0: 2020 2020 2020 2020 6627 733d 2428 736b          f's=$(sk
+00014700: 7920 7374 6174 7573 207b 6e61 6d65 7d20  y status {name} 
+00014710: 2d2d 7265 6672 6573 6829 3b20 6563 686f  --refresh); echo
+00014720: 2022 2473 223b 2065 6368 6f3b 2065 6368   "$s"; echo; ech
+00014730: 6f3b 2065 6368 6f20 2224 7322 2020 7c20  o; echo "$s"  | 
+00014740: 6772 6570 207b 6e61 6d65 7d20 7c20 6772  grep {name} | gr
+00014750: 6570 2053 544f 5050 4544 272c 0a20 2020  ep STOPPED',.   
+00014760: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
+00014770: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
+00014780: 616d 657d 272c 0a20 2020 2020 2020 2074  ame}',.        t
+00014790: 696d 656f 7574 3d74 6f74 616c 5f74 696d  imeout=total_tim
+000147a0: 656f 7574 5f6d 696e 7574 6573 202a 2036  eout_minutes * 6
+000147b0: 302c 0a20 2020 2029 0a20 2020 2072 756e  0,.    ).    run
+000147c0: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
+000147d0: 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054  ..# ---------- T
+000147e0: 6573 7469 6e67 2041 7574 6f64 6f77 6e69  esting Autodowni
+000147f0: 6e67 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070  ng ----------.@p
+00014800: 7974 6573 742e 6d61 726b 2e6e 6f5f 666c  ytest.mark.no_fl
+00014810: 7569 6473 7461 636b 2020 2320 466c 7569  uidstack  # Flui
+00014820: 6453 7461 636b 2064 6f65 7320 6e6f 7420  dStack does not 
+00014830: 7375 7070 6f72 7420 7374 6f70 7069 6e67  support stopping
+00014840: 2069 6e20 536b 7950 696c 6f74 2069 6d70   in SkyPilot imp
+00014850: 6c65 6d65 6e74 6174 696f 6e0a 4070 7974  lementation.@pyt
+00014860: 6573 742e 6d61 726b 2e6e 6f5f 7363 7020  est.mark.no_scp 
+00014870: 2023 2053 4350 2064 6f65 7320 6e6f 7420   # SCP does not 
+00014880: 7375 7070 6f72 7420 6e75 6d5f 6e6f 6465  support num_node
+00014890: 7320 3e20 3120 7965 742e 2052 756e 2074  s > 1 yet. Run t
+000148a0: 6573 745f 7363 705f 6175 746f 646f 776e  est_scp_autodown
+000148b0: 2069 6e73 7465 6164 2e0a 6465 6620 7465   instead..def te
+000148c0: 7374 5f61 7574 6f64 6f77 6e28 6765 6e65  st_autodown(gene
+000148d0: 7269 635f 636c 6f75 643a 2073 7472 293a  ric_cloud: str):
+000148e0: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
+000148f0: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
+00014900: 2020 2020 2320 417a 7572 6520 7461 6b65      # Azure take
+00014910: 7320 7e20 3133 6d33 3073 2028 3831 3073  s ~ 13m30s (810s
+00014920: 2920 746f 2061 7574 6f64 6f77 6e20 6120  ) to autodown a 
+00014930: 564d 2c20 736f 2068 6572 6520 7765 2075  VM, so here we u
+00014940: 7365 2039 3030 2074 6f20 656e 7375 7265  se 900 to ensure
+00014950: 0a20 2020 2023 2074 6865 2056 4d20 6973  .    # the VM is
+00014960: 2074 6572 6d69 6e61 7465 642e 0a20 2020   terminated..   
+00014970: 2061 7574 6f64 6f77 6e5f 7469 6d65 6f75   autodown_timeou
+00014980: 7420 3d20 3930 3020 6966 2067 656e 6572  t = 900 if gener
+00014990: 6963 5f63 6c6f 7564 203d 3d20 2761 7a75  ic_cloud == 'azu
+000149a0: 7265 2720 656c 7365 2032 3430 0a20 2020  re' else 240.   
+000149b0: 2074 6f74 616c 5f74 696d 656f 7574 5f6d   total_timeout_m
+000149c0: 696e 7574 6573 203d 2039 3020 6966 2067  inutes = 90 if g
+000149d0: 656e 6572 6963 5f63 6c6f 7564 203d 3d20  eneric_cloud == 
+000149e0: 2761 7a75 7265 2720 656c 7365 2032 300a  'azure' else 20.
+000149f0: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
+00014a00: 0a20 2020 2020 2020 2027 6175 746f 646f  .        'autodo
+00014a10: 776e 272c 0a20 2020 2020 2020 205b 0a20  wn',.        [. 
+00014a20: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00014a30: 206c 6175 6e63 6820 2d79 202d 6420 2d63   launch -y -d -c
+00014a40: 207b 6e61 6d65 7d20 2d2d 6e75 6d2d 6e6f   {name} --num-no
+00014a50: 6465 7320 3220 2d2d 636c 6f75 6420 7b67  des 2 --cloud {g
+00014a60: 656e 6572 6963 5f63 6c6f 7564 7d20 7465  eneric_cloud} te
+00014a70: 7374 732f 7465 7374 5f79 616d 6c73 2f6d  sts/test_yamls/m
+00014a80: 696e 696d 616c 2e79 616d 6c27 2c0a 2020  inimal.yaml',.  
+00014a90: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00014aa0: 6175 746f 7374 6f70 202d 7920 7b6e 616d  autostop -y {nam
+00014ab0: 657d 202d 2d64 6f77 6e20 2d69 2031 272c  e} --down -i 1',
+00014ac0: 0a20 2020 2020 2020 2020 2020 2023 2045  .            # E
+00014ad0: 6e73 7572 6520 6175 746f 7374 6f70 2069  nsure autostop i
+00014ae0: 7320 7365 742e 0a20 2020 2020 2020 2020  s set..         
+00014af0: 2020 2066 2773 6b79 2073 7461 7475 7320     f'sky status 
+00014b00: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
+00014b10: 6772 6570 2022 316d 2028 646f 776e 2922  grep "1m (down)"
+00014b20: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
+00014b30: 2045 6e73 7572 6520 7468 6520 636c 7573   Ensure the clus
+00014b40: 7465 7220 6973 206e 6f74 2074 6572 6d69  ter is not termi
+00014b50: 6e61 7465 6420 6561 726c 792e 0a20 2020  nated early..   
+00014b60: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
+00014b70: 3430 272c 0a20 2020 2020 2020 2020 2020  40',.           
+00014b80: 2066 2773 3d24 2873 6b79 2073 7461 7475   f's=$(sky statu
+00014b90: 7320 7b6e 616d 657d 202d 2d72 6566 7265  s {name} --refre
+00014ba0: 7368 293b 2065 6368 6f20 2224 7322 3b20  sh); echo "$s"; 
+00014bb0: 6563 686f 3b20 6563 686f 3b20 6563 686f  echo; echo; echo
+00014bc0: 2022 2473 2220 207c 2067 7265 7020 7b6e   "$s"  | grep {n
+00014bd0: 616d 657d 207c 2067 7265 7020 5550 272c  ame} | grep UP',
+00014be0: 0a20 2020 2020 2020 2020 2020 2023 2045  .            # E
+00014bf0: 6e73 7572 6520 7468 6520 636c 7573 7465  nsure the cluste
+00014c00: 7220 6973 2074 6572 6d69 6e61 7465 642e  r is terminated.
+00014c10: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00014c20: 6c65 6570 207b 6175 746f 646f 776e 5f74  leep {autodown_t
+00014c30: 696d 656f 7574 7d27 2c0a 2020 2020 2020  imeout}',.      
+00014c40: 2020 2020 2020 6627 733d 2428 534b 5950        f's=$(SKYP
+00014c50: 494c 4f54 5f44 4542 5547 3d30 2073 6b79  ILOT_DEBUG=0 sky
+00014c60: 2073 7461 7475 7320 7b6e 616d 657d 202d   status {name} -
+00014c70: 2d72 6566 7265 7368 2920 2626 2065 6368  -refresh) && ech
+00014c80: 6f20 2224 7322 2026 2620 7b7b 2065 6368  o "$s" && {{ ech
+00014c90: 6f20 2224 7322 207c 2067 7265 7020 7b6e  o "$s" | grep {n
+00014ca0: 616d 657d 207c 2067 7265 7020 2241 7574  ame} | grep "Aut
+00014cb0: 6f64 6f77 6e65 6420 636c 7573 7465 725c  odowned cluster\
+00014cc0: 7c74 6572 6d69 6e61 7465 6420 6f6e 2074  |terminated on t
+00014cd0: 6865 2063 6c6f 7564 223b 207d 7d20 7c7c  he cloud"; }} ||
+00014ce0: 207b 7b20 6563 686f 2022 2473 2220 7c20   {{ echo "$s" | 
+00014cf0: 6772 6570 207b 6e61 6d65 7d20 2626 2065  grep {name} && e
+00014d00: 7869 7420 3120 7c7c 2065 7869 7420 303b  xit 1 || exit 0;
+00014d10: 207d 7d27 2c0a 2020 2020 2020 2020 2020   }}',.          
+00014d20: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
+00014d30: 7920 2d64 202d 6320 7b6e 616d 657d 202d  y -d -c {name} -
+00014d40: 2d63 6c6f 7564 207b 6765 6e65 7269 635f  -cloud {generic_
+00014d50: 636c 6f75 647d 202d 2d6e 756d 2d6e 6f64  cloud} --num-nod
+00014d60: 6573 2032 202d 2d64 6f77 6e20 7465 7374  es 2 --down test
+00014d70: 732f 7465 7374 5f79 616d 6c73 2f6d 696e  s/test_yamls/min
+00014d80: 696d 616c 2e79 616d 6c27 2c0a 2020 2020  imal.yaml',.    
+00014d90: 2020 2020 2020 2020 6627 736b 7920 7374          f'sky st
+00014da0: 6174 7573 207c 2067 7265 7020 7b6e 616d  atus | grep {nam
+00014db0: 657d 207c 2067 7265 7020 5550 272c 2020  e} | grep UP',  
+00014dc0: 2320 456e 7375 7265 2074 6865 2063 6c75  # Ensure the clu
+00014dd0: 7374 6572 2069 7320 5550 2e0a 2020 2020  ster is UP..    
+00014de0: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
+00014df0: 6563 207b 6e61 6d65 7d20 2d2d 636c 6f75  ec {name} --clou
+00014e00: 6420 7b67 656e 6572 6963 5f63 6c6f 7564  d {generic_cloud
+00014e10: 7d20 7465 7374 732f 7465 7374 5f79 616d  } tests/test_yam
+00014e20: 6c73 2f6d 696e 696d 616c 2e79 616d 6c27  ls/minimal.yaml'
+00014e30: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00014e40: 736b 7920 7374 6174 7573 207c 2067 7265  sky status | gre
+00014e50: 7020 7b6e 616d 657d 207c 2067 7265 7020  p {name} | grep 
+00014e60: 2231 6d20 2864 6f77 6e29 2227 2c0a 2020  "1m (down)"',.  
+00014e70: 2020 2020 2020 2020 2020 6627 736c 6565            f'slee
+00014e80: 7020 7b61 7574 6f64 6f77 6e5f 7469 6d65  p {autodown_time
+00014e90: 6f75 747d 272c 0a20 2020 2020 2020 2020  out}',.         
+00014ea0: 2020 2023 2045 6e73 7572 6520 7468 6520     # Ensure the 
+00014eb0: 636c 7573 7465 7220 6973 2074 6572 6d69  cluster is termi
+00014ec0: 6e61 7465 642e 0a20 2020 2020 2020 2020  nated..         
+00014ed0: 2020 2066 2773 3d24 2853 4b59 5049 4c4f     f's=$(SKYPILO
+00014ee0: 545f 4445 4255 473d 3020 736b 7920 7374  T_DEBUG=0 sky st
+00014ef0: 6174 7573 207b 6e61 6d65 7d20 2d2d 7265  atus {name} --re
+00014f00: 6672 6573 6829 2026 2620 6563 686f 2022  fresh) && echo "
+00014f10: 2473 2220 2626 207b 7b20 6563 686f 2022  $s" && {{ echo "
+00014f20: 2473 2220 7c20 6772 6570 207b 6e61 6d65  $s" | grep {name
+00014f30: 7d20 7c20 6772 6570 2022 4175 746f 646f  } | grep "Autodo
+00014f40: 776e 6564 2063 6c75 7374 6572 5c7c 7465  wned cluster\|te
+00014f50: 726d 696e 6174 6564 206f 6e20 7468 6520  rminated on the 
+00014f60: 636c 6f75 6422 3b20 7d7d 207c 7c20 7b7b  cloud"; }} || {{
+00014f70: 2065 6368 6f20 2224 7322 207c 2067 7265   echo "$s" | gre
+00014f80: 7020 7b6e 616d 657d 2026 2620 6578 6974  p {name} && exit
+00014f90: 2031 207c 7c20 6578 6974 2030 3b20 7d7d   1 || exit 0; }}
+00014fa0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00014fb0: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
+00014fc0: 6420 2d63 207b 6e61 6d65 7d20 2d2d 636c  d -c {name} --cl
+00014fd0: 6f75 6420 7b67 656e 6572 6963 5f63 6c6f  oud {generic_clo
+00014fe0: 7564 7d20 2d2d 6e75 6d2d 6e6f 6465 7320  ud} --num-nodes 
+00014ff0: 3220 2d2d 646f 776e 2074 6573 7473 2f74  2 --down tests/t
+00015000: 6573 745f 7961 6d6c 732f 6d69 6e69 6d61  est_yamls/minima
+00015010: 6c2e 7961 6d6c 272c 0a20 2020 2020 2020  l.yaml',.       
+00015020: 2020 2020 2066 2773 6b79 2061 7574 6f73       f'sky autos
+00015030: 746f 7020 2d79 207b 6e61 6d65 7d20 2d2d  top -y {name} --
+00015040: 6361 6e63 656c 272c 0a20 2020 2020 2020  cancel',.       
+00015050: 2020 2020 2066 2773 6c65 6570 207b 6175       f'sleep {au
+00015060: 746f 646f 776e 5f74 696d 656f 7574 7d27  todown_timeout}'
+00015070: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
+00015080: 456e 7375 7265 2074 6865 2063 6c75 7374  Ensure the clust
+00015090: 6572 2069 7320 7374 696c 6c20 5550 2e0a  er is still UP..
+000150a0: 2020 2020 2020 2020 2020 2020 6627 733d              f's=
+000150b0: 2428 534b 5950 494c 4f54 5f44 4542 5547  $(SKYPILOT_DEBUG
+000150c0: 3d30 2073 6b79 2073 7461 7475 7320 7b6e  =0 sky status {n
+000150d0: 616d 657d 202d 2d72 6566 7265 7368 2920  ame} --refresh) 
+000150e0: 2626 2065 6368 6f20 2224 7322 2026 2620  && echo "$s" && 
+000150f0: 6563 686f 2022 2473 2220 7c20 6772 6570  echo "$s" | grep
+00015100: 207b 6e61 6d65 7d20 7c20 6772 6570 2055   {name} | grep U
+00015110: 5027 2c0a 2020 2020 2020 2020 5d2c 0a20  P',.        ],. 
+00015120: 2020 2020 2020 2066 2773 6b79 2064 6f77         f'sky dow
+00015130: 6e20 2d79 207b 6e61 6d65 7d27 2c0a 2020  n -y {name}',.  
+00015140: 2020 2020 2020 7469 6d65 6f75 743d 746f        timeout=to
+00015150: 7461 6c5f 7469 6d65 6f75 745f 6d69 6e75  tal_timeout_minu
+00015160: 7465 7320 2a20 3630 2c0a 2020 2020 290a  tes * 60,.    ).
+00015170: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
+00015180: 2874 6573 7429 0a0a 0a40 7079 7465 7374  (test)...@pytest
+00015190: 2e6d 6172 6b2e 7363 700a 6465 6620 7465  .mark.scp.def te
+000151a0: 7374 5f73 6370 5f61 7574 6f64 6f77 6e28  st_scp_autodown(
+000151b0: 293a 0a20 2020 206e 616d 6520 3d20 5f67  ):.    name = _g
+000151c0: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
+000151d0: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
+000151e0: 7428 0a20 2020 2020 2020 2027 5343 505f  t(.        'SCP_
+000151f0: 6175 746f 646f 776e 272c 0a20 2020 2020  autodown',.     
+00015200: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+00015210: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
+00015220: 202d 6420 2d63 207b 6e61 6d65 7d20 7b53   -d -c {name} {S
+00015230: 4350 5f54 5950 457d 2074 6573 7473 2f74  CP_TYPE} tests/t
+00015240: 6573 745f 7961 6d6c 732f 6d69 6e69 6d61  est_yamls/minima
+00015250: 6c2e 7961 6d6c 272c 0a20 2020 2020 2020  l.yaml',.       
+00015260: 2020 2020 2066 2773 6b79 2061 7574 6f73       f'sky autos
+00015270: 746f 7020 2d79 207b 6e61 6d65 7d20 2d2d  top -y {name} --
+00015280: 646f 776e 202d 6920 3127 2c0a 2020 2020  down -i 1',.    
+00015290: 2020 2020 2020 2020 2320 456e 7375 7265          # Ensure
+000152a0: 2061 7574 6f73 746f 7020 6973 2073 6574   autostop is set
+000152b0: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
+000152c0: 736b 7920 7374 6174 7573 207c 2067 7265  sky status | gre
+000152d0: 7020 7b6e 616d 657d 207c 2067 7265 7020  p {name} | grep 
+000152e0: 2231 6d20 2864 6f77 6e29 2227 2c0a 2020  "1m (down)"',.  
+000152f0: 2020 2020 2020 2020 2020 2320 456e 7375            # Ensu
+00015300: 7265 2074 6865 2063 6c75 7374 6572 2069  re the cluster i
+00015310: 7320 6e6f 7420 7465 726d 696e 6174 6564  s not terminated
+00015320: 2065 6172 6c79 2e0a 2020 2020 2020 2020   early..        
+00015330: 2020 2020 2773 6c65 6570 2034 3527 2c0a      'sleep 45',.
+00015340: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00015350: 7920 7374 6174 7573 202d 2d72 6566 7265  y status --refre
+00015360: 7368 207c 2067 7265 7020 7b6e 616d 657d  sh | grep {name}
+00015370: 207c 2067 7265 7020 5550 272c 0a20 2020   | grep UP',.   
+00015380: 2020 2020 2020 2020 2023 2045 6e73 7572           # Ensur
+00015390: 6520 7468 6520 636c 7573 7465 7220 6973  e the cluster is
+000153a0: 2074 6572 6d69 6e61 7465 642e 0a20 2020   terminated..   
+000153b0: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
+000153c0: 3230 3027 2c0a 2020 2020 2020 2020 2020  200',.          
+000153d0: 2020 6627 733d 2428 534b 5950 494c 4f54    f's=$(SKYPILOT
+000153e0: 5f44 4542 5547 3d30 2073 6b79 2073 7461  _DEBUG=0 sky sta
+000153f0: 7475 7320 2d2d 7265 6672 6573 6829 2026  tus --refresh) &
+00015400: 2620 7072 696e 7466 2022 2473 2220 2626  & printf "$s" &&
+00015410: 207b 7b20 6563 686f 2022 2473 2220 7c20   {{ echo "$s" | 
+00015420: 6772 6570 207b 6e61 6d65 7d20 7c20 6772  grep {name} | gr
+00015430: 6570 2022 4175 746f 646f 776e 6564 2063  ep "Autodowned c
+00015440: 6c75 7374 6572 5c7c 7465 726d 696e 6174  luster\|terminat
+00015450: 6564 206f 6e20 7468 6520 636c 6f75 6422  ed on the cloud"
+00015460: 3b20 7d7d 207c 7c20 7b7b 2065 6368 6f20  ; }} || {{ echo 
+00015470: 2224 7322 207c 2067 7265 7020 7b6e 616d  "$s" | grep {nam
+00015480: 657d 2026 2620 6578 6974 2031 207c 7c20  e} && exit 1 || 
+00015490: 6578 6974 2030 3b20 7d7d 272c 0a20 2020  exit 0; }}',.   
+000154a0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+000154b0: 6175 6e63 6820 2d79 202d 6420 2d63 207b  aunch -y -d -c {
+000154c0: 6e61 6d65 7d20 7b53 4350 5f54 5950 457d  name} {SCP_TYPE}
+000154d0: 202d 2d64 6f77 6e20 7465 7374 732f 7465   --down tests/te
+000154e0: 7374 5f79 616d 6c73 2f6d 696e 696d 616c  st_yamls/minimal
+000154f0: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
+00015500: 2020 2020 6627 736b 7920 7374 6174 7573      f'sky status
+00015510: 207c 2067 7265 7020 7b6e 616d 657d 207c   | grep {name} |
+00015520: 2067 7265 7020 5550 272c 2020 2320 456e   grep UP',  # En
+00015530: 7375 7265 2074 6865 2063 6c75 7374 6572  sure the cluster
+00015540: 2069 7320 5550 2e0a 2020 2020 2020 2020   is UP..        
+00015550: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
+00015560: 6e61 6d65 7d20 7b53 4350 5f54 5950 457d  name} {SCP_TYPE}
+00015570: 2074 6573 7473 2f74 6573 745f 7961 6d6c   tests/test_yaml
+00015580: 732f 6d69 6e69 6d61 6c2e 7961 6d6c 272c  s/minimal.yaml',
+00015590: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+000155a0: 6b79 2073 7461 7475 7320 7c20 6772 6570  ky status | grep
+000155b0: 207b 6e61 6d65 7d20 7c20 6772 6570 2022   {name} | grep "
+000155c0: 316d 2028 646f 776e 2922 272c 0a20 2020  1m (down)"',.   
+000155d0: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
+000155e0: 3230 3027 2c0a 2020 2020 2020 2020 2020  200',.          
+000155f0: 2020 2320 456e 7375 7265 2074 6865 2063    # Ensure the c
+00015600: 6c75 7374 6572 2069 7320 7465 726d 696e  luster is termin
+00015610: 6174 6564 2e0a 2020 2020 2020 2020 2020  ated..          
+00015620: 2020 6627 733d 2428 534b 5950 494c 4f54    f's=$(SKYPILOT
+00015630: 5f44 4542 5547 3d30 2073 6b79 2073 7461  _DEBUG=0 sky sta
+00015640: 7475 7320 2d2d 7265 6672 6573 6829 2026  tus --refresh) &
+00015650: 2620 7072 696e 7466 2022 2473 2220 2626  & printf "$s" &&
+00015660: 207b 7b20 6563 686f 2022 2473 2220 7c20   {{ echo "$s" | 
+00015670: 6772 6570 207b 6e61 6d65 7d20 7c20 6772  grep {name} | gr
+00015680: 6570 2022 4175 746f 646f 776e 6564 2063  ep "Autodowned c
+00015690: 6c75 7374 6572 5c7c 7465 726d 696e 6174  luster\|terminat
+000156a0: 6564 206f 6e20 7468 6520 636c 6f75 6422  ed on the cloud"
+000156b0: 3b20 7d7d 207c 7c20 7b7b 2065 6368 6f20  ; }} || {{ echo 
+000156c0: 2224 7322 207c 2067 7265 7020 7b6e 616d  "$s" | grep {nam
+000156d0: 657d 2026 2620 6578 6974 2031 207c 7c20  e} && exit 1 || 
+000156e0: 6578 6974 2030 3b20 7d7d 272c 0a20 2020  exit 0; }}',.   
+000156f0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00015700: 6175 6e63 6820 2d79 202d 6420 2d63 207b  aunch -y -d -c {
+00015710: 6e61 6d65 7d20 7b53 4350 5f54 5950 457d  name} {SCP_TYPE}
+00015720: 202d 2d64 6f77 6e20 7465 7374 732f 7465   --down tests/te
+00015730: 7374 5f79 616d 6c73 2f6d 696e 696d 616c  st_yamls/minimal
+00015740: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
+00015750: 2020 2020 6627 736b 7920 6175 746f 7374      f'sky autost
+00015760: 6f70 202d 7920 7b6e 616d 657d 202d 2d63  op -y {name} --c
+00015770: 616e 6365 6c27 2c0a 2020 2020 2020 2020  ancel',.        
+00015780: 2020 2020 2773 6c65 6570 2032 3030 272c      'sleep 200',
+00015790: 0a20 2020 2020 2020 2020 2020 2023 2045  .            # E
+000157a0: 6e73 7572 6520 7468 6520 636c 7573 7465  nsure the cluste
+000157b0: 7220 6973 2073 7469 6c6c 2055 502e 0a20  r is still UP.. 
+000157c0: 2020 2020 2020 2020 2020 2066 2773 3d24             f's=$
+000157d0: 2853 4b59 5049 4c4f 545f 4445 4255 473d  (SKYPILOT_DEBUG=
+000157e0: 3020 736b 7920 7374 6174 7573 202d 2d72  0 sky status --r
+000157f0: 6566 7265 7368 2920 2626 2070 7269 6e74  efresh) && print
+00015800: 6620 2224 7322 2026 2620 6563 686f 2022  f "$s" && echo "
+00015810: 2473 2220 7c20 6772 6570 207b 6e61 6d65  $s" | grep {name
+00015820: 7d20 7c20 6772 6570 2055 5027 2c0a 2020  } | grep UP',.  
+00015830: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
+00015840: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
+00015850: 6e61 6d65 7d27 2c0a 2020 2020 2020 2020  name}',.        
+00015860: 7469 6d65 6f75 743d 3235 202a 2036 302c  timeout=25 * 60,
+00015870: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+00015880: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+00015890: 6465 6620 5f67 6574 5f63 616e 6365 6c5f  def _get_cancel_
+000158a0: 7461 736b 5f77 6974 685f 636c 6f75 6428  task_with_cloud(
+000158b0: 6e61 6d65 2c20 636c 6f75 642c 2074 696d  name, cloud, tim
+000158c0: 656f 7574 3d31 3520 2a20 3630 293a 0a20  eout=15 * 60):. 
+000158d0: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
+000158e0: 2020 2020 2020 2020 6627 7b63 6c6f 7564          f'{cloud
+000158f0: 7d2d 6361 6e63 656c 2d74 6173 6b27 2c0a  }-cancel-task',.
+00015900: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
+00015910: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
+00015920: 6368 202d 6320 7b6e 616d 657d 2065 7861  ch -c {name} exa
+00015930: 6d70 6c65 732f 7265 736e 6574 5f61 7070  mples/resnet_app
+00015940: 2e79 616d 6c20 2d2d 636c 6f75 6420 7b63  .yaml --cloud {c
+00015950: 6c6f 7564 7d20 2d79 202d 6427 2c0a 2020  loud} -y -d',.  
+00015960: 2020 2020 2020 2020 2020 2320 5761 6974            # Wait
+00015970: 2074 6865 2047 5055 2070 726f 6365 7373   the GPU process
+00015980: 2074 6f20 7374 6172 742e 0a20 2020 2020   to start..     
+00015990: 2020 2020 2020 2027 736c 6565 7020 3630         'sleep 60
+000159a0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+000159b0: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+000159c0: 2022 6e76 6964 6961 2d73 6d69 207c 2067   "nvidia-smi | g
+000159d0: 7265 7020 7079 7468 6f6e 2227 2c0a 2020  rep python"',.  
+000159e0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+000159f0: 6c6f 6773 207b 6e61 6d65 7d20 3220 2d2d  logs {name} 2 --
+00015a00: 7374 6174 7573 272c 2020 2320 456e 7375  status',  # Ensu
+00015a10: 7265 2074 6865 206a 6f62 2073 7563 6365  re the job succe
+00015a20: 6564 6564 2e0a 2020 2020 2020 2020 2020  eded..          
+00015a30: 2020 6627 736b 7920 6361 6e63 656c 202d    f'sky cancel -
+00015a40: 7920 7b6e 616d 657d 2031 272c 0a20 2020  y {name} 1',.   
+00015a50: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
+00015a60: 3630 272c 0a20 2020 2020 2020 2020 2020  60',.           
+00015a70: 2023 2063 6865 636b 2069 6620 7468 6520   # check if the 
+00015a80: 7079 7468 6f6e 206a 6f62 2069 7320 676f  python job is go
+00015a90: 6e65 2e0a 2020 2020 2020 2020 2020 2020  ne..            
+00015aa0: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
+00015ab0: 7d20 2221 206e 7669 6469 612d 736d 6920  } "! nvidia-smi 
+00015ac0: 7c20 6772 6570 2070 7974 686f 6e22 272c  | grep python"',
+00015ad0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00015ae0: 6b79 206c 6f67 7320 7b6e 616d 657d 2033  ky logs {name} 3
+00015af0: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
+00015b00: 6e73 7572 6520 7468 6520 6a6f 6220 7375  nsure the job su
+00015b10: 6363 6565 6465 642e 0a20 2020 2020 2020  cceeded..       
+00015b20: 205d 2c0a 2020 2020 2020 2020 6627 736b   ],.        f'sk
+00015b30: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
+00015b40: 272c 0a20 2020 2020 2020 2074 696d 656f  ',.        timeo
+00015b50: 7574 3d74 696d 656f 7574 2c0a 2020 2020  ut=timeout,.    
+00015b60: 290a 2020 2020 7265 7475 726e 2074 6573  ).    return tes
+00015b70: 740a 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d  t...# ----------
+00015b80: 2054 6573 7469 6e67 2060 736b 7920 6361   Testing `sky ca
+00015b90: 6e63 656c 6020 2d2d 2d2d 2d2d 2d2d 2d2d  ncel` ----------
+00015ba0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6177  .@pytest.mark.aw
+00015bb0: 730a 4070 7974 6573 742e 6d61 726b 2e73  s.@pytest.mark.s
+00015bc0: 6b69 7028 0a20 2020 2072 6561 736f 6e3d  kip(.    reason=
+00015bd0: 2754 6865 2072 6573 6e65 745f 6170 7020  'The resnet_app 
+00015be0: 6973 2066 6c61 6b79 2c20 6475 6520 746f  is flaky, due to
+00015bf0: 2054 4620 6661 696c 696e 6720 746f 2064   TF failing to d
+00015c00: 6574 6563 7420 4750 5573 2e27 290a 6465  etect GPUs.').de
+00015c10: 6620 7465 7374 5f63 616e 6365 6c5f 6177  f test_cancel_aw
+00015c20: 7328 293a 0a20 2020 206e 616d 6520 3d20  s():.    name = 
+00015c30: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
+00015c40: 6528 290a 2020 2020 7465 7374 203d 205f  e().    test = _
+00015c50: 6765 745f 6361 6e63 656c 5f74 6173 6b5f  get_cancel_task_
+00015c60: 7769 7468 5f63 6c6f 7564 286e 616d 652c  with_cloud(name,
+00015c70: 2027 6177 7327 290a 2020 2020 7275 6e5f   'aws').    run_
+00015c80: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
+00015c90: 0a40 7079 7465 7374 2e6d 6172 6b2e 6763  .@pytest.mark.gc
+00015ca0: 700a 4070 7974 6573 742e 6d61 726b 2e73  p.@pytest.mark.s
+00015cb0: 6b69 7028 0a20 2020 2072 6561 736f 6e3d  kip(.    reason=
+00015cc0: 2754 6865 2072 6573 6e65 745f 6170 7020  'The resnet_app 
+00015cd0: 6973 2066 6c61 6b79 2c20 6475 6520 746f  is flaky, due to
+00015ce0: 2054 4620 6661 696c 696e 6720 746f 2064   TF failing to d
+00015cf0: 6574 6563 7420 4750 5573 2e27 290a 6465  etect GPUs.').de
+00015d00: 6620 7465 7374 5f63 616e 6365 6c5f 6763  f test_cancel_gc
+00015d10: 7028 293a 0a20 2020 206e 616d 6520 3d20  p():.    name = 
+00015d20: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
+00015d30: 6528 290a 2020 2020 7465 7374 203d 205f  e().    test = _
+00015d40: 6765 745f 6361 6e63 656c 5f74 6173 6b5f  get_cancel_task_
+00015d50: 7769 7468 5f63 6c6f 7564 286e 616d 652c  with_cloud(name,
+00015d60: 2027 6763 7027 290a 2020 2020 7275 6e5f   'gcp').    run_
+00015d70: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
+00015d80: 0a40 7079 7465 7374 2e6d 6172 6b2e 617a  .@pytest.mark.az
+00015d90: 7572 650a 4070 7974 6573 742e 6d61 726b  ure.@pytest.mark
+00015da0: 2e73 6b69 7028 0a20 2020 2072 6561 736f  .skip(.    reaso
+00015db0: 6e3d 2754 6865 2072 6573 6e65 745f 6170  n='The resnet_ap
+00015dc0: 7020 6973 2066 6c61 6b79 2c20 6475 6520  p is flaky, due 
+00015dd0: 746f 2054 4620 6661 696c 696e 6720 746f  to TF failing to
+00015de0: 2064 6574 6563 7420 4750 5573 2e27 290a   detect GPUs.').
+00015df0: 6465 6620 7465 7374 5f63 616e 6365 6c5f  def test_cancel_
+00015e00: 617a 7572 6528 293a 0a20 2020 206e 616d  azure():.    nam
+00015e10: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
+00015e20: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
+00015e30: 203d 205f 6765 745f 6361 6e63 656c 5f74   = _get_cancel_t
+00015e40: 6173 6b5f 7769 7468 5f63 6c6f 7564 286e  ask_with_cloud(n
+00015e50: 616d 652c 2027 617a 7572 6527 2c20 7469  ame, 'azure', ti
+00015e60: 6d65 6f75 743d 3330 202a 2036 3029 0a20  meout=30 * 60). 
+00015e70: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+00015e80: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
+00015e90: 6d61 726b 2e6e 6f5f 6c61 6d62 6461 5f63  mark.no_lambda_c
+00015ea0: 6c6f 7564 2020 2320 4c61 6d62 6461 2043  loud  # Lambda C
+00015eb0: 6c6f 7564 2064 6f65 7320 6e6f 7420 6861  loud does not ha
+00015ec0: 7665 2056 3130 3020 6770 7573 0a40 7079  ve V100 gpus.@py
+00015ed0: 7465 7374 2e6d 6172 6b2e 6e6f 5f69 626d  test.mark.no_ibm
+00015ee0: 2020 2320 4942 4d20 636c 6f75 6420 6375    # IBM cloud cu
+00015ef0: 7272 656e 746c 7920 646f 6573 6e27 7420  rrently doesn't 
+00015f00: 7072 6f76 6964 6520 7075 626c 6963 2069  provide public i
+00015f10: 6d61 6765 2077 6974 6820 4355 4441 0a40  mage with CUDA.@
+00015f20: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f70  pytest.mark.no_p
+00015f30: 6170 6572 7370 6163 6520 2023 2050 6170  aperspace  # Pap
+00015f40: 6572 7370 6163 6520 6861 7320 6067 6e6f  erspace has `gno
+00015f50: 6d65 2d73 6865 6c6c 6020 6f6e 206e 7669  me-shell` on nvi
+00015f60: 6469 612d 736d 690a 4070 7974 6573 742e  dia-smi.@pytest.
+00015f70: 6d61 726b 2e6e 6f5f 7363 7020 2023 2053  mark.no_scp  # S
+00015f80: 4350 2064 6f65 7320 6e6f 7420 7375 7070  CP does not supp
+00015f90: 6f72 7420 6e75 6d5f 6e6f 6465 7320 3e20  ort num_nodes > 
+00015fa0: 3120 7965 740a 6465 6620 7465 7374 5f63  1 yet.def test_c
+00015fb0: 616e 6365 6c5f 7079 746f 7263 6828 6765  ancel_pytorch(ge
+00015fc0: 6e65 7269 635f 636c 6f75 643a 2073 7472  neric_cloud: str
+00015fd0: 293a 0a20 2020 206e 616d 6520 3d20 5f67  ):.    name = _g
+00015fe0: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
+00015ff0: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
+00016000: 7428 0a20 2020 2020 2020 2027 6361 6e63  t(.        'canc
+00016010: 656c 2d70 7974 6f72 6368 272c 0a20 2020  el-pytorch',.   
+00016020: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
+00016030: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
+00016040: 2d63 207b 6e61 6d65 7d20 2d2d 636c 6f75  -c {name} --clou
+00016050: 6420 7b67 656e 6572 6963 5f63 6c6f 7564  d {generic_cloud
+00016060: 7d20 6578 616d 706c 6573 2f72 6573 6e65  } examples/resne
+00016070: 745f 6469 7374 7269 6275 7465 645f 746f  t_distributed_to
+00016080: 7263 682e 7961 6d6c 202d 7920 2d64 272c  rch.yaml -y -d',
+00016090: 0a20 2020 2020 2020 2020 2020 2023 2057  .            # W
+000160a0: 6169 7420 7468 6520 4750 5520 7072 6f63  ait the GPU proc
+000160b0: 6573 7320 746f 2073 7461 7274 2e0a 2020  ess to start..  
+000160c0: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
+000160d0: 2039 3027 2c0a 2020 2020 2020 2020 2020   90',.          
+000160e0: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
+000160f0: 6d65 7d20 2228 6e76 6964 6961 2d73 6d69  me} "(nvidia-smi
+00016100: 207c 2067 7265 7020 7079 7468 6f6e 2920   | grep python) 
+00016110: 7c7c 2027 0a20 2020 2020 2020 2020 2020  || '.           
+00016120: 2023 2057 6865 6e20 7275 6e20 696e 7369   # When run insi
+00016130: 6465 2063 6f6e 7461 696e 6572 2f6b 3873  de container/k8s
+00016140: 2c20 6e76 6964 6961 2d73 6d69 2063 616e  , nvidia-smi can
+00016150: 6e6f 7420 7368 6f77 2070 726f 6365 7373  not show process
+00016160: 2069 6473 2e0a 2020 2020 2020 2020 2020   ids..          
+00016170: 2020 2320 5365 6520 6874 7470 733a 2f2f    # See https://
+00016180: 6769 7468 7562 2e63 6f6d 2f4e 5649 4449  github.com/NVIDI
+00016190: 412f 6e76 6964 6961 2d64 6f63 6b65 722f  A/nvidia-docker/
+000161a0: 6973 7375 6573 2f31 3739 0a20 2020 2020  issues/179.     
+000161b0: 2020 2020 2020 2023 2054 6f20 776f 726b         # To work
+000161c0: 2061 726f 756e 642c 2077 6520 6368 6563   around, we chec
+000161d0: 6b20 6966 2047 5055 2075 7469 6c69 7a61  k if GPU utiliza
+000161e0: 7469 6f6e 2069 7320 6772 6561 7465 7220  tion is greater 
+000161f0: 7468 616e 2030 2e0a 2020 2020 2020 2020  than 0..        
+00016200: 2020 2020 6627 5b20 5c24 286e 7669 6469      f'[ \$(nvidi
+00016210: 612d 736d 6920 2d2d 7175 6572 792d 6770  a-smi --query-gp
+00016220: 753d 7574 696c 697a 6174 696f 6e2e 6770  u=utilization.gp
+00016230: 7520 2d2d 666f 726d 6174 3d63 7376 2c6e  u --format=csv,n
+00016240: 6f68 6561 6465 722c 6e6f 756e 6974 7329  oheader,nounits)
+00016250: 202d 6774 2030 205d 2227 2c0a 2020 2020   -gt 0 ]"',.    
+00016260: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+00016270: 6773 207b 6e61 6d65 7d20 3220 2d2d 7374  gs {name} 2 --st
+00016280: 6174 7573 272c 2020 2320 456e 7375 7265  atus',  # Ensure
+00016290: 2074 6865 206a 6f62 2073 7563 6365 6564   the job succeed
+000162a0: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
+000162b0: 6627 736b 7920 6361 6e63 656c 202d 7920  f'sky cancel -y 
+000162c0: 7b6e 616d 657d 2031 272c 0a20 2020 2020  {name} 1',.     
+000162d0: 2020 2020 2020 2027 736c 6565 7020 3630         'sleep 60
+000162e0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+000162f0: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+00016300: 2022 286e 7669 6469 612d 736d 6920 7c20   "(nvidia-smi | 
+00016310: 6772 6570 205c 274e 6f20 7275 6e6e 696e  grep \'No runnin
+00016320: 6720 7072 6f63 6573 735c 2729 207c 7c20  g process\') || 
+00016330: 270a 2020 2020 2020 2020 2020 2020 2320  '.            # 
+00016340: 456e 7375 7265 2058 6f72 6720 6973 2074  Ensure Xorg is t
+00016350: 6865 206f 6e6c 7920 7072 6f63 6573 7320  he only process 
+00016360: 7275 6e6e 696e 672e 0a20 2020 2020 2020  running..       
+00016370: 2020 2020 2027 5b20 5c24 286e 7669 6469       '[ \$(nvidi
+00016380: 612d 736d 6920 7c20 6772 6570 202d 4120  a-smi | grep -A 
+00016390: 3130 2050 726f 6365 7373 6573 207c 2067  10 Processes | g
+000163a0: 7265 7020 2d41 2031 3020 3d3d 3d20 7c20  rep -A 10 === | 
+000163b0: 6772 6570 202d 7620 586f 7267 2920 2d65  grep -v Xorg) -e
+000163c0: 7120 3220 5d22 272c 0a20 2020 2020 2020  q 2 ]"',.       
+000163d0: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+000163e0: 7b6e 616d 657d 2033 202d 2d73 7461 7475  {name} 3 --statu
+000163f0: 7327 2c20 2023 2045 6e73 7572 6520 7468  s',  # Ensure th
+00016400: 6520 6a6f 6220 7375 6363 6565 6465 642e  e job succeeded.
+00016410: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
+00016420: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
+00016430: 7920 7b6e 616d 657d 272c 0a20 2020 2020  y {name}',.     
+00016440: 2020 2074 696d 656f 7574 3d32 3020 2a20     timeout=20 * 
+00016450: 3630 2c0a 2020 2020 290a 2020 2020 7275  60,.    ).    ru
+00016460: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
+00016470: 0a0a 0a23 2063 616e 2774 2075 7365 2060  ...# can't use `
+00016480: 5f67 6574 5f63 616e 6365 6c5f 7461 736b  _get_cancel_task
+00016490: 5f77 6974 685f 636c 6f75 6428 2960 2c20  _with_cloud()`, 
+000164a0: 6173 2063 6f6d 6d61 6e64 2060 6e76 6964  as command `nvid
+000164b0: 6961 2d73 6d69 600a 2320 7265 7175 6972  ia-smi`.# requir
+000164c0: 6573 2061 2043 5544 4120 7075 626c 6963  es a CUDA public
+000164d0: 2069 6d61 6765 2c20 7768 6963 6820 4942   image, which IB
+000164e0: 4d20 646f 6573 6e27 7420 6f66 6665 720a  M doesn't offer.
+000164f0: 4070 7974 6573 742e 6d61 726b 2e69 626d  @pytest.mark.ibm
+00016500: 0a64 6566 2074 6573 745f 6361 6e63 656c  .def test_cancel
+00016510: 5f69 626d 2829 3a0a 2020 2020 6e61 6d65  _ibm():.    name
+00016520: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
+00016530: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
+00016540: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+00016550: 2769 626d 2d63 616e 6365 6c2d 7461 736b  'ibm-cancel-task
+00016560: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
+00016570: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00016580: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
+00016590: 657d 202d 2d63 6c6f 7564 2069 626d 2065  e} --cloud ibm e
+000165a0: 7861 6d70 6c65 732f 6d69 6e69 6d61 6c2e  xamples/minimal.
+000165b0: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+000165c0: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
+000165d0: 616d 657d 202d 6e20 7b6e 616d 657d 2d31  ame} -n {name}-1
+000165e0: 202d 6420 2022 7768 696c 6520 7472 7565   -d  "while true
+000165f0: 3b20 646f 2065 6368 6f20 5c27 4865 6c6c  ; do echo \'Hell
+00016600: 6f20 536b 7950 696c 6f74 5c27 3b20 736c  o SkyPilot\'; sl
+00016610: 6565 7020 323b 2064 6f6e 6522 272c 0a20  eep 2; done"',. 
+00016620: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+00016630: 7020 3230 272c 0a20 2020 2020 2020 2020  p 20',.         
+00016640: 2020 2066 2773 6b79 2071 7565 7565 207b     f'sky queue {
+00016650: 6e61 6d65 7d20 7c20 6772 6570 207b 6e61  name} | grep {na
+00016660: 6d65 7d2d 3120 7c20 6772 6570 2052 554e  me}-1 | grep RUN
+00016670: 4e49 4e47 272c 0a20 2020 2020 2020 2020  NING',.         
+00016680: 2020 2066 2773 6b79 2063 616e 6365 6c20     f'sky cancel 
+00016690: 2d79 207b 6e61 6d65 7d20 3227 2c0a 2020  -y {name} 2',.  
+000166a0: 2020 2020 2020 2020 2020 6627 736c 6565            f'slee
+000166b0: 7020 3527 2c0a 2020 2020 2020 2020 2020  p 5',.          
+000166c0: 2020 6627 736b 7920 7175 6575 6520 7b6e    f'sky queue {n
+000166d0: 616d 657d 207c 2067 7265 7020 7b6e 616d  ame} | grep {nam
+000166e0: 657d 2d31 207c 2067 7265 7020 4341 4e43  e}-1 | grep CANC
+000166f0: 454c 4c45 4427 2c0a 2020 2020 2020 2020  ELLED',.        
+00016700: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
+00016710: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
+00016720: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
+00016730: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
+00016740: 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20 5465  .# ---------- Te
+00016750: 7374 696e 6720 7573 652d 7370 6f74 206f  sting use-spot o
+00016760: 7074 696f 6e20 2d2d 2d2d 2d2d 2d2d 2d2d  ption ----------
+00016770: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
+00016780: 5f66 6c75 6964 7374 6163 6b20 2023 2046  _fluidstack  # F
+00016790: 6c75 6964 5374 6163 6b20 646f 6573 206e  luidStack does n
+000167a0: 6f74 2073 7570 706f 7274 2073 706f 7420  ot support spot 
+000167b0: 696e 7374 616e 6365 730a 4070 7974 6573  instances.@pytes
+000167c0: 742e 6d61 726b 2e6e 6f5f 617a 7572 6520  t.mark.no_azure 
+000167d0: 2023 2041 7a75 7265 2064 6f65 7320 6e6f   # Azure does no
+000167e0: 7420 7375 7070 6f72 7420 7370 6f74 2069  t support spot i
+000167f0: 6e73 7461 6e63 6573 0a40 7079 7465 7374  nstances.@pytest
+00016800: 2e6d 6172 6b2e 6e6f 5f6c 616d 6264 615f  .mark.no_lambda_
+00016810: 636c 6f75 6420 2023 204c 616d 6264 6120  cloud  # Lambda 
+00016820: 436c 6f75 6420 646f 6573 206e 6f74 2073  Cloud does not s
+00016830: 7570 706f 7274 2073 706f 7420 696e 7374  upport spot inst
+00016840: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
+00016850: 726b 2e6e 6f5f 7061 7065 7273 7061 6365  rk.no_paperspace
+00016860: 2020 2320 5061 7065 7273 7061 6365 2064    # Paperspace d
 00016870: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
 00016880: 7370 6f74 2069 6e73 7461 6e63 6573 0a40  spot instances.@
-00016890: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f6b  pytest.mark.no_k
-000168a0: 7562 6572 6e65 7465 7320 2023 204b 7562  ubernetes  # Kub
-000168b0: 6572 6e65 7465 7320 646f 6573 206e 6f74  ernetes does not
-000168c0: 2068 6176 6520 6120 6e6f 7469 6f6e 206f   have a notion o
-000168d0: 6620 7370 6f74 2069 6e73 7461 6e63 6573  f spot instances
-000168e0: 0a64 6566 2074 6573 745f 7573 655f 7370  .def test_use_sp
-000168f0: 6f74 2867 656e 6572 6963 5f63 6c6f 7564  ot(generic_cloud
-00016900: 3a20 7374 7229 3a0a 2020 2020 2222 2254  : str):.    """T
-00016910: 6573 7420 7573 652d 7370 6f74 2061 6e64  est use-spot and
-00016920: 2073 6b79 2065 7865 632e 2222 220a 2020   sky exec.""".  
-00016930: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
-00016940: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
-00016950: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
-00016960: 2020 2020 2020 2775 7365 2d73 706f 7427        'use-spot'
-00016970: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
-00016980: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
-00016990: 756e 6368 202d 6320 7b6e 616d 657d 202d  unch -c {name} -
-000169a0: 2d63 6c6f 7564 207b 6765 6e65 7269 635f  -cloud {generic_
-000169b0: 636c 6f75 647d 2074 6573 7473 2f74 6573  cloud} tests/tes
-000169c0: 745f 7961 6d6c 732f 6d69 6e69 6d61 6c2e  t_yamls/minimal.
-000169d0: 7961 6d6c 202d 2d75 7365 2d73 706f 7420  yaml --use-spot 
-000169e0: 2d79 272c 0a20 2020 2020 2020 2020 2020  -y',.           
-000169f0: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
-00016a00: 657d 2031 202d 2d73 7461 7475 7327 2c0a  e} 1 --status',.
-00016a10: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00016a20: 7920 6578 6563 207b 6e61 6d65 7d20 6563  y exec {name} ec
-00016a30: 686f 2068 6927 2c0a 2020 2020 2020 2020  ho hi',.        
-00016a40: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
-00016a50: 6e61 6d65 7d20 3220 2d2d 7374 6174 7573  name} 2 --status
-00016a60: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
-00016a70: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
-00016a80: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
-00016a90: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
-00016aa0: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
-00016ab0: 6573 742e 6d61 726b 2e67 6370 0a64 6566  est.mark.gcp.def
-00016ac0: 2074 6573 745f 7374 6f70 5f67 6370 5f73   test_stop_gcp_s
-00016ad0: 706f 7428 293a 0a20 2020 2022 2222 5465  pot():.    """Te
-00016ae0: 7374 2047 4350 2073 706f 7420 6361 6e20  st GCP spot can 
-00016af0: 6265 2073 746f 7070 6564 2c20 6175 746f  be stopped, auto
-00016b00: 7374 6f70 7065 642c 2072 6573 7461 7274  stopped, restart
-00016b10: 6564 2e22 2222 0a20 2020 206e 616d 6520  ed.""".    name 
-00016b20: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
-00016b30: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
-00016b40: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
-00016b50: 7374 6f70 5f67 6370 5f73 706f 7427 2c0a  stop_gcp_spot',.
-00016b60: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
-00016b70: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
-00016b80: 6368 202d 6320 7b6e 616d 657d 202d 2d63  ch -c {name} --c
-00016b90: 6c6f 7564 2067 6370 202d 2d75 7365 2d73  loud gcp --use-s
-00016ba0: 706f 7420 2d2d 6370 7573 2032 2b20 2d79  pot --cpus 2+ -y
-00016bb0: 202d 2d20 746f 7563 6820 6d79 6669 6c65   -- touch myfile
-00016bc0: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
-00016bd0: 2073 746f 7020 7368 6f75 6c64 2067 6f20   stop should go 
-00016be0: 7468 726f 7567 683a 0a20 2020 2020 2020  through:.       
-00016bf0: 2020 2020 2066 2773 6b79 2073 746f 7020       f'sky stop 
-00016c00: 7b6e 616d 657d 202d 7927 2c0a 2020 2020  {name} -y',.    
-00016c10: 2020 2020 2020 2020 6627 736b 7920 7374          f'sky st
-00016c20: 6172 7420 7b6e 616d 657d 202d 7927 2c0a  art {name} -y',.
-00016c30: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00016c40: 7920 6578 6563 207b 6e61 6d65 7d20 2d2d  y exec {name} --
-00016c50: 206c 7320 6d79 6669 6c65 272c 0a20 2020   ls myfile',.   
-00016c60: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00016c70: 6f67 7320 7b6e 616d 657d 2032 202d 2d73  ogs {name} 2 --s
-00016c80: 7461 7475 7327 2c0a 2020 2020 2020 2020  tatus',.        
-00016c90: 2020 2020 6627 736b 7920 6175 746f 7374      f'sky autost
-00016ca0: 6f70 207b 6e61 6d65 7d20 2d69 3020 2d79  op {name} -i0 -y
-00016cb0: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
-00016cc0: 736c 6565 7020 3930 272c 0a20 2020 2020  sleep 90',.     
-00016cd0: 2020 2020 2020 2066 2773 3d24 2873 6b79         f's=$(sky
-00016ce0: 2073 7461 7475 7320 7b6e 616d 657d 202d   status {name} -
-00016cf0: 2d72 6566 7265 7368 293b 2065 6368 6f20  -refresh); echo 
-00016d00: 2224 7322 3b20 6563 686f 3b20 6563 686f  "$s"; echo; echo
-00016d10: 3b20 6563 686f 2022 2473 2220 207c 2067  ; echo "$s"  | g
-00016d20: 7265 7020 7b6e 616d 657d 207c 2067 7265  rep {name} | gre
-00016d30: 7020 5354 4f50 5045 4427 2c0a 2020 2020  p STOPPED',.    
-00016d40: 2020 2020 2020 2020 6627 736b 7920 7374          f'sky st
-00016d50: 6172 7420 7b6e 616d 657d 202d 7927 2c0a  art {name} -y',.
-00016d60: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00016d70: 7920 6578 6563 207b 6e61 6d65 7d20 2d2d  y exec {name} --
-00016d80: 206c 7320 6d79 6669 6c65 272c 0a20 2020   ls myfile',.   
-00016d90: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00016da0: 6f67 7320 7b6e 616d 657d 2033 202d 2d73  ogs {name} 3 --s
-00016db0: 7461 7475 7327 2c0a 2020 2020 2020 2020  tatus',.        
-00016dc0: 2020 2020 2320 2d69 206f 7074 696f 6e20      # -i option 
-00016dd0: 6174 206c 6175 6e63 6820 7368 6f75 6c64  at launch should
-00016de0: 2067 6f20 7468 726f 7567 683a 0a20 2020   go through:.   
-00016df0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00016e00: 6175 6e63 6820 2d63 207b 6e61 6d65 7d20  aunch -c {name} 
-00016e10: 2d69 3020 2d79 272c 0a20 2020 2020 2020  -i0 -y',.       
-00016e20: 2020 2020 2027 736c 6565 7020 3132 3027       'sleep 120'
-00016e30: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00016e40: 733d 2428 736b 7920 7374 6174 7573 207b  s=$(sky status {
-00016e50: 6e61 6d65 7d20 2d2d 7265 6672 6573 6829  name} --refresh)
-00016e60: 3b20 6563 686f 2022 2473 223b 2065 6368  ; echo "$s"; ech
-00016e70: 6f3b 2065 6368 6f3b 2065 6368 6f20 2224  o; echo; echo "$
-00016e80: 7322 2020 7c20 6772 6570 207b 6e61 6d65  s"  | grep {name
-00016e90: 7d20 7c20 6772 6570 2053 544f 5050 4544  } | grep STOPPED
-00016ea0: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
-00016eb0: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
-00016ec0: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
-00016ed0: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
-00016ee0: 6573 7428 7465 7374 290a 0a0a 2320 2d2d  est(test)...# --
-00016ef0: 2d2d 2d2d 2d2d 2d2d 2054 6573 7469 6e67  -------- Testing
-00016f00: 206d 616e 6167 6564 2073 706f 7420 2d2d   managed spot --
-00016f10: 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465 7374  --------.@pytest
-00016f20: 2e6d 6172 6b2e 6e6f 5f66 6c75 6964 7374  .mark.no_fluidst
-00016f30: 6163 6b20 2023 2046 6c75 6964 5374 6163  ack  # FluidStac
-00016f40: 6b20 646f 6573 206e 6f74 2073 7570 706f  k does not suppo
-00016f50: 7274 2073 706f 7420 696e 7374 616e 6365  rt spot instance
-00016f60: 730a 4070 7974 6573 742e 6d61 726b 2e6e  s.@pytest.mark.n
-00016f70: 6f5f 617a 7572 6520 2023 2041 7a75 7265  o_azure  # Azure
-00016f80: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
-00016f90: 7420 7370 6f74 2069 6e73 7461 6e63 6573  t spot instances
-00016fa0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
-00016fb0: 5f6c 616d 6264 615f 636c 6f75 6420 2023  _lambda_cloud  #
-00016fc0: 204c 616d 6264 6120 436c 6f75 6420 646f   Lambda Cloud do
-00016fd0: 6573 206e 6f74 2073 7570 706f 7274 2073  es not support s
-00016fe0: 706f 7420 696e 7374 616e 6365 730a 4070  pot instances.@p
-00016ff0: 7974 6573 742e 6d61 726b 2e6e 6f5f 6962  ytest.mark.no_ib
-00017000: 6d20 2023 2049 424d 2043 6c6f 7564 2064  m  # IBM Cloud d
-00017010: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
-00017020: 7370 6f74 2069 6e73 7461 6e63 6573 0a40  spot instances.@
-00017030: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f73  pytest.mark.no_s
-00017040: 6370 2020 2320 5343 5020 646f 6573 206e  cp  # SCP does n
-00017050: 6f74 2073 7570 706f 7274 2073 706f 7420  ot support spot 
-00017060: 696e 7374 616e 6365 730a 4070 7974 6573  instances.@pytes
-00017070: 742e 6d61 726b 2e6e 6f5f 7061 7065 7273  t.mark.no_papers
-00017080: 7061 6365 2020 2320 5061 7070 6572 7370  pace  # Pappersp
-00017090: 6163 6520 646f 6573 206e 6f74 2073 7570  ace does not sup
-000170a0: 706f 7274 2073 706f 7420 696e 7374 616e  port spot instan
-000170b0: 6365 730a 4070 7974 6573 742e 6d61 726b  ces.@pytest.mark
-000170c0: 2e6e 6f5f 6b75 6265 726e 6574 6573 2020  .no_kubernetes  
-000170d0: 2320 4b75 6265 726e 6574 6573 2064 6f65  # Kubernetes doe
-000170e0: 7320 6e6f 7420 6861 7665 2061 206e 6f74  s not have a not
-000170f0: 696f 6e20 6f66 2073 706f 7420 696e 7374  ion of spot inst
-00017100: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
-00017110: 726b 2e6d 616e 6167 6564 5f73 706f 740a  rk.managed_spot.
-00017120: 6465 6620 7465 7374 5f73 706f 7428 6765  def test_spot(ge
-00017130: 6e65 7269 635f 636c 6f75 643a 2073 7472  neric_cloud: str
-00017140: 293a 0a20 2020 2022 2222 5465 7374 2074  ):.    """Test t
-00017150: 6865 2073 706f 7420 7961 6d6c 2e22 2222  he spot yaml."""
-00017160: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
-00017170: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
-00017180: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
-00017190: 0a20 2020 2020 2020 2027 6d61 6e61 6765  .        'manage
-000171a0: 642d 7370 6f74 272c 0a20 2020 2020 2020  d-spot',.       
-000171b0: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
-000171c0: 2773 6b79 2073 706f 7420 6c61 756e 6368  'sky spot launch
-000171d0: 202d 6e20 7b6e 616d 657d 2d31 202d 2d63   -n {name}-1 --c
-000171e0: 6c6f 7564 207b 6765 6e65 7269 635f 636c  loud {generic_cl
-000171f0: 6f75 647d 2065 7861 6d70 6c65 732f 6d61  oud} examples/ma
-00017200: 6e61 6765 645f 7370 6f74 2e79 616d 6c20  naged_spot.yaml 
-00017210: 2d79 202d 6427 2c0a 2020 2020 2020 2020  -y -d',.        
-00017220: 2020 2020 6627 736b 7920 7370 6f74 206c      f'sky spot l
-00017230: 6175 6e63 6820 2d6e 207b 6e61 6d65 7d2d  aunch -n {name}-
-00017240: 3220 2d2d 636c 6f75 6420 7b67 656e 6572  2 --cloud {gener
-00017250: 6963 5f63 6c6f 7564 7d20 6578 616d 706c  ic_cloud} exampl
-00017260: 6573 2f6d 616e 6167 6564 5f73 706f 742e  es/managed_spot.
-00017270: 7961 6d6c 202d 7920 2d64 272c 0a20 2020  yaml -y -d',.   
-00017280: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
-00017290: 3527 2c0a 2020 2020 2020 2020 2020 2020  5',.            
-000172a0: 6627 7b5f 5350 4f54 5f51 5545 5545 5f57  f'{_SPOT_QUEUE_W
-000172b0: 4149 547d 7c20 6772 6570 207b 6e61 6d65  AIT}| grep {name
-000172c0: 7d2d 3120 7c20 6865 6164 202d 6e31 207c  }-1 | head -n1 |
-000172d0: 2067 7265 7020 2253 5441 5254 494e 475c   grep "STARTING\
-000172e0: 7c52 554e 4e49 4e47 2227 2c0a 2020 2020  |RUNNING"',.    
-000172f0: 2020 2020 2020 2020 6627 7b5f 5350 4f54          f'{_SPOT
-00017300: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
-00017310: 6570 207b 6e61 6d65 7d2d 3220 7c20 6865  ep {name}-2 | he
-00017320: 6164 202d 6e31 207c 2067 7265 7020 2253  ad -n1 | grep "S
-00017330: 5441 5254 494e 475c 7c52 554e 4e49 4e47  TARTING\|RUNNING
-00017340: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-00017350: 5f53 504f 545f 4341 4e43 454c 5f57 4149  _SPOT_CANCEL_WAI
-00017360: 542e 666f 726d 6174 286a 6f62 5f6e 616d  T.format(job_nam
-00017370: 653d 6627 7b6e 616d 657d 2d31 2729 2c0a  e=f'{name}-1'),.
-00017380: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
-00017390: 6570 2035 272c 0a20 2020 2020 2020 2020  ep 5',.         
-000173a0: 2020 2066 277b 5f53 504f 545f 5155 4555     f'{_SPOT_QUEU
-000173b0: 455f 5741 4954 7d7c 2067 7265 7020 7b6e  E_WAIT}| grep {n
-000173c0: 616d 657d 2d31 207c 2068 6561 6420 2d6e  ame}-1 | head -n
-000173d0: 3120 7c20 6772 6570 2022 4341 4e43 454c  1 | grep "CANCEL
-000173e0: 4c49 4e47 5c7c 4341 4e43 454c 4c45 4422  LING\|CANCELLED"
-000173f0: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
-00017400: 736c 6565 7020 3230 3027 2c0a 2020 2020  sleep 200',.    
-00017410: 2020 2020 2020 2020 6627 7b5f 5350 4f54          f'{_SPOT
-00017420: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
-00017430: 6570 207b 6e61 6d65 7d2d 3120 7c20 6865  ep {name}-1 | he
-00017440: 6164 202d 6e31 207c 2067 7265 7020 4341  ad -n1 | grep CA
-00017450: 4e43 454c 4c45 4427 2c0a 2020 2020 2020  NCELLED',.      
-00017460: 2020 2020 2020 6627 7b5f 5350 4f54 5f51        f'{_SPOT_Q
-00017470: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
-00017480: 207b 6e61 6d65 7d2d 3220 7c20 6865 6164   {name}-2 | head
-00017490: 202d 6e31 207c 2067 7265 7020 2252 554e   -n1 | grep "RUN
-000174a0: 4e49 4e47 5c7c 5355 4343 4545 4445 4422  NING\|SUCCEEDED"
-000174b0: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
-000174c0: 2020 2020 2020 2320 544f 444f 287a 6877        # TODO(zhw
-000174d0: 7529 3a20 4368 616e 6765 2074 6f20 5f53  u): Change to _S
-000174e0: 504f 545f 4341 4e43 454c 5f57 4149 542e  POT_CANCEL_WAIT.
-000174f0: 666f 726d 6174 286a 6f62 5f6e 616d 653d  format(job_name=
-00017500: 6627 7b6e 616d 657d 2d31 202d 6e20 7b6e  f'{name}-1 -n {n
-00017510: 616d 657d 2d32 2729 2077 6865 6e0a 2020  ame}-2') when.  
-00017520: 2020 2020 2020 2320 6361 6e63 656c 696e        # cancelin
-00017530: 6720 6d75 6c74 6970 6c65 206a 6f62 206e  g multiple job n
-00017540: 616d 6573 2069 7320 7375 7070 6f72 7465  ames is supporte
-00017550: 642e 0a20 2020 2020 2020 2028 5f53 504f  d..        (_SPO
-00017560: 545f 4341 4e43 454c 5f57 4149 542e 666f  T_CANCEL_WAIT.fo
-00017570: 726d 6174 286a 6f62 5f6e 616d 653d 6627  rmat(job_name=f'
-00017580: 7b6e 616d 657d 2d31 2729 202b 2027 3b20  {name}-1') + '; 
-00017590: 2720 2b0a 2020 2020 2020 2020 205f 5350  ' +.         _SP
-000175a0: 4f54 5f43 414e 4345 4c5f 5741 4954 2e66  OT_CANCEL_WAIT.f
-000175b0: 6f72 6d61 7428 6a6f 625f 6e61 6d65 3d66  ormat(job_name=f
-000175c0: 277b 6e61 6d65 7d2d 3227 2929 2c0a 2020  '{name}-2')),.  
-000175d0: 2020 2020 2020 2320 496e 6372 6561 7365        # Increase
-000175e0: 2074 696d 656f 7574 2073 696e 6365 2073   timeout since s
-000175f0: 6b79 2073 706f 7420 7175 6575 6520 2d72  ky spot queue -r
-00017600: 2063 616e 2062 6520 626c 6f63 6b65 6420   can be blocked 
-00017610: 6279 206f 7468 6572 2073 706f 7420 7465  by other spot te
-00017620: 7374 732e 0a20 2020 2020 2020 2074 696d  sts..        tim
-00017630: 656f 7574 3d32 3020 2a20 3630 2c0a 2020  eout=20 * 60,.  
-00017640: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
-00017650: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
-00017660: 7465 7374 2e6d 6172 6b2e 6e6f 5f66 6c75  test.mark.no_flu
-00017670: 6964 7374 6163 6b20 2023 666c 7569 6473  idstack  #fluids
-00017680: 7461 636b 2064 6f65 7320 6e6f 7420 7375  tack does not su
-00017690: 7070 6f72 7420 7370 6f74 2069 6e73 7461  pport spot insta
-000176a0: 6e63 6573 0a40 7079 7465 7374 2e6d 6172  nces.@pytest.mar
-000176b0: 6b2e 6e6f 5f61 7a75 7265 2020 2320 417a  k.no_azure  # Az
-000176c0: 7572 6520 646f 6573 206e 6f74 2073 7570  ure does not sup
-000176d0: 706f 7274 2073 706f 7420 696e 7374 616e  port spot instan
-000176e0: 6365 730a 4070 7974 6573 742e 6d61 726b  ces.@pytest.mark
-000176f0: 2e6e 6f5f 6c61 6d62 6461 5f63 6c6f 7564  .no_lambda_cloud
-00017700: 2020 2320 4c61 6d62 6461 2043 6c6f 7564    # Lambda Cloud
-00017710: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
-00017720: 7420 7370 6f74 2069 6e73 7461 6e63 6573  t spot instances
-00017730: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
-00017740: 5f69 626d 2020 2320 4942 4d20 436c 6f75  _ibm  # IBM Clou
-00017750: 6420 646f 6573 206e 6f74 2073 7570 706f  d does not suppo
-00017760: 7274 2073 706f 7420 696e 7374 616e 6365  rt spot instance
-00017770: 730a 4070 7974 6573 742e 6d61 726b 2e6e  s.@pytest.mark.n
-00017780: 6f5f 7363 7020 2023 2053 4350 2064 6f65  o_scp  # SCP doe
-00017790: 7320 6e6f 7420 7375 7070 6f72 7420 7370  s not support sp
-000177a0: 6f74 2069 6e73 7461 6e63 6573 0a40 7079  ot instances.@py
-000177b0: 7465 7374 2e6d 6172 6b2e 6e6f 5f70 6170  test.mark.no_pap
-000177c0: 6572 7370 6163 6520 2023 2050 6170 6572  erspace  # Paper
-000177d0: 7370 6163 6520 646f 6573 206e 6f74 2073  space does not s
-000177e0: 7570 706f 7274 2073 706f 7420 696e 7374  upport spot inst
-000177f0: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
-00017800: 726b 2e6e 6f5f 6b75 6265 726e 6574 6573  rk.no_kubernetes
-00017810: 2020 2320 4b75 6265 726e 6574 6573 2064    # Kubernetes d
-00017820: 6f65 7320 6e6f 7420 6861 7665 2061 206e  oes not have a n
-00017830: 6f74 696f 6e20 6f66 2073 706f 7420 696e  otion of spot in
-00017840: 7374 616e 6365 730a 4070 7974 6573 742e  stances.@pytest.
-00017850: 6d61 726b 2e6d 616e 6167 6564 5f73 706f  mark.managed_spo
-00017860: 740a 6465 6620 7465 7374 5f73 706f 745f  t.def test_spot_
-00017870: 7069 7065 6c69 6e65 2867 656e 6572 6963  pipeline(generic
-00017880: 5f63 6c6f 7564 3a20 7374 7229 3a0a 2020  _cloud: str):.  
-00017890: 2020 2222 2254 6573 7420 6120 7370 6f74    """Test a spot
-000178a0: 2070 6970 656c 696e 652e 2222 220a 2020   pipeline.""".  
-000178b0: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
-000178c0: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
-000178d0: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
-000178e0: 2020 2020 2020 2773 706f 742d 7069 7065        'spot-pipe
-000178f0: 6c69 6e65 272c 0a20 2020 2020 2020 205b  line',.        [
-00017900: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00017910: 6b79 2073 706f 7420 6c61 756e 6368 202d  ky spot launch -
-00017920: 6e20 7b6e 616d 657d 2074 6573 7473 2f74  n {name} tests/t
-00017930: 6573 745f 7961 6d6c 732f 7069 7065 6c69  est_yamls/pipeli
-00017940: 6e65 2e79 616d 6c20 2d79 202d 6427 2c0a  ne.yaml -y -d',.
-00017950: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
-00017960: 6570 2035 272c 0a20 2020 2020 2020 2020  ep 5',.         
-00017970: 2020 2066 277b 5f53 504f 545f 5155 4555     f'{_SPOT_QUEU
-00017980: 455f 5741 4954 7d7c 2067 7265 7020 7b6e  E_WAIT}| grep {n
-00017990: 616d 657d 207c 2068 6561 6420 2d6e 3120  ame} | head -n1 
-000179a0: 7c20 6772 6570 2022 5354 4152 5449 4e47  | grep "STARTING
-000179b0: 5c7c 5255 4e4e 494e 4722 272c 0a20 2020  \|RUNNING"',.   
-000179c0: 2020 2020 2020 2020 2023 2060 6772 6570           # `grep
-000179d0: 202d 4120 3420 7b6e 616d 657d 6020 6669   -A 4 {name}` fi
-000179e0: 6e64 7320 7468 6520 6a6f 6220 7769 7468  nds the job with
-000179f0: 207b 6e61 6d65 7d20 616e 6420 7468 6520   {name} and the 
-00017a00: 3420 6c69 6e65 730a 2020 2020 2020 2020  4 lines.        
-00017a10: 2020 2020 2320 6166 7465 7220 6974 2c20      # after it, 
-00017a20: 692e 652e 2074 6865 2034 2074 6173 6b73  i.e. the 4 tasks
-00017a30: 2077 6974 6869 6e20 7468 6520 6a6f 622e   within the job.
-00017a40: 0a20 2020 2020 2020 2020 2020 2023 2060  .            # `
-00017a50: 7365 6420 2d6e 2032 7060 2067 6574 7320  sed -n 2p` gets 
-00017a60: 7468 6520 7365 636f 6e64 206c 696e 6520  the second line 
-00017a70: 6f66 2074 6865 2034 206c 696e 6573 2c20  of the 4 lines, 
-00017a80: 692e 652e 2074 6865 2066 6972 7374 0a20  i.e. the first. 
-00017a90: 2020 2020 2020 2020 2020 2023 2074 6173             # tas
-00017aa0: 6b20 7769 7468 696e 2074 6865 206a 6f62  k within the job
-00017ab0: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
-00017ac0: 7b5f 5350 4f54 5f51 5545 5545 5f57 4149  {_SPOT_QUEUE_WAI
-00017ad0: 547d 7c20 6772 6570 202d 4120 3420 7b6e  T}| grep -A 4 {n
-00017ae0: 616d 657d 7c20 7365 6420 2d6e 2032 7020  ame}| sed -n 2p 
-00017af0: 7c20 6772 6570 2022 5354 4152 5449 4e47  | grep "STARTING
-00017b00: 5c7c 5255 4e4e 494e 4722 272c 0a20 2020  \|RUNNING"',.   
-00017b10: 2020 2020 2020 2020 2066 277b 5f53 504f           f'{_SPO
-00017b20: 545f 5155 4555 455f 5741 4954 7d7c 2067  T_QUEUE_WAIT}| g
-00017b30: 7265 7020 2d41 2034 207b 6e61 6d65 7d7c  rep -A 4 {name}|
-00017b40: 2073 6564 202d 6e20 3370 207c 2067 7265   sed -n 3p | gre
-00017b50: 7020 2250 454e 4449 4e47 2227 2c0a 2020  p "PENDING"',.  
-00017b60: 2020 2020 2020 2020 2020 5f53 504f 545f            _SPOT_
-00017b70: 4341 4e43 454c 5f57 4149 542e 666f 726d  CANCEL_WAIT.form
-00017b80: 6174 286a 6f62 5f6e 616d 653d 6627 7b6e  at(job_name=f'{n
-00017b90: 616d 657d 2729 2c0a 2020 2020 2020 2020  ame}'),.        
-00017ba0: 2020 2020 2773 6c65 6570 2035 272c 0a20      'sleep 5',. 
-00017bb0: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
-00017bc0: 504f 545f 5155 4555 455f 5741 4954 7d7c  POT_QUEUE_WAIT}|
-00017bd0: 2067 7265 7020 2d41 2034 207b 6e61 6d65   grep -A 4 {name
-00017be0: 7d7c 2073 6564 202d 6e20 3270 207c 2067  }| sed -n 2p | g
-00017bf0: 7265 7020 2243 414e 4345 4c4c 494e 475c  rep "CANCELLING\
-00017c00: 7c43 414e 4345 4c4c 4544 2227 2c0a 2020  |CANCELLED"',.  
-00017c10: 2020 2020 2020 2020 2020 6627 7b5f 5350            f'{_SP
-00017c20: 4f54 5f51 5545 5545 5f57 4149 547d 7c20  OT_QUEUE_WAIT}| 
-00017c30: 6772 6570 202d 4120 3420 7b6e 616d 657d  grep -A 4 {name}
-00017c40: 7c20 7365 6420 2d6e 2033 7020 7c20 6772  | sed -n 3p | gr
-00017c50: 6570 2022 4341 4e43 454c 4c49 4e47 5c7c  ep "CANCELLING\|
-00017c60: 4341 4e43 454c 4c45 4422 272c 0a20 2020  CANCELLED"',.   
-00017c70: 2020 2020 2020 2020 2066 277b 5f53 504f           f'{_SPO
-00017c80: 545f 5155 4555 455f 5741 4954 7d7c 2067  T_QUEUE_WAIT}| g
-00017c90: 7265 7020 2d41 2034 207b 6e61 6d65 7d7c  rep -A 4 {name}|
-00017ca0: 2073 6564 202d 6e20 3470 207c 2067 7265   sed -n 4p | gre
-00017cb0: 7020 2243 414e 4345 4c4c 494e 475c 7c43  p "CANCELLING\|C
-00017cc0: 414e 4345 4c4c 4544 2227 2c0a 2020 2020  ANCELLED"',.    
-00017cd0: 2020 2020 2020 2020 6627 7b5f 5350 4f54          f'{_SPOT
-00017ce0: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
-00017cf0: 6570 202d 4120 3420 7b6e 616d 657d 7c20  ep -A 4 {name}| 
-00017d00: 7365 6420 2d6e 2035 7020 7c20 6772 6570  sed -n 5p | grep
-00017d10: 2022 4341 4e43 454c 4c49 4e47 5c7c 4341   "CANCELLING\|CA
-00017d20: 4e43 454c 4c45 4422 272c 0a20 2020 2020  NCELLED"',.     
-00017d30: 2020 2020 2020 2027 736c 6565 7020 3230         'sleep 20
-00017d40: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
-00017d50: 6627 7b5f 5350 4f54 5f51 5545 5545 5f57  f'{_SPOT_QUEUE_W
-00017d60: 4149 547d 7c20 6772 6570 202d 4120 3420  AIT}| grep -A 4 
-00017d70: 7b6e 616d 657d 7c20 7365 6420 2d6e 2032  {name}| sed -n 2
-00017d80: 7020 7c20 6772 6570 2022 4341 4e43 454c  p | grep "CANCEL
-00017d90: 4c45 4422 272c 0a20 2020 2020 2020 2020  LED"',.         
-00017da0: 2020 2066 277b 5f53 504f 545f 5155 4555     f'{_SPOT_QUEU
-00017db0: 455f 5741 4954 7d7c 2067 7265 7020 2d41  E_WAIT}| grep -A
-00017dc0: 2034 207b 6e61 6d65 7d7c 2073 6564 202d   4 {name}| sed -
-00017dd0: 6e20 3370 207c 2067 7265 7020 2243 414e  n 3p | grep "CAN
-00017de0: 4345 4c4c 4544 2227 2c0a 2020 2020 2020  CELLED"',.      
-00017df0: 2020 2020 2020 6627 7b5f 5350 4f54 5f51        f'{_SPOT_Q
-00017e00: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
-00017e10: 202d 4120 3420 7b6e 616d 657d 7c20 7365   -A 4 {name}| se
-00017e20: 6420 2d6e 2034 7020 7c20 6772 6570 2022  d -n 4p | grep "
-00017e30: 4341 4e43 454c 4c45 4422 272c 0a20 2020  CANCELLED"',.   
-00017e40: 2020 2020 2020 2020 2066 277b 5f53 504f           f'{_SPO
-00017e50: 545f 5155 4555 455f 5741 4954 7d7c 2067  T_QUEUE_WAIT}| g
-00017e60: 7265 7020 2d41 2034 207b 6e61 6d65 7d7c  rep -A 4 {name}|
-00017e70: 2073 6564 202d 6e20 3570 207c 2067 7265   sed -n 5p | gre
-00017e80: 7020 2243 414e 4345 4c4c 4544 2227 2c0a  p "CANCELLED"',.
-00017e90: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
-00017ea0: 2020 205f 5350 4f54 5f43 414e 4345 4c5f     _SPOT_CANCEL_
-00017eb0: 5741 4954 2e66 6f72 6d61 7428 6a6f 625f  WAIT.format(job_
-00017ec0: 6e61 6d65 3d66 277b 6e61 6d65 7d27 292c  name=f'{name}'),
-00017ed0: 0a20 2020 2020 2020 2023 2049 6e63 7265  .        # Incre
-00017ee0: 6173 6520 7469 6d65 6f75 7420 7369 6e63  ase timeout sinc
-00017ef0: 6520 736b 7920 7370 6f74 2071 7565 7565  e sky spot queue
-00017f00: 202d 7220 6361 6e20 6265 2062 6c6f 636b   -r can be block
-00017f10: 6564 2062 7920 6f74 6865 7220 7370 6f74  ed by other spot
-00017f20: 2074 6573 7473 2e0a 2020 2020 2020 2020   tests..        
-00017f30: 7469 6d65 6f75 743d 3330 202a 2036 302c  timeout=30 * 60,
-00017f40: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
-00017f50: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
-00017f60: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
-00017f70: 666c 7569 6473 7461 636b 2020 2366 6c75  fluidstack  #flu
-00017f80: 6964 7374 6163 6b20 646f 6573 206e 6f74  idstack does not
-00017f90: 2073 7570 706f 7274 2073 706f 7420 696e   support spot in
-00017fa0: 7374 616e 6365 730a 4070 7974 6573 742e  stances.@pytest.
-00017fb0: 6d61 726b 2e6e 6f5f 617a 7572 6520 2023  mark.no_azure  #
-00017fc0: 2041 7a75 7265 2064 6f65 7320 6e6f 7420   Azure does not 
-00017fd0: 7375 7070 6f72 7420 7370 6f74 2069 6e73  support spot ins
-00017fe0: 7461 6e63 6573 0a40 7079 7465 7374 2e6d  tances.@pytest.m
-00017ff0: 6172 6b2e 6e6f 5f6c 616d 6264 615f 636c  ark.no_lambda_cl
-00018000: 6f75 6420 2023 204c 616d 6264 6120 436c  oud  # Lambda Cl
-00018010: 6f75 6420 646f 6573 206e 6f74 2073 7570  oud does not sup
-00018020: 706f 7274 2073 706f 7420 696e 7374 616e  port spot instan
-00018030: 6365 730a 4070 7974 6573 742e 6d61 726b  ces.@pytest.mark
-00018040: 2e6e 6f5f 6962 6d20 2023 2049 424d 2043  .no_ibm  # IBM C
-00018050: 6c6f 7564 2064 6f65 7320 6e6f 7420 7375  loud does not su
-00018060: 7070 6f72 7420 7370 6f74 2069 6e73 7461  pport spot insta
-00018070: 6e63 6573 0a40 7079 7465 7374 2e6d 6172  nces.@pytest.mar
-00018080: 6b2e 6e6f 5f73 6370 2020 2320 5343 5020  k.no_scp  # SCP 
-00018090: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
-000180a0: 2073 706f 7420 696e 7374 616e 6365 730a   spot instances.
-000180b0: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
-000180c0: 7061 7065 7273 7061 6365 2020 2320 5061  paperspace  # Pa
-000180d0: 7065 7273 7061 6365 2064 6f65 7320 6e6f  perspace does no
-000180e0: 7420 7375 7070 6f72 7420 7370 6f74 2069  t support spot i
-000180f0: 6e73 7461 6e63 6573 0a40 7079 7465 7374  nstances.@pytest
-00018100: 2e6d 6172 6b2e 6e6f 5f6b 7562 6572 6e65  .mark.no_kuberne
-00018110: 7465 7320 2023 204b 7562 6572 6e65 7465  tes  # Kubernete
-00018120: 7320 646f 6573 206e 6f74 2068 6176 6520  s does not have 
-00018130: 6120 6e6f 7469 6f6e 206f 6620 7370 6f74  a notion of spot
-00018140: 2069 6e73 7461 6e63 6573 0a40 7079 7465   instances.@pyte
-00018150: 7374 2e6d 6172 6b2e 6d61 6e61 6765 645f  st.mark.managed_
-00018160: 7370 6f74 0a64 6566 2074 6573 745f 7370  spot.def test_sp
-00018170: 6f74 5f66 6169 6c65 645f 7365 7475 7028  ot_failed_setup(
-00018180: 6765 6e65 7269 635f 636c 6f75 643a 2073  generic_cloud: s
-00018190: 7472 293a 0a20 2020 2022 2222 5465 7374  tr):.    """Test
-000181a0: 206d 616e 6167 6564 2073 706f 7420 6a6f   managed spot jo
-000181b0: 6220 7769 7468 2066 6169 6c65 6420 7365  b with failed se
-000181c0: 7475 702e 2222 220a 2020 2020 6e61 6d65  tup.""".    name
-000181d0: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
-000181e0: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
-000181f0: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
-00018200: 2773 706f 745f 6661 696c 6564 5f73 6574  'spot_failed_set
-00018210: 7570 272c 0a20 2020 2020 2020 205b 0a20  up',.        [. 
-00018220: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00018230: 2073 706f 7420 6c61 756e 6368 202d 6e20   spot launch -n 
-00018240: 7b6e 616d 657d 202d 2d63 6c6f 7564 207b  {name} --cloud {
-00018250: 6765 6e65 7269 635f 636c 6f75 647d 202d  generic_cloud} -
-00018260: 7920 2d64 2074 6573 7473 2f74 6573 745f  y -d tests/test_
-00018270: 7961 6d6c 732f 6661 696c 6564 5f73 6574  yamls/failed_set
-00018280: 7570 2e79 616d 6c27 2c0a 2020 2020 2020  up.yaml',.      
-00018290: 2020 2020 2020 2773 6c65 6570 2033 3330        'sleep 330
-000182a0: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
-000182b0: 204d 616b 6520 7375 7265 2074 6865 206a   Make sure the j
-000182c0: 6f62 2066 6169 6c65 6420 7175 6963 6b6c  ob failed quickl
-000182d0: 792e 0a20 2020 2020 2020 2020 2020 2066  y..            f
-000182e0: 277b 5f53 504f 545f 5155 4555 455f 5741  '{_SPOT_QUEUE_WA
-000182f0: 4954 7d20 7c20 6772 6570 207b 6e61 6d65  IT} | grep {name
-00018300: 7d20 7c20 6865 6164 202d 6e31 207c 2067  } | head -n1 | g
-00018310: 7265 7020 2246 4149 4c45 445f 5345 5455  rep "FAILED_SETU
-00018320: 5022 272c 0a20 2020 2020 2020 205d 2c0a  P"',.        ],.
-00018330: 2020 2020 2020 2020 5f53 504f 545f 4341          _SPOT_CA
-00018340: 4e43 454c 5f57 4149 542e 666f 726d 6174  NCEL_WAIT.format
-00018350: 286a 6f62 5f6e 616d 653d 6e61 6d65 292c  (job_name=name),
-00018360: 0a20 2020 2020 2020 2023 2049 6e63 7265  .        # Incre
-00018370: 6173 6520 7469 6d65 6f75 7420 7369 6e63  ase timeout sinc
-00018380: 6520 736b 7920 7370 6f74 2071 7565 7565  e sky spot queue
-00018390: 202d 7220 6361 6e20 6265 2062 6c6f 636b   -r can be block
-000183a0: 6564 2062 7920 6f74 6865 7220 7370 6f74  ed by other spot
-000183b0: 2074 6573 7473 2e0a 2020 2020 2020 2020   tests..        
-000183c0: 7469 6d65 6f75 743d 3230 202a 2036 302c  timeout=20 * 60,
-000183d0: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
-000183e0: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
-000183f0: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
-00018400: 666c 7569 6473 7461 636b 2020 2366 6c75  fluidstack  #flu
-00018410: 6964 7374 6163 6b20 646f 6573 206e 6f74  idstack does not
-00018420: 2073 7570 706f 7274 2073 706f 7420 696e   support spot in
-00018430: 7374 616e 6365 730a 4070 7974 6573 742e  stances.@pytest.
-00018440: 6d61 726b 2e6e 6f5f 617a 7572 6520 2023  mark.no_azure  #
-00018450: 2041 7a75 7265 2064 6f65 7320 6e6f 7420   Azure does not 
-00018460: 7375 7070 6f72 7420 7370 6f74 2069 6e73  support spot ins
-00018470: 7461 6e63 6573 0a40 7079 7465 7374 2e6d  tances.@pytest.m
-00018480: 6172 6b2e 6e6f 5f6c 616d 6264 615f 636c  ark.no_lambda_cl
-00018490: 6f75 6420 2023 204c 616d 6264 6120 436c  oud  # Lambda Cl
-000184a0: 6f75 6420 646f 6573 206e 6f74 2073 7570  oud does not sup
-000184b0: 706f 7274 2073 706f 7420 696e 7374 616e  port spot instan
-000184c0: 6365 730a 4070 7974 6573 742e 6d61 726b  ces.@pytest.mark
-000184d0: 2e6e 6f5f 6962 6d20 2023 2049 424d 2043  .no_ibm  # IBM C
-000184e0: 6c6f 7564 2064 6f65 7320 6e6f 7420 7375  loud does not su
-000184f0: 7070 6f72 7420 7370 6f74 2069 6e73 7461  pport spot insta
-00018500: 6e63 6573 0a40 7079 7465 7374 2e6d 6172  nces.@pytest.mar
-00018510: 6b2e 6e6f 5f73 6370 2020 2320 5343 5020  k.no_scp  # SCP 
-00018520: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
-00018530: 2073 706f 7420 696e 7374 616e 6365 730a   spot instances.
-00018540: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
-00018550: 7061 7065 7273 7061 6365 2020 2320 5061  paperspace  # Pa
-00018560: 7065 7273 7061 6365 2064 6f65 7320 6e6f  perspace does no
-00018570: 7420 7375 7070 6f72 7420 7370 6f74 2069  t support spot i
-00018580: 6e73 7461 6e63 6573 0a40 7079 7465 7374  nstances.@pytest
-00018590: 2e6d 6172 6b2e 6e6f 5f6b 7562 6572 6e65  .mark.no_kuberne
-000185a0: 7465 7320 2023 204b 7562 6572 6e65 7465  tes  # Kubernete
-000185b0: 7320 646f 6573 206e 6f74 2068 6176 6520  s does not have 
-000185c0: 6120 6e6f 7469 6f6e 206f 6620 7370 6f74  a notion of spot
-000185d0: 2069 6e73 7461 6e63 6573 0a40 7079 7465   instances.@pyte
-000185e0: 7374 2e6d 6172 6b2e 6d61 6e61 6765 645f  st.mark.managed_
-000185f0: 7370 6f74 0a64 6566 2074 6573 745f 7370  spot.def test_sp
-00018600: 6f74 5f70 6970 656c 696e 655f 6661 696c  ot_pipeline_fail
-00018610: 6564 5f73 6574 7570 2867 656e 6572 6963  ed_setup(generic
-00018620: 5f63 6c6f 7564 3a20 7374 7229 3a0a 2020  _cloud: str):.  
-00018630: 2020 2222 2254 6573 7420 6d61 6e61 6765    """Test manage
-00018640: 6420 7370 6f74 206a 6f62 2077 6974 6820  d spot job with 
-00018650: 6661 696c 6564 2073 6574 7570 2066 6f72  failed setup for
-00018660: 2061 2070 6970 656c 696e 652e 2222 220a   a pipeline.""".
-00018670: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
-00018680: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
-00018690: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
-000186a0: 2020 2020 2020 2020 2773 706f 745f 7069          'spot_pi
-000186b0: 7065 6c69 6e65 5f66 6169 6c65 645f 7365  peline_failed_se
-000186c0: 7475 7027 2c0a 2020 2020 2020 2020 5b0a  tup',.        [.
-000186d0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-000186e0: 7920 7370 6f74 206c 6175 6e63 6820 2d6e  y spot launch -n
-000186f0: 207b 6e61 6d65 7d20 2d79 202d 6420 7465   {name} -y -d te
-00018700: 7374 732f 7465 7374 5f79 616d 6c73 2f66  sts/test_yamls/f
-00018710: 6169 6c65 645f 7365 7475 705f 7069 7065  ailed_setup_pipe
-00018720: 6c69 6e65 2e79 616d 6c27 2c0a 2020 2020  line.yaml',.    
-00018730: 2020 2020 2020 2020 2773 6c65 6570 2038          'sleep 8
-00018740: 3030 272c 0a20 2020 2020 2020 2020 2020  00',.           
-00018750: 2023 204d 616b 6520 7375 7265 2074 6865   # Make sure the
-00018760: 206a 6f62 2066 6169 6c65 6420 7175 6963   job failed quic
-00018770: 6b6c 792e 0a20 2020 2020 2020 2020 2020  kly..           
-00018780: 2066 277b 5f53 504f 545f 5155 4555 455f   f'{_SPOT_QUEUE_
-00018790: 5741 4954 7d20 7c20 6772 6570 207b 6e61  WAIT} | grep {na
-000187a0: 6d65 7d20 7c20 6865 6164 202d 6e31 207c  me} | head -n1 |
-000187b0: 2067 7265 7020 2246 4149 4c45 445f 5345   grep "FAILED_SE
-000187c0: 5455 5022 272c 0a20 2020 2020 2020 2020  TUP"',.         
-000187d0: 2020 2023 2054 6173 6b20 3020 7368 6f75     # Task 0 shou
-000187e0: 6c64 2062 6520 5355 4343 4545 4445 442e  ld be SUCCEEDED.
-000187f0: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
-00018800: 5f53 504f 545f 5155 4555 455f 5741 4954  _SPOT_QUEUE_WAIT
-00018810: 7d20 7c20 6772 6570 202d 4120 3420 7b6e  } | grep -A 4 {n
-00018820: 616d 657d 7c20 7365 6420 2d6e 2032 7020  ame}| sed -n 2p 
-00018830: 7c20 6772 6570 2022 5355 4343 4545 4445  | grep "SUCCEEDE
-00018840: 4422 272c 0a20 2020 2020 2020 2020 2020  D"',.           
-00018850: 2023 2054 6173 6b20 3120 7368 6f75 6c64   # Task 1 should
-00018860: 2062 6520 4641 494c 4544 5f53 4554 5550   be FAILED_SETUP
-00018870: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
-00018880: 7b5f 5350 4f54 5f51 5545 5545 5f57 4149  {_SPOT_QUEUE_WAI
-00018890: 547d 207c 2067 7265 7020 2d41 2034 207b  T} | grep -A 4 {
-000188a0: 6e61 6d65 7d7c 2073 6564 202d 6e20 3370  name}| sed -n 3p
-000188b0: 207c 2067 7265 7020 2246 4149 4c45 445f   | grep "FAILED_
-000188c0: 5345 5455 5022 272c 0a20 2020 2020 2020  SETUP"',.       
-000188d0: 2020 2020 2023 2054 6173 6b20 3220 7368       # Task 2 sh
-000188e0: 6f75 6c64 2062 6520 4341 4e43 454c 4c45  ould be CANCELLE
-000188f0: 442e 0a20 2020 2020 2020 2020 2020 2066  D..            f
-00018900: 277b 5f53 504f 545f 5155 4555 455f 5741  '{_SPOT_QUEUE_WA
-00018910: 4954 7d20 7c20 6772 6570 202d 4120 3420  IT} | grep -A 4 
-00018920: 7b6e 616d 657d 7c20 7365 6420 2d6e 2034  {name}| sed -n 4
-00018930: 7020 7c20 6772 6570 2022 4341 4e43 454c  p | grep "CANCEL
-00018940: 4c45 4422 272c 0a20 2020 2020 2020 2020  LED"',.         
-00018950: 2020 2023 2054 6173 6b20 3320 7368 6f75     # Task 3 shou
-00018960: 6c64 2062 6520 4341 4e43 454c 4c45 442e  ld be CANCELLED.
-00018970: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
-00018980: 5f53 504f 545f 5155 4555 455f 5741 4954  _SPOT_QUEUE_WAIT
-00018990: 7d20 7c20 6772 6570 202d 4120 3420 7b6e  } | grep -A 4 {n
-000189a0: 616d 657d 7c20 7365 6420 2d6e 2035 7020  ame}| sed -n 5p 
-000189b0: 7c20 6772 6570 2022 4341 4e43 454c 4c45  | grep "CANCELLE
-000189c0: 4422 272c 0a20 2020 2020 2020 205d 2c0a  D"',.        ],.
-000189d0: 2020 2020 2020 2020 5f53 504f 545f 4341          _SPOT_CA
-000189e0: 4e43 454c 5f57 4149 542e 666f 726d 6174  NCEL_WAIT.format
-000189f0: 286a 6f62 5f6e 616d 653d 6e61 6d65 292c  (job_name=name),
-00018a00: 0a20 2020 2020 2020 2023 2049 6e63 7265  .        # Incre
-00018a10: 6173 6520 7469 6d65 6f75 7420 7369 6e63  ase timeout sinc
-00018a20: 6520 736b 7920 7370 6f74 2071 7565 7565  e sky spot queue
-00018a30: 202d 7220 6361 6e20 6265 2062 6c6f 636b   -r can be block
-00018a40: 6564 2062 7920 6f74 6865 7220 7370 6f74  ed by other spot
-00018a50: 2074 6573 7473 2e0a 2020 2020 2020 2020   tests..        
-00018a60: 7469 6d65 6f75 743d 3330 202a 2036 302c  timeout=30 * 60,
-00018a70: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
-00018a80: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
-00018a90: 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054 6573  # ---------- Tes
-00018aa0: 7469 6e67 206d 616e 6167 6564 2073 706f  ting managed spo
-00018ab0: 7420 7265 636f 7665 7279 202d 2d2d 2d2d  t recovery -----
-00018ac0: 2d2d 2d2d 2d0a 0a0a 4070 7974 6573 742e  -----...@pytest.
-00018ad0: 6d61 726b 2e61 7773 0a40 7079 7465 7374  mark.aws.@pytest
-00018ae0: 2e6d 6172 6b2e 6d61 6e61 6765 645f 7370  .mark.managed_sp
-00018af0: 6f74 0a64 6566 2074 6573 745f 7370 6f74  ot.def test_spot
-00018b00: 5f72 6563 6f76 6572 795f 6177 7328 6177  _recovery_aws(aw
-00018b10: 735f 636f 6e66 6967 5f72 6567 696f 6e29  s_config_region)
-00018b20: 3a0a 2020 2020 2222 2254 6573 7420 6d61  :.    """Test ma
-00018b30: 6e61 6765 6420 7370 6f74 2072 6563 6f76  naged spot recov
-00018b40: 6572 792e 2222 220a 2020 2020 6e61 6d65  ery.""".    name
-00018b50: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
-00018b60: 6e61 6d65 2829 0a20 2020 206e 616d 655f  name().    name_
-00018b70: 6f6e 5f63 6c6f 7564 203d 2063 6f6d 6d6f  on_cloud = commo
-00018b80: 6e5f 7574 696c 732e 6d61 6b65 5f63 6c75  n_utils.make_clu
-00018b90: 7374 6572 5f6e 616d 655f 6f6e 5f63 6c6f  ster_name_on_clo
-00018ba0: 7564 280a 2020 2020 2020 2020 6e61 6d65  ud(.        name
-00018bb0: 2c20 7370 6f74 2e53 504f 545f 434c 5553  , spot.SPOT_CLUS
-00018bc0: 5445 525f 4e41 4d45 5f50 5245 4649 585f  TER_NAME_PREFIX_
-00018bd0: 4c45 4e47 5448 2c20 6164 645f 7573 6572  LENGTH, add_user
-00018be0: 5f68 6173 683d 4661 6c73 6529 0a20 2020  _hash=False).   
-00018bf0: 2072 6567 696f 6e20 3d20 6177 735f 636f   region = aws_co
-00018c00: 6e66 6967 5f72 6567 696f 6e0a 2020 2020  nfig_region.    
-00018c10: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
-00018c20: 2020 2020 2027 7370 6f74 5f72 6563 6f76       'spot_recov
-00018c30: 6572 795f 6177 7327 2c0a 2020 2020 2020  ery_aws',.      
-00018c40: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
-00018c50: 6627 736b 7920 7370 6f74 206c 6175 6e63  f'sky spot launc
-00018c60: 6820 2d2d 636c 6f75 6420 6177 7320 2d2d  h --cloud aws --
-00018c70: 7265 6769 6f6e 207b 7265 6769 6f6e 7d20  region {region} 
-00018c80: 2d6e 207b 6e61 6d65 7d20 2265 6368 6f20  -n {name} "echo 
-00018c90: 534b 5950 494c 4f54 5f54 4153 4b5f 4944  SKYPILOT_TASK_ID
-00018ca0: 3a20 5c24 534b 5950 494c 4f54 5f54 4153  : \$SKYPILOT_TAS
-00018cb0: 4b5f 4944 3b20 736c 6565 7020 3138 3030  K_ID; sleep 1800
-00018cc0: 2220 202d 7920 2d64 272c 0a20 2020 2020  "  -y -d',.     
-00018cd0: 2020 2020 2020 2027 736c 6565 7020 3336         'sleep 36
-00018ce0: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
-00018cf0: 6627 7b5f 5350 4f54 5f51 5545 5545 5f57  f'{_SPOT_QUEUE_W
-00018d00: 4149 547d 7c20 6772 6570 207b 6e61 6d65  AIT}| grep {name
-00018d10: 7d20 7c20 6865 6164 202d 6e31 207c 2067  } | head -n1 | g
-00018d20: 7265 7020 2252 554e 4e49 4e47 2227 2c0a  rep "RUNNING"',.
-00018d30: 2020 2020 2020 2020 2020 2020 6627 5255              f'RU
-00018d40: 4e5f 4944 3d24 2873 6b79 2073 706f 7420  N_ID=$(sky spot 
-00018d50: 6c6f 6773 202d 6e20 7b6e 616d 657d 202d  logs -n {name} -
-00018d60: 2d6e 6f2d 666f 6c6c 6f77 207c 2067 7265  -no-follow | gre
-00018d70: 7020 534b 5950 494c 4f54 5f54 4153 4b5f  p SKYPILOT_TASK_
-00018d80: 4944 207c 2063 7574 202d 643a 202d 6632  ID | cut -d: -f2
-00018d90: 293b 2065 6368 6f20 2224 5255 4e5f 4944  ); echo "$RUN_ID
-00018da0: 2220 7c20 7465 6520 2f74 6d70 2f7b 6e61  " | tee /tmp/{na
-00018db0: 6d65 7d2d 7275 6e2d 6964 272c 0a20 2020  me}-run-id',.   
-00018dc0: 2020 2020 2020 2020 2023 2054 6572 6d69           # Termi
-00018dd0: 6e61 7465 2074 6865 2063 6c75 7374 6572  nate the cluster
-00018de0: 206d 616e 7561 6c6c 792e 0a20 2020 2020   manually..     
-00018df0: 2020 2020 2020 2028 6627 6177 7320 6563         (f'aws ec
-00018e00: 3220 7465 726d 696e 6174 652d 696e 7374  2 terminate-inst
-00018e10: 616e 6365 7320 2d2d 7265 6769 6f6e 207b  ances --region {
-00018e20: 7265 6769 6f6e 7d20 2d2d 696e 7374 616e  region} --instan
-00018e30: 6365 2d69 6473 2024 2827 0a20 2020 2020  ce-ids $('.     
-00018e40: 2020 2020 2020 2020 6627 6177 7320 6563          f'aws ec
-00018e50: 3220 6465 7363 7269 6265 2d69 6e73 7461  2 describe-insta
-00018e60: 6e63 6573 202d 2d72 6567 696f 6e20 7b72  nces --region {r
-00018e70: 6567 696f 6e7d 2027 0a20 2020 2020 2020  egion} '.       
-00018e80: 2020 2020 2020 6627 2d2d 6669 6c74 6572        f'--filter
-00018e90: 7320 4e61 6d65 3d74 6167 3a72 6179 2d63  s Name=tag:ray-c
-00018ea0: 6c75 7374 6572 2d6e 616d 652c 5661 6c75  luster-name,Valu
-00018eb0: 6573 3d7b 6e61 6d65 5f6f 6e5f 636c 6f75  es={name_on_clou
-00018ec0: 647d 2a20 270a 2020 2020 2020 2020 2020  d}* '.          
-00018ed0: 2020 2066 272d 2d71 7565 7279 2052 6573     f'--query Res
-00018ee0: 6572 7661 7469 6f6e 735b 5d2e 496e 7374  ervations[].Inst
-00018ef0: 616e 6365 735b 5d2e 496e 7374 616e 6365  ances[].Instance
-00018f00: 4964 2027 0a20 2020 2020 2020 2020 2020  Id '.           
-00018f10: 2020 272d 2d6f 7574 7075 7420 7465 7874    '--output text
-00018f20: 2927 292c 0a20 2020 2020 2020 2020 2020  )'),.           
-00018f30: 2027 736c 6565 7020 3130 3027 2c0a 2020   'sleep 100',.  
-00018f40: 2020 2020 2020 2020 2020 6627 7b5f 5350            f'{_SP
-00018f50: 4f54 5f51 5545 5545 5f57 4149 547d 7c20  OT_QUEUE_WAIT}| 
-00018f60: 6772 6570 207b 6e61 6d65 7d20 7c20 6865  grep {name} | he
-00018f70: 6164 202d 6e31 207c 2067 7265 7020 2252  ad -n1 | grep "R
-00018f80: 4543 4f56 4552 494e 4722 272c 0a20 2020  ECOVERING"',.   
-00018f90: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
-00018fa0: 3230 3027 2c0a 2020 2020 2020 2020 2020  200',.          
-00018fb0: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
-00018fc0: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
-00018fd0: 6d65 7d20 7c20 6865 6164 202d 6e31 207c  me} | head -n1 |
-00018fe0: 2067 7265 7020 2252 554e 4e49 4e47 2227   grep "RUNNING"'
-00018ff0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00019000: 5255 4e5f 4944 3d24 2863 6174 202f 746d  RUN_ID=$(cat /tm
-00019010: 702f 7b6e 616d 657d 2d72 756e 2d69 6429  p/{name}-run-id)
-00019020: 3b20 6563 686f 2024 5255 4e5f 4944 3b20  ; echo $RUN_ID; 
-00019030: 736b 7920 7370 6f74 206c 6f67 7320 2d6e  sky spot logs -n
-00019040: 207b 6e61 6d65 7d20 2d2d 6e6f 2d66 6f6c   {name} --no-fol
-00019050: 6c6f 7720 7c20 6772 6570 2053 4b59 5049  low | grep SKYPI
-00019060: 4c4f 545f 5441 534b 5f49 4420 7c20 6772  LOT_TASK_ID | gr
-00019070: 6570 2022 2452 554e 5f49 4422 272c 0a20  ep "$RUN_ID"',. 
-00019080: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-00019090: 2020 5f53 504f 545f 4341 4e43 454c 5f57    _SPOT_CANCEL_W
-000190a0: 4149 542e 666f 726d 6174 286a 6f62 5f6e  AIT.format(job_n
-000190b0: 616d 653d 6e61 6d65 292c 0a20 2020 2020  ame=name),.     
-000190c0: 2020 2074 696d 656f 7574 3d32 3520 2a20     timeout=25 * 
-000190d0: 3630 2c0a 2020 2020 290a 2020 2020 7275  60,.    ).    ru
-000190e0: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
-000190f0: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
-00019100: 6763 700a 4070 7974 6573 742e 6d61 726b  gcp.@pytest.mark
-00019110: 2e6d 616e 6167 6564 5f73 706f 740a 6465  .managed_spot.de
-00019120: 6620 7465 7374 5f73 706f 745f 7265 636f  f test_spot_reco
-00019130: 7665 7279 5f67 6370 2829 3a0a 2020 2020  very_gcp():.    
-00019140: 2222 2254 6573 7420 6d61 6e61 6765 6420  """Test managed 
-00019150: 7370 6f74 2072 6563 6f76 6572 792e 2222  spot recovery.""
-00019160: 220a 2020 2020 6e61 6d65 203d 205f 6765  ".    name = _ge
-00019170: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
-00019180: 0a20 2020 206e 616d 655f 6f6e 5f63 6c6f  .    name_on_clo
-00019190: 7564 203d 2063 6f6d 6d6f 6e5f 7574 696c  ud = common_util
-000191a0: 732e 6d61 6b65 5f63 6c75 7374 6572 5f6e  s.make_cluster_n
-000191b0: 616d 655f 6f6e 5f63 6c6f 7564 280a 2020  ame_on_cloud(.  
-000191c0: 2020 2020 2020 6e61 6d65 2c20 7370 6f74        name, spot
-000191d0: 2e53 504f 545f 434c 5553 5445 525f 4e41  .SPOT_CLUSTER_NA
-000191e0: 4d45 5f50 5245 4649 585f 4c45 4e47 5448  ME_PREFIX_LENGTH
-000191f0: 2c20 6164 645f 7573 6572 5f68 6173 683d  , add_user_hash=
-00019200: 4661 6c73 6529 0a20 2020 207a 6f6e 6520  False).    zone 
-00019210: 3d20 2775 732d 6561 7374 342d 6227 0a20  = 'us-east4-b'. 
-00019220: 2020 2071 7565 7279 5f63 6d64 203d 2028     query_cmd = (
-00019230: 0a20 2020 2020 2020 2066 2767 636c 6f75  .        f'gclou
-00019240: 6420 636f 6d70 7574 6520 696e 7374 616e  d compute instan
-00019250: 6365 7320 6c69 7374 202d 2d66 696c 7465  ces list --filte
-00019260: 723d 270a 2020 2020 2020 2020 2320 603a  r='.        # `:
-00019270: 6020 6d65 616e 7320 7072 6566 6978 206d  ` means prefix m
-00019280: 6174 6368 2e0a 2020 2020 2020 2020 6627  atch..        f'
-00019290: 2228 6c61 6265 6c73 2e72 6179 2d63 6c75  "(labels.ray-clu
-000192a0: 7374 6572 2d6e 616d 653a 7b6e 616d 655f  ster-name:{name_
-000192b0: 6f6e 5f63 6c6f 7564 7d29 2220 270a 2020  on_cloud})" '.  
-000192c0: 2020 2020 2020 6627 2d2d 7a6f 6e65 733d        f'--zones=
-000192d0: 7b7a 6f6e 657d 202d 2d66 6f72 6d61 743d  {zone} --format=
-000192e0: 2276 616c 7565 286e 616d 6529 2227 290a  "value(name)"').
-000192f0: 2020 2020 7465 726d 696e 6174 655f 636d      terminate_cm
-00019300: 6420 3d20 2866 2767 636c 6f75 6420 636f  d = (f'gcloud co
-00019310: 6d70 7574 6520 696e 7374 616e 6365 7320  mpute instances 
-00019320: 6465 6c65 7465 202d 2d7a 6f6e 653d 7b7a  delete --zone={z
-00019330: 6f6e 657d 270a 2020 2020 2020 2020 2020  one}'.          
-00019340: 2020 2020 2020 2020 2020 2066 2720 2d2d             f' --
-00019350: 7175 6965 7420 2428 7b71 7565 7279 5f63  quiet $({query_c
-00019360: 6d64 7d29 2729 0a20 2020 2074 6573 7420  md})').    test 
-00019370: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
-00019380: 2773 706f 745f 7265 636f 7665 7279 5f67  'spot_recovery_g
-00019390: 6370 272c 0a20 2020 2020 2020 205b 0a20  cp',.        [. 
-000193a0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-000193b0: 2073 706f 7420 6c61 756e 6368 202d 2d63   spot launch --c
-000193c0: 6c6f 7564 2067 6370 202d 2d7a 6f6e 6520  loud gcp --zone 
-000193d0: 7b7a 6f6e 657d 202d 6e20 7b6e 616d 657d  {zone} -n {name}
-000193e0: 202d 2d63 7075 7320 3220 2265 6368 6f20   --cpus 2 "echo 
-000193f0: 534b 5950 494c 4f54 5f54 4153 4b5f 4944  SKYPILOT_TASK_ID
-00019400: 3a20 5c24 534b 5950 494c 4f54 5f54 4153  : \$SKYPILOT_TAS
-00019410: 4b5f 4944 3b20 736c 6565 7020 3138 3030  K_ID; sleep 1800
-00019420: 2220 202d 7920 2d64 272c 0a20 2020 2020  "  -y -d',.     
-00019430: 2020 2020 2020 2027 736c 6565 7020 3336         'sleep 36
-00019440: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
-00019450: 6627 7b5f 5350 4f54 5f51 5545 5545 5f57  f'{_SPOT_QUEUE_W
-00019460: 4149 547d 7c20 6772 6570 207b 6e61 6d65  AIT}| grep {name
-00019470: 7d20 7c20 6865 6164 202d 6e31 207c 2067  } | head -n1 | g
-00019480: 7265 7020 2252 554e 4e49 4e47 2227 2c0a  rep "RUNNING"',.
-00019490: 2020 2020 2020 2020 2020 2020 6627 5255              f'RU
-000194a0: 4e5f 4944 3d24 2873 6b79 2073 706f 7420  N_ID=$(sky spot 
-000194b0: 6c6f 6773 202d 6e20 7b6e 616d 657d 202d  logs -n {name} -
-000194c0: 2d6e 6f2d 666f 6c6c 6f77 207c 2067 7265  -no-follow | gre
-000194d0: 7020 534b 5950 494c 4f54 5f54 4153 4b5f  p SKYPILOT_TASK_
-000194e0: 4944 207c 2063 7574 202d 643a 202d 6632  ID | cut -d: -f2
-000194f0: 293b 2065 6368 6f20 2224 5255 4e5f 4944  ); echo "$RUN_ID
-00019500: 2220 7c20 7465 6520 2f74 6d70 2f7b 6e61  " | tee /tmp/{na
-00019510: 6d65 7d2d 7275 6e2d 6964 272c 0a20 2020  me}-run-id',.   
-00019520: 2020 2020 2020 2020 2023 2054 6572 6d69           # Termi
-00019530: 6e61 7465 2074 6865 2063 6c75 7374 6572  nate the cluster
-00019540: 206d 616e 7561 6c6c 792e 0a20 2020 2020   manually..     
-00019550: 2020 2020 2020 2074 6572 6d69 6e61 7465         terminate
-00019560: 5f63 6d64 2c0a 2020 2020 2020 2020 2020  _cmd,.          
-00019570: 2020 2773 6c65 6570 2036 3027 2c0a 2020    'sleep 60',.  
-00019580: 2020 2020 2020 2020 2020 6627 7b5f 5350            f'{_SP
-00019590: 4f54 5f51 5545 5545 5f57 4149 547d 7c20  OT_QUEUE_WAIT}| 
-000195a0: 6772 6570 207b 6e61 6d65 7d20 7c20 6865  grep {name} | he
-000195b0: 6164 202d 6e31 207c 2067 7265 7020 2252  ad -n1 | grep "R
-000195c0: 4543 4f56 4552 494e 4722 272c 0a20 2020  ECOVERING"',.   
-000195d0: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
-000195e0: 3230 3027 2c0a 2020 2020 2020 2020 2020  200',.          
-000195f0: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
-00019600: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
-00019610: 6d65 7d20 7c20 6865 6164 202d 6e31 207c  me} | head -n1 |
-00019620: 2067 7265 7020 2252 554e 4e49 4e47 2227   grep "RUNNING"'
-00019630: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00019640: 5255 4e5f 4944 3d24 2863 6174 202f 746d  RUN_ID=$(cat /tm
-00019650: 702f 7b6e 616d 657d 2d72 756e 2d69 6429  p/{name}-run-id)
-00019660: 3b20 6563 686f 2024 5255 4e5f 4944 3b20  ; echo $RUN_ID; 
-00019670: 736b 7920 7370 6f74 206c 6f67 7320 2d6e  sky spot logs -n
-00019680: 207b 6e61 6d65 7d20 2d2d 6e6f 2d66 6f6c   {name} --no-fol
-00019690: 6c6f 7720 7c20 6772 6570 2053 4b59 5049  low | grep SKYPI
-000196a0: 4c4f 545f 5441 534b 5f49 443a 207c 2067  LOT_TASK_ID: | g
-000196b0: 7265 7020 2224 5255 4e5f 4944 2227 2c0a  rep "$RUN_ID"',.
-000196c0: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
-000196d0: 2020 205f 5350 4f54 5f43 414e 4345 4c5f     _SPOT_CANCEL_
-000196e0: 5741 4954 2e66 6f72 6d61 7428 6a6f 625f  WAIT.format(job_
-000196f0: 6e61 6d65 3d6e 616d 6529 2c0a 2020 2020  name=name),.    
-00019700: 2020 2020 7469 6d65 6f75 743d 3235 202a      timeout=25 *
-00019710: 2036 302c 0a20 2020 2029 0a20 2020 2072   60,.    ).    r
-00019720: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
-00019730: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
-00019740: 2e61 7773 0a40 7079 7465 7374 2e6d 6172  .aws.@pytest.mar
-00019750: 6b2e 6d61 6e61 6765 645f 7370 6f74 0a64  k.managed_spot.d
-00019760: 6566 2074 6573 745f 7370 6f74 5f70 6970  ef test_spot_pip
-00019770: 656c 696e 655f 7265 636f 7665 7279 5f61  eline_recovery_a
-00019780: 7773 2861 7773 5f63 6f6e 6669 675f 7265  ws(aws_config_re
-00019790: 6769 6f6e 293a 0a20 2020 2022 2222 5465  gion):.    """Te
-000197a0: 7374 206d 616e 6167 6564 2073 706f 7420  st managed spot 
-000197b0: 7265 636f 7665 7279 2066 6f72 2061 2070  recovery for a p
-000197c0: 6970 656c 696e 652e 2222 220a 2020 2020  ipeline.""".    
-000197d0: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
-000197e0: 7465 725f 6e61 6d65 2829 0a20 2020 2075  ter_name().    u
-000197f0: 7365 725f 6861 7368 203d 2063 6f6d 6d6f  ser_hash = commo
-00019800: 6e5f 7574 696c 732e 6765 745f 7573 6572  n_utils.get_user
-00019810: 5f68 6173 6828 290a 2020 2020 7573 6572  _hash().    user
-00019820: 5f68 6173 6820 3d20 7573 6572 5f68 6173  _hash = user_has
-00019830: 685b 3a63 6f6d 6d6f 6e5f 7574 696c 732e  h[:common_utils.
-00019840: 5553 4552 5f48 4153 485f 4c45 4e47 5448  USER_HASH_LENGTH
-00019850: 5f49 4e5f 434c 5553 5445 525f 4e41 4d45  _IN_CLUSTER_NAME
-00019860: 5d0a 2020 2020 7265 6769 6f6e 203d 2061  ].    region = a
-00019870: 7773 5f63 6f6e 6669 675f 7265 6769 6f6e  ws_config_region
-00019880: 0a20 2020 2069 6620 7265 6769 6f6e 2021  .    if region !
-00019890: 3d20 2775 732d 6561 7374 2d32 273a 0a20  = 'us-east-2':. 
-000198a0: 2020 2020 2020 2070 7974 6573 742e 736b         pytest.sk
-000198b0: 6970 2827 4f6e 6c79 2072 756e 2073 706f  ip('Only run spo
-000198c0: 7420 7069 7065 6c69 6e65 2072 6563 6f76  t pipeline recov
-000198d0: 6572 7920 7465 7374 2069 6e20 7573 2d65  ery test in us-e
-000198e0: 6173 742d 3227 290a 2020 2020 7465 7374  ast-2').    test
-000198f0: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-00019900: 2027 7370 6f74 5f70 6970 656c 696e 655f   'spot_pipeline_
-00019910: 7265 636f 7665 7279 5f61 7773 272c 0a20  recovery_aws',. 
-00019920: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-00019930: 2020 2020 2066 2773 6b79 2073 706f 7420       f'sky spot 
-00019940: 6c61 756e 6368 202d 6e20 7b6e 616d 657d  launch -n {name}
-00019950: 2074 6573 7473 2f74 6573 745f 7961 6d6c   tests/test_yaml
-00019960: 732f 7069 7065 6c69 6e65 5f61 7773 2e79  s/pipeline_aws.y
-00019970: 616d 6c20 202d 7920 2d64 272c 0a20 2020  aml  -y -d',.   
-00019980: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
-00019990: 3430 3027 2c0a 2020 2020 2020 2020 2020  400',.          
-000199a0: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
-000199b0: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
-000199c0: 6d65 7d20 7c20 6865 6164 202d 6e31 207c  me} | head -n1 |
-000199d0: 2067 7265 7020 2252 554e 4e49 4e47 2227   grep "RUNNING"'
-000199e0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-000199f0: 5255 4e5f 4944 3d24 2873 6b79 2073 706f  RUN_ID=$(sky spo
-00019a00: 7420 6c6f 6773 202d 6e20 7b6e 616d 657d  t logs -n {name}
-00019a10: 202d 2d6e 6f2d 666f 6c6c 6f77 207c 2067   --no-follow | g
-00019a20: 7265 7020 534b 5950 494c 4f54 5f54 4153  rep SKYPILOT_TAS
-00019a30: 4b5f 4944 3a20 7c20 6375 7420 2d64 3a20  K_ID: | cut -d: 
-00019a40: 2d66 3229 3b20 6563 686f 2022 2452 554e  -f2); echo "$RUN
-00019a50: 5f49 4422 207c 2074 6565 202f 746d 702f  _ID" | tee /tmp/
-00019a60: 7b6e 616d 657d 2d72 756e 2d69 6427 2c0a  {name}-run-id',.
-00019a70: 2020 2020 2020 2020 2020 2020 6627 5255              f'RU
-00019a80: 4e5f 4944 533d 2428 736b 7920 7370 6f74  N_IDS=$(sky spot
-00019a90: 206c 6f67 7320 2d6e 207b 6e61 6d65 7d20   logs -n {name} 
-00019aa0: 2d2d 6e6f 2d66 6f6c 6c6f 7720 7c20 6772  --no-follow | gr
-00019ab0: 6570 202d 4120 3420 534b 5950 494c 4f54  ep -A 4 SKYPILOT
-00019ac0: 5f54 4153 4b5f 4944 5320 7c20 6375 7420  _TASK_IDS | cut 
-00019ad0: 2d64 2229 2220 2d66 3229 3b20 6563 686f  -d")" -f2); echo
-00019ae0: 2022 2452 554e 5f49 4453 2220 7c20 7465   "$RUN_IDS" | te
-00019af0: 6520 2f74 6d70 2f7b 6e61 6d65 7d2d 7275  e /tmp/{name}-ru
-00019b00: 6e2d 6964 7327 2c0a 2020 2020 2020 2020  n-ids',.        
-00019b10: 2020 2020 2320 5465 726d 696e 6174 6520      # Terminate 
-00019b20: 7468 6520 636c 7573 7465 7220 6d61 6e75  the cluster manu
-00019b30: 616c 6c79 2e0a 2020 2020 2020 2020 2020  ally..          
-00019b40: 2020 2320 5468 6520 6063 6174 202e 2e2e    # The `cat ...
-00019b50: 7c20 7265 7660 2069 7320 746f 2072 6574  | rev` is to ret
-00019b60: 7269 6576 6520 7468 6520 6a6f 625f 6964  rieve the job_id
-00019b70: 2066 726f 6d20 7468 650a 2020 2020 2020   from the.      
-00019b80: 2020 2020 2020 2320 534b 5950 494c 4f54        # SKYPILOT
-00019b90: 5f54 4153 4b5f 4944 2c20 7768 6963 6820  _TASK_ID, which 
-00019ba0: 6765 7473 2074 6865 2073 6563 6f6e 6420  gets the second 
-00019bb0: 746f 206c 6173 7420 6669 656c 640a 2020  to last field.  
-00019bc0: 2020 2020 2020 2020 2020 2320 7365 7061            # sepa
-00019bd0: 7261 7465 6420 6279 2060 2d60 2e0a 2020  rated by `-`..  
-00019be0: 2020 2020 2020 2020 2020 280a 2020 2020            (.    
-00019bf0: 2020 2020 2020 2020 2020 2020 6627 5350              f'SP
-00019c00: 4f54 5f4a 4f42 5f49 443d 6063 6174 202f  OT_JOB_ID=`cat /
-00019c10: 746d 702f 7b6e 616d 657d 2d72 756e 2d69  tmp/{name}-run-i
-00019c20: 6420 7c20 7265 7620 7c20 270a 2020 2020  d | rev | '.    
-00019c30: 2020 2020 2020 2020 2020 2020 2763 7574              'cut
-00019c40: 202d 645c 275f 5c27 202d 6631 207c 2072   -d\'_\' -f1 | r
-00019c50: 6576 207c 2063 7574 202d 645c 272d 5c27  ev | cut -d\'-\'
-00019c60: 202d 6631 603b 270a 2020 2020 2020 2020   -f1`;'.        
-00019c70: 2020 2020 2020 2020 6627 6177 7320 6563          f'aws ec
-00019c80: 3220 7465 726d 696e 6174 652d 696e 7374  2 terminate-inst
-00019c90: 616e 6365 7320 2d2d 7265 6769 6f6e 207b  ances --region {
-00019ca0: 7265 6769 6f6e 7d20 2d2d 696e 7374 616e  region} --instan
-00019cb0: 6365 2d69 6473 2024 2827 0a20 2020 2020  ce-ids $('.     
-00019cc0: 2020 2020 2020 2020 2020 2066 2761 7773             f'aws
-00019cd0: 2065 6332 2064 6573 6372 6962 652d 696e   ec2 describe-in
-00019ce0: 7374 616e 6365 7320 2d2d 7265 6769 6f6e  stances --region
-00019cf0: 207b 7265 6769 6f6e 7d20 270a 2020 2020   {region} '.    
-00019d00: 2020 2020 2020 2020 2020 2020 2320 544f              # TO
-00019d10: 444f 287a 6877 7529 3a20 6669 7820 7468  DO(zhwu): fix th
-00019d20: 6520 6e61 6d65 2066 6f72 2073 706f 7420  e name for spot 
-00019d30: 636c 7573 7465 722e 0a20 2020 2020 2020  cluster..       
-00019d40: 2020 2020 2020 2020 2027 2d2d 6669 6c74           '--filt
-00019d50: 6572 7320 4e61 6d65 3d74 6167 3a72 6179  ers Name=tag:ray
-00019d60: 2d63 6c75 7374 6572 2d6e 616d 652c 5661  -cluster-name,Va
-00019d70: 6c75 6573 3d2a 2d24 7b53 504f 545f 4a4f  lues=*-${SPOT_JO
-00019d80: 425f 4944 7d27 0a20 2020 2020 2020 2020  B_ID}'.         
-00019d90: 2020 2020 2020 2066 272d 7b75 7365 725f         f'-{user_
-00019da0: 6861 7368 7d20 270a 2020 2020 2020 2020  hash} '.        
-00019db0: 2020 2020 2020 2020 6627 2d2d 7175 6572          f'--quer
-00019dc0: 7920 5265 7365 7276 6174 696f 6e73 5b5d  y Reservations[]
-00019dd0: 2e49 6e73 7461 6e63 6573 5b5d 2e49 6e73  .Instances[].Ins
-00019de0: 7461 6e63 6549 6420 270a 2020 2020 2020  tanceId '.      
-00019df0: 2020 2020 2020 2020 2020 272d 2d6f 7574            '--out
-00019e00: 7075 7420 7465 7874 2927 292c 0a20 2020  put text)'),.   
-00019e10: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
-00019e20: 3130 3027 2c0a 2020 2020 2020 2020 2020  100',.          
-00019e30: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
-00019e40: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
-00019e50: 6d65 7d20 7c20 6865 6164 202d 6e31 207c  me} | head -n1 |
-00019e60: 2067 7265 7020 2252 4543 4f56 4552 494e   grep "RECOVERIN
-00019e70: 4722 272c 0a20 2020 2020 2020 2020 2020  G"',.           
-00019e80: 2027 736c 6565 7020 3230 3027 2c0a 2020   'sleep 200',.  
-00019e90: 2020 2020 2020 2020 2020 6627 7b5f 5350            f'{_SP
-00019ea0: 4f54 5f51 5545 5545 5f57 4149 547d 7c20  OT_QUEUE_WAIT}| 
-00019eb0: 6772 6570 207b 6e61 6d65 7d20 7c20 6865  grep {name} | he
-00019ec0: 6164 202d 6e31 207c 2067 7265 7020 2252  ad -n1 | grep "R
-00019ed0: 554e 4e49 4e47 2227 2c0a 2020 2020 2020  UNNING"',.      
-00019ee0: 2020 2020 2020 6627 5255 4e5f 4944 3d24        f'RUN_ID=$
-00019ef0: 2863 6174 202f 746d 702f 7b6e 616d 657d  (cat /tmp/{name}
-00019f00: 2d72 756e 2d69 6429 3b20 6563 686f 2024  -run-id); echo $
-00019f10: 5255 4e5f 4944 3b20 736b 7920 7370 6f74  RUN_ID; sky spot
-00019f20: 206c 6f67 7320 2d6e 207b 6e61 6d65 7d20   logs -n {name} 
-00019f30: 2d2d 6e6f 2d66 6f6c 6c6f 7720 7c20 6772  --no-follow | gr
-00019f40: 6570 2053 4b59 5049 4c4f 545f 5441 534b  ep SKYPILOT_TASK
-00019f50: 5f49 443a 207c 2067 7265 7020 2224 5255  _ID: | grep "$RU
-00019f60: 4e5f 4944 2227 2c0a 2020 2020 2020 2020  N_ID"',.        
-00019f70: 2020 2020 6627 5255 4e5f 4944 533d 2428      f'RUN_IDS=$(
-00019f80: 736b 7920 7370 6f74 206c 6f67 7320 2d6e  sky spot logs -n
-00019f90: 207b 6e61 6d65 7d20 2d2d 6e6f 2d66 6f6c   {name} --no-fol
-00019fa0: 6c6f 7720 7c20 6772 6570 202d 4120 3420  low | grep -A 4 
-00019fb0: 534b 5950 494c 4f54 5f54 4153 4b5f 4944  SKYPILOT_TASK_ID
-00019fc0: 5320 7c20 6375 7420 2d64 2229 2220 2d66  S | cut -d")" -f
-00019fd0: 3229 3b20 6563 686f 2022 2452 554e 5f49  2); echo "$RUN_I
-00019fe0: 4453 2220 7c20 7465 6520 2f74 6d70 2f7b  DS" | tee /tmp/{
-00019ff0: 6e61 6d65 7d2d 7275 6e2d 6964 732d 6e65  name}-run-ids-ne
-0001a000: 7727 2c0a 2020 2020 2020 2020 2020 2020  w',.            
-0001a010: 6627 6469 6666 202f 746d 702f 7b6e 616d  f'diff /tmp/{nam
-0001a020: 657d 2d72 756e 2d69 6473 202f 746d 702f  e}-run-ids /tmp/
-0001a030: 7b6e 616d 657d 2d72 756e 2d69 6473 2d6e  {name}-run-ids-n
-0001a040: 6577 272c 0a20 2020 2020 2020 2020 2020  ew',.           
-0001a050: 2066 2763 6174 202f 746d 702f 7b6e 616d   f'cat /tmp/{nam
-0001a060: 657d 2d72 756e 2d69 6473 207c 2073 6564  e}-run-ids | sed
-0001a070: 202d 6e20 3270 207c 2067 7265 7020 6063   -n 2p | grep `c
-0001a080: 6174 202f 746d 702f 7b6e 616d 657d 2d72  at /tmp/{name}-r
-0001a090: 756e 2d69 6460 272c 0a20 2020 2020 2020  un-id`',.       
-0001a0a0: 205d 2c0a 2020 2020 2020 2020 5f53 504f   ],.        _SPO
-0001a0b0: 545f 4341 4e43 454c 5f57 4149 542e 666f  T_CANCEL_WAIT.fo
-0001a0c0: 726d 6174 286a 6f62 5f6e 616d 653d 6e61  rmat(job_name=na
-0001a0d0: 6d65 292c 0a20 2020 2020 2020 2074 696d  me),.        tim
-0001a0e0: 656f 7574 3d32 3520 2a20 3630 2c0a 2020  eout=25 * 60,.  
-0001a0f0: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
-0001a100: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
-0001a110: 7465 7374 2e6d 6172 6b2e 6763 700a 4070  test.mark.gcp.@p
-0001a120: 7974 6573 742e 6d61 726b 2e6d 616e 6167  ytest.mark.manag
-0001a130: 6564 5f73 706f 740a 6465 6620 7465 7374  ed_spot.def test
-0001a140: 5f73 706f 745f 7069 7065 6c69 6e65 5f72  _spot_pipeline_r
-0001a150: 6563 6f76 6572 795f 6763 7028 293a 0a20  ecovery_gcp():. 
-0001a160: 2020 2022 2222 5465 7374 206d 616e 6167     """Test manag
-0001a170: 6564 2073 706f 7420 7265 636f 7665 7279  ed spot recovery
-0001a180: 2066 6f72 2061 2070 6970 656c 696e 652e   for a pipeline.
-0001a190: 2222 220a 2020 2020 6e61 6d65 203d 205f  """.    name = _
-0001a1a0: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
-0001a1b0: 2829 0a20 2020 207a 6f6e 6520 3d20 2775  ().    zone = 'u
-0001a1c0: 732d 6561 7374 342d 6227 0a20 2020 2075  s-east4-b'.    u
-0001a1d0: 7365 725f 6861 7368 203d 2063 6f6d 6d6f  ser_hash = commo
-0001a1e0: 6e5f 7574 696c 732e 6765 745f 7573 6572  n_utils.get_user
-0001a1f0: 5f68 6173 6828 290a 2020 2020 7573 6572  _hash().    user
-0001a200: 5f68 6173 6820 3d20 7573 6572 5f68 6173  _hash = user_has
-0001a210: 685b 3a63 6f6d 6d6f 6e5f 7574 696c 732e  h[:common_utils.
-0001a220: 5553 4552 5f48 4153 485f 4c45 4e47 5448  USER_HASH_LENGTH
-0001a230: 5f49 4e5f 434c 5553 5445 525f 4e41 4d45  _IN_CLUSTER_NAME
-0001a240: 5d0a 2020 2020 7175 6572 795f 636d 6420  ].    query_cmd 
-0001a250: 3d20 2827 6763 6c6f 7564 2063 6f6d 7075  = ('gcloud compu
-0001a260: 7465 2069 6e73 7461 6e63 6573 206c 6973  te instances lis
-0001a270: 7420 2d2d 6669 6c74 6572 3d27 0a20 2020  t --filter='.   
-0001a280: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-0001a290: 2228 6c61 6265 6c73 2e72 6179 2d63 6c75  "(labels.ray-clu
-0001a2a0: 7374 6572 2d6e 616d 653a 2a2d 247b 7b53  ster-name:*-${{S
-0001a2b0: 504f 545f 4a4f 425f 4944 7d7d 2d7b 7573  POT_JOB_ID}}-{us
-0001a2c0: 6572 5f68 6173 687d 2922 2027 0a20 2020  er_hash})" '.   
-0001a2d0: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-0001a2e0: 2d2d 7a6f 6e65 733d 7b7a 6f6e 657d 202d  --zones={zone} -
-0001a2f0: 2d66 6f72 6d61 743d 2276 616c 7565 286e  -format="value(n
-0001a300: 616d 6529 2227 290a 2020 2020 7465 726d  ame)"').    term
-0001a310: 696e 6174 655f 636d 6420 3d20 2866 2767  inate_cmd = (f'g
-0001a320: 636c 6f75 6420 636f 6d70 7574 6520 696e  cloud compute in
-0001a330: 7374 616e 6365 7320 6465 6c65 7465 202d  stances delete -
-0001a340: 2d7a 6f6e 653d 7b7a 6f6e 657d 270a 2020  -zone={zone}'.  
-0001a350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a360: 2020 2066 2720 2d2d 7175 6965 7420 2428     f' --quiet $(
-0001a370: 7b71 7565 7279 5f63 6d64 7d29 2729 0a20  {query_cmd})'). 
-0001a380: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
-0001a390: 2020 2020 2020 2020 2773 706f 745f 7069          'spot_pi
-0001a3a0: 7065 6c69 6e65 5f72 6563 6f76 6572 795f  peline_recovery_
-0001a3b0: 6763 7027 2c0a 2020 2020 2020 2020 5b0a  gcp',.        [.
-0001a3c0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0001a3d0: 7920 7370 6f74 206c 6175 6e63 6820 2d6e  y spot launch -n
-0001a3e0: 207b 6e61 6d65 7d20 7465 7374 732f 7465   {name} tests/te
-0001a3f0: 7374 5f79 616d 6c73 2f70 6970 656c 696e  st_yamls/pipelin
-0001a400: 655f 6763 702e 7961 6d6c 2020 2d79 202d  e_gcp.yaml  -y -
-0001a410: 6427 2c0a 2020 2020 2020 2020 2020 2020  d',.            
-0001a420: 2773 6c65 6570 2034 3030 272c 0a20 2020  'sleep 400',.   
-0001a430: 2020 2020 2020 2020 2066 277b 5f53 504f           f'{_SPO
-0001a440: 545f 5155 4555 455f 5741 4954 7d7c 2067  T_QUEUE_WAIT}| g
-0001a450: 7265 7020 7b6e 616d 657d 207c 2068 6561  rep {name} | hea
-0001a460: 6420 2d6e 3120 7c20 6772 6570 2022 5255  d -n1 | grep "RU
-0001a470: 4e4e 494e 4722 272c 0a20 2020 2020 2020  NNING"',.       
-0001a480: 2020 2020 2066 2752 554e 5f49 443d 2428       f'RUN_ID=$(
-0001a490: 736b 7920 7370 6f74 206c 6f67 7320 2d6e  sky spot logs -n
-0001a4a0: 207b 6e61 6d65 7d20 2d2d 6e6f 2d66 6f6c   {name} --no-fol
-0001a4b0: 6c6f 7720 7c20 6772 6570 2053 4b59 5049  low | grep SKYPI
-0001a4c0: 4c4f 545f 5441 534b 5f49 443a 207c 2063  LOT_TASK_ID: | c
-0001a4d0: 7574 202d 643a 202d 6632 293b 2065 6368  ut -d: -f2); ech
-0001a4e0: 6f20 2224 5255 4e5f 4944 2220 7c20 7465  o "$RUN_ID" | te
-0001a4f0: 6520 2f74 6d70 2f7b 6e61 6d65 7d2d 7275  e /tmp/{name}-ru
-0001a500: 6e2d 6964 272c 0a20 2020 2020 2020 2020  n-id',.         
-0001a510: 2020 2066 2752 554e 5f49 4453 3d24 2873     f'RUN_IDS=$(s
-0001a520: 6b79 2073 706f 7420 6c6f 6773 202d 6e20  ky spot logs -n 
-0001a530: 7b6e 616d 657d 202d 2d6e 6f2d 666f 6c6c  {name} --no-foll
-0001a540: 6f77 207c 2067 7265 7020 2d41 2034 2053  ow | grep -A 4 S
-0001a550: 4b59 5049 4c4f 545f 5441 534b 5f49 4453  KYPILOT_TASK_IDS
-0001a560: 207c 2063 7574 202d 6422 2922 202d 6632   | cut -d")" -f2
-0001a570: 293b 2065 6368 6f20 2224 5255 4e5f 4944  ); echo "$RUN_ID
-0001a580: 5322 207c 2074 6565 202f 746d 702f 7b6e  S" | tee /tmp/{n
-0001a590: 616d 657d 2d72 756e 2d69 6473 272c 0a20  ame}-run-ids',. 
-0001a5a0: 2020 2020 2020 2020 2020 2023 2054 6572             # Ter
-0001a5b0: 6d69 6e61 7465 2074 6865 2063 6c75 7374  minate the clust
-0001a5c0: 6572 206d 616e 7561 6c6c 792e 0a20 2020  er manually..   
-0001a5d0: 2020 2020 2020 2020 2023 2054 6865 2060           # The `
-0001a5e0: 6361 7420 2e2e 2e7c 2072 6576 6020 6973  cat ...| rev` is
-0001a5f0: 2074 6f20 7265 7472 6965 7665 2074 6865   to retrieve the
-0001a600: 206a 6f62 5f69 6420 6672 6f6d 2074 6865   job_id from the
-0001a610: 0a20 2020 2020 2020 2020 2020 2023 2053  .            # S
-0001a620: 4b59 5049 4c4f 545f 5441 534b 5f49 442c  KYPILOT_TASK_ID,
-0001a630: 2077 6869 6368 2067 6574 7320 7468 6520   which gets the 
-0001a640: 7365 636f 6e64 2074 6f20 6c61 7374 2066  second to last f
-0001a650: 6965 6c64 0a20 2020 2020 2020 2020 2020  ield.           
-0001a660: 2023 2073 6570 6172 6174 6564 2062 7920   # separated by 
-0001a670: 602d 602e 0a20 2020 2020 2020 2020 2020  `-`..           
-0001a680: 2028 6627 5350 4f54 5f4a 4f42 5f49 443d   (f'SPOT_JOB_ID=
-0001a690: 6063 6174 202f 746d 702f 7b6e 616d 657d  `cat /tmp/{name}
-0001a6a0: 2d72 756e 2d69 6420 7c20 7265 7620 7c20  -run-id | rev | 
-0001a6b0: 270a 2020 2020 2020 2020 2020 2020 2066  '.             f
-0001a6c0: 2763 7574 202d 645c 275f 5c27 202d 6631  'cut -d\'_\' -f1
-0001a6d0: 207c 2072 6576 207c 2063 7574 202d 645c   | rev | cut -d\
-0001a6e0: 272d 5c27 202d 6631 603b 207b 7465 726d  '-\' -f1`; {term
-0001a6f0: 696e 6174 655f 636d 647d 2729 2c0a 2020  inate_cmd}'),.  
-0001a700: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
-0001a710: 2036 3027 2c0a 2020 2020 2020 2020 2020   60',.          
-0001a720: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
-0001a730: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
-0001a740: 6d65 7d20 7c20 6865 6164 202d 6e31 207c  me} | head -n1 |
-0001a750: 2067 7265 7020 2252 4543 4f56 4552 494e   grep "RECOVERIN
-0001a760: 4722 272c 0a20 2020 2020 2020 2020 2020  G"',.           
-0001a770: 2027 736c 6565 7020 3230 3027 2c0a 2020   'sleep 200',.  
-0001a780: 2020 2020 2020 2020 2020 6627 7b5f 5350            f'{_SP
-0001a790: 4f54 5f51 5545 5545 5f57 4149 547d 7c20  OT_QUEUE_WAIT}| 
-0001a7a0: 6772 6570 207b 6e61 6d65 7d20 7c20 6865  grep {name} | he
-0001a7b0: 6164 202d 6e31 207c 2067 7265 7020 2252  ad -n1 | grep "R
-0001a7c0: 554e 4e49 4e47 2227 2c0a 2020 2020 2020  UNNING"',.      
-0001a7d0: 2020 2020 2020 6627 5255 4e5f 4944 3d24        f'RUN_ID=$
-0001a7e0: 2863 6174 202f 746d 702f 7b6e 616d 657d  (cat /tmp/{name}
-0001a7f0: 2d72 756e 2d69 6429 3b20 6563 686f 2024  -run-id); echo $
-0001a800: 5255 4e5f 4944 3b20 736b 7920 7370 6f74  RUN_ID; sky spot
-0001a810: 206c 6f67 7320 2d6e 207b 6e61 6d65 7d20   logs -n {name} 
-0001a820: 2d2d 6e6f 2d66 6f6c 6c6f 7720 7c20 6772  --no-follow | gr
-0001a830: 6570 2053 4b59 5049 4c4f 545f 5441 534b  ep SKYPILOT_TASK
-0001a840: 5f49 443a 207c 2067 7265 7020 2224 5255  _ID: | grep "$RU
-0001a850: 4e5f 4944 2227 2c0a 2020 2020 2020 2020  N_ID"',.        
-0001a860: 2020 2020 6627 5255 4e5f 4944 533d 2428      f'RUN_IDS=$(
-0001a870: 736b 7920 7370 6f74 206c 6f67 7320 2d6e  sky spot logs -n
-0001a880: 207b 6e61 6d65 7d20 2d2d 6e6f 2d66 6f6c   {name} --no-fol
-0001a890: 6c6f 7720 7c20 6772 6570 202d 4120 3420  low | grep -A 4 
-0001a8a0: 534b 5950 494c 4f54 5f54 4153 4b5f 4944  SKYPILOT_TASK_ID
-0001a8b0: 5320 7c20 6375 7420 2d64 2229 2220 2d66  S | cut -d")" -f
-0001a8c0: 3229 3b20 6563 686f 2022 2452 554e 5f49  2); echo "$RUN_I
-0001a8d0: 4453 2220 7c20 7465 6520 2f74 6d70 2f7b  DS" | tee /tmp/{
-0001a8e0: 6e61 6d65 7d2d 7275 6e2d 6964 732d 6e65  name}-run-ids-ne
-0001a8f0: 7727 2c0a 2020 2020 2020 2020 2020 2020  w',.            
-0001a900: 6627 6469 6666 202f 746d 702f 7b6e 616d  f'diff /tmp/{nam
-0001a910: 657d 2d72 756e 2d69 6473 202f 746d 702f  e}-run-ids /tmp/
-0001a920: 7b6e 616d 657d 2d72 756e 2d69 6473 2d6e  {name}-run-ids-n
-0001a930: 6577 272c 0a20 2020 2020 2020 2020 2020  ew',.           
-0001a940: 2066 2763 6174 202f 746d 702f 7b6e 616d   f'cat /tmp/{nam
-0001a950: 657d 2d72 756e 2d69 6473 207c 2073 6564  e}-run-ids | sed
-0001a960: 202d 6e20 3270 207c 2067 7265 7020 6063   -n 2p | grep `c
-0001a970: 6174 202f 746d 702f 7b6e 616d 657d 2d72  at /tmp/{name}-r
-0001a980: 756e 2d69 6460 272c 0a20 2020 2020 2020  un-id`',.       
-0001a990: 205d 2c0a 2020 2020 2020 2020 5f53 504f   ],.        _SPO
-0001a9a0: 545f 4341 4e43 454c 5f57 4149 542e 666f  T_CANCEL_WAIT.fo
-0001a9b0: 726d 6174 286a 6f62 5f6e 616d 653d 6e61  rmat(job_name=na
-0001a9c0: 6d65 292c 0a20 2020 2020 2020 2074 696d  me),.        tim
-0001a9d0: 656f 7574 3d32 3520 2a20 3630 2c0a 2020  eout=25 * 60,.  
-0001a9e0: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
-0001a9f0: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
-0001aa00: 7465 7374 2e6d 6172 6b2e 6e6f 5f66 6c75  test.mark.no_flu
-0001aa10: 6964 7374 6163 6b20 2023 2046 6c75 6964  idstack  # Fluid
-0001aa20: 7374 6163 6b20 646f 6573 206e 6f74 2073  stack does not s
-0001aa30: 7570 706f 7274 2073 706f 7420 696e 7374  upport spot inst
-0001aa40: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
-0001aa50: 726b 2e6e 6f5f 617a 7572 6520 2023 2041  rk.no_azure  # A
-0001aa60: 7a75 7265 2064 6f65 7320 6e6f 7420 7375  zure does not su
-0001aa70: 7070 6f72 7420 7370 6f74 2069 6e73 7461  pport spot insta
-0001aa80: 6e63 6573 0a40 7079 7465 7374 2e6d 6172  nces.@pytest.mar
-0001aa90: 6b2e 6e6f 5f6c 616d 6264 615f 636c 6f75  k.no_lambda_clou
-0001aaa0: 6420 2023 204c 616d 6264 6120 436c 6f75  d  # Lambda Clou
-0001aab0: 6420 646f 6573 206e 6f74 2073 7570 706f  d does not suppo
-0001aac0: 7274 2073 706f 7420 696e 7374 616e 6365  rt spot instance
-0001aad0: 730a 4070 7974 6573 742e 6d61 726b 2e6e  s.@pytest.mark.n
-0001aae0: 6f5f 6962 6d20 2023 2049 424d 2043 6c6f  o_ibm  # IBM Clo
-0001aaf0: 7564 2064 6f65 7320 6e6f 7420 7375 7070  ud does not supp
-0001ab00: 6f72 7420 7370 6f74 2069 6e73 7461 6e63  ort spot instanc
-0001ab10: 6573 0a40 7079 7465 7374 2e6d 6172 6b2e  es.@pytest.mark.
-0001ab20: 6e6f 5f73 6370 2020 2320 5343 5020 646f  no_scp  # SCP do
-0001ab30: 6573 206e 6f74 2073 7570 706f 7274 2073  es not support s
-0001ab40: 706f 7420 696e 7374 616e 6365 730a 4070  pot instances.@p
-0001ab50: 7974 6573 742e 6d61 726b 2e6e 6f5f 7061  ytest.mark.no_pa
-0001ab60: 7065 7273 7061 6365 2020 2320 5061 7065  perspace  # Pape
-0001ab70: 7273 7061 6365 2064 6f65 7320 6e6f 7420  rspace does not 
-0001ab80: 7375 7070 6f72 7420 7370 6f74 2069 6e73  support spot ins
-0001ab90: 7461 6e63 6573 0a40 7079 7465 7374 2e6d  tances.@pytest.m
-0001aba0: 6172 6b2e 6e6f 5f6b 7562 6572 6e65 7465  ark.no_kubernete
-0001abb0: 7320 2023 204b 7562 6572 6e65 7465 7320  s  # Kubernetes 
-0001abc0: 646f 6573 206e 6f74 2068 6176 6520 6120  does not have a 
-0001abd0: 6e6f 7469 6f6e 206f 6620 7370 6f74 2069  notion of spot i
-0001abe0: 6e73 7461 6e63 6573 0a40 7079 7465 7374  nstances.@pytest
-0001abf0: 2e6d 6172 6b2e 6d61 6e61 6765 645f 7370  .mark.managed_sp
-0001ac00: 6f74 0a64 6566 2074 6573 745f 7370 6f74  ot.def test_spot
-0001ac10: 5f72 6563 6f76 6572 795f 6465 6661 756c  _recovery_defaul
-0001ac20: 745f 7265 736f 7572 6365 7328 6765 6e65  t_resources(gene
-0001ac30: 7269 635f 636c 6f75 643a 2073 7472 293a  ric_cloud: str):
-0001ac40: 0a20 2020 2022 2222 5465 7374 206d 616e  .    """Test man
-0001ac50: 6167 6564 2073 706f 7420 7265 636f 7665  aged spot recove
-0001ac60: 7279 2066 6f72 2064 6566 6175 6c74 2072  ry for default r
-0001ac70: 6573 6f75 7263 6573 2e22 2222 0a20 2020  esources.""".   
-0001ac80: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
-0001ac90: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
-0001aca0: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
-0001acb0: 2020 2020 2027 6d61 6e61 6765 642d 7370       'managed-sp
-0001acc0: 6f74 2d72 6563 6f76 6572 792d 6465 6661  ot-recovery-defa
-0001acd0: 756c 742d 7265 736f 7572 6365 7327 2c0a  ult-resources',.
-0001ace0: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
-0001acf0: 2020 2020 2020 6627 736b 7920 7370 6f74        f'sky spot
-0001ad00: 206c 6175 6e63 6820 2d6e 207b 6e61 6d65   launch -n {name
-0001ad10: 7d20 2d2d 636c 6f75 6420 7b67 656e 6572  } --cloud {gener
-0001ad20: 6963 5f63 6c6f 7564 7d20 2273 6c65 6570  ic_cloud} "sleep
-0001ad30: 2033 3020 2626 2073 7564 6f20 7368 7574   30 && sudo shut
-0001ad40: 646f 776e 206e 6f77 2026 2620 736c 6565  down now && slee
-0001ad50: 7020 3130 3030 2220 2d79 202d 6427 2c0a  p 1000" -y -d',.
-0001ad60: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
-0001ad70: 6570 2033 3630 272c 0a20 2020 2020 2020  ep 360',.       
-0001ad80: 2020 2020 2066 277b 5f53 504f 545f 5155       f'{_SPOT_QU
-0001ad90: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
-0001ada0: 7b6e 616d 657d 207c 2068 6561 6420 2d6e  {name} | head -n
-0001adb0: 3120 7c20 6772 6570 2022 5255 4e4e 494e  1 | grep "RUNNIN
-0001adc0: 475c 7c52 4543 4f56 4552 494e 4722 272c  G\|RECOVERING"',
-0001add0: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
-0001ade0: 2020 2020 5f53 504f 545f 4341 4e43 454c      _SPOT_CANCEL
-0001adf0: 5f57 4149 542e 666f 726d 6174 286a 6f62  _WAIT.format(job
-0001ae00: 5f6e 616d 653d 6e61 6d65 292c 0a20 2020  _name=name),.   
-0001ae10: 2020 2020 2074 696d 656f 7574 3d32 3520       timeout=25 
-0001ae20: 2a20 3630 2c0a 2020 2020 290a 2020 2020  * 60,.    ).    
-0001ae30: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-0001ae40: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
-0001ae50: 6b2e 6177 730a 4070 7974 6573 742e 6d61  k.aws.@pytest.ma
-0001ae60: 726b 2e6d 616e 6167 6564 5f73 706f 740a  rk.managed_spot.
-0001ae70: 6465 6620 7465 7374 5f73 706f 745f 7265  def test_spot_re
-0001ae80: 636f 7665 7279 5f6d 756c 7469 5f6e 6f64  covery_multi_nod
-0001ae90: 655f 6177 7328 6177 735f 636f 6e66 6967  e_aws(aws_config
-0001aea0: 5f72 6567 696f 6e29 3a0a 2020 2020 2222  _region):.    ""
-0001aeb0: 2254 6573 7420 6d61 6e61 6765 6420 7370  "Test managed sp
-0001aec0: 6f74 2072 6563 6f76 6572 792e 2222 220a  ot recovery.""".
-0001aed0: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
-0001aee0: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
-0001aef0: 2020 206e 616d 655f 6f6e 5f63 6c6f 7564     name_on_cloud
-0001af00: 203d 2063 6f6d 6d6f 6e5f 7574 696c 732e   = common_utils.
-0001af10: 6d61 6b65 5f63 6c75 7374 6572 5f6e 616d  make_cluster_nam
-0001af20: 655f 6f6e 5f63 6c6f 7564 280a 2020 2020  e_on_cloud(.    
-0001af30: 2020 2020 6e61 6d65 2c20 7370 6f74 2e53      name, spot.S
-0001af40: 504f 545f 434c 5553 5445 525f 4e41 4d45  POT_CLUSTER_NAME
-0001af50: 5f50 5245 4649 585f 4c45 4e47 5448 2c20  _PREFIX_LENGTH, 
-0001af60: 6164 645f 7573 6572 5f68 6173 683d 4661  add_user_hash=Fa
-0001af70: 6c73 6529 0a20 2020 2072 6567 696f 6e20  lse).    region 
-0001af80: 3d20 6177 735f 636f 6e66 6967 5f72 6567  = aws_config_reg
-0001af90: 696f 6e0a 2020 2020 7465 7374 203d 2054  ion.    test = T
-0001afa0: 6573 7428 0a20 2020 2020 2020 2027 7370  est(.        'sp
-0001afb0: 6f74 5f72 6563 6f76 6572 795f 6d75 6c74  ot_recovery_mult
-0001afc0: 695f 6e6f 6465 5f61 7773 272c 0a20 2020  i_node_aws',.   
-0001afd0: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
-0001afe0: 2020 2066 2773 6b79 2073 706f 7420 6c61     f'sky spot la
-0001aff0: 756e 6368 202d 2d63 6c6f 7564 2061 7773  unch --cloud aws
-0001b000: 202d 2d72 6567 696f 6e20 7b72 6567 696f   --region {regio
-0001b010: 6e7d 202d 6e20 7b6e 616d 657d 202d 2d6e  n} -n {name} --n
-0001b020: 756d 2d6e 6f64 6573 2032 2022 6563 686f  um-nodes 2 "echo
-0001b030: 2053 4b59 5049 4c4f 545f 5441 534b 5f49   SKYPILOT_TASK_I
-0001b040: 443a 205c 2453 4b59 5049 4c4f 545f 5441  D: \$SKYPILOT_TA
-0001b050: 534b 5f49 443b 2073 6c65 6570 2031 3830  SK_ID; sleep 180
-0001b060: 3022 2020 2d79 202d 6427 2c0a 2020 2020  0"  -y -d',.    
-0001b070: 2020 2020 2020 2020 2773 6c65 6570 2034          'sleep 4
-0001b080: 3530 272c 0a20 2020 2020 2020 2020 2020  50',.           
-0001b090: 2066 277b 5f53 504f 545f 5155 4555 455f   f'{_SPOT_QUEUE_
-0001b0a0: 5741 4954 7d7c 2067 7265 7020 7b6e 616d  WAIT}| grep {nam
-0001b0b0: 657d 207c 2068 6561 6420 2d6e 3120 7c20  e} | head -n1 | 
-0001b0c0: 6772 6570 2022 5255 4e4e 494e 4722 272c  grep "RUNNING"',
-0001b0d0: 0a20 2020 2020 2020 2020 2020 2066 2752  .            f'R
-0001b0e0: 554e 5f49 443d 2428 736b 7920 7370 6f74  UN_ID=$(sky spot
-0001b0f0: 206c 6f67 7320 2d6e 207b 6e61 6d65 7d20   logs -n {name} 
-0001b100: 2d2d 6e6f 2d66 6f6c 6c6f 7720 7c20 6772  --no-follow | gr
-0001b110: 6570 2053 4b59 5049 4c4f 545f 5441 534b  ep SKYPILOT_TASK
-0001b120: 5f49 4420 7c20 6375 7420 2d64 3a20 2d66  _ID | cut -d: -f
-0001b130: 3229 3b20 6563 686f 2022 2452 554e 5f49  2); echo "$RUN_I
-0001b140: 4422 207c 2074 6565 202f 746d 702f 7b6e  D" | tee /tmp/{n
-0001b150: 616d 657d 2d72 756e 2d69 6427 2c0a 2020  ame}-run-id',.  
-0001b160: 2020 2020 2020 2020 2020 2320 5465 726d            # Term
-0001b170: 696e 6174 6520 7468 6520 776f 726b 6572  inate the worker
-0001b180: 206d 616e 7561 6c6c 792e 0a20 2020 2020   manually..     
-0001b190: 2020 2020 2020 2028 6627 6177 7320 6563         (f'aws ec
-0001b1a0: 3220 7465 726d 696e 6174 652d 696e 7374  2 terminate-inst
-0001b1b0: 616e 6365 7320 2d2d 7265 6769 6f6e 207b  ances --region {
-0001b1c0: 7265 6769 6f6e 7d20 2d2d 696e 7374 616e  region} --instan
-0001b1d0: 6365 2d69 6473 2024 2827 0a20 2020 2020  ce-ids $('.     
-0001b1e0: 2020 2020 2020 2020 6627 6177 7320 6563          f'aws ec
-0001b1f0: 3220 6465 7363 7269 6265 2d69 6e73 7461  2 describe-insta
-0001b200: 6e63 6573 202d 2d72 6567 696f 6e20 7b72  nces --region {r
-0001b210: 6567 696f 6e7d 2027 0a20 2020 2020 2020  egion} '.       
-0001b220: 2020 2020 2020 6627 2d2d 6669 6c74 6572        f'--filter
-0001b230: 7320 4e61 6d65 3d74 6167 3a72 6179 2d63  s Name=tag:ray-c
-0001b240: 6c75 7374 6572 2d6e 616d 652c 5661 6c75  luster-name,Valu
-0001b250: 6573 3d7b 6e61 6d65 5f6f 6e5f 636c 6f75  es={name_on_clou
-0001b260: 647d 2a20 270a 2020 2020 2020 2020 2020  d}* '.          
-0001b270: 2020 2027 4e61 6d65 3d74 6167 3a72 6179     'Name=tag:ray
-0001b280: 2d6e 6f64 652d 7479 7065 2c56 616c 7565  -node-type,Value
-0001b290: 733d 776f 726b 6572 2027 0a20 2020 2020  s=worker '.     
-0001b2a0: 2020 2020 2020 2020 6627 2d2d 7175 6572          f'--quer
-0001b2b0: 7920 5265 7365 7276 6174 696f 6e73 5b5d  y Reservations[]
-0001b2c0: 2e49 6e73 7461 6e63 6573 5b5d 2e49 6e73  .Instances[].Ins
-0001b2d0: 7461 6e63 6549 6420 270a 2020 2020 2020  tanceId '.      
-0001b2e0: 2020 2020 2020 2027 2d2d 6f75 7470 7574         '--output
-0001b2f0: 2074 6578 7429 2729 2c0a 2020 2020 2020   text)'),.      
-0001b300: 2020 2020 2020 2773 6c65 6570 2035 3027        'sleep 50'
-0001b310: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0001b320: 7b5f 5350 4f54 5f51 5545 5545 5f57 4149  {_SPOT_QUEUE_WAI
-0001b330: 547d 7c20 6772 6570 207b 6e61 6d65 7d20  T}| grep {name} 
-0001b340: 7c20 6865 6164 202d 6e31 207c 2067 7265  | head -n1 | gre
-0001b350: 7020 2252 4543 4f56 4552 494e 4722 272c  p "RECOVERING"',
-0001b360: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
-0001b370: 6565 7020 3536 3027 2c0a 2020 2020 2020  eep 560',.      
-0001b380: 2020 2020 2020 6627 7b5f 5350 4f54 5f51        f'{_SPOT_Q
-0001b390: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
-0001b3a0: 207b 6e61 6d65 7d20 7c20 6865 6164 202d   {name} | head -
-0001b3b0: 6e31 207c 2067 7265 7020 2252 554e 4e49  n1 | grep "RUNNI
-0001b3c0: 4e47 2227 2c0a 2020 2020 2020 2020 2020  NG"',.          
-0001b3d0: 2020 6627 5255 4e5f 4944 3d24 2863 6174    f'RUN_ID=$(cat
-0001b3e0: 202f 746d 702f 7b6e 616d 657d 2d72 756e   /tmp/{name}-run
-0001b3f0: 2d69 6429 3b20 6563 686f 2024 5255 4e5f  -id); echo $RUN_
-0001b400: 4944 3b20 736b 7920 7370 6f74 206c 6f67  ID; sky spot log
-0001b410: 7320 2d6e 207b 6e61 6d65 7d20 2d2d 6e6f  s -n {name} --no
-0001b420: 2d66 6f6c 6c6f 7720 7c20 6772 6570 2053  -follow | grep S
-0001b430: 4b59 5049 4c4f 545f 5441 534b 5f49 4420  KYPILOT_TASK_ID 
-0001b440: 7c20 6375 7420 2d64 3a20 2d66 3220 7c20  | cut -d: -f2 | 
-0001b450: 6772 6570 2022 2452 554e 5f49 4422 272c  grep "$RUN_ID"',
-0001b460: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
-0001b470: 2020 2020 5f53 504f 545f 4341 4e43 454c      _SPOT_CANCEL
-0001b480: 5f57 4149 542e 666f 726d 6174 286a 6f62  _WAIT.format(job
-0001b490: 5f6e 616d 653d 6e61 6d65 292c 0a20 2020  _name=name),.   
-0001b4a0: 2020 2020 2074 696d 656f 7574 3d33 3020       timeout=30 
-0001b4b0: 2a20 3630 2c0a 2020 2020 290a 2020 2020  * 60,.    ).    
-0001b4c0: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-0001b4d0: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
-0001b4e0: 6b2e 6763 700a 4070 7974 6573 742e 6d61  k.gcp.@pytest.ma
-0001b4f0: 726b 2e6d 616e 6167 6564 5f73 706f 740a  rk.managed_spot.
-0001b500: 6465 6620 7465 7374 5f73 706f 745f 7265  def test_spot_re
-0001b510: 636f 7665 7279 5f6d 756c 7469 5f6e 6f64  covery_multi_nod
-0001b520: 655f 6763 7028 293a 0a20 2020 2022 2222  e_gcp():.    """
-0001b530: 5465 7374 206d 616e 6167 6564 2073 706f  Test managed spo
-0001b540: 7420 7265 636f 7665 7279 2e22 2222 0a20  t recovery.""". 
-0001b550: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
-0001b560: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
-0001b570: 2020 6e61 6d65 5f6f 6e5f 636c 6f75 6420    name_on_cloud 
-0001b580: 3d20 636f 6d6d 6f6e 5f75 7469 6c73 2e6d  = common_utils.m
-0001b590: 616b 655f 636c 7573 7465 725f 6e61 6d65  ake_cluster_name
-0001b5a0: 5f6f 6e5f 636c 6f75 6428 0a20 2020 2020  _on_cloud(.     
-0001b5b0: 2020 206e 616d 652c 2073 706f 742e 5350     name, spot.SP
-0001b5c0: 4f54 5f43 4c55 5354 4552 5f4e 414d 455f  OT_CLUSTER_NAME_
-0001b5d0: 5052 4546 4958 5f4c 454e 4754 482c 2061  PREFIX_LENGTH, a
-0001b5e0: 6464 5f75 7365 725f 6861 7368 3d46 616c  dd_user_hash=Fal
-0001b5f0: 7365 290a 2020 2020 7a6f 6e65 203d 2027  se).    zone = '
-0001b600: 7573 2d77 6573 7432 2d61 270a 2020 2020  us-west2-a'.    
-0001b610: 2320 5573 6520 273a 2720 746f 206d 6174  # Use ':' to mat
-0001b620: 6368 2061 7320 7468 6520 636c 7573 7465  ch as the cluste
-0001b630: 7220 6e61 6d65 2077 696c 6c20 636f 6e74  r name will cont
-0001b640: 6169 6e20 7468 6520 7375 6666 6978 2077  ain the suffix w
-0001b650: 6974 6820 6a6f 6220 6964 0a20 2020 2071  ith job id.    q
-0001b660: 7565 7279 5f63 6d64 203d 2028 0a20 2020  uery_cmd = (.   
-0001b670: 2020 2020 2066 2767 636c 6f75 6420 636f       f'gcloud co
-0001b680: 6d70 7574 6520 696e 7374 616e 6365 7320  mpute instances 
-0001b690: 6c69 7374 202d 2d66 696c 7465 723d 270a  list --filter='.
-0001b6a0: 2020 2020 2020 2020 6627 2228 6c61 6265          f'"(labe
-0001b6b0: 6c73 2e72 6179 2d63 6c75 7374 6572 2d6e  ls.ray-cluster-n
-0001b6c0: 616d 653a 7b6e 616d 655f 6f6e 5f63 6c6f  ame:{name_on_clo
-0001b6d0: 7564 7d20 414e 4420 270a 2020 2020 2020  ud} AND '.      
-0001b6e0: 2020 6627 6c61 6265 6c73 2e72 6179 2d6e    f'labels.ray-n
-0001b6f0: 6f64 652d 7479 7065 3d77 6f72 6b65 7229  ode-type=worker)
-0001b700: 2220 2d2d 7a6f 6e65 733d 7b7a 6f6e 657d  " --zones={zone}
-0001b710: 202d 2d66 6f72 6d61 743d 2276 616c 7565   --format="value
-0001b720: 286e 616d 6529 2227 290a 2020 2020 7465  (name)"').    te
-0001b730: 726d 696e 6174 655f 636d 6420 3d20 2866  rminate_cmd = (f
-0001b740: 2767 636c 6f75 6420 636f 6d70 7574 6520  'gcloud compute 
-0001b750: 696e 7374 616e 6365 7320 6465 6c65 7465  instances delete
-0001b760: 202d 2d7a 6f6e 653d 7b7a 6f6e 657d 270a   --zone={zone}'.
-0001b770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b780: 2020 2020 2066 2720 2d2d 7175 6965 7420       f' --quiet 
-0001b790: 2428 7b71 7565 7279 5f63 6d64 7d29 2729  $({query_cmd})')
-0001b7a0: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
-0001b7b0: 280a 2020 2020 2020 2020 2773 706f 745f  (.        'spot_
-0001b7c0: 7265 636f 7665 7279 5f6d 756c 7469 5f6e  recovery_multi_n
-0001b7d0: 6f64 655f 6763 7027 2c0a 2020 2020 2020  ode_gcp',.      
-0001b7e0: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
-0001b7f0: 6627 736b 7920 7370 6f74 206c 6175 6e63  f'sky spot launc
-0001b800: 6820 2d2d 636c 6f75 6420 6763 7020 2d2d  h --cloud gcp --
-0001b810: 7a6f 6e65 207b 7a6f 6e65 7d20 2d6e 207b  zone {zone} -n {
-0001b820: 6e61 6d65 7d20 2d2d 6e75 6d2d 6e6f 6465  name} --num-node
-0001b830: 7320 3220 2265 6368 6f20 534b 5950 494c  s 2 "echo SKYPIL
-0001b840: 4f54 5f54 4153 4b5f 4944 3a20 5c24 534b  OT_TASK_ID: \$SK
-0001b850: 5950 494c 4f54 5f54 4153 4b5f 4944 3b20  YPILOT_TASK_ID; 
-0001b860: 736c 6565 7020 3138 3030 2220 202d 7920  sleep 1800"  -y 
-0001b870: 2d64 272c 0a20 2020 2020 2020 2020 2020  -d',.           
-0001b880: 2027 736c 6565 7020 3430 3027 2c0a 2020   'sleep 400',.  
-0001b890: 2020 2020 2020 2020 2020 6627 7b5f 5350            f'{_SP
-0001b8a0: 4f54 5f51 5545 5545 5f57 4149 547d 7c20  OT_QUEUE_WAIT}| 
-0001b8b0: 6772 6570 207b 6e61 6d65 7d20 7c20 6865  grep {name} | he
-0001b8c0: 6164 202d 6e31 207c 2067 7265 7020 2252  ad -n1 | grep "R
-0001b8d0: 554e 4e49 4e47 2227 2c0a 2020 2020 2020  UNNING"',.      
-0001b8e0: 2020 2020 2020 6627 5255 4e5f 4944 3d24        f'RUN_ID=$
-0001b8f0: 2873 6b79 2073 706f 7420 6c6f 6773 202d  (sky spot logs -
-0001b900: 6e20 7b6e 616d 657d 202d 2d6e 6f2d 666f  n {name} --no-fo
-0001b910: 6c6c 6f77 207c 2067 7265 7020 534b 5950  llow | grep SKYP
-0001b920: 494c 4f54 5f54 4153 4b5f 4944 207c 2063  ILOT_TASK_ID | c
-0001b930: 7574 202d 643a 202d 6632 293b 2065 6368  ut -d: -f2); ech
-0001b940: 6f20 2224 5255 4e5f 4944 2220 7c20 7465  o "$RUN_ID" | te
-0001b950: 6520 2f74 6d70 2f7b 6e61 6d65 7d2d 7275  e /tmp/{name}-ru
-0001b960: 6e2d 6964 272c 0a20 2020 2020 2020 2020  n-id',.         
-0001b970: 2020 2023 2054 6572 6d69 6e61 7465 2074     # Terminate t
-0001b980: 6865 2077 6f72 6b65 7220 6d61 6e75 616c  he worker manual
-0001b990: 6c79 2e0a 2020 2020 2020 2020 2020 2020  ly..            
-0001b9a0: 7465 726d 696e 6174 655f 636d 642c 0a20  terminate_cmd,. 
-0001b9b0: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
-0001b9c0: 7020 3530 272c 0a20 2020 2020 2020 2020  p 50',.         
-0001b9d0: 2020 2066 277b 5f53 504f 545f 5155 4555     f'{_SPOT_QUEU
-0001b9e0: 455f 5741 4954 7d7c 2067 7265 7020 7b6e  E_WAIT}| grep {n
-0001b9f0: 616d 657d 207c 2068 6561 6420 2d6e 3120  ame} | head -n1 
-0001ba00: 7c20 6772 6570 2022 5245 434f 5645 5249  | grep "RECOVERI
-0001ba10: 4e47 2227 2c0a 2020 2020 2020 2020 2020  NG"',.          
-0001ba20: 2020 2773 6c65 6570 2034 3230 272c 0a20    'sleep 420',. 
-0001ba30: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
-0001ba40: 504f 545f 5155 4555 455f 5741 4954 7d7c  POT_QUEUE_WAIT}|
-0001ba50: 2067 7265 7020 7b6e 616d 657d 207c 2068   grep {name} | h
-0001ba60: 6561 6420 2d6e 3120 7c20 6772 6570 2022  ead -n1 | grep "
-0001ba70: 5255 4e4e 494e 4722 272c 0a20 2020 2020  RUNNING"',.     
-0001ba80: 2020 2020 2020 2066 2752 554e 5f49 443d         f'RUN_ID=
-0001ba90: 2428 6361 7420 2f74 6d70 2f7b 6e61 6d65  $(cat /tmp/{name
-0001baa0: 7d2d 7275 6e2d 6964 293b 2065 6368 6f20  }-run-id); echo 
-0001bab0: 2452 554e 5f49 443b 2073 6b79 2073 706f  $RUN_ID; sky spo
-0001bac0: 7420 6c6f 6773 202d 6e20 7b6e 616d 657d  t logs -n {name}
-0001bad0: 202d 2d6e 6f2d 666f 6c6c 6f77 207c 2067   --no-follow | g
-0001bae0: 7265 7020 534b 5950 494c 4f54 5f54 4153  rep SKYPILOT_TAS
-0001baf0: 4b5f 4944 207c 2063 7574 202d 643a 202d  K_ID | cut -d: -
-0001bb00: 6632 207c 2067 7265 7020 2224 5255 4e5f  f2 | grep "$RUN_
-0001bb10: 4944 2227 2c0a 2020 2020 2020 2020 5d2c  ID"',.        ],
-0001bb20: 0a20 2020 2020 2020 205f 5350 4f54 5f43  .        _SPOT_C
-0001bb30: 414e 4345 4c5f 5741 4954 2e66 6f72 6d61  ANCEL_WAIT.forma
-0001bb40: 7428 6a6f 625f 6e61 6d65 3d6e 616d 6529  t(job_name=name)
-0001bb50: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
-0001bb60: 743d 3235 202a 2036 302c 0a20 2020 2029  t=25 * 60,.    )
-0001bb70: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
-0001bb80: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
-0001bb90: 742e 6d61 726b 2e61 7773 0a40 7079 7465  t.mark.aws.@pyte
-0001bba0: 7374 2e6d 6172 6b2e 6d61 6e61 6765 645f  st.mark.managed_
-0001bbb0: 7370 6f74 0a64 6566 2074 6573 745f 7370  spot.def test_sp
-0001bbc0: 6f74 5f63 616e 6365 6c6c 6174 696f 6e5f  ot_cancellation_
-0001bbd0: 6177 7328 6177 735f 636f 6e66 6967 5f72  aws(aws_config_r
-0001bbe0: 6567 696f 6e29 3a0a 2020 2020 6e61 6d65  egion):.    name
-0001bbf0: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
-0001bc00: 6e61 6d65 2829 0a20 2020 206e 616d 655f  name().    name_
-0001bc10: 6f6e 5f63 6c6f 7564 203d 2063 6f6d 6d6f  on_cloud = commo
-0001bc20: 6e5f 7574 696c 732e 6d61 6b65 5f63 6c75  n_utils.make_clu
-0001bc30: 7374 6572 5f6e 616d 655f 6f6e 5f63 6c6f  ster_name_on_clo
-0001bc40: 7564 280a 2020 2020 2020 2020 6e61 6d65  ud(.        name
-0001bc50: 2c20 7370 6f74 2e53 504f 545f 434c 5553  , spot.SPOT_CLUS
-0001bc60: 5445 525f 4e41 4d45 5f50 5245 4649 585f  TER_NAME_PREFIX_
-0001bc70: 4c45 4e47 5448 2c20 6164 645f 7573 6572  LENGTH, add_user
-0001bc80: 5f68 6173 683d 4661 6c73 6529 0a20 2020  _hash=False).   
-0001bc90: 206e 616d 655f 325f 6f6e 5f63 6c6f 7564   name_2_on_cloud
-0001bca0: 203d 2063 6f6d 6d6f 6e5f 7574 696c 732e   = common_utils.
-0001bcb0: 6d61 6b65 5f63 6c75 7374 6572 5f6e 616d  make_cluster_nam
-0001bcc0: 655f 6f6e 5f63 6c6f 7564 280a 2020 2020  e_on_cloud(.    
-0001bcd0: 2020 2020 6627 7b6e 616d 657d 2d32 272c      f'{name}-2',
-0001bce0: 2073 706f 742e 5350 4f54 5f43 4c55 5354   spot.SPOT_CLUST
-0001bcf0: 4552 5f4e 414d 455f 5052 4546 4958 5f4c  ER_NAME_PREFIX_L
-0001bd00: 454e 4754 482c 2061 6464 5f75 7365 725f  ENGTH, add_user_
-0001bd10: 6861 7368 3d46 616c 7365 290a 2020 2020  hash=False).    
-0001bd20: 6e61 6d65 5f33 5f6f 6e5f 636c 6f75 6420  name_3_on_cloud 
-0001bd30: 3d20 636f 6d6d 6f6e 5f75 7469 6c73 2e6d  = common_utils.m
-0001bd40: 616b 655f 636c 7573 7465 725f 6e61 6d65  ake_cluster_name
-0001bd50: 5f6f 6e5f 636c 6f75 6428 0a20 2020 2020  _on_cloud(.     
-0001bd60: 2020 2066 277b 6e61 6d65 7d2d 3327 2c20     f'{name}-3', 
-0001bd70: 7370 6f74 2e53 504f 545f 434c 5553 5445  spot.SPOT_CLUSTE
-0001bd80: 525f 4e41 4d45 5f50 5245 4649 585f 4c45  R_NAME_PREFIX_LE
-0001bd90: 4e47 5448 2c20 6164 645f 7573 6572 5f68  NGTH, add_user_h
-0001bda0: 6173 683d 4661 6c73 6529 0a20 2020 2072  ash=False).    r
-0001bdb0: 6567 696f 6e20 3d20 6177 735f 636f 6e66  egion = aws_conf
-0001bdc0: 6967 5f72 6567 696f 6e0a 2020 2020 7465  ig_region.    te
-0001bdd0: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
-0001bde0: 2020 2027 7370 6f74 5f63 616e 6365 6c6c     'spot_cancell
-0001bdf0: 6174 696f 6e5f 6177 7327 2c0a 2020 2020  ation_aws',.    
-0001be00: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
-0001be10: 2020 2320 5465 7374 2063 616e 6365 6c6c    # Test cancell
-0001be20: 6174 696f 6e20 6475 7269 6e67 2073 706f  ation during spo
-0001be30: 7420 636c 7573 7465 7220 6265 696e 6720  t cluster being 
-0001be40: 6c61 756e 6368 6564 2e0a 2020 2020 2020  launched..      
-0001be50: 2020 2020 2020 6627 736b 7920 7370 6f74        f'sky spot
-0001be60: 206c 6175 6e63 6820 2d2d 636c 6f75 6420   launch --cloud 
-0001be70: 6177 7320 2d2d 7265 6769 6f6e 207b 7265  aws --region {re
-0001be80: 6769 6f6e 7d20 2d6e 207b 6e61 6d65 7d20  gion} -n {name} 
-0001be90: 2273 6c65 6570 2031 3030 3022 2020 2d79  "sleep 1000"  -y
-0001bea0: 202d 6427 2c0a 2020 2020 2020 2020 2020   -d',.          
-0001beb0: 2020 2773 6c65 6570 2036 3027 2c0a 2020    'sleep 60',.  
-0001bec0: 2020 2020 2020 2020 2020 6627 7b5f 5350            f'{_SP
-0001bed0: 4f54 5f51 5545 5545 5f57 4149 547d 7c20  OT_QUEUE_WAIT}| 
-0001bee0: 6772 6570 207b 6e61 6d65 7d20 7c20 6865  grep {name} | he
-0001bef0: 6164 202d 6e31 207c 2067 7265 7020 2253  ad -n1 | grep "S
-0001bf00: 5441 5254 494e 4722 272c 0a20 2020 2020  TARTING"',.     
-0001bf10: 2020 2020 2020 205f 5350 4f54 5f43 414e         _SPOT_CAN
-0001bf20: 4345 4c5f 5741 4954 2e66 6f72 6d61 7428  CEL_WAIT.format(
-0001bf30: 6a6f 625f 6e61 6d65 3d6e 616d 6529 2c0a  job_name=name),.
-0001bf40: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
-0001bf50: 6570 2035 272c 0a20 2020 2020 2020 2020  ep 5',.         
-0001bf60: 2020 2066 277b 5f53 504f 545f 5155 4555     f'{_SPOT_QUEU
-0001bf70: 455f 5741 4954 7d7c 2067 7265 7020 7b6e  E_WAIT}| grep {n
-0001bf80: 616d 657d 207c 2068 6561 6420 2d6e 3120  ame} | head -n1 
-0001bf90: 7c20 6772 6570 2022 4341 4e43 454c 4c49  | grep "CANCELLI
-0001bfa0: 4e47 5c7c 4341 4e43 454c 4c45 4422 272c  NG\|CANCELLED"',
-0001bfb0: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
-0001bfc0: 6565 7020 3132 3027 2c0a 2020 2020 2020  eep 120',.      
-0001bfd0: 2020 2020 2020 6627 7b5f 5350 4f54 5f51        f'{_SPOT_Q
-0001bfe0: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
-0001bff0: 207b 6e61 6d65 7d20 7c20 6865 6164 202d   {name} | head -
-0001c000: 6e31 207c 2067 7265 7020 2243 414e 4345  n1 | grep "CANCE
-0001c010: 4c4c 4544 2227 2c0a 2020 2020 2020 2020  LLED"',.        
-0001c020: 2020 2020 2866 2773 3d24 2861 7773 2065      (f's=$(aws e
-0001c030: 6332 2064 6573 6372 6962 652d 696e 7374  c2 describe-inst
-0001c040: 616e 6365 7320 2d2d 7265 6769 6f6e 207b  ances --region {
-0001c050: 7265 6769 6f6e 7d20 270a 2020 2020 2020  region} '.      
-0001c060: 2020 2020 2020 2066 272d 2d66 696c 7465         f'--filte
-0001c070: 7273 204e 616d 653d 7461 673a 7261 792d  rs Name=tag:ray-
-0001c080: 636c 7573 7465 722d 6e61 6d65 2c56 616c  cluster-name,Val
-0001c090: 7565 733d 7b6e 616d 655f 6f6e 5f63 6c6f  ues={name_on_clo
-0001c0a0: 7564 7d2d 2a20 270a 2020 2020 2020 2020  ud}-* '.        
-0001c0b0: 2020 2020 2066 272d 2d71 7565 7279 2052       f'--query R
-0001c0c0: 6573 6572 7661 7469 6f6e 735b 5d2e 496e  eservations[].In
-0001c0d0: 7374 616e 6365 735b 5d2e 5374 6174 655b  stances[].State[
-0001c0e0: 5d2e 4e61 6d65 2027 0a20 2020 2020 2020  ].Name '.       
-0001c0f0: 2020 2020 2020 272d 2d6f 7574 7075 7420        '--output 
-0001c100: 7465 7874 2920 2626 2065 6368 6f20 2224  text) && echo "$
-0001c110: 7322 2026 2620 6563 686f 3b20 5b5b 202d  s" && echo; [[ -
-0001c120: 7a20 2224 7322 205d 5d20 7c7c 205b 5b20  z "$s" ]] || [[ 
-0001c130: 2224 7322 203d 2022 7465 726d 696e 6174  "$s" = "terminat
-0001c140: 6564 2220 5d5d 207c 7c20 5b5b 2022 2473  ed" ]] || [[ "$s
-0001c150: 2220 3d20 2273 6875 7474 696e 672d 646f  " = "shutting-do
-0001c160: 776e 2220 5d5d 270a 2020 2020 2020 2020  wn" ]]'.        
-0001c170: 2020 2020 292c 0a20 2020 2020 2020 2020      ),.         
-0001c180: 2020 2023 2054 6573 7420 6361 6e63 656c     # Test cancel
-0001c190: 6c69 6e67 2074 6865 2073 706f 7420 636c  ling the spot cl
-0001c1a0: 7573 7465 7220 6475 7269 6e67 2073 706f  uster during spo
-0001c1b0: 7420 6a6f 6220 6265 696e 6720 7365 7475  t job being setu
-0001c1c0: 702e 0a20 2020 2020 2020 2020 2020 2066  p..            f
-0001c1d0: 2773 6b79 2073 706f 7420 6c61 756e 6368  'sky spot launch
-0001c1e0: 202d 2d63 6c6f 7564 2061 7773 202d 2d72   --cloud aws --r
-0001c1f0: 6567 696f 6e20 7b72 6567 696f 6e7d 202d  egion {region} -
-0001c200: 6e20 7b6e 616d 657d 2d32 2074 6573 7473  n {name}-2 tests
-0001c210: 2f74 6573 745f 7961 6d6c 732f 7465 7374  /test_yamls/test
-0001c220: 5f6c 6f6e 675f 7365 7475 702e 7961 6d6c  _long_setup.yaml
-0001c230: 2020 2d79 202d 6427 2c0a 2020 2020 2020    -y -d',.      
-0001c240: 2020 2020 2020 2773 6c65 6570 2033 3030        'sleep 300
-0001c250: 272c 0a20 2020 2020 2020 2020 2020 205f  ',.            _
-0001c260: 5350 4f54 5f43 414e 4345 4c5f 5741 4954  SPOT_CANCEL_WAIT
-0001c270: 2e66 6f72 6d61 7428 6a6f 625f 6e61 6d65  .format(job_name
-0001c280: 3d66 277b 6e61 6d65 7d2d 3227 292c 0a20  =f'{name}-2'),. 
-0001c290: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
-0001c2a0: 7020 3527 2c0a 2020 2020 2020 2020 2020  p 5',.          
-0001c2b0: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
-0001c2c0: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
-0001c2d0: 6d65 7d2d 3220 7c20 6865 6164 202d 6e31  me}-2 | head -n1
-0001c2e0: 207c 2067 7265 7020 2243 414e 4345 4c4c   | grep "CANCELL
-0001c2f0: 494e 475c 7c43 414e 4345 4c4c 4544 2227  ING\|CANCELLED"'
-0001c300: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
-0001c310: 6c65 6570 2031 3230 272c 0a20 2020 2020  leep 120',.     
-0001c320: 2020 2020 2020 2066 277b 5f53 504f 545f         f'{_SPOT_
-0001c330: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
-0001c340: 7020 7b6e 616d 657d 2d32 207c 2068 6561  p {name}-2 | hea
-0001c350: 6420 2d6e 3120 7c20 6772 6570 2022 4341  d -n1 | grep "CA
-0001c360: 4e43 454c 4c45 4422 272c 0a20 2020 2020  NCELLED"',.     
-0001c370: 2020 2020 2020 2028 6627 733d 2428 6177         (f's=$(aw
-0001c380: 7320 6563 3220 6465 7363 7269 6265 2d69  s ec2 describe-i
-0001c390: 6e73 7461 6e63 6573 202d 2d72 6567 696f  nstances --regio
-0001c3a0: 6e20 7b72 6567 696f 6e7d 2027 0a20 2020  n {region} '.   
-0001c3b0: 2020 2020 2020 2020 2020 6627 2d2d 6669            f'--fi
-0001c3c0: 6c74 6572 7320 4e61 6d65 3d74 6167 3a72  lters Name=tag:r
-0001c3d0: 6179 2d63 6c75 7374 6572 2d6e 616d 652c  ay-cluster-name,
-0001c3e0: 5661 6c75 6573 3d7b 6e61 6d65 5f32 5f6f  Values={name_2_o
-0001c3f0: 6e5f 636c 6f75 647d 2d2a 2027 0a20 2020  n_cloud}-* '.   
-0001c400: 2020 2020 2020 2020 2020 6627 2d2d 7175            f'--qu
-0001c410: 6572 7920 5265 7365 7276 6174 696f 6e73  ery Reservations
-0001c420: 5b5d 2e49 6e73 7461 6e63 6573 5b5d 2e53  [].Instances[].S
-0001c430: 7461 7465 5b5d 2e4e 616d 6520 270a 2020  tate[].Name '.  
-0001c440: 2020 2020 2020 2020 2020 2027 2d2d 6f75             '--ou
-0001c450: 7470 7574 2074 6578 7429 2026 2620 6563  tput text) && ec
-0001c460: 686f 2022 2473 2220 2626 2065 6368 6f3b  ho "$s" && echo;
-0001c470: 205b 5b20 2d7a 2022 2473 2220 5d5d 207c   [[ -z "$s" ]] |
-0001c480: 7c20 5b5b 2022 2473 2220 3d20 2274 6572  | [[ "$s" = "ter
-0001c490: 6d69 6e61 7465 6422 205d 5d20 7c7c 205b  minated" ]] || [
-0001c4a0: 5b20 2224 7322 203d 2022 7368 7574 7469  [ "$s" = "shutti
-0001c4b0: 6e67 2d64 6f77 6e22 205d 5d27 0a20 2020  ng-down" ]]'.   
-0001c4c0: 2020 2020 2020 2020 2029 2c0a 2020 2020           ),.    
-0001c4d0: 2020 2020 2020 2020 2320 5465 7374 2063          # Test c
-0001c4e0: 616e 6365 6c6c 6174 696f 6e20 6475 7269  ancellation duri
-0001c4f0: 6e67 2073 706f 7420 6a6f 6220 6973 2072  ng spot job is r
-0001c500: 6563 6f76 6572 696e 672e 0a20 2020 2020  ecovering..     
-0001c510: 2020 2020 2020 2066 2773 6b79 2073 706f         f'sky spo
-0001c520: 7420 6c61 756e 6368 202d 2d63 6c6f 7564  t launch --cloud
-0001c530: 2061 7773 202d 2d72 6567 696f 6e20 7b72   aws --region {r
-0001c540: 6567 696f 6e7d 202d 6e20 7b6e 616d 657d  egion} -n {name}
-0001c550: 2d33 2022 736c 6565 7020 3130 3030 2220  -3 "sleep 1000" 
-0001c560: 202d 7920 2d64 272c 0a20 2020 2020 2020   -y -d',.       
-0001c570: 2020 2020 2027 736c 6565 7020 3330 3027       'sleep 300'
-0001c580: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0001c590: 7b5f 5350 4f54 5f51 5545 5545 5f57 4149  {_SPOT_QUEUE_WAI
-0001c5a0: 547d 7c20 6772 6570 207b 6e61 6d65 7d2d  T}| grep {name}-
-0001c5b0: 3320 7c20 6865 6164 202d 6e31 207c 2067  3 | head -n1 | g
-0001c5c0: 7265 7020 2252 554e 4e49 4e47 2227 2c0a  rep "RUNNING"',.
-0001c5d0: 2020 2020 2020 2020 2020 2020 2320 5465              # Te
-0001c5e0: 726d 696e 6174 6520 7468 6520 636c 7573  rminate the clus
-0001c5f0: 7465 7220 6d61 6e75 616c 6c79 2e0a 2020  ter manually..  
-0001c600: 2020 2020 2020 2020 2020 2866 2761 7773            (f'aws
-0001c610: 2065 6332 2074 6572 6d69 6e61 7465 2d69   ec2 terminate-i
-0001c620: 6e73 7461 6e63 6573 202d 2d72 6567 696f  nstances --regio
-0001c630: 6e20 7b72 6567 696f 6e7d 202d 2d69 6e73  n {region} --ins
-0001c640: 7461 6e63 652d 6964 7320 2428 270a 2020  tance-ids $('.  
-0001c650: 2020 2020 2020 2020 2020 2066 2761 7773             f'aws
-0001c660: 2065 6332 2064 6573 6372 6962 652d 696e   ec2 describe-in
-0001c670: 7374 616e 6365 7320 2d2d 7265 6769 6f6e  stances --region
-0001c680: 207b 7265 6769 6f6e 7d20 270a 2020 2020   {region} '.    
-0001c690: 2020 2020 2020 2020 2066 272d 2d66 696c           f'--fil
-0001c6a0: 7465 7273 204e 616d 653d 7461 673a 7261  ters Name=tag:ra
-0001c6b0: 792d 636c 7573 7465 722d 6e61 6d65 2c56  y-cluster-name,V
-0001c6c0: 616c 7565 733d 7b6e 616d 655f 335f 6f6e  alues={name_3_on
-0001c6d0: 5f63 6c6f 7564 7d2d 2a20 270a 2020 2020  _cloud}-* '.    
-0001c6e0: 2020 2020 2020 2020 2066 272d 2d71 7565           f'--que
-0001c6f0: 7279 2052 6573 6572 7661 7469 6f6e 735b  ry Reservations[
-0001c700: 5d2e 496e 7374 616e 6365 735b 5d2e 496e  ].Instances[].In
-0001c710: 7374 616e 6365 4964 2027 0a20 2020 2020  stanceId '.     
-0001c720: 2020 2020 2020 2020 272d 2d6f 7574 7075          '--outpu
-0001c730: 7420 7465 7874 2927 292c 0a20 2020 2020  t text)'),.     
-0001c740: 2020 2020 2020 2027 736c 6565 7020 3132         'sleep 12
-0001c750: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
-0001c760: 6627 7b5f 5350 4f54 5f51 5545 5545 5f57  f'{_SPOT_QUEUE_W
-0001c770: 4149 547d 7c20 6772 6570 207b 6e61 6d65  AIT}| grep {name
-0001c780: 7d2d 3320 7c20 6865 6164 202d 6e31 207c  }-3 | head -n1 |
-0001c790: 2067 7265 7020 2252 4543 4f56 4552 494e   grep "RECOVERIN
-0001c7a0: 4722 272c 0a20 2020 2020 2020 2020 2020  G"',.           
-0001c7b0: 205f 5350 4f54 5f43 414e 4345 4c5f 5741   _SPOT_CANCEL_WA
-0001c7c0: 4954 2e66 6f72 6d61 7428 6a6f 625f 6e61  IT.format(job_na
-0001c7d0: 6d65 3d66 277b 6e61 6d65 7d2d 3327 292c  me=f'{name}-3'),
-0001c7e0: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
-0001c7f0: 6565 7020 3527 2c0a 2020 2020 2020 2020  eep 5',.        
-0001c800: 2020 2020 6627 7b5f 5350 4f54 5f51 5545      f'{_SPOT_QUE
-0001c810: 5545 5f57 4149 547d 7c20 6772 6570 207b  UE_WAIT}| grep {
-0001c820: 6e61 6d65 7d2d 3320 7c20 6865 6164 202d  name}-3 | head -
-0001c830: 6e31 207c 2067 7265 7020 2243 414e 4345  n1 | grep "CANCE
-0001c840: 4c4c 494e 475c 7c43 414e 4345 4c4c 4544  LLING\|CANCELLED
-0001c850: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-0001c860: 2773 6c65 6570 2031 3230 272c 0a20 2020  'sleep 120',.   
-0001c870: 2020 2020 2020 2020 2066 277b 5f53 504f           f'{_SPO
-0001c880: 545f 5155 4555 455f 5741 4954 7d7c 2067  T_QUEUE_WAIT}| g
-0001c890: 7265 7020 7b6e 616d 657d 2d33 207c 2068  rep {name}-3 | h
-0001c8a0: 6561 6420 2d6e 3120 7c20 6772 6570 2022  ead -n1 | grep "
-0001c8b0: 4341 4e43 454c 4c45 4422 272c 0a20 2020  CANCELLED"',.   
-0001c8c0: 2020 2020 2020 2020 2023 2054 6865 2063           # The c
-0001c8d0: 6c75 7374 6572 2073 686f 756c 6420 6265  luster should be
-0001c8e0: 2074 6572 6d69 6e61 7465 6420 2873 6875   terminated (shu
-0001c8f0: 7474 696e 672d 646f 776e 2920 6166 7465  tting-down) afte
-0001c900: 7220 6361 6e63 656c 6c61 7469 6f6e 2e20  r cancellation. 
-0001c910: 5765 2064 6f6e 2774 2075 7365 2074 6865  We don't use the
-0001c920: 2060 3d60 206f 7065 7261 746f 7220 6865   `=` operator he
-0001c930: 7265 2062 6563 6175 7365 0a20 2020 2020  re because.     
-0001c940: 2020 2020 2020 2023 2074 6865 7265 2063         # there c
-0001c950: 616e 2062 6520 6d75 6c74 6970 6c65 2056  an be multiple V
-0001c960: 4d20 7769 7468 2074 6865 2073 616d 6520  M with the same 
-0001c970: 6e61 6d65 2064 7565 2074 6f20 7468 6520  name due to the 
-0001c980: 7265 636f 7665 7279 2e0a 2020 2020 2020  recovery..      
-0001c990: 2020 2020 2020 2866 2773 3d24 2861 7773        (f's=$(aws
-0001c9a0: 2065 6332 2064 6573 6372 6962 652d 696e   ec2 describe-in
-0001c9b0: 7374 616e 6365 7320 2d2d 7265 6769 6f6e  stances --region
-0001c9c0: 207b 7265 6769 6f6e 7d20 270a 2020 2020   {region} '.    
-0001c9d0: 2020 2020 2020 2020 2066 272d 2d66 696c           f'--fil
-0001c9e0: 7465 7273 204e 616d 653d 7461 673a 7261  ters Name=tag:ra
-0001c9f0: 792d 636c 7573 7465 722d 6e61 6d65 2c56  y-cluster-name,V
-0001ca00: 616c 7565 733d 7b6e 616d 655f 335f 6f6e  alues={name_3_on
-0001ca10: 5f63 6c6f 7564 7d2d 2a20 270a 2020 2020  _cloud}-* '.    
-0001ca20: 2020 2020 2020 2020 2066 272d 2d71 7565           f'--que
-0001ca30: 7279 2052 6573 6572 7661 7469 6f6e 735b  ry Reservations[
-0001ca40: 5d2e 496e 7374 616e 6365 735b 5d2e 5374  ].Instances[].St
-0001ca50: 6174 655b 5d2e 4e61 6d65 2027 0a20 2020  ate[].Name '.   
-0001ca60: 2020 2020 2020 2020 2020 272d 2d6f 7574            '--out
-0001ca70: 7075 7420 7465 7874 2920 2626 2065 6368  put text) && ech
-0001ca80: 6f20 2224 7322 2026 2620 6563 686f 3b20  o "$s" && echo; 
-0001ca90: 5b5b 202d 7a20 2224 7322 205d 5d20 7c7c  [[ -z "$s" ]] ||
-0001caa0: 2065 6368 6f20 2224 7322 207c 2067 7265   echo "$s" | gre
-0001cab0: 7020 2d76 202d 4520 2270 656e 6469 6e67  p -v -E "pending
-0001cac0: 7c72 756e 6e69 6e67 7c73 746f 7070 6564  |running|stopped
-0001cad0: 7c73 746f 7070 696e 6722 270a 2020 2020  |stopping"'.    
-0001cae0: 2020 2020 2020 2020 292c 0a20 2020 2020          ),.     
-0001caf0: 2020 205d 2c0a 2020 2020 2020 2020 7469     ],.        ti
-0001cb00: 6d65 6f75 743d 3235 202a 2036 3029 0a20  meout=25 * 60). 
-0001cb10: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-0001cb20: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
-0001cb30: 6d61 726b 2e67 6370 0a40 7079 7465 7374  mark.gcp.@pytest
-0001cb40: 2e6d 6172 6b2e 6d61 6e61 6765 645f 7370  .mark.managed_sp
-0001cb50: 6f74 0a64 6566 2074 6573 745f 7370 6f74  ot.def test_spot
-0001cb60: 5f63 616e 6365 6c6c 6174 696f 6e5f 6763  _cancellation_gc
-0001cb70: 7028 293a 0a20 2020 206e 616d 6520 3d20  p():.    name = 
-0001cb80: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
-0001cb90: 6528 290a 2020 2020 6e61 6d65 5f33 203d  e().    name_3 =
-0001cba0: 2066 277b 6e61 6d65 7d2d 3327 0a20 2020   f'{name}-3'.   
-0001cbb0: 206e 616d 655f 335f 6f6e 5f63 6c6f 7564   name_3_on_cloud
-0001cbc0: 203d 2063 6f6d 6d6f 6e5f 7574 696c 732e   = common_utils.
-0001cbd0: 6d61 6b65 5f63 6c75 7374 6572 5f6e 616d  make_cluster_nam
-0001cbe0: 655f 6f6e 5f63 6c6f 7564 280a 2020 2020  e_on_cloud(.    
-0001cbf0: 2020 2020 6e61 6d65 5f33 2c20 7370 6f74      name_3, spot
-0001cc00: 2e53 504f 545f 434c 5553 5445 525f 4e41  .SPOT_CLUSTER_NA
-0001cc10: 4d45 5f50 5245 4649 585f 4c45 4e47 5448  ME_PREFIX_LENGTH
-0001cc20: 2c20 6164 645f 7573 6572 5f68 6173 683d  , add_user_hash=
-0001cc30: 4661 6c73 6529 0a20 2020 207a 6f6e 6520  False).    zone 
-0001cc40: 3d20 2775 732d 7765 7374 332d 6227 0a20  = 'us-west3-b'. 
-0001cc50: 2020 2071 7565 7279 5f73 7461 7465 5f63     query_state_c
-0001cc60: 6d64 203d 2028 0a20 2020 2020 2020 2027  md = (.        '
-0001cc70: 6763 6c6f 7564 2063 6f6d 7075 7465 2069  gcloud compute i
-0001cc80: 6e73 7461 6e63 6573 206c 6973 7420 270a  nstances list '.
-0001cc90: 2020 2020 2020 2020 6627 2d2d 6669 6c74          f'--filt
-0001cca0: 6572 3d22 286c 6162 656c 732e 7261 792d  er="(labels.ray-
-0001ccb0: 636c 7573 7465 722d 6e61 6d65 3a7b 6e61  cluster-name:{na
-0001ccc0: 6d65 5f33 5f6f 6e5f 636c 6f75 647d 2922  me_3_on_cloud})"
-0001ccd0: 2027 0a20 2020 2020 2020 2027 2d2d 666f   '.        '--fo
-0001cce0: 726d 6174 3d22 7661 6c75 6528 7374 6174  rmat="value(stat
-0001ccf0: 7573 2922 2729 0a20 2020 2071 7565 7279  us)"').    query
-0001cd00: 5f63 6d64 203d 2028 6627 6763 6c6f 7564  _cmd = (f'gcloud
-0001cd10: 2063 6f6d 7075 7465 2069 6e73 7461 6e63   compute instanc
-0001cd20: 6573 206c 6973 7420 2d2d 6669 6c74 6572  es list --filter
-0001cd30: 3d27 0a20 2020 2020 2020 2020 2020 2020  ='.             
-0001cd40: 2020 2020 6627 2228 6c61 6265 6c73 2e72      f'"(labels.r
-0001cd50: 6179 2d63 6c75 7374 6572 2d6e 616d 653a  ay-cluster-name:
-0001cd60: 7b6e 616d 655f 335f 6f6e 5f63 6c6f 7564  {name_3_on_cloud
-0001cd70: 7d29 2220 270a 2020 2020 2020 2020 2020  })" '.          
-0001cd80: 2020 2020 2020 2066 272d 2d7a 6f6e 6573         f'--zones
-0001cd90: 3d7b 7a6f 6e65 7d20 2d2d 666f 726d 6174  ={zone} --format
-0001cda0: 3d22 7661 6c75 6528 6e61 6d65 2922 2729  ="value(name)"')
-0001cdb0: 0a20 2020 2074 6572 6d69 6e61 7465 5f63  .    terminate_c
-0001cdc0: 6d64 203d 2028 6627 6763 6c6f 7564 2063  md = (f'gcloud c
-0001cdd0: 6f6d 7075 7465 2069 6e73 7461 6e63 6573  ompute instances
-0001cde0: 2064 656c 6574 6520 2d2d 7a6f 6e65 3d7b   delete --zone={
-0001cdf0: 7a6f 6e65 7d27 0a20 2020 2020 2020 2020  zone}'.         
-0001ce00: 2020 2020 2020 2020 2020 2020 6627 202d              f' -
-0001ce10: 2d71 7569 6574 2024 287b 7175 6572 795f  -quiet $({query_
-0001ce20: 636d 647d 2927 290a 2020 2020 7465 7374  cmd})').    test
-0001ce30: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-0001ce40: 2027 7370 6f74 5f63 616e 6365 6c6c 6174   'spot_cancellat
-0001ce50: 696f 6e5f 6763 7027 2c0a 2020 2020 2020  ion_gcp',.      
-0001ce60: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
-0001ce70: 2320 5465 7374 2063 616e 6365 6c6c 6174  # Test cancellat
-0001ce80: 696f 6e20 6475 7269 6e67 2073 706f 7420  ion during spot 
-0001ce90: 636c 7573 7465 7220 6265 696e 6720 6c61  cluster being la
-0001cea0: 756e 6368 6564 2e0a 2020 2020 2020 2020  unched..        
-0001ceb0: 2020 2020 6627 736b 7920 7370 6f74 206c      f'sky spot l
-0001cec0: 6175 6e63 6820 2d2d 636c 6f75 6420 6763  aunch --cloud gc
-0001ced0: 7020 2d2d 7a6f 6e65 207b 7a6f 6e65 7d20  p --zone {zone} 
-0001cee0: 2d6e 207b 6e61 6d65 7d20 2273 6c65 6570  -n {name} "sleep
-0001cef0: 2031 3030 3022 2020 2d79 202d 6427 2c0a   1000"  -y -d',.
-0001cf00: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
-0001cf10: 6570 2036 3027 2c0a 2020 2020 2020 2020  ep 60',.        
-0001cf20: 2020 2020 6627 7b5f 5350 4f54 5f51 5545      f'{_SPOT_QUE
-0001cf30: 5545 5f57 4149 547d 7c20 6772 6570 207b  UE_WAIT}| grep {
-0001cf40: 6e61 6d65 7d20 7c20 6865 6164 202d 6e31  name} | head -n1
-0001cf50: 207c 2067 7265 7020 2253 5441 5254 494e   | grep "STARTIN
-0001cf60: 4722 272c 0a20 2020 2020 2020 2020 2020  G"',.           
-0001cf70: 205f 5350 4f54 5f43 414e 4345 4c5f 5741   _SPOT_CANCEL_WA
-0001cf80: 4954 2e66 6f72 6d61 7428 6a6f 625f 6e61  IT.format(job_na
-0001cf90: 6d65 3d6e 616d 6529 2c0a 2020 2020 2020  me=name),.      
-0001cfa0: 2020 2020 2020 2773 6c65 6570 2035 272c        'sleep 5',
-0001cfb0: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
-0001cfc0: 5f53 504f 545f 5155 4555 455f 5741 4954  _SPOT_QUEUE_WAIT
-0001cfd0: 7d7c 2067 7265 7020 7b6e 616d 657d 207c  }| grep {name} |
-0001cfe0: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
-0001cff0: 2022 4341 4e43 454c 4c49 4e47 5c7c 4341   "CANCELLING\|CA
-0001d000: 4e43 454c 4c45 4422 272c 0a20 2020 2020  NCELLED"',.     
-0001d010: 2020 2020 2020 2027 736c 6565 7020 3132         'sleep 12
-0001d020: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
-0001d030: 6627 7b5f 5350 4f54 5f51 5545 5545 5f57  f'{_SPOT_QUEUE_W
-0001d040: 4149 547d 7c20 6772 6570 207b 6e61 6d65  AIT}| grep {name
-0001d050: 7d20 7c20 6865 6164 202d 6e31 207c 2067  } | head -n1 | g
-0001d060: 7265 7020 2243 414e 4345 4c4c 4544 2227  rep "CANCELLED"'
-0001d070: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-0001d080: 5465 7374 2063 616e 6365 6c6c 696e 6720  Test cancelling 
-0001d090: 7468 6520 7370 6f74 2063 6c75 7374 6572  the spot cluster
-0001d0a0: 2064 7572 696e 6720 7370 6f74 206a 6f62   during spot job
-0001d0b0: 2062 6569 6e67 2073 6574 7570 2e0a 2020   being setup..  
-0001d0c0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0001d0d0: 7370 6f74 206c 6175 6e63 6820 2d2d 636c  spot launch --cl
-0001d0e0: 6f75 6420 6763 7020 2d2d 7a6f 6e65 207b  oud gcp --zone {
-0001d0f0: 7a6f 6e65 7d20 2d6e 207b 6e61 6d65 7d2d  zone} -n {name}-
-0001d100: 3220 7465 7374 732f 7465 7374 5f79 616d  2 tests/test_yam
-0001d110: 6c73 2f74 6573 745f 6c6f 6e67 5f73 6574  ls/test_long_set
-0001d120: 7570 2e79 616d 6c20 202d 7920 2d64 272c  up.yaml  -y -d',
-0001d130: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
-0001d140: 6565 7020 3330 3027 2c0a 2020 2020 2020  eep 300',.      
-0001d150: 2020 2020 2020 5f53 504f 545f 4341 4e43        _SPOT_CANC
-0001d160: 454c 5f57 4149 542e 666f 726d 6174 286a  EL_WAIT.format(j
-0001d170: 6f62 5f6e 616d 653d 6627 7b6e 616d 657d  ob_name=f'{name}
-0001d180: 2d32 2729 2c0a 2020 2020 2020 2020 2020  -2'),.          
-0001d190: 2020 2773 6c65 6570 2035 272c 0a20 2020    'sleep 5',.   
-0001d1a0: 2020 2020 2020 2020 2066 277b 5f53 504f           f'{_SPO
-0001d1b0: 545f 5155 4555 455f 5741 4954 7d7c 2067  T_QUEUE_WAIT}| g
-0001d1c0: 7265 7020 7b6e 616d 657d 2d32 207c 2068  rep {name}-2 | h
-0001d1d0: 6561 6420 2d6e 3120 7c20 6772 6570 2022  ead -n1 | grep "
-0001d1e0: 4341 4e43 454c 4c49 4e47 5c7c 4341 4e43  CANCELLING\|CANC
-0001d1f0: 454c 4c45 4422 272c 0a20 2020 2020 2020  ELLED"',.       
-0001d200: 2020 2020 2027 736c 6565 7020 3132 3027       'sleep 120'
-0001d210: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0001d220: 7b5f 5350 4f54 5f51 5545 5545 5f57 4149  {_SPOT_QUEUE_WAI
-0001d230: 547d 7c20 6772 6570 207b 6e61 6d65 7d2d  T}| grep {name}-
-0001d240: 3220 7c20 6865 6164 202d 6e31 207c 2067  2 | head -n1 | g
-0001d250: 7265 7020 2243 414e 4345 4c4c 4544 2227  rep "CANCELLED"'
-0001d260: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-0001d270: 5465 7374 2063 616e 6365 6c6c 6174 696f  Test cancellatio
-0001d280: 6e20 6475 7269 6e67 2073 706f 7420 6a6f  n during spot jo
-0001d290: 6220 6973 2072 6563 6f76 6572 696e 672e  b is recovering.
-0001d2a0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0001d2b0: 6b79 2073 706f 7420 6c61 756e 6368 202d  ky spot launch -
-0001d2c0: 2d63 6c6f 7564 2067 6370 202d 2d7a 6f6e  -cloud gcp --zon
-0001d2d0: 6520 7b7a 6f6e 657d 202d 6e20 7b6e 616d  e {zone} -n {nam
-0001d2e0: 657d 2d33 2022 736c 6565 7020 3130 3030  e}-3 "sleep 1000
-0001d2f0: 2220 202d 7920 2d64 272c 0a20 2020 2020  "  -y -d',.     
-0001d300: 2020 2020 2020 2027 736c 6565 7020 3330         'sleep 30
-0001d310: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
-0001d320: 6627 7b5f 5350 4f54 5f51 5545 5545 5f57  f'{_SPOT_QUEUE_W
-0001d330: 4149 547d 7c20 6772 6570 207b 6e61 6d65  AIT}| grep {name
-0001d340: 7d2d 3320 7c20 6865 6164 202d 6e31 207c  }-3 | head -n1 |
-0001d350: 2067 7265 7020 2252 554e 4e49 4e47 2227   grep "RUNNING"'
-0001d360: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-0001d370: 5465 726d 696e 6174 6520 7468 6520 636c  Terminate the cl
-0001d380: 7573 7465 7220 6d61 6e75 616c 6c79 2e0a  uster manually..
-0001d390: 2020 2020 2020 2020 2020 2020 7465 726d              term
-0001d3a0: 696e 6174 655f 636d 642c 0a20 2020 2020  inate_cmd,.     
-0001d3b0: 2020 2020 2020 2027 736c 6565 7020 3830         'sleep 80
-0001d3c0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0001d3d0: 277b 5f53 504f 545f 5155 4555 455f 5741  '{_SPOT_QUEUE_WA
-0001d3e0: 4954 7d7c 2067 7265 7020 7b6e 616d 657d  IT}| grep {name}
-0001d3f0: 2d33 207c 2068 6561 6420 2d6e 3120 7c20  -3 | head -n1 | 
-0001d400: 6772 6570 2022 5245 434f 5645 5249 4e47  grep "RECOVERING
-0001d410: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-0001d420: 5f53 504f 545f 4341 4e43 454c 5f57 4149  _SPOT_CANCEL_WAI
-0001d430: 542e 666f 726d 6174 286a 6f62 5f6e 616d  T.format(job_nam
-0001d440: 653d 6627 7b6e 616d 657d 2d33 2729 2c0a  e=f'{name}-3'),.
-0001d450: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
-0001d460: 6570 2035 272c 0a20 2020 2020 2020 2020  ep 5',.         
-0001d470: 2020 2066 277b 5f53 504f 545f 5155 4555     f'{_SPOT_QUEU
-0001d480: 455f 5741 4954 7d7c 2067 7265 7020 7b6e  E_WAIT}| grep {n
-0001d490: 616d 657d 2d33 207c 2068 6561 6420 2d6e  ame}-3 | head -n
-0001d4a0: 3120 7c20 6772 6570 2022 4341 4e43 454c  1 | grep "CANCEL
-0001d4b0: 4c49 4e47 5c7c 4341 4e43 454c 4c45 4422  LING\|CANCELLED"
-0001d4c0: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
-0001d4d0: 736c 6565 7020 3132 3027 2c0a 2020 2020  sleep 120',.    
-0001d4e0: 2020 2020 2020 2020 6627 7b5f 5350 4f54          f'{_SPOT
-0001d4f0: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
-0001d500: 6570 207b 6e61 6d65 7d2d 3320 7c20 6865  ep {name}-3 | he
-0001d510: 6164 202d 6e31 207c 2067 7265 7020 2243  ad -n1 | grep "C
-0001d520: 414e 4345 4c4c 4544 2227 2c0a 2020 2020  ANCELLED"',.    
-0001d530: 2020 2020 2020 2020 2320 5468 6520 636c          # The cl
-0001d540: 7573 7465 7220 7368 6f75 6c64 2062 6520  uster should be 
-0001d550: 7465 726d 696e 6174 6564 2028 5354 4f50  terminated (STOP
-0001d560: 5049 4e47 2920 6166 7465 7220 6361 6e63  PING) after canc
-0001d570: 656c 6c61 7469 6f6e 2e20 5765 2064 6f6e  ellation. We don
-0001d580: 2774 2075 7365 2074 6865 2060 3d60 206f  't use the `=` o
-0001d590: 7065 7261 746f 7220 6865 7265 2062 6563  perator here bec
-0001d5a0: 6175 7365 0a20 2020 2020 2020 2020 2020  ause.           
-0001d5b0: 2023 2074 6865 7265 2063 616e 2062 6520   # there can be 
-0001d5c0: 6d75 6c74 6970 6c65 2056 4d20 7769 7468  multiple VM with
-0001d5d0: 2074 6865 2073 616d 6520 6e61 6d65 2064   the same name d
-0001d5e0: 7565 2074 6f20 7468 6520 7265 636f 7665  ue to the recove
-0001d5f0: 7279 2e0a 2020 2020 2020 2020 2020 2020  ry..            
-0001d600: 2866 2773 3d24 287b 7175 6572 795f 7374  (f's=$({query_st
-0001d610: 6174 655f 636d 647d 2920 2626 2065 6368  ate_cmd}) && ech
-0001d620: 6f20 2224 7322 2026 2620 6563 686f 3b20  o "$s" && echo; 
-0001d630: 5b5b 202d 7a20 2224 7322 205d 5d20 7c7c  [[ -z "$s" ]] ||
-0001d640: 2065 6368 6f20 2224 7322 207c 2067 7265   echo "$s" | gre
-0001d650: 7020 2d76 202d 4520 2250 524f 5649 5349  p -v -E "PROVISI
-0001d660: 4f4e 494e 477c 5354 4147 494e 477c 5255  ONING|STAGING|RU
-0001d670: 4e4e 494e 477c 5245 5041 4952 494e 477c  NNING|REPAIRING|
-0001d680: 5445 524d 494e 4154 4544 7c53 5553 5045  TERMINATED|SUSPE
-0001d690: 4e44 494e 477c 5355 5350 454e 4445 447c  NDING|SUSPENDED|
-0001d6a0: 5355 5350 454e 4445 4422 270a 2020 2020  SUSPENDED"'.    
-0001d6b0: 2020 2020 2020 2020 292c 0a20 2020 2020          ),.     
-0001d6c0: 2020 205d 2c0a 2020 2020 2020 2020 7469     ],.        ti
-0001d6d0: 6d65 6f75 743d 3235 202a 2036 3029 0a20  meout=25 * 60). 
-0001d6e0: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-0001d6f0: 7465 7374 290a 0a0a 2320 2d2d 2d2d 2d2d  test)...# ------
-0001d700: 2d2d 2d2d 2054 6573 7469 6e67 2073 746f  ---- Testing sto
-0001d710: 7261 6765 2066 6f72 206d 616e 6167 6564  rage for managed
-0001d720: 2073 706f 7420 2d2d 2d2d 2d2d 2d2d 2d2d   spot ----------
-0001d730: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
-0001d740: 5f66 6c75 6964 7374 6163 6b20 2023 2046  _fluidstack  # F
-0001d750: 6c75 6964 7374 6163 6b20 646f 6573 206e  luidstack does n
-0001d760: 6f74 2073 7570 706f 7274 2073 706f 7420  ot support spot 
-0001d770: 696e 7374 616e 6365 730a 4070 7974 6573  instances.@pytes
-0001d780: 742e 6d61 726b 2e6e 6f5f 617a 7572 6520  t.mark.no_azure 
-0001d790: 2023 2041 7a75 7265 2064 6f65 7320 6e6f   # Azure does no
-0001d7a0: 7420 7375 7070 6f72 7420 7370 6f74 2069  t support spot i
-0001d7b0: 6e73 7461 6e63 6573 0a40 7079 7465 7374  nstances.@pytest
-0001d7c0: 2e6d 6172 6b2e 6e6f 5f6c 616d 6264 615f  .mark.no_lambda_
-0001d7d0: 636c 6f75 6420 2023 204c 616d 6264 6120  cloud  # Lambda 
-0001d7e0: 436c 6f75 6420 646f 6573 206e 6f74 2073  Cloud does not s
-0001d7f0: 7570 706f 7274 2073 706f 7420 696e 7374  upport spot inst
-0001d800: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
-0001d810: 726b 2e6e 6f5f 6962 6d20 2023 2049 424d  rk.no_ibm  # IBM
-0001d820: 2043 6c6f 7564 2064 6f65 7320 6e6f 7420   Cloud does not 
-0001d830: 7375 7070 6f72 7420 7370 6f74 2069 6e73  support spot ins
-0001d840: 7461 6e63 6573 0a40 7079 7465 7374 2e6d  tances.@pytest.m
-0001d850: 6172 6b2e 6e6f 5f70 6170 6572 7370 6163  ark.no_paperspac
-0001d860: 6520 2023 2050 6170 6572 7370 6163 6520  e  # Paperspace 
-0001d870: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
-0001d880: 2073 706f 7420 696e 7374 616e 6365 730a   spot instances.
-0001d890: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
-0001d8a0: 7363 7020 2023 2053 4350 2064 6f65 7320  scp  # SCP does 
-0001d8b0: 6e6f 7420 7375 7070 6f72 7420 7370 6f74  not support spot
-0001d8c0: 2069 6e73 7461 6e63 6573 0a40 7079 7465   instances.@pyte
-0001d8d0: 7374 2e6d 6172 6b2e 6e6f 5f6b 7562 6572  st.mark.no_kuber
-0001d8e0: 6e65 7465 7320 2023 204b 7562 6572 6e65  netes  # Kuberne
-0001d8f0: 7465 7320 646f 6573 206e 6f74 2068 6176  tes does not hav
-0001d900: 6520 6120 6e6f 7469 6f6e 206f 6620 7370  e a notion of sp
-0001d910: 6f74 2069 6e73 7461 6e63 6573 0a40 7079  ot instances.@py
-0001d920: 7465 7374 2e6d 6172 6b2e 6d61 6e61 6765  test.mark.manage
-0001d930: 645f 7370 6f74 0a64 6566 2074 6573 745f  d_spot.def test_
-0001d940: 7370 6f74 5f73 746f 7261 6765 2867 656e  spot_storage(gen
-0001d950: 6572 6963 5f63 6c6f 7564 3a20 7374 7229  eric_cloud: str)
-0001d960: 3a0a 2020 2020 2222 2254 6573 7420 7374  :.    """Test st
-0001d970: 6f72 6167 6520 7769 7468 206d 616e 6167  orage with manag
-0001d980: 6564 2073 706f 7422 2222 0a20 2020 206e  ed spot""".    n
-0001d990: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
-0001d9a0: 6572 5f6e 616d 6528 290a 2020 2020 7961  er_name().    ya
-0001d9b0: 6d6c 5f73 7472 203d 2070 6174 686c 6962  ml_str = pathlib
-0001d9c0: 2e50 6174 6828 0a20 2020 2020 2020 2027  .Path(.        '
-0001d9d0: 6578 616d 706c 6573 2f6d 616e 6167 6564  examples/managed
-0001d9e0: 5f73 706f 745f 7769 7468 5f73 746f 7261  _spot_with_stora
-0001d9f0: 6765 2e79 616d 6c27 292e 7265 6164 5f74  ge.yaml').read_t
-0001da00: 6578 7428 290a 2020 2020 7374 6f72 6167  ext().    storag
-0001da10: 655f 6e61 6d65 203d 2066 2773 6b79 2d74  e_name = f'sky-t
-0001da20: 6573 742d 7b69 6e74 2874 696d 652e 7469  est-{int(time.ti
-0001da30: 6d65 2829 297d 270a 0a20 2020 2023 2041  me())}'..    # A
-0001da40: 6c73 6f20 7065 7266 6f72 6d20 7265 6769  lso perform regi
-0001da50: 6f6e 2074 6573 7469 6e67 2066 6f72 2062  on testing for b
-0001da60: 7563 6b65 7420 6372 6561 7469 6f6e 2074  ucket creation t
-0001da70: 6f20 7661 6c69 6461 7465 2069 6620 6275  o validate if bu
-0001da80: 636b 6574 7320 6172 650a 2020 2020 2320  ckets are.    # 
-0001da90: 6372 6561 7465 6420 696e 2074 6865 2063  created in the c
-0001daa0: 6f72 7265 6374 2072 6567 696f 6e20 616e  orrect region an
-0001dab0: 6420 636f 7272 6563 746c 7920 6d6f 756e  d correctly moun
-0001dac0: 7465 6420 696e 2073 706f 7420 6a6f 6273  ted in spot jobs
-0001dad0: 2e0a 2020 2020 2320 486f 7765 7665 722c  ..    # However,
-0001dae0: 2077 6520 696e 6a65 6374 2074 6869 7320   we inject this 
-0001daf0: 7465 7374 696e 6720 6f6e 6c79 2066 6f72  testing only for
-0001db00: 2041 5753 2061 6e64 2047 4350 2073 696e   AWS and GCP sin
-0001db10: 6365 2074 6865 7920 6172 6520 7468 650a  ce they are the.
-0001db20: 2020 2020 2320 7375 7070 6f72 7465 6420      # supported 
-0001db30: 6f62 6a65 6374 2073 746f 7261 6765 2070  object storage p
-0001db40: 726f 7669 6465 7273 2069 6e20 536b 7950  roviders in SkyP
-0001db50: 696c 6f74 2e0a 2020 2020 7265 6769 6f6e  ilot..    region
-0001db60: 5f66 6c61 6720 3d20 2727 0a20 2020 2072  _flag = ''.    r
-0001db70: 6567 696f 6e5f 7661 6c69 6461 7469 6f6e  egion_validation
-0001db80: 5f63 6d64 203d 2027 7472 7565 270a 2020  _cmd = 'true'.  
-0001db90: 2020 6966 2067 656e 6572 6963 5f63 6c6f    if generic_clo
-0001dba0: 7564 203d 3d20 2761 7773 273a 0a20 2020  ud == 'aws':.   
-0001dbb0: 2020 2020 2072 6567 696f 6e20 3d20 2765       region = 'e
-0001dbc0: 752d 6365 6e74 7261 6c2d 3127 0a20 2020  u-central-1'.   
-0001dbd0: 2020 2020 2072 6567 696f 6e5f 666c 6167       region_flag
-0001dbe0: 203d 2066 2720 2d2d 7265 6769 6f6e 207b   = f' --region {
-0001dbf0: 7265 6769 6f6e 7d27 0a20 2020 2020 2020  region}'.       
-0001dc00: 2072 6567 696f 6e5f 636d 6420 3d20 5465   region_cmd = Te
-0001dc10: 7374 5374 6f72 6167 6557 6974 6843 7265  stStorageWithCre
-0001dc20: 6465 6e74 6961 6c73 2e63 6c69 5f72 6567  dentials.cli_reg
-0001dc30: 696f 6e5f 636d 6428 0a20 2020 2020 2020  ion_cmd(.       
-0001dc40: 2020 2020 2073 746f 7261 6765 5f6c 6962       storage_lib
-0001dc50: 2e53 746f 7265 5479 7065 2e53 332c 2073  .StoreType.S3, s
-0001dc60: 746f 7261 6765 5f6e 616d 6529 0a20 2020  torage_name).   
-0001dc70: 2020 2020 2072 6567 696f 6e5f 7661 6c69       region_vali
-0001dc80: 6461 7469 6f6e 5f63 6d64 203d 2066 277b  dation_cmd = f'{
-0001dc90: 7265 6769 6f6e 5f63 6d64 7d20 7c20 6772  region_cmd} | gr
-0001dca0: 6570 207b 7265 6769 6f6e 7d27 0a20 2020  ep {region}'.   
-0001dcb0: 2065 6c69 6620 6765 6e65 7269 635f 636c   elif generic_cl
-0001dcc0: 6f75 6420 3d3d 2027 6763 7027 3a0a 2020  oud == 'gcp':.  
-0001dcd0: 2020 2020 2020 7265 6769 6f6e 203d 2027        region = '
-0001dce0: 7573 2d77 6573 7432 270a 2020 2020 2020  us-west2'.      
-0001dcf0: 2020 7265 6769 6f6e 5f66 6c61 6720 3d20    region_flag = 
-0001dd00: 6627 202d 2d72 6567 696f 6e20 7b72 6567  f' --region {reg
-0001dd10: 696f 6e7d 270a 2020 2020 2020 2020 7265  ion}'.        re
-0001dd20: 6769 6f6e 5f63 6d64 203d 2054 6573 7453  gion_cmd = TestS
-0001dd30: 746f 7261 6765 5769 7468 4372 6564 656e  torageWithCreden
-0001dd40: 7469 616c 732e 636c 695f 7265 6769 6f6e  tials.cli_region
-0001dd50: 5f63 6d64 280a 2020 2020 2020 2020 2020  _cmd(.          
-0001dd60: 2020 7374 6f72 6167 655f 6c69 622e 5374    storage_lib.St
-0001dd70: 6f72 6554 7970 652e 4743 532c 2073 746f  oreType.GCS, sto
-0001dd80: 7261 6765 5f6e 616d 6529 0a20 2020 2020  rage_name).     
-0001dd90: 2020 2072 6567 696f 6e5f 7661 6c69 6461     region_valida
-0001dda0: 7469 6f6e 5f63 6d64 203d 2066 277b 7265  tion_cmd = f'{re
-0001ddb0: 6769 6f6e 5f63 6d64 7d20 7c20 6772 6570  gion_cmd} | grep
-0001ddc0: 207b 7265 6769 6f6e 7d27 0a0a 2020 2020   {region}'..    
-0001ddd0: 7961 6d6c 5f73 7472 203d 2079 616d 6c5f  yaml_str = yaml_
-0001dde0: 7374 722e 7265 706c 6163 6528 2773 6b79  str.replace('sky
-0001ddf0: 2d77 6f72 6b64 6972 2d7a 6877 7527 2c20  -workdir-zhwu', 
-0001de00: 7374 6f72 6167 655f 6e61 6d65 290a 2020  storage_name).  
-0001de10: 2020 7769 7468 2074 656d 7066 696c 652e    with tempfile.
-0001de20: 4e61 6d65 6454 656d 706f 7261 7279 4669  NamedTemporaryFi
-0001de30: 6c65 2873 7566 6669 783d 272e 7961 6d6c  le(suffix='.yaml
-0001de40: 272c 206d 6f64 653d 2777 2729 2061 7320  ', mode='w') as 
-0001de50: 663a 0a20 2020 2020 2020 2066 2e77 7269  f:.        f.wri
-0001de60: 7465 2879 616d 6c5f 7374 7229 0a20 2020  te(yaml_str).   
-0001de70: 2020 2020 2066 2e66 6c75 7368 2829 0a20       f.flush(). 
-0001de80: 2020 2020 2020 2066 696c 655f 7061 7468         file_path
-0001de90: 203d 2066 2e6e 616d 650a 2020 2020 2020   = f.name.      
-0001dea0: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
-0001deb0: 2020 2020 2020 2020 2020 2027 7370 6f74             'spot
-0001dec0: 5f73 746f 7261 6765 272c 0a20 2020 2020  _storage',.     
-0001ded0: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-0001dee0: 2020 2020 2020 2020 202a 7374 6f72 6167           *storag
-0001def0: 655f 7365 7475 705f 636f 6d6d 616e 6473  e_setup_commands
-0001df00: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001df10: 2020 6627 736b 7920 7370 6f74 206c 6175    f'sky spot lau
-0001df20: 6e63 6820 2d6e 207b 6e61 6d65 7d20 2d2d  nch -n {name} --
-0001df30: 636c 6f75 6420 7b67 656e 6572 6963 5f63  cloud {generic_c
-0001df40: 6c6f 7564 7d7b 7265 6769 6f6e 5f66 6c61  loud}{region_fla
-0001df50: 677d 207b 6669 6c65 5f70 6174 687d 202d  g} {file_path} -
-0001df60: 7927 2c0a 2020 2020 2020 2020 2020 2020  y',.            
-0001df70: 2020 2020 7265 6769 6f6e 5f76 616c 6964      region_valid
-0001df80: 6174 696f 6e5f 636d 642c 2020 2320 4368  ation_cmd,  # Ch
-0001df90: 6563 6b20 6966 2074 6865 2062 7563 6b65  eck if the bucke
-0001dfa0: 7420 6973 2063 7265 6174 6564 2069 6e20  t is created in 
-0001dfb0: 7468 6520 636f 7272 6563 7420 7265 6769  the correct regi
-0001dfc0: 6f6e 0a20 2020 2020 2020 2020 2020 2020  on.             
-0001dfd0: 2020 2027 736c 6565 7020 3630 272c 2020     'sleep 60',  
-0001dfe0: 2320 5761 6974 2074 6865 2073 706f 7420  # Wait the spot 
-0001dff0: 7175 6575 6520 746f 2062 6520 7570 6461  queue to be upda
-0001e000: 7465 640a 2020 2020 2020 2020 2020 2020  ted.            
-0001e010: 2020 2020 6627 7b5f 5350 4f54 5f51 5545      f'{_SPOT_QUE
-0001e020: 5545 5f57 4149 547d 7c20 6772 6570 207b  UE_WAIT}| grep {
-0001e030: 6e61 6d65 7d20 7c20 6772 6570 2053 5543  name} | grep SUC
-0001e040: 4345 4544 4544 272c 0a20 2020 2020 2020  CEEDED',.       
-0001e050: 2020 2020 2020 2020 2066 275b 2024 2861           f'[ $(a
-0001e060: 7773 2073 3361 7069 206c 6973 742d 6275  ws s3api list-bu
-0001e070: 636b 6574 7320 2d2d 7175 6572 7920 2242  ckets --query "B
-0001e080: 7563 6b65 7473 5b3f 636f 6e74 6169 6e73  uckets[?contains
-0001e090: 284e 616d 652c 205c 277b 7374 6f72 6167  (Name, \'{storag
-0001e0a0: 655f 6e61 6d65 7d5c 2729 5d2e 4e61 6d65  e_name}\')].Name
-0001e0b0: 2220 2d2d 6f75 7470 7574 2074 6578 7420  " --output text 
-0001e0c0: 7c20 7763 202d 6c29 202d 6571 2030 205d  | wc -l) -eq 0 ]
-0001e0d0: 270a 2020 2020 2020 2020 2020 2020 5d2c  '.            ],
-0001e0e0: 0a20 2020 2020 2020 2020 2020 205f 5350  .            _SP
-0001e0f0: 4f54 5f43 414e 4345 4c5f 5741 4954 2e66  OT_CANCEL_WAIT.f
-0001e100: 6f72 6d61 7428 6a6f 625f 6e61 6d65 3d6e  ormat(job_name=n
-0001e110: 616d 6529 2c0a 2020 2020 2020 2020 2020  ame),.          
-0001e120: 2020 2320 496e 6372 6561 7365 2074 696d    # Increase tim
-0001e130: 656f 7574 2073 696e 6365 2073 6b79 2073  eout since sky s
-0001e140: 706f 7420 7175 6575 6520 2d72 2063 616e  pot queue -r can
-0001e150: 2062 6520 626c 6f63 6b65 6420 6279 206f   be blocked by o
-0001e160: 7468 6572 2073 706f 7420 7465 7374 732e  ther spot tests.
-0001e170: 0a20 2020 2020 2020 2020 2020 2074 696d  .            tim
-0001e180: 656f 7574 3d32 3020 2a20 3630 2c0a 2020  eout=20 * 60,.  
-0001e190: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0001e1a0: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-0001e1b0: 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d  t)...# ---------
-0001e1c0: 2d20 5465 7374 696e 6720 7370 6f74 2054  - Testing spot T
-0001e1d0: 5055 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070  PU ----------.@p
-0001e1e0: 7974 6573 742e 6d61 726b 2e67 6370 0a40  ytest.mark.gcp.@
-0001e1f0: 7079 7465 7374 2e6d 6172 6b2e 6d61 6e61  pytest.mark.mana
-0001e200: 6765 645f 7370 6f74 0a40 7079 7465 7374  ged_spot.@pytest
-0001e210: 2e6d 6172 6b2e 7470 750a 6465 6620 7465  .mark.tpu.def te
-0001e220: 7374 5f73 706f 745f 7470 7528 293a 0a20  st_spot_tpu():. 
-0001e230: 2020 2022 2222 5465 7374 206d 616e 6167     """Test manag
-0001e240: 6564 2073 706f 7420 6f6e 2054 5055 2e22  ed spot on TPU."
-0001e250: 2222 0a20 2020 206e 616d 6520 3d20 5f67  "".    name = _g
-0001e260: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
-0001e270: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
-0001e280: 7428 0a20 2020 2020 2020 2027 7465 7374  t(.        'test
-0001e290: 2d73 706f 742d 7470 7527 2c0a 2020 2020  -spot-tpu',.    
-0001e2a0: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
-0001e2b0: 2020 6627 736b 7920 7370 6f74 206c 6175    f'sky spot lau
-0001e2c0: 6e63 6820 2d6e 207b 6e61 6d65 7d20 6578  nch -n {name} ex
-0001e2d0: 616d 706c 6573 2f74 7075 2f74 7075 766d  amples/tpu/tpuvm
-0001e2e0: 5f6d 6e69 7374 2e79 616d 6c20 2d79 202d  _mnist.yaml -y -
-0001e2f0: 6427 2c0a 2020 2020 2020 2020 2020 2020  d',.            
-0001e300: 2773 6c65 6570 2035 272c 0a20 2020 2020  'sleep 5',.     
-0001e310: 2020 2020 2020 2066 277b 5f53 504f 545f         f'{_SPOT_
-0001e320: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
-0001e330: 7020 7b6e 616d 657d 207c 2068 6561 6420  p {name} | head 
-0001e340: 2d6e 3120 7c20 6772 6570 2053 5441 5254  -n1 | grep START
-0001e350: 494e 4727 2c0a 2020 2020 2020 2020 2020  ING',.          
-0001e360: 2020 2773 6c65 6570 2039 3030 272c 2020    'sleep 900',  
-0001e370: 2320 5450 5520 7461 6b65 7320 6120 7768  # TPU takes a wh
-0001e380: 696c 6520 746f 206c 6175 6e63 680a 2020  ile to launch.  
-0001e390: 2020 2020 2020 2020 2020 6627 7b5f 5350            f'{_SP
-0001e3a0: 4f54 5f51 5545 5545 5f57 4149 547d 7c20  OT_QUEUE_WAIT}| 
-0001e3b0: 6772 6570 207b 6e61 6d65 7d20 7c20 6865  grep {name} | he
-0001e3c0: 6164 202d 6e31 207c 2067 7265 7020 2252  ad -n1 | grep "R
-0001e3d0: 554e 4e49 4e47 5c7c 5355 4343 4545 4445  UNNING\|SUCCEEDE
-0001e3e0: 4422 272c 0a20 2020 2020 2020 205d 2c0a  D"',.        ],.
-0001e3f0: 2020 2020 2020 2020 5f53 504f 545f 4341          _SPOT_CA
-0001e400: 4e43 454c 5f57 4149 542e 666f 726d 6174  NCEL_WAIT.format
-0001e410: 286a 6f62 5f6e 616d 653d 6e61 6d65 292c  (job_name=name),
-0001e420: 0a20 2020 2020 2020 2023 2049 6e63 7265  .        # Incre
-0001e430: 6173 6520 7469 6d65 6f75 7420 7369 6e63  ase timeout sinc
-0001e440: 6520 736b 7920 7370 6f74 2071 7565 7565  e sky spot queue
-0001e450: 202d 7220 6361 6e20 6265 2062 6c6f 636b   -r can be block
-0001e460: 6564 2062 7920 6f74 6865 7220 7370 6f74  ed by other spot
-0001e470: 2074 6573 7473 2e0a 2020 2020 2020 2020   tests..        
-0001e480: 7469 6d65 6f75 743d 3230 202a 2036 302c  timeout=20 * 60,
-0001e490: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
-0001e4a0: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
-0001e4b0: 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054 6573  # ---------- Tes
-0001e4c0: 7469 6e67 2065 6e76 2066 6f72 2073 706f  ting env for spo
-0001e4d0: 7420 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079  t ----------.@py
-0001e4e0: 7465 7374 2e6d 6172 6b2e 6e6f 5f66 6c75  test.mark.no_flu
-0001e4f0: 6964 7374 6163 6b20 2023 2046 6c75 6964  idstack  # Fluid
-0001e500: 7374 6163 6b20 646f 6573 206e 6f74 2073  stack does not s
-0001e510: 7570 706f 7274 2073 706f 7420 696e 7374  upport spot inst
-0001e520: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
-0001e530: 726b 2e6e 6f5f 617a 7572 6520 2023 2041  rk.no_azure  # A
-0001e540: 7a75 7265 2064 6f65 7320 6e6f 7420 7375  zure does not su
-0001e550: 7070 6f72 7420 7370 6f74 2069 6e73 7461  pport spot insta
-0001e560: 6e63 6573 0a40 7079 7465 7374 2e6d 6172  nces.@pytest.mar
-0001e570: 6b2e 6e6f 5f6c 616d 6264 615f 636c 6f75  k.no_lambda_clou
-0001e580: 6420 2023 204c 616d 6264 6120 436c 6f75  d  # Lambda Clou
-0001e590: 6420 646f 6573 206e 6f74 2073 7570 706f  d does not suppo
-0001e5a0: 7274 2073 706f 7420 696e 7374 616e 6365  rt spot instance
-0001e5b0: 730a 4070 7974 6573 742e 6d61 726b 2e6e  s.@pytest.mark.n
-0001e5c0: 6f5f 6962 6d20 2023 2049 424d 2043 6c6f  o_ibm  # IBM Clo
-0001e5d0: 7564 2064 6f65 7320 6e6f 7420 7375 7070  ud does not supp
-0001e5e0: 6f72 7420 7370 6f74 2069 6e73 7461 6e63  ort spot instanc
-0001e5f0: 6573 0a40 7079 7465 7374 2e6d 6172 6b2e  es.@pytest.mark.
-0001e600: 6e6f 5f73 6370 2020 2320 5343 5020 646f  no_scp  # SCP do
-0001e610: 6573 206e 6f74 2073 7570 706f 7274 2073  es not support s
-0001e620: 706f 7420 696e 7374 616e 6365 730a 4070  pot instances.@p
-0001e630: 7974 6573 742e 6d61 726b 2e6e 6f5f 7061  ytest.mark.no_pa
-0001e640: 7065 7273 7061 6365 2020 2320 5061 7065  perspace  # Pape
-0001e650: 7273 7061 6365 2064 6f65 7320 6e6f 7420  rspace does not 
-0001e660: 7375 7070 6f72 7420 7370 6f74 2069 6e73  support spot ins
-0001e670: 7461 6e63 6573 0a40 7079 7465 7374 2e6d  tances.@pytest.m
-0001e680: 6172 6b2e 6e6f 5f6b 7562 6572 6e65 7465  ark.no_kubernete
-0001e690: 7320 2023 204b 7562 6572 6e65 7465 7320  s  # Kubernetes 
-0001e6a0: 646f 6573 206e 6f74 2068 6176 6520 6120  does not have a 
-0001e6b0: 6e6f 7469 6f6e 206f 6620 7370 6f74 2069  notion of spot i
-0001e6c0: 6e73 7461 6e63 6573 0a40 7079 7465 7374  nstances.@pytest
-0001e6d0: 2e6d 6172 6b2e 6d61 6e61 6765 645f 7370  .mark.managed_sp
-0001e6e0: 6f74 0a64 6566 2074 6573 745f 7370 6f74  ot.def test_spot
-0001e6f0: 5f69 6e6c 696e 655f 656e 7628 6765 6e65  _inline_env(gene
-0001e700: 7269 635f 636c 6f75 643a 2073 7472 293a  ric_cloud: str):
-0001e710: 0a20 2020 2022 2222 5465 7374 2073 706f  .    """Test spo
-0001e720: 7420 656e 7622 2222 0a20 2020 206e 616d  t env""".    nam
-0001e730: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
-0001e740: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
-0001e750: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-0001e760: 2027 7465 7374 2d73 706f 742d 696e 6c69   'test-spot-inli
-0001e770: 6e65 2d65 6e76 272c 0a20 2020 2020 2020  ne-env',.       
-0001e780: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
-0001e790: 2773 6b79 2073 706f 7420 6c61 756e 6368  'sky spot launch
-0001e7a0: 202d 6e20 7b6e 616d 657d 202d 7920 2d2d   -n {name} -y --
-0001e7b0: 636c 6f75 6420 7b67 656e 6572 6963 5f63  cloud {generic_c
-0001e7c0: 6c6f 7564 7d20 2d2d 656e 7620 5445 5354  loud} --env TEST
-0001e7d0: 5f45 4e56 3d22 6865 6c6c 6f20 776f 726c  _ENV="hello worl
-0001e7e0: 6422 202d 2d20 2228 5b5b 2021 202d 7a20  d" -- "([[ ! -z 
-0001e7f0: 5c5c 225c 2454 4553 545f 454e 565c 5c22  \\"\$TEST_ENV\\"
-0001e800: 205d 5d20 2626 205b 5b20 2120 2d7a 205c   ]] && [[ ! -z \
-0001e810: 5c22 5c24 534b 5950 494c 4f54 5f4e 4f44  \"\$SKYPILOT_NOD
-0001e820: 455f 4950 535c 5c22 205d 5d20 2626 205b  E_IPS\\" ]] && [
-0001e830: 5b20 2120 2d7a 205c 5c22 5c24 534b 5950  [ ! -z \\"\$SKYP
-0001e840: 494c 4f54 5f4e 4f44 455f 5241 4e4b 5c5c  ILOT_NODE_RANK\\
-0001e850: 2220 5d5d 2920 7c7c 2065 7869 7420 3122  " ]]) || exit 1"
-0001e860: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
-0001e870: 736c 6565 7020 3230 272c 0a20 2020 2020  sleep 20',.     
-0001e880: 2020 2020 2020 2066 277b 5f53 504f 545f         f'{_SPOT_
-0001e890: 5155 4555 455f 5741 4954 7d20 7c20 6772  QUEUE_WAIT} | gr
-0001e8a0: 6570 207b 6e61 6d65 7d20 7c20 6772 6570  ep {name} | grep
-0001e8b0: 2053 5543 4345 4544 4544 272c 0a20 2020   SUCCEEDED',.   
-0001e8c0: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-0001e8d0: 5f53 504f 545f 4341 4e43 454c 5f57 4149  _SPOT_CANCEL_WAI
-0001e8e0: 542e 666f 726d 6174 286a 6f62 5f6e 616d  T.format(job_nam
-0001e8f0: 653d 6e61 6d65 292c 0a20 2020 2020 2020  e=name),.       
-0001e900: 2023 2049 6e63 7265 6173 6520 7469 6d65   # Increase time
-0001e910: 6f75 7420 7369 6e63 6520 736b 7920 7370  out since sky sp
-0001e920: 6f74 2071 7565 7565 202d 7220 6361 6e20  ot queue -r can 
-0001e930: 6265 2062 6c6f 636b 6564 2062 7920 6f74  be blocked by ot
-0001e940: 6865 7220 7370 6f74 2074 6573 7473 2e0a  her spot tests..
-0001e950: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
-0001e960: 3230 202a 2036 302c 0a20 2020 2029 0a20  20 * 60,.    ). 
-0001e970: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-0001e980: 7465 7374 290a 0a0a 2320 2d2d 2d2d 2d2d  test)...# ------
-0001e990: 2d2d 2d2d 2054 6573 7469 6e67 2065 6e76  ---- Testing env
-0001e9a0: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 6465 6620   ----------.def 
-0001e9b0: 7465 7374 5f69 6e6c 696e 655f 656e 7628  test_inline_env(
-0001e9c0: 6765 6e65 7269 635f 636c 6f75 643a 2073  generic_cloud: s
-0001e9d0: 7472 293a 0a20 2020 2022 2222 5465 7374  tr):.    """Test
-0001e9e0: 2065 6e76 2222 220a 2020 2020 6e61 6d65   env""".    name
-0001e9f0: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
-0001ea00: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
-0001ea10: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
-0001ea20: 2774 6573 742d 696e 6c69 6e65 2d65 6e76  'test-inline-env
-0001ea30: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
-0001ea40: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-0001ea50: 6175 6e63 6820 2d63 207b 6e61 6d65 7d20  aunch -c {name} 
-0001ea60: 2d79 202d 2d63 6c6f 7564 207b 6765 6e65  -y --cloud {gene
-0001ea70: 7269 635f 636c 6f75 647d 202d 2d65 6e76  ric_cloud} --env
-0001ea80: 2054 4553 545f 454e 563d 2268 656c 6c6f   TEST_ENV="hello
-0001ea90: 2077 6f72 6c64 2220 2d2d 2022 285b 5b20   world" -- "([[ 
-0001eaa0: 2120 2d7a 205c 5c22 5c24 5445 5354 5f45  ! -z \\"\$TEST_E
-0001eab0: 4e56 5c5c 2220 5d5d 2026 2620 5b5b 2021  NV\\" ]] && [[ !
-0001eac0: 202d 7a20 5c5c 225c 2453 4b59 5049 4c4f   -z \\"\$SKYPILO
-0001ead0: 545f 4e4f 4445 5f49 5053 5c5c 2220 5d5d  T_NODE_IPS\\" ]]
-0001eae0: 2026 2620 5b5b 2021 202d 7a20 5c5c 225c   && [[ ! -z \\"\
-0001eaf0: 2453 4b59 5049 4c4f 545f 4e4f 4445 5f52  $SKYPILOT_NODE_R
-0001eb00: 414e 4b5c 5c22 205d 5d29 207c 7c20 6578  ANK\\" ]]) || ex
-0001eb10: 6974 2031 2227 2c0a 2020 2020 2020 2020  it 1"',.        
-0001eb20: 2020 2020 2773 6c65 6570 2032 3027 2c0a      'sleep 20',.
-0001eb30: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0001eb40: 7920 6c6f 6773 207b 6e61 6d65 7d20 3120  y logs {name} 1 
-0001eb50: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
-0001eb60: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
-0001eb70: 6320 7b6e 616d 657d 202d 2d65 6e76 2054  c {name} --env T
-0001eb80: 4553 545f 454e 5632 3d22 7375 6363 6573  EST_ENV2="succes
-0001eb90: 7322 2022 285b 5b20 2120 2d7a 205c 5c22  s" "([[ ! -z \\"
-0001eba0: 5c24 5445 5354 5f45 4e56 325c 5c22 205d  \$TEST_ENV2\\" ]
-0001ebb0: 5d20 2626 205b 5b20 2120 2d7a 205c 5c22  ] && [[ ! -z \\"
-0001ebc0: 5c24 534b 5950 494c 4f54 5f4e 4f44 455f  \$SKYPILOT_NODE_
-0001ebd0: 4950 535c 5c22 205d 5d20 2626 205b 5b20  IPS\\" ]] && [[ 
-0001ebe0: 2120 2d7a 205c 5c22 5c24 534b 5950 494c  ! -z \\"\$SKYPIL
-0001ebf0: 4f54 5f4e 4f44 455f 5241 4e4b 5c5c 2220  OT_NODE_RANK\\" 
-0001ec00: 5d5d 2920 7c7c 2065 7869 7420 3122 272c  ]]) || exit 1"',
-0001ec10: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0001ec20: 6b79 206c 6f67 7320 7b6e 616d 657d 2032  ky logs {name} 2
-0001ec30: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
-0001ec40: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
-0001ec50: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
-0001ec60: 6d65 7d27 2c0a 2020 2020 2020 2020 5f67  me}',.        _g
-0001ec70: 6574 5f74 696d 656f 7574 2867 656e 6572  et_timeout(gener
-0001ec80: 6963 5f63 6c6f 7564 292c 0a20 2020 2029  ic_cloud),.    )
-0001ec90: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
-0001eca0: 7428 7465 7374 290a 0a0a 2320 2d2d 2d2d  t(test)...# ----
-0001ecb0: 2d2d 2d2d 2d2d 2054 6573 7469 6e67 2065  ------ Testing e
-0001ecc0: 6e76 2066 696c 6520 2d2d 2d2d 2d2d 2d2d  nv file --------
-0001ecd0: 2d2d 0a64 6566 2074 6573 745f 696e 6c69  --.def test_inli
-0001ece0: 6e65 5f65 6e76 5f66 696c 6528 6765 6e65  ne_env_file(gene
-0001ecf0: 7269 635f 636c 6f75 643a 2073 7472 293a  ric_cloud: str):
-0001ed00: 0a20 2020 2022 2222 5465 7374 2065 6e76  .    """Test env
-0001ed10: 2222 220a 2020 2020 6e61 6d65 203d 205f  """.    name = _
-0001ed20: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
-0001ed30: 2829 0a20 2020 2074 6573 7420 3d20 5465  ().    test = Te
-0001ed40: 7374 280a 2020 2020 2020 2020 2774 6573  st(.        'tes
-0001ed50: 742d 696e 6c69 6e65 2d65 6e76 2d66 696c  t-inline-env-fil
-0001ed60: 6527 2c0a 2020 2020 2020 2020 5b0a 2020  e',.        [.  
-0001ed70: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0001ed80: 6c61 756e 6368 202d 6320 7b6e 616d 657d  launch -c {name}
-0001ed90: 202d 7920 2d2d 636c 6f75 6420 7b67 656e   -y --cloud {gen
-0001eda0: 6572 6963 5f63 6c6f 7564 7d20 2d2d 656e  eric_cloud} --en
-0001edb0: 7620 5445 5354 5f45 4e56 3d22 6865 6c6c  v TEST_ENV="hell
-0001edc0: 6f20 776f 726c 6422 202d 2d20 2228 5b5b  o world" -- "([[
-0001edd0: 2021 202d 7a20 5c5c 225c 2454 4553 545f   ! -z \\"\$TEST_
-0001ede0: 454e 565c 5c22 205d 5d20 2626 205b 5b20  ENV\\" ]] && [[ 
-0001edf0: 2120 2d7a 205c 5c22 5c24 534b 5950 494c  ! -z \\"\$SKYPIL
-0001ee00: 4f54 5f4e 4f44 455f 4950 535c 5c22 205d  OT_NODE_IPS\\" ]
-0001ee10: 5d20 2626 205b 5b20 2120 2d7a 205c 5c22  ] && [[ ! -z \\"
-0001ee20: 5c24 534b 5950 494c 4f54 5f4e 4f44 455f  \$SKYPILOT_NODE_
-0001ee30: 5241 4e4b 5c5c 2220 5d5d 2920 7c7c 2065  RANK\\" ]]) || e
-0001ee40: 7869 7420 3122 272c 0a20 2020 2020 2020  xit 1"',.       
-0001ee50: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-0001ee60: 7b6e 616d 657d 2031 202d 2d73 7461 7475  {name} 1 --statu
-0001ee70: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
-0001ee80: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
-0001ee90: 7d20 2d2d 656e 762d 6669 6c65 2065 7861  } --env-file exa
-0001eea0: 6d70 6c65 732f 7361 6d70 6c65 5f64 6f74  mples/sample_dot
-0001eeb0: 656e 7620 2228 5b5b 2021 202d 7a20 5c5c  env "([[ ! -z \\
-0001eec0: 225c 2454 4553 545f 454e 5632 5c5c 2220  "\$TEST_ENV2\\" 
-0001eed0: 5d5d 2026 2620 5b5b 2021 202d 7a20 5c5c  ]] && [[ ! -z \\
-0001eee0: 225c 2453 4b59 5049 4c4f 545f 4e4f 4445  "\$SKYPILOT_NODE
-0001eef0: 5f49 5053 5c5c 2220 5d5d 2026 2620 5b5b  _IPS\\" ]] && [[
-0001ef00: 2021 202d 7a20 5c5c 225c 2453 4b59 5049   ! -z \\"\$SKYPI
-0001ef10: 4c4f 545f 4e4f 4445 5f52 414e 4b5c 5c22  LOT_NODE_RANK\\"
-0001ef20: 205d 5d29 207c 7c20 6578 6974 2031 2227   ]]) || exit 1"'
-0001ef30: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0001ef40: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-0001ef50: 3220 2d2d 7374 6174 7573 272c 0a20 2020  2 --status',.   
-0001ef60: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-0001ef70: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
-0001ef80: 616d 657d 272c 0a20 2020 2020 2020 205f  ame}',.        _
-0001ef90: 6765 745f 7469 6d65 6f75 7428 6765 6e65  get_timeout(gene
-0001efa0: 7269 635f 636c 6f75 6429 2c0a 2020 2020  ric_cloud),.    
-0001efb0: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
-0001efc0: 7374 2874 6573 7429 0a0a 0a23 202d 2d2d  st(test)...# ---
-0001efd0: 2d2d 2d2d 2d2d 2d20 5465 7374 696e 6720  ------- Testing 
-0001efe0: 6375 7374 6f6d 2069 6d61 6765 202d 2d2d  custom image ---
-0001eff0: 2d2d 2d2d 2d2d 2d0a 4070 7974 6573 742e  -------.@pytest.
-0001f000: 6d61 726b 2e61 7773 0a64 6566 2074 6573  mark.aws.def tes
-0001f010: 745f 6177 735f 6375 7374 6f6d 5f69 6d61  t_aws_custom_ima
-0001f020: 6765 2829 3a0a 2020 2020 2222 2254 6573  ge():.    """Tes
-0001f030: 7420 4157 5320 6375 7374 6f6d 2069 6d61  t AWS custom ima
-0001f040: 6765 2222 220a 2020 2020 6e61 6d65 203d  ge""".    name =
-0001f050: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
-0001f060: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
-0001f070: 5465 7374 280a 2020 2020 2020 2020 2774  Test(.        't
-0001f080: 6573 742d 6177 732d 6375 7374 6f6d 2d69  est-aws-custom-i
-0001f090: 6d61 6765 272c 0a20 2020 2020 2020 205b  mage',.        [
-0001f0a0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0001f0b0: 6b79 206c 6175 6e63 6820 2d63 207b 6e61  ky launch -c {na
-0001f0c0: 6d65 7d20 2d2d 7265 7472 792d 756e 7469  me} --retry-unti
-0001f0d0: 6c2d 7570 202d 7920 7465 7374 732f 7465  l-up -y tests/te
-0001f0e0: 7374 5f79 616d 6c73 2f74 6573 745f 6375  st_yamls/test_cu
-0001f0f0: 7374 6f6d 5f69 6d61 6765 2e79 616d 6c20  stom_image.yaml 
-0001f100: 2d2d 636c 6f75 6420 6177 7320 2d2d 7265  --cloud aws --re
-0001f110: 6769 6f6e 2075 732d 6561 7374 2d32 202d  gion us-east-2 -
-0001f120: 2d69 6d61 6765 2d69 6420 616d 692d 3036  -image-id ami-06
-0001f130: 3264 6464 3930 6662 3666 3832 3637 6127  2ddd90fb6f8267a'
-0001f140: 2c20 2023 204e 7669 6469 6120 696d 6167  ,  # Nvidia imag
-0001f150: 650a 2020 2020 2020 2020 2020 2020 6627  e.            f'
-0001f160: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-0001f170: 3120 2d2d 7374 6174 7573 272c 0a20 2020  1 --status',.   
-0001f180: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-0001f190: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
-0001f1a0: 616d 657d 272c 0a20 2020 2020 2020 2074  ame}',.        t
-0001f1b0: 696d 656f 7574 3d33 3020 2a20 3630 2c0a  imeout=30 * 60,.
-0001f1c0: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
-0001f1d0: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
-0001f1e0: 7079 7465 7374 2e6d 6172 6b2e 6b75 6265  pytest.mark.kube
-0001f1f0: 726e 6574 6573 0a40 7079 7465 7374 2e6d  rnetes.@pytest.m
-0001f200: 6172 6b2e 7061 7261 6d65 7472 697a 6528  ark.parametrize(
-0001f210: 0a20 2020 2022 696d 6167 655f 6964 222c  .    "image_id",
-0001f220: 0a20 2020 205b 0a20 2020 2020 2020 2022  .    [.        "
-0001f230: 646f 636b 6572 3a6e 7669 6469 612f 6375  docker:nvidia/cu
-0001f240: 6461 3a31 312e 382e 302d 6465 7665 6c2d  da:11.8.0-devel-
-0001f250: 7562 756e 7475 3138 2e30 3422 2c0a 2020  ubuntu18.04",.  
-0001f260: 2020 2020 2020 2264 6f63 6b65 723a 7562        "docker:ub
-0001f270: 756e 7475 3a31 382e 3034 222c 0a20 2020  untu:18.04",.   
-0001f280: 2020 2020 2023 2054 6573 7420 6c61 7465       # Test late
-0001f290: 7374 2069 6d61 6765 2077 6974 6820 7079  st image with py
-0001f2a0: 7468 6f6e 2033 2e31 3120 696e 7374 616c  thon 3.11 instal
-0001f2b0: 6c65 6420 6279 2064 6566 6175 6c74 2e0a  led by default..
-0001f2c0: 2020 2020 2020 2020 2320 446f 6573 206e          # Does n
-0001f2d0: 6f74 2077 6f72 6b20 666f 7220 7079 7468  ot work for pyth
-0001f2e0: 6f6e 2033 2e31 3220 6475 6520 746f 2072  on 3.12 due to r
-0001f2f0: 6179 2773 2072 6571 7569 7265 6d65 6e74  ay's requirement
-0001f300: 2066 6f72 2033 2e31 312e 0a20 2020 2020   for 3.11..     
-0001f310: 2020 2027 646f 636b 6572 3a63 6f6e 7469     'docker:conti
-0001f320: 6e75 756d 696f 2f6d 696e 6963 6f6e 6461  nuumio/miniconda
-0001f330: 333a 3234 2e31 2e32 2d30 272c 0a20 2020  3:24.1.2-0',.   
-0001f340: 205d 290a 6465 6620 7465 7374 5f6b 7562   ]).def test_kub
-0001f350: 6572 6e65 7465 735f 6375 7374 6f6d 5f69  ernetes_custom_i
-0001f360: 6d61 6765 2869 6d61 6765 5f69 6429 3a0a  mage(image_id):.
-0001f370: 2020 2020 2222 2254 6573 7420 4b75 6265      """Test Kube
-0001f380: 726e 6574 6573 2063 7573 746f 6d20 696d  rnetes custom im
-0001f390: 6167 6522 2222 0a20 2020 206e 616d 6520  age""".    name 
-0001f3a0: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
-0001f3b0: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
-0001f3c0: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
-0001f3d0: 7465 7374 2d6b 7562 6572 6e65 7465 732d  test-kubernetes-
-0001f3e0: 6375 7374 6f6d 2d69 6d61 6765 272c 0a20  custom-image',. 
-0001f3f0: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-0001f400: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
-0001f410: 6820 2d63 207b 6e61 6d65 7d20 2d2d 7265  h -c {name} --re
-0001f420: 7472 792d 756e 7469 6c2d 7570 202d 7920  try-until-up -y 
-0001f430: 7465 7374 732f 7465 7374 5f79 616d 6c73  tests/test_yamls
-0001f440: 2f74 6573 745f 6375 7374 6f6d 5f69 6d61  /test_custom_ima
-0001f450: 6765 2e79 616d 6c20 2d2d 636c 6f75 6420  ge.yaml --cloud 
-0001f460: 6b75 6265 726e 6574 6573 202d 2d69 6d61  kubernetes --ima
-0001f470: 6765 2d69 6420 7b69 6d61 6765 5f69 647d  ge-id {image_id}
-0001f480: 202d 2d72 6567 696f 6e20 4e6f 6e65 202d   --region None -
-0001f490: 2d67 7075 7320 5434 3a31 272c 0a20 2020  -gpus T4:1',.   
-0001f4a0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-0001f4b0: 6f67 7320 7b6e 616d 657d 2031 202d 2d73  ogs {name} 1 --s
-0001f4c0: 7461 7475 7327 2c0a 2020 2020 2020 2020  tatus',.        
-0001f4d0: 2020 2020 2320 5472 7920 6578 6563 2074      # Try exec t
-0001f4e0: 6f20 7275 6e20 6167 6169 6e20 616e 6420  o run again and 
-0001f4f0: 6368 6563 6b20 6966 2074 6865 206c 6f67  check if the log
-0001f500: 7320 6172 6520 7072 696e 7465 640a 2020  s are printed.  
-0001f510: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0001f520: 6578 6563 207b 6e61 6d65 7d20 7465 7374  exec {name} test
-0001f530: 732f 7465 7374 5f79 616d 6c73 2f74 6573  s/test_yamls/tes
-0001f540: 745f 6375 7374 6f6d 5f69 6d61 6765 2e79  t_custom_image.y
-0001f550: 616d 6c20 2d2d 636c 6f75 6420 6b75 6265  aml --cloud kube
-0001f560: 726e 6574 6573 202d 2d69 6d61 6765 2d69  rnetes --image-i
-0001f570: 6420 7b69 6d61 6765 5f69 647d 202d 2d72  d {image_id} --r
-0001f580: 6567 696f 6e20 4e6f 6e65 202d 2d67 7075  egion None --gpu
-0001f590: 7320 5434 3a31 207c 2067 7265 7020 2248  s T4:1 | grep "H
-0001f5a0: 656c 6c6f 2031 3030 2227 2c0a 2020 2020  ello 100"',.    
-0001f5b0: 2020 2020 2020 2020 2320 4d61 6b65 2073          # Make s
-0001f5c0: 7572 6520 7373 6820 6973 2077 6f72 6b69  ure ssh is worki
-0001f5d0: 6e67 2077 6974 6820 6375 7374 6f6d 2075  ng with custom u
-0001f5e0: 7365 726e 616d 650a 2020 2020 2020 2020  sername.        
-0001f5f0: 2020 2020 6627 7373 6820 7b6e 616d 657d      f'ssh {name}
-0001f600: 2065 6368 6f20 6869 207c 2067 7265 7020   echo hi | grep 
-0001f610: 6869 272c 0a20 2020 2020 2020 205d 2c0a  hi',.        ],.
-0001f620: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
-0001f630: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
-0001f640: 2020 2020 2020 2074 696d 656f 7574 3d33         timeout=3
-0001f650: 3020 2a20 3630 2c0a 2020 2020 290a 2020  0 * 60,.    ).  
-0001f660: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
-0001f670: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
-0001f680: 6172 6b2e 736c 6f77 0a64 6566 2074 6573  ark.slow.def tes
-0001f690: 745f 617a 7572 655f 7374 6172 745f 7374  t_azure_start_st
-0001f6a0: 6f70 5f74 776f 5f6e 6f64 6573 2829 3a0a  op_two_nodes():.
-0001f6b0: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
-0001f6c0: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
-0001f6d0: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
-0001f6e0: 2020 2020 2020 2020 2761 7a75 7265 2d73          'azure-s
-0001f6f0: 7461 7274 2d73 746f 702d 7477 6f2d 6e6f  tart-stop-two-no
-0001f700: 6465 7327 2c0a 2020 2020 2020 2020 5b0a  des',.        [.
-0001f710: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0001f720: 7920 6c61 756e 6368 202d 2d6e 756d 2d6e  y launch --num-n
-0001f730: 6f64 6573 3d32 202d 7920 2d63 207b 6e61  odes=2 -y -c {na
-0001f740: 6d65 7d20 6578 616d 706c 6573 2f61 7a75  me} examples/azu
-0001f750: 7265 5f73 7461 7274 5f73 746f 702e 7961  re_start_stop.ya
-0001f760: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
-0001f770: 2066 2773 6b79 2065 7865 6320 2d2d 6e75   f'sky exec --nu
-0001f780: 6d2d 6e6f 6465 733d 3220 7b6e 616d 657d  m-nodes=2 {name}
-0001f790: 2065 7861 6d70 6c65 732f 617a 7572 655f   examples/azure_
-0001f7a0: 7374 6172 745f 7374 6f70 2e79 616d 6c27  start_stop.yaml'
-0001f7b0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0001f7c0: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-0001f7d0: 3120 2d2d 7374 6174 7573 272c 2020 2320  1 --status',  # 
-0001f7e0: 456e 7375 7265 2074 6865 206a 6f62 2073  Ensure the job s
-0001f7f0: 7563 6365 6564 6564 2e0a 2020 2020 2020  ucceeded..      
-0001f800: 2020 2020 2020 6627 736b 7920 7374 6f70        f'sky stop
-0001f810: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
-0001f820: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
-0001f830: 7461 7274 202d 7920 7b6e 616d 657d 272c  tart -y {name}',
-0001f840: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0001f850: 6b79 2065 7865 6320 2d2d 6e75 6d2d 6e6f  ky exec --num-no
-0001f860: 6465 733d 3220 7b6e 616d 657d 2065 7861  des=2 {name} exa
-0001f870: 6d70 6c65 732f 617a 7572 655f 7374 6172  mples/azure_star
-0001f880: 745f 7374 6f70 2e79 616d 6c27 2c0a 2020  t_stop.yaml',.  
-0001f890: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0001f8a0: 6c6f 6773 207b 6e61 6d65 7d20 3220 2d2d  logs {name} 2 --
-0001f8b0: 7374 6174 7573 272c 2020 2320 456e 7375  status',  # Ensu
-0001f8c0: 7265 2074 6865 206a 6f62 2073 7563 6365  re the job succe
-0001f8d0: 6564 6564 2e0a 2020 2020 2020 2020 5d2c  eded..        ],
-0001f8e0: 0a20 2020 2020 2020 2066 2773 6b79 2064  .        f'sky d
-0001f8f0: 6f77 6e20 2d79 207b 6e61 6d65 7d27 2c0a  own -y {name}',.
-0001f900: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
-0001f910: 3330 202a 2036 302c 2020 2320 3330 206d  30 * 60,  # 30 m
-0001f920: 696e 7320 2028 6974 2074 616b 6573 2061  ins  (it takes a
-0001f930: 726f 756e 6420 7e32 3320 6d69 6e73 290a  round ~23 mins).
-0001f940: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
-0001f950: 655f 7465 7374 2874 6573 7429 0a0a 0a23  e_test(test)...#
-0001f960: 202d 2d2d 2d2d 2d2d 2d2d 2d20 5465 7374   ---------- Test
-0001f970: 696e 6720 656e 7620 666f 7220 6469 736b  ing env for disk
-0001f980: 2074 6965 7220 2d2d 2d2d 2d2d 2d2d 2d2d   tier ----------
-0001f990: 0a40 7079 7465 7374 2e6d 6172 6b2e 6177  .@pytest.mark.aw
-0001f9a0: 730a 6465 6620 7465 7374 5f61 7773 5f64  s.def test_aws_d
-0001f9b0: 6973 6b5f 7469 6572 2829 3a0a 0a20 2020  isk_tier():..   
-0001f9c0: 2064 6566 205f 6765 745f 6177 735f 7175   def _get_aws_qu
-0001f9d0: 6572 795f 636f 6d6d 616e 6428 7265 6769  ery_command(regi
-0001f9e0: 6f6e 2c20 696e 7374 616e 6365 5f69 642c  on, instance_id,
-0001f9f0: 2066 6965 6c64 2c20 6578 7065 6374 6564   field, expected
-0001fa00: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
-0001fa10: 6e20 2866 2761 7773 2065 6332 2064 6573  n (f'aws ec2 des
-0001fa20: 6372 6962 652d 766f 6c75 6d65 7320 2d2d  cribe-volumes --
-0001fa30: 7265 6769 6f6e 207b 7265 6769 6f6e 7d20  region {region} 
-0001fa40: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-0001fa50: 2020 6627 2d2d 6669 6c74 6572 7320 4e61    f'--filters Na
-0001fa60: 6d65 3d61 7474 6163 686d 656e 742e 696e  me=attachment.in
-0001fa70: 7374 616e 6365 2d69 642c 5661 6c75 6573  stance-id,Values
-0001fa80: 3d7b 696e 7374 616e 6365 5f69 647d 2027  ={instance_id} '
-0001fa90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001faa0: 2066 272d 2d71 7565 7279 2056 6f6c 756d   f'--query Volum
-0001fab0: 6573 5b2a 5d2e 7b66 6965 6c64 7d20 7c20  es[*].{field} | 
-0001fac0: 6772 6570 207b 6578 7065 6374 6564 7d20  grep {expected} 
-0001fad0: 3b20 2729 0a0a 2020 2020 666f 7220 6469  ; ')..    for di
-0001fae0: 736b 5f74 6965 7220 696e 206c 6973 7428  sk_tier in list(
-0001faf0: 7265 736f 7572 6365 735f 7574 696c 732e  resources_utils.
-0001fb00: 4469 736b 5469 6572 293a 0a20 2020 2020  DiskTier):.     
-0001fb10: 2020 2073 7065 6373 203d 2041 5753 2e5f     specs = AWS._
-0001fb20: 6765 745f 6469 736b 5f73 7065 6373 2864  get_disk_specs(d
-0001fb30: 6973 6b5f 7469 6572 290a 2020 2020 2020  isk_tier).      
-0001fb40: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
-0001fb50: 7573 7465 725f 6e61 6d65 2829 202b 2027  uster_name() + '
-0001fb60: 2d27 202b 2064 6973 6b5f 7469 6572 2e76  -' + disk_tier.v
-0001fb70: 616c 7565 0a20 2020 2020 2020 206e 616d  alue.        nam
-0001fb80: 655f 6f6e 5f63 6c6f 7564 203d 2063 6f6d  e_on_cloud = com
-0001fb90: 6d6f 6e5f 7574 696c 732e 6d61 6b65 5f63  mon_utils.make_c
-0001fba0: 6c75 7374 6572 5f6e 616d 655f 6f6e 5f63  luster_name_on_c
-0001fbb0: 6c6f 7564 280a 2020 2020 2020 2020 2020  loud(.          
-0001fbc0: 2020 6e61 6d65 2c20 736b 792e 4157 532e    name, sky.AWS.
-0001fbd0: 6d61 785f 636c 7573 7465 725f 6e61 6d65  max_cluster_name
-0001fbe0: 5f6c 656e 6774 6828 2929 0a20 2020 2020  _length()).     
-0001fbf0: 2020 2072 6567 696f 6e20 3d20 2775 732d     region = 'us-
-0001fc00: 6561 7374 2d32 270a 2020 2020 2020 2020  east-2'.        
-0001fc10: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
-0001fc20: 2020 2020 2020 2020 2027 6177 732d 6469           'aws-di
-0001fc30: 736b 2d74 6965 722d 2720 2b20 6469 736b  sk-tier-' + disk
-0001fc40: 5f74 6965 722e 7661 6c75 652c 0a20 2020  _tier.value,.   
-0001fc50: 2020 2020 2020 2020 205b 0a20 2020 2020           [.     
-0001fc60: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-0001fc70: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
-0001fc80: 616d 657d 202d 2d63 6c6f 7564 2061 7773  ame} --cloud aws
-0001fc90: 202d 2d72 6567 696f 6e20 7b72 6567 696f   --region {regio
-0001fca0: 6e7d 2027 0a20 2020 2020 2020 2020 2020  n} '.           
-0001fcb0: 2020 2020 2066 272d 2d64 6973 6b2d 7469       f'--disk-ti
-0001fcc0: 6572 207b 6469 736b 5f74 6965 722e 7661  er {disk_tier.va
-0001fcd0: 6c75 657d 2065 6368 6f20 2268 656c 6c6f  lue} echo "hello
-0001fce0: 2073 6b79 2227 2c0a 2020 2020 2020 2020   sky"',.        
-0001fcf0: 2020 2020 2020 2020 6627 6964 3d60 6177          f'id=`aw
-0001fd00: 7320 6563 3220 6465 7363 7269 6265 2d69  s ec2 describe-i
-0001fd10: 6e73 7461 6e63 6573 202d 2d72 6567 696f  nstances --regio
-0001fd20: 6e20 7b72 6567 696f 6e7d 202d 2d66 696c  n {region} --fil
-0001fd30: 7465 7273 2027 0a20 2020 2020 2020 2020  ters '.         
-0001fd40: 2020 2020 2020 2066 274e 616d 653d 7461         f'Name=ta
-0001fd50: 673a 7261 792d 636c 7573 7465 722d 6e61  g:ray-cluster-na
-0001fd60: 6d65 2c56 616c 7565 733d 7b6e 616d 655f  me,Values={name_
-0001fd70: 6f6e 5f63 6c6f 7564 7d20 2d2d 7175 6572  on_cloud} --quer
-0001fd80: 7920 270a 2020 2020 2020 2020 2020 2020  y '.            
-0001fd90: 2020 2020 6627 5265 7365 7276 6174 696f      f'Reservatio
-0001fda0: 6e73 5b5d 2e49 6e73 7461 6e63 6573 5b5d  ns[].Instances[]
-0001fdb0: 2e49 6e73 7461 6e63 6549 6420 2d2d 6f75  .InstanceId --ou
-0001fdc0: 7470 7574 2074 6578 7460 3b20 2720 2b0a  tput text`; ' +.
-0001fdd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fde0: 5f67 6574 5f61 7773 5f71 7565 7279 5f63  _get_aws_query_c
-0001fdf0: 6f6d 6d61 6e64 2872 6567 696f 6e2c 2027  ommand(region, '
-0001fe00: 2469 6427 2c20 2756 6f6c 756d 6554 7970  $id', 'VolumeTyp
-0001fe10: 6527 2c0a 2020 2020 2020 2020 2020 2020  e',.            
-0001fe20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fe30: 2020 2020 2020 2020 2020 2073 7065 6373             specs
-0001fe40: 5b27 6469 736b 5f74 6965 7227 5d29 202b  ['disk_tier']) +
-0001fe50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001fe60: 2028 2727 2069 6620 6469 736b 5f74 6965   ('' if disk_tie
-0001fe70: 7220 3d3d 2072 6573 6f75 7263 6573 5f75  r == resources_u
-0001fe80: 7469 6c73 2e44 6973 6b54 6965 722e 4c4f  tils.DiskTier.LO
-0001fe90: 5720 656c 7365 0a20 2020 2020 2020 2020  W else.         
-0001fea0: 2020 2020 2020 2020 285f 6765 745f 6177          (_get_aw
-0001feb0: 735f 7175 6572 795f 636f 6d6d 616e 6428  s_query_command(
-0001fec0: 7265 6769 6f6e 2c20 2724 6964 272c 2027  region, '$id', '
-0001fed0: 496f 7073 272c 0a20 2020 2020 2020 2020  Iops',.         
-0001fee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ff00: 7370 6563 735b 2764 6973 6b5f 696f 7073  specs['disk_iops
-0001ff10: 275d 2920 2b0a 2020 2020 2020 2020 2020  ']) +.          
-0001ff20: 2020 2020 2020 2020 5f67 6574 5f61 7773          _get_aws
-0001ff30: 5f71 7565 7279 5f63 6f6d 6d61 6e64 2872  _query_command(r
-0001ff40: 6567 696f 6e2c 2027 2469 6427 2c20 2754  egion, '$id', 'T
-0001ff50: 6872 6f75 6768 7075 7427 2c0a 2020 2020  hroughput',.    
-0001ff60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ff70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ff80: 2020 2020 2073 7065 6373 5b27 6469 736b       specs['disk
-0001ff90: 5f74 6872 6f75 6768 7075 7427 5d29 2929  _throughput'])))
-0001ffa0: 2c0a 2020 2020 2020 2020 2020 2020 5d2c  ,.            ],
-0001ffb0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0001ffc0: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
-0001ffd0: 7d27 2c0a 2020 2020 2020 2020 2020 2020  }',.            
-0001ffe0: 7469 6d65 6f75 743d 3130 202a 2036 302c  timeout=10 * 60,
-0001fff0: 2020 2320 3130 206d 696e 7320 2028 6974    # 10 mins  (it
-00020000: 2074 616b 6573 2061 726f 756e 6420 7e36   takes around ~6
-00020010: 206d 696e 7329 0a20 2020 2020 2020 2029   mins).        )
-00020020: 0a20 2020 2020 2020 2072 756e 5f6f 6e65  .        run_one
-00020030: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
-00020040: 7974 6573 742e 6d61 726b 2e67 6370 0a64  ytest.mark.gcp.d
-00020050: 6566 2074 6573 745f 6763 705f 6469 736b  ef test_gcp_disk
-00020060: 5f74 6965 7228 293a 0a20 2020 2066 6f72  _tier():.    for
-00020070: 2064 6973 6b5f 7469 6572 2069 6e20 6c69   disk_tier in li
-00020080: 7374 2872 6573 6f75 7263 6573 5f75 7469  st(resources_uti
-00020090: 6c73 2e44 6973 6b54 6965 7229 3a0a 2020  ls.DiskTier):.  
-000200a0: 2020 2020 2020 7479 7065 203d 2047 4350        type = GCP
-000200b0: 2e5f 6765 745f 6469 736b 5f74 7970 6528  ._get_disk_type(
-000200c0: 6469 736b 5f74 6965 7229 0a20 2020 2020  disk_tier).     
-000200d0: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
-000200e0: 6c75 7374 6572 5f6e 616d 6528 2920 2b20  luster_name() + 
-000200f0: 272d 2720 2b20 6469 736b 5f74 6965 722e  '-' + disk_tier.
-00020100: 7661 6c75 650a 2020 2020 2020 2020 6e61  value.        na
-00020110: 6d65 5f6f 6e5f 636c 6f75 6420 3d20 636f  me_on_cloud = co
-00020120: 6d6d 6f6e 5f75 7469 6c73 2e6d 616b 655f  mmon_utils.make_
-00020130: 636c 7573 7465 725f 6e61 6d65 5f6f 6e5f  cluster_name_on_
-00020140: 636c 6f75 6428 0a20 2020 2020 2020 2020  cloud(.         
-00020150: 2020 206e 616d 652c 2073 6b79 2e47 4350     name, sky.GCP
-00020160: 2e6d 6178 5f63 6c75 7374 6572 5f6e 616d  .max_cluster_nam
-00020170: 655f 6c65 6e67 7468 2829 290a 2020 2020  e_length()).    
-00020180: 2020 2020 7265 6769 6f6e 203d 2027 7573      region = 'us
-00020190: 2d77 6573 7432 270a 2020 2020 2020 2020  -west2'.        
-000201a0: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
-000201b0: 2020 2020 2020 2020 2027 6763 702d 6469           'gcp-di
-000201c0: 736b 2d74 6965 722d 2720 2b20 6469 736b  sk-tier-' + disk
-000201d0: 5f74 6965 722e 7661 6c75 652c 0a20 2020  _tier.value,.   
-000201e0: 2020 2020 2020 2020 205b 0a20 2020 2020           [.     
-000201f0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00020200: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
-00020210: 616d 657d 202d 2d63 6c6f 7564 2067 6370  ame} --cloud gcp
-00020220: 202d 2d72 6567 696f 6e20 7b72 6567 696f   --region {regio
-00020230: 6e7d 2027 0a20 2020 2020 2020 2020 2020  n} '.           
-00020240: 2020 2020 2066 272d 2d64 6973 6b2d 7469       f'--disk-ti
-00020250: 6572 207b 6469 736b 5f74 6965 722e 7661  er {disk_tier.va
-00020260: 6c75 657d 2065 6368 6f20 2268 656c 6c6f  lue} echo "hello
-00020270: 2073 6b79 2227 2c0a 2020 2020 2020 2020   sky"',.        
-00020280: 2020 2020 2020 2020 6627 6e61 6d65 3d60          f'name=`
-00020290: 6763 6c6f 7564 2063 6f6d 7075 7465 2069  gcloud compute i
-000202a0: 6e73 7461 6e63 6573 206c 6973 7420 2d2d  nstances list --
-000202b0: 6669 6c74 6572 3d27 0a20 2020 2020 2020  filter='.       
-000202c0: 2020 2020 2020 2020 2066 2722 6c61 6265           f'"labe
-000202d0: 6c73 2e72 6179 2d63 6c75 7374 6572 2d6e  ls.ray-cluster-n
-000202e0: 616d 653a 7b6e 616d 655f 6f6e 5f63 6c6f  ame:{name_on_clo
-000202f0: 7564 7d22 2027 0a20 2020 2020 2020 2020  ud}" '.         
-00020300: 2020 2020 2020 2027 2d2d 666f 726d 6174         '--format
-00020310: 3d22 7661 6c75 6528 6e61 6d65 2922 603b  ="value(name)"`;
-00020320: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-00020330: 2020 2066 2767 636c 6f75 6420 636f 6d70     f'gcloud comp
-00020340: 7574 6520 6469 736b 7320 6c69 7374 202d  ute disks list -
-00020350: 2d66 696c 7465 723d 226e 616d 653d 246e  -filter="name=$n
-00020360: 616d 6522 2027 0a20 2020 2020 2020 2020  ame" '.         
-00020370: 2020 2020 2020 2066 272d 2d66 6f72 6d61         f'--forma
-00020380: 743d 2276 616c 7565 2874 7970 6529 2220  t="value(type)" 
-00020390: 7c20 6772 6570 207b 7479 7065 7d20 270a  | grep {type} '.
-000203a0: 2020 2020 2020 2020 2020 2020 5d2c 0a20              ],. 
-000203b0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-000203c0: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
-000203d0: 2c0a 2020 2020 2020 2020 2020 2020 7469  ,.            ti
-000203e0: 6d65 6f75 743d 3620 2a20 3630 2c20 2023  meout=6 * 60,  #
-000203f0: 2036 206d 696e 7320 2028 6974 2074 616b   6 mins  (it tak
-00020400: 6573 2061 726f 756e 6420 7e33 206d 696e  es around ~3 min
-00020410: 7329 0a20 2020 2020 2020 2029 0a20 2020  s).        ).   
-00020420: 2020 2020 2072 756e 5f6f 6e65 5f74 6573       run_one_tes
-00020430: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
-00020440: 742e 6d61 726b 2e61 7a75 7265 0a64 6566  t.mark.azure.def
-00020450: 2074 6573 745f 617a 7572 655f 6469 736b   test_azure_disk
-00020460: 5f74 6965 7228 293a 0a20 2020 2066 6f72  _tier():.    for
-00020470: 2064 6973 6b5f 7469 6572 2069 6e20 6c69   disk_tier in li
-00020480: 7374 2872 6573 6f75 7263 6573 5f75 7469  st(resources_uti
-00020490: 6c73 2e44 6973 6b54 6965 7229 3a0a 2020  ls.DiskTier):.  
-000204a0: 2020 2020 2020 6966 2064 6973 6b5f 7469        if disk_ti
-000204b0: 6572 203d 3d20 7265 736f 7572 6365 735f  er == resources_
-000204c0: 7574 696c 732e 4469 736b 5469 6572 2e48  utils.DiskTier.H
-000204d0: 4947 483a 0a20 2020 2020 2020 2020 2020  IGH:.           
-000204e0: 2023 2041 7a75 7265 2064 6f65 7320 6e6f   # Azure does no
-000204f0: 7420 7375 7070 6f72 7420 6869 6768 2064  t support high d
-00020500: 6973 6b20 7469 6572 2e0a 2020 2020 2020  isk tier..      
-00020510: 2020 2020 2020 636f 6e74 696e 7565 0a20        continue. 
-00020520: 2020 2020 2020 2074 7970 6520 3d20 417a         type = Az
-00020530: 7572 652e 5f67 6574 5f64 6973 6b5f 7479  ure._get_disk_ty
-00020540: 7065 2864 6973 6b5f 7469 6572 290a 2020  pe(disk_tier).  
-00020550: 2020 2020 2020 6e61 6d65 203d 205f 6765        name = _ge
-00020560: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
-00020570: 202b 2027 2d27 202b 2064 6973 6b5f 7469   + '-' + disk_ti
-00020580: 6572 2e76 616c 7565 0a20 2020 2020 2020  er.value.       
-00020590: 206e 616d 655f 6f6e 5f63 6c6f 7564 203d   name_on_cloud =
-000205a0: 2063 6f6d 6d6f 6e5f 7574 696c 732e 6d61   common_utils.ma
-000205b0: 6b65 5f63 6c75 7374 6572 5f6e 616d 655f  ke_cluster_name_
-000205c0: 6f6e 5f63 6c6f 7564 280a 2020 2020 2020  on_cloud(.      
-000205d0: 2020 2020 2020 6e61 6d65 2c20 736b 792e        name, sky.
-000205e0: 417a 7572 652e 6d61 785f 636c 7573 7465  Azure.max_cluste
-000205f0: 725f 6e61 6d65 5f6c 656e 6774 6828 2929  r_name_length())
-00020600: 0a20 2020 2020 2020 2072 6567 696f 6e20  .        region 
-00020610: 3d20 2777 6573 7475 7332 270a 2020 2020  = 'westus2'.    
-00020620: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
-00020630: 0a20 2020 2020 2020 2020 2020 2027 617a  .            'az
-00020640: 7572 652d 6469 736b 2d74 6965 722d 2720  ure-disk-tier-' 
-00020650: 2b20 6469 736b 5f74 6965 722e 7661 6c75  + disk_tier.valu
-00020660: 652c 0a20 2020 2020 2020 2020 2020 205b  e,.            [
-00020670: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00020680: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
-00020690: 202d 6320 7b6e 616d 657d 202d 2d63 6c6f   -c {name} --clo
-000206a0: 7564 2061 7a75 7265 202d 2d72 6567 696f  ud azure --regio
-000206b0: 6e20 7b72 6567 696f 6e7d 2027 0a20 2020  n {region} '.   
-000206c0: 2020 2020 2020 2020 2020 2020 2066 272d               f'-
-000206d0: 2d64 6973 6b2d 7469 6572 207b 6469 736b  -disk-tier {disk
-000206e0: 5f74 6965 722e 7661 6c75 657d 2065 6368  _tier.value} ech
-000206f0: 6f20 2268 656c 6c6f 2073 6b79 2227 2c0a  o "hello sky"',.
-00020700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020710: 6627 617a 2072 6573 6f75 7263 6520 6c69  f'az resource li
-00020720: 7374 202d 2d74 6167 2072 6179 2d63 6c75  st --tag ray-clu
-00020730: 7374 6572 2d6e 616d 653d 7b6e 616d 655f  ster-name={name_
-00020740: 6f6e 5f63 6c6f 7564 7d20 2d2d 7175 6572  on_cloud} --quer
-00020750: 7920 270a 2020 2020 2020 2020 2020 2020  y '.            
-00020760: 2020 2020 6627 225b 3f74 7970 653d 3d5c      f'"[?type==\
-00020770: 274d 6963 726f 736f 6674 2e43 6f6d 7075  'Microsoft.Compu
-00020780: 7465 2f64 6973 6b73 5c27 5d2e 736b 752e  te/disks\'].sku.
-00020790: 6e61 6d65 2220 270a 2020 2020 2020 2020  name" '.        
-000207a0: 2020 2020 2020 2020 6627 2d2d 6f75 7470          f'--outp
-000207b0: 7574 2074 7376 207c 2067 7265 7020 7b74  ut tsv | grep {t
-000207c0: 7970 657d 270a 2020 2020 2020 2020 2020  ype}'.          
-000207d0: 2020 5d2c 0a20 2020 2020 2020 2020 2020    ],.           
-000207e0: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
-000207f0: 6e61 6d65 7d27 2c0a 2020 2020 2020 2020  name}',.        
-00020800: 2020 2020 7469 6d65 6f75 743d 3230 202a      timeout=20 *
-00020810: 2036 302c 2020 2320 3230 206d 696e 7320   60,  # 20 mins 
-00020820: 2028 6974 2074 616b 6573 2061 726f 756e   (it takes aroun
-00020830: 6420 7e31 3220 6d69 6e73 290a 2020 2020  d ~12 mins).    
-00020840: 2020 2020 290a 2020 2020 2020 2020 7275      ).        ru
-00020850: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
-00020860: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
-00020870: 617a 7572 650a 6465 6620 7465 7374 5f61  azure.def test_a
-00020880: 7a75 7265 5f62 6573 745f 7469 6572 5f66  zure_best_tier_f
-00020890: 6169 6c6f 7665 7228 293a 0a20 2020 2074  ailover():.    t
-000208a0: 7970 6520 3d20 417a 7572 652e 5f67 6574  ype = Azure._get
-000208b0: 5f64 6973 6b5f 7479 7065 2872 6573 6f75  _disk_type(resou
-000208c0: 7263 6573 5f75 7469 6c73 2e44 6973 6b54  rces_utils.DiskT
-000208d0: 6965 722e 4c4f 5729 0a20 2020 206e 616d  ier.LOW).    nam
-000208e0: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
-000208f0: 5f6e 616d 6528 290a 2020 2020 6e61 6d65  _name().    name
-00020900: 5f6f 6e5f 636c 6f75 6420 3d20 636f 6d6d  _on_cloud = comm
-00020910: 6f6e 5f75 7469 6c73 2e6d 616b 655f 636c  on_utils.make_cl
-00020920: 7573 7465 725f 6e61 6d65 5f6f 6e5f 636c  uster_name_on_cl
-00020930: 6f75 6428 0a20 2020 2020 2020 206e 616d  oud(.        nam
-00020940: 652c 2073 6b79 2e41 7a75 7265 2e6d 6178  e, sky.Azure.max
-00020950: 5f63 6c75 7374 6572 5f6e 616d 655f 6c65  _cluster_name_le
-00020960: 6e67 7468 2829 290a 2020 2020 7265 6769  ngth()).    regi
-00020970: 6f6e 203d 2027 7765 7374 7573 3227 0a20  on = 'westus2'. 
-00020980: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
-00020990: 2020 2020 2020 2020 2761 7a75 7265 2d62          'azure-b
-000209a0: 6573 742d 7469 6572 2d66 6169 6c6f 7665  est-tier-failove
-000209b0: 7227 2c0a 2020 2020 2020 2020 5b0a 2020  r',.        [.  
-000209c0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-000209d0: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
-000209e0: 6d65 7d20 2d2d 636c 6f75 6420 617a 7572  me} --cloud azur
-000209f0: 6520 2d2d 7265 6769 6f6e 207b 7265 6769  e --region {regi
-00020a00: 6f6e 7d20 270a 2020 2020 2020 2020 2020  on} '.          
-00020a10: 2020 6627 2d2d 6469 736b 2d74 6965 7220    f'--disk-tier 
-00020a20: 6265 7374 202d 2d69 6e73 7461 6e63 652d  best --instance-
-00020a30: 7479 7065 2053 7461 6e64 6172 645f 4438  type Standard_D8
-00020a40: 5f76 3520 6563 686f 2022 6865 6c6c 6f20  _v5 echo "hello 
-00020a50: 736b 7922 272c 0a20 2020 2020 2020 2020  sky"',.         
-00020a60: 2020 2066 2761 7a20 7265 736f 7572 6365     f'az resource
-00020a70: 206c 6973 7420 2d2d 7461 6720 7261 792d   list --tag ray-
-00020a80: 636c 7573 7465 722d 6e61 6d65 3d7b 6e61  cluster-name={na
-00020a90: 6d65 5f6f 6e5f 636c 6f75 647d 202d 2d71  me_on_cloud} --q
-00020aa0: 7565 7279 2027 0a20 2020 2020 2020 2020  uery '.         
-00020ab0: 2020 2066 2722 5b3f 7479 7065 3d3d 5c27     f'"[?type==\'
-00020ac0: 4d69 6372 6f73 6f66 742e 436f 6d70 7574  Microsoft.Comput
-00020ad0: 652f 6469 736b 735c 275d 2e73 6b75 2e6e  e/disks\'].sku.n
-00020ae0: 616d 6522 2027 0a20 2020 2020 2020 2020  ame" '.         
-00020af0: 2020 2066 272d 2d6f 7574 7075 7420 7473     f'--output ts
-00020b00: 7620 7c20 6772 6570 207b 7479 7065 7d27  v | grep {type}'
-00020b10: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
-00020b20: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
-00020b30: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
-00020b40: 2020 2020 7469 6d65 6f75 743d 3230 202a      timeout=20 *
-00020b50: 2036 302c 2020 2320 3230 206d 696e 7320   60,  # 20 mins 
-00020b60: 2028 6974 2074 616b 6573 2061 726f 756e   (it takes aroun
-00020b70: 6420 7e31 3220 6d69 6e73 290a 2020 2020  d ~12 mins).    
-00020b80: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
-00020b90: 7374 2874 6573 7429 0a0a 0a23 202d 2d2d  st(test)...# ---
-00020ba0: 2d2d 2d20 5465 7374 696e 6720 5a65 726f  --- Testing Zero
-00020bb0: 2051 756f 7461 2046 6169 6c6f 7665 7220   Quota Failover 
-00020bc0: 2d2d 2d2d 2d2d 0a40 7079 7465 7374 2e6d  ------.@pytest.m
-00020bd0: 6172 6b2e 6177 730a 6465 6620 7465 7374  ark.aws.def test
-00020be0: 5f61 7773 5f7a 6572 6f5f 7175 6f74 615f  _aws_zero_quota_
-00020bf0: 6661 696c 6f76 6572 2829 3a0a 0a20 2020  failover():..   
-00020c00: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
-00020c10: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
-00020c20: 7265 6769 6f6e 203d 2067 6574 5f61 7773  region = get_aws
-00020c30: 5f72 6567 696f 6e5f 666f 725f 7175 6f74  _region_for_quot
-00020c40: 615f 6661 696c 6f76 6572 2829 0a0a 2020  a_failover()..  
-00020c50: 2020 6966 206e 6f74 2072 6567 696f 6e3a    if not region:
-00020c60: 0a20 2020 2020 2020 2070 7974 6573 742e  .        pytest.
-00020c70: 7866 6169 6c28 0a20 2020 2020 2020 2020  xfail(.         
-00020c80: 2020 2027 556e 6162 6c65 2074 6f20 7465     'Unable to te
-00020c90: 7374 207a 6572 6f20 7175 6f74 6120 6661  st zero quota fa
-00020ca0: 696c 6f76 6572 206f 7074 696d 697a 6174  ilover optimizat
-00020cb0: 696f 6e20 e280 9420 7175 6f74 6173 2027  ion ... quotas '
-00020cc0: 0a20 2020 2020 2020 2020 2020 2027 666f  .            'fo
-00020cd0: 7220 4543 3220 5033 2069 6e73 7461 6e63  r EC2 P3 instanc
-00020ce0: 6573 2077 6572 6520 666f 756e 6420 6f6e  es were found on
-00020cf0: 2061 6c6c 2041 5753 2072 6567 696f 6e73   all AWS regions
-00020d00: 2e20 4973 2074 6869 7320 270a 2020 2020  . Is this '.    
-00020d10: 2020 2020 2020 2020 2765 7870 6563 7465          'expecte
-00020d20: 6420 666f 7220 796f 7572 2061 6363 6f75  d for your accou
-00020d30: 6e74 3f27 290a 2020 2020 2020 2020 7265  nt?').        re
-00020d40: 7475 726e 0a0a 2020 2020 7465 7374 203d  turn..    test =
-00020d50: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
-00020d60: 6177 732d 7a65 726f 2d71 756f 7461 2d66  aws-zero-quota-f
-00020d70: 6169 6c6f 7665 7227 2c0a 2020 2020 2020  ailover',.      
-00020d80: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
-00020d90: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
-00020da0: 2d63 207b 6e61 6d65 7d20 2d2d 636c 6f75  -c {name} --clou
-00020db0: 6420 6177 7320 2d2d 7265 6769 6f6e 207b  d aws --region {
-00020dc0: 7265 6769 6f6e 7d20 2d2d 6770 7573 2056  region} --gpus V
-00020dd0: 3130 303a 3820 2d2d 7573 652d 7370 6f74  100:8 --use-spot
-00020de0: 207c 2067 7265 7020 2246 6f75 6e64 206e   | grep "Found n
-00020df0: 6f20 7175 6f74 6122 272c 0a20 2020 2020  o quota"',.     
-00020e00: 2020 205d 2c0a 2020 2020 2020 2020 6627     ],.        f'
-00020e10: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
-00020e20: 657d 272c 0a20 2020 2029 0a20 2020 2072  e}',.    ).    r
-00020e30: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
-00020e40: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
-00020e50: 2e67 6370 0a64 6566 2074 6573 745f 6763  .gcp.def test_gc
-00020e60: 705f 7a65 726f 5f71 756f 7461 5f66 6169  p_zero_quota_fai
-00020e70: 6c6f 7665 7228 293a 0a0a 2020 2020 6e61  lover():..    na
-00020e80: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
-00020e90: 725f 6e61 6d65 2829 0a20 2020 2072 6567  r_name().    reg
-00020ea0: 696f 6e20 3d20 6765 745f 6763 705f 7265  ion = get_gcp_re
-00020eb0: 6769 6f6e 5f66 6f72 5f71 756f 7461 5f66  gion_for_quota_f
-00020ec0: 6169 6c6f 7665 7228 290a 0a20 2020 2069  ailover()..    i
-00020ed0: 6620 6e6f 7420 7265 6769 6f6e 3a0a 2020  f not region:.  
-00020ee0: 2020 2020 2020 7079 7465 7374 2e78 6661        pytest.xfa
-00020ef0: 696c 280a 2020 2020 2020 2020 2020 2020  il(.            
-00020f00: 2755 6e61 626c 6520 746f 2074 6573 7420  'Unable to test 
-00020f10: 7a65 726f 2071 756f 7461 2066 6169 6c6f  zero quota failo
-00020f20: 7665 7220 6f70 7469 6d69 7a61 7469 6f6e  ver optimization
-00020f30: 20e2 8094 2071 756f 7461 7320 270a 2020   ... quotas '.  
-00020f40: 2020 2020 2020 2020 2020 2766 6f72 2041            'for A
-00020f50: 3130 302d 3830 4742 2047 5055 7320 7765  100-80GB GPUs we
-00020f60: 7265 2066 6f75 6e64 206f 6e20 616c 6c20  re found on all 
-00020f70: 4743 5020 7265 6769 6f6e 732e 2049 7320  GCP regions. Is 
-00020f80: 7468 6973 2027 0a20 2020 2020 2020 2020  this '.         
-00020f90: 2020 2027 6578 7065 6374 6564 2066 6f72     'expected for
-00020fa0: 2079 6f75 7220 6163 636f 756e 743f 2729   your account?')
-00020fb0: 0a20 2020 2020 2020 2072 6574 7572 6e0a  .        return.
-00020fc0: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
-00020fd0: 280a 2020 2020 2020 2020 2767 6370 2d7a  (.        'gcp-z
-00020fe0: 6572 6f2d 7175 6f74 612d 6661 696c 6f76  ero-quota-failov
-00020ff0: 6572 272c 0a20 2020 2020 2020 205b 0a20  er',.        [. 
-00021000: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00021010: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
-00021020: 616d 657d 202d 2d63 6c6f 7564 2067 6370  ame} --cloud gcp
-00021030: 202d 2d72 6567 696f 6e20 7b72 6567 696f   --region {regio
-00021040: 6e7d 202d 2d67 7075 7320 4131 3030 2d38  n} --gpus A100-8
-00021050: 3047 423a 3120 2d2d 7573 652d 7370 6f74  0GB:1 --use-spot
-00021060: 207c 2067 7265 7020 2246 6f75 6e64 206e   | grep "Found n
-00021070: 6f20 7175 6f74 6122 272c 0a20 2020 2020  o quota"',.     
-00021080: 2020 205d 2c0a 2020 2020 2020 2020 6627     ],.        f'
-00021090: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
-000210a0: 657d 272c 0a20 2020 2029 0a20 2020 2072  e}',.    ).    r
-000210b0: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
-000210c0: 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d  )...# ----------
-000210d0: 2054 6573 7469 6e67 2073 6b79 7365 7276   Testing skyserv
-000210e0: 6520 2d2d 2d2d 2d2d 2d2d 2d2d 0a0a 0a64  e ----------...d
-000210f0: 6566 205f 6765 745f 7365 7276 6963 655f  ef _get_service_
-00021100: 6e61 6d65 2829 202d 3e20 7374 723a 0a20  name() -> str:. 
-00021110: 2020 2022 2222 5265 7475 726e 7320 6120     """Returns a 
-00021120: 7573 6572 2d75 6e69 7175 6520 7365 7276  user-unique serv
-00021130: 6963 6520 6e61 6d65 2066 6f72 2065 6163  ice name for eac
-00021140: 6820 7465 7374 5f73 6b79 7365 7276 655f  h test_skyserve_
-00021150: 3c6e 616d 653e 2829 2e0a 0a20 2020 204d  <name>()...    M
-00021160: 7573 7420 6265 2063 616c 6c65 6420 6672  ust be called fr
-00021170: 6f6d 2065 6163 6820 7465 7374 5f73 6b79  om each test_sky
-00021180: 7365 7276 655f 3c6e 616d 653e 2829 2e0a  serve_<name>()..
-00021190: 2020 2020 2222 220a 2020 2020 6361 6c6c      """.    call
-000211a0: 6572 5f66 756e 635f 6e61 6d65 203d 2069  er_func_name = i
-000211b0: 6e73 7065 6374 2e73 7461 636b 2829 5b31  nspect.stack()[1
-000211c0: 5d5b 335d 0a20 2020 2074 6573 745f 6e61  ][3].    test_na
-000211d0: 6d65 203d 2063 616c 6c65 725f 6675 6e63  me = caller_func
-000211e0: 5f6e 616d 652e 7265 706c 6163 6528 275f  _name.replace('_
-000211f0: 272c 2027 2d27 292e 7265 706c 6163 6528  ', '-').replace(
-00021200: 2774 6573 742d 272c 2027 742d 2729 0a20  'test-', 't-'). 
-00021210: 2020 2074 6573 745f 6e61 6d65 203d 2074     test_name = t
-00021220: 6573 745f 6e61 6d65 2e72 6570 6c61 6365  est_name.replace
-00021230: 2827 736b 7973 6572 7665 2d27 2c20 2773  ('skyserve-', 's
-00021240: 732d 2729 0a20 2020 2074 6573 745f 6e61  s-').    test_na
-00021250: 6d65 203d 2063 6f6d 6d6f 6e5f 7574 696c  me = common_util
-00021260: 732e 6d61 6b65 5f63 6c75 7374 6572 5f6e  s.make_cluster_n
-00021270: 616d 655f 6f6e 5f63 6c6f 7564 2874 6573  ame_on_cloud(tes
-00021280: 745f 6e61 6d65 2c20 3234 290a 2020 2020  t_name, 24).    
-00021290: 7265 7475 726e 2066 277b 7465 7374 5f6e  return f'{test_n
-000212a0: 616d 657d 2d7b 7465 7374 5f69 647d 270a  ame}-{test_id}'.
-000212b0: 0a0a 2320 5765 2063 6865 636b 2074 6865  ..# We check the
-000212c0: 206f 7574 7075 7420 6f66 2074 6865 2073   output of the s
-000212d0: 6b79 7365 7276 6520 7365 7276 6963 6520  kyserve service 
-000212e0: 746f 2073 6565 2069 6620 6974 2069 7320  to see if it is 
-000212f0: 7265 6164 792e 204f 7574 7075 7420 6f66  ready. Output of
-00021300: 0a23 2060 5245 504c 4943 4153 6020 6973  .# `REPLICAS` is
-00021310: 2069 6e20 7468 6520 666f 726d 206f 6620   in the form of 
-00021320: 6031 2f32 6020 7768 6572 6520 7468 6520  `1/2` where the 
-00021330: 6669 7273 7420 6e75 6d62 6572 2069 7320  first number is 
-00021340: 7468 6520 6e75 6d62 6572 206f 660a 2320  the number of.# 
-00021350: 7265 6164 7920 7265 706c 6963 6173 2061  ready replicas a
-00021360: 6e64 2074 6865 2073 6563 6f6e 6420 6e75  nd the second nu
-00021370: 6d62 6572 2069 7320 7468 6520 6e75 6d62  mber is the numb
-00021380: 6572 206f 6620 746f 7461 6c20 7265 706c  er of total repl
-00021390: 6963 6173 2e20 5765 0a23 2067 7265 7020  icas. We.# grep 
-000213a0: 7375 6368 2066 6f72 6d61 7420 746f 2065  such format to e
-000213b0: 6e73 7572 6520 7468 6174 2074 6865 2073  nsure that the s
-000213c0: 6572 7669 6365 2069 7320 7265 6164 792c  ervice is ready,
-000213d0: 2061 6e64 2065 6172 6c79 2065 7869 7420   and early exit 
-000213e0: 6966 2061 6e79 0a23 2066 6169 6c75 7265  if any.# failure
-000213f0: 2064 6574 6563 7465 642e 2049 6e20 7468   detected. In th
-00021400: 6520 656e 6420 7765 2073 6c65 6570 2066  e end we sleep f
-00021410: 6f72 0a23 2073 6572 7665 2e4c 425f 434f  or.# serve.LB_CO
-00021420: 4e54 524f 4c4c 4552 5f53 594e 435f 494e  NTROLLER_SYNC_IN
-00021430: 5445 5256 414c 5f53 4543 4f4e 4453 2074  TERVAL_SECONDS t
-00021440: 6f20 6d61 6b65 2073 7572 6520 6c6f 6164  o make sure load
-00021450: 2062 616c 616e 6365 7220 6861 7665 0a23   balancer have.#
-00021460: 2065 6e6f 7567 6820 7469 6d65 2074 6f20   enough time to 
-00021470: 7379 6e63 2077 6974 6820 7468 6520 636f  sync with the co
-00021480: 6e74 726f 6c6c 6572 2061 6e64 2067 6574  ntroller and get
-00021490: 2061 6c6c 2072 6561 6479 2072 6570 6c69   all ready repli
-000214a0: 6361 2049 5073 2e0a 5f53 4552 5645 5f57  ca IPs.._SERVE_W
-000214b0: 4149 545f 554e 5449 4c5f 5245 4144 5920  AIT_UNTIL_READY 
-000214c0: 3d20 280a 2020 2020 277b 7b20 7768 696c  = (.    '{{ whil
-000214d0: 6520 7472 7565 3b20 646f 270a 2020 2020  e true; do'.    
-000214e0: 2720 2020 2020 733d 2428 736b 7920 7365  '     s=$(sky se
-000214f0: 7276 6520 7374 6174 7573 207b 6e61 6d65  rve status {name
-00021500: 7d29 3b20 6563 686f 2022 2473 223b 270a  }); echo "$s";'.
-00021510: 2020 2020 2720 2020 2020 6563 686f 2022      '     echo "
-00021520: 2473 2220 7c20 6772 6570 202d 7120 227b  $s" | grep -q "{
-00021530: 7265 706c 6963 615f 6e75 6d7d 2f7b 7265  replica_num}/{re
-00021540: 706c 6963 615f 6e75 6d7d 2220 2626 2062  plica_num}" && b
-00021550: 7265 616b 3b27 0a20 2020 2027 2020 2020  reak;'.    '    
-00021560: 2065 6368 6f20 2224 7322 207c 2067 7265   echo "$s" | gre
-00021570: 7020 2d71 2022 4641 494c 4544 2220 2626  p -q "FAILED" &&
-00021580: 2065 7869 7420 313b 270a 2020 2020 2720   exit 1;'.    ' 
-00021590: 2020 2020 736c 6565 7020 3130 3b27 0a20      sleep 10;'. 
-000215a0: 2020 2027 2064 6f6e 653b 207d 7d3b 2065     ' done; }}; e
-000215b0: 6368 6f20 2247 6f74 2073 6572 7669 6365  cho "Got service
-000215c0: 2073 7461 7475 7320 2473 223b 270a 2020   status $s";'.  
-000215d0: 2020 6627 736c 6565 7020 7b73 6572 7665    f'sleep {serve
-000215e0: 2e4c 425f 434f 4e54 524f 4c4c 4552 5f53  .LB_CONTROLLER_S
-000215f0: 594e 435f 494e 5445 5256 414c 5f53 4543  YNC_INTERVAL_SEC
-00021600: 4f4e 4453 202b 2032 7d3b 2729 0a5f 4950  ONDS + 2};')._IP
-00021610: 5f52 4547 4558 203d 2072 2728 5b30 2d39  _REGEX = r'([0-9
-00021620: 5d7b 312c 337d 5c2e 297b 337d 5b30 2d39  ]{1,3}\.){3}[0-9
-00021630: 5d7b 312c 337d 270a 5f41 574b 5f41 4c4c  ]{1,3}'._AWK_ALL
-00021640: 5f4c 494e 4553 5f42 454c 4f57 5f52 4550  _LINES_BELOW_REP
-00021650: 4c49 4341 5320 3d20 7227 2f52 6570 6c69  LICAS = r'/Repli
-00021660: 6361 732f 7b66 6c61 673d 313b 206e 6578  cas/{flag=1; nex
-00021670: 747d 2066 6c61 6727 0a5f 5345 5256 4943  t} flag'._SERVIC
-00021680: 455f 4c41 554e 4348 494e 475f 5354 4154  E_LAUNCHING_STAT
-00021690: 5553 5f52 4547 4558 203d 2027 5052 4f56  US_REGEX = 'PROV
-000216a0: 4953 494f 4e49 4e47 5c7c 5354 4152 5449  ISIONING\|STARTI
-000216b0: 4e47 270a 2320 5369 6e63 6520 7765 2064  NG'.# Since we d
-000216c0: 6f6e 2774 2061 6c6c 6f77 2074 6572 6d69  on't allow termi
-000216d0: 6e61 7465 2074 6865 2073 6572 7669 6365  nate the service
-000216e0: 2069 6620 7468 6520 636f 6e74 726f 6c6c   if the controll
-000216f0: 6572 2069 7320 494e 4954 2c0a 2320 7768  er is INIT,.# wh
-00021700: 6963 6820 6973 2063 6f6d 6d6f 6e20 666f  ich is common fo
-00021710: 7220 7369 6d75 6c74 616e 656f 7573 2070  r simultaneous p
-00021720: 7974 6573 742c 2077 6520 6e65 6564 2074  ytest, we need t
-00021730: 6f20 7761 6974 2075 6e74 696c 2074 6865  o wait until the
-00021740: 0a23 2063 6f6e 7472 6f6c 6c65 7220 6973  .# controller is
-00021750: 2055 5020 6265 666f 7265 2077 6520 6361   UP before we ca
-00021760: 6e20 7465 726d 696e 6174 6520 7468 6520  n terminate the 
-00021770: 7365 7276 6963 652e 0a23 2054 6865 2074  service..# The t
-00021780: 6561 7264 6f77 6e20 636f 6d6d 616e 6420  eardown command 
-00021790: 6861 7320 6120 3130 2d6d 696e 7320 7469  has a 10-mins ti
-000217a0: 6d65 6f75 742c 2073 6f20 7765 2064 6f6e  meout, so we don
-000217b0: 2774 206e 6565 6420 746f 2064 6f0a 2320  't need to do.# 
-000217c0: 7468 6520 7469 6d65 6f75 7420 6865 7265  the timeout here
-000217d0: 2e20 5365 6520 696d 706c 656d 656e 7461  . See implementa
-000217e0: 7469 6f6e 206f 6620 7275 6e5f 6f6e 655f  tion of run_one_
-000217f0: 7465 7374 2829 2066 6f72 2064 6574 6169  test() for detai
-00021800: 6c73 2e0a 5f54 4541 5244 4f57 4e5f 5345  ls.._TEARDOWN_SE
-00021810: 5256 4943 4520 3d20 280a 2020 2020 2728  RVICE = (.    '(
-00021820: 666f 7220 6920 696e 2060 7365 7120 3120  for i in `seq 1 
-00021830: 3230 603b 2064 6f27 0a20 2020 2027 2020  20`; do'.    '  
-00021840: 2020 2073 3d24 2873 6b79 2073 6572 7665     s=$(sky serve
-00021850: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d29   down -y {name})
-00021860: 3b27 0a20 2020 2027 2020 2020 2065 6368  ;'.    '     ech
-00021870: 6f20 2254 7279 696e 6720 746f 2074 6572  o "Trying to ter
-00021880: 6d69 6e61 7465 207b 6e61 6d65 7d22 3b27  minate {name}";'
-00021890: 0a20 2020 2027 2020 2020 2065 6368 6f20  .    '     echo 
-000218a0: 2224 7322 3b27 0a20 2020 2027 2020 2020  "$s";'.    '    
-000218b0: 2065 6368 6f20 2224 7322 207c 2067 7265   echo "$s" | gre
-000218c0: 7020 2d71 2022 7363 6865 6475 6c65 6420  p -q "scheduled 
-000218d0: 746f 2062 6520 7465 726d 696e 6174 6564  to be terminated
-000218e0: 5c7c 4e6f 2073 6572 7669 6365 2074 6f20  \|No service to 
-000218f0: 7465 726d 696e 6174 6522 2026 2620 6272  terminate" && br
-00021900: 6561 6b3b 270a 2020 2020 2720 2020 2020  eak;'.    '     
-00021910: 736c 6565 7020 3130 3b27 0a20 2020 2027  sleep 10;'.    '
-00021920: 2020 2020 205b 2024 6920 2d65 7120 3230       [ $i -eq 20
-00021930: 205d 2026 2620 6563 686f 2022 4661 696c   ] && echo "Fail
-00021940: 6564 2074 6f20 7465 726d 696e 6174 6520  ed to terminate 
-00021950: 7365 7276 6963 6520 7b6e 616d 657d 223b  service {name}";
-00021960: 270a 2020 2020 2764 6f6e 6529 2729 0a0a  '.    'done)')..
-00021970: 5f53 4552 5645 5f45 4e44 504f 494e 545f  _SERVE_ENDPOINT_
-00021980: 5741 4954 203d 2028 0a20 2020 2027 6578  WAIT = (.    'ex
-00021990: 706f 7274 204f 5249 4749 4e5f 534b 5950  port ORIGIN_SKYP
-000219a0: 494c 4f54 5f44 4542 5547 3d24 534b 5950  ILOT_DEBUG=$SKYP
-000219b0: 494c 4f54 5f44 4542 5547 3b20 6578 706f  ILOT_DEBUG; expo
-000219c0: 7274 2053 4b59 5049 4c4f 545f 4445 4255  rt SKYPILOT_DEBU
-000219d0: 473d 303b 2027 0a20 2020 2027 656e 6470  G=0; '.    'endp
-000219e0: 6f69 6e74 3d24 2873 6b79 2073 6572 7665  oint=$(sky serve
-000219f0: 2073 7461 7475 7320 2d2d 656e 6470 6f69   status --endpoi
-00021a00: 6e74 207b 6e61 6d65 7d29 3b20 270a 2020  nt {name}); '.  
-00021a10: 2020 2775 6e74 696c 2021 2065 6368 6f20    'until ! echo 
-00021a20: 2224 656e 6470 6f69 6e74 2220 7c20 6772  "$endpoint" | gr
-00021a30: 6570 2022 436f 6e74 726f 6c6c 6572 2069  ep "Controller i
-00021a40: 7320 696e 6974 6961 6c69 7a69 6e67 223b  s initializing";
-00021a50: 2027 0a20 2020 2027 646f 2065 6368 6f20   '.    'do echo 
-00021a60: 2257 6169 7469 6e67 2066 6f72 2073 6572  "Waiting for ser
-00021a70: 7665 2065 6e64 706f 696e 7420 746f 2062  ve endpoint to b
-00021a80: 6520 7265 6164 792e 2e2e 223b 2027 0a20  e ready..."; '. 
-00021a90: 2020 2027 736c 6565 7020 353b 2065 6e64     'sleep 5; end
-00021aa0: 706f 696e 743d 2428 736b 7920 7365 7276  point=$(sky serv
-00021ab0: 6520 7374 6174 7573 202d 2d65 6e64 706f  e status --endpo
-00021ac0: 696e 7420 7b6e 616d 657d 293b 2064 6f6e  int {name}); don
-00021ad0: 653b 2027 0a20 2020 2027 6578 706f 7274  e; '.    'export
-00021ae0: 2053 4b59 5049 4c4f 545f 4445 4255 473d   SKYPILOT_DEBUG=
-00021af0: 244f 5249 4749 4e5f 534b 5950 494c 4f54  $ORIGIN_SKYPILOT
-00021b00: 5f44 4542 5547 3b20 6563 686f 2022 2465  _DEBUG; echo "$e
-00021b10: 6e64 706f 696e 7422 2729 0a0a 5f53 4552  ndpoint"').._SER
-00021b20: 5645 5f53 5441 5455 535f 5741 4954 203d  VE_STATUS_WAIT =
-00021b30: 2028 2773 3d24 2873 6b79 2073 6572 7665   ('s=$(sky serve
-00021b40: 2073 7461 7475 7320 7b6e 616d 657d 293b   status {name});
-00021b50: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-00021b60: 2020 2020 2020 2020 2027 756e 7469 6c20           'until 
-00021b70: 2120 6563 686f 2022 2473 2220 7c20 6772  ! echo "$s" | gr
-00021b80: 6570 2022 436f 6e74 726f 6c6c 6572 2069  ep "Controller i
-00021b90: 7320 696e 6974 6961 6c69 7a69 6e67 2e22  s initializing."
-00021ba0: 3b20 270a 2020 2020 2020 2020 2020 2020  ; '.            
-00021bb0: 2020 2020 2020 2020 2020 2764 6f20 6563            'do ec
-00021bc0: 686f 2022 5761 6974 696e 6720 666f 7220  ho "Waiting for 
-00021bd0: 7365 7276 6520 7374 6174 7573 2074 6f20  serve status to 
-00021be0: 6265 2072 6561 6479 2e2e 2e22 3b20 270a  be ready..."; '.
-00021bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021c00: 2020 2020 2020 2773 6c65 6570 2035 3b20        'sleep 5; 
-00021c10: 733d 2428 736b 7920 7365 7276 6520 7374  s=$(sky serve st
-00021c20: 6174 7573 207b 6e61 6d65 7d29 3b20 646f  atus {name}); do
-00021c30: 6e65 3b20 6563 686f 2022 2473 2227 290a  ne; echo "$s"').
-00021c40: 0a0a 6465 6620 5f67 6574 5f72 6570 6c69  ..def _get_repli
-00021c50: 6361 5f69 7028 6e61 6d65 3a20 7374 722c  ca_ip(name: str,
-00021c60: 2072 6570 6c69 6361 5f69 643a 2069 6e74   replica_id: int
-00021c70: 2920 2d3e 2073 7472 3a0a 2020 2020 7265  ) -> str:.    re
-00021c80: 7475 726e 2028 6627 6970 7b72 6570 6c69  turn (f'ip{repli
-00021c90: 6361 5f69 647d 3d24 2865 6368 6f20 2224  ca_id}=$(echo "$
-00021ca0: 7322 207c 2027 0a20 2020 2020 2020 2020  s" | '.         
-00021cb0: 2020 2066 2761 776b 2022 7b5f 4157 4b5f     f'awk "{_AWK_
-00021cc0: 414c 4c5f 4c49 4e45 535f 4245 4c4f 575f  ALL_LINES_BELOW_
-00021cd0: 5245 504c 4943 4153 7d22 207c 2027 0a20  REPLICAS}" | '. 
-00021ce0: 2020 2020 2020 2020 2020 2066 2767 7265             f'gre
-00021cf0: 7020 2d45 2022 7b6e 616d 657d 5c73 2b7b  p -E "{name}\s+{
-00021d00: 7265 706c 6963 615f 6964 7d22 207c 2027  replica_id}" | '
-00021d10: 0a20 2020 2020 2020 2020 2020 2066 2767  .            f'g
-00021d20: 7265 7020 2d45 6f20 227b 5f49 505f 5245  rep -Eo "{_IP_RE
-00021d30: 4745 587d 2229 2729 0a0a 0a64 6566 205f  GEX}")')...def _
-00021d40: 6765 745f 736b 7973 6572 7665 5f68 7474  get_skyserve_htt
-00021d50: 705f 7465 7374 286e 616d 653a 2073 7472  p_test(name: str
-00021d60: 2c20 636c 6f75 643a 2073 7472 2c0a 2020  , cloud: str,.  
-00021d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021d80: 2020 2020 2020 2020 2020 7469 6d65 6f75            timeou
-00021d90: 745f 6d69 6e75 7465 733a 2069 6e74 2920  t_minutes: int) 
-00021da0: 2d3e 2054 6573 743a 0a20 2020 2074 6573  -> Test:.    tes
-00021db0: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
-00021dc0: 2020 6627 7465 7374 2d73 6b79 7365 7276    f'test-skyserv
-00021dd0: 652d 7b63 6c6f 7564 2e72 6570 6c61 6365  e-{cloud.replace
-00021de0: 2822 5f22 2c20 222d 2229 7d27 2c0a 2020  ("_", "-")}',.  
-00021df0: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
-00021e00: 2020 2020 6627 736b 7920 7365 7276 6520      f'sky serve 
-00021e10: 7570 202d 6e20 7b6e 616d 657d 202d 7920  up -n {name} -y 
-00021e20: 7465 7374 732f 736b 7973 6572 7665 2f68  tests/skyserve/h
-00021e30: 7474 702f 7b63 6c6f 7564 7d2e 7961 6d6c  ttp/{cloud}.yaml
-00021e40: 272c 0a20 2020 2020 2020 2020 2020 205f  ',.            _
-00021e50: 5345 5256 455f 5741 4954 5f55 4e54 494c  SERVE_WAIT_UNTIL
-00021e60: 5f52 4541 4459 2e66 6f72 6d61 7428 6e61  _READY.format(na
-00021e70: 6d65 3d6e 616d 652c 2072 6570 6c69 6361  me=name, replica
-00021e80: 5f6e 756d 3d32 292c 0a20 2020 2020 2020  _num=2),.       
-00021e90: 2020 2020 2066 277b 5f53 4552 5645 5f45       f'{_SERVE_E
-00021ea0: 4e44 504f 494e 545f 5741 4954 2e66 6f72  NDPOINT_WAIT.for
-00021eb0: 6d61 7428 6e61 6d65 3d6e 616d 6529 7d3b  mat(name=name)};
-00021ec0: 2027 0a20 2020 2020 2020 2020 2020 2027   '.            '
-00021ed0: 6375 726c 202d 4c20 6874 7470 3a2f 2f24  curl -L http://$
-00021ee0: 656e 6470 6f69 6e74 207c 2067 7265 7020  endpoint | grep 
-00021ef0: 2248 692c 2053 6b79 5069 6c6f 7420 6865  "Hi, SkyPilot he
-00021f00: 7265 2227 2c0a 2020 2020 2020 2020 5d2c  re"',.        ],
-00021f10: 0a20 2020 2020 2020 205f 5445 4152 444f  .        _TEARDO
-00021f20: 574e 5f53 4552 5649 4345 2e66 6f72 6d61  WN_SERVICE.forma
-00021f30: 7428 6e61 6d65 3d6e 616d 6529 2c0a 2020  t(name=name),.  
-00021f40: 2020 2020 2020 7469 6d65 6f75 743d 7469        timeout=ti
-00021f50: 6d65 6f75 745f 6d69 6e75 7465 7320 2a20  meout_minutes * 
-00021f60: 3630 2c0a 2020 2020 290a 2020 2020 7265  60,.    ).    re
-00021f70: 7475 726e 2074 6573 740a 0a0a 6465 6620  turn test...def 
-00021f80: 5f63 6865 636b 5f72 6570 6c69 6361 5f69  _check_replica_i
-00021f90: 6e5f 7374 6174 7573 286e 616d 653a 2073  n_status(name: s
-00021fa0: 7472 2c20 6368 6563 6b5f 7475 706c 6573  tr, check_tuples
-00021fb0: 3a20 4c69 7374 5b54 7570 6c65 5b69 6e74  : List[Tuple[int
-00021fc0: 2c20 626f 6f6c 2c0a 2020 2020 2020 2020  , bool,.        
-00021fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022000: 2020 2020 2020 2020 2073 7472 5d5d 2920           str]]) 
-00022010: 2d3e 2073 7472 3a0a 2020 2020 2222 2243  -> str:.    """C
-00022020: 6865 636b 2072 6570 6c69 6361 7327 2073  heck replicas' s
-00022030: 7461 7475 7320 616e 6420 636f 756e 7420  tatus and count 
-00022040: 696e 2073 6b79 2073 6572 7665 2073 7461  in sky serve sta
-00022050: 7475 730a 0a20 2020 2057 6520 7769 6c6c  tus..    We will
-00022060: 2063 6865 636b 2076 4350 553d 322c 2061   check vCPU=2, a
-00022070: 7320 616c 6c20 6f75 7220 7465 7374 7320  s all our tests 
-00022080: 7573 6520 7643 5055 3d32 2e0a 2020 2020  use vCPU=2..    
-00022090: 0a20 2020 2041 7267 733a 0a20 2020 2020  .    Args:.     
-000220a0: 2020 206e 616d 653a 2074 6865 206e 616d     name: the nam
-000220b0: 6520 6f66 2074 6865 2073 6572 7669 6365  e of the service
-000220c0: 0a20 2020 2020 2020 2063 6865 636b 5f74  .        check_t
-000220d0: 7570 6c65 733a 2041 206c 6973 7420 6f66  uples: A list of
-000220e0: 2072 6570 6c69 6361 2070 726f 7065 7274   replica propert
-000220f0: 7920 746f 2063 6865 636b 2e20 4561 6368  y to check. Each
-00022100: 2074 7570 6c65 2069 730a 2020 2020 2020   tuple is.      
-00022110: 2020 2020 2020 2863 6f75 6e74 2c20 6973        (count, is
-00022120: 5f73 706f 742c 2073 7461 7475 7329 0a20  _spot, status). 
-00022130: 2020 2022 2222 0a20 2020 2063 6865 636b     """.    check
-00022140: 5f63 6d64 203d 2027 270a 2020 2020 666f  _cmd = ''.    fo
-00022150: 7220 6368 6563 6b5f 7475 706c 6520 696e  r check_tuple in
-00022160: 2063 6865 636b 5f74 7570 6c65 733a 0a20   check_tuples:. 
-00022170: 2020 2020 2020 2063 6f75 6e74 2c20 6973         count, is
-00022180: 5f73 706f 742c 2073 7461 7475 7320 3d20  _spot, status = 
-00022190: 6368 6563 6b5f 7475 706c 650a 2020 2020  check_tuple.    
-000221a0: 2020 2020 7265 736f 7572 6365 5f73 7472      resource_str
-000221b0: 203d 2027 270a 2020 2020 2020 2020 6966   = ''.        if
-000221c0: 2073 7461 7475 7320 6e6f 7420 696e 205b   status not in [
-000221d0: 2750 454e 4449 4e47 272c 2027 5348 5554  'PENDING', 'SHUT
-000221e0: 5449 4e47 5f44 4f57 4e27 0a20 2020 2020  TING_DOWN'.     
-000221f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022200: 2020 2020 5d20 616e 6420 6e6f 7420 7374      ] and not st
-00022210: 6174 7573 2e73 7461 7274 7377 6974 6828  atus.startswith(
-00022220: 2746 4149 4c45 4427 293a 0a20 2020 2020  'FAILED'):.     
-00022230: 2020 2020 2020 2073 706f 745f 7374 7220         spot_str 
-00022240: 3d20 2727 0a20 2020 2020 2020 2020 2020  = ''.           
-00022250: 2069 6620 6973 5f73 706f 743a 0a20 2020   if is_spot:.   
-00022260: 2020 2020 2020 2020 2020 2020 2073 706f               spo
-00022270: 745f 7374 7220 3d20 275c 5b53 706f 745c  t_str = '\[Spot\
-00022280: 5d27 0a20 2020 2020 2020 2020 2020 2072  ]'.            r
-00022290: 6573 6f75 7263 655f 7374 7220 3d20 6627  esource_str = f'
-000222a0: 287b 7370 6f74 5f73 7472 7d76 4350 553d  ({spot_str}vCPU=
-000222b0: 3229 270a 2020 2020 2020 2020 6368 6563  2)'.        chec
-000222c0: 6b5f 636d 6420 2b3d 2028 6627 2065 6368  k_cmd += (f' ech
-000222d0: 6f20 2224 7322 207c 2067 7265 7020 227b  o "$s" | grep "{
-000222e0: 7265 736f 7572 6365 5f73 7472 7d22 207c  resource_str}" |
-000222f0: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-00022300: 2020 2020 2020 2020 2066 2767 7265 7020           f'grep 
-00022310: 227b 7374 6174 7573 7d22 207c 2077 6320  "{status}" | wc 
-00022320: 2d6c 207c 2067 7265 7020 7b63 6f75 6e74  -l | grep {count
-00022330: 7d20 7c7c 2065 7869 7420 313b 2729 0a20  } || exit 1;'). 
-00022340: 2020 2072 6574 7572 6e20 2866 277b 5f53     return (f'{_S
-00022350: 4552 5645 5f53 5441 5455 535f 5741 4954  ERVE_STATUS_WAIT
-00022360: 2e66 6f72 6d61 7428 6e61 6d65 3d6e 616d  .format(name=nam
-00022370: 6529 7d3b 2065 6368 6f20 2224 7322 3b20  e)}; echo "$s"; 
-00022380: 2720 2b20 6368 6563 6b5f 636d 6429 0a0a  ' + check_cmd)..
-00022390: 0a64 6566 205f 6368 6563 6b5f 7365 7276  .def _check_serv
-000223a0: 6963 655f 7665 7273 696f 6e28 7365 7276  ice_version(serv
-000223b0: 6963 655f 6e61 6d65 3a20 7374 722c 2076  ice_name: str, v
-000223c0: 6572 7369 6f6e 3a20 7374 7229 202d 3e20  ersion: str) -> 
-000223d0: 7374 723a 0a20 2020 2023 2047 7265 7020  str:.    # Grep 
-000223e0: 7468 6520 6c69 6e65 7320 6265 666f 7265  the lines before
-000223f0: 2027 5365 7276 6963 6520 5265 706c 6963   'Service Replic
-00022400: 6173 2720 616e 6420 6368 6563 6b20 6966  as' and check if
-00022410: 2074 6865 2073 6572 7669 6365 2076 6572   the service ver
-00022420: 7369 6f6e 0a20 2020 2023 2069 7320 636f  sion.    # is co
-00022430: 7272 6563 742e 0a20 2020 2072 6574 7572  rrect..    retur
-00022440: 6e20 2866 2765 6368 6f20 2224 7322 207c  n (f'echo "$s" |
-00022450: 2067 7265 7020 2d42 3130 3030 2022 5365   grep -B1000 "Se
-00022460: 7276 6963 6520 5265 706c 6963 6173 2220  rvice Replicas" 
-00022470: 7c20 270a 2020 2020 2020 2020 2020 2020  | '.            
-00022480: 6627 6772 6570 202d 4520 227b 7365 7276  f'grep -E "{serv
-00022490: 6963 655f 6e61 6d65 7d5c 732b 7b76 6572  ice_name}\s+{ver
-000224a0: 7369 6f6e 7d22 207c 7c20 6578 6974 2031  sion}" || exit 1
-000224b0: 3b20 2729 0a0a 0a40 7079 7465 7374 2e6d  ; ')...@pytest.m
-000224c0: 6172 6b2e 6763 700a 4070 7974 6573 742e  ark.gcp.@pytest.
-000224d0: 6d61 726b 2e73 6572 7665 0a64 6566 2074  mark.serve.def t
-000224e0: 6573 745f 736b 7973 6572 7665 5f67 6370  est_skyserve_gcp
-000224f0: 5f68 7474 7028 293a 0a20 2020 2022 2222  _http():.    """
-00022500: 5465 7374 2073 6b79 7365 7276 6520 6f6e  Test skyserve on
-00022510: 2047 4350 2222 220a 2020 2020 6e61 6d65   GCP""".    name
-00022520: 203d 205f 6765 745f 7365 7276 6963 655f   = _get_service_
-00022530: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
-00022540: 3d20 5f67 6574 5f73 6b79 7365 7276 655f  = _get_skyserve_
-00022550: 6874 7470 5f74 6573 7428 6e61 6d65 2c20  http_test(name, 
-00022560: 2767 6370 272c 2032 3029 0a20 2020 2072  'gcp', 20).    r
-00022570: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
-00022580: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
-00022590: 2e61 7773 0a40 7079 7465 7374 2e6d 6172  .aws.@pytest.mar
-000225a0: 6b2e 7365 7276 650a 6465 6620 7465 7374  k.serve.def test
-000225b0: 5f73 6b79 7365 7276 655f 6177 735f 6874  _skyserve_aws_ht
-000225c0: 7470 2829 3a0a 2020 2020 2222 2254 6573  tp():.    """Tes
-000225d0: 7420 736b 7973 6572 7665 206f 6e20 4157  t skyserve on AW
-000225e0: 5322 2222 0a20 2020 206e 616d 6520 3d20  S""".    name = 
-000225f0: 5f67 6574 5f73 6572 7669 6365 5f6e 616d  _get_service_nam
-00022600: 6528 290a 2020 2020 7465 7374 203d 205f  e().    test = _
-00022610: 6765 745f 736b 7973 6572 7665 5f68 7474  get_skyserve_htt
-00022620: 705f 7465 7374 286e 616d 652c 2027 6177  p_test(name, 'aw
-00022630: 7327 2c20 3230 290a 2020 2020 7275 6e5f  s', 20).    run_
-00022640: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
-00022650: 0a40 7079 7465 7374 2e6d 6172 6b2e 617a  .@pytest.mark.az
-00022660: 7572 650a 4070 7974 6573 742e 6d61 726b  ure.@pytest.mark
-00022670: 2e73 6572 7665 0a64 6566 2074 6573 745f  .serve.def test_
-00022680: 736b 7973 6572 7665 5f61 7a75 7265 5f68  skyserve_azure_h
-00022690: 7474 7028 293a 0a20 2020 2022 2222 5465  ttp():.    """Te
-000226a0: 7374 2073 6b79 7365 7276 6520 6f6e 2041  st skyserve on A
-000226b0: 7a75 7265 2222 220a 2020 2020 6e61 6d65  zure""".    name
-000226c0: 203d 205f 6765 745f 7365 7276 6963 655f   = _get_service_
-000226d0: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
-000226e0: 3d20 5f67 6574 5f73 6b79 7365 7276 655f  = _get_skyserve_
-000226f0: 6874 7470 5f74 6573 7428 6e61 6d65 2c20  http_test(name, 
-00022700: 2761 7a75 7265 272c 2033 3029 0a20 2020  'azure', 30).   
-00022710: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
-00022720: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
-00022730: 726b 2e73 6572 7665 0a40 7079 7465 7374  rk.serve.@pytest
-00022740: 2e6d 6172 6b2e 6e6f 5f6b 7562 6572 6e65  .mark.no_kuberne
-00022750: 7465 730a 6465 6620 7465 7374 5f73 6b79  tes.def test_sky
-00022760: 7365 7276 655f 6c6c 6d28 6765 6e65 7269  serve_llm(generi
-00022770: 635f 636c 6f75 643a 2073 7472 293a 0a20  c_cloud: str):. 
-00022780: 2020 2022 2222 5465 7374 2073 6b79 7365     """Test skyse
-00022790: 7276 6520 7769 7468 2072 6561 6c20 4c4c  rve with real LL
-000227a0: 4d20 7573 6563 6173 6522 2222 0a20 2020  M usecase""".   
-000227b0: 206e 616d 6520 3d20 5f67 6574 5f73 6572   name = _get_ser
-000227c0: 7669 6365 5f6e 616d 6528 290a 0a20 2020  vice_name()..   
-000227d0: 2064 6566 2067 656e 6572 6174 655f 6c6c   def generate_ll
-000227e0: 6d5f 7465 7374 5f63 6f6d 6d61 6e64 2870  m_test_command(p
-000227f0: 726f 6d70 743a 2073 7472 2c20 6578 7065  rompt: str, expe
-00022800: 6374 6564 5f6f 7574 7075 743a 2073 7472  cted_output: str
-00022810: 2920 2d3e 2073 7472 3a0a 2020 2020 2020  ) -> str:.      
-00022820: 2020 7072 6f6d 7074 203d 2073 686c 6578    prompt = shlex
-00022830: 2e71 756f 7465 2870 726f 6d70 7429 0a20  .quote(prompt). 
-00022840: 2020 2020 2020 2065 7870 6563 7465 645f         expected_
-00022850: 6f75 7470 7574 203d 2073 686c 6578 2e71  output = shlex.q
-00022860: 756f 7465 2865 7870 6563 7465 645f 6f75  uote(expected_ou
-00022870: 7470 7574 290a 2020 2020 2020 2020 7265  tput).        re
-00022880: 7475 726e 2028 0a20 2020 2020 2020 2020  turn (.         
-00022890: 2020 2066 277b 5f53 4552 5645 5f45 4e44     f'{_SERVE_END
-000228a0: 504f 494e 545f 5741 4954 2e66 6f72 6d61  POINT_WAIT.forma
-000228b0: 7428 6e61 6d65 3d6e 616d 6529 7d3b 2027  t(name=name)}; '
-000228c0: 0a20 2020 2020 2020 2020 2020 2027 7079  .            'py
-000228d0: 7468 6f6e 2074 6573 7473 2f73 6b79 7365  thon tests/skyse
-000228e0: 7276 652f 6c6c 6d2f 6765 745f 7265 7370  rve/llm/get_resp
-000228f0: 6f6e 7365 2e70 7920 2d2d 656e 6470 6f69  onse.py --endpoi
-00022900: 6e74 2024 656e 6470 6f69 6e74 2027 0a20  nt $endpoint '. 
-00022910: 2020 2020 2020 2020 2020 2066 272d 2d70             f'--p
-00022920: 726f 6d70 7420 7b70 726f 6d70 747d 207c  rompt {prompt} |
-00022930: 2067 7265 7020 7b65 7870 6563 7465 645f   grep {expected_
-00022940: 6f75 7470 7574 7d27 290a 0a20 2020 2077  output}')..    w
-00022950: 6974 6820 6f70 656e 2827 7465 7374 732f  ith open('tests/
-00022960: 736b 7973 6572 7665 2f6c 6c6d 2f70 726f  skyserve/llm/pro
-00022970: 6d70 745f 6f75 7470 7574 2e6a 736f 6e27  mpt_output.json'
-00022980: 2c20 2772 272c 0a20 2020 2020 2020 2020  , 'r',.         
-00022990: 2020 2020 2065 6e63 6f64 696e 673d 2775       encoding='u
-000229a0: 7466 2d38 2729 2061 7320 663a 0a20 2020  tf-8') as f:.   
-000229b0: 2020 2020 2070 726f 6d70 7432 6f75 7470       prompt2outp
-000229c0: 7574 203d 206a 736f 6e2e 6c6f 6164 2866  ut = json.load(f
-000229d0: 290a 0a20 2020 2074 6573 7420 3d20 5465  )..    test = Te
-000229e0: 7374 280a 2020 2020 2020 2020 6627 7465  st(.        f'te
-000229f0: 7374 2d73 6b79 7365 7276 652d 6c6c 6d27  st-skyserve-llm'
-00022a00: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
-00022a10: 2020 2020 2020 2020 6627 736b 7920 7365          f'sky se
-00022a20: 7276 6520 7570 202d 6e20 7b6e 616d 657d  rve up -n {name}
-00022a30: 202d 2d63 6c6f 7564 207b 6765 6e65 7269   --cloud {generi
-00022a40: 635f 636c 6f75 647d 202d 7920 7465 7374  c_cloud} -y test
-00022a50: 732f 736b 7973 6572 7665 2f6c 6c6d 2f73  s/skyserve/llm/s
-00022a60: 6572 7669 6365 2e79 616d 6c27 2c0a 2020  ervice.yaml',.  
-00022a70: 2020 2020 2020 2020 2020 5f53 4552 5645            _SERVE
-00022a80: 5f57 4149 545f 554e 5449 4c5f 5245 4144  _WAIT_UNTIL_READ
-00022a90: 592e 666f 726d 6174 286e 616d 653d 6e61  Y.format(name=na
-00022aa0: 6d65 2c20 7265 706c 6963 615f 6e75 6d3d  me, replica_num=
-00022ab0: 3129 2c0a 2020 2020 2020 2020 2020 2020  1),.            
-00022ac0: 2a5b 0a20 2020 2020 2020 2020 2020 2020  *[.             
-00022ad0: 2020 2067 656e 6572 6174 655f 6c6c 6d5f     generate_llm_
-00022ae0: 7465 7374 5f63 6f6d 6d61 6e64 2870 726f  test_command(pro
-00022af0: 6d70 742c 206f 7574 7075 7429 0a20 2020  mpt, output).   
-00022b00: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-00022b10: 2070 726f 6d70 742c 206f 7574 7075 7420   prompt, output 
-00022b20: 696e 2070 726f 6d70 7432 6f75 7470 7574  in prompt2output
-00022b30: 2e69 7465 6d73 2829 0a20 2020 2020 2020  .items().       
-00022b40: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-00022b50: 5d2c 0a20 2020 2020 2020 205f 5445 4152  ],.        _TEAR
-00022b60: 444f 574e 5f53 4552 5649 4345 2e66 6f72  DOWN_SERVICE.for
-00022b70: 6d61 7428 6e61 6d65 3d6e 616d 6529 2c0a  mat(name=name),.
-00022b80: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
-00022b90: 3235 202a 2036 302c 0a20 2020 2029 0a20  25 * 60,.    ). 
-00022ba0: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-00022bb0: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
-00022bc0: 6d61 726b 2e67 6370 0a40 7079 7465 7374  mark.gcp.@pytest
-00022bd0: 2e6d 6172 6b2e 7365 7276 650a 6465 6620  .mark.serve.def 
-00022be0: 7465 7374 5f73 6b79 7365 7276 655f 7370  test_skyserve_sp
-00022bf0: 6f74 5f72 6563 6f76 6572 7928 293a 0a20  ot_recovery():. 
-00022c00: 2020 206e 616d 6520 3d20 5f67 6574 5f73     name = _get_s
-00022c10: 6572 7669 6365 5f6e 616d 6528 290a 2020  ervice_name().  
-00022c20: 2020 7a6f 6e65 203d 2027 7573 2d63 656e    zone = 'us-cen
-00022c30: 7472 616c 312d 6127 0a0a 2020 2020 7465  tral1-a'..    te
-00022c40: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
-00022c50: 2020 2066 2774 6573 742d 736b 7973 6572     f'test-skyser
-00022c60: 7665 2d73 706f 742d 7265 636f 7665 7279  ve-spot-recovery
-00022c70: 2d67 6370 272c 0a20 2020 2020 2020 205b  -gcp',.        [
-00022c80: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00022c90: 6b79 2073 6572 7665 2075 7020 2d6e 207b  ky serve up -n {
-00022ca0: 6e61 6d65 7d20 2d79 2074 6573 7473 2f73  name} -y tests/s
-00022cb0: 6b79 7365 7276 652f 7370 6f74 2f72 6563  kyserve/spot/rec
-00022cc0: 6f76 6572 792e 7961 6d6c 272c 0a20 2020  overy.yaml',.   
-00022cd0: 2020 2020 2020 2020 205f 5345 5256 455f           _SERVE_
-00022ce0: 5741 4954 5f55 4e54 494c 5f52 4541 4459  WAIT_UNTIL_READY
-00022cf0: 2e66 6f72 6d61 7428 6e61 6d65 3d6e 616d  .format(name=nam
-00022d00: 652c 2072 6570 6c69 6361 5f6e 756d 3d31  e, replica_num=1
-00022d10: 292c 0a20 2020 2020 2020 2020 2020 2066  ),.            f
-00022d20: 277b 5f53 4552 5645 5f45 4e44 504f 494e  '{_SERVE_ENDPOIN
-00022d30: 545f 5741 4954 2e66 6f72 6d61 7428 6e61  T_WAIT.format(na
-00022d40: 6d65 3d6e 616d 6529 7d3b 2027 0a20 2020  me=name)}; '.   
-00022d50: 2020 2020 2020 2020 2027 6375 726c 202d           'curl -
-00022d60: 4c20 6874 7470 3a2f 2f24 656e 6470 6f69  L http://$endpoi
-00022d70: 6e74 207c 2067 7265 7020 2248 692c 2053  nt | grep "Hi, S
-00022d80: 6b79 5069 6c6f 7420 6865 7265 2227 2c0a  kyPilot here"',.
-00022d90: 2020 2020 2020 2020 2020 2020 5f74 6572              _ter
-00022da0: 6d69 6e61 7465 5f67 6370 5f72 6570 6c69  minate_gcp_repli
-00022db0: 6361 286e 616d 652c 207a 6f6e 652c 2031  ca(name, zone, 1
-00022dc0: 292c 0a20 2020 2020 2020 2020 2020 205f  ),.            _
-00022dd0: 5345 5256 455f 5741 4954 5f55 4e54 494c  SERVE_WAIT_UNTIL
-00022de0: 5f52 4541 4459 2e66 6f72 6d61 7428 6e61  _READY.format(na
-00022df0: 6d65 3d6e 616d 652c 2072 6570 6c69 6361  me=name, replica
-00022e00: 5f6e 756d 3d31 292c 0a20 2020 2020 2020  _num=1),.       
-00022e10: 2020 2020 2066 277b 5f53 4552 5645 5f45       f'{_SERVE_E
-00022e20: 4e44 504f 494e 545f 5741 4954 2e66 6f72  NDPOINT_WAIT.for
-00022e30: 6d61 7428 6e61 6d65 3d6e 616d 6529 7d3b  mat(name=name)};
-00022e40: 2027 0a20 2020 2020 2020 2020 2020 2027   '.            '
-00022e50: 6375 726c 202d 4c20 6874 7470 3a2f 2f24  curl -L http://$
-00022e60: 656e 6470 6f69 6e74 207c 2067 7265 7020  endpoint | grep 
-00022e70: 2248 692c 2053 6b79 5069 6c6f 7420 6865  "Hi, SkyPilot he
-00022e80: 7265 2227 2c0a 2020 2020 2020 2020 5d2c  re"',.        ],
-00022e90: 0a20 2020 2020 2020 205f 5445 4152 444f  .        _TEARDO
-00022ea0: 574e 5f53 4552 5649 4345 2e66 6f72 6d61  WN_SERVICE.forma
-00022eb0: 7428 6e61 6d65 3d6e 616d 6529 2c0a 2020  t(name=name),.  
-00022ec0: 2020 2020 2020 7469 6d65 6f75 743d 3230        timeout=20
-00022ed0: 202a 2036 302c 0a20 2020 2029 0a20 2020   * 60,.    ).   
-00022ee0: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
-00022ef0: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
-00022f00: 726b 2e73 6572 7665 0a40 7079 7465 7374  rk.serve.@pytest
-00022f10: 2e6d 6172 6b2e 6e6f 5f6b 7562 6572 6e65  .mark.no_kuberne
-00022f20: 7465 730a 6465 6620 7465 7374 5f73 6b79  tes.def test_sky
-00022f30: 7365 7276 655f 6261 7365 5f6f 6e64 656d  serve_base_ondem
-00022f40: 616e 645f 6661 6c6c 6261 636b 2867 656e  and_fallback(gen
-00022f50: 6572 6963 5f63 6c6f 7564 3a20 7374 7229  eric_cloud: str)
-00022f60: 3a0a 2020 2020 6e61 6d65 203d 205f 6765  :.    name = _ge
-00022f70: 745f 7365 7276 6963 655f 6e61 6d65 2829  t_service_name()
-00022f80: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
-00022f90: 280a 2020 2020 2020 2020 6627 7465 7374  (.        f'test
-00022fa0: 2d73 6b79 7365 7276 652d 6261 7365 2d6f  -skyserve-base-o
-00022fb0: 6e64 656d 616e 642d 6661 6c6c 6261 636b  ndemand-fallback
-00022fc0: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
-00022fd0: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
-00022fe0: 6572 7665 2075 7020 2d6e 207b 6e61 6d65  erve up -n {name
-00022ff0: 7d20 2d2d 636c 6f75 6420 7b67 656e 6572  } --cloud {gener
-00023000: 6963 5f63 6c6f 7564 7d20 2d79 2074 6573  ic_cloud} -y tes
-00023010: 7473 2f73 6b79 7365 7276 652f 7370 6f74  ts/skyserve/spot
-00023020: 2f62 6173 655f 6f6e 6465 6d61 6e64 5f66  /base_ondemand_f
-00023030: 616c 6c62 6163 6b2e 7961 6d6c 272c 0a20  allback.yaml',. 
-00023040: 2020 2020 2020 2020 2020 205f 5345 5256             _SERV
-00023050: 455f 5741 4954 5f55 4e54 494c 5f52 4541  E_WAIT_UNTIL_REA
-00023060: 4459 2e66 6f72 6d61 7428 6e61 6d65 3d6e  DY.format(name=n
-00023070: 616d 652c 2072 6570 6c69 6361 5f6e 756d  ame, replica_num
-00023080: 3d32 292c 0a20 2020 2020 2020 2020 2020  =2),.           
-00023090: 205f 6368 6563 6b5f 7265 706c 6963 615f   _check_replica_
-000230a0: 696e 5f73 7461 7475 7328 6e61 6d65 2c20  in_status(name, 
-000230b0: 5b28 312c 2054 7275 652c 2027 5245 4144  [(1, True, 'READ
-000230c0: 5927 292c 0a20 2020 2020 2020 2020 2020  Y'),.           
-000230d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000230e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000230f0: 2028 312c 2046 616c 7365 2c20 2752 4541   (1, False, 'REA
-00023100: 4459 2729 5d29 2c0a 2020 2020 2020 2020  DY')]),.        
-00023110: 5d2c 0a20 2020 2020 2020 205f 5445 4152  ],.        _TEAR
-00023120: 444f 574e 5f53 4552 5649 4345 2e66 6f72  DOWN_SERVICE.for
-00023130: 6d61 7428 6e61 6d65 3d6e 616d 6529 2c0a  mat(name=name),.
-00023140: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
-00023150: 3230 202a 2036 302c 0a20 2020 2029 0a20  20 * 60,.    ). 
-00023160: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-00023170: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
-00023180: 6d61 726b 2e67 6370 0a40 7079 7465 7374  mark.gcp.@pytest
-00023190: 2e6d 6172 6b2e 7365 7276 650a 6465 6620  .mark.serve.def 
-000231a0: 7465 7374 5f73 6b79 7365 7276 655f 6479  test_skyserve_dy
-000231b0: 6e61 6d69 635f 6f6e 6465 6d61 6e64 5f66  namic_ondemand_f
-000231c0: 616c 6c62 6163 6b28 293a 0a20 2020 206e  allback():.    n
-000231d0: 616d 6520 3d20 5f67 6574 5f73 6572 7669  ame = _get_servi
-000231e0: 6365 5f6e 616d 6528 290a 2020 2020 7a6f  ce_name().    zo
-000231f0: 6e65 203d 2027 7573 2d63 656e 7472 616c  ne = 'us-central
-00023200: 312d 6127 0a0a 2020 2020 7465 7374 203d  1-a'..    test =
-00023210: 2054 6573 7428 0a20 2020 2020 2020 2066   Test(.        f
-00023220: 2774 6573 742d 736b 7973 6572 7665 2d64  'test-skyserve-d
-00023230: 796e 616d 6963 2d6f 6e64 656d 616e 642d  ynamic-ondemand-
-00023240: 6661 6c6c 6261 636b 272c 0a20 2020 2020  fallback',.     
-00023250: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
-00023260: 2066 2773 6b79 2073 6572 7665 2075 7020   f'sky serve up 
-00023270: 2d6e 207b 6e61 6d65 7d20 2d2d 636c 6f75  -n {name} --clou
-00023280: 6420 6763 7020 2d79 2074 6573 7473 2f73  d gcp -y tests/s
-00023290: 6b79 7365 7276 652f 7370 6f74 2f64 796e  kyserve/spot/dyn
-000232a0: 616d 6963 5f6f 6e64 656d 616e 645f 6661  amic_ondemand_fa
-000232b0: 6c6c 6261 636b 2e79 616d 6c27 2c0a 2020  llback.yaml',.  
-000232c0: 2020 2020 2020 2020 2020 6627 736c 6565            f'slee
-000232d0: 7020 3430 272c 0a20 2020 2020 2020 2020  p 40',.         
-000232e0: 2020 2023 2032 206f 6e2d 6465 6d61 6e64     # 2 on-demand
-000232f0: 2028 7072 6f76 6973 696f 6e69 6e67 2920   (provisioning) 
-00023300: 2b20 3220 5370 6f74 2028 7072 6f76 6973  + 2 Spot (provis
-00023310: 696f 6e69 6e67 292e 0a20 2020 2020 2020  ioning)..       
-00023320: 2020 2020 2066 277b 5f53 4552 5645 5f53       f'{_SERVE_S
-00023330: 5441 5455 535f 5741 4954 2e66 6f72 6d61  TATUS_WAIT.forma
-00023340: 7428 6e61 6d65 3d6e 616d 6529 7d3b 2065  t(name=name)}; e
-00023350: 6368 6f20 2224 7322 3b27 0a20 2020 2020  cho "$s";'.     
-00023360: 2020 2020 2020 2027 6563 686f 2022 2473         'echo "$s
-00023370: 2220 7c20 6772 6570 202d 7120 2230 2f34  " | grep -q "0/4
-00023380: 2220 7c7c 2065 7869 7420 3127 2c0a 2020  " || exit 1',.  
-00023390: 2020 2020 2020 2020 2020 2320 5761 6974            # Wait
-000233a0: 2066 6f72 2074 6865 2070 726f 7669 7369   for the provisi
-000233b0: 6f6e 696e 6720 7374 6172 7473 0a20 2020  oning starts.   
-000233c0: 2020 2020 2020 2020 2066 2773 6c65 6570           f'sleep
-000233d0: 2034 3027 2c0a 2020 2020 2020 2020 2020   40',.          
-000233e0: 2020 5f63 6865 636b 5f72 6570 6c69 6361    _check_replica
-000233f0: 5f69 6e5f 7374 6174 7573 286e 616d 652c  _in_status(name,
-00023400: 205b 0a20 2020 2020 2020 2020 2020 2020   [.             
-00023410: 2020 2028 322c 2054 7275 652c 205f 5345     (2, True, _SE
-00023420: 5256 4943 455f 4c41 554e 4348 494e 475f  RVICE_LAUNCHING_
-00023430: 5354 4154 5553 5f52 4547 4558 202b 2027  STATUS_REGEX + '
-00023440: 5c7c 5245 4144 5927 292c 0a20 2020 2020  \|READY'),.     
-00023450: 2020 2020 2020 2020 2020 2028 322c 2046             (2, F
-00023460: 616c 7365 2c20 5f53 4552 5649 4345 5f4c  alse, _SERVICE_L
-00023470: 4155 4e43 4849 4e47 5f53 5441 5455 535f  AUNCHING_STATUS_
-00023480: 5245 4745 5820 2b20 275c 7c53 4855 5454  REGEX + '\|SHUTT
-00023490: 494e 475f 444f 574e 2729 0a20 2020 2020  ING_DOWN').     
-000234a0: 2020 2020 2020 205d 292c 0a0a 2020 2020         ]),..    
-000234b0: 2020 2020 2020 2020 2320 5761 6974 2075          # Wait u
-000234c0: 6e74 696c 2032 2073 706f 7420 696e 7374  ntil 2 spot inst
-000234d0: 616e 6365 7320 6172 6520 7265 6164 792e  ances are ready.
-000234e0: 0a20 2020 2020 2020 2020 2020 205f 5345  .            _SE
-000234f0: 5256 455f 5741 4954 5f55 4e54 494c 5f52  RVE_WAIT_UNTIL_R
-00023500: 4541 4459 2e66 6f72 6d61 7428 6e61 6d65  EADY.format(name
-00023510: 3d6e 616d 652c 2072 6570 6c69 6361 5f6e  =name, replica_n
-00023520: 756d 3d32 292c 0a20 2020 2020 2020 2020  um=2),.         
-00023530: 2020 205f 6368 6563 6b5f 7265 706c 6963     _check_replic
-00023540: 615f 696e 5f73 7461 7475 7328 6e61 6d65  a_in_status(name
-00023550: 2c20 5b28 322c 2054 7275 652c 2027 5245  , [(2, True, 'RE
-00023560: 4144 5927 292c 0a20 2020 2020 2020 2020  ADY'),.         
-00023570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023590: 2020 2028 302c 2046 616c 7365 2c20 2727     (0, False, ''
-000235a0: 295d 292c 0a20 2020 2020 2020 2020 2020  )]),.           
-000235b0: 205f 7465 726d 696e 6174 655f 6763 705f   _terminate_gcp_
-000235c0: 7265 706c 6963 6128 6e61 6d65 2c20 7a6f  replica(name, zo
-000235d0: 6e65 2c20 3129 2c0a 2020 2020 2020 2020  ne, 1),.        
-000235e0: 2020 2020 6627 736c 6565 7020 3430 272c      f'sleep 40',
-000235f0: 0a20 2020 2020 2020 2020 2020 2023 2031  .            # 1
-00023600: 206f 6e2d 6465 6d61 6e64 2028 7072 6f76   on-demand (prov
-00023610: 6973 696f 6e69 6e67 2920 2b20 3120 5370  isioning) + 1 Sp
-00023620: 6f74 2028 7265 6164 7929 202b 2031 2073  ot (ready) + 1 s
-00023630: 706f 7420 2870 726f 7669 7369 6f6e 696e  pot (provisionin
-00023640: 6729 2e0a 2020 2020 2020 2020 2020 2020  g)..            
-00023650: 6627 7b5f 5345 5256 455f 5354 4154 5553  f'{_SERVE_STATUS
-00023660: 5f57 4149 542e 666f 726d 6174 286e 616d  _WAIT.format(nam
-00023670: 653d 6e61 6d65 297d 3b20 270a 2020 2020  e=name)}; '.    
-00023680: 2020 2020 2020 2020 2765 6368 6f20 2224          'echo "$
-00023690: 7322 207c 2067 7265 7020 2d71 2022 312f  s" | grep -q "1/
-000236a0: 3322 272c 0a20 2020 2020 2020 2020 2020  3"',.           
-000236b0: 205f 6368 6563 6b5f 7265 706c 6963 615f   _check_replica_
-000236c0: 696e 5f73 7461 7475 7328 0a20 2020 2020  in_status(.     
-000236d0: 2020 2020 2020 2020 2020 206e 616d 652c             name,
-000236e0: 205b 2831 2c20 5472 7565 2c20 2752 4541   [(1, True, 'REA
-000236f0: 4459 2729 2c0a 2020 2020 2020 2020 2020  DY'),.          
-00023700: 2020 2020 2020 2020 2020 2020 2028 312c               (1,
-00023710: 2054 7275 652c 205f 5345 5256 4943 455f   True, _SERVICE_
-00023720: 4c41 554e 4348 494e 475f 5354 4154 5553  LAUNCHING_STATUS
-00023730: 5f52 4547 4558 292c 0a20 2020 2020 2020  _REGEX),.       
-00023740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023750: 2831 2c20 4661 6c73 652c 205f 5345 5256  (1, False, _SERV
-00023760: 4943 455f 4c41 554e 4348 494e 475f 5354  ICE_LAUNCHING_ST
-00023770: 4154 5553 5f52 4547 4558 295d 292c 0a0a  ATUS_REGEX)]),..
-00023780: 2020 2020 2020 2020 2020 2020 2320 5761              # Wa
-00023790: 6974 2075 6e74 696c 2032 2073 706f 7420  it until 2 spot 
-000237a0: 696e 7374 616e 6365 7320 6172 6520 7265  instances are re
-000237b0: 6164 792e 0a20 2020 2020 2020 2020 2020  ady..           
-000237c0: 205f 5345 5256 455f 5741 4954 5f55 4e54   _SERVE_WAIT_UNT
-000237d0: 494c 5f52 4541 4459 2e66 6f72 6d61 7428  IL_READY.format(
-000237e0: 6e61 6d65 3d6e 616d 652c 2072 6570 6c69  name=name, repli
-000237f0: 6361 5f6e 756d 3d32 292c 0a20 2020 2020  ca_num=2),.     
-00023800: 2020 2020 2020 205f 6368 6563 6b5f 7265         _check_re
-00023810: 706c 6963 615f 696e 5f73 7461 7475 7328  plica_in_status(
-00023820: 6e61 6d65 2c20 5b28 322c 2054 7275 652c  name, [(2, True,
-00023830: 2027 5245 4144 5927 292c 0a20 2020 2020   'READY'),.     
-00023840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023860: 2020 2020 2020 2028 302c 2046 616c 7365         (0, False
-00023870: 2c20 2727 295d 292c 0a20 2020 2020 2020  , '')]),.       
-00023880: 205d 2c0a 2020 2020 2020 2020 5f54 4541   ],.        _TEA
-00023890: 5244 4f57 4e5f 5345 5256 4943 452e 666f  RDOWN_SERVICE.fo
-000238a0: 726d 6174 286e 616d 653d 6e61 6d65 292c  rmat(name=name),
-000238b0: 0a20 2020 2020 2020 2074 696d 656f 7574  .        timeout
-000238c0: 3d32 3020 2a20 3630 2c0a 2020 2020 290a  =20 * 60,.    ).
-000238d0: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
-000238e0: 2874 6573 7429 0a0a 0a40 7079 7465 7374  (test)...@pytest
-000238f0: 2e6d 6172 6b2e 7365 7276 650a 4070 7974  .mark.serve.@pyt
-00023900: 6573 742e 6d61 726b 2e6e 6f5f 6b75 6265  est.mark.no_kube
-00023910: 726e 6574 6573 0a64 6566 2074 6573 745f  rnetes.def test_
-00023920: 736b 7973 6572 7665 5f75 7365 725f 6275  skyserve_user_bu
-00023930: 675f 7265 7374 6172 7428 6765 6e65 7269  g_restart(generi
-00023940: 635f 636c 6f75 643a 2073 7472 293a 0a20  c_cloud: str):. 
-00023950: 2020 2022 2222 5465 7374 7320 7468 6174     """Tests that
-00023960: 2077 6520 7265 7374 6172 7420 7468 6520   we restart the 
-00023970: 7365 7276 6963 6520 6166 7465 7220 7573  service after us
-00023980: 6572 2062 7567 2e22 2222 0a20 2020 2023  er bug.""".    #
-00023990: 2054 4f44 4f28 7a68 7775 293a 2074 6869   TODO(zhwu): thi
-000239a0: 7320 6265 6861 7669 6f72 206e 6565 6473  s behavior needs
-000239b0: 2073 6f6d 6520 7265 7468 696e 6b69 6e67   some rethinking
-000239c0: 2e0a 2020 2020 6e61 6d65 203d 205f 6765  ..    name = _ge
-000239d0: 745f 7365 7276 6963 655f 6e61 6d65 2829  t_service_name()
-000239e0: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
-000239f0: 280a 2020 2020 2020 2020 6627 7465 7374  (.        f'test
-00023a00: 2d73 6b79 7365 7276 652d 7573 6572 2d62  -skyserve-user-b
-00023a10: 7567 2d72 6573 7461 7274 272c 0a20 2020  ug-restart',.   
-00023a20: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
-00023a30: 2020 2066 2773 6b79 2073 6572 7665 2075     f'sky serve u
-00023a40: 7020 2d6e 207b 6e61 6d65 7d20 2d2d 636c  p -n {name} --cl
-00023a50: 6f75 6420 7b67 656e 6572 6963 5f63 6c6f  oud {generic_clo
-00023a60: 7564 7d20 2d79 2074 6573 7473 2f73 6b79  ud} -y tests/sky
-00023a70: 7365 7276 652f 7265 7374 6172 742f 7573  serve/restart/us
-00023a80: 6572 5f62 7567 2e79 616d 6c27 2c0a 2020  er_bug.yaml',.  
-00023a90: 2020 2020 2020 2020 2020 6627 733d 2428            f's=$(
-00023aa0: 736b 7920 7365 7276 6520 7374 6174 7573  sky serve status
-00023ab0: 207b 6e61 6d65 7d29 3b20 6563 686f 2022   {name}); echo "
-00023ac0: 2473 223b 270a 2020 2020 2020 2020 2020  $s";'.          
-00023ad0: 2020 2775 6e74 696c 2065 6368 6f20 2224    'until echo "$
-00023ae0: 7322 207c 2067 7265 7020 2d41 2031 3030  s" | grep -A 100
-00023af0: 2022 5365 7276 6963 6520 5265 706c 6963   "Service Replic
-00023b00: 6173 2220 7c20 6772 6570 2022 5348 5554  as" | grep "SHUT
-00023b10: 5449 4e47 5f44 4f57 4e22 3b20 270a 2020  TING_DOWN"; '.  
-00023b20: 2020 2020 2020 2020 2020 2764 6f20 6563            'do ec
-00023b30: 686f 2022 5761 6974 696e 6720 666f 7220  ho "Waiting for 
-00023b40: 6669 7273 7420 7365 7276 6963 6520 746f  first service to
-00023b50: 2062 6520 5348 5554 5449 4e47 2044 4f57   be SHUTTING DOW
-00023b60: 4e2e 2e2e 223b 2027 0a20 2020 2020 2020  N..."; '.       
-00023b70: 2020 2020 2066 2773 6c65 6570 2035 3b20       f'sleep 5; 
-00023b80: 733d 2428 736b 7920 7365 7276 6520 7374  s=$(sky serve st
-00023b90: 6174 7573 207b 6e61 6d65 7d29 3b20 6563  atus {name}); ec
-00023ba0: 686f 2022 2473 223b 2064 6f6e 653b 2027  ho "$s"; done; '
-00023bb0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00023bc0: 733d 2428 736b 7920 7365 7276 6520 7374  s=$(sky serve st
-00023bd0: 6174 7573 207b 6e61 6d65 7d29 3b20 6563  atus {name}); ec
-00023be0: 686f 2022 2473 223b 270a 2020 2020 2020  ho "$s";'.      
-00023bf0: 2020 2020 2020 2775 6e74 696c 2065 6368        'until ech
-00023c00: 6f20 2224 7322 207c 2067 7265 7020 2d41  o "$s" | grep -A
-00023c10: 2031 3030 2022 5365 7276 6963 6520 5265   100 "Service Re
-00023c20: 706c 6963 6173 2220 7c20 6772 6570 2022  plicas" | grep "
-00023c30: 4641 494c 4544 223b 2027 0a20 2020 2020  FAILED"; '.     
-00023c40: 2020 2020 2020 2027 646f 2065 6368 6f20         'do echo 
-00023c50: 2257 6169 7469 6e67 2066 6f72 2066 6972  "Waiting for fir
-00023c60: 7374 2073 6572 7669 6365 2074 6f20 6265  st service to be
-00023c70: 2046 4149 4c45 442e 2e2e 223b 2027 0a20   FAILED..."; '. 
-00023c80: 2020 2020 2020 2020 2020 2066 2773 6c65             f'sle
-00023c90: 6570 2035 3b20 733d 2428 736b 7920 7365  ep 5; s=$(sky se
-00023ca0: 7276 6520 7374 6174 7573 207b 6e61 6d65  rve status {name
-00023cb0: 7d29 3b20 6563 686f 2022 2473 223b 2064  }); echo "$s"; d
-00023cc0: 6f6e 653b 2065 6368 6f20 2224 7322 3b20  one; echo "$s"; 
-00023cd0: 270a 2020 2020 2020 2020 2020 2020 2b20  '.            + 
-00023ce0: 5f63 6865 636b 5f72 6570 6c69 6361 5f69  _check_replica_i
-00023cf0: 6e5f 7374 6174 7573 286e 616d 652c 205b  n_status(name, [
-00023d00: 2831 2c20 5472 7565 2c20 2746 4149 4c45  (1, True, 'FAILE
-00023d10: 4427 295d 2920 2b0a 2020 2020 2020 2020  D')]) +.        
-00023d20: 2020 2020 2320 5573 6572 2062 7567 2066      # User bug f
-00023d30: 6169 6c75 7265 2077 696c 6c20 6361 7573  ailure will caus
-00023d40: 6520 6e6f 2066 7572 7468 6572 2073 6361  e no further sca
-00023d50: 6c69 6e67 2e0a 2020 2020 2020 2020 2020  ling..          
-00023d60: 2020 6627 6563 686f 2022 2473 2220 7c20    f'echo "$s" | 
-00023d70: 6772 6570 202d 4120 3130 3020 2253 6572  grep -A 100 "Ser
-00023d80: 7669 6365 2052 6570 6c69 6361 7322 207c  vice Replicas" |
-00023d90: 2067 7265 7020 227b 6e61 6d65 7d22 207c   grep "{name}" |
-00023da0: 2077 6320 2d6c 207c 2067 7265 7020 313b   wc -l | grep 1;
-00023db0: 2027 0a20 2020 2020 2020 2020 2020 2066   '.            f
-00023dc0: 2765 6368 6f20 2224 7322 207c 2067 7265  'echo "$s" | gre
-00023dd0: 7020 2d42 2031 3030 2022 4e4f 5f52 4550  p -B 100 "NO_REP
-00023de0: 4c49 4341 2220 7c20 6772 6570 2022 302f  LICA" | grep "0/
-00023df0: 3022 272c 0a20 2020 2020 2020 2020 2020  0"',.           
-00023e00: 2066 2773 6b79 2073 6572 7665 2075 7064   f'sky serve upd
-00023e10: 6174 6520 7b6e 616d 657d 202d 2d63 6c6f  ate {name} --clo
-00023e20: 7564 207b 6765 6e65 7269 635f 636c 6f75  ud {generic_clou
-00023e30: 647d 202d 7920 7465 7374 732f 736b 7973  d} -y tests/skys
-00023e40: 6572 7665 2f61 7574 6f5f 7265 7374 6172  erve/auto_restar
-00023e50: 742e 7961 6d6c 272c 0a20 2020 2020 2020  t.yaml',.       
-00023e60: 2020 2020 2066 277b 5f53 4552 5645 5f45       f'{_SERVE_E
-00023e70: 4e44 504f 494e 545f 5741 4954 2e66 6f72  NDPOINT_WAIT.for
-00023e80: 6d61 7428 6e61 6d65 3d6e 616d 6529 7d3b  mat(name=name)};
-00023e90: 2027 0a20 2020 2020 2020 2020 2020 2027   '.            '
-00023ea0: 756e 7469 6c20 6375 726c 202d 4c20 6874  until curl -L ht
-00023eb0: 7470 3a2f 2f24 656e 6470 6f69 6e74 207c  tp://$endpoint |
-00023ec0: 2067 7265 7020 2248 692c 2053 6b79 5069   grep "Hi, SkyPi
-00023ed0: 6c6f 7420 6865 7265 2122 3b20 646f 2073  lot here!"; do s
-00023ee0: 6c65 6570 2032 3b20 646f 6e65 3b20 736c  leep 2; done; sl
-00023ef0: 6565 7020 323b 2027 0a20 2020 2020 2020  eep 2; '.       
-00023f00: 2020 2020 202b 205f 6368 6563 6b5f 7265       + _check_re
-00023f10: 706c 6963 615f 696e 5f73 7461 7475 7328  plica_in_status(
-00023f20: 6e61 6d65 2c20 5b28 312c 2046 616c 7365  name, [(1, False
-00023f30: 2c20 2752 4541 4459 2729 2c0a 2020 2020  , 'READY'),.    
-00023f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023f60: 2020 2020 2020 2020 2020 2831 2c20 4661            (1, Fa
-00023f70: 6c73 652c 2027 4641 494c 4544 2729 5d29  lse, 'FAILED')])
-00023f80: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
-00023f90: 2020 2020 205f 5445 4152 444f 574e 5f53       _TEARDOWN_S
-00023fa0: 4552 5649 4345 2e66 6f72 6d61 7428 6e61  ERVICE.format(na
-00023fb0: 6d65 3d6e 616d 6529 2c0a 2020 2020 2020  me=name),.      
-00023fc0: 2020 7469 6d65 6f75 743d 3230 202a 2036    timeout=20 * 6
-00023fd0: 302c 0a20 2020 2029 0a20 2020 2072 756e  0,.    ).    run
-00023fe0: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
-00023ff0: 0a0a 4070 7974 6573 742e 6d61 726b 2e73  ..@pytest.mark.s
-00024000: 6572 7665 0a40 7079 7465 7374 2e6d 6172  erve.@pytest.mar
-00024010: 6b2e 6e6f 5f6b 7562 6572 6e65 7465 730a  k.no_kubernetes.
-00024020: 6465 6620 7465 7374 5f73 6b79 7365 7276  def test_skyserv
-00024030: 655f 6c6f 6164 5f62 616c 616e 6365 7228  e_load_balancer(
-00024040: 6765 6e65 7269 635f 636c 6f75 643a 2073  generic_cloud: s
-00024050: 7472 293a 0a20 2020 2022 2222 5465 7374  tr):.    """Test
-00024060: 2073 6b79 7365 7276 6520 6c6f 6164 2062   skyserve load b
-00024070: 616c 616e 6365 7220 726f 756e 642d 726f  alancer round-ro
-00024080: 6269 6e20 706f 6c69 6379 2222 220a 2020  bin policy""".  
-00024090: 2020 6e61 6d65 203d 205f 6765 745f 7365    name = _get_se
-000240a0: 7276 6963 655f 6e61 6d65 2829 0a20 2020  rvice_name().   
-000240b0: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
-000240c0: 2020 2020 2020 6627 7465 7374 2d73 6b79        f'test-sky
-000240d0: 7365 7276 652d 6c6f 6164 2d62 616c 616e  serve-load-balan
-000240e0: 6365 7227 2c0a 2020 2020 2020 2020 5b0a  cer',.        [.
-000240f0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00024100: 7920 7365 7276 6520 7570 202d 6e20 7b6e  y serve up -n {n
-00024110: 616d 657d 202d 2d63 6c6f 7564 207b 6765  ame} --cloud {ge
-00024120: 6e65 7269 635f 636c 6f75 647d 202d 7920  neric_cloud} -y 
-00024130: 7465 7374 732f 736b 7973 6572 7665 2f6c  tests/skyserve/l
-00024140: 6f61 645f 6261 6c61 6e63 6572 2f73 6572  oad_balancer/ser
-00024150: 7669 6365 2e79 616d 6c27 2c0a 2020 2020  vice.yaml',.    
-00024160: 2020 2020 2020 2020 5f53 4552 5645 5f57          _SERVE_W
-00024170: 4149 545f 554e 5449 4c5f 5245 4144 592e  AIT_UNTIL_READY.
-00024180: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
-00024190: 2c20 7265 706c 6963 615f 6e75 6d3d 3329  , replica_num=3)
-000241a0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-000241b0: 7b5f 5345 5256 455f 454e 4450 4f49 4e54  {_SERVE_ENDPOINT
-000241c0: 5f57 4149 542e 666f 726d 6174 286e 616d  _WAIT.format(nam
-000241d0: 653d 6e61 6d65 297d 3b20 270a 2020 2020  e=name)}; '.    
-000241e0: 2020 2020 2020 2020 6627 7b5f 5345 5256          f'{_SERV
-000241f0: 455f 5354 4154 5553 5f57 4149 542e 666f  E_STATUS_WAIT.fo
-00024200: 726d 6174 286e 616d 653d 6e61 6d65 297d  rmat(name=name)}
-00024210: 3b20 270a 2020 2020 2020 2020 2020 2020  ; '.            
-00024220: 6627 7b5f 6765 745f 7265 706c 6963 615f  f'{_get_replica_
-00024230: 6970 286e 616d 652c 2031 297d 3b20 270a  ip(name, 1)}; '.
-00024240: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
-00024250: 6765 745f 7265 706c 6963 615f 6970 286e  get_replica_ip(n
-00024260: 616d 652c 2032 297d 3b20 7b5f 6765 745f  ame, 2)}; {_get_
-00024270: 7265 706c 6963 615f 6970 286e 616d 652c  replica_ip(name,
-00024280: 2033 297d 3b20 270a 2020 2020 2020 2020   3)}; '.        
-00024290: 2020 2020 2770 7974 686f 6e20 7465 7374      'python test
-000242a0: 732f 736b 7973 6572 7665 2f6c 6f61 645f  s/skyserve/load_
-000242b0: 6261 6c61 6e63 6572 2f74 6573 745f 726f  balancer/test_ro
-000242c0: 756e 645f 726f 6269 6e2e 7079 2027 0a20  und_robin.py '. 
-000242d0: 2020 2020 2020 2020 2020 2027 2d2d 656e             '--en
-000242e0: 6470 6f69 6e74 2024 656e 6470 6f69 6e74  dpoint $endpoint
-000242f0: 202d 2d72 6570 6c69 6361 2d6e 756d 2033   --replica-num 3
-00024300: 202d 2d72 6570 6c69 6361 2d69 7073 2024   --replica-ips $
-00024310: 6970 3120 2469 7032 2024 6970 3327 2c0a  ip1 $ip2 $ip3',.
-00024320: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
-00024330: 2020 205f 5445 4152 444f 574e 5f53 4552     _TEARDOWN_SER
-00024340: 5649 4345 2e66 6f72 6d61 7428 6e61 6d65  VICE.format(name
-00024350: 3d6e 616d 6529 2c0a 2020 2020 2020 2020  =name),.        
-00024360: 7469 6d65 6f75 743d 3230 202a 2036 302c  timeout=20 * 60,
-00024370: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
-00024380: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
-00024390: 4070 7974 6573 742e 6d61 726b 2e67 6370  @pytest.mark.gcp
-000243a0: 0a40 7079 7465 7374 2e6d 6172 6b2e 7365  .@pytest.mark.se
-000243b0: 7276 650a 4070 7974 6573 742e 6d61 726b  rve.@pytest.mark
-000243c0: 2e6e 6f5f 6b75 6265 726e 6574 6573 0a64  .no_kubernetes.d
-000243d0: 6566 2074 6573 745f 736b 7973 6572 7665  ef test_skyserve
-000243e0: 5f61 7574 6f5f 7265 7374 6172 7428 293a  _auto_restart():
-000243f0: 0a20 2020 2022 2222 5465 7374 2073 6b79  .    """Test sky
-00024400: 7365 7276 6520 7769 7468 2061 7574 6f20  serve with auto 
-00024410: 7265 7374 6172 7422 2222 0a20 2020 206e  restart""".    n
-00024420: 616d 6520 3d20 5f67 6574 5f73 6572 7669  ame = _get_servi
-00024430: 6365 5f6e 616d 6528 290a 2020 2020 7a6f  ce_name().    zo
-00024440: 6e65 203d 2027 7573 2d63 656e 7472 616c  ne = 'us-central
-00024450: 312d 6127 0a20 2020 2074 6573 7420 3d20  1-a'.    test = 
-00024460: 5465 7374 280a 2020 2020 2020 2020 6627  Test(.        f'
-00024470: 7465 7374 2d73 6b79 7365 7276 652d 6175  test-skyserve-au
-00024480: 746f 2d72 6573 7461 7274 272c 0a20 2020  to-restart',.   
-00024490: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
-000244a0: 2020 2023 2054 4f44 4f28 7469 616e 293a     # TODO(tian):
-000244b0: 2077 6520 6361 6e20 6479 6e61 6d69 6361   we can dynamica
-000244c0: 6c6c 7920 6765 6e65 7261 7465 2059 414d  lly generate YAM
-000244d0: 4c20 6672 6f6d 2074 656d 706c 6174 6520  L from template 
-000244e0: 746f 0a20 2020 2020 2020 2020 2020 2023  to.            #
-000244f0: 2061 766f 6964 206d 6169 6e74 6169 6e69   avoid maintaini
-00024500: 6e67 2074 6f6f 206d 616e 7920 5941 4d4c  ng too many YAML
-00024510: 2066 696c 6573 0a20 2020 2020 2020 2020   files.         
-00024520: 2020 2066 2773 6b79 2073 6572 7665 2075     f'sky serve u
-00024530: 7020 2d6e 207b 6e61 6d65 7d20 2d79 2074  p -n {name} -y t
-00024540: 6573 7473 2f73 6b79 7365 7276 652f 6175  ests/skyserve/au
-00024550: 746f 5f72 6573 7461 7274 2e79 616d 6c27  to_restart.yaml'
-00024560: 2c0a 2020 2020 2020 2020 2020 2020 5f53  ,.            _S
-00024570: 4552 5645 5f57 4149 545f 554e 5449 4c5f  ERVE_WAIT_UNTIL_
-00024580: 5245 4144 592e 666f 726d 6174 286e 616d  READY.format(nam
-00024590: 653d 6e61 6d65 2c20 7265 706c 6963 615f  e=name, replica_
-000245a0: 6e75 6d3d 3129 2c0a 2020 2020 2020 2020  num=1),.        
-000245b0: 2020 2020 6627 7b5f 5345 5256 455f 454e      f'{_SERVE_EN
-000245c0: 4450 4f49 4e54 5f57 4149 542e 666f 726d  DPOINT_WAIT.form
-000245d0: 6174 286e 616d 653d 6e61 6d65 297d 3b20  at(name=name)}; 
-000245e0: 270a 2020 2020 2020 2020 2020 2020 2763  '.            'c
-000245f0: 7572 6c20 2d4c 2068 7474 703a 2f2f 2465  url -L http://$e
-00024600: 6e64 706f 696e 7420 7c20 6772 6570 2022  ndpoint | grep "
-00024610: 4869 2c20 536b 7950 696c 6f74 2068 6572  Hi, SkyPilot her
-00024620: 6522 272c 0a20 2020 2020 2020 2020 2020  e"',.           
-00024630: 2023 2073 6c65 6570 2066 6f72 2032 3020   # sleep for 20 
-00024640: 7365 636f 6e64 7320 2869 6e69 7469 616c  seconds (initial
-00024650: 2064 656c 6179 2920 746f 206d 616b 6520   delay) to make 
-00024660: 7375 7265 2069 7420 7769 6c6c 0a20 2020  sure it will.   
-00024670: 2020 2020 2020 2020 2023 2062 6520 7265           # be re
-00024680: 7374 6172 7465 640a 2020 2020 2020 2020  started.        
-00024690: 2020 2020 6627 736c 6565 7020 3230 272c      f'sleep 20',
-000246a0: 0a20 2020 2020 2020 2020 2020 205f 7465  .            _te
-000246b0: 726d 696e 6174 655f 6763 705f 7265 706c  rminate_gcp_repl
-000246c0: 6963 6128 6e61 6d65 2c20 7a6f 6e65 2c20  ica(name, zone, 
-000246d0: 3129 2c0a 2020 2020 2020 2020 2020 2020  1),.            
-000246e0: 2320 5761 6974 2066 6f72 2063 6f6e 7365  # Wait for conse
-000246f0: 6375 7469 7665 2066 6169 6c75 7265 2074  cutive failure t
-00024700: 696d 656f 7574 2070 6173 7365 642e 0a20  imeout passed.. 
-00024710: 2020 2020 2020 2020 2020 2023 2049 6620             # If 
-00024720: 7468 6520 636c 7573 7465 7220 6973 206e  the cluster is n
-00024730: 6f74 2075 7369 6e67 2073 706f 742c 2069  ot using spot, i
-00024740: 7420 776f 6e27 7420 6368 6563 6b20 7468  t won't check th
-00024750: 6520 636c 7573 7465 7220 7374 6174 7573  e cluster status
-00024760: 0a20 2020 2020 2020 2020 2020 2023 206f  .            # o
-00024770: 6e20 7468 6520 636c 6f75 6420 2873 696e  n the cloud (sin
-00024780: 6365 206d 616e 7561 6c20 7368 7574 646f  ce manual shutdo
-00024790: 776e 2069 7320 6e6f 7420 6120 636f 6d6d  wn is not a comm
-000247a0: 6f6e 2062 6568 6176 696f 7220 616e 6420  on behavior and 
-000247b0: 7375 6368 0a20 2020 2020 2020 2020 2020  such.           
-000247c0: 2023 2071 7565 7269 6573 2074 616b 6573   # queries takes
-000247d0: 2061 206c 6f74 206f 6620 7469 6d65 292e   a lot of time).
-000247e0: 2049 6e73 7465 6164 2c20 7765 2074 6869   Instead, we thi
-000247f0: 6e6b 2063 6f6e 7469 6e75 6f75 7320 3320  nk continuous 3 
-00024800: 6d69 6e20 7072 6f62 650a 2020 2020 2020  min probe.      
-00024810: 2020 2020 2020 2320 6661 696c 7572 6520        # failure 
-00024820: 6973 206e 6f74 2061 2074 656d 706f 7261  is not a tempora
-00024830: 7279 2070 726f 626c 656d 2062 7574 2069  ry problem but i
-00024840: 6e64 6565 6420 6120 6661 696c 7572 652e  ndeed a failure.
-00024850: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
-00024860: 6565 7020 3138 3027 2c0a 2020 2020 2020  eep 180',.      
-00024870: 2020 2020 2020 2320 5765 2063 616e 6e6f        # We canno
-00024880: 7420 7573 6520 5f53 4552 5645 5f57 4149  t use _SERVE_WAI
-00024890: 545f 554e 5449 4c5f 5245 4144 593b 2074  T_UNTIL_READY; t
-000248a0: 6865 7265 2077 696c 6c20 6265 2061 2069  here will be a i
-000248b0: 6e74 6572 6d65 6469 6174 6520 7469 6d65  ntermediate time
-000248c0: 0a20 2020 2020 2020 2020 2020 2023 2074  .            # t
-000248d0: 6861 7420 7468 6520 6f75 7470 7574 206f  hat the output o
-000248e0: 6620 6073 6b79 2073 6572 7665 2073 7461  f `sky serve sta
-000248f0: 7475 7360 2073 686f 7773 2046 4149 4c45  tus` shows FAILE
-00024900: 4420 616e 6420 7468 6973 2073 7461 7475  D and this statu
-00024910: 7320 7769 6c6c 0a20 2020 2020 2020 2020  s will.         
-00024920: 2020 2023 2063 6175 7365 205f 5345 5256     # cause _SERV
-00024930: 455f 5741 4954 5f55 4e54 494c 5f52 4541  E_WAIT_UNTIL_REA
-00024940: 4459 2074 6f20 6561 726c 7920 7175 6974  DY to early quit
-00024950: 2e0a 2020 2020 2020 2020 2020 2020 2728  ..            '(
-00024960: 7768 696c 6520 7472 7565 3b20 646f 270a  while true; do'.
-00024970: 2020 2020 2020 2020 2020 2020 6627 2020              f'  
-00024980: 2020 6f75 7470 7574 3d24 2873 6b79 2073    output=$(sky s
-00024990: 6572 7665 2073 7461 7475 7320 7b6e 616d  erve status {nam
-000249a0: 657d 293b 270a 2020 2020 2020 2020 2020  e});'.          
-000249b0: 2020 2720 2020 2020 6563 686f 2022 246f    '     echo "$o
-000249c0: 7574 7075 7422 207c 2067 7265 7020 2d71  utput" | grep -q
-000249d0: 2022 312f 3122 2026 2620 6272 6561 6b3b   "1/1" && break;
-000249e0: 270a 2020 2020 2020 2020 2020 2020 2720  '.            ' 
-000249f0: 2020 2020 736c 6565 7020 3130 3b27 0a20      sleep 10;'. 
-00024a00: 2020 2020 2020 2020 2020 2066 2764 6f6e             f'don
-00024a10: 6529 3b20 736c 6565 7020 7b73 6572 7665  e); sleep {serve
-00024a20: 2e4c 425f 434f 4e54 524f 4c4c 4552 5f53  .LB_CONTROLLER_S
-00024a30: 594e 435f 494e 5445 5256 414c 5f53 4543  YNC_INTERVAL_SEC
-00024a40: 4f4e 4453 7d3b 272c 0a20 2020 2020 2020  ONDS};',.       
-00024a50: 2020 2020 2066 277b 5f53 4552 5645 5f45       f'{_SERVE_E
-00024a60: 4e44 504f 494e 545f 5741 4954 2e66 6f72  NDPOINT_WAIT.for
-00024a70: 6d61 7428 6e61 6d65 3d6e 616d 6529 7d3b  mat(name=name)};
-00024a80: 2027 0a20 2020 2020 2020 2020 2020 2027   '.            '
-00024a90: 6375 726c 202d 4c20 6874 7470 3a2f 2f24  curl -L http://$
-00024aa0: 656e 6470 6f69 6e74 207c 2067 7265 7020  endpoint | grep 
-00024ab0: 2248 692c 2053 6b79 5069 6c6f 7420 6865  "Hi, SkyPilot he
-00024ac0: 7265 2227 2c0a 2020 2020 2020 2020 5d2c  re"',.        ],
-00024ad0: 0a20 2020 2020 2020 205f 5445 4152 444f  .        _TEARDO
-00024ae0: 574e 5f53 4552 5649 4345 2e66 6f72 6d61  WN_SERVICE.forma
-00024af0: 7428 6e61 6d65 3d6e 616d 6529 2c0a 2020  t(name=name),.  
-00024b00: 2020 2020 2020 7469 6d65 6f75 743d 3230        timeout=20
-00024b10: 202a 2036 302c 0a20 2020 2029 0a20 2020   * 60,.    ).   
-00024b20: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
-00024b30: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
-00024b40: 726b 2e73 6572 7665 0a40 7079 7465 7374  rk.serve.@pytest
-00024b50: 2e6d 6172 6b2e 6e6f 5f6b 7562 6572 6e65  .mark.no_kuberne
-00024b60: 7465 730a 6465 6620 7465 7374 5f73 6b79  tes.def test_sky
-00024b70: 7365 7276 655f 6361 6e63 656c 2867 656e  serve_cancel(gen
-00024b80: 6572 6963 5f63 6c6f 7564 3a20 7374 7229  eric_cloud: str)
-00024b90: 3a0a 2020 2020 2222 2254 6573 7420 736b  :.    """Test sk
-00024ba0: 7973 6572 7665 2077 6974 6820 6361 6e63  yserve with canc
-00024bb0: 656c 2222 220a 2020 2020 6e61 6d65 203d  el""".    name =
-00024bc0: 205f 6765 745f 7365 7276 6963 655f 6e61   _get_service_na
-00024bd0: 6d65 2829 0a0a 2020 2020 7465 7374 203d  me()..    test =
-00024be0: 2054 6573 7428 0a20 2020 2020 2020 2066   Test(.        f
-00024bf0: 2774 6573 742d 736b 7973 6572 7665 2d63  'test-skyserve-c
-00024c00: 616e 6365 6c27 2c0a 2020 2020 2020 2020  ancel',.        
-00024c10: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
-00024c20: 736b 7920 7365 7276 6520 7570 202d 6e20  sky serve up -n 
-00024c30: 7b6e 616d 657d 202d 2d63 6c6f 7564 207b  {name} --cloud {
-00024c40: 6765 6e65 7269 635f 636c 6f75 647d 202d  generic_cloud} -
-00024c50: 7920 7465 7374 732f 736b 7973 6572 7665  y tests/skyserve
-00024c60: 2f63 616e 6365 6c2f 6361 6e63 656c 2e79  /cancel/cancel.y
-00024c70: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-00024c80: 2020 5f53 4552 5645 5f57 4149 545f 554e    _SERVE_WAIT_UN
-00024c90: 5449 4c5f 5245 4144 592e 666f 726d 6174  TIL_READY.format
-00024ca0: 286e 616d 653d 6e61 6d65 2c20 7265 706c  (name=name, repl
-00024cb0: 6963 615f 6e75 6d3d 3129 2c0a 2020 2020  ica_num=1),.    
-00024cc0: 2020 2020 2020 2020 6627 7b5f 5345 5256          f'{_SERV
-00024cd0: 455f 454e 4450 4f49 4e54 5f57 4149 542e  E_ENDPOINT_WAIT.
-00024ce0: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
-00024cf0: 297d 3b20 7079 7468 6f6e 3320 270a 2020  )}; python3 '.  
-00024d00: 2020 2020 2020 2020 2020 2774 6573 7473            'tests
-00024d10: 2f73 6b79 7365 7276 652f 6361 6e63 656c  /skyserve/cancel
-00024d20: 2f73 656e 645f 6361 6e63 656c 5f72 6571  /send_cancel_req
-00024d30: 7565 7374 2e70 7920 270a 2020 2020 2020  uest.py '.      
-00024d40: 2020 2020 2020 272d 2d65 6e64 706f 696e        '--endpoin
-00024d50: 7420 2465 6e64 706f 696e 7420 7c20 6772  t $endpoint | gr
-00024d60: 6570 2022 5265 7175 6573 7420 7761 7320  ep "Request was 
-00024d70: 6361 6e63 656c 6c65 6422 272c 0a20 2020  cancelled"',.   
-00024d80: 2020 2020 2020 2020 2066 2773 3d24 2873           f's=$(s
-00024d90: 6b79 2073 6572 7665 206c 6f67 7320 7b6e  ky serve logs {n
-00024da0: 616d 657d 2031 202d 2d6e 6f2d 666f 6c6c  ame} 1 --no-foll
-00024db0: 6f77 293b 2027 0a20 2020 2020 2020 2020  ow); '.         
-00024dc0: 2020 2027 756e 7469 6c20 2120 6563 686f     'until ! echo
-00024dd0: 2022 2473 2220 7c20 6772 6570 2022 506c   "$s" | grep "Pl
-00024de0: 6561 7365 2077 6169 7420 666f 7220 7468  ease wait for th
-00024df0: 6520 636f 6e74 726f 6c6c 6572 2074 6f20  e controller to 
-00024e00: 6265 223b 2027 0a20 2020 2020 2020 2020  be"; '.         
-00024e10: 2020 2027 646f 2065 6368 6f20 2257 6169     'do echo "Wai
-00024e20: 7469 6e67 2066 6f72 2073 6572 7665 206c  ting for serve l
-00024e30: 6f67 7322 3b20 736c 6565 7020 3130 3b20  ogs"; sleep 10; 
-00024e40: 270a 2020 2020 2020 2020 2020 2020 6627  '.            f'
-00024e50: 733d 2428 736b 7920 7365 7276 6520 6c6f  s=$(sky serve lo
-00024e60: 6773 207b 6e61 6d65 7d20 3120 2d2d 6e6f  gs {name} 1 --no
-00024e70: 2d66 6f6c 6c6f 7729 3b20 646f 6e65 3b20  -follow); done; 
-00024e80: 270a 2020 2020 2020 2020 2020 2020 2765  '.            'e
-00024e90: 6368 6f20 2224 7322 3b20 6563 686f 2022  cho "$s"; echo "
-00024ea0: 2473 2220 7c20 6772 6570 2022 436c 6965  $s" | grep "Clie
-00024eb0: 6e74 2064 6973 636f 6e6e 6563 7465 642c  nt disconnected,
-00024ec0: 2073 746f 7070 696e 6720 636f 6d70 7574   stopping comput
-00024ed0: 6174 696f 6e22 272c 0a20 2020 2020 2020  ation"',.       
-00024ee0: 205d 2c0a 2020 2020 2020 2020 5f54 4541   ],.        _TEA
-00024ef0: 5244 4f57 4e5f 5345 5256 4943 452e 666f  RDOWN_SERVICE.fo
-00024f00: 726d 6174 286e 616d 653d 6e61 6d65 292c  rmat(name=name),
-00024f10: 0a20 2020 2020 2020 2074 696d 656f 7574  .        timeout
-00024f20: 3d32 3020 2a20 3630 2c0a 2020 2020 290a  =20 * 60,.    ).
-00024f30: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
-00024f40: 2874 6573 7429 0a0a 0a40 7079 7465 7374  (test)...@pytest
-00024f50: 2e6d 6172 6b2e 7365 7276 650a 4070 7974  .mark.serve.@pyt
-00024f60: 6573 742e 6d61 726b 2e6e 6f5f 6b75 6265  est.mark.no_kube
-00024f70: 726e 6574 6573 0a64 6566 2074 6573 745f  rnetes.def test_
-00024f80: 736b 7973 6572 7665 5f75 7064 6174 6528  skyserve_update(
-00024f90: 6765 6e65 7269 635f 636c 6f75 643a 2073  generic_cloud: s
-00024fa0: 7472 293a 0a20 2020 2022 2222 5465 7374  tr):.    """Test
-00024fb0: 2073 6b79 7365 7276 6520 7769 7468 2075   skyserve with u
-00024fc0: 7064 6174 6522 2222 0a20 2020 206e 616d  pdate""".    nam
-00024fd0: 6520 3d20 5f67 6574 5f73 6572 7669 6365  e = _get_service
-00024fe0: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
-00024ff0: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-00025000: 2066 2774 6573 742d 736b 7973 6572 7665   f'test-skyserve
-00025010: 2d75 7064 6174 6527 2c0a 2020 2020 2020  -update',.      
-00025020: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
-00025030: 6627 736b 7920 7365 7276 6520 7570 202d  f'sky serve up -
-00025040: 6e20 7b6e 616d 657d 202d 2d63 6c6f 7564  n {name} --cloud
-00025050: 207b 6765 6e65 7269 635f 636c 6f75 647d   {generic_cloud}
-00025060: 202d 7920 7465 7374 732f 736b 7973 6572   -y tests/skyser
-00025070: 7665 2f75 7064 6174 652f 6f6c 642e 7961  ve/update/old.ya
-00025080: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
-00025090: 205f 5345 5256 455f 5741 4954 5f55 4e54   _SERVE_WAIT_UNT
-000250a0: 494c 5f52 4541 4459 2e66 6f72 6d61 7428  IL_READY.format(
-000250b0: 6e61 6d65 3d6e 616d 652c 2072 6570 6c69  name=name, repli
-000250c0: 6361 5f6e 756d 3d32 292c 0a20 2020 2020  ca_num=2),.     
-000250d0: 2020 2020 2020 2066 277b 5f53 4552 5645         f'{_SERVE
-000250e0: 5f45 4e44 504f 494e 545f 5741 4954 2e66  _ENDPOINT_WAIT.f
-000250f0: 6f72 6d61 7428 6e61 6d65 3d6e 616d 6529  ormat(name=name)
-00025100: 7d3b 2063 7572 6c20 2d4c 2068 7474 703a  }; curl -L http:
-00025110: 2f2f 2465 6e64 706f 696e 7420 7c20 6772  //$endpoint | gr
-00025120: 6570 2022 4869 2c20 536b 7950 696c 6f74  ep "Hi, SkyPilot
-00025130: 2068 6572 6522 272c 0a20 2020 2020 2020   here"',.       
-00025140: 2020 2020 2066 2773 6b79 2073 6572 7665       f'sky serve
-00025150: 2075 7064 6174 6520 7b6e 616d 657d 202d   update {name} -
-00025160: 2d63 6c6f 7564 207b 6765 6e65 7269 635f  -cloud {generic_
-00025170: 636c 6f75 647d 202d 2d6d 6f64 6520 626c  cloud} --mode bl
-00025180: 7565 5f67 7265 656e 202d 7920 7465 7374  ue_green -y test
-00025190: 732f 736b 7973 6572 7665 2f75 7064 6174  s/skyserve/updat
-000251a0: 652f 6e65 772e 7961 6d6c 272c 0a20 2020  e/new.yaml',.   
-000251b0: 2020 2020 2020 2020 2023 2073 6c65 6570           # sleep
-000251c0: 2062 6566 6f72 6520 7570 6461 7465 2069   before update i
-000251d0: 7320 7265 6769 7374 6572 6564 2e0a 2020  s registered..  
-000251e0: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
-000251f0: 2032 3027 2c0a 2020 2020 2020 2020 2020   20',.          
-00025200: 2020 6627 7b5f 5345 5256 455f 454e 4450    f'{_SERVE_ENDP
-00025210: 4f49 4e54 5f57 4149 542e 666f 726d 6174  OINT_WAIT.format
-00025220: 286e 616d 653d 6e61 6d65 297d 3b20 270a  (name=name)}; '.
-00025230: 2020 2020 2020 2020 2020 2020 2775 6e74              'unt
-00025240: 696c 2063 7572 6c20 2d4c 2068 7474 703a  il curl -L http:
-00025250: 2f2f 2465 6e64 706f 696e 7420 7c20 6772  //$endpoint | gr
-00025260: 6570 2022 4869 2c20 6e65 7720 536b 7950  ep "Hi, new SkyP
-00025270: 696c 6f74 2068 6572 6521 223b 2064 6f20  ilot here!"; do 
-00025280: 736c 6565 7020 323b 2064 6f6e 653b 270a  sleep 2; done;'.
-00025290: 2020 2020 2020 2020 2020 2020 2320 4d61              # Ma
-000252a0: 6b65 2073 7572 6520 7468 6520 7472 6166  ke sure the traf
-000252b0: 6669 6320 6973 206e 6f74 206d 6978 6564  fic is not mixed
-000252c0: 0a20 2020 2020 2020 2020 2020 2027 6375  .            'cu
-000252d0: 726c 202d 4c20 6874 7470 3a2f 2f24 656e  rl -L http://$en
-000252e0: 6470 6f69 6e74 207c 2067 7265 7020 2248  dpoint | grep "H
-000252f0: 692c 206e 6577 2053 6b79 5069 6c6f 7420  i, new SkyPilot 
-00025300: 6865 7265 2227 2c0a 2020 2020 2020 2020  here"',.        
-00025310: 2020 2020 2320 5468 6520 6c61 7465 7374      # The latest
-00025320: 2032 2076 6572 7369 6f6e 2073 686f 756c   2 version shoul
-00025330: 6420 6265 2052 4541 4459 2061 6e64 2074  d be READY and t
-00025340: 6865 206f 6c64 6572 2076 6572 7369 6f6e  he older version
-00025350: 7320 7368 6f75 6c64 2062 6520 7368 7574  s should be shut
-00025360: 7469 6e67 2064 6f77 6e0a 2020 2020 2020  ting down.      
-00025370: 2020 2020 2020 285f 6368 6563 6b5f 7265        (_check_re
-00025380: 706c 6963 615f 696e 5f73 7461 7475 7328  plica_in_status(
-00025390: 6e61 6d65 2c20 5b28 322c 2046 616c 7365  name, [(2, False
-000253a0: 2c20 2752 4541 4459 2729 2c0a 2020 2020  , 'READY'),.    
-000253b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000253c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000253d0: 2020 2020 2020 2020 2028 322c 2046 616c           (2, Fal
-000253e0: 7365 2c20 2753 4855 5454 494e 475f 444f  se, 'SHUTTING_DO
-000253f0: 574e 2729 5d29 202b 0a20 2020 2020 2020  WN')]) +.       
-00025400: 2020 2020 2020 5f63 6865 636b 5f73 6572        _check_ser
-00025410: 7669 6365 5f76 6572 7369 6f6e 286e 616d  vice_version(nam
-00025420: 652c 2022 3222 2929 2c0a 2020 2020 2020  e, "2")),.      
-00025430: 2020 5d2c 0a20 2020 2020 2020 205f 5445    ],.        _TE
-00025440: 4152 444f 574e 5f53 4552 5649 4345 2e66  ARDOWN_SERVICE.f
-00025450: 6f72 6d61 7428 6e61 6d65 3d6e 616d 6529  ormat(name=name)
-00025460: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
-00025470: 743d 3230 202a 2036 302c 0a20 2020 2029  t=20 * 60,.    )
-00025480: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
-00025490: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
-000254a0: 742e 6d61 726b 2e73 6572 7665 0a40 7079  t.mark.serve.@py
-000254b0: 7465 7374 2e6d 6172 6b2e 6e6f 5f6b 7562  test.mark.no_kub
-000254c0: 6572 6e65 7465 730a 6465 6620 7465 7374  ernetes.def test
-000254d0: 5f73 6b79 7365 7276 655f 726f 6c6c 696e  _skyserve_rollin
-000254e0: 675f 7570 6461 7465 2867 656e 6572 6963  g_update(generic
-000254f0: 5f63 6c6f 7564 3a20 7374 7229 3a0a 2020  _cloud: str):.  
-00025500: 2020 2222 2254 6573 7420 736b 7973 6572    """Test skyser
-00025510: 7665 2077 6974 6820 726f 6c6c 696e 6720  ve with rolling 
-00025520: 7570 6461 7465 2222 220a 2020 2020 6e61  update""".    na
-00025530: 6d65 203d 205f 6765 745f 7365 7276 6963  me = _get_servic
-00025540: 655f 6e61 6d65 2829 0a20 2020 2073 696e  e_name().    sin
-00025550: 676c 655f 6e65 775f 7265 706c 6963 6120  gle_new_replica 
-00025560: 3d20 5f63 6865 636b 5f72 6570 6c69 6361  = _check_replica
-00025570: 5f69 6e5f 7374 6174 7573 280a 2020 2020  _in_status(.    
-00025580: 2020 2020 6e61 6d65 2c20 5b28 322c 2046      name, [(2, F
-00025590: 616c 7365 2c20 2752 4541 4459 2729 2c20  alse, 'READY'), 
-000255a0: 2831 2c20 4661 6c73 652c 205f 5345 5256  (1, False, _SERV
-000255b0: 4943 455f 4c41 554e 4348 494e 475f 5354  ICE_LAUNCHING_ST
-000255c0: 4154 5553 5f52 4547 4558 292c 0a20 2020  ATUS_REGEX),.   
-000255d0: 2020 2020 2020 2020 2020 2020 2831 2c20              (1, 
-000255e0: 4661 6c73 652c 2027 5348 5554 5449 4e47  False, 'SHUTTING
-000255f0: 5f44 4f57 4e27 295d 290a 2020 2020 7465  _DOWN')]).    te
-00025600: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
-00025610: 2020 2066 2774 6573 742d 736b 7973 6572     f'test-skyser
-00025620: 7665 2d72 6f6c 6c69 6e67 2d75 7064 6174  ve-rolling-updat
-00025630: 6527 2c0a 2020 2020 2020 2020 5b0a 2020  e',.        [.  
-00025640: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00025650: 7365 7276 6520 7570 202d 6e20 7b6e 616d  serve up -n {nam
-00025660: 657d 202d 2d63 6c6f 7564 207b 6765 6e65  e} --cloud {gene
-00025670: 7269 635f 636c 6f75 647d 202d 7920 7465  ric_cloud} -y te
-00025680: 7374 732f 736b 7973 6572 7665 2f75 7064  sts/skyserve/upd
-00025690: 6174 652f 6f6c 642e 7961 6d6c 272c 0a20  ate/old.yaml',. 
-000256a0: 2020 2020 2020 2020 2020 205f 5345 5256             _SERV
-000256b0: 455f 5741 4954 5f55 4e54 494c 5f52 4541  E_WAIT_UNTIL_REA
-000256c0: 4459 2e66 6f72 6d61 7428 6e61 6d65 3d6e  DY.format(name=n
-000256d0: 616d 652c 2072 6570 6c69 6361 5f6e 756d  ame, replica_num
-000256e0: 3d32 292c 0a20 2020 2020 2020 2020 2020  =2),.           
-000256f0: 2066 277b 5f53 4552 5645 5f45 4e44 504f   f'{_SERVE_ENDPO
-00025700: 494e 545f 5741 4954 2e66 6f72 6d61 7428  INT_WAIT.format(
-00025710: 6e61 6d65 3d6e 616d 6529 7d3b 2063 7572  name=name)}; cur
-00025720: 6c20 2d4c 2068 7474 703a 2f2f 2465 6e64  l -L http://$end
-00025730: 706f 696e 7420 7c20 6772 6570 2022 4869  point | grep "Hi
-00025740: 2c20 536b 7950 696c 6f74 2068 6572 6522  , SkyPilot here"
-00025750: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00025760: 2773 6b79 2073 6572 7665 2075 7064 6174  'sky serve updat
-00025770: 6520 7b6e 616d 657d 202d 2d63 6c6f 7564  e {name} --cloud
-00025780: 207b 6765 6e65 7269 635f 636c 6f75 647d   {generic_cloud}
-00025790: 202d 7920 7465 7374 732f 736b 7973 6572   -y tests/skyser
-000257a0: 7665 2f75 7064 6174 652f 6e65 772e 7961  ve/update/new.ya
-000257b0: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
-000257c0: 2023 204d 616b 6520 7375 7265 2074 6865   # Make sure the
-000257d0: 2074 7261 6666 6963 2069 7320 6d69 7865   traffic is mixe
-000257e0: 6420 6163 726f 7373 2074 776f 2076 6572  d across two ver
-000257f0: 7369 6f6e 732c 2074 6865 2072 6570 6c69  sions, the repli
-00025800: 6361 730a 2020 2020 2020 2020 2020 2020  cas.            
-00025810: 2320 7769 7468 2065 7665 6e20 6964 2077  # with even id w
-00025820: 696c 6c20 736c 6565 7020 3630 2073 6563  ill sleep 60 sec
-00025830: 6f6e 6473 2062 6566 6f72 6520 6265 696e  onds before bein
-00025840: 6720 7265 6164 792c 2073 6f20 7765 0a20  g ready, so we. 
-00025850: 2020 2020 2020 2020 2020 2023 2073 686f             # sho
-00025860: 756c 6420 6265 2061 626c 6520 746f 2067  uld be able to g
-00025870: 6574 206f 6273 6572 7665 2074 6865 2070  et observe the p
-00025880: 6572 696f 6420 7468 6174 2074 6865 2074  eriod that the t
-00025890: 7261 6666 6963 2069 7320 6d69 7865 640a  raffic is mixed.
-000258a0: 2020 2020 2020 2020 2020 2020 2320 6163              # ac
-000258b0: 726f 7373 2074 776f 2076 6572 7369 6f6e  ross two version
-000258c0: 732e 0a20 2020 2020 2020 2020 2020 2066  s..            f
-000258d0: 277b 5f53 4552 5645 5f45 4e44 504f 494e  '{_SERVE_ENDPOIN
-000258e0: 545f 5741 4954 2e66 6f72 6d61 7428 6e61  T_WAIT.format(na
-000258f0: 6d65 3d6e 616d 6529 7d3b 2027 0a20 2020  me=name)}; '.   
-00025900: 2020 2020 2020 2020 2027 756e 7469 6c20           'until 
-00025910: 6375 726c 202d 4c20 6874 7470 3a2f 2f24  curl -L http://$
-00025920: 656e 6470 6f69 6e74 207c 2067 7265 7020  endpoint | grep 
-00025930: 2248 692c 206e 6577 2053 6b79 5069 6c6f  "Hi, new SkyPilo
-00025940: 7420 6865 7265 2122 3b20 646f 2073 6c65  t here!"; do sle
-00025950: 6570 2032 3b20 646f 6e65 3b20 736c 6565  ep 2; done; slee
-00025960: 7020 323b 2027 0a20 2020 2020 2020 2020  p 2; '.         
-00025970: 2020 2023 2054 6865 206c 6174 6573 7420     # The latest 
-00025980: 7665 7273 696f 6e20 7368 6f75 6c64 2068  version should h
-00025990: 6176 6520 6f6e 6520 5245 4144 5920 616e  ave one READY an
-000259a0: 6420 7468 6520 6f6e 6520 6f66 2074 6865  d the one of the
-000259b0: 206f 6c64 6572 2076 6572 7369 6f6e 7320   older versions 
-000259c0: 7368 6f75 6c64 2062 6520 7368 7574 7469  should be shutti
-000259d0: 6e67 2064 6f77 6e0a 2020 2020 2020 2020  ng down.        
-000259e0: 2020 2020 6627 7b73 696e 676c 655f 6e65      f'{single_ne
-000259f0: 775f 7265 706c 6963 617d 207b 5f63 6865  w_replica} {_che
-00025a00: 636b 5f73 6572 7669 6365 5f76 6572 7369  ck_service_versi
-00025a10: 6f6e 286e 616d 652c 2022 312c 3222 297d  on(name, "1,2")}
-00025a20: 2027 0a20 2020 2020 2020 2020 2020 2023   '.            #
-00025a30: 2043 6865 636b 2074 6865 206f 7574 7075   Check the outpu
-00025a40: 7420 6672 6f6d 2074 6865 206f 6c64 2076  t from the old v
-00025a50: 6572 7369 6f6e 2c20 696d 6d65 6469 6174  ersion, immediat
-00025a60: 656c 7920 6166 7465 7220 7468 650a 2020  ely after the.  
-00025a70: 2020 2020 2020 2020 2020 2320 6f75 7470            # outp
-00025a80: 7574 2066 726f 6d20 7468 6520 6e65 7720  ut from the new 
-00025a90: 7665 7273 696f 6e20 6170 7065 6172 732e  version appears.
-00025aa0: 2054 6869 7320 6973 2067 7561 7261 6e74   This is guarant
-00025ab0: 6565 6420 6279 2074 6865 0a20 2020 2020  eed by the.     
-00025ac0: 2020 2020 2020 2023 2072 6f75 6e64 2072         # round r
-00025ad0: 6f62 696e 206c 6f61 6420 6261 6c61 6e63  obin load balanc
-00025ae0: 696e 6720 706f 6c69 6379 2e0a 2020 2020  ing policy..    
-00025af0: 2020 2020 2020 2020 2320 544f 444f 287a          # TODO(z
-00025b00: 6877 7529 3a20 7765 2073 686f 756c 6420  hwu): we should 
-00025b10: 6861 7665 2061 206d 6f72 6520 6765 6e65  have a more gene
-00025b20: 7261 6c69 7a65 6420 7761 7920 666f 7220  ralized way for 
-00025b30: 6368 6563 6b69 6e67 2074 6865 0a20 2020  checking the.   
-00025b40: 2020 2020 2020 2020 2023 206d 6978 6564           # mixed
-00025b50: 2076 6572 7369 6f6e 206f 6620 7265 706c   version of repl
-00025b60: 6963 6173 2074 6f20 6176 6f69 6420 6465  icas to avoid de
-00025b70: 7065 6e64 696e 6720 6f6e 2074 6865 2073  pending on the s
-00025b80: 7065 6369 6669 630a 2020 2020 2020 2020  pecific.        
-00025b90: 2020 2020 2320 726f 756e 6420 726f 6269      # round robi
-00025ba0: 6e20 6c6f 6164 2062 616c 616e 6369 6e67  n load balancing
-00025bb0: 2070 6f6c 6963 792e 0a20 2020 2020 2020   policy..       
-00025bc0: 2020 2020 2027 6375 726c 202d 4c20 6874       'curl -L ht
-00025bd0: 7470 3a2f 2f24 656e 6470 6f69 6e74 207c  tp://$endpoint |
-00025be0: 2067 7265 7020 2248 692c 2053 6b79 5069   grep "Hi, SkyPi
-00025bf0: 6c6f 7420 6865 7265 2227 2c0a 2020 2020  lot here"',.    
-00025c00: 2020 2020 5d2c 0a20 2020 2020 2020 205f      ],.        _
-00025c10: 5445 4152 444f 574e 5f53 4552 5649 4345  TEARDOWN_SERVICE
-00025c20: 2e66 6f72 6d61 7428 6e61 6d65 3d6e 616d  .format(name=nam
-00025c30: 6529 2c0a 2020 2020 2020 2020 7469 6d65  e),.        time
-00025c40: 6f75 743d 3230 202a 2036 302c 0a20 2020  out=20 * 60,.   
-00025c50: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
-00025c60: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
-00025c70: 6573 742e 6d61 726b 2e73 6572 7665 0a40  est.mark.serve.@
-00025c80: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f6b  pytest.mark.no_k
-00025c90: 7562 6572 6e65 7465 730a 6465 6620 7465  ubernetes.def te
-00025ca0: 7374 5f73 6b79 7365 7276 655f 6661 7374  st_skyserve_fast
-00025cb0: 5f75 7064 6174 6528 6765 6e65 7269 635f  _update(generic_
-00025cc0: 636c 6f75 643a 2073 7472 293a 0a20 2020  cloud: str):.   
-00025cd0: 2022 2222 5465 7374 2073 6b79 7365 7276   """Test skyserv
-00025ce0: 6520 7769 7468 2066 6173 7420 7570 6461  e with fast upda
-00025cf0: 7465 2028 496e 6372 656d 656e 7420 7665  te (Increment ve
-00025d00: 7273 696f 6e20 6f66 206f 6c64 2072 6570  rsion of old rep
-00025d10: 6c69 6361 7329 2222 220a 2020 2020 6e61  licas)""".    na
-00025d20: 6d65 203d 205f 6765 745f 7365 7276 6963  me = _get_servic
-00025d30: 655f 6e61 6d65 2829 0a0a 2020 2020 7465  e_name()..    te
-00025d40: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
-00025d50: 2020 2066 2774 6573 742d 736b 7973 6572     f'test-skyser
-00025d60: 7665 2d66 6173 742d 7570 6461 7465 272c  ve-fast-update',
-00025d70: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
-00025d80: 2020 2020 2020 2066 2773 6b79 2073 6572         f'sky ser
-00025d90: 7665 2075 7020 2d6e 207b 6e61 6d65 7d20  ve up -n {name} 
-00025da0: 2d79 202d 2d63 6c6f 7564 207b 6765 6e65  -y --cloud {gene
-00025db0: 7269 635f 636c 6f75 647d 2074 6573 7473  ric_cloud} tests
-00025dc0: 2f73 6b79 7365 7276 652f 7570 6461 7465  /skyserve/update
-00025dd0: 2f62 756d 705f 7665 7273 696f 6e5f 6265  /bump_version_be
-00025de0: 666f 7265 2e79 616d 6c27 2c0a 2020 2020  fore.yaml',.    
-00025df0: 2020 2020 2020 2020 5f53 4552 5645 5f57          _SERVE_W
-00025e00: 4149 545f 554e 5449 4c5f 5245 4144 592e  AIT_UNTIL_READY.
-00025e10: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
-00025e20: 2c20 7265 706c 6963 615f 6e75 6d3d 3229  , replica_num=2)
-00025e30: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00025e40: 7b5f 5345 5256 455f 454e 4450 4f49 4e54  {_SERVE_ENDPOINT
-00025e50: 5f57 4149 542e 666f 726d 6174 286e 616d  _WAIT.format(nam
-00025e60: 653d 6e61 6d65 297d 3b20 6375 726c 202d  e=name)}; curl -
-00025e70: 4c20 6874 7470 3a2f 2f24 656e 6470 6f69  L http://$endpoi
-00025e80: 6e74 207c 2067 7265 7020 2248 692c 2053  nt | grep "Hi, S
-00025e90: 6b79 5069 6c6f 7420 6865 7265 2227 2c0a  kyPilot here"',.
-00025ea0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00025eb0: 7920 7365 7276 6520 7570 6461 7465 207b  y serve update {
-00025ec0: 6e61 6d65 7d20 2d2d 636c 6f75 6420 7b67  name} --cloud {g
-00025ed0: 656e 6572 6963 5f63 6c6f 7564 7d20 2d2d  eneric_cloud} --
-00025ee0: 6d6f 6465 2062 6c75 655f 6772 6565 6e20  mode blue_green 
-00025ef0: 2d79 2074 6573 7473 2f73 6b79 7365 7276  -y tests/skyserv
-00025f00: 652f 7570 6461 7465 2f62 756d 705f 7665  e/update/bump_ve
-00025f10: 7273 696f 6e5f 6166 7465 722e 7961 6d6c  rsion_after.yaml
-00025f20: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
-00025f30: 2073 6c65 6570 2074 6f20 7761 6974 2066   sleep to wait f
-00025f40: 6f72 2075 7064 6174 6520 746f 2062 6520  or update to be 
-00025f50: 7265 6769 7374 6572 6564 2e0a 2020 2020  registered..    
-00025f60: 2020 2020 2020 2020 2773 6c65 6570 2031          'sleep 1
-00025f70: 3230 272c 0a20 2020 2020 2020 2020 2020  20',.           
-00025f80: 2023 2032 206f 6e2d 6465 616d 6e64 2028   # 2 on-deamnd (
-00025f90: 7265 6164 7929 202b 2031 206f 6e2d 6465  ready) + 1 on-de
-00025fa0: 6d61 6e64 2028 7072 6f76 6973 696f 6e69  mand (provisioni
-00025fb0: 6e67 292e 0a20 2020 2020 2020 2020 2020  ng)..           
-00025fc0: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
-00025fd0: 2020 205f 6368 6563 6b5f 7265 706c 6963     _check_replic
-00025fe0: 615f 696e 5f73 7461 7475 7328 0a20 2020  a_in_status(.   
-00025ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026000: 206e 616d 652c 205b 2832 2c20 4661 6c73   name, [(2, Fals
-00026010: 652c 2027 5245 4144 5927 292c 0a20 2020  e, 'READY'),.   
-00026020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026030: 2020 2020 2020 2020 2831 2c20 4661 6c73          (1, Fals
-00026040: 652c 205f 5345 5256 4943 455f 4c41 554e  e, _SERVICE_LAUN
-00026050: 4348 494e 475f 5354 4154 5553 5f52 4547  CHING_STATUS_REG
-00026060: 4558 295d 2920 2b0a 2020 2020 2020 2020  EX)]) +.        
-00026070: 2020 2020 2020 2020 2320 4661 7374 2075          # Fast u
-00026080: 7064 6174 6520 7769 6c6c 2064 6972 6563  pdate will direc
-00026090: 746c 7920 6861 7665 2074 6865 206c 6174  tly have the lat
-000260a0: 6573 7420 7665 7273 696f 6e20 7265 6164  est version read
-000260b0: 792e 0a20 2020 2020 2020 2020 2020 2020  y..             
-000260c0: 2020 205f 6368 6563 6b5f 7365 7276 6963     _check_servic
-000260d0: 655f 7665 7273 696f 6e28 6e61 6d65 2c20  e_version(name, 
-000260e0: 2232 2229 292c 0a20 2020 2020 2020 2020  "2")),.         
-000260f0: 2020 205f 5345 5256 455f 5741 4954 5f55     _SERVE_WAIT_U
-00026100: 4e54 494c 5f52 4541 4459 2e66 6f72 6d61  NTIL_READY.forma
-00026110: 7428 6e61 6d65 3d6e 616d 652c 2072 6570  t(name=name, rep
-00026120: 6c69 6361 5f6e 756d 3d33 2920 2b0a 2020  lica_num=3) +.  
-00026130: 2020 2020 2020 2020 2020 5f63 6865 636b            _check
-00026140: 5f73 6572 7669 6365 5f76 6572 7369 6f6e  _service_version
-00026150: 286e 616d 652c 2022 3222 292c 0a20 2020  (name, "2"),.   
-00026160: 2020 2020 2020 2020 2066 277b 5f53 4552           f'{_SER
-00026170: 5645 5f45 4e44 504f 494e 545f 5741 4954  VE_ENDPOINT_WAIT
-00026180: 2e66 6f72 6d61 7428 6e61 6d65 3d6e 616d  .format(name=nam
-00026190: 6529 7d3b 2063 7572 6c20 2d4c 2068 7474  e)}; curl -L htt
-000261a0: 703a 2f2f 2465 6e64 706f 696e 7420 7c20  p://$endpoint | 
-000261b0: 6772 6570 2022 4869 2c20 536b 7950 696c  grep "Hi, SkyPil
-000261c0: 6f74 2068 6572 6522 272c 0a20 2020 2020  ot here"',.     
-000261d0: 2020 2020 2020 2023 2054 6573 7420 726f         # Test ro
-000261e0: 6c6c 696e 6720 7570 6461 7465 0a20 2020  lling update.   
-000261f0: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
-00026200: 6572 7665 2075 7064 6174 6520 7b6e 616d  erve update {nam
-00026210: 657d 202d 2d63 6c6f 7564 207b 6765 6e65  e} --cloud {gene
-00026220: 7269 635f 636c 6f75 647d 202d 7920 7465  ric_cloud} -y te
-00026230: 7374 732f 736b 7973 6572 7665 2f75 7064  sts/skyserve/upd
-00026240: 6174 652f 6275 6d70 5f76 6572 7369 6f6e  ate/bump_version
-00026250: 5f62 6566 6f72 652e 7961 6d6c 272c 0a20  _before.yaml',. 
-00026260: 2020 2020 2020 2020 2020 2023 2073 6c65             # sle
-00026270: 6570 2074 6f20 7761 6974 2066 6f72 2075  ep to wait for u
-00026280: 7064 6174 6520 746f 2062 6520 7265 6769  pdate to be regi
-00026290: 7374 6572 6564 2e0a 2020 2020 2020 2020  stered..        
-000262a0: 2020 2020 2773 6c65 6570 2033 3027 2c0a      'sleep 30',.
-000262b0: 2020 2020 2020 2020 2020 2020 2320 3220              # 2 
-000262c0: 6f6e 2d64 6561 6d6e 6420 2872 6561 6479  on-deamnd (ready
-000262d0: 2920 2b20 3120 6f6e 2d64 656d 616e 6420  ) + 1 on-demand 
-000262e0: 2873 6875 7474 696e 6720 646f 776e 292e  (shutting down).
-000262f0: 0a20 2020 2020 2020 2020 2020 205f 6368  .            _ch
-00026300: 6563 6b5f 7265 706c 6963 615f 696e 5f73  eck_replica_in_s
-00026310: 7461 7475 7328 6e61 6d65 2c20 5b28 322c  tatus(name, [(2,
-00026320: 2046 616c 7365 2c20 2752 4541 4459 2729   False, 'READY')
-00026330: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00026340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026350: 2020 2020 2020 2020 2020 2020 2020 2831                (1
-00026360: 2c20 4661 6c73 652c 2027 5348 5554 5449  , False, 'SHUTTI
-00026370: 4e47 5f44 4f57 4e27 295d 292c 0a20 2020  NG_DOWN')]),.   
-00026380: 2020 2020 2020 2020 205f 5345 5256 455f           _SERVE_
-00026390: 5741 4954 5f55 4e54 494c 5f52 4541 4459  WAIT_UNTIL_READY
-000263a0: 2e66 6f72 6d61 7428 6e61 6d65 3d6e 616d  .format(name=nam
-000263b0: 652c 2072 6570 6c69 6361 5f6e 756d 3d32  e, replica_num=2
-000263c0: 2920 2b0a 2020 2020 2020 2020 2020 2020  ) +.            
-000263d0: 5f63 6865 636b 5f73 6572 7669 6365 5f76  _check_service_v
-000263e0: 6572 7369 6f6e 286e 616d 652c 2022 3322  ersion(name, "3"
-000263f0: 292c 0a20 2020 2020 2020 2020 2020 2066  ),.            f
-00026400: 277b 5f53 4552 5645 5f45 4e44 504f 494e  '{_SERVE_ENDPOIN
-00026410: 545f 5741 4954 2e66 6f72 6d61 7428 6e61  T_WAIT.format(na
-00026420: 6d65 3d6e 616d 6529 7d3b 2063 7572 6c20  me=name)}; curl 
-00026430: 2d4c 2068 7474 703a 2f2f 2465 6e64 706f  -L http://$endpo
-00026440: 696e 7420 7c20 6772 6570 2022 4869 2c20  int | grep "Hi, 
-00026450: 536b 7950 696c 6f74 2068 6572 6522 272c  SkyPilot here"',
-00026460: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
-00026470: 2020 2020 5f54 4541 5244 4f57 4e5f 5345      _TEARDOWN_SE
-00026480: 5256 4943 452e 666f 726d 6174 286e 616d  RVICE.format(nam
-00026490: 653d 6e61 6d65 292c 0a20 2020 2020 2020  e=name),.       
-000264a0: 2074 696d 656f 7574 3d33 3020 2a20 3630   timeout=30 * 60
-000264b0: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
-000264c0: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
-000264d0: 0a40 7079 7465 7374 2e6d 6172 6b2e 7365  .@pytest.mark.se
-000264e0: 7276 650a 4070 7974 6573 742e 6d61 726b  rve.@pytest.mark
-000264f0: 2e6e 6f5f 6b75 6265 726e 6574 6573 0a64  .no_kubernetes.d
-00026500: 6566 2074 6573 745f 736b 7973 6572 7665  ef test_skyserve
-00026510: 5f75 7064 6174 655f 6175 746f 7363 616c  _update_autoscal
-00026520: 6528 6765 6e65 7269 635f 636c 6f75 643a  e(generic_cloud:
-00026530: 2073 7472 293a 0a20 2020 2022 2222 5465   str):.    """Te
-00026540: 7374 2073 6b79 7365 7276 6520 7570 6461  st skyserve upda
-00026550: 7465 2077 6974 6820 6175 746f 7363 616c  te with autoscal
-00026560: 6522 2222 0a20 2020 206e 616d 6520 3d20  e""".    name = 
-00026570: 5f67 6574 5f73 6572 7669 6365 5f6e 616d  _get_service_nam
-00026580: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
-00026590: 6573 7428 0a20 2020 2020 2020 2066 2774  est(.        f't
-000265a0: 6573 742d 736b 7973 6572 7665 2d75 7064  est-skyserve-upd
-000265b0: 6174 652d 6175 746f 7363 616c 6527 2c0a  ate-autoscale',.
-000265c0: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
-000265d0: 2020 2020 2020 6627 736b 7920 7365 7276        f'sky serv
-000265e0: 6520 7570 202d 6e20 7b6e 616d 657d 202d  e up -n {name} -
-000265f0: 2d63 6c6f 7564 207b 6765 6e65 7269 635f  -cloud {generic_
-00026600: 636c 6f75 647d 202d 7920 7465 7374 732f  cloud} -y tests/
-00026610: 736b 7973 6572 7665 2f75 7064 6174 652f  skyserve/update/
-00026620: 6e75 6d5f 6d69 6e5f 7477 6f2e 7961 6d6c  num_min_two.yaml
-00026630: 272c 0a20 2020 2020 2020 2020 2020 205f  ',.            _
-00026640: 5345 5256 455f 5741 4954 5f55 4e54 494c  SERVE_WAIT_UNTIL
-00026650: 5f52 4541 4459 2e66 6f72 6d61 7428 6e61  _READY.format(na
-00026660: 6d65 3d6e 616d 652c 2072 6570 6c69 6361  me=name, replica
-00026670: 5f6e 756d 3d32 2920 2b0a 2020 2020 2020  _num=2) +.      
-00026680: 2020 2020 2020 5f63 6865 636b 5f73 6572        _check_ser
-00026690: 7669 6365 5f76 6572 7369 6f6e 286e 616d  vice_version(nam
-000266a0: 652c 2022 3122 292c 0a20 2020 2020 2020  e, "1"),.       
-000266b0: 2020 2020 2066 277b 5f53 4552 5645 5f45       f'{_SERVE_E
-000266c0: 4e44 504f 494e 545f 5741 4954 2e66 6f72  NDPOINT_WAIT.for
-000266d0: 6d61 7428 6e61 6d65 3d6e 616d 6529 7d3b  mat(name=name)};
-000266e0: 2027 0a20 2020 2020 2020 2020 2020 2027   '.            '
-000266f0: 6375 726c 202d 4c20 6874 7470 3a2f 2f24  curl -L http://$
-00026700: 656e 6470 6f69 6e74 207c 2067 7265 7020  endpoint | grep 
-00026710: 2248 692c 2053 6b79 5069 6c6f 7420 6865  "Hi, SkyPilot he
-00026720: 7265 2227 2c0a 2020 2020 2020 2020 2020  re"',.          
-00026730: 2020 6627 736b 7920 7365 7276 6520 7570    f'sky serve up
-00026740: 6461 7465 207b 6e61 6d65 7d20 2d2d 636c  date {name} --cl
-00026750: 6f75 6420 7b67 656e 6572 6963 5f63 6c6f  oud {generic_clo
-00026760: 7564 7d20 2d2d 6d6f 6465 2062 6c75 655f  ud} --mode blue_
-00026770: 6772 6565 6e20 2d79 2074 6573 7473 2f73  green -y tests/s
-00026780: 6b79 7365 7276 652f 7570 6461 7465 2f6e  kyserve/update/n
-00026790: 756d 5f6d 696e 5f6f 6e65 2e79 616d 6c27  um_min_one.yaml'
-000267a0: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-000267b0: 736c 6565 7020 6265 666f 7265 2075 7064  sleep before upd
-000267c0: 6174 6520 6973 2072 6567 6973 7465 7265  ate is registere
-000267d0: 642e 0a20 2020 2020 2020 2020 2020 2027  d..            '
-000267e0: 736c 6565 7020 3230 272c 0a20 2020 2020  sleep 20',.     
-000267f0: 2020 2020 2020 2023 2054 696d 656f 7574         # Timeout
-00026800: 2077 696c 6c20 6265 2074 7269 6767 6572   will be trigger
-00026810: 6564 2077 6865 6e20 7570 6461 7465 2066  ed when update f
-00026820: 6169 6c73 2e0a 2020 2020 2020 2020 2020  ails..          
-00026830: 2020 5f53 4552 5645 5f57 4149 545f 554e    _SERVE_WAIT_UN
-00026840: 5449 4c5f 5245 4144 592e 666f 726d 6174  TIL_READY.format
-00026850: 286e 616d 653d 6e61 6d65 2c20 7265 706c  (name=name, repl
-00026860: 6963 615f 6e75 6d3d 3129 202b 0a20 2020  ica_num=1) +.   
-00026870: 2020 2020 2020 2020 205f 6368 6563 6b5f           _check_
-00026880: 7365 7276 6963 655f 7665 7273 696f 6e28  service_version(
-00026890: 6e61 6d65 2c20 2232 2229 2c0a 2020 2020  name, "2"),.    
-000268a0: 2020 2020 2020 2020 6627 7b5f 5345 5256          f'{_SERV
-000268b0: 455f 454e 4450 4f49 4e54 5f57 4149 542e  E_ENDPOINT_WAIT.
-000268c0: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
-000268d0: 297d 3b20 270a 2020 2020 2020 2020 2020  )}; '.          
-000268e0: 2020 2763 7572 6c20 2d4c 2068 7474 703a    'curl -L http:
-000268f0: 2f2f 2465 6e64 706f 696e 7420 7c20 6772  //$endpoint | gr
-00026900: 6570 2022 4869 2c20 536b 7950 696c 6f74  ep "Hi, SkyPilot
-00026910: 2068 6572 6521 2227 2c0a 2020 2020 2020   here!"',.      
-00026920: 2020 2020 2020 2320 526f 6c6c 696e 6720        # Rolling 
-00026930: 5570 6461 7465 0a20 2020 2020 2020 2020  Update.         
-00026940: 2020 2066 2773 6b79 2073 6572 7665 2075     f'sky serve u
-00026950: 7064 6174 6520 7b6e 616d 657d 202d 2d63  pdate {name} --c
-00026960: 6c6f 7564 207b 6765 6e65 7269 635f 636c  loud {generic_cl
-00026970: 6f75 647d 202d 7920 7465 7374 732f 736b  oud} -y tests/sk
-00026980: 7973 6572 7665 2f75 7064 6174 652f 6e75  yserve/update/nu
-00026990: 6d5f 6d69 6e5f 7477 6f2e 7961 6d6c 272c  m_min_two.yaml',
-000269a0: 0a20 2020 2020 2020 2020 2020 2023 2073  .            # s
-000269b0: 6c65 6570 2062 6566 6f72 6520 7570 6461  leep before upda
-000269c0: 7465 2069 7320 7265 6769 7374 6572 6564  te is registered
-000269d0: 2e0a 2020 2020 2020 2020 2020 2020 2773  ..            's
-000269e0: 6c65 6570 2032 3027 2c0a 2020 2020 2020  leep 20',.      
-000269f0: 2020 2020 2020 2320 5469 6d65 6f75 7420        # Timeout 
-00026a00: 7769 6c6c 2062 6520 7472 6967 6765 7265  will be triggere
-00026a10: 6420 7768 656e 2075 7064 6174 6520 6661  d when update fa
-00026a20: 696c 732e 0a20 2020 2020 2020 2020 2020  ils..           
-00026a30: 205f 5345 5256 455f 5741 4954 5f55 4e54   _SERVE_WAIT_UNT
-00026a40: 494c 5f52 4541 4459 2e66 6f72 6d61 7428  IL_READY.format(
-00026a50: 6e61 6d65 3d6e 616d 652c 2072 6570 6c69  name=name, repli
-00026a60: 6361 5f6e 756d 3d32 2920 2b0a 2020 2020  ca_num=2) +.    
-00026a70: 2020 2020 2020 2020 5f63 6865 636b 5f73          _check_s
-00026a80: 6572 7669 6365 5f76 6572 7369 6f6e 286e  ervice_version(n
-00026a90: 616d 652c 2022 3322 292c 0a20 2020 2020  ame, "3"),.     
-00026aa0: 2020 2020 2020 2066 277b 5f53 4552 5645         f'{_SERVE
-00026ab0: 5f45 4e44 504f 494e 545f 5741 4954 2e66  _ENDPOINT_WAIT.f
-00026ac0: 6f72 6d61 7428 6e61 6d65 3d6e 616d 6529  ormat(name=name)
-00026ad0: 7d3b 2027 0a20 2020 2020 2020 2020 2020  }; '.           
-00026ae0: 2027 6375 726c 202d 4c20 6874 7470 3a2f   'curl -L http:/
-00026af0: 2f24 656e 6470 6f69 6e74 207c 2067 7265  /$endpoint | gre
-00026b00: 7020 2248 692c 2053 6b79 5069 6c6f 7420  p "Hi, SkyPilot 
-00026b10: 6865 7265 2122 272c 0a20 2020 2020 2020  here!"',.       
-00026b20: 205d 2c0a 2020 2020 2020 2020 5f54 4541   ],.        _TEA
-00026b30: 5244 4f57 4e5f 5345 5256 4943 452e 666f  RDOWN_SERVICE.fo
-00026b40: 726d 6174 286e 616d 653d 6e61 6d65 292c  rmat(name=name),
-00026b50: 0a20 2020 2020 2020 2074 696d 656f 7574  .        timeout
-00026b60: 3d33 3020 2a20 3630 2c0a 2020 2020 290a  =30 * 60,.    ).
-00026b70: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
-00026b80: 2874 6573 7429 0a0a 0a40 7079 7465 7374  (test)...@pytest
-00026b90: 2e6d 6172 6b2e 7365 7276 650a 4070 7974  .mark.serve.@pyt
-00026ba0: 6573 742e 6d61 726b 2e70 6172 616d 6574  est.mark.paramet
-00026bb0: 7269 7a65 2827 6d6f 6465 272c 205b 2772  rize('mode', ['r
-00026bc0: 6f6c 6c69 6e67 272c 2027 626c 7565 5f67  olling', 'blue_g
-00026bd0: 7265 656e 275d 290a 4070 7974 6573 742e  reen']).@pytest.
-00026be0: 6d61 726b 2e6e 6f5f 6b75 6265 726e 6574  mark.no_kubernet
-00026bf0: 6573 0a64 6566 2074 6573 745f 736b 7973  es.def test_skys
-00026c00: 6572 7665 5f6e 6577 5f61 7574 6f73 6361  erve_new_autosca
-00026c10: 6c65 725f 7570 6461 7465 286d 6f64 653a  ler_update(mode:
-00026c20: 2073 7472 2c20 6765 6e65 7269 635f 636c   str, generic_cl
-00026c30: 6f75 643a 2073 7472 293a 0a20 2020 2022  oud: str):.    "
-00026c40: 2222 5465 7374 2073 6b79 7365 7276 6520  ""Test skyserve 
-00026c50: 7769 7468 2075 7064 6174 6520 7468 6174  with update that
-00026c60: 2063 6861 6e67 6573 2061 7574 6f73 6361   changes autosca
-00026c70: 6c65 7222 2222 0a20 2020 206e 616d 6520  ler""".    name 
-00026c80: 3d20 5f67 6574 5f73 6572 7669 6365 5f6e  = _get_service_n
-00026c90: 616d 6528 2920 2b20 6d6f 6465 0a0a 2020  ame() + mode..  
-00026ca0: 2020 666f 7572 5f73 706f 745f 7570 5f63    four_spot_up_c
-00026cb0: 6d64 203d 205f 6368 6563 6b5f 7265 706c  md = _check_repl
-00026cc0: 6963 615f 696e 5f73 7461 7475 7328 6e61  ica_in_status(na
-00026cd0: 6d65 2c20 5b28 342c 2054 7275 652c 2027  me, [(4, True, '
-00026ce0: 5245 4144 5927 295d 290a 2020 2020 7570  READY')]).    up
-00026cf0: 6461 7465 5f63 6865 636b 203d 205b 6627  date_check = [f'
-00026d00: 756e 7469 6c20 287b 666f 7572 5f73 706f  until ({four_spo
-00026d10: 745f 7570 5f63 6d64 7d29 3b20 646f 2073  t_up_cmd}); do s
-00026d20: 6c65 6570 2035 3b20 646f 6e65 3b20 736c  leep 5; done; sl
-00026d30: 6565 7020 3130 3b27 5d0a 2020 2020 6966  eep 10;'].    if
-00026d40: 206d 6f64 6520 3d3d 2027 726f 6c6c 696e   mode == 'rollin
-00026d50: 6727 3a0a 2020 2020 2020 2020 2320 4368  g':.        # Ch
-00026d60: 6563 6b20 726f 6c6c 696e 6720 7570 6461  eck rolling upda
-00026d70: 7465 2c20 6974 2077 696c 6c20 7465 726d  te, it will term
-00026d80: 696e 6174 6520 6f6e 6520 6f66 2074 6865  inate one of the
-00026d90: 206f 6c64 206f 6e2d 6465 6d61 6e64 0a20   old on-demand. 
-00026da0: 2020 2020 2020 2023 2069 6e73 7461 6e63         # instanc
-00026db0: 6573 2c20 6f6e 6365 2074 6865 7265 2061  es, once there a
-00026dc0: 7265 2034 2073 706f 7420 696e 7374 616e  re 4 spot instan
-00026dd0: 6365 2072 6561 6479 2e0a 2020 2020 2020  ce ready..      
-00026de0: 2020 7570 6461 7465 5f63 6865 636b 202b    update_check +
-00026df0: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
-00026e00: 5f63 6865 636b 5f72 6570 6c69 6361 5f69  _check_replica_i
-00026e10: 6e5f 7374 6174 7573 280a 2020 2020 2020  n_status(.      
-00026e20: 2020 2020 2020 2020 2020 6e61 6d65 2c20            name, 
-00026e30: 5b28 312c 2046 616c 7365 2c20 5f53 4552  [(1, False, _SER
-00026e40: 5649 4345 5f4c 4155 4e43 4849 4e47 5f53  VICE_LAUNCHING_S
-00026e50: 5441 5455 535f 5245 4745 5829 2c0a 2020  TATUS_REGEX),.  
-00026e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026e70: 2020 2020 2028 312c 2046 616c 7365 2c20       (1, False, 
-00026e80: 2753 4855 5454 494e 475f 444f 574e 2729  'SHUTTING_DOWN')
-00026e90: 2c20 2831 2c20 4661 6c73 652c 2027 5245  , (1, False, 'RE
-00026ea0: 4144 5927 295d 2920 2b0a 2020 2020 2020  ADY')]) +.      
-00026eb0: 2020 2020 2020 5f63 6865 636b 5f73 6572        _check_ser
-00026ec0: 7669 6365 5f76 6572 7369 6f6e 286e 616d  vice_version(nam
-00026ed0: 652c 2022 312c 3222 292c 0a20 2020 2020  e, "1,2"),.     
-00026ee0: 2020 205d 0a20 2020 2065 6c73 653a 0a20     ].    else:. 
-00026ef0: 2020 2020 2020 2023 2043 6865 636b 2062         # Check b
-00026f00: 6c75 6520 6772 6565 6e20 7570 6461 7465  lue green update
-00026f10: 2c20 6974 2077 696c 6c20 6b65 6570 2062  , it will keep b
-00026f20: 6f74 6820 6f6c 6420 6f6e 2d64 656d 616e  oth old on-deman
-00026f30: 6420 696e 7374 616e 6365 730a 2020 2020  d instances.    
-00026f40: 2020 2020 2320 7275 6e6e 696e 672c 206f      # running, o
-00026f50: 6e63 6520 7468 6572 6520 6172 6520 3420  nce there are 4 
-00026f60: 7370 6f74 2069 6e73 7461 6e63 6520 7265  spot instance re
-00026f70: 6164 792e 0a20 2020 2020 2020 2075 7064  ady..        upd
-00026f80: 6174 655f 6368 6563 6b20 2b3d 205b 0a20  ate_check += [. 
-00026f90: 2020 2020 2020 2020 2020 205f 6368 6563             _chec
-00026fa0: 6b5f 7265 706c 6963 615f 696e 5f73 7461  k_replica_in_sta
-00026fb0: 7475 7328 0a20 2020 2020 2020 2020 2020  tus(.           
-00026fc0: 2020 2020 206e 616d 652c 205b 2831 2c20       name, [(1, 
-00026fd0: 4661 6c73 652c 205f 5345 5256 4943 455f  False, _SERVICE_
-00026fe0: 4c41 554e 4348 494e 475f 5354 4154 5553  LAUNCHING_STATUS
-00026ff0: 5f52 4547 4558 292c 0a20 2020 2020 2020  _REGEX),.       
-00027000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027010: 2832 2c20 4661 6c73 652c 2027 5245 4144  (2, False, 'READ
-00027020: 5927 295d 2920 2b0a 2020 2020 2020 2020  Y')]) +.        
-00027030: 2020 2020 5f63 6865 636b 5f73 6572 7669      _check_servi
-00027040: 6365 5f76 6572 7369 6f6e 286e 616d 652c  ce_version(name,
-00027050: 2022 3122 292c 0a20 2020 2020 2020 205d   "1"),.        ]
-00027060: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
-00027070: 280a 2020 2020 2020 2020 2774 6573 742d  (.        'test-
-00027080: 736b 7973 6572 7665 2d6e 6577 2d61 7574  skyserve-new-aut
-00027090: 6f73 6361 6c65 722d 7570 6461 7465 272c  oscaler-update',
-000270a0: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
-000270b0: 2020 2020 2020 2066 2773 6b79 2073 6572         f'sky ser
-000270c0: 7665 2075 7020 2d6e 207b 6e61 6d65 7d20  ve up -n {name} 
-000270d0: 2d2d 636c 6f75 6420 7b67 656e 6572 6963  --cloud {generic
-000270e0: 5f63 6c6f 7564 7d20 2d79 2074 6573 7473  _cloud} -y tests
-000270f0: 2f73 6b79 7365 7276 652f 7570 6461 7465  /skyserve/update
-00027100: 2f6e 6577 5f61 7574 6f73 6361 6c65 725f  /new_autoscaler_
-00027110: 6265 666f 7265 2e79 616d 6c27 2c0a 2020  before.yaml',.  
-00027120: 2020 2020 2020 2020 2020 5f53 4552 5645            _SERVE
-00027130: 5f57 4149 545f 554e 5449 4c5f 5245 4144  _WAIT_UNTIL_READ
-00027140: 592e 666f 726d 6174 286e 616d 653d 6e61  Y.format(name=na
-00027150: 6d65 2c20 7265 706c 6963 615f 6e75 6d3d  me, replica_num=
-00027160: 3229 202b 0a20 2020 2020 2020 2020 2020  2) +.           
-00027170: 205f 6368 6563 6b5f 7365 7276 6963 655f   _check_service_
-00027180: 7665 7273 696f 6e28 6e61 6d65 2c20 2231  version(name, "1
-00027190: 2229 2c0a 2020 2020 2020 2020 2020 2020  "),.            
-000271a0: 6627 7b5f 5345 5256 455f 454e 4450 4f49  f'{_SERVE_ENDPOI
-000271b0: 4e54 5f57 4149 542e 666f 726d 6174 286e  NT_WAIT.format(n
-000271c0: 616d 653d 6e61 6d65 297d 3b20 270a 2020  ame=name)}; '.  
-000271d0: 2020 2020 2020 2020 2020 2773 3d24 2863            's=$(c
-000271e0: 7572 6c20 2d4c 2068 7474 703a 2f2f 2465  url -L http://$e
-000271f0: 6e64 706f 696e 7429 3b20 6563 686f 2022  ndpoint); echo "
-00027200: 2473 223b 2065 6368 6f20 2224 7322 207c  $s"; echo "$s" |
-00027210: 2067 7265 7020 2248 692c 2053 6b79 5069   grep "Hi, SkyPi
-00027220: 6c6f 7420 6865 7265 2227 2c0a 2020 2020  lot here"',.    
-00027230: 2020 2020 2020 2020 6627 736b 7920 7365          f'sky se
-00027240: 7276 6520 7570 6461 7465 207b 6e61 6d65  rve update {name
-00027250: 7d20 2d2d 636c 6f75 6420 7b67 656e 6572  } --cloud {gener
-00027260: 6963 5f63 6c6f 7564 7d20 2d2d 6d6f 6465  ic_cloud} --mode
-00027270: 207b 6d6f 6465 7d20 2d79 2074 6573 7473   {mode} -y tests
-00027280: 2f73 6b79 7365 7276 652f 7570 6461 7465  /skyserve/update
-00027290: 2f6e 6577 5f61 7574 6f73 6361 6c65 725f  /new_autoscaler_
-000272a0: 6166 7465 722e 7961 6d6c 272c 0a20 2020  after.yaml',.   
-000272b0: 2020 2020 2020 2020 2023 2057 6169 7420           # Wait 
-000272c0: 666f 7220 7570 6461 7465 2074 6f20 6265  for update to be
-000272d0: 2072 6567 6973 7465 7265 640a 2020 2020   registered.    
-000272e0: 2020 2020 2020 2020 6627 736c 6565 7020          f'sleep 
-000272f0: 3132 3027 2c0a 2020 2020 2020 2020 2020  120',.          
-00027300: 2020 5f63 6865 636b 5f72 6570 6c69 6361    _check_replica
-00027310: 5f69 6e5f 7374 6174 7573 280a 2020 2020  _in_status(.    
-00027320: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
-00027330: 2c20 5b28 342c 2054 7275 652c 205f 5345  , [(4, True, _SE
-00027340: 5256 4943 455f 4c41 554e 4348 494e 475f  RVICE_LAUNCHING_
-00027350: 5354 4154 5553 5f52 4547 4558 202b 2027  STATUS_REGEX + '
-00027360: 5c7c 5245 4144 5927 292c 0a20 2020 2020  \|READY'),.     
-00027370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027380: 2020 2831 2c20 4661 6c73 652c 205f 5345    (1, False, _SE
-00027390: 5256 4943 455f 4c41 554e 4348 494e 475f  RVICE_LAUNCHING_
-000273a0: 5354 4154 5553 5f52 4547 4558 292c 0a20  STATUS_REGEX),. 
-000273b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000273c0: 2020 2020 2020 2832 2c20 4661 6c73 652c        (2, False,
-000273d0: 2027 5245 4144 5927 295d 292c 0a20 2020   'READY')]),.   
-000273e0: 2020 2020 2020 2020 202a 7570 6461 7465           *update
-000273f0: 5f63 6865 636b 2c0a 2020 2020 2020 2020  _check,.        
-00027400: 2020 2020 5f53 4552 5645 5f57 4149 545f      _SERVE_WAIT_
-00027410: 554e 5449 4c5f 5245 4144 592e 666f 726d  UNTIL_READY.form
-00027420: 6174 286e 616d 653d 6e61 6d65 2c20 7265  at(name=name, re
-00027430: 706c 6963 615f 6e75 6d3d 3529 2c0a 2020  plica_num=5),.  
-00027440: 2020 2020 2020 2020 2020 6627 7b5f 5345            f'{_SE
-00027450: 5256 455f 454e 4450 4f49 4e54 5f57 4149  RVE_ENDPOINT_WAI
-00027460: 542e 666f 726d 6174 286e 616d 653d 6e61  T.format(name=na
-00027470: 6d65 297d 3b20 270a 2020 2020 2020 2020  me)}; '.        
-00027480: 2020 2020 2763 7572 6c20 2d4c 2068 7474      'curl -L htt
-00027490: 703a 2f2f 2465 6e64 706f 696e 7420 7c20  p://$endpoint | 
-000274a0: 6772 6570 2022 4869 2c20 536b 7950 696c  grep "Hi, SkyPil
-000274b0: 6f74 2068 6572 6522 272c 0a20 2020 2020  ot here"',.     
-000274c0: 2020 2020 2020 205f 6368 6563 6b5f 7265         _check_re
-000274d0: 706c 6963 615f 696e 5f73 7461 7475 7328  plica_in_status(
-000274e0: 6e61 6d65 2c20 5b28 342c 2054 7275 652c  name, [(4, True,
-000274f0: 2027 5245 4144 5927 292c 0a20 2020 2020   'READY'),.     
-00027500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027520: 2020 2020 2020 2028 312c 2046 616c 7365         (1, False
-00027530: 2c20 2752 4541 4459 2729 5d29 2c0a 2020  , 'READY')]),.  
-00027540: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-00027550: 205f 5445 4152 444f 574e 5f53 4552 5649   _TEARDOWN_SERVI
-00027560: 4345 2e66 6f72 6d61 7428 6e61 6d65 3d6e  CE.format(name=n
-00027570: 616d 6529 2c0a 2020 2020 2020 2020 7469  ame),.        ti
-00027580: 6d65 6f75 743d 3230 202a 2036 302c 0a20  meout=20 * 60,. 
-00027590: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
-000275a0: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
-000275b0: 7974 6573 742e 6d61 726b 2e73 6572 7665  ytest.mark.serve
-000275c0: 0a64 6566 2074 6573 745f 736b 7973 6572  .def test_skyser
-000275d0: 7665 5f66 6169 6c75 7265 7328 6765 6e65  ve_failures(gene
-000275e0: 7269 635f 636c 6f75 643a 2073 7472 293a  ric_cloud: str):
-000275f0: 0a20 2020 2022 2222 5465 7374 2072 6570  .    """Test rep
-00027600: 6c69 6361 2066 6169 6c75 7265 2073 7461  lica failure sta
-00027610: 7475 7365 7322 2222 0a20 2020 206e 616d  tuses""".    nam
-00027620: 6520 3d20 5f67 6574 5f73 6572 7669 6365  e = _get_service
-00027630: 5f6e 616d 6528 290a 0a20 2020 2074 6573  _name()..    tes
-00027640: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
-00027650: 2020 2774 6573 742d 736b 7973 6572 7665    'test-skyserve
-00027660: 2d66 6169 6c75 7265 7327 2c0a 2020 2020  -failures',.    
-00027670: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
-00027680: 2020 6627 736b 7920 7365 7276 6520 7570    f'sky serve up
-00027690: 202d 6e20 7b6e 616d 657d 202d 2d63 6c6f   -n {name} --clo
-000276a0: 7564 207b 6765 6e65 7269 635f 636c 6f75  ud {generic_clou
-000276b0: 647d 202d 7920 7465 7374 732f 736b 7973  d} -y tests/skys
-000276c0: 6572 7665 2f66 6169 6c75 7265 732f 696e  erve/failures/in
-000276d0: 6974 6961 6c5f 6465 6c61 792e 7961 6d6c  itial_delay.yaml
-000276e0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-000276f0: 2773 3d24 2873 6b79 2073 6572 7665 2073  's=$(sky serve s
-00027700: 7461 7475 7320 7b6e 616d 657d 293b 2027  tatus {name}); '
-00027710: 0a20 2020 2020 2020 2020 2020 2066 2775  .            f'u
-00027720: 6e74 696c 2065 6368 6f20 2224 7322 207c  ntil echo "$s" |
-00027730: 2067 7265 7020 2246 4149 4c45 445f 494e   grep "FAILED_IN
-00027740: 4954 4941 4c5f 4445 4c41 5922 3b20 646f  ITIAL_DELAY"; do
-00027750: 2027 0a20 2020 2020 2020 2020 2020 2027   '.            '
-00027760: 6563 686f 2022 5761 6974 696e 6720 666f  echo "Waiting fo
-00027770: 7220 7265 706c 6963 6120 746f 2062 6520  r replica to be 
-00027780: 6661 696c 6564 2e2e 2e22 3b20 736c 6565  failed..."; slee
-00027790: 7020 353b 2027 0a20 2020 2020 2020 2020  p 5; '.         
-000277a0: 2020 2066 2773 3d24 2873 6b79 2073 6572     f's=$(sky ser
-000277b0: 7665 2073 7461 7475 7320 7b6e 616d 657d  ve status {name}
-000277c0: 293b 2065 6368 6f20 2224 7322 3b20 646f  ); echo "$s"; do
-000277d0: 6e65 3b27 2c0a 2020 2020 2020 2020 2020  ne;',.          
-000277e0: 2020 2773 6c65 6570 2036 3027 2c0a 2020    'sleep 60',.  
-000277f0: 2020 2020 2020 2020 2020 6627 7b5f 5345            f'{_SE
-00027800: 5256 455f 5354 4154 5553 5f57 4149 542e  RVE_STATUS_WAIT.
-00027810: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
-00027820: 297d 3b20 6563 686f 2022 2473 2220 7c20  )}; echo "$s" | 
-00027830: 6772 6570 2022 7b6e 616d 657d 2220 7c20  grep "{name}" | 
-00027840: 6772 6570 2022 4641 494c 4544 5f49 4e49  grep "FAILED_INI
-00027850: 5449 414c 5f44 454c 4159 2220 7c20 7763  TIAL_DELAY" | wc
-00027860: 202d 6c20 7c20 6772 6570 2032 3b20 270a   -l | grep 2; '.
-00027870: 2020 2020 2020 2020 2020 2020 2320 4d61              # Ma
-00027880: 6b65 2073 7572 6520 6e6f 206e 6577 2072  ke sure no new r
-00027890: 6570 6c69 6361 7320 6172 6520 7374 6172  eplicas are star
-000278a0: 7465 6420 666f 7220 6561 726c 7920 6661  ted for early fa
-000278b0: 696c 7572 652e 0a20 2020 2020 2020 2020  ilure..         
-000278c0: 2020 2066 2765 6368 6f20 2224 7322 207c     f'echo "$s" |
-000278d0: 2067 7265 7020 2d41 2031 3030 2022 5365   grep -A 100 "Se
-000278e0: 7276 6963 6520 5265 706c 6963 6173 2220  rvice Replicas" 
-000278f0: 7c20 6772 6570 2022 7b6e 616d 657d 2220  | grep "{name}" 
-00027900: 7c20 7763 202d 6c20 7c20 6772 6570 2032  | wc -l | grep 2
-00027910: 3b27 2c0a 2020 2020 2020 2020 2020 2020  ;',.            
-00027920: 6627 736b 7920 7365 7276 6520 7570 6461  f'sky serve upda
-00027930: 7465 207b 6e61 6d65 7d20 2d2d 636c 6f75  te {name} --clou
-00027940: 6420 7b67 656e 6572 6963 5f63 6c6f 7564  d {generic_cloud
-00027950: 7d20 2d79 2074 6573 7473 2f73 6b79 7365  } -y tests/skyse
-00027960: 7276 652f 6661 696c 7572 6573 2f70 726f  rve/failures/pro
-00027970: 6269 6e67 2e79 616d 6c27 2c0a 2020 2020  bing.yaml',.    
-00027980: 2020 2020 2020 2020 6627 733d 2428 736b          f's=$(sk
-00027990: 7920 7365 7276 6520 7374 6174 7573 207b  y serve status {
-000279a0: 6e61 6d65 7d29 3b20 270a 2020 2020 2020  name}); '.      
-000279b0: 2020 2020 2020 2320 5761 6974 2066 6f72        # Wait for
-000279c0: 2072 6570 6c69 6361 2074 6f20 6265 2072   replica to be r
-000279d0: 6561 6479 2e0a 2020 2020 2020 2020 2020  eady..          
-000279e0: 2020 6627 756e 7469 6c20 6563 686f 2022    f'until echo "
-000279f0: 2473 2220 7c20 6772 6570 2022 5245 4144  $s" | grep "READ
-00027a00: 5922 3b20 646f 2027 0a20 2020 2020 2020  Y"; do '.       
-00027a10: 2020 2020 2027 6563 686f 2022 5761 6974       'echo "Wait
-00027a20: 696e 6720 666f 7220 7265 706c 6963 6120  ing for replica 
-00027a30: 746f 2062 6520 6661 696c 6564 2e2e 2e22  to be failed..."
-00027a40: 3b20 736c 6565 7020 353b 2027 0a20 2020  ; sleep 5; '.   
-00027a50: 2020 2020 2020 2020 2066 2773 3d24 2873           f's=$(s
-00027a60: 6b79 2073 6572 7665 2073 7461 7475 7320  ky serve status 
-00027a70: 7b6e 616d 657d 293b 2065 6368 6f20 2224  {name}); echo "$
-00027a80: 7322 3b20 646f 6e65 3b27 2c0a 2020 2020  s"; done;',.    
-00027a90: 2020 2020 2020 2020 2320 5761 6974 2066          # Wait f
-00027aa0: 6f72 2072 6570 6c69 6361 2074 6f20 6368  or replica to ch
-00027ab0: 616e 6765 2074 6f20 4641 494c 4544 5f50  ange to FAILED_P
-00027ac0: 524f 4249 4e47 0a20 2020 2020 2020 2020  ROBING.         
-00027ad0: 2020 2066 2773 3d24 2873 6b79 2073 6572     f's=$(sky ser
-00027ae0: 7665 2073 7461 7475 7320 7b6e 616d 657d  ve status {name}
-00027af0: 293b 2027 0a20 2020 2020 2020 2020 2020  ); '.           
-00027b00: 2066 2775 6e74 696c 2065 6368 6f20 2224   f'until echo "$
-00027b10: 7322 207c 2067 7265 7020 2246 4149 4c45  s" | grep "FAILE
-00027b20: 445f 5052 4f42 494e 4722 3b20 646f 2027  D_PROBING"; do '
-00027b30: 0a20 2020 2020 2020 2020 2020 2027 6563  .            'ec
-00027b40: 686f 2022 5761 6974 696e 6720 666f 7220  ho "Waiting for 
-00027b50: 7265 706c 6963 6120 746f 2062 6520 6661  replica to be fa
-00027b60: 696c 6564 2e2e 2e22 3b20 736c 6565 7020  iled..."; sleep 
-00027b70: 353b 2027 0a20 2020 2020 2020 2020 2020  5; '.           
-00027b80: 2066 2773 3d24 2873 6b79 2073 6572 7665   f's=$(sky serve
-00027b90: 2073 7461 7475 7320 7b6e 616d 657d 293b   status {name});
-00027ba0: 2065 6368 6f20 2224 7322 3b20 646f 6e65   echo "$s"; done
-00027bb0: 3b27 202b 0a20 2020 2020 2020 2020 2020  ;' +.           
-00027bc0: 205f 6368 6563 6b5f 7265 706c 6963 615f   _check_replica_
-00027bd0: 696e 5f73 7461 7475 7328 0a20 2020 2020  in_status(.     
-00027be0: 2020 2020 2020 2020 2020 206e 616d 652c             name,
-00027bf0: 205b 2831 2c20 4661 6c73 652c 2027 4641   [(1, False, 'FA
-00027c00: 494c 4544 5f50 524f 4249 4e47 2729 2c0a  ILED_PROBING'),.
-00027c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027c20: 2020 2020 2020 2028 312c 2046 616c 7365         (1, False
-00027c30: 2c20 5f53 4552 5649 4345 5f4c 4155 4e43  , _SERVICE_LAUNC
-00027c40: 4849 4e47 5f53 5441 5455 535f 5245 4745  HING_STATUS_REGE
-00027c50: 5829 5d29 2c0a 2020 2020 2020 2020 2020  X)]),.          
-00027c60: 2020 2320 544f 444f 287a 6877 7529 3a20    # TODO(zhwu): 
-00027c70: 6164 6420 7465 7374 2066 6f72 2046 4149  add test for FAI
-00027c80: 4c45 445f 5052 4f56 4953 494f 4e0a 2020  LED_PROVISION.  
-00027c90: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-00027ca0: 205f 5445 4152 444f 574e 5f53 4552 5649   _TEARDOWN_SERVI
-00027cb0: 4345 2e66 6f72 6d61 7428 6e61 6d65 3d6e  CE.format(name=n
-00027cc0: 616d 6529 2c0a 2020 2020 2020 2020 7469  ame),.        ti
-00027cd0: 6d65 6f75 743d 3230 202a 2036 302c 0a20  meout=20 * 60,. 
-00027ce0: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
-00027cf0: 5f74 6573 7428 7465 7374 290a 0a0a 2320  _test(test)...# 
-00027d00: 544f 444f 285a 696d 696e 672c 2054 6961  TODO(Ziming, Tia
-00027d10: 6e29 3a20 4164 6420 7465 7374 7320 666f  n): Add tests fo
-00027d20: 7220 6175 746f 7363 616c 696e 672e 0a0a  r autoscaling...
-00027d30: 0a23 202d 2d2d 2d2d 2d2d 2054 6573 7469  .# ------- Testi
-00027d40: 6e67 2075 7365 7220 7261 7920 636c 7573  ng user ray clus
-00027d50: 7465 7220 2d2d 2d2d 2d2d 2d2d 0a64 6566  ter --------.def
-00027d60: 2074 6573 745f 7573 6572 5f72 6179 5f63   test_user_ray_c
-00027d70: 6c75 7374 6572 2867 656e 6572 6963 5f63  luster(generic_c
-00027d80: 6c6f 7564 3a20 7374 7229 3a0a 2020 2020  loud: str):.    
-00027d90: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
-00027da0: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
-00027db0: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
-00027dc0: 2020 2020 2775 7365 722d 7261 792d 636c      'user-ray-cl
-00027dd0: 7573 7465 7227 2c0a 2020 2020 2020 2020  uster',.        
-00027de0: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
-00027df0: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
-00027e00: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
-00027e10: 7b67 656e 6572 6963 5f63 6c6f 7564 7d20  {generic_cloud} 
-00027e20: 2272 6179 2073 7461 7274 202d 2d68 6561  "ray start --hea
-00027e30: 6422 272c 0a20 2020 2020 2020 2020 2020  d"',.           
-00027e40: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
-00027e50: 657d 2022 6563 686f 2068 6922 272c 0a20  e} "echo hi"',. 
-00027e60: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00027e70: 206c 6f67 7320 7b6e 616d 657d 2031 202d   logs {name} 1 -
-00027e80: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
-00027e90: 2020 2020 2020 6627 736b 7920 7374 6174        f'sky stat
-00027ea0: 7573 202d 7220 7b6e 616d 657d 207c 2067  us -r {name} | g
-00027eb0: 7265 7020 5550 272c 0a20 2020 2020 2020  rep UP',.       
-00027ec0: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
-00027ed0: 7b6e 616d 657d 2022 6563 686f 2062 7965  {name} "echo bye
-00027ee0: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-00027ef0: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
-00027f00: 7d20 3220 2d2d 7374 6174 7573 272c 0a20  } 2 --status',. 
-00027f10: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-00027f20: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
-00027f30: 7b6e 616d 657d 272c 0a20 2020 2029 0a20  {name}',.    ). 
-00027f40: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-00027f50: 7465 7374 290a 0a0a 2320 2d2d 2d2d 2d2d  test)...# ------
-00027f60: 2d20 5465 7374 696e 6720 7468 6520 636f  - Testing the co
-00027f70: 7265 2041 5049 202d 2d2d 2d2d 2d2d 2d0a  re API --------.
-00027f80: 2320 4d6f 7374 206f 6620 7468 6520 636f  # Most of the co
-00027f90: 7265 2041 5049 7320 6861 7665 2062 6565  re APIs have bee
-00027fa0: 6e20 7465 7374 6564 2069 6e20 7468 6520  n tested in the 
-00027fb0: 434c 4920 7465 7374 732e 0a23 2054 6865  CLI tests..# The
-00027fc0: 7365 2074 6573 7473 2061 7265 2066 6f72  se tests are for
-00027fd0: 2074 6573 7469 6e67 2074 6865 2072 6574   testing the ret
-00027fe0: 7572 6e20 7661 6c75 6520 6f66 2074 6865  urn value of the
-00027ff0: 2041 5049 7320 6e6f 7420 6675 6c6c 7920   APIs not fully 
-00028000: 7573 6564 2069 6e20 434c 492e 0a0a 0a40  used in CLI....@
-00028010: 7079 7465 7374 2e6d 6172 6b2e 6763 700a  pytest.mark.gcp.
-00028020: 6465 6620 7465 7374 5f63 6f72 655f 6170  def test_core_ap
-00028030: 695f 736b 795f 6c61 756e 6368 5f65 7865  i_sky_launch_exe
-00028040: 6328 293a 0a20 2020 206e 616d 6520 3d20  c():.    name = 
-00028050: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
-00028060: 6528 290a 2020 2020 7461 736b 203d 2073  e().    task = s
-00028070: 6b79 2e54 6173 6b28 7275 6e3d 2277 686f  ky.Task(run="who
-00028080: 616d 6922 290a 2020 2020 7461 736b 2e73  ami").    task.s
-00028090: 6574 5f72 6573 6f75 7263 6573 2873 6b79  et_resources(sky
-000280a0: 2e52 6573 6f75 7263 6573 2863 6c6f 7564  .Resources(cloud
-000280b0: 3d73 6b79 2e47 4350 2829 2929 0a20 2020  =sky.GCP())).   
-000280c0: 206a 6f62 5f69 642c 2068 616e 646c 6520   job_id, handle 
-000280d0: 3d20 736b 792e 6c61 756e 6368 2874 6173  = sky.launch(tas
-000280e0: 6b2c 2063 6c75 7374 6572 5f6e 616d 653d  k, cluster_name=
-000280f0: 6e61 6d65 290a 2020 2020 6173 7365 7274  name).    assert
-00028100: 206a 6f62 5f69 6420 3d3d 2031 0a20 2020   job_id == 1.   
-00028110: 2061 7373 6572 7420 6861 6e64 6c65 2069   assert handle i
-00028120: 7320 6e6f 7420 4e6f 6e65 0a20 2020 2061  s not None.    a
-00028130: 7373 6572 7420 6861 6e64 6c65 2e63 6c75  ssert handle.clu
-00028140: 7374 6572 5f6e 616d 6520 3d3d 206e 616d  ster_name == nam
-00028150: 650a 2020 2020 6173 7365 7274 2068 616e  e.    assert han
-00028160: 646c 652e 6c61 756e 6368 6564 5f72 6573  dle.launched_res
-00028170: 6f75 7263 6573 2e63 6c6f 7564 2e69 735f  ources.cloud.is_
-00028180: 7361 6d65 5f63 6c6f 7564 2873 6b79 2e47  same_cloud(sky.G
-00028190: 4350 2829 290a 2020 2020 6a6f 625f 6964  CP()).    job_id
-000281a0: 5f65 7865 632c 2068 616e 646c 655f 6578  _exec, handle_ex
-000281b0: 6563 203d 2073 6b79 2e65 7865 6328 7461  ec = sky.exec(ta
-000281c0: 736b 2c20 636c 7573 7465 725f 6e61 6d65  sk, cluster_name
-000281d0: 3d6e 616d 6529 0a20 2020 2061 7373 6572  =name).    asser
-000281e0: 7420 6a6f 625f 6964 5f65 7865 6320 3d3d  t job_id_exec ==
-000281f0: 2032 0a20 2020 2061 7373 6572 7420 6861   2.    assert ha
-00028200: 6e64 6c65 5f65 7865 6320 6973 206e 6f74  ndle_exec is not
-00028210: 204e 6f6e 650a 2020 2020 6173 7365 7274   None.    assert
-00028220: 2068 616e 646c 655f 6578 6563 2e63 6c75   handle_exec.clu
-00028230: 7374 6572 5f6e 616d 6520 3d3d 206e 616d  ster_name == nam
-00028240: 650a 2020 2020 6173 7365 7274 2068 616e  e.    assert han
-00028250: 646c 655f 6578 6563 2e6c 6175 6e63 6865  dle_exec.launche
-00028260: 645f 7265 736f 7572 6365 732e 636c 6f75  d_resources.clou
-00028270: 642e 6973 5f73 616d 655f 636c 6f75 6428  d.is_same_cloud(
-00028280: 736b 792e 4743 5028 2929 0a20 2020 2023  sky.GCP()).    #
-00028290: 2046 6f72 2064 756d 6d79 2074 6173 6b20   For dummy task 
-000282a0: 2869 2e65 2e20 7461 736b 2e72 756e 2069  (i.e. task.run i
-000282b0: 7320 4e6f 6e65 292c 2074 6865 206a 6f62  s None), the job
-000282c0: 2077 6f6e 2774 2062 6520 7375 626d 6974   won't be submit
-000282d0: 7465 642e 0a20 2020 2064 756d 6d79 5f74  ted..    dummy_t
-000282e0: 6173 6b20 3d20 736b 792e 5461 736b 2829  ask = sky.Task()
-000282f0: 0a20 2020 206a 6f62 5f69 645f 6475 6d6d  .    job_id_dumm
-00028300: 792c 205f 203d 2073 6b79 2e65 7865 6328  y, _ = sky.exec(
-00028310: 6475 6d6d 795f 7461 736b 2c20 636c 7573  dummy_task, clus
-00028320: 7465 725f 6e61 6d65 3d6e 616d 6529 0a20  ter_name=name). 
-00028330: 2020 2061 7373 6572 7420 6a6f 625f 6964     assert job_id
-00028340: 5f64 756d 6d79 2069 7320 4e6f 6e65 0a20  _dummy is None. 
-00028350: 2020 2073 6b79 2e64 6f77 6e28 6e61 6d65     sky.down(name
-00028360: 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d  )...# ----------
-00028370: 2054 6573 7469 6e67 2053 746f 7261 6765   Testing Storage
-00028380: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 636c 6173   ----------.clas
-00028390: 7320 5465 7374 5374 6f72 6167 6557 6974  s TestStorageWit
-000283a0: 6843 7265 6465 6e74 6961 6c73 3a0a 2020  hCredentials:.  
-000283b0: 2020 2222 2253 746f 7261 6765 2074 6573    """Storage tes
-000283c0: 7473 2077 6869 6368 2072 6571 7569 7265  ts which require
-000283d0: 2063 7265 6465 6e74 6961 6c73 2061 6e64   credentials and
-000283e0: 206e 6574 776f 726b 2063 6f6e 6e65 6374   network connect
-000283f0: 696f 6e22 2222 0a0a 2020 2020 4157 535f  ion"""..    AWS_
-00028400: 494e 5641 4c49 445f 4e41 4d45 5320 3d20  INVALID_NAMES = 
-00028410: 5b0a 2020 2020 2020 2020 2761 6227 2c20  [.        'ab', 
-00028420: 2023 206c 6573 7320 7468 616e 2033 2063   # less than 3 c
-00028430: 6861 7261 6374 6572 730a 2020 2020 2020  haracters.      
-00028440: 2020 2761 6263 6465 6667 6869 6a6b 6c6d    'abcdefghijklm
-00028450: 6e6f 7071 7273 7475 7677 7879 7a61 6263  nopqrstuvwxyzabc
-00028460: 6465 6667 6869 6a6b 6c6d 6e6f 7071 7273  defghijklmnopqrs
-00028470: 7475 7677 7879 7a61 6263 6465 6667 6869  tuvwxyzabcdefghi
-00028480: 6a6b 6c6d 6e6f 7071 7273 7475 7677 7879  jklmnopqrstuvwxy
-00028490: 7a31 272c 0a20 2020 2020 2020 2023 206d  z1',.        # m
-000284a0: 6f72 6520 7468 616e 2036 3320 6368 6172  ore than 63 char
-000284b0: 6163 7465 7273 0a20 2020 2020 2020 2027  acters.        '
-000284c0: 4162 6364 6566 272c 2020 2320 636f 6e74  Abcdef',  # cont
-000284d0: 6169 6e73 2061 6e20 7570 7065 7263 6173  ains an uppercas
-000284e0: 6520 6c65 7474 6572 0a20 2020 2020 2020  e letter.       
-000284f0: 2027 6162 6320 6465 6627 2c20 2023 2063   'abc def',  # c
-00028500: 6f6e 7461 696e 7320 6120 7370 6163 650a  ontains a space.
-00028510: 2020 2020 2020 2020 2761 6263 2e2e 6465          'abc..de
-00028520: 6627 2c20 2023 2074 776f 2061 646a 6163  f',  # two adjac
-00028530: 656e 7420 7065 7269 6f64 730a 2020 2020  ent periods.    
-00028540: 2020 2020 2731 3932 2e31 3638 2e35 2e34      '192.168.5.4
-00028550: 272c 2020 2320 666f 726d 6174 7465 6420  ',  # formatted 
-00028560: 6173 2061 6e20 4950 2061 6464 7265 7373  as an IP address
-00028570: 0a20 2020 2020 2020 2027 786e 2d2d 6275  .        'xn--bu
-00028580: 636b 6574 272c 2020 2320 7374 6172 7473  cket',  # starts
-00028590: 2077 6974 6820 2778 6e2d 2d27 2070 7265   with 'xn--' pre
-000285a0: 6669 780a 2020 2020 2020 2020 2762 7563  fix.        'buc
-000285b0: 6b65 742d 7333 616c 6961 7327 2c20 2023  ket-s3alias',  #
-000285c0: 2065 6e64 7320 7769 7468 2027 2d73 3361   ends with '-s3a
-000285d0: 6c69 6173 2720 7375 6666 6978 0a20 2020  lias' suffix.   
-000285e0: 2020 2020 2027 6275 636b 6574 2d2d 6f6c       'bucket--ol
-000285f0: 2d73 3327 2c20 2023 2065 6e64 7320 7769  -s3',  # ends wi
-00028600: 7468 2027 2d2d 6f6c 2d73 3327 2073 7566  th '--ol-s3' suf
-00028610: 6669 780a 2020 2020 2020 2020 272e 6162  fix.        '.ab
-00028620: 6327 2c20 2023 2073 7461 7274 7320 7769  c',  # starts wi
-00028630: 7468 2061 2064 6f74 0a20 2020 2020 2020  th a dot.       
-00028640: 2027 6162 632e 272c 2020 2320 656e 6473   'abc.',  # ends
-00028650: 2077 6974 6820 6120 646f 740a 2020 2020   with a dot.    
-00028660: 2020 2020 272d 6162 6327 2c20 2023 2073      '-abc',  # s
-00028670: 7461 7274 7320 7769 7468 2061 2068 7970  tarts with a hyp
-00028680: 6865 6e0a 2020 2020 2020 2020 2761 6263  hen.        'abc
-00028690: 2d27 2c20 2023 2065 6e64 7320 7769 7468  -',  # ends with
-000286a0: 2061 2068 7970 6865 6e0a 2020 2020 5d0a   a hyphen.    ].
-000286b0: 0a20 2020 2047 4353 5f49 4e56 414c 4944  .    GCS_INVALID
-000286c0: 5f4e 414d 4553 203d 205b 0a20 2020 2020  _NAMES = [.     
-000286d0: 2020 2027 6162 272c 2020 2320 6c65 7373     'ab',  # less
-000286e0: 2074 6861 6e20 3320 6368 6172 6163 7465   than 3 characte
-000286f0: 7273 0a20 2020 2020 2020 2027 6162 6364  rs.        'abcd
-00028700: 6566 6768 696a 6b6c 6d6e 6f70 7172 7374  efghijklmnopqrst
-00028710: 7576 7778 797a 6162 6364 6566 6768 696a  uvwxyzabcdefghij
-00028720: 6b6c 6d6e 6f70 7172 7374 7576 7778 797a  klmnopqrstuvwxyz
-00028730: 6162 6364 6566 6768 696a 6b6c 6d6e 6f70  abcdefghijklmnop
-00028740: 7172 7374 7576 7778 797a 3127 2c0a 2020  qrstuvwxyz1',.  
-00028750: 2020 2020 2020 2320 6d6f 7265 2074 6861        # more tha
-00028760: 6e20 3633 2063 6861 7261 6374 6572 7320  n 63 characters 
-00028770: 2877 6974 686f 7574 2064 6f74 7329 0a20  (without dots). 
-00028780: 2020 2020 2020 2027 4162 6364 6566 272c         'Abcdef',
-00028790: 2020 2320 636f 6e74 6169 6e73 2061 6e20    # contains an 
-000287a0: 7570 7065 7263 6173 6520 6c65 7474 6572  uppercase letter
-000287b0: 0a20 2020 2020 2020 2027 6162 6320 6465  .        'abc de
-000287c0: 6627 2c20 2023 2063 6f6e 7461 696e 7320  f',  # contains 
-000287d0: 6120 7370 6163 650a 2020 2020 2020 2020  a space.        
-000287e0: 2761 6263 2e2e 6465 6627 2c20 2023 2074  'abc..def',  # t
-000287f0: 776f 2061 646a 6163 656e 7420 7065 7269  wo adjacent peri
-00028800: 6f64 730a 2020 2020 2020 2020 2761 6263  ods.        'abc
-00028810: 5f2e 6465 662e 6768 692e 6a6b 6c6d 6e6f  _.def.ghi.jklmno
-00028820: 7071 7273 7475 7677 7879 7a61 6263 6465  pqrstuvwxyzabcde
-00028830: 6667 6869 6a6b 6c6d 6e6f 7071 7273 7475  fghijklmnopqrstu
-00028840: 7677 7879 7a61 6263 6465 6667 6869 6a6b  vwxyzabcdefghijk
-00028850: 6c6d 6e6f 7071 7273 7475 7677 7879 7a31  lmnopqrstuvwxyz1
-00028860: 270a 2020 2020 2020 2020 2320 4d6f 7265  '.        # More
-00028870: 2074 6861 6e20 3633 2063 6861 7261 6374   than 63 charact
-00028880: 6572 7320 6265 7477 6565 6e20 646f 7473  ers between dots
-00028890: 0a20 2020 2020 2020 2027 6162 635f 2e64  .        'abc_.d
-000288a0: 6566 2e67 6869 2e6a 6b6c 6d6e 6f70 7172  ef.ghi.jklmnopqr
-000288b0: 7374 7576 7778 797a 6162 6364 6566 6768  stuvwxyzabcdefgh
-000288c0: 696a 6b6c 6d6e 6f70 7166 6768 696a 6b6c  ijklmnopqfghijkl
-000288d0: 6d6e 6f70 7172 7374 7576 7727 202a 2035  mnopqrstuvw' * 5
-000288e0: 2c0a 2020 2020 2020 2020 2320 6d6f 7265  ,.        # more
-000288f0: 2074 6861 6e20 3232 3220 6368 6172 6163   than 222 charac
-00028900: 7465 7273 2028 7769 7468 2064 6f74 7329  ters (with dots)
-00028910: 0a20 2020 2020 2020 2027 3139 322e 3136  .        '192.16
-00028920: 382e 352e 3427 2c20 2023 2066 6f72 6d61  8.5.4',  # forma
-00028930: 7474 6564 2061 7320 616e 2049 5020 6164  tted as an IP ad
-00028940: 6472 6573 730a 2020 2020 2020 2020 2767  dress.        'g
-00028950: 6f6f 6762 7563 6b65 7427 2c20 2023 2073  oogbucket',  # s
-00028960: 7461 7274 7320 7769 7468 2027 676f 6f67  tarts with 'goog
-00028970: 2720 7072 6566 6978 0a20 2020 2020 2020  ' prefix.       
-00028980: 2027 676f 6f67 6c65 6275 636b 6574 272c   'googlebucket',
-00028990: 2020 2320 636f 6e74 6169 6e73 2027 676f    # contains 'go
-000289a0: 6f67 6c65 270a 2020 2020 2020 2020 2767  ogle'.        'g
-000289b0: 3030 676c 6562 7563 6b65 7427 2c20 2023  00glebucket',  #
-000289c0: 2076 6172 6961 6e74 206f 6620 2767 6f6f   variant of 'goo
-000289d0: 676c 6527 0a20 2020 2020 2020 2027 676f  gle'.        'go
-000289e0: 3067 6c65 6275 636b 6574 272c 2020 2320  0glebucket',  # 
-000289f0: 7661 7269 616e 7420 6f66 2027 676f 6f67  variant of 'goog
-00028a00: 6c65 270a 2020 2020 2020 2020 2767 306f  le'.        'g0o
-00028a10: 676c 6562 7563 6b65 7427 2c20 2023 2076  glebucket',  # v
-00028a20: 6172 6961 6e74 206f 6620 2767 6f6f 676c  ariant of 'googl
-00028a30: 6527 0a20 2020 2020 2020 2027 2e61 6263  e'.        '.abc
-00028a40: 272c 2020 2320 7374 6172 7473 2077 6974  ',  # starts wit
-00028a50: 6820 6120 646f 740a 2020 2020 2020 2020  h a dot.        
-00028a60: 2761 6263 2e27 2c20 2023 2065 6e64 7320  'abc.',  # ends 
-00028a70: 7769 7468 2061 2064 6f74 0a20 2020 2020  with a dot.     
-00028a80: 2020 2027 5f61 6263 272c 2020 2320 7374     '_abc',  # st
-00028a90: 6172 7473 2077 6974 6820 616e 2075 6e64  arts with an und
-00028aa0: 6572 7363 6f72 650a 2020 2020 2020 2020  erscore.        
-00028ab0: 2761 6263 5f27 2c20 2023 2065 6e64 7320  'abc_',  # ends 
-00028ac0: 7769 7468 2061 6e20 756e 6465 7273 636f  with an undersco
-00028ad0: 7265 0a20 2020 205d 0a0a 2020 2020 4942  re.    ]..    IB
-00028ae0: 4d5f 494e 5641 4c49 445f 4e41 4d45 5320  M_INVALID_NAMES 
-00028af0: 3d20 5b0a 2020 2020 2020 2020 2761 6227  = [.        'ab'
-00028b00: 2c20 2023 206c 6573 7320 7468 616e 2033  ,  # less than 3
-00028b10: 2063 6861 7261 6374 6572 730a 2020 2020   characters.    
-00028b20: 2020 2020 2761 6263 6465 6667 6869 6a6b      'abcdefghijk
-00028b30: 6c6d 6e6f 7071 7273 7475 7677 7879 7a61  lmnopqrstuvwxyza
-00028b40: 6263 6465 6667 6869 6a6b 6c6d 6e6f 7071  bcdefghijklmnopq
-00028b50: 7273 7475 7677 7879 7a61 6263 6465 6667  rstuvwxyzabcdefg
-00028b60: 6869 6a6b 6c6d 6e6f 7071 7273 7475 7677  hijklmnopqrstuvw
-00028b70: 7879 7a31 272c 0a20 2020 2020 2020 2023  xyz1',.        #
-00028b80: 206d 6f72 6520 7468 616e 2036 3320 6368   more than 63 ch
-00028b90: 6172 6163 7465 7273 0a20 2020 2020 2020  aracters.       
-00028ba0: 2027 4162 6364 6566 272c 2020 2320 636f   'Abcdef',  # co
-00028bb0: 6e74 6169 6e73 2061 6e20 7570 7065 7263  ntains an upperc
-00028bc0: 6173 6520 6c65 7474 6572 0a20 2020 2020  ase letter.     
-00028bd0: 2020 2027 6162 6320 6465 6627 2c20 2023     'abc def',  #
-00028be0: 2063 6f6e 7461 696e 7320 6120 7370 6163   contains a spac
-00028bf0: 650a 2020 2020 2020 2020 2761 6263 2e2e  e.        'abc..
-00028c00: 6465 6627 2c20 2023 2074 776f 2061 646a  def',  # two adj
-00028c10: 6163 656e 7420 7065 7269 6f64 730a 2020  acent periods.  
-00028c20: 2020 2020 2020 2731 3932 2e31 3638 2e35        '192.168.5
-00028c30: 2e34 272c 2020 2320 666f 726d 6174 7465  .4',  # formatte
-00028c40: 6420 6173 2061 6e20 4950 2061 6464 7265  d as an IP addre
-00028c50: 7373 0a20 2020 2020 2020 2027 786e 2d2d  ss.        'xn--
-00028c60: 6275 636b 6574 272c 2020 2320 7374 6172  bucket',  # star
-00028c70: 7473 2077 6974 6820 2778 6e2d 2d27 2070  ts with 'xn--' p
-00028c80: 7265 6669 780a 2020 2020 2020 2020 272e  refix.        '.
-00028c90: 6162 6327 2c20 2023 2073 7461 7274 7320  abc',  # starts 
-00028ca0: 7769 7468 2061 2064 6f74 0a20 2020 2020  with a dot.     
-00028cb0: 2020 2027 6162 632e 272c 2020 2320 656e     'abc.',  # en
-00028cc0: 6473 2077 6974 6820 6120 646f 740a 2020  ds with a dot.  
-00028cd0: 2020 2020 2020 272d 6162 6327 2c20 2023        '-abc',  #
-00028ce0: 2073 7461 7274 7320 7769 7468 2061 2068   starts with a h
-00028cf0: 7970 6865 6e0a 2020 2020 2020 2020 2761  yphen.        'a
-00028d00: 6263 2d27 2c20 2023 2065 6e64 7320 7769  bc-',  # ends wi
-00028d10: 7468 2061 2068 7970 6865 6e0a 2020 2020  th a hyphen.    
-00028d20: 2020 2020 2761 2e2d 6263 272c 2020 2320      'a.-bc',  # 
-00028d30: 636f 6e74 6169 6e73 2074 6865 2073 6571  contains the seq
-00028d40: 7565 6e63 6520 272e 2d27 0a20 2020 2020  uence '.-'.     
-00028d50: 2020 2027 612d 2e62 6327 2c20 2023 2063     'a-.bc',  # c
-00028d60: 6f6e 7461 696e 7320 7468 6520 7365 7175  ontains the sequ
-00028d70: 656e 6365 2027 2d2e 270a 2020 2020 2020  ence '-.'.      
-00028d80: 2020 2761 2662 6327 2020 2320 636f 6e74    'a&bc'  # cont
-00028d90: 6169 6e73 2073 7065 6369 616c 2063 6861  ains special cha
-00028da0: 7261 6374 6572 730a 2020 2020 2020 2020  racters.        
-00028db0: 2761 625e 6327 2020 2320 636f 6e74 6169  'ab^c'  # contai
-00028dc0: 6e73 2073 7065 6369 616c 2063 6861 7261  ns special chara
-00028dd0: 6374 6572 730a 2020 2020 5d0a 2020 2020  cters.    ].    
-00028de0: 4749 5449 474e 4f52 455f 5359 4e43 5f54  GITIGNORE_SYNC_T
-00028df0: 4553 545f 4449 525f 5354 5255 4354 5552  EST_DIR_STRUCTUR
-00028e00: 4520 3d20 7b0a 2020 2020 2020 2020 2764  E = {.        'd
-00028e10: 6f75 626c 655f 6173 7465 7269 736b 273a  ouble_asterisk':
-00028e20: 207b 0a20 2020 2020 2020 2020 2020 2027   {.            '
-00028e30: 646f 7562 6c65 5f61 7374 6572 6973 6b5f  double_asterisk_
-00028e40: 6578 636c 7564 6564 273a 204e 6f6e 652c  excluded': None,
-00028e50: 0a20 2020 2020 2020 2020 2020 2027 646f  .            'do
-00028e60: 7562 6c65 5f61 7374 6572 6973 6b5f 6578  uble_asterisk_ex
-00028e70: 636c 7564 6564 5f64 6972 273a 207b 0a20  cluded_dir': {. 
-00028e80: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-00028e90: 6469 725f 6578 636c 7564 6564 273a 204e  dir_excluded': N
-00028ea0: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
-00028eb0: 207d 2c0a 2020 2020 2020 2020 7d2c 0a20   },.        },. 
-00028ec0: 2020 2020 2020 2027 646f 7562 6c65 5f61         'double_a
-00028ed0: 7374 6572 6973 6b5f 7061 7265 6e74 273a  sterisk_parent':
-00028ee0: 207b 0a20 2020 2020 2020 2020 2020 2027   {.            '
-00028ef0: 7061 7265 6e74 273a 207b 0a20 2020 2020  parent': {.     
-00028f00: 2020 2020 2020 2020 2020 2027 616c 736f             'also
-00028f10: 5f65 7863 6c75 6465 642e 7478 7427 3a20  _excluded.txt': 
-00028f20: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
-00028f30: 2020 2020 2020 2763 6869 6c64 273a 207b        'child': {
-00028f40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00028f50: 2020 2020 2027 646f 7562 6c65 5f61 7374       'double_ast
-00028f60: 6572 6973 6b5f 7061 7265 6e74 5f63 6869  erisk_parent_chi
-00028f70: 6c64 5f65 7863 6c75 6465 642e 7478 7427  ld_excluded.txt'
-00028f80: 3a20 4e6f 6e65 2c0a 2020 2020 2020 2020  : None,.        
-00028f90: 2020 2020 2020 2020 7d2c 0a20 2020 2020          },.     
-00028fa0: 2020 2020 2020 2020 2020 2027 646f 7562             'doub
-00028fb0: 6c65 5f61 7374 6572 6973 6b5f 7061 7265  le_asterisk_pare
-00028fc0: 6e74 5f65 7863 6c75 6465 642e 7478 7427  nt_excluded.txt'
-00028fd0: 3a20 4e6f 6e65 2c0a 2020 2020 2020 2020  : None,.        
-00028fe0: 2020 2020 7d2c 0a20 2020 2020 2020 207d      },.        }
-00028ff0: 2c0a 2020 2020 2020 2020 2765 7863 6c75  ,.        'exclu
-00029000: 6465 642e 6c6f 6727 3a20 4e6f 6e65 2c0a  ded.log': None,.
-00029010: 2020 2020 2020 2020 2765 7863 6c75 6465          'exclude
-00029020: 645f 6469 7227 3a20 7b0a 2020 2020 2020  d_dir': {.      
-00029030: 2020 2020 2020 2765 7863 6c75 6465 642e        'excluded.
-00029040: 7478 7427 3a20 4e6f 6e65 2c0a 2020 2020  txt': None,.    
-00029050: 2020 2020 2020 2020 276e 6573 7465 645f          'nested_
-00029060: 6578 636c 7564 6564 273a 207b 0a20 2020  excluded': {.   
-00029070: 2020 2020 2020 2020 2020 2020 2027 6578               'ex
-00029080: 636c 7564 6564 273a 204e 6f6e 652c 0a20  cluded': None,. 
-00029090: 2020 2020 2020 2020 2020 207d 2c0a 2020             },.  
-000290a0: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
-000290b0: 2027 6578 702d 3127 3a20 7b0a 2020 2020   'exp-1': {.    
-000290c0: 2020 2020 2020 2020 2762 655f 6578 636c          'be_excl
-000290d0: 7564 6564 273a 204e 6f6e 652c 0a20 2020  uded': None,.   
-000290e0: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
-000290f0: 2765 7870 2d32 273a 207b 0a20 2020 2020  'exp-2': {.     
-00029100: 2020 2020 2020 2027 6265 5f65 7863 6c75         'be_exclu
-00029110: 6465 6427 3a20 4e6f 6e65 2c0a 2020 2020  ded': None,.    
-00029120: 2020 2020 7d2c 0a20 2020 2020 2020 2027      },.        '
-00029130: 6672 6f6e 745f 736c 6173 685f 6578 636c  front_slash_excl
-00029140: 7564 6564 273a 204e 6f6e 652c 0a20 2020  uded': None,.   
-00029150: 2020 2020 2027 696e 636c 7564 6564 2e6c       'included.l
-00029160: 6f67 273a 204e 6f6e 652c 0a20 2020 2020  og': None,.     
-00029170: 2020 2027 696e 636c 7564 6564 2e74 7874     'included.txt
-00029180: 273a 204e 6f6e 652c 0a20 2020 2020 2020  ': None,.       
-00029190: 2027 696e 636c 7564 655f 6469 7227 3a20   'include_dir': 
-000291a0: 7b0a 2020 2020 2020 2020 2020 2020 2765  {.            'e
-000291b0: 7863 6c75 6465 642e 6c6f 6727 3a20 4e6f  xcluded.log': No
-000291c0: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
-000291d0: 2769 6e63 6c75 6465 642e 6c6f 6727 3a20  'included.log': 
-000291e0: 4e6f 6e65 2c0a 2020 2020 2020 2020 7d2c  None,.        },
-000291f0: 0a20 2020 2020 2020 2027 6e65 7374 6564  .        'nested
-00029200: 5f64 6f75 626c 655f 6173 7465 7269 736b  _double_asterisk
-00029210: 273a 207b 0a20 2020 2020 2020 2020 2020  ': {.           
-00029220: 2027 6f6e 6527 3a20 7b0a 2020 2020 2020   'one': {.      
-00029230: 2020 2020 2020 2020 2020 2761 6c73 6f5f            'also_
-00029240: 6578 636c 7564 652e 7478 7427 3a20 4e6f  exclude.txt': No
-00029250: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
-00029260: 7d2c 0a20 2020 2020 2020 2020 2020 2027  },.            '
-00029270: 7477 6f27 3a20 7b0a 2020 2020 2020 2020  two': {.        
-00029280: 2020 2020 2020 2020 2761 6c73 6f5f 6578          'also_ex
-00029290: 636c 7564 652e 7478 7427 3a20 4e6f 6e65  clude.txt': None
-000292a0: 2c0a 2020 2020 2020 2020 2020 2020 7d2c  ,.            },
-000292b0: 0a20 2020 2020 2020 207d 2c0a 2020 2020  .        },.    
-000292c0: 2020 2020 276e 6573 7465 645f 7769 6c64      'nested_wild
-000292d0: 6361 7264 5f64 6972 273a 207b 0a20 2020  card_dir': {.   
-000292e0: 2020 2020 2020 2020 2027 6d6f 6e64 6179           'monday
-000292f0: 273a 207b 0a20 2020 2020 2020 2020 2020  ': {.           
-00029300: 2020 2020 2027 616c 736f 5f65 7863 6c75       'also_exclu
-00029310: 6465 2e74 7874 273a 204e 6f6e 652c 0a20  de.txt': None,. 
-00029320: 2020 2020 2020 2020 2020 207d 2c0a 2020             },.  
-00029330: 2020 2020 2020 2020 2020 2774 7565 7364            'tuesd
-00029340: 6179 273a 207b 0a20 2020 2020 2020 2020  ay': {.         
-00029350: 2020 2020 2020 2027 616c 736f 5f65 7863         'also_exc
-00029360: 6c75 6465 2e74 7874 273a 204e 6f6e 652c  lude.txt': None,
-00029370: 0a20 2020 2020 2020 2020 2020 207d 2c0a  .            },.
-00029380: 2020 2020 2020 2020 7d2c 0a20 2020 2020          },.     
-00029390: 2020 2027 6e6f 5f73 6c61 7368 5f65 7863     'no_slash_exc
-000293a0: 6c75 6465 6427 3a20 4e6f 6e65 2c0a 2020  luded': None,.  
-000293b0: 2020 2020 2020 276e 6f5f 736c 6173 685f        'no_slash_
-000293c0: 7465 7374 7327 3a20 7b0a 2020 2020 2020  tests': {.      
-000293d0: 2020 2020 2020 276e 6f5f 736c 6173 685f        'no_slash_
-000293e0: 6578 636c 7564 6564 273a 207b 0a20 2020  excluded': {.   
-000293f0: 2020 2020 2020 2020 2020 2020 2027 616c               'al
-00029400: 736f 5f65 7863 6c75 6465 642e 7478 7427  so_excluded.txt'
-00029410: 3a20 4e6f 6e65 2c0a 2020 2020 2020 2020  : None,.        
-00029420: 2020 2020 7d2c 0a20 2020 2020 2020 207d      },.        }
-00029430: 2c0a 2020 2020 2020 2020 2771 7565 7374  ,.        'quest
-00029440: 696f 6e5f 6d61 726b 273a 207b 0a20 2020  ion_mark': {.   
-00029450: 2020 2020 2020 2020 2027 6578 636c 7564           'exclud
-00029460: 6564 312e 7478 7427 3a20 4e6f 6e65 2c0a  ed1.txt': None,.
-00029470: 2020 2020 2020 2020 2020 2020 2765 7863              'exc
-00029480: 6c75 6465 6440 2e74 7874 273a 204e 6f6e  luded@.txt': Non
-00029490: 652c 0a20 2020 2020 2020 207d 2c0a 2020  e,.        },.  
-000294a0: 2020 2020 2020 2773 7175 6172 655f 6272        'square_br
-000294b0: 6163 6b65 7427 3a20 7b0a 2020 2020 2020  acket': {.      
-000294c0: 2020 2020 2020 2765 7863 6c75 6465 6431        'excluded1
-000294d0: 2e74 7874 273a 204e 6f6e 652c 0a20 2020  .txt': None,.   
-000294e0: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
-000294f0: 2773 7175 6172 655f 6272 6163 6b65 745f  'square_bracket_
-00029500: 616c 7068 6127 3a20 7b0a 2020 2020 2020  alpha': {.      
-00029510: 2020 2020 2020 2765 7863 6c75 6465 647a        'excludedz
-00029520: 2e74 7874 273a 204e 6f6e 652c 0a20 2020  .txt': None,.   
-00029530: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
-00029540: 2773 7175 6172 655f 6272 6163 6b65 745f  'square_bracket_
-00029550: 6578 636c 6127 3a20 7b0a 2020 2020 2020  excla': {.      
-00029560: 2020 2020 2020 2765 7863 6c75 6465 6432        'excluded2
-00029570: 2e74 7874 273a 204e 6f6e 652c 0a20 2020  .txt': None,.   
-00029580: 2020 2020 2020 2020 2027 6578 636c 7564           'exclud
-00029590: 6564 402e 7478 7427 3a20 4e6f 6e65 2c0a  ed@.txt': None,.
-000295a0: 2020 2020 2020 2020 7d2c 0a20 2020 2020          },.     
-000295b0: 2020 2027 7371 7561 7265 5f62 7261 636b     'square_brack
-000295c0: 6574 5f73 696e 676c 6527 3a20 7b0a 2020  et_single': {.  
-000295d0: 2020 2020 2020 2020 2020 2765 7863 6c75            'exclu
-000295e0: 6465 6430 2e74 7874 273a 204e 6f6e 652c  ded0.txt': None,
-000295f0: 0a20 2020 2020 2020 207d 2c0a 2020 2020  .        },.    
-00029600: 7d0a 0a20 2020 2040 7374 6174 6963 6d65  }..    @staticme
-00029610: 7468 6f64 0a20 2020 2064 6566 2063 7265  thod.    def cre
-00029620: 6174 655f 6469 725f 7374 7275 6374 7572  ate_dir_structur
-00029630: 6528 6261 7365 5f70 6174 682c 2073 7472  e(base_path, str
-00029640: 7563 7475 7265 293a 0a20 2020 2020 2020  ucture):.       
-00029650: 2023 2063 7265 6174 6573 2061 2067 6976   # creates a giv
-00029660: 656e 2066 696c 6520 5354 5255 4354 5552  en file STRUCTUR
-00029670: 4520 696e 2042 4153 455f 5041 5448 0a20  E in BASE_PATH. 
-00029680: 2020 2020 2020 2066 6f72 206e 616d 652c         for name,
-00029690: 2073 7562 7374 7275 6374 7572 6520 696e   substructure in
-000296a0: 2073 7472 7563 7475 7265 2e69 7465 6d73   structure.items
-000296b0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-000296c0: 7061 7468 203d 206f 732e 7061 7468 2e6a  path = os.path.j
-000296d0: 6f69 6e28 6261 7365 5f70 6174 682c 206e  oin(base_path, n
-000296e0: 616d 6529 0a20 2020 2020 2020 2020 2020  ame).           
-000296f0: 2069 6620 7375 6273 7472 7563 7475 7265   if substructure
-00029700: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-00029710: 2020 2020 2020 2020 2020 2320 4372 6561            # Crea
-00029720: 7465 2061 2066 696c 650a 2020 2020 2020  te a file.      
-00029730: 2020 2020 2020 2020 2020 6f70 656e 2870            open(p
-00029740: 6174 682c 2027 6127 2c20 656e 636f 6469  ath, 'a', encodi
-00029750: 6e67 3d27 7574 662d 3827 292e 636c 6f73  ng='utf-8').clos
-00029760: 6528 290a 2020 2020 2020 2020 2020 2020  e().            
-00029770: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00029780: 2020 2020 2020 2320 4372 6561 7465 2061        # Create a
-00029790: 2073 7562 6469 7265 6374 6f72 790a 2020   subdirectory.  
-000297a0: 2020 2020 2020 2020 2020 2020 2020 6f73                os
-000297b0: 2e6d 6b64 6972 2870 6174 6829 0a20 2020  .mkdir(path).   
-000297c0: 2020 2020 2020 2020 2020 2020 2054 6573               Tes
-000297d0: 7453 746f 7261 6765 5769 7468 4372 6564  tStorageWithCred
-000297e0: 656e 7469 616c 732e 6372 6561 7465 5f64  entials.create_d
-000297f0: 6972 5f73 7472 7563 7475 7265 280a 2020  ir_structure(.  
-00029800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029810: 2020 7061 7468 2c20 7375 6273 7472 7563    path, substruc
-00029820: 7475 7265 290a 0a20 2020 2040 7374 6174  ture)..    @stat
-00029830: 6963 6d65 7468 6f64 0a20 2020 2064 6566  icmethod.    def
-00029840: 2063 6c69 5f64 656c 6574 655f 636d 6428   cli_delete_cmd(
-00029850: 7374 6f72 655f 7479 7065 2c20 6275 636b  store_type, buck
-00029860: 6574 5f6e 616d 6529 3a0a 2020 2020 2020  et_name):.      
-00029870: 2020 6966 2073 746f 7265 5f74 7970 6520    if store_type 
-00029880: 3d3d 2073 746f 7261 6765 5f6c 6962 2e53  == storage_lib.S
-00029890: 746f 7265 5479 7065 2e53 333a 0a20 2020  toreType.S3:.   
-000298a0: 2020 2020 2020 2020 2075 726c 203d 2066           url = f
-000298b0: 2773 333a 2f2f 7b62 7563 6b65 745f 6e61  's3://{bucket_na
-000298c0: 6d65 7d27 0a20 2020 2020 2020 2020 2020  me}'.           
-000298d0: 2072 6574 7572 6e20 6627 6177 7320 7333   return f'aws s3
-000298e0: 2072 6220 7b75 726c 7d20 2d2d 666f 7263   rb {url} --forc
-000298f0: 6527 0a20 2020 2020 2020 2069 6620 7374  e'.        if st
-00029900: 6f72 655f 7479 7065 203d 3d20 7374 6f72  ore_type == stor
-00029910: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
-00029920: 652e 4743 533a 0a20 2020 2020 2020 2020  e.GCS:.         
-00029930: 2020 2075 726c 203d 2066 2767 733a 2f2f     url = f'gs://
-00029940: 7b62 7563 6b65 745f 6e61 6d65 7d27 0a20  {bucket_name}'. 
-00029950: 2020 2020 2020 2020 2020 2067 7375 7469             gsuti
-00029960: 6c5f 616c 6961 732c 2061 6c69 6173 5f67  l_alias, alias_g
-00029970: 656e 203d 2064 6174 615f 7574 696c 732e  en = data_utils.
-00029980: 6765 745f 6773 7574 696c 5f63 6f6d 6d61  get_gsutil_comma
-00029990: 6e64 2829 0a20 2020 2020 2020 2020 2020  nd().           
-000299a0: 2072 6574 7572 6e20 6627 7b61 6c69 6173   return f'{alias
-000299b0: 5f67 656e 7d3b 207b 6773 7574 696c 5f61  _gen}; {gsutil_a
-000299c0: 6c69 6173 7d20 726d 202d 7220 7b75 726c  lias} rm -r {url
-000299d0: 7d27 0a20 2020 2020 2020 2069 6620 7374  }'.        if st
-000299e0: 6f72 655f 7479 7065 203d 3d20 7374 6f72  ore_type == stor
-000299f0: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
-00029a00: 652e 5232 3a0a 2020 2020 2020 2020 2020  e.R2:.          
-00029a10: 2020 656e 6470 6f69 6e74 5f75 726c 203d    endpoint_url =
-00029a20: 2063 6c6f 7564 666c 6172 652e 6372 6561   cloudflare.crea
-00029a30: 7465 5f65 6e64 706f 696e 7428 290a 2020  te_endpoint().  
-00029a40: 2020 2020 2020 2020 2020 7572 6c20 3d20            url = 
-00029a50: 6627 7333 3a2f 2f7b 6275 636b 6574 5f6e  f's3://{bucket_n
-00029a60: 616d 657d 270a 2020 2020 2020 2020 2020  ame}'.          
-00029a70: 2020 7265 7475 726e 2066 2741 5753 5f53    return f'AWS_S
-00029a80: 4841 5245 445f 4352 4544 454e 5449 414c  HARED_CREDENTIAL
-00029a90: 535f 4649 4c45 3d7b 636c 6f75 6466 6c61  S_FILE={cloudfla
-00029aa0: 7265 2e52 325f 4352 4544 454e 5449 414c  re.R2_CREDENTIAL
-00029ab0: 535f 5041 5448 7d20 6177 7320 7333 2072  S_PATH} aws s3 r
-00029ac0: 6220 7b75 726c 7d20 2d2d 666f 7263 6520  b {url} --force 
-00029ad0: 2d2d 656e 6470 6f69 6e74 207b 656e 6470  --endpoint {endp
-00029ae0: 6f69 6e74 5f75 726c 7d20 2d2d 7072 6f66  oint_url} --prof
-00029af0: 696c 653d 7232 270a 2020 2020 2020 2020  ile=r2'.        
-00029b00: 6966 2073 746f 7265 5f74 7970 6520 3d3d  if store_type ==
-00029b10: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
-00029b20: 7265 5479 7065 2e49 424d 3a0a 2020 2020  reType.IBM:.    
-00029b30: 2020 2020 2020 2020 6275 636b 6574 5f72          bucket_r
-00029b40: 636c 6f6e 655f 7072 6f66 696c 6520 3d20  clone_profile = 
-00029b50: 5263 6c6f 6e65 2e67 656e 6572 6174 655f  Rclone.generate_
-00029b60: 7263 6c6f 6e65 5f62 7563 6b65 745f 7072  rclone_bucket_pr
-00029b70: 6f66 696c 655f 6e61 6d65 280a 2020 2020  ofile_name(.    
-00029b80: 2020 2020 2020 2020 2020 2020 6275 636b              buck
-00029b90: 6574 5f6e 616d 652c 2052 636c 6f6e 652e  et_name, Rclone.
-00029ba0: 5263 6c6f 6e65 436c 6f75 6473 2e49 424d  RcloneClouds.IBM
-00029bb0: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
-00029bc0: 7475 726e 2066 2772 636c 6f6e 6520 7075  turn f'rclone pu
-00029bd0: 7267 6520 7b62 7563 6b65 745f 7263 6c6f  rge {bucket_rclo
-00029be0: 6e65 5f70 726f 6669 6c65 7d3a 7b62 7563  ne_profile}:{buc
-00029bf0: 6b65 745f 6e61 6d65 7d20 2626 2072 636c  ket_name} && rcl
-00029c00: 6f6e 6520 636f 6e66 6967 2064 656c 6574  one config delet
-00029c10: 6520 7b62 7563 6b65 745f 7263 6c6f 6e65  e {bucket_rclone
-00029c20: 5f70 726f 6669 6c65 7d27 0a0a 2020 2020  _profile}'..    
-00029c30: 4073 7461 7469 636d 6574 686f 640a 2020  @staticmethod.  
-00029c40: 2020 6465 6620 636c 695f 6c73 5f63 6d64    def cli_ls_cmd
-00029c50: 2873 746f 7265 5f74 7970 652c 2062 7563  (store_type, buc
-00029c60: 6b65 745f 6e61 6d65 2c20 7375 6666 6978  ket_name, suffix
-00029c70: 3d27 2729 3a0a 2020 2020 2020 2020 6966  =''):.        if
-00029c80: 2073 746f 7265 5f74 7970 6520 3d3d 2073   store_type == s
-00029c90: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
-00029ca0: 5479 7065 2e53 333a 0a20 2020 2020 2020  Type.S3:.       
-00029cb0: 2020 2020 2069 6620 7375 6666 6978 3a0a       if suffix:.
-00029cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029cd0: 7572 6c20 3d20 6627 7333 3a2f 2f7b 6275  url = f's3://{bu
-00029ce0: 636b 6574 5f6e 616d 657d 2f7b 7375 6666  cket_name}/{suff
-00029cf0: 6978 7d27 0a20 2020 2020 2020 2020 2020  ix}'.           
-00029d00: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00029d10: 2020 2020 2020 2075 726c 203d 2066 2773         url = f's
-00029d20: 333a 2f2f 7b62 7563 6b65 745f 6e61 6d65  3://{bucket_name
-00029d30: 7d27 0a20 2020 2020 2020 2020 2020 2072  }'.            r
-00029d40: 6574 7572 6e20 6627 6177 7320 7333 206c  eturn f'aws s3 l
-00029d50: 7320 7b75 726c 7d27 0a20 2020 2020 2020  s {url}'.       
-00029d60: 2069 6620 7374 6f72 655f 7479 7065 203d   if store_type =
-00029d70: 3d20 7374 6f72 6167 655f 6c69 622e 5374  = storage_lib.St
-00029d80: 6f72 6554 7970 652e 4743 533a 0a20 2020  oreType.GCS:.   
-00029d90: 2020 2020 2020 2020 2069 6620 7375 6666           if suff
-00029da0: 6978 3a0a 2020 2020 2020 2020 2020 2020  ix:.            
-00029db0: 2020 2020 7572 6c20 3d20 6627 6773 3a2f      url = f'gs:/
-00029dc0: 2f7b 6275 636b 6574 5f6e 616d 657d 2f7b  /{bucket_name}/{
-00029dd0: 7375 6666 6978 7d27 0a20 2020 2020 2020  suffix}'.       
-00029de0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00029df0: 2020 2020 2020 2020 2020 2075 726c 203d             url =
-00029e00: 2066 2767 733a 2f2f 7b62 7563 6b65 745f   f'gs://{bucket_
-00029e10: 6e61 6d65 7d27 0a20 2020 2020 2020 2020  name}'.         
-00029e20: 2020 2072 6574 7572 6e20 6627 6773 7574     return f'gsut
-00029e30: 696c 206c 7320 7b75 726c 7d27 0a20 2020  il ls {url}'.   
-00029e40: 2020 2020 2069 6620 7374 6f72 655f 7479       if store_ty
-00029e50: 7065 203d 3d20 7374 6f72 6167 655f 6c69  pe == storage_li
-00029e60: 622e 5374 6f72 6554 7970 652e 5232 3a0a  b.StoreType.R2:.
-00029e70: 2020 2020 2020 2020 2020 2020 656e 6470              endp
-00029e80: 6f69 6e74 5f75 726c 203d 2063 6c6f 7564  oint_url = cloud
-00029e90: 666c 6172 652e 6372 6561 7465 5f65 6e64  flare.create_end
-00029ea0: 706f 696e 7428 290a 2020 2020 2020 2020  point().        
-00029eb0: 2020 2020 6966 2073 7566 6669 783a 0a20      if suffix:. 
-00029ec0: 2020 2020 2020 2020 2020 2020 2020 2075                 u
-00029ed0: 726c 203d 2066 2773 333a 2f2f 7b62 7563  rl = f's3://{buc
-00029ee0: 6b65 745f 6e61 6d65 7d2f 7b73 7566 6669  ket_name}/{suffi
-00029ef0: 787d 270a 2020 2020 2020 2020 2020 2020  x}'.            
-00029f00: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00029f10: 2020 2020 2020 7572 6c20 3d20 6627 7333        url = f's3
-00029f20: 3a2f 2f7b 6275 636b 6574 5f6e 616d 657d  ://{bucket_name}
-00029f30: 270a 2020 2020 2020 2020 2020 2020 7265  '.            re
-00029f40: 7475 726e 2066 2741 5753 5f53 4841 5245  turn f'AWS_SHARE
-00029f50: 445f 4352 4544 454e 5449 414c 535f 4649  D_CREDENTIALS_FI
-00029f60: 4c45 3d7b 636c 6f75 6466 6c61 7265 2e52  LE={cloudflare.R
-00029f70: 325f 4352 4544 454e 5449 414c 535f 5041  2_CREDENTIALS_PA
-00029f80: 5448 7d20 6177 7320 7333 206c 7320 7b75  TH} aws s3 ls {u
-00029f90: 726c 7d20 2d2d 656e 6470 6f69 6e74 207b  rl} --endpoint {
-00029fa0: 656e 6470 6f69 6e74 5f75 726c 7d20 2d2d  endpoint_url} --
-00029fb0: 7072 6f66 696c 653d 7232 270a 2020 2020  profile=r2'.    
-00029fc0: 2020 2020 6966 2073 746f 7265 5f74 7970      if store_typ
-00029fd0: 6520 3d3d 2073 746f 7261 6765 5f6c 6962  e == storage_lib
-00029fe0: 2e53 746f 7265 5479 7065 2e49 424d 3a0a  .StoreType.IBM:.
-00029ff0: 2020 2020 2020 2020 2020 2020 6275 636b              buck
-0002a000: 6574 5f72 636c 6f6e 655f 7072 6f66 696c  et_rclone_profil
-0002a010: 6520 3d20 5263 6c6f 6e65 2e67 656e 6572  e = Rclone.gener
-0002a020: 6174 655f 7263 6c6f 6e65 5f62 7563 6b65  ate_rclone_bucke
-0002a030: 745f 7072 6f66 696c 655f 6e61 6d65 280a  t_profile_name(.
-0002a040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a050: 6275 636b 6574 5f6e 616d 652c 2052 636c  bucket_name, Rcl
-0002a060: 6f6e 652e 5263 6c6f 6e65 436c 6f75 6473  one.RcloneClouds
-0002a070: 2e49 424d 290a 2020 2020 2020 2020 2020  .IBM).          
-0002a080: 2020 7265 7475 726e 2066 2772 636c 6f6e    return f'rclon
-0002a090: 6520 6c73 207b 6275 636b 6574 5f72 636c  e ls {bucket_rcl
-0002a0a0: 6f6e 655f 7072 6f66 696c 657d 3a7b 6275  one_profile}:{bu
-0002a0b0: 636b 6574 5f6e 616d 657d 2f7b 7375 6666  cket_name}/{suff
-0002a0c0: 6978 7d27 0a0a 2020 2020 4073 7461 7469  ix}'..    @stati
-0002a0d0: 636d 6574 686f 640a 2020 2020 6465 6620  cmethod.    def 
-0002a0e0: 636c 695f 7265 6769 6f6e 5f63 6d64 2873  cli_region_cmd(s
-0002a0f0: 746f 7265 5f74 7970 652c 2062 7563 6b65  tore_type, bucke
-0002a100: 745f 6e61 6d65 293a 0a20 2020 2020 2020  t_name):.       
-0002a110: 2069 6620 7374 6f72 655f 7479 7065 203d   if store_type =
-0002a120: 3d20 7374 6f72 6167 655f 6c69 622e 5374  = storage_lib.St
-0002a130: 6f72 6554 7970 652e 5333 3a0a 2020 2020  oreType.S3:.    
-0002a140: 2020 2020 2020 2020 7265 7475 726e 2028          return (
-0002a150: 2761 7773 2073 3361 7069 2067 6574 2d62  'aws s3api get-b
-0002a160: 7563 6b65 742d 6c6f 6361 7469 6f6e 2027  ucket-location '
-0002a170: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002a180: 2020 2020 2066 272d 2d62 7563 6b65 7420       f'--bucket 
-0002a190: 7b62 7563 6b65 745f 6e61 6d65 7d20 2d2d  {bucket_name} --
-0002a1a0: 6f75 7470 7574 2074 6578 7427 290a 2020  output text').  
-0002a1b0: 2020 2020 2020 656c 6966 2073 746f 7265        elif store
-0002a1c0: 5f74 7970 6520 3d3d 2073 746f 7261 6765  _type == storage
-0002a1d0: 5f6c 6962 2e53 746f 7265 5479 7065 2e47  _lib.StoreType.G
-0002a1e0: 4353 3a0a 2020 2020 2020 2020 2020 2020  CS:.            
-0002a1f0: 7265 7475 726e 2028 6627 6773 7574 696c  return (f'gsutil
-0002a200: 206c 7320 2d4c 202d 6220 6773 3a2f 2f7b   ls -L -b gs://{
-0002a210: 6275 636b 6574 5f6e 616d 657d 2f20 7c20  bucket_name}/ | 
-0002a220: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-0002a230: 2020 2020 2020 2767 7265 7020 224c 6f63        'grep "Loc
-0002a240: 6174 696f 6e20 636f 6e73 7472 6169 6e74  ation constraint
-0002a250: 2220 7c20 270a 2020 2020 2020 2020 2020  " | '.          
-0002a260: 2020 2020 2020 2020 2020 2761 776b 205c            'awk \
-0002a270: 277b 7072 696e 7420 746f 6c6f 7765 7228  '{print tolower(
-0002a280: 244e 4629 7d5c 2727 290a 2020 2020 2020  $NF)}\'').      
-0002a290: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0002a2a0: 2020 2020 7261 6973 6520 4e6f 7449 6d70      raise NotImp
-0002a2b0: 6c65 6d65 6e74 6564 4572 726f 7228 6627  lementedError(f'
-0002a2c0: 5265 6769 6f6e 2063 6f6d 6d61 6e64 206e  Region command n
-0002a2d0: 6f74 2069 6d70 6c65 6d65 6e74 6564 2066  ot implemented f
-0002a2e0: 6f72 2027 0a20 2020 2020 2020 2020 2020  or '.           
-0002a2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a300: 2020 2020 2020 2020 2020 2066 277b 7374             f'{st
-0002a310: 6f72 655f 7479 7065 7d27 290a 0a20 2020  ore_type}')..   
-0002a320: 2040 7374 6174 6963 6d65 7468 6f64 0a20   @staticmethod. 
-0002a330: 2020 2064 6566 2063 6c69 5f63 6f75 6e74     def cli_count
-0002a340: 5f6e 616d 655f 696e 5f62 7563 6b65 7428  _name_in_bucket(
-0002a350: 7374 6f72 655f 7479 7065 2c20 6275 636b  store_type, buck
-0002a360: 6574 5f6e 616d 652c 2066 696c 655f 6e61  et_name, file_na
-0002a370: 6d65 2c20 7375 6666 6978 3d27 2729 3a0a  me, suffix=''):.
-0002a380: 2020 2020 2020 2020 6966 2073 746f 7265          if store
-0002a390: 5f74 7970 6520 3d3d 2073 746f 7261 6765  _type == storage
-0002a3a0: 5f6c 6962 2e53 746f 7265 5479 7065 2e53  _lib.StoreType.S
-0002a3b0: 333a 0a20 2020 2020 2020 2020 2020 2069  3:.            i
-0002a3c0: 6620 7375 6666 6978 3a0a 2020 2020 2020  f suffix:.      
-0002a3d0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0002a3e0: 2066 2761 7773 2073 3361 7069 206c 6973   f'aws s3api lis
-0002a3f0: 742d 6f62 6a65 6374 7320 2d2d 6275 636b  t-objects --buck
-0002a400: 6574 2022 7b62 7563 6b65 745f 6e61 6d65  et "{bucket_name
-0002a410: 7d22 202d 2d70 7265 6669 7820 7b73 7566  }" --prefix {suf
-0002a420: 6669 787d 202d 2d71 7565 7279 2022 6c65  fix} --query "le
-0002a430: 6e67 7468 2843 6f6e 7465 6e74 735b 3f63  ngth(Contents[?c
-0002a440: 6f6e 7461 696e 7328 4b65 792c 5c27 7b66  ontains(Key,\'{f
-0002a450: 696c 655f 6e61 6d65 7d5c 2729 5d2e 4b65  ile_name}\')].Ke
-0002a460: 7929 2227 0a20 2020 2020 2020 2020 2020  y)"'.           
-0002a470: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0002a480: 2020 2020 2020 2072 6574 7572 6e20 6627         return f'
-0002a490: 6177 7320 7333 6170 6920 6c69 7374 2d6f  aws s3api list-o
-0002a4a0: 626a 6563 7473 202d 2d62 7563 6b65 7420  bjects --bucket 
-0002a4b0: 227b 6275 636b 6574 5f6e 616d 657d 2220  "{bucket_name}" 
-0002a4c0: 2d2d 7175 6572 7920 226c 656e 6774 6828  --query "length(
-0002a4d0: 436f 6e74 656e 7473 5b3f 636f 6e74 6169  Contents[?contai
-0002a4e0: 6e73 284b 6579 2c5c 277b 6669 6c65 5f6e  ns(Key,\'{file_n
-0002a4f0: 616d 657d 5c27 295d 2e4b 6579 2922 270a  ame}\')].Key)"'.
-0002a500: 2020 2020 2020 2020 656c 6966 2073 746f          elif sto
-0002a510: 7265 5f74 7970 6520 3d3d 2073 746f 7261  re_type == stora
-0002a520: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
-0002a530: 2e47 4353 3a0a 2020 2020 2020 2020 2020  .GCS:.          
-0002a540: 2020 6966 2073 7566 6669 783a 0a20 2020    if suffix:.   
-0002a550: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-0002a560: 7572 6e20 6627 6773 7574 696c 206c 7320  urn f'gsutil ls 
-0002a570: 2d72 2067 733a 2f2f 7b62 7563 6b65 745f  -r gs://{bucket_
-0002a580: 6e61 6d65 7d2f 7b73 7566 6669 787d 207c  name}/{suffix} |
-0002a590: 2067 7265 7020 227b 6669 6c65 5f6e 616d   grep "{file_nam
-0002a5a0: 657d 2220 7c20 7763 202d 6c27 0a20 2020  e}" | wc -l'.   
-0002a5b0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-0002a5c0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0002a5d0: 6574 7572 6e20 6627 6773 7574 696c 206c  eturn f'gsutil l
-0002a5e0: 7320 2d72 2067 733a 2f2f 7b62 7563 6b65  s -r gs://{bucke
-0002a5f0: 745f 6e61 6d65 7d20 7c20 6772 6570 2022  t_name} | grep "
-0002a600: 7b66 696c 655f 6e61 6d65 7d22 207c 2077  {file_name}" | w
-0002a610: 6320 2d6c 270a 2020 2020 2020 2020 656c  c -l'.        el
-0002a620: 6966 2073 746f 7265 5f74 7970 6520 3d3d  if store_type ==
-0002a630: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
-0002a640: 7265 5479 7065 2e52 323a 0a20 2020 2020  reType.R2:.     
-0002a650: 2020 2020 2020 2065 6e64 706f 696e 745f         endpoint_
-0002a660: 7572 6c20 3d20 636c 6f75 6466 6c61 7265  url = cloudflare
-0002a670: 2e63 7265 6174 655f 656e 6470 6f69 6e74  .create_endpoint
-0002a680: 2829 0a20 2020 2020 2020 2020 2020 2069  ().            i
-0002a690: 6620 7375 6666 6978 3a0a 2020 2020 2020  f suffix:.      
-0002a6a0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0002a6b0: 2066 2741 5753 5f53 4841 5245 445f 4352   f'AWS_SHARED_CR
-0002a6c0: 4544 454e 5449 414c 535f 4649 4c45 3d7b  EDENTIALS_FILE={
-0002a6d0: 636c 6f75 6466 6c61 7265 2e52 325f 4352  cloudflare.R2_CR
-0002a6e0: 4544 454e 5449 414c 535f 5041 5448 7d20  EDENTIALS_PATH} 
-0002a6f0: 6177 7320 7333 6170 6920 6c69 7374 2d6f  aws s3api list-o
-0002a700: 626a 6563 7473 202d 2d62 7563 6b65 7420  bjects --bucket 
-0002a710: 227b 6275 636b 6574 5f6e 616d 657d 2220  "{bucket_name}" 
-0002a720: 2d2d 7072 6566 6978 207b 7375 6666 6978  --prefix {suffix
-0002a730: 7d20 2d2d 7175 6572 7920 226c 656e 6774  } --query "lengt
-0002a740: 6828 436f 6e74 656e 7473 5b3f 636f 6e74  h(Contents[?cont
-0002a750: 6169 6e73 284b 6579 2c5c 277b 6669 6c65  ains(Key,\'{file
-0002a760: 5f6e 616d 657d 5c27 295d 2e4b 6579 2922  _name}\')].Key)"
-0002a770: 202d 2d65 6e64 706f 696e 7420 7b65 6e64   --endpoint {end
-0002a780: 706f 696e 745f 7572 6c7d 202d 2d70 726f  point_url} --pro
-0002a790: 6669 6c65 3d72 3227 0a20 2020 2020 2020  file=r2'.       
-0002a7a0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0002a7b0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0002a7c0: 6e20 6627 4157 535f 5348 4152 4544 5f43  n f'AWS_SHARED_C
-0002a7d0: 5245 4445 4e54 4941 4c53 5f46 494c 453d  REDENTIALS_FILE=
-0002a7e0: 7b63 6c6f 7564 666c 6172 652e 5232 5f43  {cloudflare.R2_C
-0002a7f0: 5245 4445 4e54 4941 4c53 5f50 4154 487d  REDENTIALS_PATH}
-0002a800: 2061 7773 2073 3361 7069 206c 6973 742d   aws s3api list-
-0002a810: 6f62 6a65 6374 7320 2d2d 6275 636b 6574  objects --bucket
-0002a820: 2022 7b62 7563 6b65 745f 6e61 6d65 7d22   "{bucket_name}"
-0002a830: 202d 2d71 7565 7279 2022 6c65 6e67 7468   --query "length
-0002a840: 2843 6f6e 7465 6e74 735b 3f63 6f6e 7461  (Contents[?conta
-0002a850: 696e 7328 4b65 792c 5c27 7b66 696c 655f  ins(Key,\'{file_
-0002a860: 6e61 6d65 7d5c 2729 5d2e 4b65 7929 2220  name}\')].Key)" 
-0002a870: 2d2d 656e 6470 6f69 6e74 207b 656e 6470  --endpoint {endp
-0002a880: 6f69 6e74 5f75 726c 7d20 2d2d 7072 6f66  oint_url} --prof
-0002a890: 696c 653d 7232 270a 0a20 2020 2040 7374  ile=r2'..    @st
-0002a8a0: 6174 6963 6d65 7468 6f64 0a20 2020 2064  aticmethod.    d
-0002a8b0: 6566 2063 6c69 5f63 6f75 6e74 5f66 696c  ef cli_count_fil
-0002a8c0: 655f 696e 5f62 7563 6b65 7428 7374 6f72  e_in_bucket(stor
-0002a8d0: 655f 7479 7065 2c20 6275 636b 6574 5f6e  e_type, bucket_n
-0002a8e0: 616d 6529 3a0a 2020 2020 2020 2020 6966  ame):.        if
-0002a8f0: 2073 746f 7265 5f74 7970 6520 3d3d 2073   store_type == s
-0002a900: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
-0002a910: 5479 7065 2e53 333a 0a20 2020 2020 2020  Type.S3:.       
-0002a920: 2020 2020 2072 6574 7572 6e20 6627 6177       return f'aw
-0002a930: 7320 7333 206c 7320 7333 3a2f 2f7b 6275  s s3 ls s3://{bu
-0002a940: 636b 6574 5f6e 616d 657d 202d 2d72 6563  cket_name} --rec
-0002a950: 7572 7369 7665 207c 2077 6320 2d6c 270a  ursive | wc -l'.
-0002a960: 2020 2020 2020 2020 656c 6966 2073 746f          elif sto
-0002a970: 7265 5f74 7970 6520 3d3d 2073 746f 7261  re_type == stora
-0002a980: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
-0002a990: 2e47 4353 3a0a 2020 2020 2020 2020 2020  .GCS:.          
-0002a9a0: 2020 7265 7475 726e 2066 2767 7375 7469    return f'gsuti
-0002a9b0: 6c20 6c73 202d 7220 6773 3a2f 2f7b 6275  l ls -r gs://{bu
-0002a9c0: 636b 6574 5f6e 616d 657d 2f2a 2a20 7c20  cket_name}/** | 
-0002a9d0: 7763 202d 6c27 0a20 2020 2020 2020 2065  wc -l'.        e
-0002a9e0: 6c69 6620 7374 6f72 655f 7479 7065 203d  lif store_type =
-0002a9f0: 3d20 7374 6f72 6167 655f 6c69 622e 5374  = storage_lib.St
-0002aa00: 6f72 6554 7970 652e 5232 3a0a 2020 2020  oreType.R2:.    
-0002aa10: 2020 2020 2020 2020 656e 6470 6f69 6e74          endpoint
-0002aa20: 5f75 726c 203d 2063 6c6f 7564 666c 6172  _url = cloudflar
-0002aa30: 652e 6372 6561 7465 5f65 6e64 706f 696e  e.create_endpoin
-0002aa40: 7428 290a 2020 2020 2020 2020 2020 2020  t().            
-0002aa50: 7265 7475 726e 2066 2741 5753 5f53 4841  return f'AWS_SHA
-0002aa60: 5245 445f 4352 4544 454e 5449 414c 535f  RED_CREDENTIALS_
-0002aa70: 4649 4c45 3d7b 636c 6f75 6466 6c61 7265  FILE={cloudflare
-0002aa80: 2e52 325f 4352 4544 454e 5449 414c 535f  .R2_CREDENTIALS_
-0002aa90: 5041 5448 7d20 6177 7320 7333 206c 7320  PATH} aws s3 ls 
-0002aaa0: 7333 3a2f 2f7b 6275 636b 6574 5f6e 616d  s3://{bucket_nam
-0002aab0: 657d 202d 2d72 6563 7572 7369 7665 202d  e} --recursive -
-0002aac0: 2d65 6e64 706f 696e 7420 7b65 6e64 706f  -endpoint {endpo
-0002aad0: 696e 745f 7572 6c7d 202d 2d70 726f 6669  int_url} --profi
-0002aae0: 6c65 3d72 3220 7c20 7763 202d 6c27 0a0a  le=r2 | wc -l'..
-0002aaf0: 2020 2020 4070 7974 6573 742e 6669 7874      @pytest.fixt
-0002ab00: 7572 650a 2020 2020 6465 6620 746d 705f  ure.    def tmp_
-0002ab10: 736f 7572 6365 2873 656c 662c 2074 6d70  source(self, tmp
-0002ab20: 5f70 6174 6829 3a0a 2020 2020 2020 2020  _path):.        
-0002ab30: 2320 4372 6561 7465 7320 6120 7465 6d70  # Creates a temp
-0002ab40: 6f72 6172 7920 6469 7265 6374 6f72 7920  orary directory 
-0002ab50: 7769 7468 2061 2066 696c 6520 696e 2069  with a file in i
-0002ab60: 740a 2020 2020 2020 2020 746d 705f 6469  t.        tmp_di
-0002ab70: 7220 3d20 746d 705f 7061 7468 202f 2027  r = tmp_path / '
-0002ab80: 746d 702d 736f 7572 6365 270a 2020 2020  tmp-source'.    
-0002ab90: 2020 2020 746d 705f 6469 722e 6d6b 6469      tmp_dir.mkdi
-0002aba0: 7228 290a 2020 2020 2020 2020 746d 705f  r().        tmp_
-0002abb0: 6669 6c65 203d 2074 6d70 5f64 6972 202f  file = tmp_dir /
-0002abc0: 2027 746d 702d 6669 6c65 270a 2020 2020   'tmp-file'.    
-0002abd0: 2020 2020 746d 705f 6669 6c65 2e77 7269      tmp_file.wri
-0002abe0: 7465 5f74 6578 7428 2774 6573 7427 290a  te_text('test').
-0002abf0: 2020 2020 2020 2020 6369 7263 6c65 5f6c          circle_l
-0002ac00: 696e 6b20 3d20 746d 705f 6469 7220 2f20  ink = tmp_dir / 
-0002ac10: 2763 6972 636c 652d 6c69 6e6b 270a 2020  'circle-link'.  
-0002ac20: 2020 2020 2020 6369 7263 6c65 5f6c 696e        circle_lin
-0002ac30: 6b2e 7379 6d6c 696e 6b5f 746f 2874 6d70  k.symlink_to(tmp
-0002ac40: 5f64 6972 2c20 7461 7267 6574 5f69 735f  _dir, target_is_
-0002ac50: 6469 7265 6374 6f72 793d 5472 7565 290a  directory=True).
-0002ac60: 2020 2020 2020 2020 7969 656c 6420 7374          yield st
-0002ac70: 7228 746d 705f 6469 7229 0a0a 2020 2020  r(tmp_dir)..    
-0002ac80: 4073 7461 7469 636d 6574 686f 640a 2020  @staticmethod.  
-0002ac90: 2020 6465 6620 6765 6e65 7261 7465 5f62    def generate_b
-0002aca0: 7563 6b65 745f 6e61 6d65 2829 3a0a 2020  ucket_name():.  
-0002acb0: 2020 2020 2020 2320 4372 6561 7465 7320        # Creates 
-0002acc0: 6120 7465 6d70 6f72 6172 7920 6275 636b  a temporary buck
-0002acd0: 6574 206e 616d 650a 2020 2020 2020 2020  et name.        
-0002ace0: 2320 7469 6d65 2e74 696d 6528 2920 7265  # time.time() re
-0002acf0: 7475 726e 7320 7661 7279 696e 6720 7072  turns varying pr
-0002ad00: 6563 6973 696f 6e20 6f6e 2064 6966 6665  ecision on diffe
-0002ad10: 7265 6e74 2073 7973 7465 6d73 2c20 736f  rent systems, so
-0002ad20: 2077 650a 2020 2020 2020 2020 2320 7265   we.        # re
-0002ad30: 706c 6163 6520 7468 6520 6465 6369 6d61  place the decima
-0002ad40: 6c20 706f 696e 7420 616e 6420 7573 6520  l point and use 
-0002ad50: 7768 6174 6576 6572 2070 7265 6369 7369  whatever precisi
-0002ad60: 6f6e 2077 6520 6361 6e20 6765 742e 0a20  on we can get.. 
-0002ad70: 2020 2020 2020 2074 696d 6573 7461 6d70         timestamp
-0002ad80: 203d 2073 7472 2874 696d 652e 7469 6d65   = str(time.time
-0002ad90: 2829 292e 7265 706c 6163 6528 272e 272c  ()).replace('.',
-0002ada0: 2027 2729 0a20 2020 2020 2020 2072 6574   '').        ret
-0002adb0: 7572 6e20 6627 736b 792d 7465 7374 2d7b  urn f'sky-test-{
-0002adc0: 7469 6d65 7374 616d 707d 270a 0a20 2020  timestamp}'..   
-0002add0: 2040 7079 7465 7374 2e66 6978 7475 7265   @pytest.fixture
-0002ade0: 0a20 2020 2064 6566 2074 6d70 5f62 7563  .    def tmp_buc
-0002adf0: 6b65 745f 6e61 6d65 2873 656c 6629 3a0a  ket_name(self):.
-0002ae00: 2020 2020 2020 2020 7969 656c 6420 7365          yield se
-0002ae10: 6c66 2e67 656e 6572 6174 655f 6275 636b  lf.generate_buck
-0002ae20: 6574 5f6e 616d 6528 290a 0a20 2020 2040  et_name()..    @
-0002ae30: 7374 6174 6963 6d65 7468 6f64 0a20 2020  staticmethod.   
-0002ae40: 2064 6566 2079 6965 6c64 5f73 746f 7261   def yield_stora
-0002ae50: 6765 5f6f 626a 6563 7428 0a20 2020 2020  ge_object(.     
-0002ae60: 2020 2020 2020 206e 616d 653a 204f 7074         name: Opt
-0002ae70: 696f 6e61 6c5b 7374 725d 203d 204e 6f6e  ional[str] = Non
-0002ae80: 652c 0a20 2020 2020 2020 2020 2020 2073  e,.            s
-0002ae90: 6f75 7263 653a 204f 7074 696f 6e61 6c5b  ource: Optional[
-0002aea0: 7374 6f72 6167 655f 6c69 622e 5061 7468  storage_lib.Path
-0002aeb0: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
-0002aec0: 2020 2020 2020 7374 6f72 6573 3a20 4f70        stores: Op
-0002aed0: 7469 6f6e 616c 5b44 6963 745b 7374 6f72  tional[Dict[stor
-0002aee0: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
-0002aef0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+00016890: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f69  pytest.mark.no_i
+000168a0: 626d 2020 2320 4942 4d20 436c 6f75 6420  bm  # IBM Cloud 
+000168b0: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
+000168c0: 2073 706f 7420 696e 7374 616e 6365 730a   spot instances.
+000168d0: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+000168e0: 7363 7020 2023 2053 4350 2064 6f65 7320  scp  # SCP does 
+000168f0: 6e6f 7420 7375 7070 6f72 7420 7370 6f74  not support spot
+00016900: 2069 6e73 7461 6e63 6573 0a40 7079 7465   instances.@pyte
+00016910: 7374 2e6d 6172 6b2e 6e6f 5f6b 7562 6572  st.mark.no_kuber
+00016920: 6e65 7465 7320 2023 204b 7562 6572 6e65  netes  # Kuberne
+00016930: 7465 7320 646f 6573 206e 6f74 2068 6176  tes does not hav
+00016940: 6520 6120 6e6f 7469 6f6e 206f 6620 7370  e a notion of sp
+00016950: 6f74 2069 6e73 7461 6e63 6573 0a64 6566  ot instances.def
+00016960: 2074 6573 745f 7573 655f 7370 6f74 2867   test_use_spot(g
+00016970: 656e 6572 6963 5f63 6c6f 7564 3a20 7374  eneric_cloud: st
+00016980: 7229 3a0a 2020 2020 2222 2254 6573 7420  r):.    """Test 
+00016990: 7573 652d 7370 6f74 2061 6e64 2073 6b79  use-spot and sky
+000169a0: 2065 7865 632e 2222 220a 2020 2020 6e61   exec.""".    na
+000169b0: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
+000169c0: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
+000169d0: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
+000169e0: 2020 2775 7365 2d73 706f 7427 2c0a 2020    'use-spot',.  
+000169f0: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+00016a00: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
+00016a10: 202d 6320 7b6e 616d 657d 202d 2d63 6c6f   -c {name} --clo
+00016a20: 7564 207b 6765 6e65 7269 635f 636c 6f75  ud {generic_clou
+00016a30: 647d 2074 6573 7473 2f74 6573 745f 7961  d} tests/test_ya
+00016a40: 6d6c 732f 6d69 6e69 6d61 6c2e 7961 6d6c  mls/minimal.yaml
+00016a50: 202d 2d75 7365 2d73 706f 7420 2d79 272c   --use-spot -y',
+00016a60: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00016a70: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
+00016a80: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
+00016a90: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
+00016aa0: 6563 207b 6e61 6d65 7d20 6563 686f 2068  ec {name} echo h
+00016ab0: 6927 2c0a 2020 2020 2020 2020 2020 2020  i',.            
+00016ac0: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+00016ad0: 7d20 3220 2d2d 7374 6174 7573 272c 0a20  } 2 --status',. 
+00016ae0: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
+00016af0: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
+00016b00: 7b6e 616d 657d 272c 0a20 2020 2029 0a20  {name}',.    ). 
+00016b10: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+00016b20: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
+00016b30: 6d61 726b 2e67 6370 0a64 6566 2074 6573  mark.gcp.def tes
+00016b40: 745f 7374 6f70 5f67 6370 5f73 706f 7428  t_stop_gcp_spot(
+00016b50: 293a 0a20 2020 2022 2222 5465 7374 2047  ):.    """Test G
+00016b60: 4350 2073 706f 7420 6361 6e20 6265 2073  CP spot can be s
+00016b70: 746f 7070 6564 2c20 6175 746f 7374 6f70  topped, autostop
+00016b80: 7065 642c 2072 6573 7461 7274 6564 2e22  ped, restarted."
+00016b90: 2222 0a20 2020 206e 616d 6520 3d20 5f67  "".    name = _g
+00016ba0: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
+00016bb0: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
+00016bc0: 7428 0a20 2020 2020 2020 2027 7374 6f70  t(.        'stop
+00016bd0: 5f67 6370 5f73 706f 7427 2c0a 2020 2020  _gcp_spot',.    
+00016be0: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
+00016bf0: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
+00016c00: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
+00016c10: 2067 6370 202d 2d75 7365 2d73 706f 7420   gcp --use-spot 
+00016c20: 2d2d 6370 7573 2032 2b20 2d79 202d 2d20  --cpus 2+ -y -- 
+00016c30: 746f 7563 6820 6d79 6669 6c65 272c 0a20  touch myfile',. 
+00016c40: 2020 2020 2020 2020 2020 2023 2073 746f             # sto
+00016c50: 7020 7368 6f75 6c64 2067 6f20 7468 726f  p should go thro
+00016c60: 7567 683a 0a20 2020 2020 2020 2020 2020  ugh:.           
+00016c70: 2066 2773 6b79 2073 746f 7020 7b6e 616d   f'sky stop {nam
+00016c80: 657d 202d 7927 2c0a 2020 2020 2020 2020  e} -y',.        
+00016c90: 2020 2020 6627 736b 7920 7374 6172 7420      f'sky start 
+00016ca0: 7b6e 616d 657d 202d 7927 2c0a 2020 2020  {name} -y',.    
+00016cb0: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
+00016cc0: 6563 207b 6e61 6d65 7d20 2d2d 206c 7320  ec {name} -- ls 
+00016cd0: 6d79 6669 6c65 272c 0a20 2020 2020 2020  myfile',.       
+00016ce0: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+00016cf0: 7b6e 616d 657d 2032 202d 2d73 7461 7475  {name} 2 --statu
+00016d00: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
+00016d10: 6627 736b 7920 6175 746f 7374 6f70 207b  f'sky autostop {
+00016d20: 6e61 6d65 7d20 2d69 3020 2d79 272c 0a20  name} -i0 -y',. 
+00016d30: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+00016d40: 7020 3930 272c 0a20 2020 2020 2020 2020  p 90',.         
+00016d50: 2020 2066 2773 3d24 2873 6b79 2073 7461     f's=$(sky sta
+00016d60: 7475 7320 7b6e 616d 657d 202d 2d72 6566  tus {name} --ref
+00016d70: 7265 7368 293b 2065 6368 6f20 2224 7322  resh); echo "$s"
+00016d80: 3b20 6563 686f 3b20 6563 686f 3b20 6563  ; echo; echo; ec
+00016d90: 686f 2022 2473 2220 207c 2067 7265 7020  ho "$s"  | grep 
+00016da0: 7b6e 616d 657d 207c 2067 7265 7020 5354  {name} | grep ST
+00016db0: 4f50 5045 4427 2c0a 2020 2020 2020 2020  OPPED',.        
+00016dc0: 2020 2020 6627 736b 7920 7374 6172 7420      f'sky start 
+00016dd0: 7b6e 616d 657d 202d 7927 2c0a 2020 2020  {name} -y',.    
+00016de0: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
+00016df0: 6563 207b 6e61 6d65 7d20 2d2d 206c 7320  ec {name} -- ls 
+00016e00: 6d79 6669 6c65 272c 0a20 2020 2020 2020  myfile',.       
+00016e10: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+00016e20: 7b6e 616d 657d 2033 202d 2d73 7461 7475  {name} 3 --statu
+00016e30: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
+00016e40: 2320 2d69 206f 7074 696f 6e20 6174 206c  # -i option at l
+00016e50: 6175 6e63 6820 7368 6f75 6c64 2067 6f20  aunch should go 
+00016e60: 7468 726f 7567 683a 0a20 2020 2020 2020  through:.       
+00016e70: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
+00016e80: 6820 2d63 207b 6e61 6d65 7d20 2d69 3020  h -c {name} -i0 
+00016e90: 2d79 272c 0a20 2020 2020 2020 2020 2020  -y',.           
+00016ea0: 2027 736c 6565 7020 3132 3027 2c0a 2020   'sleep 120',.  
+00016eb0: 2020 2020 2020 2020 2020 6627 733d 2428            f's=$(
+00016ec0: 736b 7920 7374 6174 7573 207b 6e61 6d65  sky status {name
+00016ed0: 7d20 2d2d 7265 6672 6573 6829 3b20 6563  } --refresh); ec
+00016ee0: 686f 2022 2473 223b 2065 6368 6f3b 2065  ho "$s"; echo; e
+00016ef0: 6368 6f3b 2065 6368 6f20 2224 7322 2020  cho; echo "$s"  
+00016f00: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
+00016f10: 6772 6570 2053 544f 5050 4544 272c 0a20  grep STOPPED',. 
+00016f20: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
+00016f30: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
+00016f40: 7b6e 616d 657d 272c 0a20 2020 2029 0a20  {name}',.    ). 
+00016f50: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+00016f60: 7465 7374 290a 0a0a 2320 2d2d 2d2d 2d2d  test)...# ------
+00016f70: 2d2d 2d2d 2054 6573 7469 6e67 206d 616e  ---- Testing man
+00016f80: 6167 6564 206a 6f62 202d 2d2d 2d2d 2d2d  aged job -------
+00016f90: 2d2d 2d0a 4070 7974 6573 742e 6d61 726b  ---.@pytest.mark
+00016fa0: 2e6d 616e 6167 6564 5f6a 6f62 730a 6465  .managed_jobs.de
+00016fb0: 6620 7465 7374 5f6d 616e 6167 6564 5f6a  f test_managed_j
+00016fc0: 6f62 7328 6765 6e65 7269 635f 636c 6f75  obs(generic_clou
+00016fd0: 643a 2073 7472 293a 0a20 2020 2022 2222  d: str):.    """
+00016fe0: 5465 7374 2074 6865 206d 616e 6167 6564  Test the managed
+00016ff0: 206a 6f62 7320 7961 6d6c 2e22 2222 0a20   jobs yaml.""". 
+00017000: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
+00017010: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
+00017020: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
+00017030: 2020 2020 2020 2027 6d61 6e61 6765 642d         'managed-
+00017040: 6a6f 6273 272c 0a20 2020 2020 2020 205b  jobs',.        [
+00017050: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00017060: 6b79 206a 6f62 7320 6c61 756e 6368 202d  ky jobs launch -
+00017070: 6e20 7b6e 616d 657d 2d31 202d 2d63 6c6f  n {name}-1 --clo
+00017080: 7564 207b 6765 6e65 7269 635f 636c 6f75  ud {generic_clou
+00017090: 647d 2065 7861 6d70 6c65 732f 6d61 6e61  d} examples/mana
+000170a0: 6765 645f 6a6f 622e 7961 6d6c 202d 7920  ged_job.yaml -y 
+000170b0: 2d64 272c 0a20 2020 2020 2020 2020 2020  -d',.           
+000170c0: 2066 2773 6b79 206a 6f62 7320 6c61 756e   f'sky jobs laun
+000170d0: 6368 202d 6e20 7b6e 616d 657d 2d32 202d  ch -n {name}-2 -
+000170e0: 2d63 6c6f 7564 207b 6765 6e65 7269 635f  -cloud {generic_
+000170f0: 636c 6f75 647d 2065 7861 6d70 6c65 732f  cloud} examples/
+00017100: 6d61 6e61 6765 645f 6a6f 622e 7961 6d6c  managed_job.yaml
+00017110: 202d 7920 2d64 272c 0a20 2020 2020 2020   -y -d',.       
+00017120: 2020 2020 2027 736c 6565 7020 3527 2c0a       'sleep 5',.
+00017130: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
+00017140: 4a4f 425f 5155 4555 455f 5741 4954 7d7c  JOB_QUEUE_WAIT}|
+00017150: 2067 7265 7020 7b6e 616d 657d 2d31 207c   grep {name}-1 |
+00017160: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
+00017170: 2022 5354 4152 5449 4e47 5c7c 5255 4e4e   "STARTING\|RUNN
+00017180: 494e 4722 272c 0a20 2020 2020 2020 2020  ING"',.         
+00017190: 2020 2066 277b 5f4a 4f42 5f51 5545 5545     f'{_JOB_QUEUE
+000171a0: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
+000171b0: 6d65 7d2d 3220 7c20 6865 6164 202d 6e31  me}-2 | head -n1
+000171c0: 207c 2067 7265 7020 2253 5441 5254 494e   | grep "STARTIN
+000171d0: 475c 7c52 554e 4e49 4e47 2227 2c0a 2020  G\|RUNNING"',.  
+000171e0: 2020 2020 2020 2020 2020 5f4a 4f42 5f43            _JOB_C
+000171f0: 414e 4345 4c5f 5741 4954 2e66 6f72 6d61  ANCEL_WAIT.forma
+00017200: 7428 6a6f 625f 6e61 6d65 3d66 277b 6e61  t(job_name=f'{na
+00017210: 6d65 7d2d 3127 292c 0a20 2020 2020 2020  me}-1'),.       
+00017220: 2020 2020 2027 736c 6565 7020 3527 2c0a       'sleep 5',.
+00017230: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
+00017240: 4a4f 425f 5155 4555 455f 5741 4954 7d7c  JOB_QUEUE_WAIT}|
+00017250: 2067 7265 7020 7b6e 616d 657d 2d31 207c   grep {name}-1 |
+00017260: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
+00017270: 2022 4341 4e43 454c 4c49 4e47 5c7c 4341   "CANCELLING\|CA
+00017280: 4e43 454c 4c45 4422 272c 0a20 2020 2020  NCELLED"',.     
+00017290: 2020 2020 2020 2027 736c 6565 7020 3230         'sleep 20
+000172a0: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
+000172b0: 6627 7b5f 4a4f 425f 5155 4555 455f 5741  f'{_JOB_QUEUE_WA
+000172c0: 4954 7d7c 2067 7265 7020 7b6e 616d 657d  IT}| grep {name}
+000172d0: 2d31 207c 2068 6561 6420 2d6e 3120 7c20  -1 | head -n1 | 
+000172e0: 6772 6570 2043 414e 4345 4c4c 4544 272c  grep CANCELLED',
+000172f0: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
+00017300: 5f4a 4f42 5f51 5545 5545 5f57 4149 547d  _JOB_QUEUE_WAIT}
+00017310: 7c20 6772 6570 207b 6e61 6d65 7d2d 3220  | grep {name}-2 
+00017320: 7c20 6865 6164 202d 6e31 207c 2067 7265  | head -n1 | gre
+00017330: 7020 2252 554e 4e49 4e47 5c7c 5355 4343  p "RUNNING\|SUCC
+00017340: 4545 4445 4422 272c 0a20 2020 2020 2020  EEDED"',.       
+00017350: 205d 2c0a 2020 2020 2020 2020 2320 544f   ],.        # TO
+00017360: 444f 287a 6877 7529 3a20 4368 616e 6765  DO(zhwu): Change
+00017370: 2074 6f20 5f4a 4f42 5f43 414e 4345 4c5f   to _JOB_CANCEL_
+00017380: 5741 4954 2e66 6f72 6d61 7428 6a6f 625f  WAIT.format(job_
+00017390: 6e61 6d65 3d66 277b 6e61 6d65 7d2d 3120  name=f'{name}-1 
+000173a0: 2d6e 207b 6e61 6d65 7d2d 3227 2920 7768  -n {name}-2') wh
+000173b0: 656e 0a20 2020 2020 2020 2023 2063 616e  en.        # can
+000173c0: 6365 6c69 6e67 206d 756c 7469 706c 6520  celing multiple 
+000173d0: 6a6f 6220 6e61 6d65 7320 6973 2073 7570  job names is sup
+000173e0: 706f 7274 6564 2e0a 2020 2020 2020 2020  ported..        
+000173f0: 285f 4a4f 425f 4341 4e43 454c 5f57 4149  (_JOB_CANCEL_WAI
+00017400: 542e 666f 726d 6174 286a 6f62 5f6e 616d  T.format(job_nam
+00017410: 653d 6627 7b6e 616d 657d 2d31 2729 202b  e=f'{name}-1') +
+00017420: 2027 3b20 2720 2b0a 2020 2020 2020 2020   '; ' +.        
+00017430: 205f 4a4f 425f 4341 4e43 454c 5f57 4149   _JOB_CANCEL_WAI
+00017440: 542e 666f 726d 6174 286a 6f62 5f6e 616d  T.format(job_nam
+00017450: 653d 6627 7b6e 616d 657d 2d32 2729 292c  e=f'{name}-2')),
+00017460: 0a20 2020 2020 2020 2023 2049 6e63 7265  .        # Incre
+00017470: 6173 6520 7469 6d65 6f75 7420 7369 6e63  ase timeout sinc
+00017480: 6520 736b 7920 6a6f 6273 2071 7565 7565  e sky jobs queue
+00017490: 202d 7220 6361 6e20 6265 2062 6c6f 636b   -r can be block
+000174a0: 6564 2062 7920 6f74 6865 7220 7370 6f74  ed by other spot
+000174b0: 2074 6573 7473 2e0a 2020 2020 2020 2020   tests..        
+000174c0: 7469 6d65 6f75 743d 3230 202a 2036 302c  timeout=20 * 60,
+000174d0: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+000174e0: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+000174f0: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+00017500: 666c 7569 6473 7461 636b 2020 2366 6c75  fluidstack  #flu
+00017510: 6964 7374 6163 6b20 646f 6573 206e 6f74  idstack does not
+00017520: 2073 7570 706f 7274 2073 706f 7420 696e   support spot in
+00017530: 7374 616e 6365 730a 4070 7974 6573 742e  stances.@pytest.
+00017540: 6d61 726b 2e6e 6f5f 617a 7572 6520 2023  mark.no_azure  #
+00017550: 2041 7a75 7265 2064 6f65 7320 6e6f 7420   Azure does not 
+00017560: 7375 7070 6f72 7420 7370 6f74 2069 6e73  support spot ins
+00017570: 7461 6e63 6573 0a40 7079 7465 7374 2e6d  tances.@pytest.m
+00017580: 6172 6b2e 6e6f 5f6c 616d 6264 615f 636c  ark.no_lambda_cl
+00017590: 6f75 6420 2023 204c 616d 6264 6120 436c  oud  # Lambda Cl
+000175a0: 6f75 6420 646f 6573 206e 6f74 2073 7570  oud does not sup
+000175b0: 706f 7274 2073 706f 7420 696e 7374 616e  port spot instan
+000175c0: 6365 730a 4070 7974 6573 742e 6d61 726b  ces.@pytest.mark
+000175d0: 2e6e 6f5f 6962 6d20 2023 2049 424d 2043  .no_ibm  # IBM C
+000175e0: 6c6f 7564 2064 6f65 7320 6e6f 7420 7375  loud does not su
+000175f0: 7070 6f72 7420 7370 6f74 2069 6e73 7461  pport spot insta
+00017600: 6e63 6573 0a40 7079 7465 7374 2e6d 6172  nces.@pytest.mar
+00017610: 6b2e 6e6f 5f73 6370 2020 2320 5343 5020  k.no_scp  # SCP 
+00017620: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
+00017630: 2073 706f 7420 696e 7374 616e 6365 730a   spot instances.
+00017640: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+00017650: 7061 7065 7273 7061 6365 2020 2320 5061  paperspace  # Pa
+00017660: 7065 7273 7061 6365 2064 6f65 7320 6e6f  perspace does no
+00017670: 7420 7375 7070 6f72 7420 7370 6f74 2069  t support spot i
+00017680: 6e73 7461 6e63 6573 0a40 7079 7465 7374  nstances.@pytest
+00017690: 2e6d 6172 6b2e 6e6f 5f6b 7562 6572 6e65  .mark.no_kuberne
+000176a0: 7465 7320 2023 204b 7562 6572 6e65 7465  tes  # Kubernete
+000176b0: 7320 646f 6573 206e 6f74 2068 6176 6520  s does not have 
+000176c0: 6120 6e6f 7469 6f6e 206f 6620 7370 6f74  a notion of spot
+000176d0: 2069 6e73 7461 6e63 6573 0a40 7079 7465   instances.@pyte
+000176e0: 7374 2e6d 6172 6b2e 6d61 6e61 6765 645f  st.mark.managed_
+000176f0: 6a6f 6273 0a64 6566 2074 6573 745f 6a6f  jobs.def test_jo
+00017700: 625f 7069 7065 6c69 6e65 2867 656e 6572  b_pipeline(gener
+00017710: 6963 5f63 6c6f 7564 3a20 7374 7229 3a0a  ic_cloud: str):.
+00017720: 2020 2020 2222 2254 6573 7420 6120 6a6f      """Test a jo
+00017730: 6220 7069 7065 6c69 6e65 2e22 2222 0a20  b pipeline.""". 
+00017740: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
+00017750: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
+00017760: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
+00017770: 2020 2020 2020 2027 7370 6f74 2d70 6970         'spot-pip
+00017780: 656c 696e 6527 2c0a 2020 2020 2020 2020  eline',.        
+00017790: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
+000177a0: 736b 7920 6a6f 6273 206c 6175 6e63 6820  sky jobs launch 
+000177b0: 2d6e 207b 6e61 6d65 7d20 7465 7374 732f  -n {name} tests/
+000177c0: 7465 7374 5f79 616d 6c73 2f70 6970 656c  test_yamls/pipel
+000177d0: 696e 652e 7961 6d6c 202d 7920 2d64 272c  ine.yaml -y -d',
+000177e0: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
+000177f0: 6565 7020 3527 2c0a 2020 2020 2020 2020  eep 5',.        
+00017800: 2020 2020 6627 7b5f 4a4f 425f 5155 4555      f'{_JOB_QUEU
+00017810: 455f 5741 4954 7d7c 2067 7265 7020 7b6e  E_WAIT}| grep {n
+00017820: 616d 657d 207c 2068 6561 6420 2d6e 3120  ame} | head -n1 
+00017830: 7c20 6772 6570 2022 5354 4152 5449 4e47  | grep "STARTING
+00017840: 5c7c 5255 4e4e 494e 4722 272c 0a20 2020  \|RUNNING"',.   
+00017850: 2020 2020 2020 2020 2023 2060 6772 6570           # `grep
+00017860: 202d 4120 3420 7b6e 616d 657d 6020 6669   -A 4 {name}` fi
+00017870: 6e64 7320 7468 6520 6a6f 6220 7769 7468  nds the job with
+00017880: 207b 6e61 6d65 7d20 616e 6420 7468 6520   {name} and the 
+00017890: 3420 6c69 6e65 730a 2020 2020 2020 2020  4 lines.        
+000178a0: 2020 2020 2320 6166 7465 7220 6974 2c20      # after it, 
+000178b0: 692e 652e 2074 6865 2034 2074 6173 6b73  i.e. the 4 tasks
+000178c0: 2077 6974 6869 6e20 7468 6520 6a6f 622e   within the job.
+000178d0: 0a20 2020 2020 2020 2020 2020 2023 2060  .            # `
+000178e0: 7365 6420 2d6e 2032 7060 2067 6574 7320  sed -n 2p` gets 
+000178f0: 7468 6520 7365 636f 6e64 206c 696e 6520  the second line 
+00017900: 6f66 2074 6865 2034 206c 696e 6573 2c20  of the 4 lines, 
+00017910: 692e 652e 2074 6865 2066 6972 7374 0a20  i.e. the first. 
+00017920: 2020 2020 2020 2020 2020 2023 2074 6173             # tas
+00017930: 6b20 7769 7468 696e 2074 6865 206a 6f62  k within the job
+00017940: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
+00017950: 7b5f 4a4f 425f 5155 4555 455f 5741 4954  {_JOB_QUEUE_WAIT
+00017960: 7d7c 2067 7265 7020 2d41 2034 207b 6e61  }| grep -A 4 {na
+00017970: 6d65 7d7c 2073 6564 202d 6e20 3270 207c  me}| sed -n 2p |
+00017980: 2067 7265 7020 2253 5441 5254 494e 475c   grep "STARTING\
+00017990: 7c52 554e 4e49 4e47 2227 2c0a 2020 2020  |RUNNING"',.    
+000179a0: 2020 2020 2020 2020 6627 7b5f 4a4f 425f          f'{_JOB_
+000179b0: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
+000179c0: 7020 2d41 2034 207b 6e61 6d65 7d7c 2073  p -A 4 {name}| s
+000179d0: 6564 202d 6e20 3370 207c 2067 7265 7020  ed -n 3p | grep 
+000179e0: 2250 454e 4449 4e47 2227 2c0a 2020 2020  "PENDING"',.    
+000179f0: 2020 2020 2020 2020 5f4a 4f42 5f43 414e          _JOB_CAN
+00017a00: 4345 4c5f 5741 4954 2e66 6f72 6d61 7428  CEL_WAIT.format(
+00017a10: 6a6f 625f 6e61 6d65 3d66 277b 6e61 6d65  job_name=f'{name
+00017a20: 7d27 292c 0a20 2020 2020 2020 2020 2020  }'),.           
+00017a30: 2027 736c 6565 7020 3527 2c0a 2020 2020   'sleep 5',.    
+00017a40: 2020 2020 2020 2020 6627 7b5f 4a4f 425f          f'{_JOB_
+00017a50: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
+00017a60: 7020 2d41 2034 207b 6e61 6d65 7d7c 2073  p -A 4 {name}| s
+00017a70: 6564 202d 6e20 3270 207c 2067 7265 7020  ed -n 2p | grep 
+00017a80: 2243 414e 4345 4c4c 494e 475c 7c43 414e  "CANCELLING\|CAN
+00017a90: 4345 4c4c 4544 2227 2c0a 2020 2020 2020  CELLED"',.      
+00017aa0: 2020 2020 2020 6627 7b5f 4a4f 425f 5155        f'{_JOB_QU
+00017ab0: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
+00017ac0: 2d41 2034 207b 6e61 6d65 7d7c 2073 6564  -A 4 {name}| sed
+00017ad0: 202d 6e20 3370 207c 2067 7265 7020 2243   -n 3p | grep "C
+00017ae0: 414e 4345 4c4c 494e 475c 7c43 414e 4345  ANCELLING\|CANCE
+00017af0: 4c4c 4544 2227 2c0a 2020 2020 2020 2020  LLED"',.        
+00017b00: 2020 2020 6627 7b5f 4a4f 425f 5155 4555      f'{_JOB_QUEU
+00017b10: 455f 5741 4954 7d7c 2067 7265 7020 2d41  E_WAIT}| grep -A
+00017b20: 2034 207b 6e61 6d65 7d7c 2073 6564 202d   4 {name}| sed -
+00017b30: 6e20 3470 207c 2067 7265 7020 2243 414e  n 4p | grep "CAN
+00017b40: 4345 4c4c 494e 475c 7c43 414e 4345 4c4c  CELLING\|CANCELL
+00017b50: 4544 2227 2c0a 2020 2020 2020 2020 2020  ED"',.          
+00017b60: 2020 6627 7b5f 4a4f 425f 5155 4555 455f    f'{_JOB_QUEUE_
+00017b70: 5741 4954 7d7c 2067 7265 7020 2d41 2034  WAIT}| grep -A 4
+00017b80: 207b 6e61 6d65 7d7c 2073 6564 202d 6e20   {name}| sed -n 
+00017b90: 3570 207c 2067 7265 7020 2243 414e 4345  5p | grep "CANCE
+00017ba0: 4c4c 494e 475c 7c43 414e 4345 4c4c 4544  LLING\|CANCELLED
+00017bb0: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+00017bc0: 2773 6c65 6570 2032 3030 272c 0a20 2020  'sleep 200',.   
+00017bd0: 2020 2020 2020 2020 2066 277b 5f4a 4f42           f'{_JOB
+00017be0: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
+00017bf0: 6570 202d 4120 3420 7b6e 616d 657d 7c20  ep -A 4 {name}| 
+00017c00: 7365 6420 2d6e 2032 7020 7c20 6772 6570  sed -n 2p | grep
+00017c10: 2022 4341 4e43 454c 4c45 4422 272c 0a20   "CANCELLED"',. 
+00017c20: 2020 2020 2020 2020 2020 2066 277b 5f4a             f'{_J
+00017c30: 4f42 5f51 5545 5545 5f57 4149 547d 7c20  OB_QUEUE_WAIT}| 
+00017c40: 6772 6570 202d 4120 3420 7b6e 616d 657d  grep -A 4 {name}
+00017c50: 7c20 7365 6420 2d6e 2033 7020 7c20 6772  | sed -n 3p | gr
+00017c60: 6570 2022 4341 4e43 454c 4c45 4422 272c  ep "CANCELLED"',
+00017c70: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
+00017c80: 5f4a 4f42 5f51 5545 5545 5f57 4149 547d  _JOB_QUEUE_WAIT}
+00017c90: 7c20 6772 6570 202d 4120 3420 7b6e 616d  | grep -A 4 {nam
+00017ca0: 657d 7c20 7365 6420 2d6e 2034 7020 7c20  e}| sed -n 4p | 
+00017cb0: 6772 6570 2022 4341 4e43 454c 4c45 4422  grep "CANCELLED"
+00017cc0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00017cd0: 277b 5f4a 4f42 5f51 5545 5545 5f57 4149  '{_JOB_QUEUE_WAI
+00017ce0: 547d 7c20 6772 6570 202d 4120 3420 7b6e  T}| grep -A 4 {n
+00017cf0: 616d 657d 7c20 7365 6420 2d6e 2035 7020  ame}| sed -n 5p 
+00017d00: 7c20 6772 6570 2022 4341 4e43 454c 4c45  | grep "CANCELLE
+00017d10: 4422 272c 0a20 2020 2020 2020 205d 2c0a  D"',.        ],.
+00017d20: 2020 2020 2020 2020 5f4a 4f42 5f43 414e          _JOB_CAN
+00017d30: 4345 4c5f 5741 4954 2e66 6f72 6d61 7428  CEL_WAIT.format(
+00017d40: 6a6f 625f 6e61 6d65 3d66 277b 6e61 6d65  job_name=f'{name
+00017d50: 7d27 292c 0a20 2020 2020 2020 2023 2049  }'),.        # I
+00017d60: 6e63 7265 6173 6520 7469 6d65 6f75 7420  ncrease timeout 
+00017d70: 7369 6e63 6520 736b 7920 6a6f 6273 2071  since sky jobs q
+00017d80: 7565 7565 202d 7220 6361 6e20 6265 2062  ueue -r can be b
+00017d90: 6c6f 636b 6564 2062 7920 6f74 6865 7220  locked by other 
+00017da0: 7370 6f74 2074 6573 7473 2e0a 2020 2020  spot tests..    
+00017db0: 2020 2020 7469 6d65 6f75 743d 3330 202a      timeout=30 *
+00017dc0: 2036 302c 0a20 2020 2029 0a20 2020 2072   60,.    ).    r
+00017dd0: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
+00017de0: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
+00017df0: 2e6e 6f5f 666c 7569 6473 7461 636b 2020  .no_fluidstack  
+00017e00: 2366 6c75 6964 7374 6163 6b20 646f 6573  #fluidstack does
+00017e10: 206e 6f74 2073 7570 706f 7274 2073 706f   not support spo
+00017e20: 7420 696e 7374 616e 6365 730a 4070 7974  t instances.@pyt
+00017e30: 6573 742e 6d61 726b 2e6e 6f5f 617a 7572  est.mark.no_azur
+00017e40: 6520 2023 2041 7a75 7265 2064 6f65 7320  e  # Azure does 
+00017e50: 6e6f 7420 7375 7070 6f72 7420 7370 6f74  not support spot
+00017e60: 2069 6e73 7461 6e63 6573 0a40 7079 7465   instances.@pyte
+00017e70: 7374 2e6d 6172 6b2e 6e6f 5f6c 616d 6264  st.mark.no_lambd
+00017e80: 615f 636c 6f75 6420 2023 204c 616d 6264  a_cloud  # Lambd
+00017e90: 6120 436c 6f75 6420 646f 6573 206e 6f74  a Cloud does not
+00017ea0: 2073 7570 706f 7274 2073 706f 7420 696e   support spot in
+00017eb0: 7374 616e 6365 730a 4070 7974 6573 742e  stances.@pytest.
+00017ec0: 6d61 726b 2e6e 6f5f 6962 6d20 2023 2049  mark.no_ibm  # I
+00017ed0: 424d 2043 6c6f 7564 2064 6f65 7320 6e6f  BM Cloud does no
+00017ee0: 7420 7375 7070 6f72 7420 7370 6f74 2069  t support spot i
+00017ef0: 6e73 7461 6e63 6573 0a40 7079 7465 7374  nstances.@pytest
+00017f00: 2e6d 6172 6b2e 6e6f 5f73 6370 2020 2320  .mark.no_scp  # 
+00017f10: 5343 5020 646f 6573 206e 6f74 2073 7570  SCP does not sup
+00017f20: 706f 7274 2073 706f 7420 696e 7374 616e  port spot instan
+00017f30: 6365 730a 4070 7974 6573 742e 6d61 726b  ces.@pytest.mark
+00017f40: 2e6e 6f5f 7061 7065 7273 7061 6365 2020  .no_paperspace  
+00017f50: 2320 5061 7065 7273 7061 6365 2064 6f65  # Paperspace doe
+00017f60: 7320 6e6f 7420 7375 7070 6f72 7420 7370  s not support sp
+00017f70: 6f74 2069 6e73 7461 6e63 6573 0a40 7079  ot instances.@py
+00017f80: 7465 7374 2e6d 6172 6b2e 6e6f 5f6b 7562  test.mark.no_kub
+00017f90: 6572 6e65 7465 7320 2023 204b 7562 6572  ernetes  # Kuber
+00017fa0: 6e65 7465 7320 646f 6573 206e 6f74 2068  netes does not h
+00017fb0: 6176 6520 6120 6e6f 7469 6f6e 206f 6620  ave a notion of 
+00017fc0: 7370 6f74 2069 6e73 7461 6e63 6573 0a40  spot instances.@
+00017fd0: 7079 7465 7374 2e6d 6172 6b2e 6d61 6e61  pytest.mark.mana
+00017fe0: 6765 645f 6a6f 6273 0a64 6566 2074 6573  ged_jobs.def tes
+00017ff0: 745f 6d61 6e61 6765 645f 6a6f 6273 5f66  t_managed_jobs_f
+00018000: 6169 6c65 645f 7365 7475 7028 6765 6e65  ailed_setup(gene
+00018010: 7269 635f 636c 6f75 643a 2073 7472 293a  ric_cloud: str):
+00018020: 0a20 2020 2022 2222 5465 7374 206d 616e  .    """Test man
+00018030: 6167 6564 206a 6f62 2077 6974 6820 6661  aged job with fa
+00018040: 696c 6564 2073 6574 7570 2e22 2222 0a20  iled setup.""". 
+00018050: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
+00018060: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
+00018070: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
+00018080: 2020 2020 2020 2027 6d61 6e61 6765 645f         'managed_
+00018090: 6a6f 6273 5f66 6169 6c65 645f 7365 7475  jobs_failed_setu
+000180a0: 7027 2c0a 2020 2020 2020 2020 5b0a 2020  p',.        [.  
+000180b0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+000180c0: 6a6f 6273 206c 6175 6e63 6820 2d6e 207b  jobs launch -n {
+000180d0: 6e61 6d65 7d20 2d2d 636c 6f75 6420 7b67  name} --cloud {g
+000180e0: 656e 6572 6963 5f63 6c6f 7564 7d20 2d79  eneric_cloud} -y
+000180f0: 202d 6420 7465 7374 732f 7465 7374 5f79   -d tests/test_y
+00018100: 616d 6c73 2f66 6169 6c65 645f 7365 7475  amls/failed_setu
+00018110: 702e 7961 6d6c 272c 0a20 2020 2020 2020  p.yaml',.       
+00018120: 2020 2020 2027 736c 6565 7020 3333 3027       'sleep 330'
+00018130: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
+00018140: 4d61 6b65 2073 7572 6520 7468 6520 6a6f  Make sure the jo
+00018150: 6220 6661 696c 6564 2071 7569 636b 6c79  b failed quickly
+00018160: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
+00018170: 7b5f 4a4f 425f 5155 4555 455f 5741 4954  {_JOB_QUEUE_WAIT
+00018180: 7d20 7c20 6772 6570 207b 6e61 6d65 7d20  } | grep {name} 
+00018190: 7c20 6865 6164 202d 6e31 207c 2067 7265  | head -n1 | gre
+000181a0: 7020 2246 4149 4c45 445f 5345 5455 5022  p "FAILED_SETUP"
+000181b0: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
+000181c0: 2020 2020 2020 5f4a 4f42 5f43 414e 4345        _JOB_CANCE
+000181d0: 4c5f 5741 4954 2e66 6f72 6d61 7428 6a6f  L_WAIT.format(jo
+000181e0: 625f 6e61 6d65 3d6e 616d 6529 2c0a 2020  b_name=name),.  
+000181f0: 2020 2020 2020 2320 496e 6372 6561 7365        # Increase
+00018200: 2074 696d 656f 7574 2073 696e 6365 2073   timeout since s
+00018210: 6b79 206a 6f62 7320 7175 6575 6520 2d72  ky jobs queue -r
+00018220: 2063 616e 2062 6520 626c 6f63 6b65 6420   can be blocked 
+00018230: 6279 206f 7468 6572 2073 706f 7420 7465  by other spot te
+00018240: 7374 732e 0a20 2020 2020 2020 2074 696d  sts..        tim
+00018250: 656f 7574 3d32 3020 2a20 3630 2c0a 2020  eout=20 * 60,.  
+00018260: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
+00018270: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
+00018280: 7465 7374 2e6d 6172 6b2e 6e6f 5f66 6c75  test.mark.no_flu
+00018290: 6964 7374 6163 6b20 2023 666c 7569 6473  idstack  #fluids
+000182a0: 7461 636b 2064 6f65 7320 6e6f 7420 7375  tack does not su
+000182b0: 7070 6f72 7420 7370 6f74 2069 6e73 7461  pport spot insta
+000182c0: 6e63 6573 0a40 7079 7465 7374 2e6d 6172  nces.@pytest.mar
+000182d0: 6b2e 6e6f 5f61 7a75 7265 2020 2320 417a  k.no_azure  # Az
+000182e0: 7572 6520 646f 6573 206e 6f74 2073 7570  ure does not sup
+000182f0: 706f 7274 2073 706f 7420 696e 7374 616e  port spot instan
+00018300: 6365 730a 4070 7974 6573 742e 6d61 726b  ces.@pytest.mark
+00018310: 2e6e 6f5f 6c61 6d62 6461 5f63 6c6f 7564  .no_lambda_cloud
+00018320: 2020 2320 4c61 6d62 6461 2043 6c6f 7564    # Lambda Cloud
+00018330: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
+00018340: 7420 7370 6f74 2069 6e73 7461 6e63 6573  t spot instances
+00018350: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
+00018360: 5f69 626d 2020 2320 4942 4d20 436c 6f75  _ibm  # IBM Clou
+00018370: 6420 646f 6573 206e 6f74 2073 7570 706f  d does not suppo
+00018380: 7274 2073 706f 7420 696e 7374 616e 6365  rt spot instance
+00018390: 730a 4070 7974 6573 742e 6d61 726b 2e6e  s.@pytest.mark.n
+000183a0: 6f5f 7363 7020 2023 2053 4350 2064 6f65  o_scp  # SCP doe
+000183b0: 7320 6e6f 7420 7375 7070 6f72 7420 7370  s not support sp
+000183c0: 6f74 2069 6e73 7461 6e63 6573 0a40 7079  ot instances.@py
+000183d0: 7465 7374 2e6d 6172 6b2e 6e6f 5f70 6170  test.mark.no_pap
+000183e0: 6572 7370 6163 6520 2023 2050 6170 6572  erspace  # Paper
+000183f0: 7370 6163 6520 646f 6573 206e 6f74 2073  space does not s
+00018400: 7570 706f 7274 2073 706f 7420 696e 7374  upport spot inst
+00018410: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
+00018420: 726b 2e6e 6f5f 6b75 6265 726e 6574 6573  rk.no_kubernetes
+00018430: 2020 2320 4b75 6265 726e 6574 6573 2064    # Kubernetes d
+00018440: 6f65 7320 6e6f 7420 6861 7665 2061 206e  oes not have a n
+00018450: 6f74 696f 6e20 6f66 2073 706f 7420 696e  otion of spot in
+00018460: 7374 616e 6365 730a 4070 7974 6573 742e  stances.@pytest.
+00018470: 6d61 726b 2e6d 616e 6167 6564 5f6a 6f62  mark.managed_job
+00018480: 730a 6465 6620 7465 7374 5f6d 616e 6167  s.def test_manag
+00018490: 6564 5f6a 6f62 735f 7069 7065 6c69 6e65  ed_jobs_pipeline
+000184a0: 5f66 6169 6c65 645f 7365 7475 7028 6765  _failed_setup(ge
+000184b0: 6e65 7269 635f 636c 6f75 643a 2073 7472  neric_cloud: str
+000184c0: 293a 0a20 2020 2022 2222 5465 7374 206d  ):.    """Test m
+000184d0: 616e 6167 6564 206a 6f62 2077 6974 6820  anaged job with 
+000184e0: 6661 696c 6564 2073 6574 7570 2066 6f72  failed setup for
+000184f0: 2061 2070 6970 656c 696e 652e 2222 220a   a pipeline.""".
+00018500: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
+00018510: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
+00018520: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
+00018530: 2020 2020 2020 2020 276d 616e 6167 6564          'managed
+00018540: 5f6a 6f62 735f 7069 7065 6c69 6e65 5f66  _jobs_pipeline_f
+00018550: 6169 6c65 645f 7365 7475 7027 2c0a 2020  ailed_setup',.  
+00018560: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+00018570: 2020 2020 6627 736b 7920 6a6f 6273 206c      f'sky jobs l
+00018580: 6175 6e63 6820 2d6e 207b 6e61 6d65 7d20  aunch -n {name} 
+00018590: 2d79 202d 6420 7465 7374 732f 7465 7374  -y -d tests/test
+000185a0: 5f79 616d 6c73 2f66 6169 6c65 645f 7365  _yamls/failed_se
+000185b0: 7475 705f 7069 7065 6c69 6e65 2e79 616d  tup_pipeline.yam
+000185c0: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+000185d0: 2773 6c65 6570 2036 3030 272c 0a20 2020  'sleep 600',.   
+000185e0: 2020 2020 2020 2020 2023 204d 616b 6520           # Make 
+000185f0: 7375 7265 2074 6865 206a 6f62 2066 6169  sure the job fai
+00018600: 6c65 6420 7175 6963 6b6c 792e 0a20 2020  led quickly..   
+00018610: 2020 2020 2020 2020 2066 277b 5f4a 4f42           f'{_JOB
+00018620: 5f51 5545 5545 5f57 4149 547d 207c 2067  _QUEUE_WAIT} | g
+00018630: 7265 7020 7b6e 616d 657d 207c 2068 6561  rep {name} | hea
+00018640: 6420 2d6e 3120 7c20 6772 6570 2022 4641  d -n1 | grep "FA
+00018650: 494c 4544 5f53 4554 5550 2227 2c0a 2020  ILED_SETUP"',.  
+00018660: 2020 2020 2020 2020 2020 2320 5461 736b            # Task
+00018670: 2030 2073 686f 756c 6420 6265 2053 5543   0 should be SUC
+00018680: 4345 4544 4544 2e0a 2020 2020 2020 2020  CEEDED..        
+00018690: 2020 2020 6627 7b5f 4a4f 425f 5155 4555      f'{_JOB_QUEU
+000186a0: 455f 5741 4954 7d20 7c20 6772 6570 202d  E_WAIT} | grep -
+000186b0: 4120 3420 7b6e 616d 657d 7c20 7365 6420  A 4 {name}| sed 
+000186c0: 2d6e 2032 7020 7c20 6772 6570 2022 5355  -n 2p | grep "SU
+000186d0: 4343 4545 4445 4422 272c 0a20 2020 2020  CCEEDED"',.     
+000186e0: 2020 2020 2020 2023 2054 6173 6b20 3120         # Task 1 
+000186f0: 7368 6f75 6c64 2062 6520 4641 494c 4544  should be FAILED
+00018700: 5f53 4554 5550 2e0a 2020 2020 2020 2020  _SETUP..        
+00018710: 2020 2020 6627 7b5f 4a4f 425f 5155 4555      f'{_JOB_QUEU
+00018720: 455f 5741 4954 7d20 7c20 6772 6570 202d  E_WAIT} | grep -
+00018730: 4120 3420 7b6e 616d 657d 7c20 7365 6420  A 4 {name}| sed 
+00018740: 2d6e 2033 7020 7c20 6772 6570 2022 4641  -n 3p | grep "FA
+00018750: 494c 4544 5f53 4554 5550 2227 2c0a 2020  ILED_SETUP"',.  
+00018760: 2020 2020 2020 2020 2020 2320 5461 736b            # Task
+00018770: 2032 2073 686f 756c 6420 6265 2043 414e   2 should be CAN
+00018780: 4345 4c4c 4544 2e0a 2020 2020 2020 2020  CELLED..        
+00018790: 2020 2020 6627 7b5f 4a4f 425f 5155 4555      f'{_JOB_QUEU
+000187a0: 455f 5741 4954 7d20 7c20 6772 6570 202d  E_WAIT} | grep -
+000187b0: 4120 3420 7b6e 616d 657d 7c20 7365 6420  A 4 {name}| sed 
+000187c0: 2d6e 2034 7020 7c20 6772 6570 2022 4341  -n 4p | grep "CA
+000187d0: 4e43 454c 4c45 4422 272c 0a20 2020 2020  NCELLED"',.     
+000187e0: 2020 2020 2020 2023 2054 6173 6b20 3320         # Task 3 
+000187f0: 7368 6f75 6c64 2062 6520 4341 4e43 454c  should be CANCEL
+00018800: 4c45 442e 0a20 2020 2020 2020 2020 2020  LED..           
+00018810: 2066 277b 5f4a 4f42 5f51 5545 5545 5f57   f'{_JOB_QUEUE_W
+00018820: 4149 547d 207c 2067 7265 7020 2d41 2034  AIT} | grep -A 4
+00018830: 207b 6e61 6d65 7d7c 2073 6564 202d 6e20   {name}| sed -n 
+00018840: 3570 207c 2067 7265 7020 2243 414e 4345  5p | grep "CANCE
+00018850: 4c4c 4544 2227 2c0a 2020 2020 2020 2020  LLED"',.        
+00018860: 5d2c 0a20 2020 2020 2020 205f 4a4f 425f  ],.        _JOB_
+00018870: 4341 4e43 454c 5f57 4149 542e 666f 726d  CANCEL_WAIT.form
+00018880: 6174 286a 6f62 5f6e 616d 653d 6e61 6d65  at(job_name=name
+00018890: 292c 0a20 2020 2020 2020 2023 2049 6e63  ),.        # Inc
+000188a0: 7265 6173 6520 7469 6d65 6f75 7420 7369  rease timeout si
+000188b0: 6e63 6520 736b 7920 6a6f 6273 2071 7565  nce sky jobs que
+000188c0: 7565 202d 7220 6361 6e20 6265 2062 6c6f  ue -r can be blo
+000188d0: 636b 6564 2062 7920 6f74 6865 7220 7370  cked by other sp
+000188e0: 6f74 2074 6573 7473 2e0a 2020 2020 2020  ot tests..      
+000188f0: 2020 7469 6d65 6f75 743d 3330 202a 2036    timeout=30 * 6
+00018900: 302c 0a20 2020 2029 0a20 2020 2072 756e  0,.    ).    run
+00018910: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
+00018920: 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054  ..# ---------- T
+00018930: 6573 7469 6e67 206d 616e 6167 6564 206a  esting managed j
+00018940: 6f62 2072 6563 6f76 6572 7920 2d2d 2d2d  ob recovery ----
+00018950: 2d2d 2d2d 2d2d 0a0a 0a40 7079 7465 7374  ------...@pytest
+00018960: 2e6d 6172 6b2e 6177 730a 4070 7974 6573  .mark.aws.@pytes
+00018970: 742e 6d61 726b 2e6d 616e 6167 6564 5f6a  t.mark.managed_j
+00018980: 6f62 730a 6465 6620 7465 7374 5f6d 616e  obs.def test_man
+00018990: 6167 6564 5f6a 6f62 735f 7265 636f 7665  aged_jobs_recove
+000189a0: 7279 5f61 7773 2861 7773 5f63 6f6e 6669  ry_aws(aws_confi
+000189b0: 675f 7265 6769 6f6e 293a 0a20 2020 2022  g_region):.    "
+000189c0: 2222 5465 7374 206d 616e 6167 6564 206a  ""Test managed j
+000189d0: 6f62 2072 6563 6f76 6572 792e 2222 220a  ob recovery.""".
+000189e0: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
+000189f0: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
+00018a00: 2020 206e 616d 655f 6f6e 5f63 6c6f 7564     name_on_cloud
+00018a10: 203d 2063 6f6d 6d6f 6e5f 7574 696c 732e   = common_utils.
+00018a20: 6d61 6b65 5f63 6c75 7374 6572 5f6e 616d  make_cluster_nam
+00018a30: 655f 6f6e 5f63 6c6f 7564 280a 2020 2020  e_on_cloud(.    
+00018a40: 2020 2020 6e61 6d65 2c20 6a6f 6273 2e4a      name, jobs.J
+00018a50: 4f42 535f 434c 5553 5445 525f 4e41 4d45  OBS_CLUSTER_NAME
+00018a60: 5f50 5245 4649 585f 4c45 4e47 5448 2c20  _PREFIX_LENGTH, 
+00018a70: 6164 645f 7573 6572 5f68 6173 683d 4661  add_user_hash=Fa
+00018a80: 6c73 6529 0a20 2020 2072 6567 696f 6e20  lse).    region 
+00018a90: 3d20 6177 735f 636f 6e66 6967 5f72 6567  = aws_config_reg
+00018aa0: 696f 6e0a 2020 2020 7465 7374 203d 2054  ion.    test = T
+00018ab0: 6573 7428 0a20 2020 2020 2020 2027 6d61  est(.        'ma
+00018ac0: 6e61 6765 645f 6a6f 6273 5f72 6563 6f76  naged_jobs_recov
+00018ad0: 6572 795f 6177 7327 2c0a 2020 2020 2020  ery_aws',.      
+00018ae0: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
+00018af0: 6627 736b 7920 6a6f 6273 206c 6175 6e63  f'sky jobs launc
+00018b00: 6820 2d2d 636c 6f75 6420 6177 7320 2d2d  h --cloud aws --
+00018b10: 7265 6769 6f6e 207b 7265 6769 6f6e 7d20  region {region} 
+00018b20: 2d2d 7573 652d 7370 6f74 202d 6e20 7b6e  --use-spot -n {n
+00018b30: 616d 657d 2022 6563 686f 2053 4b59 5049  ame} "echo SKYPI
+00018b40: 4c4f 545f 5441 534b 5f49 443a 205c 2453  LOT_TASK_ID: \$S
+00018b50: 4b59 5049 4c4f 545f 5441 534b 5f49 443b  KYPILOT_TASK_ID;
+00018b60: 2073 6c65 6570 2031 3830 3022 2020 2d79   sleep 1800"  -y
+00018b70: 202d 6427 2c0a 2020 2020 2020 2020 2020   -d',.          
+00018b80: 2020 2773 6c65 6570 2033 3630 272c 0a20    'sleep 360',. 
+00018b90: 2020 2020 2020 2020 2020 2066 277b 5f4a             f'{_J
+00018ba0: 4f42 5f51 5545 5545 5f57 4149 547d 7c20  OB_QUEUE_WAIT}| 
+00018bb0: 6772 6570 207b 6e61 6d65 7d20 7c20 6865  grep {name} | he
+00018bc0: 6164 202d 6e31 207c 2067 7265 7020 2252  ad -n1 | grep "R
+00018bd0: 554e 4e49 4e47 2227 2c0a 2020 2020 2020  UNNING"',.      
+00018be0: 2020 2020 2020 6627 5255 4e5f 4944 3d24        f'RUN_ID=$
+00018bf0: 2873 6b79 206a 6f62 7320 6c6f 6773 202d  (sky jobs logs -
+00018c00: 6e20 7b6e 616d 657d 202d 2d6e 6f2d 666f  n {name} --no-fo
+00018c10: 6c6c 6f77 207c 2067 7265 7020 534b 5950  llow | grep SKYP
+00018c20: 494c 4f54 5f54 4153 4b5f 4944 207c 2063  ILOT_TASK_ID | c
+00018c30: 7574 202d 643a 202d 6632 293b 2065 6368  ut -d: -f2); ech
+00018c40: 6f20 2224 5255 4e5f 4944 2220 7c20 7465  o "$RUN_ID" | te
+00018c50: 6520 2f74 6d70 2f7b 6e61 6d65 7d2d 7275  e /tmp/{name}-ru
+00018c60: 6e2d 6964 272c 0a20 2020 2020 2020 2020  n-id',.         
+00018c70: 2020 2023 2054 6572 6d69 6e61 7465 2074     # Terminate t
+00018c80: 6865 2063 6c75 7374 6572 206d 616e 7561  he cluster manua
+00018c90: 6c6c 792e 0a20 2020 2020 2020 2020 2020  lly..           
+00018ca0: 2028 6627 6177 7320 6563 3220 7465 726d   (f'aws ec2 term
+00018cb0: 696e 6174 652d 696e 7374 616e 6365 7320  inate-instances 
+00018cc0: 2d2d 7265 6769 6f6e 207b 7265 6769 6f6e  --region {region
+00018cd0: 7d20 2d2d 696e 7374 616e 6365 2d69 6473  } --instance-ids
+00018ce0: 2024 2827 0a20 2020 2020 2020 2020 2020   $('.           
+00018cf0: 2020 6627 6177 7320 6563 3220 6465 7363    f'aws ec2 desc
+00018d00: 7269 6265 2d69 6e73 7461 6e63 6573 202d  ribe-instances -
+00018d10: 2d72 6567 696f 6e20 7b72 6567 696f 6e7d  -region {region}
+00018d20: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+00018d30: 6627 2d2d 6669 6c74 6572 7320 4e61 6d65  f'--filters Name
+00018d40: 3d74 6167 3a72 6179 2d63 6c75 7374 6572  =tag:ray-cluster
+00018d50: 2d6e 616d 652c 5661 6c75 6573 3d7b 6e61  -name,Values={na
+00018d60: 6d65 5f6f 6e5f 636c 6f75 647d 2a20 270a  me_on_cloud}* '.
+00018d70: 2020 2020 2020 2020 2020 2020 2066 272d               f'-
+00018d80: 2d71 7565 7279 2052 6573 6572 7661 7469  -query Reservati
+00018d90: 6f6e 735b 5d2e 496e 7374 616e 6365 735b  ons[].Instances[
+00018da0: 5d2e 496e 7374 616e 6365 4964 2027 0a20  ].InstanceId '. 
+00018db0: 2020 2020 2020 2020 2020 2020 272d 2d6f              '--o
+00018dc0: 7574 7075 7420 7465 7874 2927 292c 0a20  utput text)'),. 
+00018dd0: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+00018de0: 7020 3130 3027 2c0a 2020 2020 2020 2020  p 100',.        
+00018df0: 2020 2020 6627 7b5f 4a4f 425f 5155 4555      f'{_JOB_QUEU
+00018e00: 455f 5741 4954 7d7c 2067 7265 7020 7b6e  E_WAIT}| grep {n
+00018e10: 616d 657d 207c 2068 6561 6420 2d6e 3120  ame} | head -n1 
+00018e20: 7c20 6772 6570 2022 5245 434f 5645 5249  | grep "RECOVERI
+00018e30: 4e47 2227 2c0a 2020 2020 2020 2020 2020  NG"',.          
+00018e40: 2020 2773 6c65 6570 2032 3030 272c 0a20    'sleep 200',. 
+00018e50: 2020 2020 2020 2020 2020 2066 277b 5f4a             f'{_J
+00018e60: 4f42 5f51 5545 5545 5f57 4149 547d 7c20  OB_QUEUE_WAIT}| 
+00018e70: 6772 6570 207b 6e61 6d65 7d20 7c20 6865  grep {name} | he
+00018e80: 6164 202d 6e31 207c 2067 7265 7020 2252  ad -n1 | grep "R
+00018e90: 554e 4e49 4e47 2227 2c0a 2020 2020 2020  UNNING"',.      
+00018ea0: 2020 2020 2020 6627 5255 4e5f 4944 3d24        f'RUN_ID=$
+00018eb0: 2863 6174 202f 746d 702f 7b6e 616d 657d  (cat /tmp/{name}
+00018ec0: 2d72 756e 2d69 6429 3b20 6563 686f 2022  -run-id); echo "
+00018ed0: 2452 554e 5f49 4422 3b20 736b 7920 6a6f  $RUN_ID"; sky jo
+00018ee0: 6273 206c 6f67 7320 2d6e 207b 6e61 6d65  bs logs -n {name
+00018ef0: 7d20 2d2d 6e6f 2d66 6f6c 6c6f 7720 7c20  } --no-follow | 
+00018f00: 6772 6570 2053 4b59 5049 4c4f 545f 5441  grep SKYPILOT_TA
+00018f10: 534b 5f49 4420 7c20 6772 6570 2022 2452  SK_ID | grep "$R
+00018f20: 554e 5f49 4422 272c 0a20 2020 2020 2020  UN_ID"',.       
+00018f30: 205d 2c0a 2020 2020 2020 2020 5f4a 4f42   ],.        _JOB
+00018f40: 5f43 414e 4345 4c5f 5741 4954 2e66 6f72  _CANCEL_WAIT.for
+00018f50: 6d61 7428 6a6f 625f 6e61 6d65 3d6e 616d  mat(job_name=nam
+00018f60: 6529 2c0a 2020 2020 2020 2020 7469 6d65  e),.        time
+00018f70: 6f75 743d 3235 202a 2036 302c 0a20 2020  out=25 * 60,.   
+00018f80: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
+00018f90: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
+00018fa0: 6573 742e 6d61 726b 2e67 6370 0a40 7079  est.mark.gcp.@py
+00018fb0: 7465 7374 2e6d 6172 6b2e 6d61 6e61 6765  test.mark.manage
+00018fc0: 645f 6a6f 6273 0a64 6566 2074 6573 745f  d_jobs.def test_
+00018fd0: 6d61 6e61 6765 645f 6a6f 6273 5f72 6563  managed_jobs_rec
+00018fe0: 6f76 6572 795f 6763 7028 293a 0a20 2020  overy_gcp():.   
+00018ff0: 2022 2222 5465 7374 206d 616e 6167 6564   """Test managed
+00019000: 206a 6f62 2072 6563 6f76 6572 792e 2222   job recovery.""
+00019010: 220a 2020 2020 6e61 6d65 203d 205f 6765  ".    name = _ge
+00019020: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
+00019030: 0a20 2020 206e 616d 655f 6f6e 5f63 6c6f  .    name_on_clo
+00019040: 7564 203d 2063 6f6d 6d6f 6e5f 7574 696c  ud = common_util
+00019050: 732e 6d61 6b65 5f63 6c75 7374 6572 5f6e  s.make_cluster_n
+00019060: 616d 655f 6f6e 5f63 6c6f 7564 280a 2020  ame_on_cloud(.  
+00019070: 2020 2020 2020 6e61 6d65 2c20 6a6f 6273        name, jobs
+00019080: 2e4a 4f42 535f 434c 5553 5445 525f 4e41  .JOBS_CLUSTER_NA
+00019090: 4d45 5f50 5245 4649 585f 4c45 4e47 5448  ME_PREFIX_LENGTH
+000190a0: 2c20 6164 645f 7573 6572 5f68 6173 683d  , add_user_hash=
+000190b0: 4661 6c73 6529 0a20 2020 207a 6f6e 6520  False).    zone 
+000190c0: 3d20 2775 732d 6561 7374 342d 6227 0a20  = 'us-east4-b'. 
+000190d0: 2020 2071 7565 7279 5f63 6d64 203d 2028     query_cmd = (
+000190e0: 0a20 2020 2020 2020 2066 2767 636c 6f75  .        f'gclou
+000190f0: 6420 636f 6d70 7574 6520 696e 7374 616e  d compute instan
+00019100: 6365 7320 6c69 7374 202d 2d66 696c 7465  ces list --filte
+00019110: 723d 270a 2020 2020 2020 2020 2320 603a  r='.        # `:
+00019120: 6020 6d65 616e 7320 7072 6566 6978 206d  ` means prefix m
+00019130: 6174 6368 2e0a 2020 2020 2020 2020 6627  atch..        f'
+00019140: 2228 6c61 6265 6c73 2e72 6179 2d63 6c75  "(labels.ray-clu
+00019150: 7374 6572 2d6e 616d 653a 7b6e 616d 655f  ster-name:{name_
+00019160: 6f6e 5f63 6c6f 7564 7d29 2220 270a 2020  on_cloud})" '.  
+00019170: 2020 2020 2020 6627 2d2d 7a6f 6e65 733d        f'--zones=
+00019180: 7b7a 6f6e 657d 202d 2d66 6f72 6d61 743d  {zone} --format=
+00019190: 2276 616c 7565 286e 616d 6529 2227 290a  "value(name)"').
+000191a0: 2020 2020 7465 726d 696e 6174 655f 636d      terminate_cm
+000191b0: 6420 3d20 2866 2767 636c 6f75 6420 636f  d = (f'gcloud co
+000191c0: 6d70 7574 6520 696e 7374 616e 6365 7320  mpute instances 
+000191d0: 6465 6c65 7465 202d 2d7a 6f6e 653d 7b7a  delete --zone={z
+000191e0: 6f6e 657d 270a 2020 2020 2020 2020 2020  one}'.          
+000191f0: 2020 2020 2020 2020 2020 2066 2720 2d2d             f' --
+00019200: 7175 6965 7420 2428 7b71 7565 7279 5f63  quiet $({query_c
+00019210: 6d64 7d29 2729 0a20 2020 2074 6573 7420  md})').    test 
+00019220: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+00019230: 276d 616e 6167 6564 5f6a 6f62 735f 7265  'managed_jobs_re
+00019240: 636f 7665 7279 5f67 6370 272c 0a20 2020  covery_gcp',.   
+00019250: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
+00019260: 2020 2066 2773 6b79 206a 6f62 7320 6c61     f'sky jobs la
+00019270: 756e 6368 202d 2d63 6c6f 7564 2067 6370  unch --cloud gcp
+00019280: 202d 2d7a 6f6e 6520 7b7a 6f6e 657d 202d   --zone {zone} -
+00019290: 6e20 7b6e 616d 657d 202d 2d75 7365 2d73  n {name} --use-s
+000192a0: 706f 7420 2d2d 6370 7573 2032 2022 6563  pot --cpus 2 "ec
+000192b0: 686f 2053 4b59 5049 4c4f 545f 5441 534b  ho SKYPILOT_TASK
+000192c0: 5f49 443a 205c 2453 4b59 5049 4c4f 545f  _ID: \$SKYPILOT_
+000192d0: 5441 534b 5f49 443b 2073 6c65 6570 2031  TASK_ID; sleep 1
+000192e0: 3830 3022 2020 2d79 202d 6427 2c0a 2020  800"  -y -d',.  
+000192f0: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
+00019300: 2033 3630 272c 0a20 2020 2020 2020 2020   360',.         
+00019310: 2020 2066 277b 5f4a 4f42 5f51 5545 5545     f'{_JOB_QUEUE
+00019320: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
+00019330: 6d65 7d20 7c20 6865 6164 202d 6e31 207c  me} | head -n1 |
+00019340: 2067 7265 7020 2252 554e 4e49 4e47 2227   grep "RUNNING"'
+00019350: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00019360: 5255 4e5f 4944 3d24 2873 6b79 206a 6f62  RUN_ID=$(sky job
+00019370: 7320 6c6f 6773 202d 6e20 7b6e 616d 657d  s logs -n {name}
+00019380: 202d 2d6e 6f2d 666f 6c6c 6f77 207c 2067   --no-follow | g
+00019390: 7265 7020 534b 5950 494c 4f54 5f54 4153  rep SKYPILOT_TAS
+000193a0: 4b5f 4944 207c 2063 7574 202d 643a 202d  K_ID | cut -d: -
+000193b0: 6632 293b 2065 6368 6f20 2224 5255 4e5f  f2); echo "$RUN_
+000193c0: 4944 2220 7c20 7465 6520 2f74 6d70 2f7b  ID" | tee /tmp/{
+000193d0: 6e61 6d65 7d2d 7275 6e2d 6964 272c 0a20  name}-run-id',. 
+000193e0: 2020 2020 2020 2020 2020 2023 2054 6572             # Ter
+000193f0: 6d69 6e61 7465 2074 6865 2063 6c75 7374  minate the clust
+00019400: 6572 206d 616e 7561 6c6c 792e 0a20 2020  er manually..   
+00019410: 2020 2020 2020 2020 2074 6572 6d69 6e61           termina
+00019420: 7465 5f63 6d64 2c0a 2020 2020 2020 2020  te_cmd,.        
+00019430: 2020 2020 2773 6c65 6570 2036 3027 2c0a      'sleep 60',.
+00019440: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
+00019450: 4a4f 425f 5155 4555 455f 5741 4954 7d7c  JOB_QUEUE_WAIT}|
+00019460: 2067 7265 7020 7b6e 616d 657d 207c 2068   grep {name} | h
+00019470: 6561 6420 2d6e 3120 7c20 6772 6570 2022  ead -n1 | grep "
+00019480: 5245 434f 5645 5249 4e47 2227 2c0a 2020  RECOVERING"',.  
+00019490: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
+000194a0: 2032 3030 272c 0a20 2020 2020 2020 2020   200',.         
+000194b0: 2020 2066 277b 5f4a 4f42 5f51 5545 5545     f'{_JOB_QUEUE
+000194c0: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
+000194d0: 6d65 7d20 7c20 6865 6164 202d 6e31 207c  me} | head -n1 |
+000194e0: 2067 7265 7020 2252 554e 4e49 4e47 2227   grep "RUNNING"'
+000194f0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00019500: 5255 4e5f 4944 3d24 2863 6174 202f 746d  RUN_ID=$(cat /tm
+00019510: 702f 7b6e 616d 657d 2d72 756e 2d69 6429  p/{name}-run-id)
+00019520: 3b20 6563 686f 2022 2452 554e 5f49 4422  ; echo "$RUN_ID"
+00019530: 3b20 736b 7920 6a6f 6273 206c 6f67 7320  ; sky jobs logs 
+00019540: 2d6e 207b 6e61 6d65 7d20 2d2d 6e6f 2d66  -n {name} --no-f
+00019550: 6f6c 6c6f 7720 7c20 6772 6570 2053 4b59  ollow | grep SKY
+00019560: 5049 4c4f 545f 5441 534b 5f49 443a 207c  PILOT_TASK_ID: |
+00019570: 2067 7265 7020 2224 5255 4e5f 4944 2227   grep "$RUN_ID"'
+00019580: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
+00019590: 2020 2020 205f 4a4f 425f 4341 4e43 454c       _JOB_CANCEL
+000195a0: 5f57 4149 542e 666f 726d 6174 286a 6f62  _WAIT.format(job
+000195b0: 5f6e 616d 653d 6e61 6d65 292c 0a20 2020  _name=name),.   
+000195c0: 2020 2020 2074 696d 656f 7574 3d32 3520       timeout=25 
+000195d0: 2a20 3630 2c0a 2020 2020 290a 2020 2020  * 60,.    ).    
+000195e0: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
+000195f0: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
+00019600: 6b2e 6177 730a 4070 7974 6573 742e 6d61  k.aws.@pytest.ma
+00019610: 726b 2e6d 616e 6167 6564 5f6a 6f62 730a  rk.managed_jobs.
+00019620: 6465 6620 7465 7374 5f6d 616e 6167 6564  def test_managed
+00019630: 5f6a 6f62 735f 7069 7065 6c69 6e65 5f72  _jobs_pipeline_r
+00019640: 6563 6f76 6572 795f 6177 7328 6177 735f  ecovery_aws(aws_
+00019650: 636f 6e66 6967 5f72 6567 696f 6e29 3a0a  config_region):.
+00019660: 2020 2020 2222 2254 6573 7420 6d61 6e61      """Test mana
+00019670: 6765 6420 6a6f 6220 7265 636f 7665 7279  ged job recovery
+00019680: 2066 6f72 2061 2070 6970 656c 696e 652e   for a pipeline.
+00019690: 2222 220a 2020 2020 6e61 6d65 203d 205f  """.    name = _
+000196a0: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
+000196b0: 2829 0a20 2020 2075 7365 725f 6861 7368  ().    user_hash
+000196c0: 203d 2063 6f6d 6d6f 6e5f 7574 696c 732e   = common_utils.
+000196d0: 6765 745f 7573 6572 5f68 6173 6828 290a  get_user_hash().
+000196e0: 2020 2020 7573 6572 5f68 6173 6820 3d20      user_hash = 
+000196f0: 7573 6572 5f68 6173 685b 3a63 6f6d 6d6f  user_hash[:commo
+00019700: 6e5f 7574 696c 732e 5553 4552 5f48 4153  n_utils.USER_HAS
+00019710: 485f 4c45 4e47 5448 5f49 4e5f 434c 5553  H_LENGTH_IN_CLUS
+00019720: 5445 525f 4e41 4d45 5d0a 2020 2020 7265  TER_NAME].    re
+00019730: 6769 6f6e 203d 2061 7773 5f63 6f6e 6669  gion = aws_confi
+00019740: 675f 7265 6769 6f6e 0a20 2020 2069 6620  g_region.    if 
+00019750: 7265 6769 6f6e 2021 3d20 2775 732d 6561  region != 'us-ea
+00019760: 7374 2d32 273a 0a20 2020 2020 2020 2070  st-2':.        p
+00019770: 7974 6573 742e 736b 6970 2827 4f6e 6c79  ytest.skip('Only
+00019780: 2072 756e 2073 706f 7420 7069 7065 6c69   run spot pipeli
+00019790: 6e65 2072 6563 6f76 6572 7920 7465 7374  ne recovery test
+000197a0: 2069 6e20 7573 2d65 6173 742d 3227 290a   in us-east-2').
+000197b0: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
+000197c0: 0a20 2020 2020 2020 2027 6d61 6e61 6765  .        'manage
+000197d0: 645f 6a6f 6273 5f70 6970 656c 696e 655f  d_jobs_pipeline_
+000197e0: 7265 636f 7665 7279 5f61 7773 272c 0a20  recovery_aws',. 
+000197f0: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
+00019800: 2020 2020 2066 2773 6b79 206a 6f62 7320       f'sky jobs 
+00019810: 6c61 756e 6368 202d 6e20 7b6e 616d 657d  launch -n {name}
+00019820: 2074 6573 7473 2f74 6573 745f 7961 6d6c   tests/test_yaml
+00019830: 732f 7069 7065 6c69 6e65 5f61 7773 2e79  s/pipeline_aws.y
+00019840: 616d 6c20 202d 7920 2d64 272c 0a20 2020  aml  -y -d',.   
+00019850: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
+00019860: 3430 3027 2c0a 2020 2020 2020 2020 2020  400',.          
+00019870: 2020 6627 7b5f 4a4f 425f 5155 4555 455f    f'{_JOB_QUEUE_
+00019880: 5741 4954 7d7c 2067 7265 7020 7b6e 616d  WAIT}| grep {nam
+00019890: 657d 207c 2068 6561 6420 2d6e 3120 7c20  e} | head -n1 | 
+000198a0: 6772 6570 2022 5255 4e4e 494e 4722 272c  grep "RUNNING"',
+000198b0: 0a20 2020 2020 2020 2020 2020 2066 2752  .            f'R
+000198c0: 554e 5f49 443d 2428 736b 7920 6a6f 6273  UN_ID=$(sky jobs
+000198d0: 206c 6f67 7320 2d6e 207b 6e61 6d65 7d20   logs -n {name} 
+000198e0: 2d2d 6e6f 2d66 6f6c 6c6f 7720 7c20 6772  --no-follow | gr
+000198f0: 6570 2053 4b59 5049 4c4f 545f 5441 534b  ep SKYPILOT_TASK
+00019900: 5f49 443a 207c 2063 7574 202d 643a 202d  _ID: | cut -d: -
+00019910: 6632 293b 2065 6368 6f20 2224 5255 4e5f  f2); echo "$RUN_
+00019920: 4944 2220 7c20 7465 6520 2f74 6d70 2f7b  ID" | tee /tmp/{
+00019930: 6e61 6d65 7d2d 7275 6e2d 6964 272c 0a20  name}-run-id',. 
+00019940: 2020 2020 2020 2020 2020 2066 2752 554e             f'RUN
+00019950: 5f49 4453 3d24 2873 6b79 206a 6f62 7320  _IDS=$(sky jobs 
+00019960: 6c6f 6773 202d 6e20 7b6e 616d 657d 202d  logs -n {name} -
+00019970: 2d6e 6f2d 666f 6c6c 6f77 207c 2067 7265  -no-follow | gre
+00019980: 7020 2d41 2034 2053 4b59 5049 4c4f 545f  p -A 4 SKYPILOT_
+00019990: 5441 534b 5f49 4453 207c 2063 7574 202d  TASK_IDS | cut -
+000199a0: 6422 2922 202d 6632 293b 2065 6368 6f20  d")" -f2); echo 
+000199b0: 2224 5255 4e5f 4944 5322 207c 2074 6565  "$RUN_IDS" | tee
+000199c0: 202f 746d 702f 7b6e 616d 657d 2d72 756e   /tmp/{name}-run
+000199d0: 2d69 6473 272c 0a20 2020 2020 2020 2020  -ids',.         
+000199e0: 2020 2023 2054 6572 6d69 6e61 7465 2074     # Terminate t
+000199f0: 6865 2063 6c75 7374 6572 206d 616e 7561  he cluster manua
+00019a00: 6c6c 792e 0a20 2020 2020 2020 2020 2020  lly..           
+00019a10: 2023 2054 6865 2060 6361 7420 2e2e 2e7c   # The `cat ...|
+00019a20: 2072 6576 6020 6973 2074 6f20 7265 7472   rev` is to retr
+00019a30: 6965 7665 2074 6865 206a 6f62 5f69 6420  ieve the job_id 
+00019a40: 6672 6f6d 2074 6865 0a20 2020 2020 2020  from the.       
+00019a50: 2020 2020 2023 2053 4b59 5049 4c4f 545f       # SKYPILOT_
+00019a60: 5441 534b 5f49 442c 2077 6869 6368 2067  TASK_ID, which g
+00019a70: 6574 7320 7468 6520 7365 636f 6e64 2074  ets the second t
+00019a80: 6f20 6c61 7374 2066 6965 6c64 0a20 2020  o last field.   
+00019a90: 2020 2020 2020 2020 2023 2073 6570 6172           # separ
+00019aa0: 6174 6564 2062 7920 602d 602e 0a20 2020  ated by `-`..   
+00019ab0: 2020 2020 2020 2020 2028 0a20 2020 2020           (.     
+00019ac0: 2020 2020 2020 2020 2020 2066 274d 414e             f'MAN
+00019ad0: 4147 4544 5f4a 4f42 5f49 443d 6063 6174  AGED_JOB_ID=`cat
+00019ae0: 202f 746d 702f 7b6e 616d 657d 2d72 756e   /tmp/{name}-run
+00019af0: 2d69 6420 7c20 7265 7620 7c20 270a 2020  -id | rev | '.  
+00019b00: 2020 2020 2020 2020 2020 2020 2020 2763                'c
+00019b10: 7574 202d 645c 275f 5c27 202d 6631 207c  ut -d\'_\' -f1 |
+00019b20: 2072 6576 207c 2063 7574 202d 645c 272d   rev | cut -d\'-
+00019b30: 5c27 202d 6631 603b 270a 2020 2020 2020  \' -f1`;'.      
+00019b40: 2020 2020 2020 2020 2020 6627 6177 7320            f'aws 
+00019b50: 6563 3220 7465 726d 696e 6174 652d 696e  ec2 terminate-in
+00019b60: 7374 616e 6365 7320 2d2d 7265 6769 6f6e  stances --region
+00019b70: 207b 7265 6769 6f6e 7d20 2d2d 696e 7374   {region} --inst
+00019b80: 616e 6365 2d69 6473 2024 2827 0a20 2020  ance-ids $('.   
+00019b90: 2020 2020 2020 2020 2020 2020 2066 2761               f'a
+00019ba0: 7773 2065 6332 2064 6573 6372 6962 652d  ws ec2 describe-
+00019bb0: 696e 7374 616e 6365 7320 2d2d 7265 6769  instances --regi
+00019bc0: 6f6e 207b 7265 6769 6f6e 7d20 270a 2020  on {region} '.  
+00019bd0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00019be0: 544f 444f 287a 6877 7529 3a20 6669 7820  TODO(zhwu): fix 
+00019bf0: 7468 6520 6e61 6d65 2066 6f72 2073 706f  the name for spo
+00019c00: 7420 636c 7573 7465 722e 0a20 2020 2020  t cluster..     
+00019c10: 2020 2020 2020 2020 2020 2027 2d2d 6669             '--fi
+00019c20: 6c74 6572 7320 4e61 6d65 3d74 6167 3a72  lters Name=tag:r
+00019c30: 6179 2d63 6c75 7374 6572 2d6e 616d 652c  ay-cluster-name,
+00019c40: 5661 6c75 6573 3d2a 2d24 7b4d 414e 4147  Values=*-${MANAG
+00019c50: 4544 5f4a 4f42 5f49 447d 270a 2020 2020  ED_JOB_ID}'.    
+00019c60: 2020 2020 2020 2020 2020 2020 6627 2d7b              f'-{
+00019c70: 7573 6572 5f68 6173 687d 2027 0a20 2020  user_hash} '.   
+00019c80: 2020 2020 2020 2020 2020 2020 2066 272d               f'-
+00019c90: 2d71 7565 7279 2052 6573 6572 7661 7469  -query Reservati
+00019ca0: 6f6e 735b 5d2e 496e 7374 616e 6365 735b  ons[].Instances[
+00019cb0: 5d2e 496e 7374 616e 6365 4964 2027 0a20  ].InstanceId '. 
+00019cc0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00019cd0: 2d2d 6f75 7470 7574 2074 6578 7429 2729  --output text)')
+00019ce0: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
+00019cf0: 6c65 6570 2031 3030 272c 0a20 2020 2020  leep 100',.     
+00019d00: 2020 2020 2020 2066 277b 5f4a 4f42 5f51         f'{_JOB_Q
+00019d10: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
+00019d20: 207b 6e61 6d65 7d20 7c20 6865 6164 202d   {name} | head -
+00019d30: 6e31 207c 2067 7265 7020 2252 4543 4f56  n1 | grep "RECOV
+00019d40: 4552 494e 4722 272c 0a20 2020 2020 2020  ERING"',.       
+00019d50: 2020 2020 2027 736c 6565 7020 3230 3027       'sleep 200'
+00019d60: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00019d70: 7b5f 4a4f 425f 5155 4555 455f 5741 4954  {_JOB_QUEUE_WAIT
+00019d80: 7d7c 2067 7265 7020 7b6e 616d 657d 207c  }| grep {name} |
+00019d90: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
+00019da0: 2022 5255 4e4e 494e 4722 272c 0a20 2020   "RUNNING"',.   
+00019db0: 2020 2020 2020 2020 2066 2752 554e 5f49           f'RUN_I
+00019dc0: 443d 2428 6361 7420 2f74 6d70 2f7b 6e61  D=$(cat /tmp/{na
+00019dd0: 6d65 7d2d 7275 6e2d 6964 293b 2065 6368  me}-run-id); ech
+00019de0: 6f20 2452 554e 5f49 443b 2073 6b79 206a  o $RUN_ID; sky j
+00019df0: 6f62 7320 6c6f 6773 202d 6e20 7b6e 616d  obs logs -n {nam
+00019e00: 657d 202d 2d6e 6f2d 666f 6c6c 6f77 207c  e} --no-follow |
+00019e10: 2067 7265 7020 534b 5950 494c 4f54 5f54   grep SKYPILOT_T
+00019e20: 4153 4b5f 4944 3a20 7c20 6772 6570 2022  ASK_ID: | grep "
+00019e30: 2452 554e 5f49 4422 272c 0a20 2020 2020  $RUN_ID"',.     
+00019e40: 2020 2020 2020 2066 2752 554e 5f49 4453         f'RUN_IDS
+00019e50: 3d24 2873 6b79 206a 6f62 7320 6c6f 6773  =$(sky jobs logs
+00019e60: 202d 6e20 7b6e 616d 657d 202d 2d6e 6f2d   -n {name} --no-
+00019e70: 666f 6c6c 6f77 207c 2067 7265 7020 2d41  follow | grep -A
+00019e80: 2034 2053 4b59 5049 4c4f 545f 5441 534b   4 SKYPILOT_TASK
+00019e90: 5f49 4453 207c 2063 7574 202d 6422 2922  _IDS | cut -d")"
+00019ea0: 202d 6632 293b 2065 6368 6f20 2224 5255   -f2); echo "$RU
+00019eb0: 4e5f 4944 5322 207c 2074 6565 202f 746d  N_IDS" | tee /tm
+00019ec0: 702f 7b6e 616d 657d 2d72 756e 2d69 6473  p/{name}-run-ids
+00019ed0: 2d6e 6577 272c 0a20 2020 2020 2020 2020  -new',.         
+00019ee0: 2020 2066 2764 6966 6620 2f74 6d70 2f7b     f'diff /tmp/{
+00019ef0: 6e61 6d65 7d2d 7275 6e2d 6964 7320 2f74  name}-run-ids /t
+00019f00: 6d70 2f7b 6e61 6d65 7d2d 7275 6e2d 6964  mp/{name}-run-id
+00019f10: 732d 6e65 7727 2c0a 2020 2020 2020 2020  s-new',.        
+00019f20: 2020 2020 6627 6361 7420 2f74 6d70 2f7b      f'cat /tmp/{
+00019f30: 6e61 6d65 7d2d 7275 6e2d 6964 7320 7c20  name}-run-ids | 
+00019f40: 7365 6420 2d6e 2032 7020 7c20 6772 6570  sed -n 2p | grep
+00019f50: 2060 6361 7420 2f74 6d70 2f7b 6e61 6d65   `cat /tmp/{name
+00019f60: 7d2d 7275 6e2d 6964 6027 2c0a 2020 2020  }-run-id`',.    
+00019f70: 2020 2020 5d2c 0a20 2020 2020 2020 205f      ],.        _
+00019f80: 4a4f 425f 4341 4e43 454c 5f57 4149 542e  JOB_CANCEL_WAIT.
+00019f90: 666f 726d 6174 286a 6f62 5f6e 616d 653d  format(job_name=
+00019fa0: 6e61 6d65 292c 0a20 2020 2020 2020 2074  name),.        t
+00019fb0: 696d 656f 7574 3d32 3520 2a20 3630 2c0a  imeout=25 * 60,.
+00019fc0: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
+00019fd0: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
+00019fe0: 7079 7465 7374 2e6d 6172 6b2e 6763 700a  pytest.mark.gcp.
+00019ff0: 4070 7974 6573 742e 6d61 726b 2e6d 616e  @pytest.mark.man
+0001a000: 6167 6564 5f6a 6f62 730a 6465 6620 7465  aged_jobs.def te
+0001a010: 7374 5f6d 616e 6167 6564 5f6a 6f62 735f  st_managed_jobs_
+0001a020: 7069 7065 6c69 6e65 5f72 6563 6f76 6572  pipeline_recover
+0001a030: 795f 6763 7028 293a 0a20 2020 2022 2222  y_gcp():.    """
+0001a040: 5465 7374 206d 616e 6167 6564 206a 6f62  Test managed job
+0001a050: 2072 6563 6f76 6572 7920 666f 7220 6120   recovery for a 
+0001a060: 7069 7065 6c69 6e65 2e22 2222 0a20 2020  pipeline.""".   
+0001a070: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
+0001a080: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
+0001a090: 7a6f 6e65 203d 2027 7573 2d65 6173 7434  zone = 'us-east4
+0001a0a0: 2d62 270a 2020 2020 7573 6572 5f68 6173  -b'.    user_has
+0001a0b0: 6820 3d20 636f 6d6d 6f6e 5f75 7469 6c73  h = common_utils
+0001a0c0: 2e67 6574 5f75 7365 725f 6861 7368 2829  .get_user_hash()
+0001a0d0: 0a20 2020 2075 7365 725f 6861 7368 203d  .    user_hash =
+0001a0e0: 2075 7365 725f 6861 7368 5b3a 636f 6d6d   user_hash[:comm
+0001a0f0: 6f6e 5f75 7469 6c73 2e55 5345 525f 4841  on_utils.USER_HA
+0001a100: 5348 5f4c 454e 4754 485f 494e 5f43 4c55  SH_LENGTH_IN_CLU
+0001a110: 5354 4552 5f4e 414d 455d 0a20 2020 2071  STER_NAME].    q
+0001a120: 7565 7279 5f63 6d64 203d 2028 0a20 2020  uery_cmd = (.   
+0001a130: 2020 2020 2027 6763 6c6f 7564 2063 6f6d       'gcloud com
+0001a140: 7075 7465 2069 6e73 7461 6e63 6573 206c  pute instances l
+0001a150: 6973 7420 2d2d 6669 6c74 6572 3d27 0a20  ist --filter='. 
+0001a160: 2020 2020 2020 2066 2722 286c 6162 656c         f'"(label
+0001a170: 732e 7261 792d 636c 7573 7465 722d 6e61  s.ray-cluster-na
+0001a180: 6d65 3a2a 2d24 7b7b 4d41 4e41 4745 445f  me:*-${{MANAGED_
+0001a190: 4a4f 425f 4944 7d7d 2d7b 7573 6572 5f68  JOB_ID}}-{user_h
+0001a1a0: 6173 687d 2922 2027 0a20 2020 2020 2020  ash})" '.       
+0001a1b0: 2066 272d 2d7a 6f6e 6573 3d7b 7a6f 6e65   f'--zones={zone
+0001a1c0: 7d20 2d2d 666f 726d 6174 3d22 7661 6c75  } --format="valu
+0001a1d0: 6528 6e61 6d65 2922 2729 0a20 2020 2074  e(name)"').    t
+0001a1e0: 6572 6d69 6e61 7465 5f63 6d64 203d 2028  erminate_cmd = (
+0001a1f0: 6627 6763 6c6f 7564 2063 6f6d 7075 7465  f'gcloud compute
+0001a200: 2069 6e73 7461 6e63 6573 2064 656c 6574   instances delet
+0001a210: 6520 2d2d 7a6f 6e65 3d7b 7a6f 6e65 7d27  e --zone={zone}'
+0001a220: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001a230: 2020 2020 2020 6627 202d 2d71 7569 6574        f' --quiet
+0001a240: 2024 287b 7175 6572 795f 636d 647d 2927   $({query_cmd})'
+0001a250: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
+0001a260: 7428 0a20 2020 2020 2020 2027 6d61 6e61  t(.        'mana
+0001a270: 6765 645f 6a6f 6273 5f70 6970 656c 696e  ged_jobs_pipelin
+0001a280: 655f 7265 636f 7665 7279 5f67 6370 272c  e_recovery_gcp',
+0001a290: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
+0001a2a0: 2020 2020 2020 2066 2773 6b79 206a 6f62         f'sky job
+0001a2b0: 7320 6c61 756e 6368 202d 6e20 7b6e 616d  s launch -n {nam
+0001a2c0: 657d 2074 6573 7473 2f74 6573 745f 7961  e} tests/test_ya
+0001a2d0: 6d6c 732f 7069 7065 6c69 6e65 5f67 6370  mls/pipeline_gcp
+0001a2e0: 2e79 616d 6c20 202d 7920 2d64 272c 0a20  .yaml  -y -d',. 
+0001a2f0: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+0001a300: 7020 3430 3027 2c0a 2020 2020 2020 2020  p 400',.        
+0001a310: 2020 2020 6627 7b5f 4a4f 425f 5155 4555      f'{_JOB_QUEU
+0001a320: 455f 5741 4954 7d7c 2067 7265 7020 7b6e  E_WAIT}| grep {n
+0001a330: 616d 657d 207c 2068 6561 6420 2d6e 3120  ame} | head -n1 
+0001a340: 7c20 6772 6570 2022 5255 4e4e 494e 4722  | grep "RUNNING"
+0001a350: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0001a360: 2752 554e 5f49 443d 2428 736b 7920 6a6f  'RUN_ID=$(sky jo
+0001a370: 6273 206c 6f67 7320 2d6e 207b 6e61 6d65  bs logs -n {name
+0001a380: 7d20 2d2d 6e6f 2d66 6f6c 6c6f 7720 7c20  } --no-follow | 
+0001a390: 6772 6570 2053 4b59 5049 4c4f 545f 5441  grep SKYPILOT_TA
+0001a3a0: 534b 5f49 443a 207c 2063 7574 202d 643a  SK_ID: | cut -d:
+0001a3b0: 202d 6632 293b 2065 6368 6f20 2224 5255   -f2); echo "$RU
+0001a3c0: 4e5f 4944 2220 7c20 7465 6520 2f74 6d70  N_ID" | tee /tmp
+0001a3d0: 2f7b 6e61 6d65 7d2d 7275 6e2d 6964 272c  /{name}-run-id',
+0001a3e0: 0a20 2020 2020 2020 2020 2020 2066 2752  .            f'R
+0001a3f0: 554e 5f49 4453 3d24 2873 6b79 206a 6f62  UN_IDS=$(sky job
+0001a400: 7320 6c6f 6773 202d 6e20 7b6e 616d 657d  s logs -n {name}
+0001a410: 202d 2d6e 6f2d 666f 6c6c 6f77 207c 2067   --no-follow | g
+0001a420: 7265 7020 2d41 2034 2053 4b59 5049 4c4f  rep -A 4 SKYPILO
+0001a430: 545f 5441 534b 5f49 4453 207c 2063 7574  T_TASK_IDS | cut
+0001a440: 202d 6422 2922 202d 6632 293b 2065 6368   -d")" -f2); ech
+0001a450: 6f20 2224 5255 4e5f 4944 5322 207c 2074  o "$RUN_IDS" | t
+0001a460: 6565 202f 746d 702f 7b6e 616d 657d 2d72  ee /tmp/{name}-r
+0001a470: 756e 2d69 6473 272c 0a20 2020 2020 2020  un-ids',.       
+0001a480: 2020 2020 2023 2054 6572 6d69 6e61 7465       # Terminate
+0001a490: 2074 6865 2063 6c75 7374 6572 206d 616e   the cluster man
+0001a4a0: 7561 6c6c 792e 0a20 2020 2020 2020 2020  ually..         
+0001a4b0: 2020 2023 2054 6865 2060 6361 7420 2e2e     # The `cat ..
+0001a4c0: 2e7c 2072 6576 6020 6973 2074 6f20 7265  .| rev` is to re
+0001a4d0: 7472 6965 7665 2074 6865 206a 6f62 5f69  trieve the job_i
+0001a4e0: 6420 6672 6f6d 2074 6865 0a20 2020 2020  d from the.     
+0001a4f0: 2020 2020 2020 2023 2053 4b59 5049 4c4f         # SKYPILO
+0001a500: 545f 5441 534b 5f49 442c 2077 6869 6368  T_TASK_ID, which
+0001a510: 2067 6574 7320 7468 6520 7365 636f 6e64   gets the second
+0001a520: 2074 6f20 6c61 7374 2066 6965 6c64 0a20   to last field. 
+0001a530: 2020 2020 2020 2020 2020 2023 2073 6570             # sep
+0001a540: 6172 6174 6564 2062 7920 602d 602e 0a20  arated by `-`.. 
+0001a550: 2020 2020 2020 2020 2020 2028 6627 4d41             (f'MA
+0001a560: 4e41 4745 445f 4a4f 425f 4944 3d60 6361  NAGED_JOB_ID=`ca
+0001a570: 7420 2f74 6d70 2f7b 6e61 6d65 7d2d 7275  t /tmp/{name}-ru
+0001a580: 6e2d 6964 207c 2072 6576 207c 2027 0a20  n-id | rev | '. 
+0001a590: 2020 2020 2020 2020 2020 2020 6627 6375              f'cu
+0001a5a0: 7420 2d64 5c27 5f5c 2720 2d66 3120 7c20  t -d\'_\' -f1 | 
+0001a5b0: 7265 7620 7c20 6375 7420 2d64 5c27 2d5c  rev | cut -d\'-\
+0001a5c0: 2720 2d66 3160 3b20 7b74 6572 6d69 6e61  ' -f1`; {termina
+0001a5d0: 7465 5f63 6d64 7d27 292c 0a20 2020 2020  te_cmd}'),.     
+0001a5e0: 2020 2020 2020 2027 736c 6565 7020 3630         'sleep 60
+0001a5f0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0001a600: 277b 5f4a 4f42 5f51 5545 5545 5f57 4149  '{_JOB_QUEUE_WAI
+0001a610: 547d 7c20 6772 6570 207b 6e61 6d65 7d20  T}| grep {name} 
+0001a620: 7c20 6865 6164 202d 6e31 207c 2067 7265  | head -n1 | gre
+0001a630: 7020 2252 4543 4f56 4552 494e 4722 272c  p "RECOVERING"',
+0001a640: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
+0001a650: 6565 7020 3230 3027 2c0a 2020 2020 2020  eep 200',.      
+0001a660: 2020 2020 2020 6627 7b5f 4a4f 425f 5155        f'{_JOB_QU
+0001a670: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
+0001a680: 7b6e 616d 657d 207c 2068 6561 6420 2d6e  {name} | head -n
+0001a690: 3120 7c20 6772 6570 2022 5255 4e4e 494e  1 | grep "RUNNIN
+0001a6a0: 4722 272c 0a20 2020 2020 2020 2020 2020  G"',.           
+0001a6b0: 2066 2752 554e 5f49 443d 2428 6361 7420   f'RUN_ID=$(cat 
+0001a6c0: 2f74 6d70 2f7b 6e61 6d65 7d2d 7275 6e2d  /tmp/{name}-run-
+0001a6d0: 6964 293b 2065 6368 6f20 2452 554e 5f49  id); echo $RUN_I
+0001a6e0: 443b 2073 6b79 206a 6f62 7320 6c6f 6773  D; sky jobs logs
+0001a6f0: 202d 6e20 7b6e 616d 657d 202d 2d6e 6f2d   -n {name} --no-
+0001a700: 666f 6c6c 6f77 207c 2067 7265 7020 534b  follow | grep SK
+0001a710: 5950 494c 4f54 5f54 4153 4b5f 4944 3a20  YPILOT_TASK_ID: 
+0001a720: 7c20 6772 6570 2022 2452 554e 5f49 4422  | grep "$RUN_ID"
+0001a730: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0001a740: 2752 554e 5f49 4453 3d24 2873 6b79 206a  'RUN_IDS=$(sky j
+0001a750: 6f62 7320 6c6f 6773 202d 6e20 7b6e 616d  obs logs -n {nam
+0001a760: 657d 202d 2d6e 6f2d 666f 6c6c 6f77 207c  e} --no-follow |
+0001a770: 2067 7265 7020 2d41 2034 2053 4b59 5049   grep -A 4 SKYPI
+0001a780: 4c4f 545f 5441 534b 5f49 4453 207c 2063  LOT_TASK_IDS | c
+0001a790: 7574 202d 6422 2922 202d 6632 293b 2065  ut -d")" -f2); e
+0001a7a0: 6368 6f20 2224 5255 4e5f 4944 5322 207c  cho "$RUN_IDS" |
+0001a7b0: 2074 6565 202f 746d 702f 7b6e 616d 657d   tee /tmp/{name}
+0001a7c0: 2d72 756e 2d69 6473 2d6e 6577 272c 0a20  -run-ids-new',. 
+0001a7d0: 2020 2020 2020 2020 2020 2066 2764 6966             f'dif
+0001a7e0: 6620 2f74 6d70 2f7b 6e61 6d65 7d2d 7275  f /tmp/{name}-ru
+0001a7f0: 6e2d 6964 7320 2f74 6d70 2f7b 6e61 6d65  n-ids /tmp/{name
+0001a800: 7d2d 7275 6e2d 6964 732d 6e65 7727 2c0a  }-run-ids-new',.
+0001a810: 2020 2020 2020 2020 2020 2020 6627 6361              f'ca
+0001a820: 7420 2f74 6d70 2f7b 6e61 6d65 7d2d 7275  t /tmp/{name}-ru
+0001a830: 6e2d 6964 7320 7c20 7365 6420 2d6e 2032  n-ids | sed -n 2
+0001a840: 7020 7c20 6772 6570 2060 6361 7420 2f74  p | grep `cat /t
+0001a850: 6d70 2f7b 6e61 6d65 7d2d 7275 6e2d 6964  mp/{name}-run-id
+0001a860: 6027 2c0a 2020 2020 2020 2020 5d2c 0a20  `',.        ],. 
+0001a870: 2020 2020 2020 205f 4a4f 425f 4341 4e43         _JOB_CANC
+0001a880: 454c 5f57 4149 542e 666f 726d 6174 286a  EL_WAIT.format(j
+0001a890: 6f62 5f6e 616d 653d 6e61 6d65 292c 0a20  ob_name=name),. 
+0001a8a0: 2020 2020 2020 2074 696d 656f 7574 3d32         timeout=2
+0001a8b0: 3520 2a20 3630 2c0a 2020 2020 290a 2020  5 * 60,.    ).  
+0001a8c0: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+0001a8d0: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
+0001a8e0: 6172 6b2e 6e6f 5f66 6c75 6964 7374 6163  ark.no_fluidstac
+0001a8f0: 6b20 2023 2046 6c75 6964 7374 6163 6b20  k  # Fluidstack 
+0001a900: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
+0001a910: 2073 706f 7420 696e 7374 616e 6365 730a   spot instances.
+0001a920: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+0001a930: 617a 7572 6520 2023 2041 7a75 7265 2064  azure  # Azure d
+0001a940: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
+0001a950: 7370 6f74 2069 6e73 7461 6e63 6573 0a40  spot instances.@
+0001a960: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f6c  pytest.mark.no_l
+0001a970: 616d 6264 615f 636c 6f75 6420 2023 204c  ambda_cloud  # L
+0001a980: 616d 6264 6120 436c 6f75 6420 646f 6573  ambda Cloud does
+0001a990: 206e 6f74 2073 7570 706f 7274 2073 706f   not support spo
+0001a9a0: 7420 696e 7374 616e 6365 730a 4070 7974  t instances.@pyt
+0001a9b0: 6573 742e 6d61 726b 2e6e 6f5f 6962 6d20  est.mark.no_ibm 
+0001a9c0: 2023 2049 424d 2043 6c6f 7564 2064 6f65   # IBM Cloud doe
+0001a9d0: 7320 6e6f 7420 7375 7070 6f72 7420 7370  s not support sp
+0001a9e0: 6f74 2069 6e73 7461 6e63 6573 0a40 7079  ot instances.@py
+0001a9f0: 7465 7374 2e6d 6172 6b2e 6e6f 5f73 6370  test.mark.no_scp
+0001aa00: 2020 2320 5343 5020 646f 6573 206e 6f74    # SCP does not
+0001aa10: 2073 7570 706f 7274 2073 706f 7420 696e   support spot in
+0001aa20: 7374 616e 6365 730a 4070 7974 6573 742e  stances.@pytest.
+0001aa30: 6d61 726b 2e6e 6f5f 7061 7065 7273 7061  mark.no_paperspa
+0001aa40: 6365 2020 2320 5061 7065 7273 7061 6365  ce  # Paperspace
+0001aa50: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
+0001aa60: 7420 7370 6f74 2069 6e73 7461 6e63 6573  t spot instances
+0001aa70: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
+0001aa80: 5f6b 7562 6572 6e65 7465 7320 2023 204b  _kubernetes  # K
+0001aa90: 7562 6572 6e65 7465 7320 646f 6573 206e  ubernetes does n
+0001aaa0: 6f74 2068 6176 6520 6120 6e6f 7469 6f6e  ot have a notion
+0001aab0: 206f 6620 7370 6f74 2069 6e73 7461 6e63   of spot instanc
+0001aac0: 6573 0a40 7079 7465 7374 2e6d 6172 6b2e  es.@pytest.mark.
+0001aad0: 6d61 6e61 6765 645f 6a6f 6273 0a64 6566  managed_jobs.def
+0001aae0: 2074 6573 745f 6d61 6e61 6765 645f 6a6f   test_managed_jo
+0001aaf0: 6273 5f72 6563 6f76 6572 795f 6465 6661  bs_recovery_defa
+0001ab00: 756c 745f 7265 736f 7572 6365 7328 6765  ult_resources(ge
+0001ab10: 6e65 7269 635f 636c 6f75 643a 2073 7472  neric_cloud: str
+0001ab20: 293a 0a20 2020 2022 2222 5465 7374 206d  ):.    """Test m
+0001ab30: 616e 6167 6564 206a 6f62 2072 6563 6f76  anaged job recov
+0001ab40: 6572 7920 666f 7220 6465 6661 756c 7420  ery for default 
+0001ab50: 7265 736f 7572 6365 732e 2222 220a 2020  resources.""".  
+0001ab60: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
+0001ab70: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
+0001ab80: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+0001ab90: 2020 2020 2020 276d 616e 6167 6564 2d73        'managed-s
+0001aba0: 706f 742d 7265 636f 7665 7279 2d64 6566  pot-recovery-def
+0001abb0: 6175 6c74 2d72 6573 6f75 7263 6573 272c  ault-resources',
+0001abc0: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
+0001abd0: 2020 2020 2020 2066 2773 6b79 206a 6f62         f'sky job
+0001abe0: 7320 6c61 756e 6368 202d 6e20 7b6e 616d  s launch -n {nam
+0001abf0: 657d 202d 2d63 6c6f 7564 207b 6765 6e65  e} --cloud {gene
+0001ac00: 7269 635f 636c 6f75 647d 202d 2d75 7365  ric_cloud} --use
+0001ac10: 2d73 706f 7420 2273 6c65 6570 2033 3020  -spot "sleep 30 
+0001ac20: 2626 2073 7564 6f20 7368 7574 646f 776e  && sudo shutdown
+0001ac30: 206e 6f77 2026 2620 736c 6565 7020 3130   now && sleep 10
+0001ac40: 3030 2220 2d79 202d 6427 2c0a 2020 2020  00" -y -d',.    
+0001ac50: 2020 2020 2020 2020 2773 6c65 6570 2033          'sleep 3
+0001ac60: 3630 272c 0a20 2020 2020 2020 2020 2020  60',.           
+0001ac70: 2066 277b 5f4a 4f42 5f51 5545 5545 5f57   f'{_JOB_QUEUE_W
+0001ac80: 4149 547d 7c20 6772 6570 207b 6e61 6d65  AIT}| grep {name
+0001ac90: 7d20 7c20 6865 6164 202d 6e31 207c 2067  } | head -n1 | g
+0001aca0: 7265 7020 2252 554e 4e49 4e47 5c7c 5245  rep "RUNNING\|RE
+0001acb0: 434f 5645 5249 4e47 2227 2c0a 2020 2020  COVERING"',.    
+0001acc0: 2020 2020 5d2c 0a20 2020 2020 2020 205f      ],.        _
+0001acd0: 4a4f 425f 4341 4e43 454c 5f57 4149 542e  JOB_CANCEL_WAIT.
+0001ace0: 666f 726d 6174 286a 6f62 5f6e 616d 653d  format(job_name=
+0001acf0: 6e61 6d65 292c 0a20 2020 2020 2020 2074  name),.        t
+0001ad00: 696d 656f 7574 3d32 3520 2a20 3630 2c0a  imeout=25 * 60,.
+0001ad10: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
+0001ad20: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
+0001ad30: 7079 7465 7374 2e6d 6172 6b2e 6177 730a  pytest.mark.aws.
+0001ad40: 4070 7974 6573 742e 6d61 726b 2e6d 616e  @pytest.mark.man
+0001ad50: 6167 6564 5f6a 6f62 730a 6465 6620 7465  aged_jobs.def te
+0001ad60: 7374 5f6d 616e 6167 6564 5f6a 6f62 735f  st_managed_jobs_
+0001ad70: 7265 636f 7665 7279 5f6d 756c 7469 5f6e  recovery_multi_n
+0001ad80: 6f64 655f 6177 7328 6177 735f 636f 6e66  ode_aws(aws_conf
+0001ad90: 6967 5f72 6567 696f 6e29 3a0a 2020 2020  ig_region):.    
+0001ada0: 2222 2254 6573 7420 6d61 6e61 6765 6420  """Test managed 
+0001adb0: 6a6f 6220 7265 636f 7665 7279 2e22 2222  job recovery."""
+0001adc0: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
+0001add0: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
+0001ade0: 2020 2020 6e61 6d65 5f6f 6e5f 636c 6f75      name_on_clou
+0001adf0: 6420 3d20 636f 6d6d 6f6e 5f75 7469 6c73  d = common_utils
+0001ae00: 2e6d 616b 655f 636c 7573 7465 725f 6e61  .make_cluster_na
+0001ae10: 6d65 5f6f 6e5f 636c 6f75 6428 0a20 2020  me_on_cloud(.   
+0001ae20: 2020 2020 206e 616d 652c 206a 6f62 732e       name, jobs.
+0001ae30: 4a4f 4253 5f43 4c55 5354 4552 5f4e 414d  JOBS_CLUSTER_NAM
+0001ae40: 455f 5052 4546 4958 5f4c 454e 4754 482c  E_PREFIX_LENGTH,
+0001ae50: 2061 6464 5f75 7365 725f 6861 7368 3d46   add_user_hash=F
+0001ae60: 616c 7365 290a 2020 2020 7265 6769 6f6e  alse).    region
+0001ae70: 203d 2061 7773 5f63 6f6e 6669 675f 7265   = aws_config_re
+0001ae80: 6769 6f6e 0a20 2020 2074 6573 7420 3d20  gion.    test = 
+0001ae90: 5465 7374 280a 2020 2020 2020 2020 276d  Test(.        'm
+0001aea0: 616e 6167 6564 5f6a 6f62 735f 7265 636f  anaged_jobs_reco
+0001aeb0: 7665 7279 5f6d 756c 7469 5f6e 6f64 655f  very_multi_node_
+0001aec0: 6177 7327 2c0a 2020 2020 2020 2020 5b0a  aws',.        [.
+0001aed0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0001aee0: 7920 6a6f 6273 206c 6175 6e63 6820 2d2d  y jobs launch --
+0001aef0: 636c 6f75 6420 6177 7320 2d2d 7265 6769  cloud aws --regi
+0001af00: 6f6e 207b 7265 6769 6f6e 7d20 2d6e 207b  on {region} -n {
+0001af10: 6e61 6d65 7d20 2d2d 7573 652d 7370 6f74  name} --use-spot
+0001af20: 202d 2d6e 756d 2d6e 6f64 6573 2032 2022   --num-nodes 2 "
+0001af30: 6563 686f 2053 4b59 5049 4c4f 545f 5441  echo SKYPILOT_TA
+0001af40: 534b 5f49 443a 205c 2453 4b59 5049 4c4f  SK_ID: \$SKYPILO
+0001af50: 545f 5441 534b 5f49 443b 2073 6c65 6570  T_TASK_ID; sleep
+0001af60: 2031 3830 3022 2020 2d79 202d 6427 2c0a   1800"  -y -d',.
+0001af70: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
+0001af80: 6570 2034 3530 272c 0a20 2020 2020 2020  ep 450',.       
+0001af90: 2020 2020 2066 277b 5f4a 4f42 5f51 5545       f'{_JOB_QUE
+0001afa0: 5545 5f57 4149 547d 7c20 6772 6570 207b  UE_WAIT}| grep {
+0001afb0: 6e61 6d65 7d20 7c20 6865 6164 202d 6e31  name} | head -n1
+0001afc0: 207c 2067 7265 7020 2252 554e 4e49 4e47   | grep "RUNNING
+0001afd0: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+0001afe0: 6627 5255 4e5f 4944 3d24 2873 6b79 206a  f'RUN_ID=$(sky j
+0001aff0: 6f62 7320 6c6f 6773 202d 6e20 7b6e 616d  obs logs -n {nam
+0001b000: 657d 202d 2d6e 6f2d 666f 6c6c 6f77 207c  e} --no-follow |
+0001b010: 2067 7265 7020 534b 5950 494c 4f54 5f54   grep SKYPILOT_T
+0001b020: 4153 4b5f 4944 207c 2063 7574 202d 643a  ASK_ID | cut -d:
+0001b030: 202d 6632 293b 2065 6368 6f20 2224 5255   -f2); echo "$RU
+0001b040: 4e5f 4944 2220 7c20 7465 6520 2f74 6d70  N_ID" | tee /tmp
+0001b050: 2f7b 6e61 6d65 7d2d 7275 6e2d 6964 272c  /{name}-run-id',
+0001b060: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
+0001b070: 6572 6d69 6e61 7465 2074 6865 2077 6f72  erminate the wor
+0001b080: 6b65 7220 6d61 6e75 616c 6c79 2e0a 2020  ker manually..  
+0001b090: 2020 2020 2020 2020 2020 2866 2761 7773            (f'aws
+0001b0a0: 2065 6332 2074 6572 6d69 6e61 7465 2d69   ec2 terminate-i
+0001b0b0: 6e73 7461 6e63 6573 202d 2d72 6567 696f  nstances --regio
+0001b0c0: 6e20 7b72 6567 696f 6e7d 202d 2d69 6e73  n {region} --ins
+0001b0d0: 7461 6e63 652d 6964 7320 2428 270a 2020  tance-ids $('.  
+0001b0e0: 2020 2020 2020 2020 2020 2066 2761 7773             f'aws
+0001b0f0: 2065 6332 2064 6573 6372 6962 652d 696e   ec2 describe-in
+0001b100: 7374 616e 6365 7320 2d2d 7265 6769 6f6e  stances --region
+0001b110: 207b 7265 6769 6f6e 7d20 270a 2020 2020   {region} '.    
+0001b120: 2020 2020 2020 2020 2066 272d 2d66 696c           f'--fil
+0001b130: 7465 7273 204e 616d 653d 7461 673a 7261  ters Name=tag:ra
+0001b140: 792d 636c 7573 7465 722d 6e61 6d65 2c56  y-cluster-name,V
+0001b150: 616c 7565 733d 7b6e 616d 655f 6f6e 5f63  alues={name_on_c
+0001b160: 6c6f 7564 7d2a 2027 0a20 2020 2020 2020  loud}* '.       
+0001b170: 2020 2020 2020 274e 616d 653d 7461 673a        'Name=tag:
+0001b180: 7261 792d 6e6f 6465 2d74 7970 652c 5661  ray-node-type,Va
+0001b190: 6c75 6573 3d77 6f72 6b65 7220 270a 2020  lues=worker '.  
+0001b1a0: 2020 2020 2020 2020 2020 2066 272d 2d71             f'--q
+0001b1b0: 7565 7279 2052 6573 6572 7661 7469 6f6e  uery Reservation
+0001b1c0: 735b 5d2e 496e 7374 616e 6365 735b 5d2e  s[].Instances[].
+0001b1d0: 496e 7374 616e 6365 4964 2027 0a20 2020  InstanceId '.   
+0001b1e0: 2020 2020 2020 2020 2020 272d 2d6f 7574            '--out
+0001b1f0: 7075 7420 7465 7874 2927 292c 0a20 2020  put text)'),.   
+0001b200: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
+0001b210: 3530 272c 0a20 2020 2020 2020 2020 2020  50',.           
+0001b220: 2066 277b 5f4a 4f42 5f51 5545 5545 5f57   f'{_JOB_QUEUE_W
+0001b230: 4149 547d 7c20 6772 6570 207b 6e61 6d65  AIT}| grep {name
+0001b240: 7d20 7c20 6865 6164 202d 6e31 207c 2067  } | head -n1 | g
+0001b250: 7265 7020 2252 4543 4f56 4552 494e 4722  rep "RECOVERING"
+0001b260: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
+0001b270: 736c 6565 7020 3536 3027 2c0a 2020 2020  sleep 560',.    
+0001b280: 2020 2020 2020 2020 6627 7b5f 4a4f 425f          f'{_JOB_
+0001b290: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
+0001b2a0: 7020 7b6e 616d 657d 207c 2068 6561 6420  p {name} | head 
+0001b2b0: 2d6e 3120 7c20 6772 6570 2022 5255 4e4e  -n1 | grep "RUNN
+0001b2c0: 494e 4722 272c 0a20 2020 2020 2020 2020  ING"',.         
+0001b2d0: 2020 2066 2752 554e 5f49 443d 2428 6361     f'RUN_ID=$(ca
+0001b2e0: 7420 2f74 6d70 2f7b 6e61 6d65 7d2d 7275  t /tmp/{name}-ru
+0001b2f0: 6e2d 6964 293b 2065 6368 6f20 2452 554e  n-id); echo $RUN
+0001b300: 5f49 443b 2073 6b79 206a 6f62 7320 6c6f  _ID; sky jobs lo
+0001b310: 6773 202d 6e20 7b6e 616d 657d 202d 2d6e  gs -n {name} --n
+0001b320: 6f2d 666f 6c6c 6f77 207c 2067 7265 7020  o-follow | grep 
+0001b330: 534b 5950 494c 4f54 5f54 4153 4b5f 4944  SKYPILOT_TASK_ID
+0001b340: 207c 2063 7574 202d 643a 202d 6632 207c   | cut -d: -f2 |
+0001b350: 2067 7265 7020 2224 5255 4e5f 4944 2227   grep "$RUN_ID"'
+0001b360: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
+0001b370: 2020 2020 205f 4a4f 425f 4341 4e43 454c       _JOB_CANCEL
+0001b380: 5f57 4149 542e 666f 726d 6174 286a 6f62  _WAIT.format(job
+0001b390: 5f6e 616d 653d 6e61 6d65 292c 0a20 2020  _name=name),.   
+0001b3a0: 2020 2020 2074 696d 656f 7574 3d33 3020       timeout=30 
+0001b3b0: 2a20 3630 2c0a 2020 2020 290a 2020 2020  * 60,.    ).    
+0001b3c0: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
+0001b3d0: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
+0001b3e0: 6b2e 6763 700a 4070 7974 6573 742e 6d61  k.gcp.@pytest.ma
+0001b3f0: 726b 2e6d 616e 6167 6564 5f6a 6f62 730a  rk.managed_jobs.
+0001b400: 6465 6620 7465 7374 5f6d 616e 6167 6564  def test_managed
+0001b410: 5f6a 6f62 735f 7265 636f 7665 7279 5f6d  _jobs_recovery_m
+0001b420: 756c 7469 5f6e 6f64 655f 6763 7028 293a  ulti_node_gcp():
+0001b430: 0a20 2020 2022 2222 5465 7374 206d 616e  .    """Test man
+0001b440: 6167 6564 206a 6f62 2072 6563 6f76 6572  aged job recover
+0001b450: 792e 2222 220a 2020 2020 6e61 6d65 203d  y.""".    name =
+0001b460: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
+0001b470: 6d65 2829 0a20 2020 206e 616d 655f 6f6e  me().    name_on
+0001b480: 5f63 6c6f 7564 203d 2063 6f6d 6d6f 6e5f  _cloud = common_
+0001b490: 7574 696c 732e 6d61 6b65 5f63 6c75 7374  utils.make_clust
+0001b4a0: 6572 5f6e 616d 655f 6f6e 5f63 6c6f 7564  er_name_on_cloud
+0001b4b0: 280a 2020 2020 2020 2020 6e61 6d65 2c20  (.        name, 
+0001b4c0: 6a6f 6273 2e4a 4f42 535f 434c 5553 5445  jobs.JOBS_CLUSTE
+0001b4d0: 525f 4e41 4d45 5f50 5245 4649 585f 4c45  R_NAME_PREFIX_LE
+0001b4e0: 4e47 5448 2c20 6164 645f 7573 6572 5f68  NGTH, add_user_h
+0001b4f0: 6173 683d 4661 6c73 6529 0a20 2020 207a  ash=False).    z
+0001b500: 6f6e 6520 3d20 2775 732d 7765 7374 322d  one = 'us-west2-
+0001b510: 6127 0a20 2020 2023 2055 7365 2027 3a27  a'.    # Use ':'
+0001b520: 2074 6f20 6d61 7463 6820 6173 2074 6865   to match as the
+0001b530: 2063 6c75 7374 6572 206e 616d 6520 7769   cluster name wi
+0001b540: 6c6c 2063 6f6e 7461 696e 2074 6865 2073  ll contain the s
+0001b550: 7566 6669 7820 7769 7468 206a 6f62 2069  uffix with job i
+0001b560: 640a 2020 2020 7175 6572 795f 636d 6420  d.    query_cmd 
+0001b570: 3d20 280a 2020 2020 2020 2020 6627 6763  = (.        f'gc
+0001b580: 6c6f 7564 2063 6f6d 7075 7465 2069 6e73  loud compute ins
+0001b590: 7461 6e63 6573 206c 6973 7420 2d2d 6669  tances list --fi
+0001b5a0: 6c74 6572 3d27 0a20 2020 2020 2020 2066  lter='.        f
+0001b5b0: 2722 286c 6162 656c 732e 7261 792d 636c  '"(labels.ray-cl
+0001b5c0: 7573 7465 722d 6e61 6d65 3a7b 6e61 6d65  uster-name:{name
+0001b5d0: 5f6f 6e5f 636c 6f75 647d 2041 4e44 2027  _on_cloud} AND '
+0001b5e0: 0a20 2020 2020 2020 2066 276c 6162 656c  .        f'label
+0001b5f0: 732e 7261 792d 6e6f 6465 2d74 7970 653d  s.ray-node-type=
+0001b600: 776f 726b 6572 2922 202d 2d7a 6f6e 6573  worker)" --zones
+0001b610: 3d7b 7a6f 6e65 7d20 2d2d 666f 726d 6174  ={zone} --format
+0001b620: 3d22 7661 6c75 6528 6e61 6d65 2922 2729  ="value(name)"')
+0001b630: 0a20 2020 2074 6572 6d69 6e61 7465 5f63  .    terminate_c
+0001b640: 6d64 203d 2028 6627 6763 6c6f 7564 2063  md = (f'gcloud c
+0001b650: 6f6d 7075 7465 2069 6e73 7461 6e63 6573  ompute instances
+0001b660: 2064 656c 6574 6520 2d2d 7a6f 6e65 3d7b   delete --zone={
+0001b670: 7a6f 6e65 7d27 0a20 2020 2020 2020 2020  zone}'.         
+0001b680: 2020 2020 2020 2020 2020 2020 6627 202d              f' -
+0001b690: 2d71 7569 6574 2024 287b 7175 6572 795f  -quiet $({query_
+0001b6a0: 636d 647d 2927 290a 2020 2020 7465 7374  cmd})').    test
+0001b6b0: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
+0001b6c0: 2027 6d61 6e61 6765 645f 6a6f 6273 5f72   'managed_jobs_r
+0001b6d0: 6563 6f76 6572 795f 6d75 6c74 695f 6e6f  ecovery_multi_no
+0001b6e0: 6465 5f67 6370 272c 0a20 2020 2020 2020  de_gcp',.       
+0001b6f0: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
+0001b700: 2773 6b79 206a 6f62 7320 6c61 756e 6368  'sky jobs launch
+0001b710: 202d 2d63 6c6f 7564 2067 6370 202d 2d7a   --cloud gcp --z
+0001b720: 6f6e 6520 7b7a 6f6e 657d 202d 6e20 7b6e  one {zone} -n {n
+0001b730: 616d 657d 202d 2d75 7365 2d73 706f 7420  ame} --use-spot 
+0001b740: 2d2d 6e75 6d2d 6e6f 6465 7320 3220 2265  --num-nodes 2 "e
+0001b750: 6368 6f20 534b 5950 494c 4f54 5f54 4153  cho SKYPILOT_TAS
+0001b760: 4b5f 4944 3a20 5c24 534b 5950 494c 4f54  K_ID: \$SKYPILOT
+0001b770: 5f54 4153 4b5f 4944 3b20 736c 6565 7020  _TASK_ID; sleep 
+0001b780: 3138 3030 2220 202d 7920 2d64 272c 0a20  1800"  -y -d',. 
+0001b790: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+0001b7a0: 7020 3430 3027 2c0a 2020 2020 2020 2020  p 400',.        
+0001b7b0: 2020 2020 6627 7b5f 4a4f 425f 5155 4555      f'{_JOB_QUEU
+0001b7c0: 455f 5741 4954 7d7c 2067 7265 7020 7b6e  E_WAIT}| grep {n
+0001b7d0: 616d 657d 207c 2068 6561 6420 2d6e 3120  ame} | head -n1 
+0001b7e0: 7c20 6772 6570 2022 5255 4e4e 494e 4722  | grep "RUNNING"
+0001b7f0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0001b800: 2752 554e 5f49 443d 2428 736b 7920 6a6f  'RUN_ID=$(sky jo
+0001b810: 6273 206c 6f67 7320 2d6e 207b 6e61 6d65  bs logs -n {name
+0001b820: 7d20 2d2d 6e6f 2d66 6f6c 6c6f 7720 7c20  } --no-follow | 
+0001b830: 6772 6570 2053 4b59 5049 4c4f 545f 5441  grep SKYPILOT_TA
+0001b840: 534b 5f49 4420 7c20 6375 7420 2d64 3a20  SK_ID | cut -d: 
+0001b850: 2d66 3229 3b20 6563 686f 2022 2452 554e  -f2); echo "$RUN
+0001b860: 5f49 4422 207c 2074 6565 202f 746d 702f  _ID" | tee /tmp/
+0001b870: 7b6e 616d 657d 2d72 756e 2d69 6427 2c0a  {name}-run-id',.
+0001b880: 2020 2020 2020 2020 2020 2020 2320 5465              # Te
+0001b890: 726d 696e 6174 6520 7468 6520 776f 726b  rminate the work
+0001b8a0: 6572 206d 616e 7561 6c6c 792e 0a20 2020  er manually..   
+0001b8b0: 2020 2020 2020 2020 2074 6572 6d69 6e61           termina
+0001b8c0: 7465 5f63 6d64 2c0a 2020 2020 2020 2020  te_cmd,.        
+0001b8d0: 2020 2020 2773 6c65 6570 2035 3027 2c0a      'sleep 50',.
+0001b8e0: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
+0001b8f0: 4a4f 425f 5155 4555 455f 5741 4954 7d7c  JOB_QUEUE_WAIT}|
+0001b900: 2067 7265 7020 7b6e 616d 657d 207c 2068   grep {name} | h
+0001b910: 6561 6420 2d6e 3120 7c20 6772 6570 2022  ead -n1 | grep "
+0001b920: 5245 434f 5645 5249 4e47 2227 2c0a 2020  RECOVERING"',.  
+0001b930: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
+0001b940: 2034 3230 272c 0a20 2020 2020 2020 2020   420',.         
+0001b950: 2020 2066 277b 5f4a 4f42 5f51 5545 5545     f'{_JOB_QUEUE
+0001b960: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
+0001b970: 6d65 7d20 7c20 6865 6164 202d 6e31 207c  me} | head -n1 |
+0001b980: 2067 7265 7020 2252 554e 4e49 4e47 2227   grep "RUNNING"'
+0001b990: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0001b9a0: 5255 4e5f 4944 3d24 2863 6174 202f 746d  RUN_ID=$(cat /tm
+0001b9b0: 702f 7b6e 616d 657d 2d72 756e 2d69 6429  p/{name}-run-id)
+0001b9c0: 3b20 6563 686f 2024 5255 4e5f 4944 3b20  ; echo $RUN_ID; 
+0001b9d0: 736b 7920 6a6f 6273 206c 6f67 7320 2d6e  sky jobs logs -n
+0001b9e0: 207b 6e61 6d65 7d20 2d2d 6e6f 2d66 6f6c   {name} --no-fol
+0001b9f0: 6c6f 7720 7c20 6772 6570 2053 4b59 5049  low | grep SKYPI
+0001ba00: 4c4f 545f 5441 534b 5f49 4420 7c20 6375  LOT_TASK_ID | cu
+0001ba10: 7420 2d64 3a20 2d66 3220 7c20 6772 6570  t -d: -f2 | grep
+0001ba20: 2022 2452 554e 5f49 4422 272c 0a20 2020   "$RUN_ID"',.   
+0001ba30: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
+0001ba40: 5f4a 4f42 5f43 414e 4345 4c5f 5741 4954  _JOB_CANCEL_WAIT
+0001ba50: 2e66 6f72 6d61 7428 6a6f 625f 6e61 6d65  .format(job_name
+0001ba60: 3d6e 616d 6529 2c0a 2020 2020 2020 2020  =name),.        
+0001ba70: 7469 6d65 6f75 743d 3235 202a 2036 302c  timeout=25 * 60,
+0001ba80: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+0001ba90: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+0001baa0: 4070 7974 6573 742e 6d61 726b 2e61 7773  @pytest.mark.aws
+0001bab0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6d61  .@pytest.mark.ma
+0001bac0: 6e61 6765 645f 6a6f 6273 0a64 6566 2074  naged_jobs.def t
+0001bad0: 6573 745f 6d61 6e61 6765 645f 6a6f 6273  est_managed_jobs
+0001bae0: 5f63 616e 6365 6c6c 6174 696f 6e5f 6177  _cancellation_aw
+0001baf0: 7328 6177 735f 636f 6e66 6967 5f72 6567  s(aws_config_reg
+0001bb00: 696f 6e29 3a0a 2020 2020 6e61 6d65 203d  ion):.    name =
+0001bb10: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
+0001bb20: 6d65 2829 0a20 2020 206e 616d 655f 6f6e  me().    name_on
+0001bb30: 5f63 6c6f 7564 203d 2063 6f6d 6d6f 6e5f  _cloud = common_
+0001bb40: 7574 696c 732e 6d61 6b65 5f63 6c75 7374  utils.make_clust
+0001bb50: 6572 5f6e 616d 655f 6f6e 5f63 6c6f 7564  er_name_on_cloud
+0001bb60: 280a 2020 2020 2020 2020 6e61 6d65 2c20  (.        name, 
+0001bb70: 6a6f 6273 2e4a 4f42 535f 434c 5553 5445  jobs.JOBS_CLUSTE
+0001bb80: 525f 4e41 4d45 5f50 5245 4649 585f 4c45  R_NAME_PREFIX_LE
+0001bb90: 4e47 5448 2c20 6164 645f 7573 6572 5f68  NGTH, add_user_h
+0001bba0: 6173 683d 4661 6c73 6529 0a20 2020 206e  ash=False).    n
+0001bbb0: 616d 655f 325f 6f6e 5f63 6c6f 7564 203d  ame_2_on_cloud =
+0001bbc0: 2063 6f6d 6d6f 6e5f 7574 696c 732e 6d61   common_utils.ma
+0001bbd0: 6b65 5f63 6c75 7374 6572 5f6e 616d 655f  ke_cluster_name_
+0001bbe0: 6f6e 5f63 6c6f 7564 280a 2020 2020 2020  on_cloud(.      
+0001bbf0: 2020 6627 7b6e 616d 657d 2d32 272c 206a    f'{name}-2', j
+0001bc00: 6f62 732e 4a4f 4253 5f43 4c55 5354 4552  obs.JOBS_CLUSTER
+0001bc10: 5f4e 414d 455f 5052 4546 4958 5f4c 454e  _NAME_PREFIX_LEN
+0001bc20: 4754 482c 2061 6464 5f75 7365 725f 6861  GTH, add_user_ha
+0001bc30: 7368 3d46 616c 7365 290a 2020 2020 6e61  sh=False).    na
+0001bc40: 6d65 5f33 5f6f 6e5f 636c 6f75 6420 3d20  me_3_on_cloud = 
+0001bc50: 636f 6d6d 6f6e 5f75 7469 6c73 2e6d 616b  common_utils.mak
+0001bc60: 655f 636c 7573 7465 725f 6e61 6d65 5f6f  e_cluster_name_o
+0001bc70: 6e5f 636c 6f75 6428 0a20 2020 2020 2020  n_cloud(.       
+0001bc80: 2066 277b 6e61 6d65 7d2d 3327 2c20 6a6f   f'{name}-3', jo
+0001bc90: 6273 2e4a 4f42 535f 434c 5553 5445 525f  bs.JOBS_CLUSTER_
+0001bca0: 4e41 4d45 5f50 5245 4649 585f 4c45 4e47  NAME_PREFIX_LENG
+0001bcb0: 5448 2c20 6164 645f 7573 6572 5f68 6173  TH, add_user_has
+0001bcc0: 683d 4661 6c73 6529 0a20 2020 2072 6567  h=False).    reg
+0001bcd0: 696f 6e20 3d20 6177 735f 636f 6e66 6967  ion = aws_config
+0001bce0: 5f72 6567 696f 6e0a 2020 2020 7465 7374  _region.    test
+0001bcf0: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
+0001bd00: 2027 6d61 6e61 6765 645f 6a6f 6273 5f63   'managed_jobs_c
+0001bd10: 616e 6365 6c6c 6174 696f 6e5f 6177 7327  ancellation_aws'
+0001bd20: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
+0001bd30: 2020 2020 2020 2020 2320 5465 7374 2063          # Test c
+0001bd40: 616e 6365 6c6c 6174 696f 6e20 6475 7269  ancellation duri
+0001bd50: 6e67 2073 706f 7420 636c 7573 7465 7220  ng spot cluster 
+0001bd60: 6265 696e 6720 6c61 756e 6368 6564 2e0a  being launched..
+0001bd70: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0001bd80: 7920 6a6f 6273 206c 6175 6e63 6820 2d2d  y jobs launch --
+0001bd90: 636c 6f75 6420 6177 7320 2d2d 7265 6769  cloud aws --regi
+0001bda0: 6f6e 207b 7265 6769 6f6e 7d20 2d6e 207b  on {region} -n {
+0001bdb0: 6e61 6d65 7d20 2d2d 7573 652d 7370 6f74  name} --use-spot
+0001bdc0: 2022 736c 6565 7020 3130 3030 2220 202d   "sleep 1000"  -
+0001bdd0: 7920 2d64 272c 0a20 2020 2020 2020 2020  y -d',.         
+0001bde0: 2020 2027 736c 6565 7020 3630 272c 0a20     'sleep 60',. 
+0001bdf0: 2020 2020 2020 2020 2020 2066 277b 5f4a             f'{_J
+0001be00: 4f42 5f51 5545 5545 5f57 4149 547d 7c20  OB_QUEUE_WAIT}| 
+0001be10: 6772 6570 207b 6e61 6d65 7d20 7c20 6865  grep {name} | he
+0001be20: 6164 202d 6e31 207c 2067 7265 7020 2253  ad -n1 | grep "S
+0001be30: 5441 5254 494e 4722 272c 0a20 2020 2020  TARTING"',.     
+0001be40: 2020 2020 2020 205f 4a4f 425f 4341 4e43         _JOB_CANC
+0001be50: 454c 5f57 4149 542e 666f 726d 6174 286a  EL_WAIT.format(j
+0001be60: 6f62 5f6e 616d 653d 6e61 6d65 292c 0a20  ob_name=name),. 
+0001be70: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+0001be80: 7020 3527 2c0a 2020 2020 2020 2020 2020  p 5',.          
+0001be90: 2020 6627 7b5f 4a4f 425f 5155 4555 455f    f'{_JOB_QUEUE_
+0001bea0: 5741 4954 7d7c 2067 7265 7020 7b6e 616d  WAIT}| grep {nam
+0001beb0: 657d 207c 2068 6561 6420 2d6e 3120 7c20  e} | head -n1 | 
+0001bec0: 6772 6570 2022 4341 4e43 454c 4c49 4e47  grep "CANCELLING
+0001bed0: 5c7c 4341 4e43 454c 4c45 4422 272c 0a20  \|CANCELLED"',. 
+0001bee0: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+0001bef0: 7020 3132 3027 2c0a 2020 2020 2020 2020  p 120',.        
+0001bf00: 2020 2020 6627 7b5f 4a4f 425f 5155 4555      f'{_JOB_QUEU
+0001bf10: 455f 5741 4954 7d7c 2067 7265 7020 7b6e  E_WAIT}| grep {n
+0001bf20: 616d 657d 207c 2068 6561 6420 2d6e 3120  ame} | head -n1 
+0001bf30: 7c20 6772 6570 2022 4341 4e43 454c 4c45  | grep "CANCELLE
+0001bf40: 4422 272c 0a20 2020 2020 2020 2020 2020  D"',.           
+0001bf50: 2028 6627 733d 2428 6177 7320 6563 3220   (f's=$(aws ec2 
+0001bf60: 6465 7363 7269 6265 2d69 6e73 7461 6e63  describe-instanc
+0001bf70: 6573 202d 2d72 6567 696f 6e20 7b72 6567  es --region {reg
+0001bf80: 696f 6e7d 2027 0a20 2020 2020 2020 2020  ion} '.         
+0001bf90: 2020 2020 6627 2d2d 6669 6c74 6572 7320      f'--filters 
+0001bfa0: 4e61 6d65 3d74 6167 3a72 6179 2d63 6c75  Name=tag:ray-clu
+0001bfb0: 7374 6572 2d6e 616d 652c 5661 6c75 6573  ster-name,Values
+0001bfc0: 3d7b 6e61 6d65 5f6f 6e5f 636c 6f75 647d  ={name_on_cloud}
+0001bfd0: 2d2a 2027 0a20 2020 2020 2020 2020 2020  -* '.           
+0001bfe0: 2020 6627 2d2d 7175 6572 7920 5265 7365    f'--query Rese
+0001bff0: 7276 6174 696f 6e73 5b5d 2e49 6e73 7461  rvations[].Insta
+0001c000: 6e63 6573 5b5d 2e53 7461 7465 5b5d 2e4e  nces[].State[].N
+0001c010: 616d 6520 270a 2020 2020 2020 2020 2020  ame '.          
+0001c020: 2020 2027 2d2d 6f75 7470 7574 2074 6578     '--output tex
+0001c030: 7429 2026 2620 6563 686f 2022 2473 2220  t) && echo "$s" 
+0001c040: 2626 2065 6368 6f3b 205b 5b20 2d7a 2022  && echo; [[ -z "
+0001c050: 2473 2220 5d5d 207c 7c20 5b5b 2022 2473  $s" ]] || [[ "$s
+0001c060: 2220 3d20 2274 6572 6d69 6e61 7465 6422  " = "terminated"
+0001c070: 205d 5d20 7c7c 205b 5b20 2224 7322 203d   ]] || [[ "$s" =
+0001c080: 2022 7368 7574 7469 6e67 2d64 6f77 6e22   "shutting-down"
+0001c090: 205d 5d27 0a20 2020 2020 2020 2020 2020   ]]'.           
+0001c0a0: 2029 2c0a 2020 2020 2020 2020 2020 2020   ),.            
+0001c0b0: 2320 5465 7374 2063 616e 6365 6c6c 696e  # Test cancellin
+0001c0c0: 6720 7468 6520 7370 6f74 2063 6c75 7374  g the spot clust
+0001c0d0: 6572 2064 7572 696e 6720 7370 6f74 206a  er during spot j
+0001c0e0: 6f62 2062 6569 6e67 2073 6574 7570 2e0a  ob being setup..
+0001c0f0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0001c100: 7920 6a6f 6273 206c 6175 6e63 6820 2d2d  y jobs launch --
+0001c110: 636c 6f75 6420 6177 7320 2d2d 7265 6769  cloud aws --regi
+0001c120: 6f6e 207b 7265 6769 6f6e 7d20 2d6e 207b  on {region} -n {
+0001c130: 6e61 6d65 7d2d 3220 2d2d 7573 652d 7370  name}-2 --use-sp
+0001c140: 6f74 2074 6573 7473 2f74 6573 745f 7961  ot tests/test_ya
+0001c150: 6d6c 732f 7465 7374 5f6c 6f6e 675f 7365  mls/test_long_se
+0001c160: 7475 702e 7961 6d6c 2020 2d79 202d 6427  tup.yaml  -y -d'
+0001c170: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
+0001c180: 6c65 6570 2033 3030 272c 0a20 2020 2020  leep 300',.     
+0001c190: 2020 2020 2020 205f 4a4f 425f 4341 4e43         _JOB_CANC
+0001c1a0: 454c 5f57 4149 542e 666f 726d 6174 286a  EL_WAIT.format(j
+0001c1b0: 6f62 5f6e 616d 653d 6627 7b6e 616d 657d  ob_name=f'{name}
+0001c1c0: 2d32 2729 2c0a 2020 2020 2020 2020 2020  -2'),.          
+0001c1d0: 2020 2773 6c65 6570 2035 272c 0a20 2020    'sleep 5',.   
+0001c1e0: 2020 2020 2020 2020 2066 277b 5f4a 4f42           f'{_JOB
+0001c1f0: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
+0001c200: 6570 207b 6e61 6d65 7d2d 3220 7c20 6865  ep {name}-2 | he
+0001c210: 6164 202d 6e31 207c 2067 7265 7020 2243  ad -n1 | grep "C
+0001c220: 414e 4345 4c4c 494e 475c 7c43 414e 4345  ANCELLING\|CANCE
+0001c230: 4c4c 4544 2227 2c0a 2020 2020 2020 2020  LLED"',.        
+0001c240: 2020 2020 2773 6c65 6570 2031 3230 272c      'sleep 120',
+0001c250: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
+0001c260: 5f4a 4f42 5f51 5545 5545 5f57 4149 547d  _JOB_QUEUE_WAIT}
+0001c270: 7c20 6772 6570 207b 6e61 6d65 7d2d 3220  | grep {name}-2 
+0001c280: 7c20 6865 6164 202d 6e31 207c 2067 7265  | head -n1 | gre
+0001c290: 7020 2243 414e 4345 4c4c 4544 2227 2c0a  p "CANCELLED"',.
+0001c2a0: 2020 2020 2020 2020 2020 2020 2866 2773              (f's
+0001c2b0: 3d24 2861 7773 2065 6332 2064 6573 6372  =$(aws ec2 descr
+0001c2c0: 6962 652d 696e 7374 616e 6365 7320 2d2d  ibe-instances --
+0001c2d0: 7265 6769 6f6e 207b 7265 6769 6f6e 7d20  region {region} 
+0001c2e0: 270a 2020 2020 2020 2020 2020 2020 2066  '.             f
+0001c2f0: 272d 2d66 696c 7465 7273 204e 616d 653d  '--filters Name=
+0001c300: 7461 673a 7261 792d 636c 7573 7465 722d  tag:ray-cluster-
+0001c310: 6e61 6d65 2c56 616c 7565 733d 7b6e 616d  name,Values={nam
+0001c320: 655f 325f 6f6e 5f63 6c6f 7564 7d2d 2a20  e_2_on_cloud}-* 
+0001c330: 270a 2020 2020 2020 2020 2020 2020 2066  '.             f
+0001c340: 272d 2d71 7565 7279 2052 6573 6572 7661  '--query Reserva
+0001c350: 7469 6f6e 735b 5d2e 496e 7374 616e 6365  tions[].Instance
+0001c360: 735b 5d2e 5374 6174 655b 5d2e 4e61 6d65  s[].State[].Name
+0001c370: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+0001c380: 272d 2d6f 7574 7075 7420 7465 7874 2920  '--output text) 
+0001c390: 2626 2065 6368 6f20 2224 7322 2026 2620  && echo "$s" && 
+0001c3a0: 6563 686f 3b20 5b5b 202d 7a20 2224 7322  echo; [[ -z "$s"
+0001c3b0: 205d 5d20 7c7c 205b 5b20 2224 7322 203d   ]] || [[ "$s" =
+0001c3c0: 2022 7465 726d 696e 6174 6564 2220 5d5d   "terminated" ]]
+0001c3d0: 207c 7c20 5b5b 2022 2473 2220 3d20 2273   || [[ "$s" = "s
+0001c3e0: 6875 7474 696e 672d 646f 776e 2220 5d5d  hutting-down" ]]
+0001c3f0: 270a 2020 2020 2020 2020 2020 2020 292c  '.            ),
+0001c400: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
+0001c410: 6573 7420 6361 6e63 656c 6c61 7469 6f6e  est cancellation
+0001c420: 2064 7572 696e 6720 7370 6f74 206a 6f62   during spot job
+0001c430: 2069 7320 7265 636f 7665 7269 6e67 2e0a   is recovering..
+0001c440: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0001c450: 7920 6a6f 6273 206c 6175 6e63 6820 2d2d  y jobs launch --
+0001c460: 636c 6f75 6420 6177 7320 2d2d 7265 6769  cloud aws --regi
+0001c470: 6f6e 207b 7265 6769 6f6e 7d20 2d6e 207b  on {region} -n {
+0001c480: 6e61 6d65 7d2d 3320 2d2d 7573 652d 7370  name}-3 --use-sp
+0001c490: 6f74 2022 736c 6565 7020 3130 3030 2220  ot "sleep 1000" 
+0001c4a0: 202d 7920 2d64 272c 0a20 2020 2020 2020   -y -d',.       
+0001c4b0: 2020 2020 2027 736c 6565 7020 3330 3027       'sleep 300'
+0001c4c0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0001c4d0: 7b5f 4a4f 425f 5155 4555 455f 5741 4954  {_JOB_QUEUE_WAIT
+0001c4e0: 7d7c 2067 7265 7020 7b6e 616d 657d 2d33  }| grep {name}-3
+0001c4f0: 207c 2068 6561 6420 2d6e 3120 7c20 6772   | head -n1 | gr
+0001c500: 6570 2022 5255 4e4e 494e 4722 272c 0a20  ep "RUNNING"',. 
+0001c510: 2020 2020 2020 2020 2020 2023 2054 6572             # Ter
+0001c520: 6d69 6e61 7465 2074 6865 2063 6c75 7374  minate the clust
+0001c530: 6572 206d 616e 7561 6c6c 792e 0a20 2020  er manually..   
+0001c540: 2020 2020 2020 2020 2028 6627 6177 7320           (f'aws 
+0001c550: 6563 3220 7465 726d 696e 6174 652d 696e  ec2 terminate-in
+0001c560: 7374 616e 6365 7320 2d2d 7265 6769 6f6e  stances --region
+0001c570: 207b 7265 6769 6f6e 7d20 2d2d 696e 7374   {region} --inst
+0001c580: 616e 6365 2d69 6473 2024 2827 0a20 2020  ance-ids $('.   
+0001c590: 2020 2020 2020 2020 2020 6627 6177 7320            f'aws 
+0001c5a0: 6563 3220 6465 7363 7269 6265 2d69 6e73  ec2 describe-ins
+0001c5b0: 7461 6e63 6573 202d 2d72 6567 696f 6e20  tances --region 
+0001c5c0: 7b72 6567 696f 6e7d 2027 0a20 2020 2020  {region} '.     
+0001c5d0: 2020 2020 2020 2020 6627 2d2d 6669 6c74          f'--filt
+0001c5e0: 6572 7320 4e61 6d65 3d74 6167 3a72 6179  ers Name=tag:ray
+0001c5f0: 2d63 6c75 7374 6572 2d6e 616d 652c 5661  -cluster-name,Va
+0001c600: 6c75 6573 3d7b 6e61 6d65 5f33 5f6f 6e5f  lues={name_3_on_
+0001c610: 636c 6f75 647d 2d2a 2027 0a20 2020 2020  cloud}-* '.     
+0001c620: 2020 2020 2020 2020 6627 2d2d 7175 6572          f'--quer
+0001c630: 7920 5265 7365 7276 6174 696f 6e73 5b5d  y Reservations[]
+0001c640: 2e49 6e73 7461 6e63 6573 5b5d 2e49 6e73  .Instances[].Ins
+0001c650: 7461 6e63 6549 6420 270a 2020 2020 2020  tanceId '.      
+0001c660: 2020 2020 2020 2027 2d2d 6f75 7470 7574         '--output
+0001c670: 2074 6578 7429 2729 2c0a 2020 2020 2020   text)'),.      
+0001c680: 2020 2020 2020 2773 6c65 6570 2031 3230        'sleep 120
+0001c690: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0001c6a0: 277b 5f4a 4f42 5f51 5545 5545 5f57 4149  '{_JOB_QUEUE_WAI
+0001c6b0: 547d 7c20 6772 6570 207b 6e61 6d65 7d2d  T}| grep {name}-
+0001c6c0: 3320 7c20 6865 6164 202d 6e31 207c 2067  3 | head -n1 | g
+0001c6d0: 7265 7020 2252 4543 4f56 4552 494e 4722  rep "RECOVERING"
+0001c6e0: 272c 0a20 2020 2020 2020 2020 2020 205f  ',.            _
+0001c6f0: 4a4f 425f 4341 4e43 454c 5f57 4149 542e  JOB_CANCEL_WAIT.
+0001c700: 666f 726d 6174 286a 6f62 5f6e 616d 653d  format(job_name=
+0001c710: 6627 7b6e 616d 657d 2d33 2729 2c0a 2020  f'{name}-3'),.  
+0001c720: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
+0001c730: 2035 272c 0a20 2020 2020 2020 2020 2020   5',.           
+0001c740: 2066 277b 5f4a 4f42 5f51 5545 5545 5f57   f'{_JOB_QUEUE_W
+0001c750: 4149 547d 7c20 6772 6570 207b 6e61 6d65  AIT}| grep {name
+0001c760: 7d2d 3320 7c20 6865 6164 202d 6e31 207c  }-3 | head -n1 |
+0001c770: 2067 7265 7020 2243 414e 4345 4c4c 494e   grep "CANCELLIN
+0001c780: 475c 7c43 414e 4345 4c4c 4544 2227 2c0a  G\|CANCELLED"',.
+0001c790: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
+0001c7a0: 6570 2031 3230 272c 0a20 2020 2020 2020  ep 120',.       
+0001c7b0: 2020 2020 2066 277b 5f4a 4f42 5f51 5545       f'{_JOB_QUE
+0001c7c0: 5545 5f57 4149 547d 7c20 6772 6570 207b  UE_WAIT}| grep {
+0001c7d0: 6e61 6d65 7d2d 3320 7c20 6865 6164 202d  name}-3 | head -
+0001c7e0: 6e31 207c 2067 7265 7020 2243 414e 4345  n1 | grep "CANCE
+0001c7f0: 4c4c 4544 2227 2c0a 2020 2020 2020 2020  LLED"',.        
+0001c800: 2020 2020 2320 5468 6520 636c 7573 7465      # The cluste
+0001c810: 7220 7368 6f75 6c64 2062 6520 7465 726d  r should be term
+0001c820: 696e 6174 6564 2028 7368 7574 7469 6e67  inated (shutting
+0001c830: 2d64 6f77 6e29 2061 6674 6572 2063 616e  -down) after can
+0001c840: 6365 6c6c 6174 696f 6e2e 2057 6520 646f  cellation. We do
+0001c850: 6e27 7420 7573 6520 7468 6520 603d 6020  n't use the `=` 
+0001c860: 6f70 6572 6174 6f72 2068 6572 6520 6265  operator here be
+0001c870: 6361 7573 650a 2020 2020 2020 2020 2020  cause.          
+0001c880: 2020 2320 7468 6572 6520 6361 6e20 6265    # there can be
+0001c890: 206d 756c 7469 706c 6520 564d 2077 6974   multiple VM wit
+0001c8a0: 6820 7468 6520 7361 6d65 206e 616d 6520  h the same name 
+0001c8b0: 6475 6520 746f 2074 6865 2072 6563 6f76  due to the recov
+0001c8c0: 6572 792e 0a20 2020 2020 2020 2020 2020  ery..           
+0001c8d0: 2028 6627 733d 2428 6177 7320 6563 3220   (f's=$(aws ec2 
+0001c8e0: 6465 7363 7269 6265 2d69 6e73 7461 6e63  describe-instanc
+0001c8f0: 6573 202d 2d72 6567 696f 6e20 7b72 6567  es --region {reg
+0001c900: 696f 6e7d 2027 0a20 2020 2020 2020 2020  ion} '.         
+0001c910: 2020 2020 6627 2d2d 6669 6c74 6572 7320      f'--filters 
+0001c920: 4e61 6d65 3d74 6167 3a72 6179 2d63 6c75  Name=tag:ray-clu
+0001c930: 7374 6572 2d6e 616d 652c 5661 6c75 6573  ster-name,Values
+0001c940: 3d7b 6e61 6d65 5f33 5f6f 6e5f 636c 6f75  ={name_3_on_clou
+0001c950: 647d 2d2a 2027 0a20 2020 2020 2020 2020  d}-* '.         
+0001c960: 2020 2020 6627 2d2d 7175 6572 7920 5265      f'--query Re
+0001c970: 7365 7276 6174 696f 6e73 5b5d 2e49 6e73  servations[].Ins
+0001c980: 7461 6e63 6573 5b5d 2e53 7461 7465 5b5d  tances[].State[]
+0001c990: 2e4e 616d 6520 270a 2020 2020 2020 2020  .Name '.        
+0001c9a0: 2020 2020 2027 2d2d 6f75 7470 7574 2074       '--output t
+0001c9b0: 6578 7429 2026 2620 6563 686f 2022 2473  ext) && echo "$s
+0001c9c0: 2220 2626 2065 6368 6f3b 205b 5b20 2d7a  " && echo; [[ -z
+0001c9d0: 2022 2473 2220 5d5d 207c 7c20 6563 686f   "$s" ]] || echo
+0001c9e0: 2022 2473 2220 7c20 6772 6570 202d 7620   "$s" | grep -v 
+0001c9f0: 2d45 2022 7065 6e64 696e 677c 7275 6e6e  -E "pending|runn
+0001ca00: 696e 677c 7374 6f70 7065 647c 7374 6f70  ing|stopped|stop
+0001ca10: 7069 6e67 2227 0a20 2020 2020 2020 2020  ping"'.         
+0001ca20: 2020 2029 2c0a 2020 2020 2020 2020 5d2c     ),.        ],
+0001ca30: 0a20 2020 2020 2020 2074 696d 656f 7574  .        timeout
+0001ca40: 3d32 3520 2a20 3630 290a 2020 2020 7275  =25 * 60).    ru
+0001ca50: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
+0001ca60: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
+0001ca70: 6763 700a 4070 7974 6573 742e 6d61 726b  gcp.@pytest.mark
+0001ca80: 2e6d 616e 6167 6564 5f6a 6f62 730a 6465  .managed_jobs.de
+0001ca90: 6620 7465 7374 5f6d 616e 6167 6564 5f6a  f test_managed_j
+0001caa0: 6f62 735f 6361 6e63 656c 6c61 7469 6f6e  obs_cancellation
+0001cab0: 5f67 6370 2829 3a0a 2020 2020 6e61 6d65  _gcp():.    name
+0001cac0: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
+0001cad0: 6e61 6d65 2829 0a20 2020 206e 616d 655f  name().    name_
+0001cae0: 3320 3d20 6627 7b6e 616d 657d 2d33 270a  3 = f'{name}-3'.
+0001caf0: 2020 2020 6e61 6d65 5f33 5f6f 6e5f 636c      name_3_on_cl
+0001cb00: 6f75 6420 3d20 636f 6d6d 6f6e 5f75 7469  oud = common_uti
+0001cb10: 6c73 2e6d 616b 655f 636c 7573 7465 725f  ls.make_cluster_
+0001cb20: 6e61 6d65 5f6f 6e5f 636c 6f75 6428 0a20  name_on_cloud(. 
+0001cb30: 2020 2020 2020 206e 616d 655f 332c 206a         name_3, j
+0001cb40: 6f62 732e 4a4f 4253 5f43 4c55 5354 4552  obs.JOBS_CLUSTER
+0001cb50: 5f4e 414d 455f 5052 4546 4958 5f4c 454e  _NAME_PREFIX_LEN
+0001cb60: 4754 482c 2061 6464 5f75 7365 725f 6861  GTH, add_user_ha
+0001cb70: 7368 3d46 616c 7365 290a 2020 2020 7a6f  sh=False).    zo
+0001cb80: 6e65 203d 2027 7573 2d77 6573 7433 2d62  ne = 'us-west3-b
+0001cb90: 270a 2020 2020 7175 6572 795f 7374 6174  '.    query_stat
+0001cba0: 655f 636d 6420 3d20 280a 2020 2020 2020  e_cmd = (.      
+0001cbb0: 2020 2767 636c 6f75 6420 636f 6d70 7574    'gcloud comput
+0001cbc0: 6520 696e 7374 616e 6365 7320 6c69 7374  e instances list
+0001cbd0: 2027 0a20 2020 2020 2020 2066 272d 2d66   '.        f'--f
+0001cbe0: 696c 7465 723d 2228 6c61 6265 6c73 2e72  ilter="(labels.r
+0001cbf0: 6179 2d63 6c75 7374 6572 2d6e 616d 653a  ay-cluster-name:
+0001cc00: 7b6e 616d 655f 335f 6f6e 5f63 6c6f 7564  {name_3_on_cloud
+0001cc10: 7d29 2220 270a 2020 2020 2020 2020 272d  })" '.        '-
+0001cc20: 2d66 6f72 6d61 743d 2276 616c 7565 2873  -format="value(s
+0001cc30: 7461 7475 7329 2227 290a 2020 2020 7175  tatus)"').    qu
+0001cc40: 6572 795f 636d 6420 3d20 2866 2767 636c  ery_cmd = (f'gcl
+0001cc50: 6f75 6420 636f 6d70 7574 6520 696e 7374  oud compute inst
+0001cc60: 616e 6365 7320 6c69 7374 202d 2d66 696c  ances list --fil
+0001cc70: 7465 723d 270a 2020 2020 2020 2020 2020  ter='.          
+0001cc80: 2020 2020 2020 2066 2722 286c 6162 656c         f'"(label
+0001cc90: 732e 7261 792d 636c 7573 7465 722d 6e61  s.ray-cluster-na
+0001cca0: 6d65 3a7b 6e61 6d65 5f33 5f6f 6e5f 636c  me:{name_3_on_cl
+0001ccb0: 6f75 647d 2922 2027 0a20 2020 2020 2020  oud})" '.       
+0001ccc0: 2020 2020 2020 2020 2020 6627 2d2d 7a6f            f'--zo
+0001ccd0: 6e65 733d 7b7a 6f6e 657d 202d 2d66 6f72  nes={zone} --for
+0001cce0: 6d61 743d 2276 616c 7565 286e 616d 6529  mat="value(name)
+0001ccf0: 2227 290a 2020 2020 7465 726d 696e 6174  "').    terminat
+0001cd00: 655f 636d 6420 3d20 2866 2767 636c 6f75  e_cmd = (f'gclou
+0001cd10: 6420 636f 6d70 7574 6520 696e 7374 616e  d compute instan
+0001cd20: 6365 7320 6465 6c65 7465 202d 2d7a 6f6e  ces delete --zon
+0001cd30: 653d 7b7a 6f6e 657d 270a 2020 2020 2020  e={zone}'.      
+0001cd40: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0001cd50: 2720 2d2d 7175 6965 7420 2428 7b71 7565  ' --quiet $({que
+0001cd60: 7279 5f63 6d64 7d29 2729 0a20 2020 2074  ry_cmd})').    t
+0001cd70: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+0001cd80: 2020 2020 276d 616e 6167 6564 5f6a 6f62      'managed_job
+0001cd90: 735f 6361 6e63 656c 6c61 7469 6f6e 5f67  s_cancellation_g
+0001cda0: 6370 272c 0a20 2020 2020 2020 205b 0a20  cp',.        [. 
+0001cdb0: 2020 2020 2020 2020 2020 2023 2054 6573             # Tes
+0001cdc0: 7420 6361 6e63 656c 6c61 7469 6f6e 2064  t cancellation d
+0001cdd0: 7572 696e 6720 7370 6f74 2063 6c75 7374  uring spot clust
+0001cde0: 6572 2062 6569 6e67 206c 6175 6e63 6865  er being launche
+0001cdf0: 642e 0a20 2020 2020 2020 2020 2020 2066  d..            f
+0001ce00: 2773 6b79 206a 6f62 7320 6c61 756e 6368  'sky jobs launch
+0001ce10: 202d 2d63 6c6f 7564 2067 6370 202d 2d7a   --cloud gcp --z
+0001ce20: 6f6e 6520 7b7a 6f6e 657d 202d 6e20 7b6e  one {zone} -n {n
+0001ce30: 616d 657d 202d 2d75 7365 2d73 706f 7420  ame} --use-spot 
+0001ce40: 2273 6c65 6570 2031 3030 3022 2020 2d79  "sleep 1000"  -y
+0001ce50: 202d 6427 2c0a 2020 2020 2020 2020 2020   -d',.          
+0001ce60: 2020 2773 6c65 6570 2036 3027 2c0a 2020    'sleep 60',.  
+0001ce70: 2020 2020 2020 2020 2020 6627 7b5f 4a4f            f'{_JO
+0001ce80: 425f 5155 4555 455f 5741 4954 7d7c 2067  B_QUEUE_WAIT}| g
+0001ce90: 7265 7020 7b6e 616d 657d 207c 2068 6561  rep {name} | hea
+0001cea0: 6420 2d6e 3120 7c20 6772 6570 2022 5354  d -n1 | grep "ST
+0001ceb0: 4152 5449 4e47 2227 2c0a 2020 2020 2020  ARTING"',.      
+0001cec0: 2020 2020 2020 5f4a 4f42 5f43 414e 4345        _JOB_CANCE
+0001ced0: 4c5f 5741 4954 2e66 6f72 6d61 7428 6a6f  L_WAIT.format(jo
+0001cee0: 625f 6e61 6d65 3d6e 616d 6529 2c0a 2020  b_name=name),.  
+0001cef0: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
+0001cf00: 2035 272c 0a20 2020 2020 2020 2020 2020   5',.           
+0001cf10: 2066 277b 5f4a 4f42 5f51 5545 5545 5f57   f'{_JOB_QUEUE_W
+0001cf20: 4149 547d 7c20 6772 6570 207b 6e61 6d65  AIT}| grep {name
+0001cf30: 7d20 7c20 6865 6164 202d 6e31 207c 2067  } | head -n1 | g
+0001cf40: 7265 7020 2243 414e 4345 4c4c 494e 475c  rep "CANCELLING\
+0001cf50: 7c43 414e 4345 4c4c 4544 2227 2c0a 2020  |CANCELLED"',.  
+0001cf60: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
+0001cf70: 2031 3230 272c 0a20 2020 2020 2020 2020   120',.         
+0001cf80: 2020 2066 277b 5f4a 4f42 5f51 5545 5545     f'{_JOB_QUEUE
+0001cf90: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
+0001cfa0: 6d65 7d20 7c20 6865 6164 202d 6e31 207c  me} | head -n1 |
+0001cfb0: 2067 7265 7020 2243 414e 4345 4c4c 4544   grep "CANCELLED
+0001cfc0: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+0001cfd0: 2320 5465 7374 2063 616e 6365 6c6c 696e  # Test cancellin
+0001cfe0: 6720 7468 6520 7370 6f74 2063 6c75 7374  g the spot clust
+0001cff0: 6572 2064 7572 696e 6720 7370 6f74 206a  er during spot j
+0001d000: 6f62 2062 6569 6e67 2073 6574 7570 2e0a  ob being setup..
+0001d010: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0001d020: 7920 6a6f 6273 206c 6175 6e63 6820 2d2d  y jobs launch --
+0001d030: 636c 6f75 6420 6763 7020 2d2d 7a6f 6e65  cloud gcp --zone
+0001d040: 207b 7a6f 6e65 7d20 2d6e 207b 6e61 6d65   {zone} -n {name
+0001d050: 7d2d 3220 2d2d 7573 652d 7370 6f74 2074  }-2 --use-spot t
+0001d060: 6573 7473 2f74 6573 745f 7961 6d6c 732f  ests/test_yamls/
+0001d070: 7465 7374 5f6c 6f6e 675f 7365 7475 702e  test_long_setup.
+0001d080: 7961 6d6c 2020 2d79 202d 6427 2c0a 2020  yaml  -y -d',.  
+0001d090: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
+0001d0a0: 2033 3030 272c 0a20 2020 2020 2020 2020   300',.         
+0001d0b0: 2020 205f 4a4f 425f 4341 4e43 454c 5f57     _JOB_CANCEL_W
+0001d0c0: 4149 542e 666f 726d 6174 286a 6f62 5f6e  AIT.format(job_n
+0001d0d0: 616d 653d 6627 7b6e 616d 657d 2d32 2729  ame=f'{name}-2')
+0001d0e0: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
+0001d0f0: 6c65 6570 2035 272c 0a20 2020 2020 2020  leep 5',.       
+0001d100: 2020 2020 2066 277b 5f4a 4f42 5f51 5545       f'{_JOB_QUE
+0001d110: 5545 5f57 4149 547d 7c20 6772 6570 207b  UE_WAIT}| grep {
+0001d120: 6e61 6d65 7d2d 3220 7c20 6865 6164 202d  name}-2 | head -
+0001d130: 6e31 207c 2067 7265 7020 2243 414e 4345  n1 | grep "CANCE
+0001d140: 4c4c 494e 475c 7c43 414e 4345 4c4c 4544  LLING\|CANCELLED
+0001d150: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+0001d160: 2773 6c65 6570 2031 3230 272c 0a20 2020  'sleep 120',.   
+0001d170: 2020 2020 2020 2020 2066 277b 5f4a 4f42           f'{_JOB
+0001d180: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
+0001d190: 6570 207b 6e61 6d65 7d2d 3220 7c20 6865  ep {name}-2 | he
+0001d1a0: 6164 202d 6e31 207c 2067 7265 7020 2243  ad -n1 | grep "C
+0001d1b0: 414e 4345 4c4c 4544 2227 2c0a 2020 2020  ANCELLED"',.    
+0001d1c0: 2020 2020 2020 2020 2320 5465 7374 2063          # Test c
+0001d1d0: 616e 6365 6c6c 6174 696f 6e20 6475 7269  ancellation duri
+0001d1e0: 6e67 2073 706f 7420 6a6f 6220 6973 2072  ng spot job is r
+0001d1f0: 6563 6f76 6572 696e 672e 0a20 2020 2020  ecovering..     
+0001d200: 2020 2020 2020 2066 2773 6b79 206a 6f62         f'sky job
+0001d210: 7320 6c61 756e 6368 202d 2d63 6c6f 7564  s launch --cloud
+0001d220: 2067 6370 202d 2d7a 6f6e 6520 7b7a 6f6e   gcp --zone {zon
+0001d230: 657d 202d 6e20 7b6e 616d 657d 2d33 202d  e} -n {name}-3 -
+0001d240: 2d75 7365 2d73 706f 7420 2273 6c65 6570  -use-spot "sleep
+0001d250: 2031 3030 3022 2020 2d79 202d 6427 2c0a   1000"  -y -d',.
+0001d260: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
+0001d270: 6570 2033 3030 272c 0a20 2020 2020 2020  ep 300',.       
+0001d280: 2020 2020 2066 277b 5f4a 4f42 5f51 5545       f'{_JOB_QUE
+0001d290: 5545 5f57 4149 547d 7c20 6772 6570 207b  UE_WAIT}| grep {
+0001d2a0: 6e61 6d65 7d2d 3320 7c20 6865 6164 202d  name}-3 | head -
+0001d2b0: 6e31 207c 2067 7265 7020 2252 554e 4e49  n1 | grep "RUNNI
+0001d2c0: 4e47 2227 2c0a 2020 2020 2020 2020 2020  NG"',.          
+0001d2d0: 2020 2320 5465 726d 696e 6174 6520 7468    # Terminate th
+0001d2e0: 6520 636c 7573 7465 7220 6d61 6e75 616c  e cluster manual
+0001d2f0: 6c79 2e0a 2020 2020 2020 2020 2020 2020  ly..            
+0001d300: 7465 726d 696e 6174 655f 636d 642c 0a20  terminate_cmd,. 
+0001d310: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+0001d320: 7020 3830 272c 0a20 2020 2020 2020 2020  p 80',.         
+0001d330: 2020 2066 277b 5f4a 4f42 5f51 5545 5545     f'{_JOB_QUEUE
+0001d340: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
+0001d350: 6d65 7d2d 3320 7c20 6865 6164 202d 6e31  me}-3 | head -n1
+0001d360: 207c 2067 7265 7020 2252 4543 4f56 4552   | grep "RECOVER
+0001d370: 494e 4722 272c 0a20 2020 2020 2020 2020  ING"',.         
+0001d380: 2020 205f 4a4f 425f 4341 4e43 454c 5f57     _JOB_CANCEL_W
+0001d390: 4149 542e 666f 726d 6174 286a 6f62 5f6e  AIT.format(job_n
+0001d3a0: 616d 653d 6627 7b6e 616d 657d 2d33 2729  ame=f'{name}-3')
+0001d3b0: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
+0001d3c0: 6c65 6570 2035 272c 0a20 2020 2020 2020  leep 5',.       
+0001d3d0: 2020 2020 2066 277b 5f4a 4f42 5f51 5545       f'{_JOB_QUE
+0001d3e0: 5545 5f57 4149 547d 7c20 6772 6570 207b  UE_WAIT}| grep {
+0001d3f0: 6e61 6d65 7d2d 3320 7c20 6865 6164 202d  name}-3 | head -
+0001d400: 6e31 207c 2067 7265 7020 2243 414e 4345  n1 | grep "CANCE
+0001d410: 4c4c 494e 475c 7c43 414e 4345 4c4c 4544  LLING\|CANCELLED
+0001d420: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+0001d430: 2773 6c65 6570 2031 3230 272c 0a20 2020  'sleep 120',.   
+0001d440: 2020 2020 2020 2020 2066 277b 5f4a 4f42           f'{_JOB
+0001d450: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
+0001d460: 6570 207b 6e61 6d65 7d2d 3320 7c20 6865  ep {name}-3 | he
+0001d470: 6164 202d 6e31 207c 2067 7265 7020 2243  ad -n1 | grep "C
+0001d480: 414e 4345 4c4c 4544 2227 2c0a 2020 2020  ANCELLED"',.    
+0001d490: 2020 2020 2020 2020 2320 5468 6520 636c          # The cl
+0001d4a0: 7573 7465 7220 7368 6f75 6c64 2062 6520  uster should be 
+0001d4b0: 7465 726d 696e 6174 6564 2028 5354 4f50  terminated (STOP
+0001d4c0: 5049 4e47 2920 6166 7465 7220 6361 6e63  PING) after canc
+0001d4d0: 656c 6c61 7469 6f6e 2e20 5765 2064 6f6e  ellation. We don
+0001d4e0: 2774 2075 7365 2074 6865 2060 3d60 206f  't use the `=` o
+0001d4f0: 7065 7261 746f 7220 6865 7265 2062 6563  perator here bec
+0001d500: 6175 7365 0a20 2020 2020 2020 2020 2020  ause.           
+0001d510: 2023 2074 6865 7265 2063 616e 2062 6520   # there can be 
+0001d520: 6d75 6c74 6970 6c65 2056 4d20 7769 7468  multiple VM with
+0001d530: 2074 6865 2073 616d 6520 6e61 6d65 2064   the same name d
+0001d540: 7565 2074 6f20 7468 6520 7265 636f 7665  ue to the recove
+0001d550: 7279 2e0a 2020 2020 2020 2020 2020 2020  ry..            
+0001d560: 2866 2773 3d24 287b 7175 6572 795f 7374  (f's=$({query_st
+0001d570: 6174 655f 636d 647d 2920 2626 2065 6368  ate_cmd}) && ech
+0001d580: 6f20 2224 7322 2026 2620 6563 686f 3b20  o "$s" && echo; 
+0001d590: 5b5b 202d 7a20 2224 7322 205d 5d20 7c7c  [[ -z "$s" ]] ||
+0001d5a0: 2065 6368 6f20 2224 7322 207c 2067 7265   echo "$s" | gre
+0001d5b0: 7020 2d76 202d 4520 2250 524f 5649 5349  p -v -E "PROVISI
+0001d5c0: 4f4e 494e 477c 5354 4147 494e 477c 5255  ONING|STAGING|RU
+0001d5d0: 4e4e 494e 477c 5245 5041 4952 494e 477c  NNING|REPAIRING|
+0001d5e0: 5445 524d 494e 4154 4544 7c53 5553 5045  TERMINATED|SUSPE
+0001d5f0: 4e44 494e 477c 5355 5350 454e 4445 447c  NDING|SUSPENDED|
+0001d600: 5355 5350 454e 4445 4422 270a 2020 2020  SUSPENDED"'.    
+0001d610: 2020 2020 2020 2020 292c 0a20 2020 2020          ),.     
+0001d620: 2020 205d 2c0a 2020 2020 2020 2020 7469     ],.        ti
+0001d630: 6d65 6f75 743d 3235 202a 2036 3029 0a20  meout=25 * 60). 
+0001d640: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+0001d650: 7465 7374 290a 0a0a 2320 2d2d 2d2d 2d2d  test)...# ------
+0001d660: 2d2d 2d2d 2054 6573 7469 6e67 2073 746f  ---- Testing sto
+0001d670: 7261 6765 2066 6f72 206d 616e 6167 6564  rage for managed
+0001d680: 206a 6f62 202d 2d2d 2d2d 2d2d 2d2d 2d0a   job ----------.
+0001d690: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+0001d6a0: 666c 7569 6473 7461 636b 2020 2320 466c  fluidstack  # Fl
+0001d6b0: 7569 6473 7461 636b 2064 6f65 7320 6e6f  uidstack does no
+0001d6c0: 7420 7375 7070 6f72 7420 7370 6f74 2069  t support spot i
+0001d6d0: 6e73 7461 6e63 6573 0a40 7079 7465 7374  nstances.@pytest
+0001d6e0: 2e6d 6172 6b2e 6e6f 5f61 7a75 7265 2020  .mark.no_azure  
+0001d6f0: 2320 417a 7572 6520 646f 6573 206e 6f74  # Azure does not
+0001d700: 2073 7570 706f 7274 2073 706f 7420 696e   support spot in
+0001d710: 7374 616e 6365 730a 4070 7974 6573 742e  stances.@pytest.
+0001d720: 6d61 726b 2e6e 6f5f 6c61 6d62 6461 5f63  mark.no_lambda_c
+0001d730: 6c6f 7564 2020 2320 4c61 6d62 6461 2043  loud  # Lambda C
+0001d740: 6c6f 7564 2064 6f65 7320 6e6f 7420 7375  loud does not su
+0001d750: 7070 6f72 7420 7370 6f74 2069 6e73 7461  pport spot insta
+0001d760: 6e63 6573 0a40 7079 7465 7374 2e6d 6172  nces.@pytest.mar
+0001d770: 6b2e 6e6f 5f69 626d 2020 2320 4942 4d20  k.no_ibm  # IBM 
+0001d780: 436c 6f75 6420 646f 6573 206e 6f74 2073  Cloud does not s
+0001d790: 7570 706f 7274 2073 706f 7420 696e 7374  upport spot inst
+0001d7a0: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
+0001d7b0: 726b 2e6e 6f5f 7061 7065 7273 7061 6365  rk.no_paperspace
+0001d7c0: 2020 2320 5061 7065 7273 7061 6365 2064    # Paperspace d
+0001d7d0: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
+0001d7e0: 7370 6f74 2069 6e73 7461 6e63 6573 0a40  spot instances.@
+0001d7f0: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f73  pytest.mark.no_s
+0001d800: 6370 2020 2320 5343 5020 646f 6573 206e  cp  # SCP does n
+0001d810: 6f74 2073 7570 706f 7274 2073 706f 7420  ot support spot 
+0001d820: 696e 7374 616e 6365 730a 4070 7974 6573  instances.@pytes
+0001d830: 742e 6d61 726b 2e6e 6f5f 6b75 6265 726e  t.mark.no_kubern
+0001d840: 6574 6573 2020 2320 4b75 6265 726e 6574  etes  # Kubernet
+0001d850: 6573 2064 6f65 7320 6e6f 7420 6861 7665  es does not have
+0001d860: 2061 206e 6f74 696f 6e20 6f66 2073 706f   a notion of spo
+0001d870: 7420 696e 7374 616e 6365 730a 4070 7974  t instances.@pyt
+0001d880: 6573 742e 6d61 726b 2e6d 616e 6167 6564  est.mark.managed
+0001d890: 5f6a 6f62 730a 6465 6620 7465 7374 5f6d  _jobs.def test_m
+0001d8a0: 616e 6167 6564 5f6a 6f62 735f 7374 6f72  anaged_jobs_stor
+0001d8b0: 6167 6528 6765 6e65 7269 635f 636c 6f75  age(generic_clou
+0001d8c0: 643a 2073 7472 293a 0a20 2020 2022 2222  d: str):.    """
+0001d8d0: 5465 7374 2073 746f 7261 6765 2077 6974  Test storage wit
+0001d8e0: 6820 6d61 6e61 6765 6420 6a6f 6222 2222  h managed job"""
+0001d8f0: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
+0001d900: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
+0001d910: 2020 2020 7961 6d6c 5f73 7472 203d 2070      yaml_str = p
+0001d920: 6174 686c 6962 2e50 6174 6828 0a20 2020  athlib.Path(.   
+0001d930: 2020 2020 2027 6578 616d 706c 6573 2f6d       'examples/m
+0001d940: 616e 6167 6564 5f6a 6f62 5f77 6974 685f  anaged_job_with_
+0001d950: 7374 6f72 6167 652e 7961 6d6c 2729 2e72  storage.yaml').r
+0001d960: 6561 645f 7465 7874 2829 0a20 2020 2073  ead_text().    s
+0001d970: 746f 7261 6765 5f6e 616d 6520 3d20 6627  torage_name = f'
+0001d980: 736b 792d 7465 7374 2d7b 696e 7428 7469  sky-test-{int(ti
+0001d990: 6d65 2e74 696d 6528 2929 7d27 0a0a 2020  me.time())}'..  
+0001d9a0: 2020 2320 416c 736f 2070 6572 666f 726d    # Also perform
+0001d9b0: 2072 6567 696f 6e20 7465 7374 696e 6720   region testing 
+0001d9c0: 666f 7220 6275 636b 6574 2063 7265 6174  for bucket creat
+0001d9d0: 696f 6e20 746f 2076 616c 6964 6174 6520  ion to validate 
+0001d9e0: 6966 2062 7563 6b65 7473 2061 7265 0a20  if buckets are. 
+0001d9f0: 2020 2023 2063 7265 6174 6564 2069 6e20     # created in 
+0001da00: 7468 6520 636f 7272 6563 7420 7265 6769  the correct regi
+0001da10: 6f6e 2061 6e64 2063 6f72 7265 6374 6c79  on and correctly
+0001da20: 206d 6f75 6e74 6564 2069 6e20 6d61 6e61   mounted in mana
+0001da30: 6765 6420 6a6f 6273 2e0a 2020 2020 2320  ged jobs..    # 
+0001da40: 486f 7765 7665 722c 2077 6520 696e 6a65  However, we inje
+0001da50: 6374 2074 6869 7320 7465 7374 696e 6720  ct this testing 
+0001da60: 6f6e 6c79 2066 6f72 2041 5753 2061 6e64  only for AWS and
+0001da70: 2047 4350 2073 696e 6365 2074 6865 7920   GCP since they 
+0001da80: 6172 6520 7468 650a 2020 2020 2320 7375  are the.    # su
+0001da90: 7070 6f72 7465 6420 6f62 6a65 6374 2073  pported object s
+0001daa0: 746f 7261 6765 2070 726f 7669 6465 7273  torage providers
+0001dab0: 2069 6e20 536b 7950 696c 6f74 2e0a 2020   in SkyPilot..  
+0001dac0: 2020 7265 6769 6f6e 5f66 6c61 6720 3d20    region_flag = 
+0001dad0: 2727 0a20 2020 2072 6567 696f 6e5f 7661  ''.    region_va
+0001dae0: 6c69 6461 7469 6f6e 5f63 6d64 203d 2027  lidation_cmd = '
+0001daf0: 7472 7565 270a 2020 2020 6966 2067 656e  true'.    if gen
+0001db00: 6572 6963 5f63 6c6f 7564 203d 3d20 2761  eric_cloud == 'a
+0001db10: 7773 273a 0a20 2020 2020 2020 2072 6567  ws':.        reg
+0001db20: 696f 6e20 3d20 2765 752d 6365 6e74 7261  ion = 'eu-centra
+0001db30: 6c2d 3127 0a20 2020 2020 2020 2072 6567  l-1'.        reg
+0001db40: 696f 6e5f 666c 6167 203d 2066 2720 2d2d  ion_flag = f' --
+0001db50: 7265 6769 6f6e 207b 7265 6769 6f6e 7d27  region {region}'
+0001db60: 0a20 2020 2020 2020 2072 6567 696f 6e5f  .        region_
+0001db70: 636d 6420 3d20 5465 7374 5374 6f72 6167  cmd = TestStorag
+0001db80: 6557 6974 6843 7265 6465 6e74 6961 6c73  eWithCredentials
+0001db90: 2e63 6c69 5f72 6567 696f 6e5f 636d 6428  .cli_region_cmd(
+0001dba0: 0a20 2020 2020 2020 2020 2020 2073 746f  .            sto
+0001dbb0: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
+0001dbc0: 7065 2e53 332c 2073 746f 7261 6765 5f6e  pe.S3, storage_n
+0001dbd0: 616d 6529 0a20 2020 2020 2020 2072 6567  ame).        reg
+0001dbe0: 696f 6e5f 7661 6c69 6461 7469 6f6e 5f63  ion_validation_c
+0001dbf0: 6d64 203d 2066 277b 7265 6769 6f6e 5f63  md = f'{region_c
+0001dc00: 6d64 7d20 7c20 6772 6570 207b 7265 6769  md} | grep {regi
+0001dc10: 6f6e 7d27 0a20 2020 2065 6c69 6620 6765  on}'.    elif ge
+0001dc20: 6e65 7269 635f 636c 6f75 6420 3d3d 2027  neric_cloud == '
+0001dc30: 6763 7027 3a0a 2020 2020 2020 2020 7265  gcp':.        re
+0001dc40: 6769 6f6e 203d 2027 7573 2d77 6573 7432  gion = 'us-west2
+0001dc50: 270a 2020 2020 2020 2020 7265 6769 6f6e  '.        region
+0001dc60: 5f66 6c61 6720 3d20 6627 202d 2d72 6567  _flag = f' --reg
+0001dc70: 696f 6e20 7b72 6567 696f 6e7d 270a 2020  ion {region}'.  
+0001dc80: 2020 2020 2020 7265 6769 6f6e 5f63 6d64        region_cmd
+0001dc90: 203d 2054 6573 7453 746f 7261 6765 5769   = TestStorageWi
+0001dca0: 7468 4372 6564 656e 7469 616c 732e 636c  thCredentials.cl
+0001dcb0: 695f 7265 6769 6f6e 5f63 6d64 280a 2020  i_region_cmd(.  
+0001dcc0: 2020 2020 2020 2020 2020 7374 6f72 6167            storag
+0001dcd0: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
+0001dce0: 4743 532c 2073 746f 7261 6765 5f6e 616d  GCS, storage_nam
+0001dcf0: 6529 0a20 2020 2020 2020 2072 6567 696f  e).        regio
+0001dd00: 6e5f 7661 6c69 6461 7469 6f6e 5f63 6d64  n_validation_cmd
+0001dd10: 203d 2066 277b 7265 6769 6f6e 5f63 6d64   = f'{region_cmd
+0001dd20: 7d20 7c20 6772 6570 207b 7265 6769 6f6e  } | grep {region
+0001dd30: 7d27 0a0a 2020 2020 7961 6d6c 5f73 7472  }'..    yaml_str
+0001dd40: 203d 2079 616d 6c5f 7374 722e 7265 706c   = yaml_str.repl
+0001dd50: 6163 6528 2773 6b79 2d77 6f72 6b64 6972  ace('sky-workdir
+0001dd60: 2d7a 6877 7527 2c20 7374 6f72 6167 655f  -zhwu', storage_
+0001dd70: 6e61 6d65 290a 2020 2020 7769 7468 2074  name).    with t
+0001dd80: 656d 7066 696c 652e 4e61 6d65 6454 656d  empfile.NamedTem
+0001dd90: 706f 7261 7279 4669 6c65 2873 7566 6669  poraryFile(suffi
+0001dda0: 783d 272e 7961 6d6c 272c 206d 6f64 653d  x='.yaml', mode=
+0001ddb0: 2777 2729 2061 7320 663a 0a20 2020 2020  'w') as f:.     
+0001ddc0: 2020 2066 2e77 7269 7465 2879 616d 6c5f     f.write(yaml_
+0001ddd0: 7374 7229 0a20 2020 2020 2020 2066 2e66  str).        f.f
+0001dde0: 6c75 7368 2829 0a20 2020 2020 2020 2066  lush().        f
+0001ddf0: 696c 655f 7061 7468 203d 2066 2e6e 616d  ile_path = f.nam
+0001de00: 650a 2020 2020 2020 2020 7465 7374 203d  e.        test =
+0001de10: 2054 6573 7428 0a20 2020 2020 2020 2020   Test(.         
+0001de20: 2020 2027 6d61 6e61 6765 645f 6a6f 6273     'managed_jobs
+0001de30: 5f73 746f 7261 6765 272c 0a20 2020 2020  _storage',.     
+0001de40: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
+0001de50: 2020 2020 2020 2020 202a 7374 6f72 6167           *storag
+0001de60: 655f 7365 7475 705f 636f 6d6d 616e 6473  e_setup_commands
+0001de70: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001de80: 2020 6627 736b 7920 6a6f 6273 206c 6175    f'sky jobs lau
+0001de90: 6e63 6820 2d6e 207b 6e61 6d65 7d20 2d2d  nch -n {name} --
+0001dea0: 7573 652d 7370 6f74 202d 2d63 6c6f 7564  use-spot --cloud
+0001deb0: 207b 6765 6e65 7269 635f 636c 6f75 647d   {generic_cloud}
+0001dec0: 7b72 6567 696f 6e5f 666c 6167 7d20 7b66  {region_flag} {f
+0001ded0: 696c 655f 7061 7468 7d20 2d79 272c 0a20  ile_path} -y',. 
+0001dee0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0001def0: 6567 696f 6e5f 7661 6c69 6461 7469 6f6e  egion_validation
+0001df00: 5f63 6d64 2c20 2023 2043 6865 636b 2069  _cmd,  # Check i
+0001df10: 6620 7468 6520 6275 636b 6574 2069 7320  f the bucket is 
+0001df20: 6372 6561 7465 6420 696e 2074 6865 2063  created in the c
+0001df30: 6f72 7265 6374 2072 6567 696f 6e0a 2020  orrect region.  
+0001df40: 2020 2020 2020 2020 2020 2020 2020 2773                's
+0001df50: 6c65 6570 2036 3027 2c20 2023 2057 6169  leep 60',  # Wai
+0001df60: 7420 7468 6520 7370 6f74 2071 7565 7565  t the spot queue
+0001df70: 2074 6f20 6265 2075 7064 6174 6564 0a20   to be updated. 
+0001df80: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0001df90: 277b 5f4a 4f42 5f51 5545 5545 5f57 4149  '{_JOB_QUEUE_WAI
+0001dfa0: 547d 7c20 6772 6570 207b 6e61 6d65 7d20  T}| grep {name} 
+0001dfb0: 7c20 6772 6570 2053 5543 4345 4544 4544  | grep SUCCEEDED
+0001dfc0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+0001dfd0: 2020 2066 275b 2024 2861 7773 2073 3361     f'[ $(aws s3a
+0001dfe0: 7069 206c 6973 742d 6275 636b 6574 7320  pi list-buckets 
+0001dff0: 2d2d 7175 6572 7920 2242 7563 6b65 7473  --query "Buckets
+0001e000: 5b3f 636f 6e74 6169 6e73 284e 616d 652c  [?contains(Name,
+0001e010: 205c 277b 7374 6f72 6167 655f 6e61 6d65   \'{storage_name
+0001e020: 7d5c 2729 5d2e 4e61 6d65 2220 2d2d 6f75  }\')].Name" --ou
+0001e030: 7470 7574 2074 6578 7420 7c20 7763 202d  tput text | wc -
+0001e040: 6c29 202d 6571 2030 205d 270a 2020 2020  l) -eq 0 ]'.    
+0001e050: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
+0001e060: 2020 2020 2020 205f 4a4f 425f 4341 4e43         _JOB_CANC
+0001e070: 454c 5f57 4149 542e 666f 726d 6174 286a  EL_WAIT.format(j
+0001e080: 6f62 5f6e 616d 653d 6e61 6d65 292c 0a20  ob_name=name),. 
+0001e090: 2020 2020 2020 2020 2020 2023 2049 6e63             # Inc
+0001e0a0: 7265 6173 6520 7469 6d65 6f75 7420 7369  rease timeout si
+0001e0b0: 6e63 6520 736b 7920 6a6f 6273 2071 7565  nce sky jobs que
+0001e0c0: 7565 202d 7220 6361 6e20 6265 2062 6c6f  ue -r can be blo
+0001e0d0: 636b 6564 2062 7920 6f74 6865 7220 7370  cked by other sp
+0001e0e0: 6f74 2074 6573 7473 2e0a 2020 2020 2020  ot tests..      
+0001e0f0: 2020 2020 2020 7469 6d65 6f75 743d 3230        timeout=20
+0001e100: 202a 2036 302c 0a20 2020 2020 2020 2029   * 60,.        )
+0001e110: 0a20 2020 2020 2020 2072 756e 5f6f 6e65  .        run_one
+0001e120: 5f74 6573 7428 7465 7374 290a 0a0a 2320  _test(test)...# 
+0001e130: 2d2d 2d2d 2d2d 2d2d 2d2d 2054 6573 7469  ---------- Testi
+0001e140: 6e67 2073 706f 7420 5450 5520 2d2d 2d2d  ng spot TPU ----
+0001e150: 2d2d 2d2d 2d2d 0a40 7079 7465 7374 2e6d  ------.@pytest.m
+0001e160: 6172 6b2e 6763 700a 4070 7974 6573 742e  ark.gcp.@pytest.
+0001e170: 6d61 726b 2e6d 616e 6167 6564 5f6a 6f62  mark.managed_job
+0001e180: 730a 4070 7974 6573 742e 6d61 726b 2e74  s.@pytest.mark.t
+0001e190: 7075 0a64 6566 2074 6573 745f 6d61 6e61  pu.def test_mana
+0001e1a0: 6765 645f 6a6f 6273 5f74 7075 2829 3a0a  ged_jobs_tpu():.
+0001e1b0: 2020 2020 2222 2254 6573 7420 6d61 6e61      """Test mana
+0001e1c0: 6765 6420 6a6f 6220 6f6e 2054 5055 2e22  ged job on TPU."
+0001e1d0: 2222 0a20 2020 206e 616d 6520 3d20 5f67  "".    name = _g
+0001e1e0: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
+0001e1f0: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
+0001e200: 7428 0a20 2020 2020 2020 2027 7465 7374  t(.        'test
+0001e210: 2d73 706f 742d 7470 7527 2c0a 2020 2020  -spot-tpu',.    
+0001e220: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
+0001e230: 2020 6627 736b 7920 6a6f 6273 206c 6175    f'sky jobs lau
+0001e240: 6e63 6820 2d6e 207b 6e61 6d65 7d20 2d2d  nch -n {name} --
+0001e250: 7573 652d 7370 6f74 2065 7861 6d70 6c65  use-spot example
+0001e260: 732f 7470 752f 7470 7576 6d5f 6d6e 6973  s/tpu/tpuvm_mnis
+0001e270: 742e 7961 6d6c 202d 7920 2d64 272c 0a20  t.yaml -y -d',. 
+0001e280: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+0001e290: 7020 3527 2c0a 2020 2020 2020 2020 2020  p 5',.          
+0001e2a0: 2020 6627 7b5f 4a4f 425f 5155 4555 455f    f'{_JOB_QUEUE_
+0001e2b0: 5741 4954 7d7c 2067 7265 7020 7b6e 616d  WAIT}| grep {nam
+0001e2c0: 657d 207c 2068 6561 6420 2d6e 3120 7c20  e} | head -n1 | 
+0001e2d0: 6772 6570 2053 5441 5254 494e 4727 2c0a  grep STARTING',.
+0001e2e0: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
+0001e2f0: 6570 2039 3030 272c 2020 2320 5450 5520  ep 900',  # TPU 
+0001e300: 7461 6b65 7320 6120 7768 696c 6520 746f  takes a while to
+0001e310: 206c 6175 6e63 680a 2020 2020 2020 2020   launch.        
+0001e320: 2020 2020 6627 7b5f 4a4f 425f 5155 4555      f'{_JOB_QUEU
+0001e330: 455f 5741 4954 7d7c 2067 7265 7020 7b6e  E_WAIT}| grep {n
+0001e340: 616d 657d 207c 2068 6561 6420 2d6e 3120  ame} | head -n1 
+0001e350: 7c20 6772 6570 2022 5255 4e4e 494e 475c  | grep "RUNNING\
+0001e360: 7c53 5543 4345 4544 4544 2227 2c0a 2020  |SUCCEEDED"',.  
+0001e370: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
+0001e380: 205f 4a4f 425f 4341 4e43 454c 5f57 4149   _JOB_CANCEL_WAI
+0001e390: 542e 666f 726d 6174 286a 6f62 5f6e 616d  T.format(job_nam
+0001e3a0: 653d 6e61 6d65 292c 0a20 2020 2020 2020  e=name),.       
+0001e3b0: 2023 2049 6e63 7265 6173 6520 7469 6d65   # Increase time
+0001e3c0: 6f75 7420 7369 6e63 6520 736b 7920 6a6f  out since sky jo
+0001e3d0: 6273 2071 7565 7565 202d 7220 6361 6e20  bs queue -r can 
+0001e3e0: 6265 2062 6c6f 636b 6564 2062 7920 6f74  be blocked by ot
+0001e3f0: 6865 7220 7370 6f74 2074 6573 7473 2e0a  her spot tests..
+0001e400: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
+0001e410: 3230 202a 2036 302c 0a20 2020 2029 0a20  20 * 60,.    ). 
+0001e420: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+0001e430: 7465 7374 290a 0a0a 2320 2d2d 2d2d 2d2d  test)...# ------
+0001e440: 2d2d 2d2d 2054 6573 7469 6e67 2065 6e76  ---- Testing env
+0001e450: 2066 6f72 206d 616e 6167 6564 206a 6f62   for managed job
+0001e460: 7320 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079  s ----------.@py
+0001e470: 7465 7374 2e6d 6172 6b2e 6d61 6e61 6765  test.mark.manage
+0001e480: 645f 6a6f 6273 0a64 6566 2074 6573 745f  d_jobs.def test_
+0001e490: 6d61 6e61 6765 645f 6a6f 6273 5f69 6e6c  managed_jobs_inl
+0001e4a0: 696e 655f 656e 7628 6765 6e65 7269 635f  ine_env(generic_
+0001e4b0: 636c 6f75 643a 2073 7472 293a 0a20 2020  cloud: str):.   
+0001e4c0: 2022 2222 5465 7374 206d 616e 6167 6564   """Test managed
+0001e4d0: 206a 6f62 7320 656e 7622 2222 0a20 2020   jobs env""".   
+0001e4e0: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
+0001e4f0: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
+0001e500: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
+0001e510: 2020 2020 2027 7465 7374 2d6d 616e 6167       'test-manag
+0001e520: 6564 2d6a 6f62 732d 696e 6c69 6e65 2d65  ed-jobs-inline-e
+0001e530: 6e76 272c 0a20 2020 2020 2020 205b 0a20  nv',.        [. 
+0001e540: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0001e550: 206a 6f62 7320 6c61 756e 6368 202d 6e20   jobs launch -n 
+0001e560: 7b6e 616d 657d 202d 7920 2d2d 636c 6f75  {name} -y --clou
+0001e570: 6420 7b67 656e 6572 6963 5f63 6c6f 7564  d {generic_cloud
+0001e580: 7d20 2d2d 656e 7620 5445 5354 5f45 4e56  } --env TEST_ENV
+0001e590: 3d22 6865 6c6c 6f20 776f 726c 6422 202d  ="hello world" -
+0001e5a0: 2d20 2228 5b5b 2021 202d 7a20 5c5c 225c  - "([[ ! -z \\"\
+0001e5b0: 2454 4553 545f 454e 565c 5c22 205d 5d20  $TEST_ENV\\" ]] 
+0001e5c0: 2626 205b 5b20 2120 2d7a 205c 5c22 5c24  && [[ ! -z \\"\$
+0001e5d0: 534b 5950 494c 4f54 5f4e 4f44 455f 4950  SKYPILOT_NODE_IP
+0001e5e0: 535c 5c22 205d 5d20 2626 205b 5b20 2120  S\\" ]] && [[ ! 
+0001e5f0: 2d7a 205c 5c22 5c24 534b 5950 494c 4f54  -z \\"\$SKYPILOT
+0001e600: 5f4e 4f44 455f 5241 4e4b 5c5c 2220 5d5d  _NODE_RANK\\" ]]
+0001e610: 2920 7c7c 2065 7869 7420 3122 272c 0a20  ) || exit 1"',. 
+0001e620: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+0001e630: 7020 3230 272c 0a20 2020 2020 2020 2020  p 20',.         
+0001e640: 2020 2066 277b 5f4a 4f42 5f51 5545 5545     f'{_JOB_QUEUE
+0001e650: 5f57 4149 547d 207c 2067 7265 7020 7b6e  _WAIT} | grep {n
+0001e660: 616d 657d 207c 2067 7265 7020 5355 4343  ame} | grep SUCC
+0001e670: 4545 4445 4427 2c0a 2020 2020 2020 2020  EEDED',.        
+0001e680: 5d2c 0a20 2020 2020 2020 205f 4a4f 425f  ],.        _JOB_
+0001e690: 4341 4e43 454c 5f57 4149 542e 666f 726d  CANCEL_WAIT.form
+0001e6a0: 6174 286a 6f62 5f6e 616d 653d 6e61 6d65  at(job_name=name
+0001e6b0: 292c 0a20 2020 2020 2020 2023 2049 6e63  ),.        # Inc
+0001e6c0: 7265 6173 6520 7469 6d65 6f75 7420 7369  rease timeout si
+0001e6d0: 6e63 6520 736b 7920 6a6f 6273 2071 7565  nce sky jobs que
+0001e6e0: 7565 202d 7220 6361 6e20 6265 2062 6c6f  ue -r can be blo
+0001e6f0: 636b 6564 2062 7920 6f74 6865 7220 7370  cked by other sp
+0001e700: 6f74 2074 6573 7473 2e0a 2020 2020 2020  ot tests..      
+0001e710: 2020 7469 6d65 6f75 743d 3230 202a 2036    timeout=20 * 6
+0001e720: 302c 0a20 2020 2029 0a20 2020 2072 756e  0,.    ).    run
+0001e730: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
+0001e740: 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054  ..# ---------- T
+0001e750: 6573 7469 6e67 2065 6e76 202d 2d2d 2d2d  esting env -----
+0001e760: 2d2d 2d2d 2d0a 6465 6620 7465 7374 5f69  -----.def test_i
+0001e770: 6e6c 696e 655f 656e 7628 6765 6e65 7269  nline_env(generi
+0001e780: 635f 636c 6f75 643a 2073 7472 293a 0a20  c_cloud: str):. 
+0001e790: 2020 2022 2222 5465 7374 2065 6e76 2222     """Test env""
+0001e7a0: 220a 2020 2020 6e61 6d65 203d 205f 6765  ".    name = _ge
+0001e7b0: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
+0001e7c0: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
+0001e7d0: 280a 2020 2020 2020 2020 2774 6573 742d  (.        'test-
+0001e7e0: 696e 6c69 6e65 2d65 6e76 272c 0a20 2020  inline-env',.   
+0001e7f0: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
+0001e800: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
+0001e810: 2d63 207b 6e61 6d65 7d20 2d79 202d 2d63  -c {name} -y --c
+0001e820: 6c6f 7564 207b 6765 6e65 7269 635f 636c  loud {generic_cl
+0001e830: 6f75 647d 202d 2d65 6e76 2054 4553 545f  oud} --env TEST_
+0001e840: 454e 563d 2268 656c 6c6f 2077 6f72 6c64  ENV="hello world
+0001e850: 2220 2d2d 2022 285b 5b20 2120 2d7a 205c  " -- "([[ ! -z \
+0001e860: 5c22 5c24 5445 5354 5f45 4e56 5c5c 2220  \"\$TEST_ENV\\" 
+0001e870: 5d5d 2026 2620 5b5b 2021 202d 7a20 5c5c  ]] && [[ ! -z \\
+0001e880: 225c 2453 4b59 5049 4c4f 545f 4e4f 4445  "\$SKYPILOT_NODE
+0001e890: 5f49 5053 5c5c 2220 5d5d 2026 2620 5b5b  _IPS\\" ]] && [[
+0001e8a0: 2021 202d 7a20 5c5c 225c 2453 4b59 5049   ! -z \\"\$SKYPI
+0001e8b0: 4c4f 545f 4e4f 4445 5f52 414e 4b5c 5c22  LOT_NODE_RANK\\"
+0001e8c0: 205d 5d29 207c 7c20 6578 6974 2031 2227   ]]) || exit 1"'
+0001e8d0: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
+0001e8e0: 6c65 6570 2032 3027 2c0a 2020 2020 2020  leep 20',.      
+0001e8f0: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
+0001e900: 207b 6e61 6d65 7d20 3120 2d2d 7374 6174   {name} 1 --stat
+0001e910: 7573 272c 0a20 2020 2020 2020 2020 2020  us',.           
+0001e920: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
+0001e930: 657d 202d 2d65 6e76 2054 4553 545f 454e  e} --env TEST_EN
+0001e940: 5632 3d22 7375 6363 6573 7322 2022 285b  V2="success" "([
+0001e950: 5b20 2120 2d7a 205c 5c22 5c24 5445 5354  [ ! -z \\"\$TEST
+0001e960: 5f45 4e56 325c 5c22 205d 5d20 2626 205b  _ENV2\\" ]] && [
+0001e970: 5b20 2120 2d7a 205c 5c22 5c24 534b 5950  [ ! -z \\"\$SKYP
+0001e980: 494c 4f54 5f4e 4f44 455f 4950 535c 5c22  ILOT_NODE_IPS\\"
+0001e990: 205d 5d20 2626 205b 5b20 2120 2d7a 205c   ]] && [[ ! -z \
+0001e9a0: 5c22 5c24 534b 5950 494c 4f54 5f4e 4f44  \"\$SKYPILOT_NOD
+0001e9b0: 455f 5241 4e4b 5c5c 2220 5d5d 2920 7c7c  E_RANK\\" ]]) ||
+0001e9c0: 2065 7869 7420 3122 272c 0a20 2020 2020   exit 1"',.     
+0001e9d0: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+0001e9e0: 7320 7b6e 616d 657d 2032 202d 2d73 7461  s {name} 2 --sta
+0001e9f0: 7475 7327 2c0a 2020 2020 2020 2020 5d2c  tus',.        ],
+0001ea00: 0a20 2020 2020 2020 2066 2773 6b79 2064  .        f'sky d
+0001ea10: 6f77 6e20 2d79 207b 6e61 6d65 7d27 2c0a  own -y {name}',.
+0001ea20: 2020 2020 2020 2020 5f67 6574 5f74 696d          _get_tim
+0001ea30: 656f 7574 2867 656e 6572 6963 5f63 6c6f  eout(generic_clo
+0001ea40: 7564 292c 0a20 2020 2029 0a20 2020 2072  ud),.    ).    r
+0001ea50: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
+0001ea60: 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d  )...# ----------
+0001ea70: 2054 6573 7469 6e67 2065 6e76 2066 696c   Testing env fil
+0001ea80: 6520 2d2d 2d2d 2d2d 2d2d 2d2d 0a64 6566  e ----------.def
+0001ea90: 2074 6573 745f 696e 6c69 6e65 5f65 6e76   test_inline_env
+0001eaa0: 5f66 696c 6528 6765 6e65 7269 635f 636c  _file(generic_cl
+0001eab0: 6f75 643a 2073 7472 293a 0a20 2020 2022  oud: str):.    "
+0001eac0: 2222 5465 7374 2065 6e76 2222 220a 2020  ""Test env""".  
+0001ead0: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
+0001eae0: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
+0001eaf0: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+0001eb00: 2020 2020 2020 2774 6573 742d 696e 6c69        'test-inli
+0001eb10: 6e65 2d65 6e76 2d66 696c 6527 2c0a 2020  ne-env-file',.  
+0001eb20: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+0001eb30: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
+0001eb40: 202d 6320 7b6e 616d 657d 202d 7920 2d2d   -c {name} -y --
+0001eb50: 636c 6f75 6420 7b67 656e 6572 6963 5f63  cloud {generic_c
+0001eb60: 6c6f 7564 7d20 2d2d 656e 7620 5445 5354  loud} --env TEST
+0001eb70: 5f45 4e56 3d22 6865 6c6c 6f20 776f 726c  _ENV="hello worl
+0001eb80: 6422 202d 2d20 2228 5b5b 2021 202d 7a20  d" -- "([[ ! -z 
+0001eb90: 5c5c 225c 2454 4553 545f 454e 565c 5c22  \\"\$TEST_ENV\\"
+0001eba0: 205d 5d20 2626 205b 5b20 2120 2d7a 205c   ]] && [[ ! -z \
+0001ebb0: 5c22 5c24 534b 5950 494c 4f54 5f4e 4f44  \"\$SKYPILOT_NOD
+0001ebc0: 455f 4950 535c 5c22 205d 5d20 2626 205b  E_IPS\\" ]] && [
+0001ebd0: 5b20 2120 2d7a 205c 5c22 5c24 534b 5950  [ ! -z \\"\$SKYP
+0001ebe0: 494c 4f54 5f4e 4f44 455f 5241 4e4b 5c5c  ILOT_NODE_RANK\\
+0001ebf0: 2220 5d5d 2920 7c7c 2065 7869 7420 3122  " ]]) || exit 1"
+0001ec00: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0001ec10: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
+0001ec20: 2031 202d 2d73 7461 7475 7327 2c0a 2020   1 --status',.  
+0001ec30: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0001ec40: 6578 6563 207b 6e61 6d65 7d20 2d2d 656e  exec {name} --en
+0001ec50: 762d 6669 6c65 2065 7861 6d70 6c65 732f  v-file examples/
+0001ec60: 7361 6d70 6c65 5f64 6f74 656e 7620 2228  sample_dotenv "(
+0001ec70: 5b5b 2021 202d 7a20 5c5c 225c 2454 4553  [[ ! -z \\"\$TES
+0001ec80: 545f 454e 5632 5c5c 2220 5d5d 2026 2620  T_ENV2\\" ]] && 
+0001ec90: 5b5b 2021 202d 7a20 5c5c 225c 2453 4b59  [[ ! -z \\"\$SKY
+0001eca0: 5049 4c4f 545f 4e4f 4445 5f49 5053 5c5c  PILOT_NODE_IPS\\
+0001ecb0: 2220 5d5d 2026 2620 5b5b 2021 202d 7a20  " ]] && [[ ! -z 
+0001ecc0: 5c5c 225c 2453 4b59 5049 4c4f 545f 4e4f  \\"\$SKYPILOT_NO
+0001ecd0: 4445 5f52 414e 4b5c 5c22 205d 5d29 207c  DE_RANK\\" ]]) |
+0001ece0: 7c20 6578 6974 2031 2227 2c0a 2020 2020  | exit 1"',.    
+0001ecf0: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+0001ed00: 6773 207b 6e61 6d65 7d20 3220 2d2d 7374  gs {name} 2 --st
+0001ed10: 6174 7573 272c 0a20 2020 2020 2020 205d  atus',.        ]
+0001ed20: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
+0001ed30: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
+0001ed40: 0a20 2020 2020 2020 205f 6765 745f 7469  .        _get_ti
+0001ed50: 6d65 6f75 7428 6765 6e65 7269 635f 636c  meout(generic_cl
+0001ed60: 6f75 6429 2c0a 2020 2020 290a 2020 2020  oud),.    ).    
+0001ed70: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
+0001ed80: 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d  t)...# ---------
+0001ed90: 2d20 5465 7374 696e 6720 6375 7374 6f6d  - Testing custom
+0001eda0: 2069 6d61 6765 202d 2d2d 2d2d 2d2d 2d2d   image ---------
+0001edb0: 2d0a 4070 7974 6573 742e 6d61 726b 2e61  -.@pytest.mark.a
+0001edc0: 7773 0a64 6566 2074 6573 745f 6177 735f  ws.def test_aws_
+0001edd0: 6375 7374 6f6d 5f69 6d61 6765 2829 3a0a  custom_image():.
+0001ede0: 2020 2020 2222 2254 6573 7420 4157 5320      """Test AWS 
+0001edf0: 6375 7374 6f6d 2069 6d61 6765 2222 220a  custom image""".
+0001ee00: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
+0001ee10: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
+0001ee20: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
+0001ee30: 2020 2020 2020 2020 2774 6573 742d 6177          'test-aw
+0001ee40: 732d 6375 7374 6f6d 2d69 6d61 6765 272c  s-custom-image',
+0001ee50: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
+0001ee60: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
+0001ee70: 6e63 6820 2d63 207b 6e61 6d65 7d20 2d2d  nch -c {name} --
+0001ee80: 7265 7472 792d 756e 7469 6c2d 7570 202d  retry-until-up -
+0001ee90: 7920 7465 7374 732f 7465 7374 5f79 616d  y tests/test_yam
+0001eea0: 6c73 2f74 6573 745f 6375 7374 6f6d 5f69  ls/test_custom_i
+0001eeb0: 6d61 6765 2e79 616d 6c20 2d2d 636c 6f75  mage.yaml --clou
+0001eec0: 6420 6177 7320 2d2d 7265 6769 6f6e 2075  d aws --region u
+0001eed0: 732d 6561 7374 2d32 202d 2d69 6d61 6765  s-east-2 --image
+0001eee0: 2d69 6420 616d 692d 3036 3264 6464 3930  -id ami-062ddd90
+0001eef0: 6662 3666 3832 3637 6127 2c20 2023 204e  fb6f8267a',  # N
+0001ef00: 7669 6469 6120 696d 6167 650a 2020 2020  vidia image.    
+0001ef10: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+0001ef20: 6773 207b 6e61 6d65 7d20 3120 2d2d 7374  gs {name} 1 --st
+0001ef30: 6174 7573 272c 0a20 2020 2020 2020 205d  atus',.        ]
+0001ef40: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
+0001ef50: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
+0001ef60: 0a20 2020 2020 2020 2074 696d 656f 7574  .        timeout
+0001ef70: 3d33 3020 2a20 3630 2c0a 2020 2020 290a  =30 * 60,.    ).
+0001ef80: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
+0001ef90: 2874 6573 7429 0a0a 0a40 7079 7465 7374  (test)...@pytest
+0001efa0: 2e6d 6172 6b2e 6b75 6265 726e 6574 6573  .mark.kubernetes
+0001efb0: 0a40 7079 7465 7374 2e6d 6172 6b2e 7061  .@pytest.mark.pa
+0001efc0: 7261 6d65 7472 697a 6528 0a20 2020 2027  rametrize(.    '
+0001efd0: 696d 6167 655f 6964 272c 0a20 2020 205b  image_id',.    [
+0001efe0: 0a20 2020 2020 2020 2027 646f 636b 6572  .        'docker
+0001eff0: 3a6e 7669 6469 612f 6375 6461 3a31 312e  :nvidia/cuda:11.
+0001f000: 382e 302d 6465 7665 6c2d 7562 756e 7475  8.0-devel-ubuntu
+0001f010: 3138 2e30 3427 2c0a 2020 2020 2020 2020  18.04',.        
+0001f020: 2764 6f63 6b65 723a 7562 756e 7475 3a31  'docker:ubuntu:1
+0001f030: 382e 3034 272c 0a20 2020 2020 2020 2023  8.04',.        #
+0001f040: 2054 6573 7420 6c61 7465 7374 2069 6d61   Test latest ima
+0001f050: 6765 2077 6974 6820 7079 7468 6f6e 2033  ge with python 3
+0001f060: 2e31 3120 696e 7374 616c 6c65 6420 6279  .11 installed by
+0001f070: 2064 6566 6175 6c74 2e0a 2020 2020 2020   default..      
+0001f080: 2020 2320 446f 6573 206e 6f74 2077 6f72    # Does not wor
+0001f090: 6b20 666f 7220 7079 7468 6f6e 2033 2e31  k for python 3.1
+0001f0a0: 3220 6475 6520 746f 2072 6179 2773 2072  2 due to ray's r
+0001f0b0: 6571 7569 7265 6d65 6e74 2066 6f72 2033  equirement for 3
+0001f0c0: 2e31 312e 0a20 2020 2020 2020 2027 646f  .11..        'do
+0001f0d0: 636b 6572 3a63 6f6e 7469 6e75 756d 696f  cker:continuumio
+0001f0e0: 2f6d 696e 6963 6f6e 6461 333a 3234 2e31  /miniconda3:24.1
+0001f0f0: 2e32 2d30 272c 0a20 2020 205d 290a 6465  .2-0',.    ]).de
+0001f100: 6620 7465 7374 5f6b 7562 6572 6e65 7465  f test_kubernete
+0001f110: 735f 6375 7374 6f6d 5f69 6d61 6765 2869  s_custom_image(i
+0001f120: 6d61 6765 5f69 6429 3a0a 2020 2020 2222  mage_id):.    ""
+0001f130: 2254 6573 7420 4b75 6265 726e 6574 6573  "Test Kubernetes
+0001f140: 2063 7573 746f 6d20 696d 6167 6522 2222   custom image"""
+0001f150: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
+0001f160: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
+0001f170: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
+0001f180: 0a20 2020 2020 2020 2027 7465 7374 2d6b  .        'test-k
+0001f190: 7562 6572 6e65 7465 732d 6375 7374 6f6d  ubernetes-custom
+0001f1a0: 2d69 6d61 6765 272c 0a20 2020 2020 2020  -image',.       
+0001f1b0: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
+0001f1c0: 2773 6b79 206c 6175 6e63 6820 2d63 207b  'sky launch -c {
+0001f1d0: 6e61 6d65 7d20 2d2d 7265 7472 792d 756e  name} --retry-un
+0001f1e0: 7469 6c2d 7570 202d 7920 7465 7374 732f  til-up -y tests/
+0001f1f0: 7465 7374 5f79 616d 6c73 2f74 6573 745f  test_yamls/test_
+0001f200: 6375 7374 6f6d 5f69 6d61 6765 2e79 616d  custom_image.yam
+0001f210: 6c20 2d2d 636c 6f75 6420 6b75 6265 726e  l --cloud kubern
+0001f220: 6574 6573 202d 2d69 6d61 6765 2d69 6420  etes --image-id 
+0001f230: 7b69 6d61 6765 5f69 647d 202d 2d72 6567  {image_id} --reg
+0001f240: 696f 6e20 4e6f 6e65 202d 2d67 7075 7320  ion None --gpus 
+0001f250: 5434 3a31 272c 0a20 2020 2020 2020 2020  T4:1',.         
+0001f260: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+0001f270: 616d 657d 2031 202d 2d73 7461 7475 7327  ame} 1 --status'
+0001f280: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
+0001f290: 5472 7920 6578 6563 2074 6f20 7275 6e20  Try exec to run 
+0001f2a0: 6167 6169 6e20 616e 6420 6368 6563 6b20  again and check 
+0001f2b0: 6966 2074 6865 206c 6f67 7320 6172 6520  if the logs are 
+0001f2c0: 7072 696e 7465 640a 2020 2020 2020 2020  printed.        
+0001f2d0: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
+0001f2e0: 6e61 6d65 7d20 7465 7374 732f 7465 7374  name} tests/test
+0001f2f0: 5f79 616d 6c73 2f74 6573 745f 6375 7374  _yamls/test_cust
+0001f300: 6f6d 5f69 6d61 6765 2e79 616d 6c20 2d2d  om_image.yaml --
+0001f310: 636c 6f75 6420 6b75 6265 726e 6574 6573  cloud kubernetes
+0001f320: 202d 2d69 6d61 6765 2d69 6420 7b69 6d61   --image-id {ima
+0001f330: 6765 5f69 647d 202d 2d72 6567 696f 6e20  ge_id} --region 
+0001f340: 4e6f 6e65 202d 2d67 7075 7320 5434 3a31  None --gpus T4:1
+0001f350: 207c 2067 7265 7020 2248 656c 6c6f 2031   | grep "Hello 1
+0001f360: 3030 2227 2c0a 2020 2020 2020 2020 2020  00"',.          
+0001f370: 2020 2320 4d61 6b65 2073 7572 6520 7373    # Make sure ss
+0001f380: 6820 6973 2077 6f72 6b69 6e67 2077 6974  h is working wit
+0001f390: 6820 6375 7374 6f6d 2075 7365 726e 616d  h custom usernam
+0001f3a0: 650a 2020 2020 2020 2020 2020 2020 6627  e.            f'
+0001f3b0: 7373 6820 7b6e 616d 657d 2065 6368 6f20  ssh {name} echo 
+0001f3c0: 6869 207c 2067 7265 7020 6869 272c 0a20  hi | grep hi',. 
+0001f3d0: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
+0001f3e0: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
+0001f3f0: 7b6e 616d 657d 272c 0a20 2020 2020 2020  {name}',.       
+0001f400: 2074 696d 656f 7574 3d33 3020 2a20 3630   timeout=30 * 60
+0001f410: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
+0001f420: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
+0001f430: 0a40 7079 7465 7374 2e6d 6172 6b2e 736c  .@pytest.mark.sl
+0001f440: 6f77 0a64 6566 2074 6573 745f 617a 7572  ow.def test_azur
+0001f450: 655f 7374 6172 745f 7374 6f70 5f74 776f  e_start_stop_two
+0001f460: 5f6e 6f64 6573 2829 3a0a 2020 2020 6e61  _nodes():.    na
+0001f470: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
+0001f480: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
+0001f490: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
+0001f4a0: 2020 2761 7a75 7265 2d73 7461 7274 2d73    'azure-start-s
+0001f4b0: 746f 702d 7477 6f2d 6e6f 6465 7327 2c0a  top-two-nodes',.
+0001f4c0: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
+0001f4d0: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
+0001f4e0: 6368 202d 2d6e 756d 2d6e 6f64 6573 3d32  ch --num-nodes=2
+0001f4f0: 202d 7920 2d63 207b 6e61 6d65 7d20 6578   -y -c {name} ex
+0001f500: 616d 706c 6573 2f61 7a75 7265 5f73 7461  amples/azure_sta
+0001f510: 7274 5f73 746f 702e 7961 6d6c 272c 0a20  rt_stop.yaml',. 
+0001f520: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0001f530: 2065 7865 6320 2d2d 6e75 6d2d 6e6f 6465   exec --num-node
+0001f540: 733d 3220 7b6e 616d 657d 2065 7861 6d70  s=2 {name} examp
+0001f550: 6c65 732f 617a 7572 655f 7374 6172 745f  les/azure_start_
+0001f560: 7374 6f70 2e79 616d 6c27 2c0a 2020 2020  stop.yaml',.    
+0001f570: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+0001f580: 6773 207b 6e61 6d65 7d20 3120 2d2d 7374  gs {name} 1 --st
+0001f590: 6174 7573 272c 2020 2320 456e 7375 7265  atus',  # Ensure
+0001f5a0: 2074 6865 206a 6f62 2073 7563 6365 6564   the job succeed
+0001f5b0: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
+0001f5c0: 6627 736b 7920 7374 6f70 202d 7920 7b6e  f'sky stop -y {n
+0001f5d0: 616d 657d 272c 0a20 2020 2020 2020 2020  ame}',.         
+0001f5e0: 2020 2066 2773 6b79 2073 7461 7274 202d     f'sky start -
+0001f5f0: 7920 7b6e 616d 657d 272c 0a20 2020 2020  y {name}',.     
+0001f600: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
+0001f610: 6320 2d2d 6e75 6d2d 6e6f 6465 733d 3220  c --num-nodes=2 
+0001f620: 7b6e 616d 657d 2065 7861 6d70 6c65 732f  {name} examples/
+0001f630: 617a 7572 655f 7374 6172 745f 7374 6f70  azure_start_stop
+0001f640: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
+0001f650: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
+0001f660: 6e61 6d65 7d20 3220 2d2d 7374 6174 7573  name} 2 --status
+0001f670: 272c 2020 2320 456e 7375 7265 2074 6865  ',  # Ensure the
+0001f680: 206a 6f62 2073 7563 6365 6564 6564 2e0a   job succeeded..
+0001f690: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
+0001f6a0: 2020 2066 2773 6b79 2064 6f77 6e20 2d79     f'sky down -y
+0001f6b0: 207b 6e61 6d65 7d27 2c0a 2020 2020 2020   {name}',.      
+0001f6c0: 2020 7469 6d65 6f75 743d 3330 202a 2036    timeout=30 * 6
+0001f6d0: 302c 2020 2320 3330 206d 696e 7320 2028  0,  # 30 mins  (
+0001f6e0: 6974 2074 616b 6573 2061 726f 756e 6420  it takes around 
+0001f6f0: 7e32 3320 6d69 6e73 290a 2020 2020 290a  ~23 mins).    ).
+0001f700: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
+0001f710: 2874 6573 7429 0a0a 0a23 202d 2d2d 2d2d  (test)...# -----
+0001f720: 2d2d 2d2d 2d20 5465 7374 696e 6720 656e  ----- Testing en
+0001f730: 7620 666f 7220 6469 736b 2074 6965 7220  v for disk tier 
+0001f740: 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465  ----------.@pyte
+0001f750: 7374 2e6d 6172 6b2e 6177 730a 6465 6620  st.mark.aws.def 
+0001f760: 7465 7374 5f61 7773 5f64 6973 6b5f 7469  test_aws_disk_ti
+0001f770: 6572 2829 3a0a 0a20 2020 2064 6566 205f  er():..    def _
+0001f780: 6765 745f 6177 735f 7175 6572 795f 636f  get_aws_query_co
+0001f790: 6d6d 616e 6428 7265 6769 6f6e 2c20 696e  mmand(region, in
+0001f7a0: 7374 616e 6365 5f69 642c 2066 6965 6c64  stance_id, field
+0001f7b0: 2c20 6578 7065 6374 6564 293a 0a20 2020  , expected):.   
+0001f7c0: 2020 2020 2072 6574 7572 6e20 2866 2761       return (f'a
+0001f7d0: 7773 2065 6332 2064 6573 6372 6962 652d  ws ec2 describe-
+0001f7e0: 766f 6c75 6d65 7320 2d2d 7265 6769 6f6e  volumes --region
+0001f7f0: 207b 7265 6769 6f6e 7d20 270a 2020 2020   {region} '.    
+0001f800: 2020 2020 2020 2020 2020 2020 6627 2d2d              f'--
+0001f810: 6669 6c74 6572 7320 4e61 6d65 3d61 7474  filters Name=att
+0001f820: 6163 686d 656e 742e 696e 7374 616e 6365  achment.instance
+0001f830: 2d69 642c 5661 6c75 6573 3d7b 696e 7374  -id,Values={inst
+0001f840: 616e 6365 5f69 647d 2027 0a20 2020 2020  ance_id} '.     
+0001f850: 2020 2020 2020 2020 2020 2066 272d 2d71             f'--q
+0001f860: 7565 7279 2056 6f6c 756d 6573 5b2a 5d2e  uery Volumes[*].
+0001f870: 7b66 6965 6c64 7d20 7c20 6772 6570 207b  {field} | grep {
+0001f880: 6578 7065 6374 6564 7d20 3b20 2729 0a0a  expected} ; ')..
+0001f890: 2020 2020 666f 7220 6469 736b 5f74 6965      for disk_tie
+0001f8a0: 7220 696e 206c 6973 7428 7265 736f 7572  r in list(resour
+0001f8b0: 6365 735f 7574 696c 732e 4469 736b 5469  ces_utils.DiskTi
+0001f8c0: 6572 293a 0a20 2020 2020 2020 2073 7065  er):.        spe
+0001f8d0: 6373 203d 2041 5753 2e5f 6765 745f 6469  cs = AWS._get_di
+0001f8e0: 736b 5f73 7065 6373 2864 6973 6b5f 7469  sk_specs(disk_ti
+0001f8f0: 6572 290a 2020 2020 2020 2020 6e61 6d65  er).        name
+0001f900: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
+0001f910: 6e61 6d65 2829 202b 2027 2d27 202b 2064  name() + '-' + d
+0001f920: 6973 6b5f 7469 6572 2e76 616c 7565 0a20  isk_tier.value. 
+0001f930: 2020 2020 2020 206e 616d 655f 6f6e 5f63         name_on_c
+0001f940: 6c6f 7564 203d 2063 6f6d 6d6f 6e5f 7574  loud = common_ut
+0001f950: 696c 732e 6d61 6b65 5f63 6c75 7374 6572  ils.make_cluster
+0001f960: 5f6e 616d 655f 6f6e 5f63 6c6f 7564 280a  _name_on_cloud(.
+0001f970: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
+0001f980: 2c20 736b 792e 4157 532e 6d61 785f 636c  , sky.AWS.max_cl
+0001f990: 7573 7465 725f 6e61 6d65 5f6c 656e 6774  uster_name_lengt
+0001f9a0: 6828 2929 0a20 2020 2020 2020 2072 6567  h()).        reg
+0001f9b0: 696f 6e20 3d20 2775 732d 6561 7374 2d32  ion = 'us-east-2
+0001f9c0: 270a 2020 2020 2020 2020 7465 7374 203d  '.        test =
+0001f9d0: 2054 6573 7428 0a20 2020 2020 2020 2020   Test(.         
+0001f9e0: 2020 2027 6177 732d 6469 736b 2d74 6965     'aws-disk-tie
+0001f9f0: 722d 2720 2b20 6469 736b 5f74 6965 722e  r-' + disk_tier.
+0001fa00: 7661 6c75 652c 0a20 2020 2020 2020 2020  value,.         
+0001fa10: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+0001fa20: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
+0001fa30: 6820 2d79 202d 6320 7b6e 616d 657d 202d  h -y -c {name} -
+0001fa40: 2d63 6c6f 7564 2061 7773 202d 2d72 6567  -cloud aws --reg
+0001fa50: 696f 6e20 7b72 6567 696f 6e7d 2027 0a20  ion {region} '. 
+0001fa60: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0001fa70: 272d 2d64 6973 6b2d 7469 6572 207b 6469  '--disk-tier {di
+0001fa80: 736b 5f74 6965 722e 7661 6c75 657d 2065  sk_tier.value} e
+0001fa90: 6368 6f20 2268 656c 6c6f 2073 6b79 2227  cho "hello sky"'
+0001faa0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001fab0: 2020 6627 6964 3d60 6177 7320 6563 3220    f'id=`aws ec2 
+0001fac0: 6465 7363 7269 6265 2d69 6e73 7461 6e63  describe-instanc
+0001fad0: 6573 202d 2d72 6567 696f 6e20 7b72 6567  es --region {reg
+0001fae0: 696f 6e7d 202d 2d66 696c 7465 7273 2027  ion} --filters '
+0001faf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001fb00: 2066 274e 616d 653d 7461 673a 7261 792d   f'Name=tag:ray-
+0001fb10: 636c 7573 7465 722d 6e61 6d65 2c56 616c  cluster-name,Val
+0001fb20: 7565 733d 7b6e 616d 655f 6f6e 5f63 6c6f  ues={name_on_clo
+0001fb30: 7564 7d20 2d2d 7175 6572 7920 270a 2020  ud} --query '.  
+0001fb40: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+0001fb50: 5265 7365 7276 6174 696f 6e73 5b5d 2e49  Reservations[].I
+0001fb60: 6e73 7461 6e63 6573 5b5d 2e49 6e73 7461  nstances[].Insta
+0001fb70: 6e63 6549 6420 2d2d 6f75 7470 7574 2074  nceId --output t
+0001fb80: 6578 7460 3b20 2720 2b0a 2020 2020 2020  ext`; ' +.      
+0001fb90: 2020 2020 2020 2020 2020 5f67 6574 5f61            _get_a
+0001fba0: 7773 5f71 7565 7279 5f63 6f6d 6d61 6e64  ws_query_command
+0001fbb0: 2872 6567 696f 6e2c 2027 2469 6427 2c20  (region, '$id', 
+0001fbc0: 2756 6f6c 756d 6554 7970 6527 2c0a 2020  'VolumeType',.  
+0001fbd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001fbe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001fbf0: 2020 2020 2073 7065 6373 5b27 6469 736b       specs['disk
+0001fc00: 5f74 6965 7227 5d29 202b 0a20 2020 2020  _tier']) +.     
+0001fc10: 2020 2020 2020 2020 2020 2028 2727 2069             ('' i
+0001fc20: 6620 6469 736b 5f74 6965 7220 3d3d 2072  f disk_tier == r
+0001fc30: 6573 6f75 7263 6573 5f75 7469 6c73 2e44  esources_utils.D
+0001fc40: 6973 6b54 6965 722e 4c4f 5720 656c 7365  iskTier.LOW else
+0001fc50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001fc60: 2020 285f 6765 745f 6177 735f 7175 6572    (_get_aws_quer
+0001fc70: 795f 636f 6d6d 616e 6428 7265 6769 6f6e  y_command(region
+0001fc80: 2c20 2724 6964 272c 2027 496f 7073 272c  , '$id', 'Iops',
+0001fc90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001fca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001fcb0: 2020 2020 2020 2020 2020 7370 6563 735b            specs[
+0001fcc0: 2764 6973 6b5f 696f 7073 275d 2920 2b0a  'disk_iops']) +.
+0001fcd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001fce0: 2020 5f67 6574 5f61 7773 5f71 7565 7279    _get_aws_query
+0001fcf0: 5f63 6f6d 6d61 6e64 2872 6567 696f 6e2c  _command(region,
+0001fd00: 2027 2469 6427 2c20 2754 6872 6f75 6768   '$id', 'Through
+0001fd10: 7075 7427 2c0a 2020 2020 2020 2020 2020  put',.          
+0001fd20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001fd30: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0001fd40: 7065 6373 5b27 6469 736b 5f74 6872 6f75  pecs['disk_throu
+0001fd50: 6768 7075 7427 5d29 2929 2c0a 2020 2020  ghput']))),.    
+0001fd60: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
+0001fd70: 2020 2020 2020 2066 2773 6b79 2064 6f77         f'sky dow
+0001fd80: 6e20 2d79 207b 6e61 6d65 7d27 2c0a 2020  n -y {name}',.  
+0001fd90: 2020 2020 2020 2020 2020 7469 6d65 6f75            timeou
+0001fda0: 743d 3130 202a 2036 302c 2020 2320 3130  t=10 * 60,  # 10
+0001fdb0: 206d 696e 7320 2028 6974 2074 616b 6573   mins  (it takes
+0001fdc0: 2061 726f 756e 6420 7e36 206d 696e 7329   around ~6 mins)
+0001fdd0: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+0001fde0: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+0001fdf0: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
+0001fe00: 6d61 726b 2e67 6370 0a64 6566 2074 6573  mark.gcp.def tes
+0001fe10: 745f 6763 705f 6469 736b 5f74 6965 7228  t_gcp_disk_tier(
+0001fe20: 293a 0a20 2020 2066 6f72 2064 6973 6b5f  ):.    for disk_
+0001fe30: 7469 6572 2069 6e20 6c69 7374 2872 6573  tier in list(res
+0001fe40: 6f75 7263 6573 5f75 7469 6c73 2e44 6973  ources_utils.Dis
+0001fe50: 6b54 6965 7229 3a0a 2020 2020 2020 2020  kTier):.        
+0001fe60: 7479 7065 203d 2047 4350 2e5f 6765 745f  type = GCP._get_
+0001fe70: 6469 736b 5f74 7970 6528 6469 736b 5f74  disk_type(disk_t
+0001fe80: 6965 7229 0a20 2020 2020 2020 206e 616d  ier).        nam
+0001fe90: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
+0001fea0: 5f6e 616d 6528 2920 2b20 272d 2720 2b20  _name() + '-' + 
+0001feb0: 6469 736b 5f74 6965 722e 7661 6c75 650a  disk_tier.value.
+0001fec0: 2020 2020 2020 2020 6e61 6d65 5f6f 6e5f          name_on_
+0001fed0: 636c 6f75 6420 3d20 636f 6d6d 6f6e 5f75  cloud = common_u
+0001fee0: 7469 6c73 2e6d 616b 655f 636c 7573 7465  tils.make_cluste
+0001fef0: 725f 6e61 6d65 5f6f 6e5f 636c 6f75 6428  r_name_on_cloud(
+0001ff00: 0a20 2020 2020 2020 2020 2020 206e 616d  .            nam
+0001ff10: 652c 2073 6b79 2e47 4350 2e6d 6178 5f63  e, sky.GCP.max_c
+0001ff20: 6c75 7374 6572 5f6e 616d 655f 6c65 6e67  luster_name_leng
+0001ff30: 7468 2829 290a 2020 2020 2020 2020 7265  th()).        re
+0001ff40: 6769 6f6e 203d 2027 7573 2d77 6573 7432  gion = 'us-west2
+0001ff50: 270a 2020 2020 2020 2020 7465 7374 203d  '.        test =
+0001ff60: 2054 6573 7428 0a20 2020 2020 2020 2020   Test(.         
+0001ff70: 2020 2027 6763 702d 6469 736b 2d74 6965     'gcp-disk-tie
+0001ff80: 722d 2720 2b20 6469 736b 5f74 6965 722e  r-' + disk_tier.
+0001ff90: 7661 6c75 652c 0a20 2020 2020 2020 2020  value,.         
+0001ffa0: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+0001ffb0: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
+0001ffc0: 6820 2d79 202d 6320 7b6e 616d 657d 202d  h -y -c {name} -
+0001ffd0: 2d63 6c6f 7564 2067 6370 202d 2d72 6567  -cloud gcp --reg
+0001ffe0: 696f 6e20 7b72 6567 696f 6e7d 2027 0a20  ion {region} '. 
+0001fff0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00020000: 272d 2d64 6973 6b2d 7469 6572 207b 6469  '--disk-tier {di
+00020010: 736b 5f74 6965 722e 7661 6c75 657d 2065  sk_tier.value} e
+00020020: 6368 6f20 2268 656c 6c6f 2073 6b79 2227  cho "hello sky"'
+00020030: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00020040: 2020 6627 6e61 6d65 3d60 6763 6c6f 7564    f'name=`gcloud
+00020050: 2063 6f6d 7075 7465 2069 6e73 7461 6e63   compute instanc
+00020060: 6573 206c 6973 7420 2d2d 6669 6c74 6572  es list --filter
+00020070: 3d27 0a20 2020 2020 2020 2020 2020 2020  ='.             
+00020080: 2020 2066 2722 6c61 6265 6c73 2e72 6179     f'"labels.ray
+00020090: 2d63 6c75 7374 6572 2d6e 616d 653a 7b6e  -cluster-name:{n
+000200a0: 616d 655f 6f6e 5f63 6c6f 7564 7d22 2027  ame_on_cloud}" '
+000200b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000200c0: 2027 2d2d 666f 726d 6174 3d22 7661 6c75   '--format="valu
+000200d0: 6528 6e61 6d65 2922 603b 2027 0a20 2020  e(name)"`; '.   
+000200e0: 2020 2020 2020 2020 2020 2020 2066 2767               f'g
+000200f0: 636c 6f75 6420 636f 6d70 7574 6520 6469  cloud compute di
+00020100: 736b 7320 6c69 7374 202d 2d66 696c 7465  sks list --filte
+00020110: 723d 226e 616d 653d 246e 616d 6522 2027  r="name=$name" '
+00020120: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00020130: 2066 272d 2d66 6f72 6d61 743d 2276 616c   f'--format="val
+00020140: 7565 2874 7970 6529 2220 7c20 6772 6570  ue(type)" | grep
+00020150: 207b 7479 7065 7d20 270a 2020 2020 2020   {type} '.      
+00020160: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
+00020170: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
+00020180: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
+00020190: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
+000201a0: 3620 2a20 3630 2c20 2023 2036 206d 696e  6 * 60,  # 6 min
+000201b0: 7320 2028 6974 2074 616b 6573 2061 726f  s  (it takes aro
+000201c0: 756e 6420 7e33 206d 696e 7329 0a20 2020  und ~3 mins).   
+000201d0: 2020 2020 2029 0a20 2020 2020 2020 2072       ).        r
+000201e0: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
+000201f0: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
+00020200: 2e61 7a75 7265 0a64 6566 2074 6573 745f  .azure.def test_
+00020210: 617a 7572 655f 6469 736b 5f74 6965 7228  azure_disk_tier(
+00020220: 293a 0a20 2020 2066 6f72 2064 6973 6b5f  ):.    for disk_
+00020230: 7469 6572 2069 6e20 6c69 7374 2872 6573  tier in list(res
+00020240: 6f75 7263 6573 5f75 7469 6c73 2e44 6973  ources_utils.Dis
+00020250: 6b54 6965 7229 3a0a 2020 2020 2020 2020  kTier):.        
+00020260: 6966 2064 6973 6b5f 7469 6572 203d 3d20  if disk_tier == 
+00020270: 7265 736f 7572 6365 735f 7574 696c 732e  resources_utils.
+00020280: 4469 736b 5469 6572 2e48 4947 483a 0a20  DiskTier.HIGH:. 
+00020290: 2020 2020 2020 2020 2020 2023 2041 7a75             # Azu
+000202a0: 7265 2064 6f65 7320 6e6f 7420 7375 7070  re does not supp
+000202b0: 6f72 7420 6869 6768 2064 6973 6b20 7469  ort high disk ti
+000202c0: 6572 2e0a 2020 2020 2020 2020 2020 2020  er..            
+000202d0: 636f 6e74 696e 7565 0a20 2020 2020 2020  continue.       
+000202e0: 2074 7970 6520 3d20 417a 7572 652e 5f67   type = Azure._g
+000202f0: 6574 5f64 6973 6b5f 7479 7065 2864 6973  et_disk_type(dis
+00020300: 6b5f 7469 6572 290a 2020 2020 2020 2020  k_tier).        
+00020310: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
+00020320: 7465 725f 6e61 6d65 2829 202b 2027 2d27  ter_name() + '-'
+00020330: 202b 2064 6973 6b5f 7469 6572 2e76 616c   + disk_tier.val
+00020340: 7565 0a20 2020 2020 2020 206e 616d 655f  ue.        name_
+00020350: 6f6e 5f63 6c6f 7564 203d 2063 6f6d 6d6f  on_cloud = commo
+00020360: 6e5f 7574 696c 732e 6d61 6b65 5f63 6c75  n_utils.make_clu
+00020370: 7374 6572 5f6e 616d 655f 6f6e 5f63 6c6f  ster_name_on_clo
+00020380: 7564 280a 2020 2020 2020 2020 2020 2020  ud(.            
+00020390: 6e61 6d65 2c20 736b 792e 417a 7572 652e  name, sky.Azure.
+000203a0: 6d61 785f 636c 7573 7465 725f 6e61 6d65  max_cluster_name
+000203b0: 5f6c 656e 6774 6828 2929 0a20 2020 2020  _length()).     
+000203c0: 2020 2072 6567 696f 6e20 3d20 2777 6573     region = 'wes
+000203d0: 7475 7332 270a 2020 2020 2020 2020 7465  tus2'.        te
+000203e0: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+000203f0: 2020 2020 2020 2027 617a 7572 652d 6469         'azure-di
+00020400: 736b 2d74 6965 722d 2720 2b20 6469 736b  sk-tier-' + disk
+00020410: 5f74 6965 722e 7661 6c75 652c 0a20 2020  _tier.value,.   
+00020420: 2020 2020 2020 2020 205b 0a20 2020 2020           [.     
+00020430: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00020440: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
+00020450: 616d 657d 202d 2d63 6c6f 7564 2061 7a75  ame} --cloud azu
+00020460: 7265 202d 2d72 6567 696f 6e20 7b72 6567  re --region {reg
+00020470: 696f 6e7d 2027 0a20 2020 2020 2020 2020  ion} '.         
+00020480: 2020 2020 2020 2066 272d 2d64 6973 6b2d         f'--disk-
+00020490: 7469 6572 207b 6469 736b 5f74 6965 722e  tier {disk_tier.
+000204a0: 7661 6c75 657d 2065 6368 6f20 2268 656c  value} echo "hel
+000204b0: 6c6f 2073 6b79 2227 2c0a 2020 2020 2020  lo sky"',.      
+000204c0: 2020 2020 2020 2020 2020 6627 617a 2072            f'az r
+000204d0: 6573 6f75 7263 6520 6c69 7374 202d 2d74  esource list --t
+000204e0: 6167 2072 6179 2d63 6c75 7374 6572 2d6e  ag ray-cluster-n
+000204f0: 616d 653d 7b6e 616d 655f 6f6e 5f63 6c6f  ame={name_on_clo
+00020500: 7564 7d20 2d2d 7175 6572 7920 270a 2020  ud} --query '.  
+00020510: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+00020520: 225b 3f74 7970 653d 3d5c 274d 6963 726f  "[?type==\'Micro
+00020530: 736f 6674 2e43 6f6d 7075 7465 2f64 6973  soft.Compute/dis
+00020540: 6b73 5c27 5d2e 736b 752e 6e61 6d65 2220  ks\'].sku.name" 
+00020550: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+00020560: 2020 6627 2d2d 6f75 7470 7574 2074 7376    f'--output tsv
+00020570: 207c 2067 7265 7020 7b74 7970 657d 270a   | grep {type}'.
+00020580: 2020 2020 2020 2020 2020 2020 5d2c 0a20              ],. 
+00020590: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+000205a0: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
+000205b0: 2c0a 2020 2020 2020 2020 2020 2020 7469  ,.            ti
+000205c0: 6d65 6f75 743d 3230 202a 2036 302c 2020  meout=20 * 60,  
+000205d0: 2320 3230 206d 696e 7320 2028 6974 2074  # 20 mins  (it t
+000205e0: 616b 6573 2061 726f 756e 6420 7e31 3220  akes around ~12 
+000205f0: 6d69 6e73 290a 2020 2020 2020 2020 290a  mins).        ).
+00020600: 2020 2020 2020 2020 7275 6e5f 6f6e 655f          run_one_
+00020610: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
+00020620: 7465 7374 2e6d 6172 6b2e 617a 7572 650a  test.mark.azure.
+00020630: 6465 6620 7465 7374 5f61 7a75 7265 5f62  def test_azure_b
+00020640: 6573 745f 7469 6572 5f66 6169 6c6f 7665  est_tier_failove
+00020650: 7228 293a 0a20 2020 2074 7970 6520 3d20  r():.    type = 
+00020660: 417a 7572 652e 5f67 6574 5f64 6973 6b5f  Azure._get_disk_
+00020670: 7479 7065 2872 6573 6f75 7263 6573 5f75  type(resources_u
+00020680: 7469 6c73 2e44 6973 6b54 6965 722e 4c4f  tils.DiskTier.LO
+00020690: 5729 0a20 2020 206e 616d 6520 3d20 5f67  W).    name = _g
+000206a0: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
+000206b0: 290a 2020 2020 6e61 6d65 5f6f 6e5f 636c  ).    name_on_cl
+000206c0: 6f75 6420 3d20 636f 6d6d 6f6e 5f75 7469  oud = common_uti
+000206d0: 6c73 2e6d 616b 655f 636c 7573 7465 725f  ls.make_cluster_
+000206e0: 6e61 6d65 5f6f 6e5f 636c 6f75 6428 0a20  name_on_cloud(. 
+000206f0: 2020 2020 2020 206e 616d 652c 2073 6b79         name, sky
+00020700: 2e41 7a75 7265 2e6d 6178 5f63 6c75 7374  .Azure.max_clust
+00020710: 6572 5f6e 616d 655f 6c65 6e67 7468 2829  er_name_length()
+00020720: 290a 2020 2020 7265 6769 6f6e 203d 2027  ).    region = '
+00020730: 7765 7374 7573 3227 0a20 2020 2074 6573  westus2'.    tes
+00020740: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
+00020750: 2020 2761 7a75 7265 2d62 6573 742d 7469    'azure-best-ti
+00020760: 6572 2d66 6169 6c6f 7665 7227 2c0a 2020  er-failover',.  
+00020770: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+00020780: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
+00020790: 202d 7920 2d63 207b 6e61 6d65 7d20 2d2d   -y -c {name} --
+000207a0: 636c 6f75 6420 617a 7572 6520 2d2d 7265  cloud azure --re
+000207b0: 6769 6f6e 207b 7265 6769 6f6e 7d20 270a  gion {region} '.
+000207c0: 2020 2020 2020 2020 2020 2020 6627 2d2d              f'--
+000207d0: 6469 736b 2d74 6965 7220 6265 7374 202d  disk-tier best -
+000207e0: 2d69 6e73 7461 6e63 652d 7479 7065 2053  -instance-type S
+000207f0: 7461 6e64 6172 645f 4438 5f76 3520 6563  tandard_D8_v5 ec
+00020800: 686f 2022 6865 6c6c 6f20 736b 7922 272c  ho "hello sky"',
+00020810: 0a20 2020 2020 2020 2020 2020 2066 2761  .            f'a
+00020820: 7a20 7265 736f 7572 6365 206c 6973 7420  z resource list 
+00020830: 2d2d 7461 6720 7261 792d 636c 7573 7465  --tag ray-cluste
+00020840: 722d 6e61 6d65 3d7b 6e61 6d65 5f6f 6e5f  r-name={name_on_
+00020850: 636c 6f75 647d 202d 2d71 7565 7279 2027  cloud} --query '
+00020860: 0a20 2020 2020 2020 2020 2020 2066 2722  .            f'"
+00020870: 5b3f 7479 7065 3d3d 5c27 4d69 6372 6f73  [?type==\'Micros
+00020880: 6f66 742e 436f 6d70 7574 652f 6469 736b  oft.Compute/disk
+00020890: 735c 275d 2e73 6b75 2e6e 616d 6522 2027  s\'].sku.name" '
+000208a0: 0a20 2020 2020 2020 2020 2020 2066 272d  .            f'-
+000208b0: 2d6f 7574 7075 7420 7473 7620 7c20 6772  -output tsv | gr
+000208c0: 6570 207b 7479 7065 7d27 2c0a 2020 2020  ep {type}',.    
+000208d0: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
+000208e0: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
+000208f0: 6d65 7d27 2c0a 2020 2020 2020 2020 7469  me}',.        ti
+00020900: 6d65 6f75 743d 3230 202a 2036 302c 2020  meout=20 * 60,  
+00020910: 2320 3230 206d 696e 7320 2028 6974 2074  # 20 mins  (it t
+00020920: 616b 6573 2061 726f 756e 6420 7e31 3220  akes around ~12 
+00020930: 6d69 6e73 290a 2020 2020 290a 2020 2020  mins).    ).    
+00020940: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
+00020950: 7429 0a0a 0a23 202d 2d2d 2d2d 2d20 5465  t)...# ------ Te
+00020960: 7374 696e 6720 5a65 726f 2051 756f 7461  sting Zero Quota
+00020970: 2046 6169 6c6f 7665 7220 2d2d 2d2d 2d2d   Failover ------
+00020980: 0a40 7079 7465 7374 2e6d 6172 6b2e 6177  .@pytest.mark.aw
+00020990: 730a 6465 6620 7465 7374 5f61 7773 5f7a  s.def test_aws_z
+000209a0: 6572 6f5f 7175 6f74 615f 6661 696c 6f76  ero_quota_failov
+000209b0: 6572 2829 3a0a 0a20 2020 206e 616d 6520  er():..    name 
+000209c0: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
+000209d0: 616d 6528 290a 2020 2020 7265 6769 6f6e  ame().    region
+000209e0: 203d 2067 6574 5f61 7773 5f72 6567 696f   = get_aws_regio
+000209f0: 6e5f 666f 725f 7175 6f74 615f 6661 696c  n_for_quota_fail
+00020a00: 6f76 6572 2829 0a0a 2020 2020 6966 206e  over()..    if n
+00020a10: 6f74 2072 6567 696f 6e3a 0a20 2020 2020  ot region:.     
+00020a20: 2020 2070 7974 6573 742e 7866 6169 6c28     pytest.xfail(
+00020a30: 0a20 2020 2020 2020 2020 2020 2027 556e  .            'Un
+00020a40: 6162 6c65 2074 6f20 7465 7374 207a 6572  able to test zer
+00020a50: 6f20 7175 6f74 6120 6661 696c 6f76 6572  o quota failover
+00020a60: 206f 7074 696d 697a 6174 696f 6e20 e280   optimization ..
+00020a70: 9420 7175 6f74 6173 2027 0a20 2020 2020  . quotas '.     
+00020a80: 2020 2020 2020 2027 666f 7220 4543 3220         'for EC2 
+00020a90: 5033 2069 6e73 7461 6e63 6573 2077 6572  P3 instances wer
+00020aa0: 6520 666f 756e 6420 6f6e 2061 6c6c 2041  e found on all A
+00020ab0: 5753 2072 6567 696f 6e73 2e20 4973 2074  WS regions. Is t
+00020ac0: 6869 7320 270a 2020 2020 2020 2020 2020  his '.          
+00020ad0: 2020 2765 7870 6563 7465 6420 666f 7220    'expected for 
+00020ae0: 796f 7572 2061 6363 6f75 6e74 3f27 290a  your account?').
+00020af0: 2020 2020 2020 2020 7265 7475 726e 0a0a          return..
+00020b00: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
+00020b10: 0a20 2020 2020 2020 2027 6177 732d 7a65  .        'aws-ze
+00020b20: 726f 2d71 756f 7461 2d66 6169 6c6f 7665  ro-quota-failove
+00020b30: 7227 2c0a 2020 2020 2020 2020 5b0a 2020  r',.        [.  
+00020b40: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00020b50: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
+00020b60: 6d65 7d20 2d2d 636c 6f75 6420 6177 7320  me} --cloud aws 
+00020b70: 2d2d 7265 6769 6f6e 207b 7265 6769 6f6e  --region {region
+00020b80: 7d20 2d2d 6770 7573 2056 3130 303a 3820  } --gpus V100:8 
+00020b90: 2d2d 7573 652d 7370 6f74 207c 2067 7265  --use-spot | gre
+00020ba0: 7020 2246 6f75 6e64 206e 6f20 7175 6f74  p "Found no quot
+00020bb0: 6122 272c 0a20 2020 2020 2020 205d 2c0a  a"',.        ],.
+00020bc0: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
+00020bd0: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
+00020be0: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
+00020bf0: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
+00020c00: 7974 6573 742e 6d61 726b 2e67 6370 0a64  ytest.mark.gcp.d
+00020c10: 6566 2074 6573 745f 6763 705f 7a65 726f  ef test_gcp_zero
+00020c20: 5f71 756f 7461 5f66 6169 6c6f 7665 7228  _quota_failover(
+00020c30: 293a 0a0a 2020 2020 6e61 6d65 203d 205f  ):..    name = _
+00020c40: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
+00020c50: 2829 0a20 2020 2072 6567 696f 6e20 3d20  ().    region = 
+00020c60: 6765 745f 6763 705f 7265 6769 6f6e 5f66  get_gcp_region_f
+00020c70: 6f72 5f71 756f 7461 5f66 6169 6c6f 7665  or_quota_failove
+00020c80: 7228 290a 0a20 2020 2069 6620 6e6f 7420  r()..    if not 
+00020c90: 7265 6769 6f6e 3a0a 2020 2020 2020 2020  region:.        
+00020ca0: 7079 7465 7374 2e78 6661 696c 280a 2020  pytest.xfail(.  
+00020cb0: 2020 2020 2020 2020 2020 2755 6e61 626c            'Unabl
+00020cc0: 6520 746f 2074 6573 7420 7a65 726f 2071  e to test zero q
+00020cd0: 756f 7461 2066 6169 6c6f 7665 7220 6f70  uota failover op
+00020ce0: 7469 6d69 7a61 7469 6f6e 20e2 8094 2071  timization ... q
+00020cf0: 756f 7461 7320 270a 2020 2020 2020 2020  uotas '.        
+00020d00: 2020 2020 2766 6f72 2041 3130 302d 3830      'for A100-80
+00020d10: 4742 2047 5055 7320 7765 7265 2066 6f75  GB GPUs were fou
+00020d20: 6e64 206f 6e20 616c 6c20 4743 5020 7265  nd on all GCP re
+00020d30: 6769 6f6e 732e 2049 7320 7468 6973 2027  gions. Is this '
+00020d40: 0a20 2020 2020 2020 2020 2020 2027 6578  .            'ex
+00020d50: 7065 6374 6564 2066 6f72 2079 6f75 7220  pected for your 
+00020d60: 6163 636f 756e 743f 2729 0a20 2020 2020  account?').     
+00020d70: 2020 2072 6574 7572 6e0a 0a20 2020 2074     return..    t
+00020d80: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+00020d90: 2020 2020 2767 6370 2d7a 6572 6f2d 7175      'gcp-zero-qu
+00020da0: 6f74 612d 6661 696c 6f76 6572 272c 0a20  ota-failover',. 
+00020db0: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
+00020dc0: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
+00020dd0: 6820 2d79 202d 6320 7b6e 616d 657d 202d  h -y -c {name} -
+00020de0: 2d63 6c6f 7564 2067 6370 202d 2d72 6567  -cloud gcp --reg
+00020df0: 696f 6e20 7b72 6567 696f 6e7d 202d 2d67  ion {region} --g
+00020e00: 7075 7320 4131 3030 2d38 3047 423a 3120  pus A100-80GB:1 
+00020e10: 2d2d 7573 652d 7370 6f74 207c 2067 7265  --use-spot | gre
+00020e20: 7020 2246 6f75 6e64 206e 6f20 7175 6f74  p "Found no quot
+00020e30: 6122 272c 0a20 2020 2020 2020 205d 2c0a  a"',.        ],.
+00020e40: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
+00020e50: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
+00020e60: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
+00020e70: 5f74 6573 7428 7465 7374 290a 0a0a 2320  _test(test)...# 
+00020e80: 2d2d 2d2d 2d2d 2d2d 2d2d 2054 6573 7469  ---------- Testi
+00020e90: 6e67 2073 6b79 7365 7276 6520 2d2d 2d2d  ng skyserve ----
+00020ea0: 2d2d 2d2d 2d2d 0a0a 0a64 6566 205f 6765  ------...def _ge
+00020eb0: 745f 7365 7276 6963 655f 6e61 6d65 2829  t_service_name()
+00020ec0: 202d 3e20 7374 723a 0a20 2020 2022 2222   -> str:.    """
+00020ed0: 5265 7475 726e 7320 6120 7573 6572 2d75  Returns a user-u
+00020ee0: 6e69 7175 6520 7365 7276 6963 6520 6e61  nique service na
+00020ef0: 6d65 2066 6f72 2065 6163 6820 7465 7374  me for each test
+00020f00: 5f73 6b79 7365 7276 655f 3c6e 616d 653e  _skyserve_<name>
+00020f10: 2829 2e0a 0a20 2020 204d 7573 7420 6265  ()...    Must be
+00020f20: 2063 616c 6c65 6420 6672 6f6d 2065 6163   called from eac
+00020f30: 6820 7465 7374 5f73 6b79 7365 7276 655f  h test_skyserve_
+00020f40: 3c6e 616d 653e 2829 2e0a 2020 2020 2222  <name>()..    ""
+00020f50: 220a 2020 2020 6361 6c6c 6572 5f66 756e  ".    caller_fun
+00020f60: 635f 6e61 6d65 203d 2069 6e73 7065 6374  c_name = inspect
+00020f70: 2e73 7461 636b 2829 5b31 5d5b 335d 0a20  .stack()[1][3]. 
+00020f80: 2020 2074 6573 745f 6e61 6d65 203d 2063     test_name = c
+00020f90: 616c 6c65 725f 6675 6e63 5f6e 616d 652e  aller_func_name.
+00020fa0: 7265 706c 6163 6528 275f 272c 2027 2d27  replace('_', '-'
+00020fb0: 292e 7265 706c 6163 6528 2774 6573 742d  ).replace('test-
+00020fc0: 272c 2027 742d 2729 0a20 2020 2074 6573  ', 't-').    tes
+00020fd0: 745f 6e61 6d65 203d 2074 6573 745f 6e61  t_name = test_na
+00020fe0: 6d65 2e72 6570 6c61 6365 2827 736b 7973  me.replace('skys
+00020ff0: 6572 7665 2d27 2c20 2773 732d 2729 0a20  erve-', 'ss-'). 
+00021000: 2020 2074 6573 745f 6e61 6d65 203d 2063     test_name = c
+00021010: 6f6d 6d6f 6e5f 7574 696c 732e 6d61 6b65  ommon_utils.make
+00021020: 5f63 6c75 7374 6572 5f6e 616d 655f 6f6e  _cluster_name_on
+00021030: 5f63 6c6f 7564 2874 6573 745f 6e61 6d65  _cloud(test_name
+00021040: 2c20 3234 290a 2020 2020 7265 7475 726e  , 24).    return
+00021050: 2066 277b 7465 7374 5f6e 616d 657d 2d7b   f'{test_name}-{
+00021060: 7465 7374 5f69 647d 270a 0a0a 2320 5765  test_id}'...# We
+00021070: 2063 6865 636b 2074 6865 206f 7574 7075   check the outpu
+00021080: 7420 6f66 2074 6865 2073 6b79 7365 7276  t of the skyserv
+00021090: 6520 7365 7276 6963 6520 746f 2073 6565  e service to see
+000210a0: 2069 6620 6974 2069 7320 7265 6164 792e   if it is ready.
+000210b0: 204f 7574 7075 7420 6f66 0a23 2060 5245   Output of.# `RE
+000210c0: 504c 4943 4153 6020 6973 2069 6e20 7468  PLICAS` is in th
+000210d0: 6520 666f 726d 206f 6620 6031 2f32 6020  e form of `1/2` 
+000210e0: 7768 6572 6520 7468 6520 6669 7273 7420  where the first 
+000210f0: 6e75 6d62 6572 2069 7320 7468 6520 6e75  number is the nu
+00021100: 6d62 6572 206f 660a 2320 7265 6164 7920  mber of.# ready 
+00021110: 7265 706c 6963 6173 2061 6e64 2074 6865  replicas and the
+00021120: 2073 6563 6f6e 6420 6e75 6d62 6572 2069   second number i
+00021130: 7320 7468 6520 6e75 6d62 6572 206f 6620  s the number of 
+00021140: 746f 7461 6c20 7265 706c 6963 6173 2e20  total replicas. 
+00021150: 5765 0a23 2067 7265 7020 7375 6368 2066  We.# grep such f
+00021160: 6f72 6d61 7420 746f 2065 6e73 7572 6520  ormat to ensure 
+00021170: 7468 6174 2074 6865 2073 6572 7669 6365  that the service
+00021180: 2069 7320 7265 6164 792c 2061 6e64 2065   is ready, and e
+00021190: 6172 6c79 2065 7869 7420 6966 2061 6e79  arly exit if any
+000211a0: 0a23 2066 6169 6c75 7265 2064 6574 6563  .# failure detec
+000211b0: 7465 642e 2049 6e20 7468 6520 656e 6420  ted. In the end 
+000211c0: 7765 2073 6c65 6570 2066 6f72 0a23 2073  we sleep for.# s
+000211d0: 6572 7665 2e4c 425f 434f 4e54 524f 4c4c  erve.LB_CONTROLL
+000211e0: 4552 5f53 594e 435f 494e 5445 5256 414c  ER_SYNC_INTERVAL
+000211f0: 5f53 4543 4f4e 4453 2074 6f20 6d61 6b65  _SECONDS to make
+00021200: 2073 7572 6520 6c6f 6164 2062 616c 616e   sure load balan
+00021210: 6365 7220 6861 7665 0a23 2065 6e6f 7567  cer have.# enoug
+00021220: 6820 7469 6d65 2074 6f20 7379 6e63 2077  h time to sync w
+00021230: 6974 6820 7468 6520 636f 6e74 726f 6c6c  ith the controll
+00021240: 6572 2061 6e64 2067 6574 2061 6c6c 2072  er and get all r
+00021250: 6561 6479 2072 6570 6c69 6361 2049 5073  eady replica IPs
+00021260: 2e0a 5f53 4552 5645 5f57 4149 545f 554e  .._SERVE_WAIT_UN
+00021270: 5449 4c5f 5245 4144 5920 3d20 280a 2020  TIL_READY = (.  
+00021280: 2020 277b 7b20 7768 696c 6520 7472 7565    '{{ while true
+00021290: 3b20 646f 270a 2020 2020 2720 2020 2020  ; do'.    '     
+000212a0: 733d 2428 736b 7920 7365 7276 6520 7374  s=$(sky serve st
+000212b0: 6174 7573 207b 6e61 6d65 7d29 3b20 6563  atus {name}); ec
+000212c0: 686f 2022 2473 223b 270a 2020 2020 2720  ho "$s";'.    ' 
+000212d0: 2020 2020 6563 686f 2022 2473 2220 7c20      echo "$s" | 
+000212e0: 6772 6570 202d 7120 227b 7265 706c 6963  grep -q "{replic
+000212f0: 615f 6e75 6d7d 2f7b 7265 706c 6963 615f  a_num}/{replica_
+00021300: 6e75 6d7d 2220 2626 2062 7265 616b 3b27  num}" && break;'
+00021310: 0a20 2020 2027 2020 2020 2065 6368 6f20  .    '     echo 
+00021320: 2224 7322 207c 2067 7265 7020 2d71 2022  "$s" | grep -q "
+00021330: 4641 494c 4544 2220 2626 2065 7869 7420  FAILED" && exit 
+00021340: 313b 270a 2020 2020 2720 2020 2020 736c  1;'.    '     sl
+00021350: 6565 7020 3130 3b27 0a20 2020 2027 2064  eep 10;'.    ' d
+00021360: 6f6e 653b 207d 7d3b 2065 6368 6f20 2247  one; }}; echo "G
+00021370: 6f74 2073 6572 7669 6365 2073 7461 7475  ot service statu
+00021380: 7320 2473 223b 270a 2020 2020 6627 736c  s $s";'.    f'sl
+00021390: 6565 7020 7b73 6572 7665 2e4c 425f 434f  eep {serve.LB_CO
+000213a0: 4e54 524f 4c4c 4552 5f53 594e 435f 494e  NTROLLER_SYNC_IN
+000213b0: 5445 5256 414c 5f53 4543 4f4e 4453 202b  TERVAL_SECONDS +
+000213c0: 2032 7d3b 2729 0a5f 4950 5f52 4547 4558   2};')._IP_REGEX
+000213d0: 203d 2072 2728 5b30 2d39 5d7b 312c 337d   = r'([0-9]{1,3}
+000213e0: 5c2e 297b 337d 5b30 2d39 5d7b 312c 337d  \.){3}[0-9]{1,3}
+000213f0: 270a 5f41 574b 5f41 4c4c 5f4c 494e 4553  '._AWK_ALL_LINES
+00021400: 5f42 454c 4f57 5f52 4550 4c49 4341 5320  _BELOW_REPLICAS 
+00021410: 3d20 7227 2f52 6570 6c69 6361 732f 7b66  = r'/Replicas/{f
+00021420: 6c61 673d 313b 206e 6578 747d 2066 6c61  lag=1; next} fla
+00021430: 6727 0a5f 5345 5256 4943 455f 4c41 554e  g'._SERVICE_LAUN
+00021440: 4348 494e 475f 5354 4154 5553 5f52 4547  CHING_STATUS_REG
+00021450: 4558 203d 2027 5052 4f56 4953 494f 4e49  EX = 'PROVISIONI
+00021460: 4e47 5c7c 5354 4152 5449 4e47 270a 2320  NG\|STARTING'.# 
+00021470: 5369 6e63 6520 7765 2064 6f6e 2774 2061  Since we don't a
+00021480: 6c6c 6f77 2074 6572 6d69 6e61 7465 2074  llow terminate t
+00021490: 6865 2073 6572 7669 6365 2069 6620 7468  he service if th
+000214a0: 6520 636f 6e74 726f 6c6c 6572 2069 7320  e controller is 
+000214b0: 494e 4954 2c0a 2320 7768 6963 6820 6973  INIT,.# which is
+000214c0: 2063 6f6d 6d6f 6e20 666f 7220 7369 6d75   common for simu
+000214d0: 6c74 616e 656f 7573 2070 7974 6573 742c  ltaneous pytest,
+000214e0: 2077 6520 6e65 6564 2074 6f20 7761 6974   we need to wait
+000214f0: 2075 6e74 696c 2074 6865 0a23 2063 6f6e   until the.# con
+00021500: 7472 6f6c 6c65 7220 6973 2055 5020 6265  troller is UP be
+00021510: 666f 7265 2077 6520 6361 6e20 7465 726d  fore we can term
+00021520: 696e 6174 6520 7468 6520 7365 7276 6963  inate the servic
+00021530: 652e 0a23 2054 6865 2074 6561 7264 6f77  e..# The teardow
+00021540: 6e20 636f 6d6d 616e 6420 6861 7320 6120  n command has a 
+00021550: 3130 2d6d 696e 7320 7469 6d65 6f75 742c  10-mins timeout,
+00021560: 2073 6f20 7765 2064 6f6e 2774 206e 6565   so we don't nee
+00021570: 6420 746f 2064 6f0a 2320 7468 6520 7469  d to do.# the ti
+00021580: 6d65 6f75 7420 6865 7265 2e20 5365 6520  meout here. See 
+00021590: 696d 706c 656d 656e 7461 7469 6f6e 206f  implementation o
+000215a0: 6620 7275 6e5f 6f6e 655f 7465 7374 2829  f run_one_test()
+000215b0: 2066 6f72 2064 6574 6169 6c73 2e0a 5f54   for details.._T
+000215c0: 4541 5244 4f57 4e5f 5345 5256 4943 4520  EARDOWN_SERVICE 
+000215d0: 3d20 280a 2020 2020 2728 666f 7220 6920  = (.    '(for i 
+000215e0: 696e 2060 7365 7120 3120 3230 603b 2064  in `seq 1 20`; d
+000215f0: 6f27 0a20 2020 2027 2020 2020 2073 3d24  o'.    '     s=$
+00021600: 2873 6b79 2073 6572 7665 2064 6f77 6e20  (sky serve down 
+00021610: 2d79 207b 6e61 6d65 7d29 3b27 0a20 2020  -y {name});'.   
+00021620: 2027 2020 2020 2065 6368 6f20 2254 7279   '     echo "Try
+00021630: 696e 6720 746f 2074 6572 6d69 6e61 7465  ing to terminate
+00021640: 207b 6e61 6d65 7d22 3b27 0a20 2020 2027   {name}";'.    '
+00021650: 2020 2020 2065 6368 6f20 2224 7322 3b27       echo "$s";'
+00021660: 0a20 2020 2027 2020 2020 2065 6368 6f20  .    '     echo 
+00021670: 2224 7322 207c 2067 7265 7020 2d71 2022  "$s" | grep -q "
+00021680: 7363 6865 6475 6c65 6420 746f 2062 6520  scheduled to be 
+00021690: 7465 726d 696e 6174 6564 5c7c 4e6f 2073  terminated\|No s
+000216a0: 6572 7669 6365 2074 6f20 7465 726d 696e  ervice to termin
+000216b0: 6174 6522 2026 2620 6272 6561 6b3b 270a  ate" && break;'.
+000216c0: 2020 2020 2720 2020 2020 736c 6565 7020      '     sleep 
+000216d0: 3130 3b27 0a20 2020 2027 2020 2020 205b  10;'.    '     [
+000216e0: 2024 6920 2d65 7120 3230 205d 2026 2620   $i -eq 20 ] && 
+000216f0: 6563 686f 2022 4661 696c 6564 2074 6f20  echo "Failed to 
+00021700: 7465 726d 696e 6174 6520 7365 7276 6963  terminate servic
+00021710: 6520 7b6e 616d 657d 223b 270a 2020 2020  e {name}";'.    
+00021720: 2764 6f6e 6529 2729 0a0a 5f53 4552 5645  'done)').._SERVE
+00021730: 5f45 4e44 504f 494e 545f 5741 4954 203d  _ENDPOINT_WAIT =
+00021740: 2028 0a20 2020 2027 6578 706f 7274 204f   (.    'export O
+00021750: 5249 4749 4e5f 534b 5950 494c 4f54 5f44  RIGIN_SKYPILOT_D
+00021760: 4542 5547 3d24 534b 5950 494c 4f54 5f44  EBUG=$SKYPILOT_D
+00021770: 4542 5547 3b20 6578 706f 7274 2053 4b59  EBUG; export SKY
+00021780: 5049 4c4f 545f 4445 4255 473d 303b 2027  PILOT_DEBUG=0; '
+00021790: 0a20 2020 2027 656e 6470 6f69 6e74 3d24  .    'endpoint=$
+000217a0: 2873 6b79 2073 6572 7665 2073 7461 7475  (sky serve statu
+000217b0: 7320 2d2d 656e 6470 6f69 6e74 207b 6e61  s --endpoint {na
+000217c0: 6d65 7d29 3b20 270a 2020 2020 2775 6e74  me}); '.    'unt
+000217d0: 696c 2021 2065 6368 6f20 2224 656e 6470  il ! echo "$endp
+000217e0: 6f69 6e74 2220 7c20 6772 6570 2022 436f  oint" | grep "Co
+000217f0: 6e74 726f 6c6c 6572 2069 7320 696e 6974  ntroller is init
+00021800: 6961 6c69 7a69 6e67 223b 2027 0a20 2020  ializing"; '.   
+00021810: 2027 646f 2065 6368 6f20 2257 6169 7469   'do echo "Waiti
+00021820: 6e67 2066 6f72 2073 6572 7665 2065 6e64  ng for serve end
+00021830: 706f 696e 7420 746f 2062 6520 7265 6164  point to be read
+00021840: 792e 2e2e 223b 2027 0a20 2020 2027 736c  y..."; '.    'sl
+00021850: 6565 7020 353b 2065 6e64 706f 696e 743d  eep 5; endpoint=
+00021860: 2428 736b 7920 7365 7276 6520 7374 6174  $(sky serve stat
+00021870: 7573 202d 2d65 6e64 706f 696e 7420 7b6e  us --endpoint {n
+00021880: 616d 657d 293b 2064 6f6e 653b 2027 0a20  ame}); done; '. 
+00021890: 2020 2027 6578 706f 7274 2053 4b59 5049     'export SKYPI
+000218a0: 4c4f 545f 4445 4255 473d 244f 5249 4749  LOT_DEBUG=$ORIGI
+000218b0: 4e5f 534b 5950 494c 4f54 5f44 4542 5547  N_SKYPILOT_DEBUG
+000218c0: 3b20 6563 686f 2022 2465 6e64 706f 696e  ; echo "$endpoin
+000218d0: 7422 2729 0a0a 5f53 4552 5645 5f53 5441  t"').._SERVE_STA
+000218e0: 5455 535f 5741 4954 203d 2028 2773 3d24  TUS_WAIT = ('s=$
+000218f0: 2873 6b79 2073 6572 7665 2073 7461 7475  (sky serve statu
+00021900: 7320 7b6e 616d 657d 293b 2027 0a20 2020  s {name}); '.   
+00021910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021920: 2020 2027 756e 7469 6c20 2120 6563 686f     'until ! echo
+00021930: 2022 2473 2220 7c20 6772 6570 2022 436f   "$s" | grep "Co
+00021940: 6e74 726f 6c6c 6572 2069 7320 696e 6974  ntroller is init
+00021950: 6961 6c69 7a69 6e67 2e22 3b20 270a 2020  ializing."; '.  
+00021960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021970: 2020 2020 2764 6f20 6563 686f 2022 5761      'do echo "Wa
+00021980: 6974 696e 6720 666f 7220 7365 7276 6520  iting for serve 
+00021990: 7374 6174 7573 2074 6f20 6265 2072 6561  status to be rea
+000219a0: 6479 2e2e 2e22 3b20 270a 2020 2020 2020  dy..."; '.      
+000219b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000219c0: 2773 6c65 6570 2035 3b20 733d 2428 736b  'sleep 5; s=$(sk
+000219d0: 7920 7365 7276 6520 7374 6174 7573 207b  y serve status {
+000219e0: 6e61 6d65 7d29 3b20 646f 6e65 3b20 6563  name}); done; ec
+000219f0: 686f 2022 2473 2227 290a 0a0a 6465 6620  ho "$s"')...def 
+00021a00: 5f67 6574 5f72 6570 6c69 6361 5f69 7028  _get_replica_ip(
+00021a10: 6e61 6d65 3a20 7374 722c 2072 6570 6c69  name: str, repli
+00021a20: 6361 5f69 643a 2069 6e74 2920 2d3e 2073  ca_id: int) -> s
+00021a30: 7472 3a0a 2020 2020 7265 7475 726e 2028  tr:.    return (
+00021a40: 6627 6970 7b72 6570 6c69 6361 5f69 647d  f'ip{replica_id}
+00021a50: 3d24 2865 6368 6f20 2224 7322 207c 2027  =$(echo "$s" | '
+00021a60: 0a20 2020 2020 2020 2020 2020 2066 2761  .            f'a
+00021a70: 776b 2022 7b5f 4157 4b5f 414c 4c5f 4c49  wk "{_AWK_ALL_LI
+00021a80: 4e45 535f 4245 4c4f 575f 5245 504c 4943  NES_BELOW_REPLIC
+00021a90: 4153 7d22 207c 2027 0a20 2020 2020 2020  AS}" | '.       
+00021aa0: 2020 2020 2066 2767 7265 7020 2d45 2022       f'grep -E "
+00021ab0: 7b6e 616d 657d 5c73 2b7b 7265 706c 6963  {name}\s+{replic
+00021ac0: 615f 6964 7d22 207c 2027 0a20 2020 2020  a_id}" | '.     
+00021ad0: 2020 2020 2020 2066 2767 7265 7020 2d45         f'grep -E
+00021ae0: 6f20 227b 5f49 505f 5245 4745 587d 2229  o "{_IP_REGEX}")
+00021af0: 2729 0a0a 0a64 6566 205f 6765 745f 736b  ')...def _get_sk
+00021b00: 7973 6572 7665 5f68 7474 705f 7465 7374  yserve_http_test
+00021b10: 286e 616d 653a 2073 7472 2c20 636c 6f75  (name: str, clou
+00021b20: 643a 2073 7472 2c0a 2020 2020 2020 2020  d: str,.        
+00021b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021b40: 2020 2020 7469 6d65 6f75 745f 6d69 6e75      timeout_minu
+00021b50: 7465 733a 2069 6e74 2920 2d3e 2054 6573  tes: int) -> Tes
+00021b60: 743a 0a20 2020 2074 6573 7420 3d20 5465  t:.    test = Te
+00021b70: 7374 280a 2020 2020 2020 2020 6627 7465  st(.        f'te
+00021b80: 7374 2d73 6b79 7365 7276 652d 7b63 6c6f  st-skyserve-{clo
+00021b90: 7564 2e72 6570 6c61 6365 2822 5f22 2c20  ud.replace("_", 
+00021ba0: 222d 2229 7d27 2c0a 2020 2020 2020 2020  "-")}',.        
+00021bb0: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
+00021bc0: 736b 7920 7365 7276 6520 7570 202d 6e20  sky serve up -n 
+00021bd0: 7b6e 616d 657d 202d 7920 7465 7374 732f  {name} -y tests/
+00021be0: 736b 7973 6572 7665 2f68 7474 702f 7b63  skyserve/http/{c
+00021bf0: 6c6f 7564 7d2e 7961 6d6c 272c 0a20 2020  loud}.yaml',.   
+00021c00: 2020 2020 2020 2020 205f 5345 5256 455f           _SERVE_
+00021c10: 5741 4954 5f55 4e54 494c 5f52 4541 4459  WAIT_UNTIL_READY
+00021c20: 2e66 6f72 6d61 7428 6e61 6d65 3d6e 616d  .format(name=nam
+00021c30: 652c 2072 6570 6c69 6361 5f6e 756d 3d32  e, replica_num=2
+00021c40: 292c 0a20 2020 2020 2020 2020 2020 2066  ),.            f
+00021c50: 277b 5f53 4552 5645 5f45 4e44 504f 494e  '{_SERVE_ENDPOIN
+00021c60: 545f 5741 4954 2e66 6f72 6d61 7428 6e61  T_WAIT.format(na
+00021c70: 6d65 3d6e 616d 6529 7d3b 2027 0a20 2020  me=name)}; '.   
+00021c80: 2020 2020 2020 2020 2027 6375 726c 202d           'curl -
+00021c90: 4c20 6874 7470 3a2f 2f24 656e 6470 6f69  L http://$endpoi
+00021ca0: 6e74 207c 2067 7265 7020 2248 692c 2053  nt | grep "Hi, S
+00021cb0: 6b79 5069 6c6f 7420 6865 7265 2227 2c0a  kyPilot here"',.
+00021cc0: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
+00021cd0: 2020 205f 5445 4152 444f 574e 5f53 4552     _TEARDOWN_SER
+00021ce0: 5649 4345 2e66 6f72 6d61 7428 6e61 6d65  VICE.format(name
+00021cf0: 3d6e 616d 6529 2c0a 2020 2020 2020 2020  =name),.        
+00021d00: 7469 6d65 6f75 743d 7469 6d65 6f75 745f  timeout=timeout_
+00021d10: 6d69 6e75 7465 7320 2a20 3630 2c0a 2020  minutes * 60,.  
+00021d20: 2020 290a 2020 2020 7265 7475 726e 2074    ).    return t
+00021d30: 6573 740a 0a0a 6465 6620 5f63 6865 636b  est...def _check
+00021d40: 5f72 6570 6c69 6361 5f69 6e5f 7374 6174  _replica_in_stat
+00021d50: 7573 286e 616d 653a 2073 7472 2c20 6368  us(name: str, ch
+00021d60: 6563 6b5f 7475 706c 6573 3a20 4c69 7374  eck_tuples: List
+00021d70: 5b54 7570 6c65 5b69 6e74 2c20 626f 6f6c  [Tuple[int, bool
+00021d80: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00021d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021dc0: 2020 2073 7472 5d5d 2920 2d3e 2073 7472     str]]) -> str
+00021dd0: 3a0a 2020 2020 2222 2243 6865 636b 2072  :.    """Check r
+00021de0: 6570 6c69 6361 7327 2073 7461 7475 7320  eplicas' status 
+00021df0: 616e 6420 636f 756e 7420 696e 2073 6b79  and count in sky
+00021e00: 2073 6572 7665 2073 7461 7475 730a 0a20   serve status.. 
+00021e10: 2020 2057 6520 7769 6c6c 2063 6865 636b     We will check
+00021e20: 2076 4350 553d 322c 2061 7320 616c 6c20   vCPU=2, as all 
+00021e30: 6f75 7220 7465 7374 7320 7573 6520 7643  our tests use vC
+00021e40: 5055 3d32 2e0a 2020 2020 0a20 2020 2041  PU=2..    .    A
+00021e50: 7267 733a 0a20 2020 2020 2020 206e 616d  rgs:.        nam
+00021e60: 653a 2074 6865 206e 616d 6520 6f66 2074  e: the name of t
+00021e70: 6865 2073 6572 7669 6365 0a20 2020 2020  he service.     
+00021e80: 2020 2063 6865 636b 5f74 7570 6c65 733a     check_tuples:
+00021e90: 2041 206c 6973 7420 6f66 2072 6570 6c69   A list of repli
+00021ea0: 6361 2070 726f 7065 7274 7920 746f 2063  ca property to c
+00021eb0: 6865 636b 2e20 4561 6368 2074 7570 6c65  heck. Each tuple
+00021ec0: 2069 730a 2020 2020 2020 2020 2020 2020   is.            
+00021ed0: 2863 6f75 6e74 2c20 6973 5f73 706f 742c  (count, is_spot,
+00021ee0: 2073 7461 7475 7329 0a20 2020 2022 2222   status).    """
+00021ef0: 0a20 2020 2063 6865 636b 5f63 6d64 203d  .    check_cmd =
+00021f00: 2027 270a 2020 2020 666f 7220 6368 6563   ''.    for chec
+00021f10: 6b5f 7475 706c 6520 696e 2063 6865 636b  k_tuple in check
+00021f20: 5f74 7570 6c65 733a 0a20 2020 2020 2020  _tuples:.       
+00021f30: 2063 6f75 6e74 2c20 6973 5f73 706f 742c   count, is_spot,
+00021f40: 2073 7461 7475 7320 3d20 6368 6563 6b5f   status = check_
+00021f50: 7475 706c 650a 2020 2020 2020 2020 7265  tuple.        re
+00021f60: 736f 7572 6365 5f73 7472 203d 2027 270a  source_str = ''.
+00021f70: 2020 2020 2020 2020 6966 2073 7461 7475          if statu
+00021f80: 7320 6e6f 7420 696e 205b 2750 454e 4449  s not in ['PENDI
+00021f90: 4e47 272c 2027 5348 5554 5449 4e47 5f44  NG', 'SHUTTING_D
+00021fa0: 4f57 4e27 0a20 2020 2020 2020 2020 2020  OWN'.           
+00021fb0: 2020 2020 2020 2020 2020 2020 2020 5d20                ] 
+00021fc0: 616e 6420 6e6f 7420 7374 6174 7573 2e73  and not status.s
+00021fd0: 7461 7274 7377 6974 6828 2746 4149 4c45  tartswith('FAILE
+00021fe0: 4427 293a 0a20 2020 2020 2020 2020 2020  D'):.           
+00021ff0: 2073 706f 745f 7374 7220 3d20 2727 0a20   spot_str = ''. 
+00022000: 2020 2020 2020 2020 2020 2069 6620 6973             if is
+00022010: 5f73 706f 743a 0a20 2020 2020 2020 2020  _spot:.         
+00022020: 2020 2020 2020 2073 706f 745f 7374 7220         spot_str 
+00022030: 3d20 275c 5b53 706f 745c 5d27 0a20 2020  = '\[Spot\]'.   
+00022040: 2020 2020 2020 2020 2072 6573 6f75 7263           resourc
+00022050: 655f 7374 7220 3d20 6627 287b 7370 6f74  e_str = f'({spot
+00022060: 5f73 7472 7d76 4350 553d 3229 270a 2020  _str}vCPU=2)'.  
+00022070: 2020 2020 2020 6368 6563 6b5f 636d 6420        check_cmd 
+00022080: 2b3d 2028 6627 2065 6368 6f20 2224 7322  += (f' echo "$s"
+00022090: 207c 2067 7265 7020 227b 7265 736f 7572   | grep "{resour
+000220a0: 6365 5f73 7472 7d22 207c 2027 0a20 2020  ce_str}" | '.   
+000220b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000220c0: 2020 2066 2767 7265 7020 227b 7374 6174     f'grep "{stat
+000220d0: 7573 7d22 207c 2077 6320 2d6c 207c 2067  us}" | wc -l | g
+000220e0: 7265 7020 7b63 6f75 6e74 7d20 7c7c 2065  rep {count} || e
+000220f0: 7869 7420 313b 2729 0a20 2020 2072 6574  xit 1;').    ret
+00022100: 7572 6e20 2866 277b 5f53 4552 5645 5f53  urn (f'{_SERVE_S
+00022110: 5441 5455 535f 5741 4954 2e66 6f72 6d61  TATUS_WAIT.forma
+00022120: 7428 6e61 6d65 3d6e 616d 6529 7d3b 2065  t(name=name)}; e
+00022130: 6368 6f20 2224 7322 3b20 2720 2b20 6368  cho "$s"; ' + ch
+00022140: 6563 6b5f 636d 6429 0a0a 0a64 6566 205f  eck_cmd)...def _
+00022150: 6368 6563 6b5f 7365 7276 6963 655f 7665  check_service_ve
+00022160: 7273 696f 6e28 7365 7276 6963 655f 6e61  rsion(service_na
+00022170: 6d65 3a20 7374 722c 2076 6572 7369 6f6e  me: str, version
+00022180: 3a20 7374 7229 202d 3e20 7374 723a 0a20  : str) -> str:. 
+00022190: 2020 2023 2047 7265 7020 7468 6520 6c69     # Grep the li
+000221a0: 6e65 7320 6265 666f 7265 2027 5365 7276  nes before 'Serv
+000221b0: 6963 6520 5265 706c 6963 6173 2720 616e  ice Replicas' an
+000221c0: 6420 6368 6563 6b20 6966 2074 6865 2073  d check if the s
+000221d0: 6572 7669 6365 2076 6572 7369 6f6e 0a20  ervice version. 
+000221e0: 2020 2023 2069 7320 636f 7272 6563 742e     # is correct.
+000221f0: 0a20 2020 2072 6574 7572 6e20 2866 2765  .    return (f'e
+00022200: 6368 6f20 2224 7322 207c 2067 7265 7020  cho "$s" | grep 
+00022210: 2d42 3130 3030 2022 5365 7276 6963 6520  -B1000 "Service 
+00022220: 5265 706c 6963 6173 2220 7c20 270a 2020  Replicas" | '.  
+00022230: 2020 2020 2020 2020 2020 6627 6772 6570            f'grep
+00022240: 202d 4520 227b 7365 7276 6963 655f 6e61   -E "{service_na
+00022250: 6d65 7d5c 732b 7b76 6572 7369 6f6e 7d22  me}\s+{version}"
+00022260: 207c 7c20 6578 6974 2031 3b20 2729 0a0a   || exit 1; ')..
+00022270: 0a40 7079 7465 7374 2e6d 6172 6b2e 6763  .@pytest.mark.gc
+00022280: 700a 4070 7974 6573 742e 6d61 726b 2e73  p.@pytest.mark.s
+00022290: 6572 7665 0a64 6566 2074 6573 745f 736b  erve.def test_sk
+000222a0: 7973 6572 7665 5f67 6370 5f68 7474 7028  yserve_gcp_http(
+000222b0: 293a 0a20 2020 2022 2222 5465 7374 2073  ):.    """Test s
+000222c0: 6b79 7365 7276 6520 6f6e 2047 4350 2222  kyserve on GCP""
+000222d0: 220a 2020 2020 6e61 6d65 203d 205f 6765  ".    name = _ge
+000222e0: 745f 7365 7276 6963 655f 6e61 6d65 2829  t_service_name()
+000222f0: 0a20 2020 2074 6573 7420 3d20 5f67 6574  .    test = _get
+00022300: 5f73 6b79 7365 7276 655f 6874 7470 5f74  _skyserve_http_t
+00022310: 6573 7428 6e61 6d65 2c20 2767 6370 272c  est(name, 'gcp',
+00022320: 2032 3029 0a20 2020 2072 756e 5f6f 6e65   20).    run_one
+00022330: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
+00022340: 7974 6573 742e 6d61 726b 2e61 7773 0a40  ytest.mark.aws.@
+00022350: 7079 7465 7374 2e6d 6172 6b2e 7365 7276  pytest.mark.serv
+00022360: 650a 6465 6620 7465 7374 5f73 6b79 7365  e.def test_skyse
+00022370: 7276 655f 6177 735f 6874 7470 2829 3a0a  rve_aws_http():.
+00022380: 2020 2020 2222 2254 6573 7420 736b 7973      """Test skys
+00022390: 6572 7665 206f 6e20 4157 5322 2222 0a20  erve on AWS""". 
+000223a0: 2020 206e 616d 6520 3d20 5f67 6574 5f73     name = _get_s
+000223b0: 6572 7669 6365 5f6e 616d 6528 290a 2020  ervice_name().  
+000223c0: 2020 7465 7374 203d 205f 6765 745f 736b    test = _get_sk
+000223d0: 7973 6572 7665 5f68 7474 705f 7465 7374  yserve_http_test
+000223e0: 286e 616d 652c 2027 6177 7327 2c20 3230  (name, 'aws', 20
+000223f0: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
+00022400: 7374 2874 6573 7429 0a0a 0a40 7079 7465  st(test)...@pyte
+00022410: 7374 2e6d 6172 6b2e 617a 7572 650a 4070  st.mark.azure.@p
+00022420: 7974 6573 742e 6d61 726b 2e73 6572 7665  ytest.mark.serve
+00022430: 0a64 6566 2074 6573 745f 736b 7973 6572  .def test_skyser
+00022440: 7665 5f61 7a75 7265 5f68 7474 7028 293a  ve_azure_http():
+00022450: 0a20 2020 2022 2222 5465 7374 2073 6b79  .    """Test sky
+00022460: 7365 7276 6520 6f6e 2041 7a75 7265 2222  serve on Azure""
+00022470: 220a 2020 2020 6e61 6d65 203d 205f 6765  ".    name = _ge
+00022480: 745f 7365 7276 6963 655f 6e61 6d65 2829  t_service_name()
+00022490: 0a20 2020 2074 6573 7420 3d20 5f67 6574  .    test = _get
+000224a0: 5f73 6b79 7365 7276 655f 6874 7470 5f74  _skyserve_http_t
+000224b0: 6573 7428 6e61 6d65 2c20 2761 7a75 7265  est(name, 'azure
+000224c0: 272c 2033 3029 0a20 2020 2072 756e 5f6f  ', 30).    run_o
+000224d0: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+000224e0: 4070 7974 6573 742e 6d61 726b 2e73 6572  @pytest.mark.ser
+000224f0: 7665 0a40 7079 7465 7374 2e6d 6172 6b2e  ve.@pytest.mark.
+00022500: 6e6f 5f6b 7562 6572 6e65 7465 730a 6465  no_kubernetes.de
+00022510: 6620 7465 7374 5f73 6b79 7365 7276 655f  f test_skyserve_
+00022520: 6c6c 6d28 6765 6e65 7269 635f 636c 6f75  llm(generic_clou
+00022530: 643a 2073 7472 293a 0a20 2020 2022 2222  d: str):.    """
+00022540: 5465 7374 2073 6b79 7365 7276 6520 7769  Test skyserve wi
+00022550: 7468 2072 6561 6c20 4c4c 4d20 7573 6563  th real LLM usec
+00022560: 6173 6522 2222 0a20 2020 206e 616d 6520  ase""".    name 
+00022570: 3d20 5f67 6574 5f73 6572 7669 6365 5f6e  = _get_service_n
+00022580: 616d 6528 290a 0a20 2020 2064 6566 2067  ame()..    def g
+00022590: 656e 6572 6174 655f 6c6c 6d5f 7465 7374  enerate_llm_test
+000225a0: 5f63 6f6d 6d61 6e64 2870 726f 6d70 743a  _command(prompt:
+000225b0: 2073 7472 2c20 6578 7065 6374 6564 5f6f   str, expected_o
+000225c0: 7574 7075 743a 2073 7472 2920 2d3e 2073  utput: str) -> s
+000225d0: 7472 3a0a 2020 2020 2020 2020 7072 6f6d  tr:.        prom
+000225e0: 7074 203d 2073 686c 6578 2e71 756f 7465  pt = shlex.quote
+000225f0: 2870 726f 6d70 7429 0a20 2020 2020 2020  (prompt).       
+00022600: 2065 7870 6563 7465 645f 6f75 7470 7574   expected_output
+00022610: 203d 2073 686c 6578 2e71 756f 7465 2865   = shlex.quote(e
+00022620: 7870 6563 7465 645f 6f75 7470 7574 290a  xpected_output).
+00022630: 2020 2020 2020 2020 7265 7475 726e 2028          return (
+00022640: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
+00022650: 5f53 4552 5645 5f45 4e44 504f 494e 545f  _SERVE_ENDPOINT_
+00022660: 5741 4954 2e66 6f72 6d61 7428 6e61 6d65  WAIT.format(name
+00022670: 3d6e 616d 6529 7d3b 2027 0a20 2020 2020  =name)}; '.     
+00022680: 2020 2020 2020 2027 7079 7468 6f6e 2074         'python t
+00022690: 6573 7473 2f73 6b79 7365 7276 652f 6c6c  ests/skyserve/ll
+000226a0: 6d2f 6765 745f 7265 7370 6f6e 7365 2e70  m/get_response.p
+000226b0: 7920 2d2d 656e 6470 6f69 6e74 2024 656e  y --endpoint $en
+000226c0: 6470 6f69 6e74 2027 0a20 2020 2020 2020  dpoint '.       
+000226d0: 2020 2020 2066 272d 2d70 726f 6d70 7420       f'--prompt 
+000226e0: 7b70 726f 6d70 747d 207c 2067 7265 7020  {prompt} | grep 
+000226f0: 7b65 7870 6563 7465 645f 6f75 7470 7574  {expected_output
+00022700: 7d27 290a 0a20 2020 2077 6974 6820 6f70  }')..    with op
+00022710: 656e 2827 7465 7374 732f 736b 7973 6572  en('tests/skyser
+00022720: 7665 2f6c 6c6d 2f70 726f 6d70 745f 6f75  ve/llm/prompt_ou
+00022730: 7470 7574 2e6a 736f 6e27 2c20 2772 272c  tput.json', 'r',
+00022740: 0a20 2020 2020 2020 2020 2020 2020 2065  .              e
+00022750: 6e63 6f64 696e 673d 2775 7466 2d38 2729  ncoding='utf-8')
+00022760: 2061 7320 663a 0a20 2020 2020 2020 2070   as f:.        p
+00022770: 726f 6d70 7432 6f75 7470 7574 203d 206a  rompt2output = j
+00022780: 736f 6e2e 6c6f 6164 2866 290a 0a20 2020  son.load(f)..   
+00022790: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+000227a0: 2020 2020 2020 6627 7465 7374 2d73 6b79        f'test-sky
+000227b0: 7365 7276 652d 6c6c 6d27 2c0a 2020 2020  serve-llm',.    
+000227c0: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
+000227d0: 2020 6627 736b 7920 7365 7276 6520 7570    f'sky serve up
+000227e0: 202d 6e20 7b6e 616d 657d 202d 2d63 6c6f   -n {name} --clo
+000227f0: 7564 207b 6765 6e65 7269 635f 636c 6f75  ud {generic_clou
+00022800: 647d 202d 7920 7465 7374 732f 736b 7973  d} -y tests/skys
+00022810: 6572 7665 2f6c 6c6d 2f73 6572 7669 6365  erve/llm/service
+00022820: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
+00022830: 2020 2020 5f53 4552 5645 5f57 4149 545f      _SERVE_WAIT_
+00022840: 554e 5449 4c5f 5245 4144 592e 666f 726d  UNTIL_READY.form
+00022850: 6174 286e 616d 653d 6e61 6d65 2c20 7265  at(name=name, re
+00022860: 706c 6963 615f 6e75 6d3d 3129 2c0a 2020  plica_num=1),.  
+00022870: 2020 2020 2020 2020 2020 2a5b 0a20 2020            *[.   
+00022880: 2020 2020 2020 2020 2020 2020 2067 656e               gen
+00022890: 6572 6174 655f 6c6c 6d5f 7465 7374 5f63  erate_llm_test_c
+000228a0: 6f6d 6d61 6e64 2870 726f 6d70 742c 206f  ommand(prompt, o
+000228b0: 7574 7075 7429 0a20 2020 2020 2020 2020  utput).         
+000228c0: 2020 2020 2020 2066 6f72 2070 726f 6d70         for promp
+000228d0: 742c 206f 7574 7075 7420 696e 2070 726f  t, output in pro
+000228e0: 6d70 7432 6f75 7470 7574 2e69 7465 6d73  mpt2output.items
+000228f0: 2829 0a20 2020 2020 2020 2020 2020 205d  ().            ]
+00022900: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
+00022910: 2020 2020 205f 5445 4152 444f 574e 5f53       _TEARDOWN_S
+00022920: 4552 5649 4345 2e66 6f72 6d61 7428 6e61  ERVICE.format(na
+00022930: 6d65 3d6e 616d 6529 2c0a 2020 2020 2020  me=name),.      
+00022940: 2020 7469 6d65 6f75 743d 3235 202a 2036    timeout=25 * 6
+00022950: 302c 0a20 2020 2029 0a20 2020 2072 756e  0,.    ).    run
+00022960: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
+00022970: 0a0a 4070 7974 6573 742e 6d61 726b 2e67  ..@pytest.mark.g
+00022980: 6370 0a40 7079 7465 7374 2e6d 6172 6b2e  cp.@pytest.mark.
+00022990: 7365 7276 650a 6465 6620 7465 7374 5f73  serve.def test_s
+000229a0: 6b79 7365 7276 655f 7370 6f74 5f72 6563  kyserve_spot_rec
+000229b0: 6f76 6572 7928 293a 0a20 2020 206e 616d  overy():.    nam
+000229c0: 6520 3d20 5f67 6574 5f73 6572 7669 6365  e = _get_service
+000229d0: 5f6e 616d 6528 290a 2020 2020 7a6f 6e65  _name().    zone
+000229e0: 203d 2027 7573 2d63 656e 7472 616c 312d   = 'us-central1-
+000229f0: 6127 0a0a 2020 2020 7465 7374 203d 2054  a'..    test = T
+00022a00: 6573 7428 0a20 2020 2020 2020 2066 2774  est(.        f't
+00022a10: 6573 742d 736b 7973 6572 7665 2d73 706f  est-skyserve-spo
+00022a20: 742d 7265 636f 7665 7279 2d67 6370 272c  t-recovery-gcp',
+00022a30: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
+00022a40: 2020 2020 2020 2066 2773 6b79 2073 6572         f'sky ser
+00022a50: 7665 2075 7020 2d6e 207b 6e61 6d65 7d20  ve up -n {name} 
+00022a60: 2d79 2074 6573 7473 2f73 6b79 7365 7276  -y tests/skyserv
+00022a70: 652f 7370 6f74 2f72 6563 6f76 6572 792e  e/spot/recovery.
+00022a80: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+00022a90: 2020 205f 5345 5256 455f 5741 4954 5f55     _SERVE_WAIT_U
+00022aa0: 4e54 494c 5f52 4541 4459 2e66 6f72 6d61  NTIL_READY.forma
+00022ab0: 7428 6e61 6d65 3d6e 616d 652c 2072 6570  t(name=name, rep
+00022ac0: 6c69 6361 5f6e 756d 3d31 292c 0a20 2020  lica_num=1),.   
+00022ad0: 2020 2020 2020 2020 2066 277b 5f53 4552           f'{_SER
+00022ae0: 5645 5f45 4e44 504f 494e 545f 5741 4954  VE_ENDPOINT_WAIT
+00022af0: 2e66 6f72 6d61 7428 6e61 6d65 3d6e 616d  .format(name=nam
+00022b00: 6529 7d3b 2027 0a20 2020 2020 2020 2020  e)}; '.         
+00022b10: 2020 2027 7265 7175 6573 745f 6f75 7470     'request_outp
+00022b20: 7574 3d24 2863 7572 6c20 2d4c 2068 7474  ut=$(curl -L htt
+00022b30: 703a 2f2f 2465 6e64 706f 696e 7429 3b20  p://$endpoint); 
+00022b40: 6563 686f 2022 2472 6571 7565 7374 5f6f  echo "$request_o
+00022b50: 7574 7075 7422 3b20 6563 686f 2022 2472  utput"; echo "$r
+00022b60: 6571 7565 7374 5f6f 7574 7075 7422 207c  equest_output" |
+00022b70: 2067 7265 7020 2248 692c 2053 6b79 5069   grep "Hi, SkyPi
+00022b80: 6c6f 7420 6865 7265 2227 2c0a 2020 2020  lot here"',.    
+00022b90: 2020 2020 2020 2020 5f74 6572 6d69 6e61          _termina
+00022ba0: 7465 5f67 6370 5f72 6570 6c69 6361 286e  te_gcp_replica(n
+00022bb0: 616d 652c 207a 6f6e 652c 2031 292c 0a20  ame, zone, 1),. 
+00022bc0: 2020 2020 2020 2020 2020 205f 5345 5256             _SERV
+00022bd0: 455f 5741 4954 5f55 4e54 494c 5f52 4541  E_WAIT_UNTIL_REA
+00022be0: 4459 2e66 6f72 6d61 7428 6e61 6d65 3d6e  DY.format(name=n
+00022bf0: 616d 652c 2072 6570 6c69 6361 5f6e 756d  ame, replica_num
+00022c00: 3d31 292c 0a20 2020 2020 2020 2020 2020  =1),.           
+00022c10: 2066 277b 5f53 4552 5645 5f45 4e44 504f   f'{_SERVE_ENDPO
+00022c20: 494e 545f 5741 4954 2e66 6f72 6d61 7428  INT_WAIT.format(
+00022c30: 6e61 6d65 3d6e 616d 6529 7d3b 2027 0a20  name=name)}; '. 
+00022c40: 2020 2020 2020 2020 2020 2027 7265 7175             'requ
+00022c50: 6573 745f 6f75 7470 7574 3d24 2863 7572  est_output=$(cur
+00022c60: 6c20 2d4c 2068 7474 703a 2f2f 2465 6e64  l -L http://$end
+00022c70: 706f 696e 7429 3b20 6563 686f 2022 2472  point); echo "$r
+00022c80: 6571 7565 7374 5f6f 7574 7075 7422 3b20  equest_output"; 
+00022c90: 6563 686f 2022 2472 6571 7565 7374 5f6f  echo "$request_o
+00022ca0: 7574 7075 7422 207c 2067 7265 7020 2248  utput" | grep "H
+00022cb0: 692c 2053 6b79 5069 6c6f 7420 6865 7265  i, SkyPilot here
+00022cc0: 2227 2c0a 2020 2020 2020 2020 5d2c 0a20  "',.        ],. 
+00022cd0: 2020 2020 2020 205f 5445 4152 444f 574e         _TEARDOWN
+00022ce0: 5f53 4552 5649 4345 2e66 6f72 6d61 7428  _SERVICE.format(
+00022cf0: 6e61 6d65 3d6e 616d 6529 2c0a 2020 2020  name=name),.    
+00022d00: 2020 2020 7469 6d65 6f75 743d 3230 202a      timeout=20 *
+00022d10: 2036 302c 0a20 2020 2029 0a20 2020 2072   60,.    ).    r
+00022d20: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
+00022d30: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
+00022d40: 2e73 6572 7665 0a40 7079 7465 7374 2e6d  .serve.@pytest.m
+00022d50: 6172 6b2e 6e6f 5f6b 7562 6572 6e65 7465  ark.no_kubernete
+00022d60: 730a 6465 6620 7465 7374 5f73 6b79 7365  s.def test_skyse
+00022d70: 7276 655f 6261 7365 5f6f 6e64 656d 616e  rve_base_ondeman
+00022d80: 645f 6661 6c6c 6261 636b 2867 656e 6572  d_fallback(gener
+00022d90: 6963 5f63 6c6f 7564 3a20 7374 7229 3a0a  ic_cloud: str):.
+00022da0: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
+00022db0: 7365 7276 6963 655f 6e61 6d65 2829 0a20  service_name(). 
+00022dc0: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
+00022dd0: 2020 2020 2020 2020 6627 7465 7374 2d73          f'test-s
+00022de0: 6b79 7365 7276 652d 6261 7365 2d6f 6e64  kyserve-base-ond
+00022df0: 656d 616e 642d 6661 6c6c 6261 636b 272c  emand-fallback',
+00022e00: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
+00022e10: 2020 2020 2020 2066 2773 6b79 2073 6572         f'sky ser
+00022e20: 7665 2075 7020 2d6e 207b 6e61 6d65 7d20  ve up -n {name} 
+00022e30: 2d2d 636c 6f75 6420 7b67 656e 6572 6963  --cloud {generic
+00022e40: 5f63 6c6f 7564 7d20 2d79 2074 6573 7473  _cloud} -y tests
+00022e50: 2f73 6b79 7365 7276 652f 7370 6f74 2f62  /skyserve/spot/b
+00022e60: 6173 655f 6f6e 6465 6d61 6e64 5f66 616c  ase_ondemand_fal
+00022e70: 6c62 6163 6b2e 7961 6d6c 272c 0a20 2020  lback.yaml',.   
+00022e80: 2020 2020 2020 2020 205f 5345 5256 455f           _SERVE_
+00022e90: 5741 4954 5f55 4e54 494c 5f52 4541 4459  WAIT_UNTIL_READY
+00022ea0: 2e66 6f72 6d61 7428 6e61 6d65 3d6e 616d  .format(name=nam
+00022eb0: 652c 2072 6570 6c69 6361 5f6e 756d 3d32  e, replica_num=2
+00022ec0: 292c 0a20 2020 2020 2020 2020 2020 205f  ),.            _
+00022ed0: 6368 6563 6b5f 7265 706c 6963 615f 696e  check_replica_in
+00022ee0: 5f73 7461 7475 7328 6e61 6d65 2c20 5b28  _status(name, [(
+00022ef0: 312c 2054 7275 652c 2027 5245 4144 5927  1, True, 'READY'
+00022f00: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00022f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022f20: 2020 2020 2020 2020 2020 2020 2020 2028                 (
+00022f30: 312c 2046 616c 7365 2c20 2752 4541 4459  1, False, 'READY
+00022f40: 2729 5d29 2c0a 2020 2020 2020 2020 5d2c  ')]),.        ],
+00022f50: 0a20 2020 2020 2020 205f 5445 4152 444f  .        _TEARDO
+00022f60: 574e 5f53 4552 5649 4345 2e66 6f72 6d61  WN_SERVICE.forma
+00022f70: 7428 6e61 6d65 3d6e 616d 6529 2c0a 2020  t(name=name),.  
+00022f80: 2020 2020 2020 7469 6d65 6f75 743d 3230        timeout=20
+00022f90: 202a 2036 302c 0a20 2020 2029 0a20 2020   * 60,.    ).   
+00022fa0: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
+00022fb0: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
+00022fc0: 726b 2e67 6370 0a40 7079 7465 7374 2e6d  rk.gcp.@pytest.m
+00022fd0: 6172 6b2e 7365 7276 650a 6465 6620 7465  ark.serve.def te
+00022fe0: 7374 5f73 6b79 7365 7276 655f 6479 6e61  st_skyserve_dyna
+00022ff0: 6d69 635f 6f6e 6465 6d61 6e64 5f66 616c  mic_ondemand_fal
+00023000: 6c62 6163 6b28 293a 0a20 2020 206e 616d  lback():.    nam
+00023010: 6520 3d20 5f67 6574 5f73 6572 7669 6365  e = _get_service
+00023020: 5f6e 616d 6528 290a 2020 2020 7a6f 6e65  _name().    zone
+00023030: 203d 2027 7573 2d63 656e 7472 616c 312d   = 'us-central1-
+00023040: 6127 0a0a 2020 2020 7465 7374 203d 2054  a'..    test = T
+00023050: 6573 7428 0a20 2020 2020 2020 2066 2774  est(.        f't
+00023060: 6573 742d 736b 7973 6572 7665 2d64 796e  est-skyserve-dyn
+00023070: 616d 6963 2d6f 6e64 656d 616e 642d 6661  amic-ondemand-fa
+00023080: 6c6c 6261 636b 272c 0a20 2020 2020 2020  llback',.       
+00023090: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
+000230a0: 2773 6b79 2073 6572 7665 2075 7020 2d6e  'sky serve up -n
+000230b0: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
+000230c0: 6763 7020 2d79 2074 6573 7473 2f73 6b79  gcp -y tests/sky
+000230d0: 7365 7276 652f 7370 6f74 2f64 796e 616d  serve/spot/dynam
+000230e0: 6963 5f6f 6e64 656d 616e 645f 6661 6c6c  ic_ondemand_fall
+000230f0: 6261 636b 2e79 616d 6c27 2c0a 2020 2020  back.yaml',.    
+00023100: 2020 2020 2020 2020 6627 736c 6565 7020          f'sleep 
+00023110: 3430 272c 0a20 2020 2020 2020 2020 2020  40',.           
+00023120: 2023 2032 206f 6e2d 6465 6d61 6e64 2028   # 2 on-demand (
+00023130: 7072 6f76 6973 696f 6e69 6e67 2920 2b20  provisioning) + 
+00023140: 3220 5370 6f74 2028 7072 6f76 6973 696f  2 Spot (provisio
+00023150: 6e69 6e67 292e 0a20 2020 2020 2020 2020  ning)..         
+00023160: 2020 2066 277b 5f53 4552 5645 5f53 5441     f'{_SERVE_STA
+00023170: 5455 535f 5741 4954 2e66 6f72 6d61 7428  TUS_WAIT.format(
+00023180: 6e61 6d65 3d6e 616d 6529 7d3b 2065 6368  name=name)}; ech
+00023190: 6f20 2224 7322 3b27 0a20 2020 2020 2020  o "$s";'.       
+000231a0: 2020 2020 2027 6563 686f 2022 2473 2220       'echo "$s" 
+000231b0: 7c20 6772 6570 202d 7120 2230 2f34 2220  | grep -q "0/4" 
+000231c0: 7c7c 2065 7869 7420 3127 2c0a 2020 2020  || exit 1',.    
+000231d0: 2020 2020 2020 2020 2320 5761 6974 2066          # Wait f
+000231e0: 6f72 2074 6865 2070 726f 7669 7369 6f6e  or the provision
+000231f0: 696e 6720 7374 6172 7473 0a20 2020 2020  ing starts.     
+00023200: 2020 2020 2020 2066 2773 6c65 6570 2034         f'sleep 4
+00023210: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
+00023220: 5f63 6865 636b 5f72 6570 6c69 6361 5f69  _check_replica_i
+00023230: 6e5f 7374 6174 7573 286e 616d 652c 205b  n_status(name, [
+00023240: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00023250: 2028 322c 2054 7275 652c 205f 5345 5256   (2, True, _SERV
+00023260: 4943 455f 4c41 554e 4348 494e 475f 5354  ICE_LAUNCHING_ST
+00023270: 4154 5553 5f52 4547 4558 202b 2027 5c7c  ATUS_REGEX + '\|
+00023280: 5245 4144 5927 292c 0a20 2020 2020 2020  READY'),.       
+00023290: 2020 2020 2020 2020 2028 322c 2046 616c           (2, Fal
+000232a0: 7365 2c20 5f53 4552 5649 4345 5f4c 4155  se, _SERVICE_LAU
+000232b0: 4e43 4849 4e47 5f53 5441 5455 535f 5245  NCHING_STATUS_RE
+000232c0: 4745 5820 2b20 275c 7c53 4855 5454 494e  GEX + '\|SHUTTIN
+000232d0: 475f 444f 574e 2729 0a20 2020 2020 2020  G_DOWN').       
+000232e0: 2020 2020 205d 292c 0a0a 2020 2020 2020       ]),..      
+000232f0: 2020 2020 2020 2320 5761 6974 2075 6e74        # Wait unt
+00023300: 696c 2032 2073 706f 7420 696e 7374 616e  il 2 spot instan
+00023310: 6365 7320 6172 6520 7265 6164 792e 0a20  ces are ready.. 
+00023320: 2020 2020 2020 2020 2020 205f 5345 5256             _SERV
+00023330: 455f 5741 4954 5f55 4e54 494c 5f52 4541  E_WAIT_UNTIL_REA
+00023340: 4459 2e66 6f72 6d61 7428 6e61 6d65 3d6e  DY.format(name=n
+00023350: 616d 652c 2072 6570 6c69 6361 5f6e 756d  ame, replica_num
+00023360: 3d32 292c 0a20 2020 2020 2020 2020 2020  =2),.           
+00023370: 205f 6368 6563 6b5f 7265 706c 6963 615f   _check_replica_
+00023380: 696e 5f73 7461 7475 7328 6e61 6d65 2c20  in_status(name, 
+00023390: 5b28 322c 2054 7275 652c 2027 5245 4144  [(2, True, 'READ
+000233a0: 5927 292c 0a20 2020 2020 2020 2020 2020  Y'),.           
+000233b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000233c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000233d0: 2028 302c 2046 616c 7365 2c20 2727 295d   (0, False, '')]
+000233e0: 292c 0a20 2020 2020 2020 2020 2020 205f  ),.            _
+000233f0: 7465 726d 696e 6174 655f 6763 705f 7265  terminate_gcp_re
+00023400: 706c 6963 6128 6e61 6d65 2c20 7a6f 6e65  plica(name, zone
+00023410: 2c20 3129 2c0a 2020 2020 2020 2020 2020  , 1),.          
+00023420: 2020 6627 736c 6565 7020 3430 272c 0a20    f'sleep 40',. 
+00023430: 2020 2020 2020 2020 2020 2023 2031 206f             # 1 o
+00023440: 6e2d 6465 6d61 6e64 2028 7072 6f76 6973  n-demand (provis
+00023450: 696f 6e69 6e67 2920 2b20 3120 5370 6f74  ioning) + 1 Spot
+00023460: 2028 7265 6164 7929 202b 2031 2073 706f   (ready) + 1 spo
+00023470: 7420 2870 726f 7669 7369 6f6e 696e 6729  t (provisioning)
+00023480: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
+00023490: 7b5f 5345 5256 455f 5354 4154 5553 5f57  {_SERVE_STATUS_W
+000234a0: 4149 542e 666f 726d 6174 286e 616d 653d  AIT.format(name=
+000234b0: 6e61 6d65 297d 3b20 270a 2020 2020 2020  name)}; '.      
+000234c0: 2020 2020 2020 2765 6368 6f20 2224 7322        'echo "$s"
+000234d0: 207c 2067 7265 7020 2d71 2022 312f 3322   | grep -q "1/3"
+000234e0: 272c 0a20 2020 2020 2020 2020 2020 205f  ',.            _
+000234f0: 6368 6563 6b5f 7265 706c 6963 615f 696e  check_replica_in
+00023500: 5f73 7461 7475 7328 0a20 2020 2020 2020  _status(.       
+00023510: 2020 2020 2020 2020 206e 616d 652c 205b           name, [
+00023520: 2831 2c20 5472 7565 2c20 2752 4541 4459  (1, True, 'READY
+00023530: 2729 2c0a 2020 2020 2020 2020 2020 2020  '),.            
+00023540: 2020 2020 2020 2020 2020 2028 312c 2054             (1, T
+00023550: 7275 652c 205f 5345 5256 4943 455f 4c41  rue, _SERVICE_LA
+00023560: 554e 4348 494e 475f 5354 4154 5553 5f52  UNCHING_STATUS_R
+00023570: 4547 4558 292c 0a20 2020 2020 2020 2020  EGEX),.         
+00023580: 2020 2020 2020 2020 2020 2020 2020 2831                (1
+00023590: 2c20 4661 6c73 652c 205f 5345 5256 4943  , False, _SERVIC
+000235a0: 455f 4c41 554e 4348 494e 475f 5354 4154  E_LAUNCHING_STAT
+000235b0: 5553 5f52 4547 4558 295d 292c 0a0a 2020  US_REGEX)]),..  
+000235c0: 2020 2020 2020 2020 2020 2320 5761 6974            # Wait
+000235d0: 2075 6e74 696c 2032 2073 706f 7420 696e   until 2 spot in
+000235e0: 7374 616e 6365 7320 6172 6520 7265 6164  stances are read
+000235f0: 792e 0a20 2020 2020 2020 2020 2020 205f  y..            _
+00023600: 5345 5256 455f 5741 4954 5f55 4e54 494c  SERVE_WAIT_UNTIL
+00023610: 5f52 4541 4459 2e66 6f72 6d61 7428 6e61  _READY.format(na
+00023620: 6d65 3d6e 616d 652c 2072 6570 6c69 6361  me=name, replica
+00023630: 5f6e 756d 3d32 292c 0a20 2020 2020 2020  _num=2),.       
+00023640: 2020 2020 205f 6368 6563 6b5f 7265 706c       _check_repl
+00023650: 6963 615f 696e 5f73 7461 7475 7328 6e61  ica_in_status(na
+00023660: 6d65 2c20 5b28 322c 2054 7275 652c 2027  me, [(2, True, '
+00023670: 5245 4144 5927 292c 0a20 2020 2020 2020  READY'),.       
+00023680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000236a0: 2020 2020 2028 302c 2046 616c 7365 2c20       (0, False, 
+000236b0: 2727 295d 292c 0a20 2020 2020 2020 205d  '')]),.        ]
+000236c0: 2c0a 2020 2020 2020 2020 5f54 4541 5244  ,.        _TEARD
+000236d0: 4f57 4e5f 5345 5256 4943 452e 666f 726d  OWN_SERVICE.form
+000236e0: 6174 286e 616d 653d 6e61 6d65 292c 0a20  at(name=name),. 
+000236f0: 2020 2020 2020 2074 696d 656f 7574 3d32         timeout=2
+00023700: 3020 2a20 3630 2c0a 2020 2020 290a 2020  0 * 60,.    ).  
+00023710: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+00023720: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
+00023730: 6172 6b2e 7365 7276 650a 4070 7974 6573  ark.serve.@pytes
+00023740: 742e 6d61 726b 2e6e 6f5f 6b75 6265 726e  t.mark.no_kubern
+00023750: 6574 6573 0a64 6566 2074 6573 745f 736b  etes.def test_sk
+00023760: 7973 6572 7665 5f75 7365 725f 6275 675f  yserve_user_bug_
+00023770: 7265 7374 6172 7428 6765 6e65 7269 635f  restart(generic_
+00023780: 636c 6f75 643a 2073 7472 293a 0a20 2020  cloud: str):.   
+00023790: 2022 2222 5465 7374 7320 7468 6174 2077   """Tests that w
+000237a0: 6520 7265 7374 6172 7420 7468 6520 7365  e restart the se
+000237b0: 7276 6963 6520 6166 7465 7220 7573 6572  rvice after user
+000237c0: 2062 7567 2e22 2222 0a20 2020 2023 2054   bug.""".    # T
+000237d0: 4f44 4f28 7a68 7775 293a 2074 6869 7320  ODO(zhwu): this 
+000237e0: 6265 6861 7669 6f72 206e 6565 6473 2073  behavior needs s
+000237f0: 6f6d 6520 7265 7468 696e 6b69 6e67 2e0a  ome rethinking..
+00023800: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
+00023810: 7365 7276 6963 655f 6e61 6d65 2829 0a20  service_name(). 
+00023820: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
+00023830: 2020 2020 2020 2020 6627 7465 7374 2d73          f'test-s
+00023840: 6b79 7365 7276 652d 7573 6572 2d62 7567  kyserve-user-bug
+00023850: 2d72 6573 7461 7274 272c 0a20 2020 2020  -restart',.     
+00023860: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+00023870: 2066 2773 6b79 2073 6572 7665 2075 7020   f'sky serve up 
+00023880: 2d6e 207b 6e61 6d65 7d20 2d2d 636c 6f75  -n {name} --clou
+00023890: 6420 7b67 656e 6572 6963 5f63 6c6f 7564  d {generic_cloud
+000238a0: 7d20 2d79 2074 6573 7473 2f73 6b79 7365  } -y tests/skyse
+000238b0: 7276 652f 7265 7374 6172 742f 7573 6572  rve/restart/user
+000238c0: 5f62 7567 2e79 616d 6c27 2c0a 2020 2020  _bug.yaml',.    
+000238d0: 2020 2020 2020 2020 6627 733d 2428 736b          f's=$(sk
+000238e0: 7920 7365 7276 6520 7374 6174 7573 207b  y serve status {
+000238f0: 6e61 6d65 7d29 3b20 6563 686f 2022 2473  name}); echo "$s
+00023900: 223b 270a 2020 2020 2020 2020 2020 2020  ";'.            
+00023910: 2775 6e74 696c 2065 6368 6f20 2224 7322  'until echo "$s"
+00023920: 207c 2067 7265 7020 2d41 2031 3030 2022   | grep -A 100 "
+00023930: 5365 7276 6963 6520 5265 706c 6963 6173  Service Replicas
+00023940: 2220 7c20 6772 6570 2022 5348 5554 5449  " | grep "SHUTTI
+00023950: 4e47 5f44 4f57 4e22 3b20 270a 2020 2020  NG_DOWN"; '.    
+00023960: 2020 2020 2020 2020 2764 6f20 6563 686f          'do echo
+00023970: 2022 5761 6974 696e 6720 666f 7220 6669   "Waiting for fi
+00023980: 7273 7420 7365 7276 6963 6520 746f 2062  rst service to b
+00023990: 6520 5348 5554 5449 4e47 2044 4f57 4e2e  e SHUTTING DOWN.
+000239a0: 2e2e 223b 2027 0a20 2020 2020 2020 2020  .."; '.         
+000239b0: 2020 2066 2773 6c65 6570 2035 3b20 733d     f'sleep 5; s=
+000239c0: 2428 736b 7920 7365 7276 6520 7374 6174  $(sky serve stat
+000239d0: 7573 207b 6e61 6d65 7d29 3b20 6563 686f  us {name}); echo
+000239e0: 2022 2473 223b 2064 6f6e 653b 2027 2c0a   "$s"; done; ',.
+000239f0: 2020 2020 2020 2020 2020 2020 6627 733d              f's=
+00023a00: 2428 736b 7920 7365 7276 6520 7374 6174  $(sky serve stat
+00023a10: 7573 207b 6e61 6d65 7d29 3b20 6563 686f  us {name}); echo
+00023a20: 2022 2473 223b 270a 2020 2020 2020 2020   "$s";'.        
+00023a30: 2020 2020 2775 6e74 696c 2065 6368 6f20      'until echo 
+00023a40: 2224 7322 207c 2067 7265 7020 2d41 2031  "$s" | grep -A 1
+00023a50: 3030 2022 5365 7276 6963 6520 5265 706c  00 "Service Repl
+00023a60: 6963 6173 2220 7c20 6772 6570 2022 4641  icas" | grep "FA
+00023a70: 494c 4544 223b 2027 0a20 2020 2020 2020  ILED"; '.       
+00023a80: 2020 2020 2027 646f 2065 6368 6f20 2257       'do echo "W
+00023a90: 6169 7469 6e67 2066 6f72 2066 6972 7374  aiting for first
+00023aa0: 2073 6572 7669 6365 2074 6f20 6265 2046   service to be F
+00023ab0: 4149 4c45 442e 2e2e 223b 2027 0a20 2020  AILED..."; '.   
+00023ac0: 2020 2020 2020 2020 2066 2773 6c65 6570           f'sleep
+00023ad0: 2035 3b20 733d 2428 736b 7920 7365 7276   5; s=$(sky serv
+00023ae0: 6520 7374 6174 7573 207b 6e61 6d65 7d29  e status {name})
+00023af0: 3b20 6563 686f 2022 2473 223b 2064 6f6e  ; echo "$s"; don
+00023b00: 653b 2065 6368 6f20 2224 7322 3b20 270a  e; echo "$s"; '.
+00023b10: 2020 2020 2020 2020 2020 2020 2b20 5f63              + _c
+00023b20: 6865 636b 5f72 6570 6c69 6361 5f69 6e5f  heck_replica_in_
+00023b30: 7374 6174 7573 286e 616d 652c 205b 2831  status(name, [(1
+00023b40: 2c20 5472 7565 2c20 2746 4149 4c45 4427  , True, 'FAILED'
+00023b50: 295d 2920 2b0a 2020 2020 2020 2020 2020  )]) +.          
+00023b60: 2020 2320 5573 6572 2062 7567 2066 6169    # User bug fai
+00023b70: 6c75 7265 2077 696c 6c20 6361 7573 6520  lure will cause 
+00023b80: 6e6f 2066 7572 7468 6572 2073 6361 6c69  no further scali
+00023b90: 6e67 2e0a 2020 2020 2020 2020 2020 2020  ng..            
+00023ba0: 6627 6563 686f 2022 2473 2220 7c20 6772  f'echo "$s" | gr
+00023bb0: 6570 202d 4120 3130 3020 2253 6572 7669  ep -A 100 "Servi
+00023bc0: 6365 2052 6570 6c69 6361 7322 207c 2067  ce Replicas" | g
+00023bd0: 7265 7020 227b 6e61 6d65 7d22 207c 2077  rep "{name}" | w
+00023be0: 6320 2d6c 207c 2067 7265 7020 313b 2027  c -l | grep 1; '
+00023bf0: 0a20 2020 2020 2020 2020 2020 2066 2765  .            f'e
+00023c00: 6368 6f20 2224 7322 207c 2067 7265 7020  cho "$s" | grep 
+00023c10: 2d42 2031 3030 2022 4e4f 5f52 4550 4c49  -B 100 "NO_REPLI
+00023c20: 4341 2220 7c20 6772 6570 2022 302f 3022  CA" | grep "0/0"
+00023c30: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00023c40: 2773 6b79 2073 6572 7665 2075 7064 6174  'sky serve updat
+00023c50: 6520 7b6e 616d 657d 202d 2d63 6c6f 7564  e {name} --cloud
+00023c60: 207b 6765 6e65 7269 635f 636c 6f75 647d   {generic_cloud}
+00023c70: 202d 7920 7465 7374 732f 736b 7973 6572   -y tests/skyser
+00023c80: 7665 2f61 7574 6f5f 7265 7374 6172 742e  ve/auto_restart.
+00023c90: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+00023ca0: 2020 2066 277b 5f53 4552 5645 5f45 4e44     f'{_SERVE_END
+00023cb0: 504f 494e 545f 5741 4954 2e66 6f72 6d61  POINT_WAIT.forma
+00023cc0: 7428 6e61 6d65 3d6e 616d 6529 7d3b 2027  t(name=name)}; '
+00023cd0: 0a20 2020 2020 2020 2020 2020 2027 756e  .            'un
+00023ce0: 7469 6c20 6375 726c 202d 4c20 6874 7470  til curl -L http
+00023cf0: 3a2f 2f24 656e 6470 6f69 6e74 207c 2067  ://$endpoint | g
+00023d00: 7265 7020 2248 692c 2053 6b79 5069 6c6f  rep "Hi, SkyPilo
+00023d10: 7420 6865 7265 2122 3b20 646f 2073 6c65  t here!"; do sle
+00023d20: 6570 2032 3b20 646f 6e65 3b20 736c 6565  ep 2; done; slee
+00023d30: 7020 323b 2027 0a20 2020 2020 2020 2020  p 2; '.         
+00023d40: 2020 202b 205f 6368 6563 6b5f 7265 706c     + _check_repl
+00023d50: 6963 615f 696e 5f73 7461 7475 7328 6e61  ica_in_status(na
+00023d60: 6d65 2c20 5b28 312c 2046 616c 7365 2c20  me, [(1, False, 
+00023d70: 2752 4541 4459 2729 2c0a 2020 2020 2020  'READY'),.      
+00023d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023da0: 2020 2020 2020 2020 2831 2c20 4661 6c73          (1, Fals
+00023db0: 652c 2027 4641 494c 4544 2729 5d29 2c0a  e, 'FAILED')]),.
+00023dc0: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
+00023dd0: 2020 205f 5445 4152 444f 574e 5f53 4552     _TEARDOWN_SER
+00023de0: 5649 4345 2e66 6f72 6d61 7428 6e61 6d65  VICE.format(name
+00023df0: 3d6e 616d 6529 2c0a 2020 2020 2020 2020  =name),.        
+00023e00: 7469 6d65 6f75 743d 3230 202a 2036 302c  timeout=20 * 60,
+00023e10: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+00023e20: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+00023e30: 4070 7974 6573 742e 6d61 726b 2e73 6572  @pytest.mark.ser
+00023e40: 7665 0a40 7079 7465 7374 2e6d 6172 6b2e  ve.@pytest.mark.
+00023e50: 6e6f 5f6b 7562 6572 6e65 7465 730a 6465  no_kubernetes.de
+00023e60: 6620 7465 7374 5f73 6b79 7365 7276 655f  f test_skyserve_
+00023e70: 6c6f 6164 5f62 616c 616e 6365 7228 6765  load_balancer(ge
+00023e80: 6e65 7269 635f 636c 6f75 643a 2073 7472  neric_cloud: str
+00023e90: 293a 0a20 2020 2022 2222 5465 7374 2073  ):.    """Test s
+00023ea0: 6b79 7365 7276 6520 6c6f 6164 2062 616c  kyserve load bal
+00023eb0: 616e 6365 7220 726f 756e 642d 726f 6269  ancer round-robi
+00023ec0: 6e20 706f 6c69 6379 2222 220a 2020 2020  n policy""".    
+00023ed0: 6e61 6d65 203d 205f 6765 745f 7365 7276  name = _get_serv
+00023ee0: 6963 655f 6e61 6d65 2829 0a20 2020 2074  ice_name().    t
+00023ef0: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+00023f00: 2020 2020 6627 7465 7374 2d73 6b79 7365      f'test-skyse
+00023f10: 7276 652d 6c6f 6164 2d62 616c 616e 6365  rve-load-balance
+00023f20: 7227 2c0a 2020 2020 2020 2020 5b0a 2020  r',.        [.  
+00023f30: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00023f40: 7365 7276 6520 7570 202d 6e20 7b6e 616d  serve up -n {nam
+00023f50: 657d 202d 2d63 6c6f 7564 207b 6765 6e65  e} --cloud {gene
+00023f60: 7269 635f 636c 6f75 647d 202d 7920 7465  ric_cloud} -y te
+00023f70: 7374 732f 736b 7973 6572 7665 2f6c 6f61  sts/skyserve/loa
+00023f80: 645f 6261 6c61 6e63 6572 2f73 6572 7669  d_balancer/servi
+00023f90: 6365 2e79 616d 6c27 2c0a 2020 2020 2020  ce.yaml',.      
+00023fa0: 2020 2020 2020 5f53 4552 5645 5f57 4149        _SERVE_WAI
+00023fb0: 545f 554e 5449 4c5f 5245 4144 592e 666f  T_UNTIL_READY.fo
+00023fc0: 726d 6174 286e 616d 653d 6e61 6d65 2c20  rmat(name=name, 
+00023fd0: 7265 706c 6963 615f 6e75 6d3d 3329 2c0a  replica_num=3),.
+00023fe0: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
+00023ff0: 5345 5256 455f 454e 4450 4f49 4e54 5f57  SERVE_ENDPOINT_W
+00024000: 4149 542e 666f 726d 6174 286e 616d 653d  AIT.format(name=
+00024010: 6e61 6d65 297d 3b20 270a 2020 2020 2020  name)}; '.      
+00024020: 2020 2020 2020 6627 7b5f 5345 5256 455f        f'{_SERVE_
+00024030: 5354 4154 5553 5f57 4149 542e 666f 726d  STATUS_WAIT.form
+00024040: 6174 286e 616d 653d 6e61 6d65 297d 3b20  at(name=name)}; 
+00024050: 270a 2020 2020 2020 2020 2020 2020 6627  '.            f'
+00024060: 7b5f 6765 745f 7265 706c 6963 615f 6970  {_get_replica_ip
+00024070: 286e 616d 652c 2031 297d 3b20 270a 2020  (name, 1)}; '.  
+00024080: 2020 2020 2020 2020 2020 6627 7b5f 6765            f'{_ge
+00024090: 745f 7265 706c 6963 615f 6970 286e 616d  t_replica_ip(nam
+000240a0: 652c 2032 297d 3b20 7b5f 6765 745f 7265  e, 2)}; {_get_re
+000240b0: 706c 6963 615f 6970 286e 616d 652c 2033  plica_ip(name, 3
+000240c0: 297d 3b20 270a 2020 2020 2020 2020 2020  )}; '.          
+000240d0: 2020 2770 7974 686f 6e20 7465 7374 732f    'python tests/
+000240e0: 736b 7973 6572 7665 2f6c 6f61 645f 6261  skyserve/load_ba
+000240f0: 6c61 6e63 6572 2f74 6573 745f 726f 756e  lancer/test_roun
+00024100: 645f 726f 6269 6e2e 7079 2027 0a20 2020  d_robin.py '.   
+00024110: 2020 2020 2020 2020 2027 2d2d 656e 6470           '--endp
+00024120: 6f69 6e74 2024 656e 6470 6f69 6e74 202d  oint $endpoint -
+00024130: 2d72 6570 6c69 6361 2d6e 756d 2033 202d  -replica-num 3 -
+00024140: 2d72 6570 6c69 6361 2d69 7073 2024 6970  -replica-ips $ip
+00024150: 3120 2469 7032 2024 6970 3327 2c0a 2020  1 $ip2 $ip3',.  
+00024160: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
+00024170: 205f 5445 4152 444f 574e 5f53 4552 5649   _TEARDOWN_SERVI
+00024180: 4345 2e66 6f72 6d61 7428 6e61 6d65 3d6e  CE.format(name=n
+00024190: 616d 6529 2c0a 2020 2020 2020 2020 7469  ame),.        ti
+000241a0: 6d65 6f75 743d 3230 202a 2036 302c 0a20  meout=20 * 60,. 
+000241b0: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
+000241c0: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
+000241d0: 7974 6573 742e 6d61 726b 2e67 6370 0a40  ytest.mark.gcp.@
+000241e0: 7079 7465 7374 2e6d 6172 6b2e 7365 7276  pytest.mark.serv
+000241f0: 650a 4070 7974 6573 742e 6d61 726b 2e6e  e.@pytest.mark.n
+00024200: 6f5f 6b75 6265 726e 6574 6573 0a64 6566  o_kubernetes.def
+00024210: 2074 6573 745f 736b 7973 6572 7665 5f61   test_skyserve_a
+00024220: 7574 6f5f 7265 7374 6172 7428 293a 0a20  uto_restart():. 
+00024230: 2020 2022 2222 5465 7374 2073 6b79 7365     """Test skyse
+00024240: 7276 6520 7769 7468 2061 7574 6f20 7265  rve with auto re
+00024250: 7374 6172 7422 2222 0a20 2020 206e 616d  start""".    nam
+00024260: 6520 3d20 5f67 6574 5f73 6572 7669 6365  e = _get_service
+00024270: 5f6e 616d 6528 290a 2020 2020 7a6f 6e65  _name().    zone
+00024280: 203d 2027 7573 2d63 656e 7472 616c 312d   = 'us-central1-
+00024290: 6127 0a20 2020 2074 6573 7420 3d20 5465  a'.    test = Te
+000242a0: 7374 280a 2020 2020 2020 2020 6627 7465  st(.        f'te
+000242b0: 7374 2d73 6b79 7365 7276 652d 6175 746f  st-skyserve-auto
+000242c0: 2d72 6573 7461 7274 272c 0a20 2020 2020  -restart',.     
+000242d0: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+000242e0: 2023 2054 4f44 4f28 7469 616e 293a 2077   # TODO(tian): w
+000242f0: 6520 6361 6e20 6479 6e61 6d69 6361 6c6c  e can dynamicall
+00024300: 7920 6765 6e65 7261 7465 2059 414d 4c20  y generate YAML 
+00024310: 6672 6f6d 2074 656d 706c 6174 6520 746f  from template to
+00024320: 0a20 2020 2020 2020 2020 2020 2023 2061  .            # a
+00024330: 766f 6964 206d 6169 6e74 6169 6e69 6e67  void maintaining
+00024340: 2074 6f6f 206d 616e 7920 5941 4d4c 2066   too many YAML f
+00024350: 696c 6573 0a20 2020 2020 2020 2020 2020  iles.           
+00024360: 2066 2773 6b79 2073 6572 7665 2075 7020   f'sky serve up 
+00024370: 2d6e 207b 6e61 6d65 7d20 2d79 2074 6573  -n {name} -y tes
+00024380: 7473 2f73 6b79 7365 7276 652f 6175 746f  ts/skyserve/auto
+00024390: 5f72 6573 7461 7274 2e79 616d 6c27 2c0a  _restart.yaml',.
+000243a0: 2020 2020 2020 2020 2020 2020 5f53 4552              _SER
+000243b0: 5645 5f57 4149 545f 554e 5449 4c5f 5245  VE_WAIT_UNTIL_RE
+000243c0: 4144 592e 666f 726d 6174 286e 616d 653d  ADY.format(name=
+000243d0: 6e61 6d65 2c20 7265 706c 6963 615f 6e75  name, replica_nu
+000243e0: 6d3d 3129 2c0a 2020 2020 2020 2020 2020  m=1),.          
+000243f0: 2020 6627 7b5f 5345 5256 455f 454e 4450    f'{_SERVE_ENDP
+00024400: 4f49 4e54 5f57 4149 542e 666f 726d 6174  OINT_WAIT.format
+00024410: 286e 616d 653d 6e61 6d65 297d 3b20 270a  (name=name)}; '.
+00024420: 2020 2020 2020 2020 2020 2020 2772 6571              'req
+00024430: 7565 7374 5f6f 7574 7075 743d 2428 6375  uest_output=$(cu
+00024440: 726c 202d 4c20 6874 7470 3a2f 2f24 656e  rl -L http://$en
+00024450: 6470 6f69 6e74 293b 2065 6368 6f20 2224  dpoint); echo "$
+00024460: 7265 7175 6573 745f 6f75 7470 7574 223b  request_output";
+00024470: 2065 6368 6f20 2224 7265 7175 6573 745f   echo "$request_
+00024480: 6f75 7470 7574 2220 7c20 6772 6570 2022  output" | grep "
+00024490: 4869 2c20 536b 7950 696c 6f74 2068 6572  Hi, SkyPilot her
+000244a0: 6522 272c 0a20 2020 2020 2020 2020 2020  e"',.           
+000244b0: 2023 2073 6c65 6570 2066 6f72 2032 3020   # sleep for 20 
+000244c0: 7365 636f 6e64 7320 2869 6e69 7469 616c  seconds (initial
+000244d0: 2064 656c 6179 2920 746f 206d 616b 6520   delay) to make 
+000244e0: 7375 7265 2069 7420 7769 6c6c 0a20 2020  sure it will.   
+000244f0: 2020 2020 2020 2020 2023 2062 6520 7265           # be re
+00024500: 7374 6172 7465 640a 2020 2020 2020 2020  started.        
+00024510: 2020 2020 6627 736c 6565 7020 3230 272c      f'sleep 20',
+00024520: 0a20 2020 2020 2020 2020 2020 205f 7465  .            _te
+00024530: 726d 696e 6174 655f 6763 705f 7265 706c  rminate_gcp_repl
+00024540: 6963 6128 6e61 6d65 2c20 7a6f 6e65 2c20  ica(name, zone, 
+00024550: 3129 2c0a 2020 2020 2020 2020 2020 2020  1),.            
+00024560: 2320 5761 6974 2066 6f72 2063 6f6e 7365  # Wait for conse
+00024570: 6375 7469 7665 2066 6169 6c75 7265 2074  cutive failure t
+00024580: 696d 656f 7574 2070 6173 7365 642e 0a20  imeout passed.. 
+00024590: 2020 2020 2020 2020 2020 2023 2049 6620             # If 
+000245a0: 7468 6520 636c 7573 7465 7220 6973 206e  the cluster is n
+000245b0: 6f74 2075 7369 6e67 2073 706f 742c 2069  ot using spot, i
+000245c0: 7420 776f 6e27 7420 6368 6563 6b20 7468  t won't check th
+000245d0: 6520 636c 7573 7465 7220 7374 6174 7573  e cluster status
+000245e0: 0a20 2020 2020 2020 2020 2020 2023 206f  .            # o
+000245f0: 6e20 7468 6520 636c 6f75 6420 2873 696e  n the cloud (sin
+00024600: 6365 206d 616e 7561 6c20 7368 7574 646f  ce manual shutdo
+00024610: 776e 2069 7320 6e6f 7420 6120 636f 6d6d  wn is not a comm
+00024620: 6f6e 2062 6568 6176 696f 7220 616e 6420  on behavior and 
+00024630: 7375 6368 0a20 2020 2020 2020 2020 2020  such.           
+00024640: 2023 2071 7565 7269 6573 2074 616b 6573   # queries takes
+00024650: 2061 206c 6f74 206f 6620 7469 6d65 292e   a lot of time).
+00024660: 2049 6e73 7465 6164 2c20 7765 2074 6869   Instead, we thi
+00024670: 6e6b 2063 6f6e 7469 6e75 6f75 7320 3320  nk continuous 3 
+00024680: 6d69 6e20 7072 6f62 650a 2020 2020 2020  min probe.      
+00024690: 2020 2020 2020 2320 6661 696c 7572 6520        # failure 
+000246a0: 6973 206e 6f74 2061 2074 656d 706f 7261  is not a tempora
+000246b0: 7279 2070 726f 626c 656d 2062 7574 2069  ry problem but i
+000246c0: 6e64 6565 6420 6120 6661 696c 7572 652e  ndeed a failure.
+000246d0: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
+000246e0: 6565 7020 3138 3027 2c0a 2020 2020 2020  eep 180',.      
+000246f0: 2020 2020 2020 2320 5765 2063 616e 6e6f        # We canno
+00024700: 7420 7573 6520 5f53 4552 5645 5f57 4149  t use _SERVE_WAI
+00024710: 545f 554e 5449 4c5f 5245 4144 593b 2074  T_UNTIL_READY; t
+00024720: 6865 7265 2077 696c 6c20 6265 2061 2069  here will be a i
+00024730: 6e74 6572 6d65 6469 6174 6520 7469 6d65  ntermediate time
+00024740: 0a20 2020 2020 2020 2020 2020 2023 2074  .            # t
+00024750: 6861 7420 7468 6520 6f75 7470 7574 206f  hat the output o
+00024760: 6620 6073 6b79 2073 6572 7665 2073 7461  f `sky serve sta
+00024770: 7475 7360 2073 686f 7773 2046 4149 4c45  tus` shows FAILE
+00024780: 4420 616e 6420 7468 6973 2073 7461 7475  D and this statu
+00024790: 7320 7769 6c6c 0a20 2020 2020 2020 2020  s will.         
+000247a0: 2020 2023 2063 6175 7365 205f 5345 5256     # cause _SERV
+000247b0: 455f 5741 4954 5f55 4e54 494c 5f52 4541  E_WAIT_UNTIL_REA
+000247c0: 4459 2074 6f20 6561 726c 7920 7175 6974  DY to early quit
+000247d0: 2e0a 2020 2020 2020 2020 2020 2020 2728  ..            '(
+000247e0: 7768 696c 6520 7472 7565 3b20 646f 270a  while true; do'.
+000247f0: 2020 2020 2020 2020 2020 2020 6627 2020              f'  
+00024800: 2020 6f75 7470 7574 3d24 2873 6b79 2073    output=$(sky s
+00024810: 6572 7665 2073 7461 7475 7320 7b6e 616d  erve status {nam
+00024820: 657d 293b 270a 2020 2020 2020 2020 2020  e});'.          
+00024830: 2020 2720 2020 2020 6563 686f 2022 246f    '     echo "$o
+00024840: 7574 7075 7422 207c 2067 7265 7020 2d71  utput" | grep -q
+00024850: 2022 312f 3122 2026 2620 6272 6561 6b3b   "1/1" && break;
+00024860: 270a 2020 2020 2020 2020 2020 2020 2720  '.            ' 
+00024870: 2020 2020 736c 6565 7020 3130 3b27 0a20      sleep 10;'. 
+00024880: 2020 2020 2020 2020 2020 2066 2764 6f6e             f'don
+00024890: 6529 3b20 736c 6565 7020 7b73 6572 7665  e); sleep {serve
+000248a0: 2e4c 425f 434f 4e54 524f 4c4c 4552 5f53  .LB_CONTROLLER_S
+000248b0: 594e 435f 494e 5445 5256 414c 5f53 4543  YNC_INTERVAL_SEC
+000248c0: 4f4e 4453 7d3b 272c 0a20 2020 2020 2020  ONDS};',.       
+000248d0: 2020 2020 2066 277b 5f53 4552 5645 5f45       f'{_SERVE_E
+000248e0: 4e44 504f 494e 545f 5741 4954 2e66 6f72  NDPOINT_WAIT.for
+000248f0: 6d61 7428 6e61 6d65 3d6e 616d 6529 7d3b  mat(name=name)};
+00024900: 2027 0a20 2020 2020 2020 2020 2020 2027   '.            '
+00024910: 7265 7175 6573 745f 6f75 7470 7574 3d24  request_output=$
+00024920: 2863 7572 6c20 2d4c 2068 7474 703a 2f2f  (curl -L http://
+00024930: 2465 6e64 706f 696e 7429 3b20 6563 686f  $endpoint); echo
+00024940: 2022 2472 6571 7565 7374 5f6f 7574 7075   "$request_outpu
+00024950: 7422 3b20 6563 686f 2022 2472 6571 7565  t"; echo "$reque
+00024960: 7374 5f6f 7574 7075 7422 207c 2067 7265  st_output" | gre
+00024970: 7020 2248 692c 2053 6b79 5069 6c6f 7420  p "Hi, SkyPilot 
+00024980: 6865 7265 2227 2c0a 2020 2020 2020 2020  here"',.        
+00024990: 5d2c 0a20 2020 2020 2020 205f 5445 4152  ],.        _TEAR
+000249a0: 444f 574e 5f53 4552 5649 4345 2e66 6f72  DOWN_SERVICE.for
+000249b0: 6d61 7428 6e61 6d65 3d6e 616d 6529 2c0a  mat(name=name),.
+000249c0: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
+000249d0: 3230 202a 2036 302c 0a20 2020 2029 0a20  20 * 60,.    ). 
+000249e0: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+000249f0: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
+00024a00: 6d61 726b 2e73 6572 7665 0a40 7079 7465  mark.serve.@pyte
+00024a10: 7374 2e6d 6172 6b2e 6e6f 5f6b 7562 6572  st.mark.no_kuber
+00024a20: 6e65 7465 730a 6465 6620 7465 7374 5f73  netes.def test_s
+00024a30: 6b79 7365 7276 655f 6361 6e63 656c 2867  kyserve_cancel(g
+00024a40: 656e 6572 6963 5f63 6c6f 7564 3a20 7374  eneric_cloud: st
+00024a50: 7229 3a0a 2020 2020 2222 2254 6573 7420  r):.    """Test 
+00024a60: 736b 7973 6572 7665 2077 6974 6820 6361  skyserve with ca
+00024a70: 6e63 656c 2222 220a 2020 2020 6e61 6d65  ncel""".    name
+00024a80: 203d 205f 6765 745f 7365 7276 6963 655f   = _get_service_
+00024a90: 6e61 6d65 2829 0a0a 2020 2020 7465 7374  name()..    test
+00024aa0: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
+00024ab0: 2066 2774 6573 742d 736b 7973 6572 7665   f'test-skyserve
+00024ac0: 2d63 616e 6365 6c27 2c0a 2020 2020 2020  -cancel',.      
+00024ad0: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
+00024ae0: 6627 736b 7920 7365 7276 6520 7570 202d  f'sky serve up -
+00024af0: 6e20 7b6e 616d 657d 202d 2d63 6c6f 7564  n {name} --cloud
+00024b00: 207b 6765 6e65 7269 635f 636c 6f75 647d   {generic_cloud}
+00024b10: 202d 7920 7465 7374 732f 736b 7973 6572   -y tests/skyser
+00024b20: 7665 2f63 616e 6365 6c2f 6361 6e63 656c  ve/cancel/cancel
+00024b30: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
+00024b40: 2020 2020 5f53 4552 5645 5f57 4149 545f      _SERVE_WAIT_
+00024b50: 554e 5449 4c5f 5245 4144 592e 666f 726d  UNTIL_READY.form
+00024b60: 6174 286e 616d 653d 6e61 6d65 2c20 7265  at(name=name, re
+00024b70: 706c 6963 615f 6e75 6d3d 3129 2c0a 2020  plica_num=1),.  
+00024b80: 2020 2020 2020 2020 2020 6627 7b5f 5345            f'{_SE
+00024b90: 5256 455f 454e 4450 4f49 4e54 5f57 4149  RVE_ENDPOINT_WAI
+00024ba0: 542e 666f 726d 6174 286e 616d 653d 6e61  T.format(name=na
+00024bb0: 6d65 297d 3b20 7079 7468 6f6e 3320 270a  me)}; python3 '.
+00024bc0: 2020 2020 2020 2020 2020 2020 2774 6573              'tes
+00024bd0: 7473 2f73 6b79 7365 7276 652f 6361 6e63  ts/skyserve/canc
+00024be0: 656c 2f73 656e 645f 6361 6e63 656c 5f72  el/send_cancel_r
+00024bf0: 6571 7565 7374 2e70 7920 270a 2020 2020  equest.py '.    
+00024c00: 2020 2020 2020 2020 272d 2d65 6e64 706f          '--endpo
+00024c10: 696e 7420 2465 6e64 706f 696e 7420 7c20  int $endpoint | 
+00024c20: 6772 6570 2022 5265 7175 6573 7420 7761  grep "Request wa
+00024c30: 7320 6361 6e63 656c 6c65 6422 272c 0a20  s cancelled"',. 
+00024c40: 2020 2020 2020 2020 2020 2066 2773 3d24             f's=$
+00024c50: 2873 6b79 2073 6572 7665 206c 6f67 7320  (sky serve logs 
+00024c60: 7b6e 616d 657d 2031 202d 2d6e 6f2d 666f  {name} 1 --no-fo
+00024c70: 6c6c 6f77 293b 2027 0a20 2020 2020 2020  llow); '.       
+00024c80: 2020 2020 2027 756e 7469 6c20 2120 6563       'until ! ec
+00024c90: 686f 2022 2473 2220 7c20 6772 6570 2022  ho "$s" | grep "
+00024ca0: 506c 6561 7365 2077 6169 7420 666f 7220  Please wait for 
+00024cb0: 7468 6520 636f 6e74 726f 6c6c 6572 2074  the controller t
+00024cc0: 6f20 6265 223b 2027 0a20 2020 2020 2020  o be"; '.       
+00024cd0: 2020 2020 2027 646f 2065 6368 6f20 2257       'do echo "W
+00024ce0: 6169 7469 6e67 2066 6f72 2073 6572 7665  aiting for serve
+00024cf0: 206c 6f67 7322 3b20 736c 6565 7020 3130   logs"; sleep 10
+00024d00: 3b20 270a 2020 2020 2020 2020 2020 2020  ; '.            
+00024d10: 6627 733d 2428 736b 7920 7365 7276 6520  f's=$(sky serve 
+00024d20: 6c6f 6773 207b 6e61 6d65 7d20 3120 2d2d  logs {name} 1 --
+00024d30: 6e6f 2d66 6f6c 6c6f 7729 3b20 646f 6e65  no-follow); done
+00024d40: 3b20 270a 2020 2020 2020 2020 2020 2020  ; '.            
+00024d50: 2765 6368 6f20 2224 7322 3b20 6563 686f  'echo "$s"; echo
+00024d60: 2022 2473 2220 7c20 6772 6570 2022 436c   "$s" | grep "Cl
+00024d70: 6965 6e74 2064 6973 636f 6e6e 6563 7465  ient disconnecte
+00024d80: 642c 2073 746f 7070 696e 6720 636f 6d70  d, stopping comp
+00024d90: 7574 6174 696f 6e22 272c 0a20 2020 2020  utation"',.     
+00024da0: 2020 205d 2c0a 2020 2020 2020 2020 5f54     ],.        _T
+00024db0: 4541 5244 4f57 4e5f 5345 5256 4943 452e  EARDOWN_SERVICE.
+00024dc0: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
+00024dd0: 292c 0a20 2020 2020 2020 2074 696d 656f  ),.        timeo
+00024de0: 7574 3d32 3020 2a20 3630 2c0a 2020 2020  ut=20 * 60,.    
+00024df0: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
+00024e00: 7374 2874 6573 7429 0a0a 0a40 7079 7465  st(test)...@pyte
+00024e10: 7374 2e6d 6172 6b2e 7365 7276 650a 4070  st.mark.serve.@p
+00024e20: 7974 6573 742e 6d61 726b 2e6e 6f5f 6b75  ytest.mark.no_ku
+00024e30: 6265 726e 6574 6573 0a64 6566 2074 6573  bernetes.def tes
+00024e40: 745f 736b 7973 6572 7665 5f75 7064 6174  t_skyserve_updat
+00024e50: 6528 6765 6e65 7269 635f 636c 6f75 643a  e(generic_cloud:
+00024e60: 2073 7472 293a 0a20 2020 2022 2222 5465   str):.    """Te
+00024e70: 7374 2073 6b79 7365 7276 6520 7769 7468  st skyserve with
+00024e80: 2075 7064 6174 6522 2222 0a20 2020 206e   update""".    n
+00024e90: 616d 6520 3d20 5f67 6574 5f73 6572 7669  ame = _get_servi
+00024ea0: 6365 5f6e 616d 6528 290a 2020 2020 7465  ce_name().    te
+00024eb0: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+00024ec0: 2020 2066 2774 6573 742d 736b 7973 6572     f'test-skyser
+00024ed0: 7665 2d75 7064 6174 6527 2c0a 2020 2020  ve-update',.    
+00024ee0: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
+00024ef0: 2020 6627 736b 7920 7365 7276 6520 7570    f'sky serve up
+00024f00: 202d 6e20 7b6e 616d 657d 202d 2d63 6c6f   -n {name} --clo
+00024f10: 7564 207b 6765 6e65 7269 635f 636c 6f75  ud {generic_clou
+00024f20: 647d 202d 7920 7465 7374 732f 736b 7973  d} -y tests/skys
+00024f30: 6572 7665 2f75 7064 6174 652f 6f6c 642e  erve/update/old.
+00024f40: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+00024f50: 2020 205f 5345 5256 455f 5741 4954 5f55     _SERVE_WAIT_U
+00024f60: 4e54 494c 5f52 4541 4459 2e66 6f72 6d61  NTIL_READY.forma
+00024f70: 7428 6e61 6d65 3d6e 616d 652c 2072 6570  t(name=name, rep
+00024f80: 6c69 6361 5f6e 756d 3d32 292c 0a20 2020  lica_num=2),.   
+00024f90: 2020 2020 2020 2020 2066 277b 5f53 4552           f'{_SER
+00024fa0: 5645 5f45 4e44 504f 494e 545f 5741 4954  VE_ENDPOINT_WAIT
+00024fb0: 2e66 6f72 6d61 7428 6e61 6d65 3d6e 616d  .format(name=nam
+00024fc0: 6529 7d3b 2063 7572 6c20 2d4c 2068 7474  e)}; curl -L htt
+00024fd0: 703a 2f2f 2465 6e64 706f 696e 7420 7c20  p://$endpoint | 
+00024fe0: 6772 6570 2022 4869 2c20 536b 7950 696c  grep "Hi, SkyPil
+00024ff0: 6f74 2068 6572 6522 272c 0a20 2020 2020  ot here"',.     
+00025000: 2020 2020 2020 2066 2773 6b79 2073 6572         f'sky ser
+00025010: 7665 2075 7064 6174 6520 7b6e 616d 657d  ve update {name}
+00025020: 202d 2d63 6c6f 7564 207b 6765 6e65 7269   --cloud {generi
+00025030: 635f 636c 6f75 647d 202d 2d6d 6f64 6520  c_cloud} --mode 
+00025040: 626c 7565 5f67 7265 656e 202d 7920 7465  blue_green -y te
+00025050: 7374 732f 736b 7973 6572 7665 2f75 7064  sts/skyserve/upd
+00025060: 6174 652f 6e65 772e 7961 6d6c 272c 0a20  ate/new.yaml',. 
+00025070: 2020 2020 2020 2020 2020 2023 2073 6c65             # sle
+00025080: 6570 2062 6566 6f72 6520 7570 6461 7465  ep before update
+00025090: 2069 7320 7265 6769 7374 6572 6564 2e0a   is registered..
+000250a0: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
+000250b0: 6570 2032 3027 2c0a 2020 2020 2020 2020  ep 20',.        
+000250c0: 2020 2020 6627 7b5f 5345 5256 455f 454e      f'{_SERVE_EN
+000250d0: 4450 4f49 4e54 5f57 4149 542e 666f 726d  DPOINT_WAIT.form
+000250e0: 6174 286e 616d 653d 6e61 6d65 297d 3b20  at(name=name)}; 
+000250f0: 270a 2020 2020 2020 2020 2020 2020 2775  '.            'u
+00025100: 6e74 696c 2063 7572 6c20 2d4c 2068 7474  ntil curl -L htt
+00025110: 703a 2f2f 2465 6e64 706f 696e 7420 7c20  p://$endpoint | 
+00025120: 6772 6570 2022 4869 2c20 6e65 7720 536b  grep "Hi, new Sk
+00025130: 7950 696c 6f74 2068 6572 6521 223b 2064  yPilot here!"; d
+00025140: 6f20 736c 6565 7020 323b 2064 6f6e 653b  o sleep 2; done;
+00025150: 270a 2020 2020 2020 2020 2020 2020 2320  '.            # 
+00025160: 4d61 6b65 2073 7572 6520 7468 6520 7472  Make sure the tr
+00025170: 6166 6669 6320 6973 206e 6f74 206d 6978  affic is not mix
+00025180: 6564 0a20 2020 2020 2020 2020 2020 2027  ed.            '
+00025190: 6375 726c 202d 4c20 6874 7470 3a2f 2f24  curl -L http://$
+000251a0: 656e 6470 6f69 6e74 207c 2067 7265 7020  endpoint | grep 
+000251b0: 2248 692c 206e 6577 2053 6b79 5069 6c6f  "Hi, new SkyPilo
+000251c0: 7420 6865 7265 2227 2c0a 2020 2020 2020  t here"',.      
+000251d0: 2020 2020 2020 2320 5468 6520 6c61 7465        # The late
+000251e0: 7374 2032 2076 6572 7369 6f6e 2073 686f  st 2 version sho
+000251f0: 756c 6420 6265 2052 4541 4459 2061 6e64  uld be READY and
+00025200: 2074 6865 206f 6c64 6572 2076 6572 7369   the older versi
+00025210: 6f6e 7320 7368 6f75 6c64 2062 6520 7368  ons should be sh
+00025220: 7574 7469 6e67 2064 6f77 6e0a 2020 2020  utting down.    
+00025230: 2020 2020 2020 2020 285f 6368 6563 6b5f          (_check_
+00025240: 7265 706c 6963 615f 696e 5f73 7461 7475  replica_in_statu
+00025250: 7328 6e61 6d65 2c20 5b28 322c 2046 616c  s(name, [(2, Fal
+00025260: 7365 2c20 2752 4541 4459 2729 2c0a 2020  se, 'READY'),.  
+00025270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025290: 2020 2020 2020 2020 2020 2028 322c 2046             (2, F
+000252a0: 616c 7365 2c20 2753 4855 5454 494e 475f  alse, 'SHUTTING_
+000252b0: 444f 574e 2729 5d29 202b 0a20 2020 2020  DOWN')]) +.     
+000252c0: 2020 2020 2020 2020 5f63 6865 636b 5f73          _check_s
+000252d0: 6572 7669 6365 5f76 6572 7369 6f6e 286e  ervice_version(n
+000252e0: 616d 652c 2022 3222 2929 2c0a 2020 2020  ame, "2")),.    
+000252f0: 2020 2020 5d2c 0a20 2020 2020 2020 205f      ],.        _
+00025300: 5445 4152 444f 574e 5f53 4552 5649 4345  TEARDOWN_SERVICE
+00025310: 2e66 6f72 6d61 7428 6e61 6d65 3d6e 616d  .format(name=nam
+00025320: 6529 2c0a 2020 2020 2020 2020 7469 6d65  e),.        time
+00025330: 6f75 743d 3230 202a 2036 302c 0a20 2020  out=20 * 60,.   
+00025340: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
+00025350: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
+00025360: 6573 742e 6d61 726b 2e73 6572 7665 0a40  est.mark.serve.@
+00025370: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f6b  pytest.mark.no_k
+00025380: 7562 6572 6e65 7465 730a 6465 6620 7465  ubernetes.def te
+00025390: 7374 5f73 6b79 7365 7276 655f 726f 6c6c  st_skyserve_roll
+000253a0: 696e 675f 7570 6461 7465 2867 656e 6572  ing_update(gener
+000253b0: 6963 5f63 6c6f 7564 3a20 7374 7229 3a0a  ic_cloud: str):.
+000253c0: 2020 2020 2222 2254 6573 7420 736b 7973      """Test skys
+000253d0: 6572 7665 2077 6974 6820 726f 6c6c 696e  erve with rollin
+000253e0: 6720 7570 6461 7465 2222 220a 2020 2020  g update""".    
+000253f0: 6e61 6d65 203d 205f 6765 745f 7365 7276  name = _get_serv
+00025400: 6963 655f 6e61 6d65 2829 0a20 2020 2073  ice_name().    s
+00025410: 696e 676c 655f 6e65 775f 7265 706c 6963  ingle_new_replic
+00025420: 6120 3d20 5f63 6865 636b 5f72 6570 6c69  a = _check_repli
+00025430: 6361 5f69 6e5f 7374 6174 7573 280a 2020  ca_in_status(.  
+00025440: 2020 2020 2020 6e61 6d65 2c20 5b28 322c        name, [(2,
+00025450: 2046 616c 7365 2c20 2752 4541 4459 2729   False, 'READY')
+00025460: 2c20 2831 2c20 4661 6c73 652c 205f 5345  , (1, False, _SE
+00025470: 5256 4943 455f 4c41 554e 4348 494e 475f  RVICE_LAUNCHING_
+00025480: 5354 4154 5553 5f52 4547 4558 292c 0a20  STATUS_REGEX),. 
+00025490: 2020 2020 2020 2020 2020 2020 2020 2831                (1
+000254a0: 2c20 4661 6c73 652c 2027 5348 5554 5449  , False, 'SHUTTI
+000254b0: 4e47 5f44 4f57 4e27 295d 290a 2020 2020  NG_DOWN')]).    
+000254c0: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
+000254d0: 2020 2020 2066 2774 6573 742d 736b 7973       f'test-skys
+000254e0: 6572 7665 2d72 6f6c 6c69 6e67 2d75 7064  erve-rolling-upd
+000254f0: 6174 6527 2c0a 2020 2020 2020 2020 5b0a  ate',.        [.
+00025500: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00025510: 7920 7365 7276 6520 7570 202d 6e20 7b6e  y serve up -n {n
+00025520: 616d 657d 202d 2d63 6c6f 7564 207b 6765  ame} --cloud {ge
+00025530: 6e65 7269 635f 636c 6f75 647d 202d 7920  neric_cloud} -y 
+00025540: 7465 7374 732f 736b 7973 6572 7665 2f75  tests/skyserve/u
+00025550: 7064 6174 652f 6f6c 642e 7961 6d6c 272c  pdate/old.yaml',
+00025560: 0a20 2020 2020 2020 2020 2020 205f 5345  .            _SE
+00025570: 5256 455f 5741 4954 5f55 4e54 494c 5f52  RVE_WAIT_UNTIL_R
+00025580: 4541 4459 2e66 6f72 6d61 7428 6e61 6d65  EADY.format(name
+00025590: 3d6e 616d 652c 2072 6570 6c69 6361 5f6e  =name, replica_n
+000255a0: 756d 3d32 292c 0a20 2020 2020 2020 2020  um=2),.         
+000255b0: 2020 2066 277b 5f53 4552 5645 5f45 4e44     f'{_SERVE_END
+000255c0: 504f 494e 545f 5741 4954 2e66 6f72 6d61  POINT_WAIT.forma
+000255d0: 7428 6e61 6d65 3d6e 616d 6529 7d3b 2063  t(name=name)}; c
+000255e0: 7572 6c20 2d4c 2068 7474 703a 2f2f 2465  url -L http://$e
+000255f0: 6e64 706f 696e 7420 7c20 6772 6570 2022  ndpoint | grep "
+00025600: 4869 2c20 536b 7950 696c 6f74 2068 6572  Hi, SkyPilot her
+00025610: 6522 272c 0a20 2020 2020 2020 2020 2020  e"',.           
+00025620: 2066 2773 6b79 2073 6572 7665 2075 7064   f'sky serve upd
+00025630: 6174 6520 7b6e 616d 657d 202d 2d63 6c6f  ate {name} --clo
+00025640: 7564 207b 6765 6e65 7269 635f 636c 6f75  ud {generic_clou
+00025650: 647d 202d 7920 7465 7374 732f 736b 7973  d} -y tests/skys
+00025660: 6572 7665 2f75 7064 6174 652f 6e65 772e  erve/update/new.
+00025670: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+00025680: 2020 2023 204d 616b 6520 7375 7265 2074     # Make sure t
+00025690: 6865 2074 7261 6666 6963 2069 7320 6d69  he traffic is mi
+000256a0: 7865 6420 6163 726f 7373 2074 776f 2076  xed across two v
+000256b0: 6572 7369 6f6e 732c 2074 6865 2072 6570  ersions, the rep
+000256c0: 6c69 6361 730a 2020 2020 2020 2020 2020  licas.          
+000256d0: 2020 2320 7769 7468 2065 7665 6e20 6964    # with even id
+000256e0: 2077 696c 6c20 736c 6565 7020 3630 2073   will sleep 60 s
+000256f0: 6563 6f6e 6473 2062 6566 6f72 6520 6265  econds before be
+00025700: 696e 6720 7265 6164 792c 2073 6f20 7765  ing ready, so we
+00025710: 0a20 2020 2020 2020 2020 2020 2023 2073  .            # s
+00025720: 686f 756c 6420 6265 2061 626c 6520 746f  hould be able to
+00025730: 2067 6574 206f 6273 6572 7665 2074 6865   get observe the
+00025740: 2070 6572 696f 6420 7468 6174 2074 6865   period that the
+00025750: 2074 7261 6666 6963 2069 7320 6d69 7865   traffic is mixe
+00025760: 640a 2020 2020 2020 2020 2020 2020 2320  d.            # 
+00025770: 6163 726f 7373 2074 776f 2076 6572 7369  across two versi
+00025780: 6f6e 732e 0a20 2020 2020 2020 2020 2020  ons..           
+00025790: 2066 277b 5f53 4552 5645 5f45 4e44 504f   f'{_SERVE_ENDPO
+000257a0: 494e 545f 5741 4954 2e66 6f72 6d61 7428  INT_WAIT.format(
+000257b0: 6e61 6d65 3d6e 616d 6529 7d3b 2027 0a20  name=name)}; '. 
+000257c0: 2020 2020 2020 2020 2020 2027 756e 7469             'unti
+000257d0: 6c20 6375 726c 202d 4c20 6874 7470 3a2f  l curl -L http:/
+000257e0: 2f24 656e 6470 6f69 6e74 207c 2067 7265  /$endpoint | gre
+000257f0: 7020 2248 692c 206e 6577 2053 6b79 5069  p "Hi, new SkyPi
+00025800: 6c6f 7420 6865 7265 2122 3b20 646f 2073  lot here!"; do s
+00025810: 6c65 6570 2032 3b20 646f 6e65 3b20 736c  leep 2; done; sl
+00025820: 6565 7020 323b 2027 0a20 2020 2020 2020  eep 2; '.       
+00025830: 2020 2020 2023 2054 6865 206c 6174 6573       # The lates
+00025840: 7420 7665 7273 696f 6e20 7368 6f75 6c64  t version should
+00025850: 2068 6176 6520 6f6e 6520 5245 4144 5920   have one READY 
+00025860: 616e 6420 7468 6520 6f6e 6520 6f66 2074  and the one of t
+00025870: 6865 206f 6c64 6572 2076 6572 7369 6f6e  he older version
+00025880: 7320 7368 6f75 6c64 2062 6520 7368 7574  s should be shut
+00025890: 7469 6e67 2064 6f77 6e0a 2020 2020 2020  ting down.      
+000258a0: 2020 2020 2020 6627 7b73 696e 676c 655f        f'{single_
+000258b0: 6e65 775f 7265 706c 6963 617d 207b 5f63  new_replica} {_c
+000258c0: 6865 636b 5f73 6572 7669 6365 5f76 6572  heck_service_ver
+000258d0: 7369 6f6e 286e 616d 652c 2022 312c 3222  sion(name, "1,2"
+000258e0: 297d 2027 0a20 2020 2020 2020 2020 2020  )} '.           
+000258f0: 2023 2043 6865 636b 2074 6865 206f 7574   # Check the out
+00025900: 7075 7420 6672 6f6d 2074 6865 206f 6c64  put from the old
+00025910: 2076 6572 7369 6f6e 2c20 696d 6d65 6469   version, immedi
+00025920: 6174 656c 7920 6166 7465 7220 7468 650a  ately after the.
+00025930: 2020 2020 2020 2020 2020 2020 2320 6f75              # ou
+00025940: 7470 7574 2066 726f 6d20 7468 6520 6e65  tput from the ne
+00025950: 7720 7665 7273 696f 6e20 6170 7065 6172  w version appear
+00025960: 732e 2054 6869 7320 6973 2067 7561 7261  s. This is guara
+00025970: 6e74 6565 6420 6279 2074 6865 0a20 2020  nteed by the.   
+00025980: 2020 2020 2020 2020 2023 2072 6f75 6e64           # round
+00025990: 2072 6f62 696e 206c 6f61 6420 6261 6c61   robin load bala
+000259a0: 6e63 696e 6720 706f 6c69 6379 2e0a 2020  ncing policy..  
+000259b0: 2020 2020 2020 2020 2020 2320 544f 444f            # TODO
+000259c0: 287a 6877 7529 3a20 7765 2073 686f 756c  (zhwu): we shoul
+000259d0: 6420 6861 7665 2061 206d 6f72 6520 6765  d have a more ge
+000259e0: 6e65 7261 6c69 7a65 6420 7761 7920 666f  neralized way fo
+000259f0: 7220 6368 6563 6b69 6e67 2074 6865 0a20  r checking the. 
+00025a00: 2020 2020 2020 2020 2020 2023 206d 6978             # mix
+00025a10: 6564 2076 6572 7369 6f6e 206f 6620 7265  ed version of re
+00025a20: 706c 6963 6173 2074 6f20 6176 6f69 6420  plicas to avoid 
+00025a30: 6465 7065 6e64 696e 6720 6f6e 2074 6865  depending on the
+00025a40: 2073 7065 6369 6669 630a 2020 2020 2020   specific.      
+00025a50: 2020 2020 2020 2320 726f 756e 6420 726f        # round ro
+00025a60: 6269 6e20 6c6f 6164 2062 616c 616e 6369  bin load balanci
+00025a70: 6e67 2070 6f6c 6963 792e 0a20 2020 2020  ng policy..     
+00025a80: 2020 2020 2020 2027 6375 726c 202d 4c20         'curl -L 
+00025a90: 6874 7470 3a2f 2f24 656e 6470 6f69 6e74  http://$endpoint
+00025aa0: 207c 2067 7265 7020 2248 692c 2053 6b79   | grep "Hi, Sky
+00025ab0: 5069 6c6f 7420 6865 7265 2227 2c0a 2020  Pilot here"',.  
+00025ac0: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
+00025ad0: 205f 5445 4152 444f 574e 5f53 4552 5649   _TEARDOWN_SERVI
+00025ae0: 4345 2e66 6f72 6d61 7428 6e61 6d65 3d6e  CE.format(name=n
+00025af0: 616d 6529 2c0a 2020 2020 2020 2020 7469  ame),.        ti
+00025b00: 6d65 6f75 743d 3230 202a 2036 302c 0a20  meout=20 * 60,. 
+00025b10: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
+00025b20: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
+00025b30: 7974 6573 742e 6d61 726b 2e73 6572 7665  ytest.mark.serve
+00025b40: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
+00025b50: 5f6b 7562 6572 6e65 7465 730a 6465 6620  _kubernetes.def 
+00025b60: 7465 7374 5f73 6b79 7365 7276 655f 6661  test_skyserve_fa
+00025b70: 7374 5f75 7064 6174 6528 6765 6e65 7269  st_update(generi
+00025b80: 635f 636c 6f75 643a 2073 7472 293a 0a20  c_cloud: str):. 
+00025b90: 2020 2022 2222 5465 7374 2073 6b79 7365     """Test skyse
+00025ba0: 7276 6520 7769 7468 2066 6173 7420 7570  rve with fast up
+00025bb0: 6461 7465 2028 496e 6372 656d 656e 7420  date (Increment 
+00025bc0: 7665 7273 696f 6e20 6f66 206f 6c64 2072  version of old r
+00025bd0: 6570 6c69 6361 7329 2222 220a 2020 2020  eplicas)""".    
+00025be0: 6e61 6d65 203d 205f 6765 745f 7365 7276  name = _get_serv
+00025bf0: 6963 655f 6e61 6d65 2829 0a0a 2020 2020  ice_name()..    
+00025c00: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
+00025c10: 2020 2020 2066 2774 6573 742d 736b 7973       f'test-skys
+00025c20: 6572 7665 2d66 6173 742d 7570 6461 7465  erve-fast-update
+00025c30: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
+00025c40: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
+00025c50: 6572 7665 2075 7020 2d6e 207b 6e61 6d65  erve up -n {name
+00025c60: 7d20 2d79 202d 2d63 6c6f 7564 207b 6765  } -y --cloud {ge
+00025c70: 6e65 7269 635f 636c 6f75 647d 2074 6573  neric_cloud} tes
+00025c80: 7473 2f73 6b79 7365 7276 652f 7570 6461  ts/skyserve/upda
+00025c90: 7465 2f62 756d 705f 7665 7273 696f 6e5f  te/bump_version_
+00025ca0: 6265 666f 7265 2e79 616d 6c27 2c0a 2020  before.yaml',.  
+00025cb0: 2020 2020 2020 2020 2020 5f53 4552 5645            _SERVE
+00025cc0: 5f57 4149 545f 554e 5449 4c5f 5245 4144  _WAIT_UNTIL_READ
+00025cd0: 592e 666f 726d 6174 286e 616d 653d 6e61  Y.format(name=na
+00025ce0: 6d65 2c20 7265 706c 6963 615f 6e75 6d3d  me, replica_num=
+00025cf0: 3229 2c0a 2020 2020 2020 2020 2020 2020  2),.            
+00025d00: 6627 7b5f 5345 5256 455f 454e 4450 4f49  f'{_SERVE_ENDPOI
+00025d10: 4e54 5f57 4149 542e 666f 726d 6174 286e  NT_WAIT.format(n
+00025d20: 616d 653d 6e61 6d65 297d 3b20 6375 726c  ame=name)}; curl
+00025d30: 202d 4c20 6874 7470 3a2f 2f24 656e 6470   -L http://$endp
+00025d40: 6f69 6e74 207c 2067 7265 7020 2248 692c  oint | grep "Hi,
+00025d50: 2053 6b79 5069 6c6f 7420 6865 7265 2227   SkyPilot here"'
+00025d60: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00025d70: 736b 7920 7365 7276 6520 7570 6461 7465  sky serve update
+00025d80: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
+00025d90: 7b67 656e 6572 6963 5f63 6c6f 7564 7d20  {generic_cloud} 
+00025da0: 2d2d 6d6f 6465 2062 6c75 655f 6772 6565  --mode blue_gree
+00025db0: 6e20 2d79 2074 6573 7473 2f73 6b79 7365  n -y tests/skyse
+00025dc0: 7276 652f 7570 6461 7465 2f62 756d 705f  rve/update/bump_
+00025dd0: 7665 7273 696f 6e5f 6166 7465 722e 7961  version_after.ya
+00025de0: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
+00025df0: 2023 2073 6c65 6570 2074 6f20 7761 6974   # sleep to wait
+00025e00: 2066 6f72 2075 7064 6174 6520 746f 2062   for update to b
+00025e10: 6520 7265 6769 7374 6572 6564 2e0a 2020  e registered..  
+00025e20: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
+00025e30: 2031 3230 272c 0a20 2020 2020 2020 2020   120',.         
+00025e40: 2020 2023 2032 206f 6e2d 6465 616d 6e64     # 2 on-deamnd
+00025e50: 2028 7265 6164 7929 202b 2031 206f 6e2d   (ready) + 1 on-
+00025e60: 6465 6d61 6e64 2028 7072 6f76 6973 696f  demand (provisio
+00025e70: 6e69 6e67 292e 0a20 2020 2020 2020 2020  ning)..         
+00025e80: 2020 2028 0a20 2020 2020 2020 2020 2020     (.           
+00025e90: 2020 2020 205f 6368 6563 6b5f 7265 706c       _check_repl
+00025ea0: 6963 615f 696e 5f73 7461 7475 7328 0a20  ica_in_status(. 
+00025eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025ec0: 2020 206e 616d 652c 205b 2832 2c20 4661     name, [(2, Fa
+00025ed0: 6c73 652c 2027 5245 4144 5927 292c 0a20  lse, 'READY'),. 
+00025ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025ef0: 2020 2020 2020 2020 2020 2831 2c20 4661            (1, Fa
+00025f00: 6c73 652c 205f 5345 5256 4943 455f 4c41  lse, _SERVICE_LA
+00025f10: 554e 4348 494e 475f 5354 4154 5553 5f52  UNCHING_STATUS_R
+00025f20: 4547 4558 295d 2920 2b0a 2020 2020 2020  EGEX)]) +.      
+00025f30: 2020 2020 2020 2020 2020 2320 4661 7374            # Fast
+00025f40: 2075 7064 6174 6520 7769 6c6c 2064 6972   update will dir
+00025f50: 6563 746c 7920 6861 7665 2074 6865 206c  ectly have the l
+00025f60: 6174 6573 7420 7665 7273 696f 6e20 7265  atest version re
+00025f70: 6164 792e 0a20 2020 2020 2020 2020 2020  ady..           
+00025f80: 2020 2020 205f 6368 6563 6b5f 7365 7276       _check_serv
+00025f90: 6963 655f 7665 7273 696f 6e28 6e61 6d65  ice_version(name
+00025fa0: 2c20 2232 2229 292c 0a20 2020 2020 2020  , "2")),.       
+00025fb0: 2020 2020 205f 5345 5256 455f 5741 4954       _SERVE_WAIT
+00025fc0: 5f55 4e54 494c 5f52 4541 4459 2e66 6f72  _UNTIL_READY.for
+00025fd0: 6d61 7428 6e61 6d65 3d6e 616d 652c 2072  mat(name=name, r
+00025fe0: 6570 6c69 6361 5f6e 756d 3d33 2920 2b0a  eplica_num=3) +.
+00025ff0: 2020 2020 2020 2020 2020 2020 5f63 6865              _che
+00026000: 636b 5f73 6572 7669 6365 5f76 6572 7369  ck_service_versi
+00026010: 6f6e 286e 616d 652c 2022 3222 292c 0a20  on(name, "2"),. 
+00026020: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
+00026030: 4552 5645 5f45 4e44 504f 494e 545f 5741  ERVE_ENDPOINT_WA
+00026040: 4954 2e66 6f72 6d61 7428 6e61 6d65 3d6e  IT.format(name=n
+00026050: 616d 6529 7d3b 2063 7572 6c20 2d4c 2068  ame)}; curl -L h
+00026060: 7474 703a 2f2f 2465 6e64 706f 696e 7420  ttp://$endpoint 
+00026070: 7c20 6772 6570 2022 4869 2c20 536b 7950  | grep "Hi, SkyP
+00026080: 696c 6f74 2068 6572 6522 272c 0a20 2020  ilot here"',.   
+00026090: 2020 2020 2020 2020 2023 2054 6573 7420           # Test 
+000260a0: 726f 6c6c 696e 6720 7570 6461 7465 0a20  rolling update. 
+000260b0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+000260c0: 2073 6572 7665 2075 7064 6174 6520 7b6e   serve update {n
+000260d0: 616d 657d 202d 2d63 6c6f 7564 207b 6765  ame} --cloud {ge
+000260e0: 6e65 7269 635f 636c 6f75 647d 202d 7920  neric_cloud} -y 
+000260f0: 7465 7374 732f 736b 7973 6572 7665 2f75  tests/skyserve/u
+00026100: 7064 6174 652f 6275 6d70 5f76 6572 7369  pdate/bump_versi
+00026110: 6f6e 5f62 6566 6f72 652e 7961 6d6c 272c  on_before.yaml',
+00026120: 0a20 2020 2020 2020 2020 2020 2023 2073  .            # s
+00026130: 6c65 6570 2074 6f20 7761 6974 2066 6f72  leep to wait for
+00026140: 2075 7064 6174 6520 746f 2062 6520 7265   update to be re
+00026150: 6769 7374 6572 6564 2e0a 2020 2020 2020  gistered..      
+00026160: 2020 2020 2020 2773 6c65 6570 2033 3027        'sleep 30'
+00026170: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
+00026180: 3220 6f6e 2d64 6561 6d6e 6420 2872 6561  2 on-deamnd (rea
+00026190: 6479 2920 2b20 3120 6f6e 2d64 656d 616e  dy) + 1 on-deman
+000261a0: 6420 2873 6875 7474 696e 6720 646f 776e  d (shutting down
+000261b0: 292e 0a20 2020 2020 2020 2020 2020 205f  )..            _
+000261c0: 6368 6563 6b5f 7265 706c 6963 615f 696e  check_replica_in
+000261d0: 5f73 7461 7475 7328 6e61 6d65 2c20 5b28  _status(name, [(
+000261e0: 322c 2046 616c 7365 2c20 2752 4541 4459  2, False, 'READY
+000261f0: 2729 2c0a 2020 2020 2020 2020 2020 2020  '),.            
+00026200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026220: 2831 2c20 4661 6c73 652c 2027 5348 5554  (1, False, 'SHUT
+00026230: 5449 4e47 5f44 4f57 4e27 295d 292c 0a20  TING_DOWN')]),. 
+00026240: 2020 2020 2020 2020 2020 205f 5345 5256             _SERV
+00026250: 455f 5741 4954 5f55 4e54 494c 5f52 4541  E_WAIT_UNTIL_REA
+00026260: 4459 2e66 6f72 6d61 7428 6e61 6d65 3d6e  DY.format(name=n
+00026270: 616d 652c 2072 6570 6c69 6361 5f6e 756d  ame, replica_num
+00026280: 3d32 2920 2b0a 2020 2020 2020 2020 2020  =2) +.          
+00026290: 2020 5f63 6865 636b 5f73 6572 7669 6365    _check_service
+000262a0: 5f76 6572 7369 6f6e 286e 616d 652c 2022  _version(name, "
+000262b0: 3322 292c 0a20 2020 2020 2020 2020 2020  3"),.           
+000262c0: 2066 277b 5f53 4552 5645 5f45 4e44 504f   f'{_SERVE_ENDPO
+000262d0: 494e 545f 5741 4954 2e66 6f72 6d61 7428  INT_WAIT.format(
+000262e0: 6e61 6d65 3d6e 616d 6529 7d3b 2063 7572  name=name)}; cur
+000262f0: 6c20 2d4c 2068 7474 703a 2f2f 2465 6e64  l -L http://$end
+00026300: 706f 696e 7420 7c20 6772 6570 2022 4869  point | grep "Hi
+00026310: 2c20 536b 7950 696c 6f74 2068 6572 6522  , SkyPilot here"
+00026320: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
+00026330: 2020 2020 2020 5f54 4541 5244 4f57 4e5f        _TEARDOWN_
+00026340: 5345 5256 4943 452e 666f 726d 6174 286e  SERVICE.format(n
+00026350: 616d 653d 6e61 6d65 292c 0a20 2020 2020  ame=name),.     
+00026360: 2020 2074 696d 656f 7574 3d33 3020 2a20     timeout=30 * 
+00026370: 3630 2c0a 2020 2020 290a 2020 2020 7275  60,.    ).    ru
+00026380: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
+00026390: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
+000263a0: 7365 7276 650a 4070 7974 6573 742e 6d61  serve.@pytest.ma
+000263b0: 726b 2e6e 6f5f 6b75 6265 726e 6574 6573  rk.no_kubernetes
+000263c0: 0a64 6566 2074 6573 745f 736b 7973 6572  .def test_skyser
+000263d0: 7665 5f75 7064 6174 655f 6175 746f 7363  ve_update_autosc
+000263e0: 616c 6528 6765 6e65 7269 635f 636c 6f75  ale(generic_clou
+000263f0: 643a 2073 7472 293a 0a20 2020 2022 2222  d: str):.    """
+00026400: 5465 7374 2073 6b79 7365 7276 6520 7570  Test skyserve up
+00026410: 6461 7465 2077 6974 6820 6175 746f 7363  date with autosc
+00026420: 616c 6522 2222 0a20 2020 206e 616d 6520  ale""".    name 
+00026430: 3d20 5f67 6574 5f73 6572 7669 6365 5f6e  = _get_service_n
+00026440: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
+00026450: 2054 6573 7428 0a20 2020 2020 2020 2066   Test(.        f
+00026460: 2774 6573 742d 736b 7973 6572 7665 2d75  'test-skyserve-u
+00026470: 7064 6174 652d 6175 746f 7363 616c 6527  pdate-autoscale'
+00026480: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
+00026490: 2020 2020 2020 2020 6627 736b 7920 7365          f'sky se
+000264a0: 7276 6520 7570 202d 6e20 7b6e 616d 657d  rve up -n {name}
+000264b0: 202d 2d63 6c6f 7564 207b 6765 6e65 7269   --cloud {generi
+000264c0: 635f 636c 6f75 647d 202d 7920 7465 7374  c_cloud} -y test
+000264d0: 732f 736b 7973 6572 7665 2f75 7064 6174  s/skyserve/updat
+000264e0: 652f 6e75 6d5f 6d69 6e5f 7477 6f2e 7961  e/num_min_two.ya
+000264f0: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
+00026500: 205f 5345 5256 455f 5741 4954 5f55 4e54   _SERVE_WAIT_UNT
+00026510: 494c 5f52 4541 4459 2e66 6f72 6d61 7428  IL_READY.format(
+00026520: 6e61 6d65 3d6e 616d 652c 2072 6570 6c69  name=name, repli
+00026530: 6361 5f6e 756d 3d32 2920 2b0a 2020 2020  ca_num=2) +.    
+00026540: 2020 2020 2020 2020 5f63 6865 636b 5f73          _check_s
+00026550: 6572 7669 6365 5f76 6572 7369 6f6e 286e  ervice_version(n
+00026560: 616d 652c 2022 3122 292c 0a20 2020 2020  ame, "1"),.     
+00026570: 2020 2020 2020 2066 277b 5f53 4552 5645         f'{_SERVE
+00026580: 5f45 4e44 504f 494e 545f 5741 4954 2e66  _ENDPOINT_WAIT.f
+00026590: 6f72 6d61 7428 6e61 6d65 3d6e 616d 6529  ormat(name=name)
+000265a0: 7d3b 2027 0a20 2020 2020 2020 2020 2020  }; '.           
+000265b0: 2027 6375 726c 202d 4c20 6874 7470 3a2f   'curl -L http:/
+000265c0: 2f24 656e 6470 6f69 6e74 207c 2067 7265  /$endpoint | gre
+000265d0: 7020 2248 692c 2053 6b79 5069 6c6f 7420  p "Hi, SkyPilot 
+000265e0: 6865 7265 2227 2c0a 2020 2020 2020 2020  here"',.        
+000265f0: 2020 2020 6627 736b 7920 7365 7276 6520      f'sky serve 
+00026600: 7570 6461 7465 207b 6e61 6d65 7d20 2d2d  update {name} --
+00026610: 636c 6f75 6420 7b67 656e 6572 6963 5f63  cloud {generic_c
+00026620: 6c6f 7564 7d20 2d2d 6d6f 6465 2062 6c75  loud} --mode blu
+00026630: 655f 6772 6565 6e20 2d79 2074 6573 7473  e_green -y tests
+00026640: 2f73 6b79 7365 7276 652f 7570 6461 7465  /skyserve/update
+00026650: 2f6e 756d 5f6d 696e 5f6f 6e65 2e79 616d  /num_min_one.yam
+00026660: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+00026670: 2320 736c 6565 7020 6265 666f 7265 2075  # sleep before u
+00026680: 7064 6174 6520 6973 2072 6567 6973 7465  pdate is registe
+00026690: 7265 642e 0a20 2020 2020 2020 2020 2020  red..           
+000266a0: 2027 736c 6565 7020 3230 272c 0a20 2020   'sleep 20',.   
+000266b0: 2020 2020 2020 2020 2023 2054 696d 656f           # Timeo
+000266c0: 7574 2077 696c 6c20 6265 2074 7269 6767  ut will be trigg
+000266d0: 6572 6564 2077 6865 6e20 7570 6461 7465  ered when update
+000266e0: 2066 6169 6c73 2e0a 2020 2020 2020 2020   fails..        
+000266f0: 2020 2020 5f53 4552 5645 5f57 4149 545f      _SERVE_WAIT_
+00026700: 554e 5449 4c5f 5245 4144 592e 666f 726d  UNTIL_READY.form
+00026710: 6174 286e 616d 653d 6e61 6d65 2c20 7265  at(name=name, re
+00026720: 706c 6963 615f 6e75 6d3d 3129 202b 0a20  plica_num=1) +. 
+00026730: 2020 2020 2020 2020 2020 205f 6368 6563             _chec
+00026740: 6b5f 7365 7276 6963 655f 7665 7273 696f  k_service_versio
+00026750: 6e28 6e61 6d65 2c20 2232 2229 2c0a 2020  n(name, "2"),.  
+00026760: 2020 2020 2020 2020 2020 6627 7b5f 5345            f'{_SE
+00026770: 5256 455f 454e 4450 4f49 4e54 5f57 4149  RVE_ENDPOINT_WAI
+00026780: 542e 666f 726d 6174 286e 616d 653d 6e61  T.format(name=na
+00026790: 6d65 297d 3b20 270a 2020 2020 2020 2020  me)}; '.        
+000267a0: 2020 2020 2763 7572 6c20 2d4c 2068 7474      'curl -L htt
+000267b0: 703a 2f2f 2465 6e64 706f 696e 7420 7c20  p://$endpoint | 
+000267c0: 6772 6570 2022 4869 2c20 536b 7950 696c  grep "Hi, SkyPil
+000267d0: 6f74 2068 6572 6521 2227 2c0a 2020 2020  ot here!"',.    
+000267e0: 2020 2020 2020 2020 2320 526f 6c6c 696e          # Rollin
+000267f0: 6720 5570 6461 7465 0a20 2020 2020 2020  g Update.       
+00026800: 2020 2020 2066 2773 6b79 2073 6572 7665       f'sky serve
+00026810: 2075 7064 6174 6520 7b6e 616d 657d 202d   update {name} -
+00026820: 2d63 6c6f 7564 207b 6765 6e65 7269 635f  -cloud {generic_
+00026830: 636c 6f75 647d 202d 7920 7465 7374 732f  cloud} -y tests/
+00026840: 736b 7973 6572 7665 2f75 7064 6174 652f  skyserve/update/
+00026850: 6e75 6d5f 6d69 6e5f 7477 6f2e 7961 6d6c  num_min_two.yaml
+00026860: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
+00026870: 2073 6c65 6570 2062 6566 6f72 6520 7570   sleep before up
+00026880: 6461 7465 2069 7320 7265 6769 7374 6572  date is register
+00026890: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
+000268a0: 2773 6c65 6570 2032 3027 2c0a 2020 2020  'sleep 20',.    
+000268b0: 2020 2020 2020 2020 2320 5469 6d65 6f75          # Timeou
+000268c0: 7420 7769 6c6c 2062 6520 7472 6967 6765  t will be trigge
+000268d0: 7265 6420 7768 656e 2075 7064 6174 6520  red when update 
+000268e0: 6661 696c 732e 0a20 2020 2020 2020 2020  fails..         
+000268f0: 2020 205f 5345 5256 455f 5741 4954 5f55     _SERVE_WAIT_U
+00026900: 4e54 494c 5f52 4541 4459 2e66 6f72 6d61  NTIL_READY.forma
+00026910: 7428 6e61 6d65 3d6e 616d 652c 2072 6570  t(name=name, rep
+00026920: 6c69 6361 5f6e 756d 3d32 2920 2b0a 2020  lica_num=2) +.  
+00026930: 2020 2020 2020 2020 2020 5f63 6865 636b            _check
+00026940: 5f73 6572 7669 6365 5f76 6572 7369 6f6e  _service_version
+00026950: 286e 616d 652c 2022 3322 292c 0a20 2020  (name, "3"),.   
+00026960: 2020 2020 2020 2020 2066 277b 5f53 4552           f'{_SER
+00026970: 5645 5f45 4e44 504f 494e 545f 5741 4954  VE_ENDPOINT_WAIT
+00026980: 2e66 6f72 6d61 7428 6e61 6d65 3d6e 616d  .format(name=nam
+00026990: 6529 7d3b 2027 0a20 2020 2020 2020 2020  e)}; '.         
+000269a0: 2020 2027 6375 726c 202d 4c20 6874 7470     'curl -L http
+000269b0: 3a2f 2f24 656e 6470 6f69 6e74 207c 2067  ://$endpoint | g
+000269c0: 7265 7020 2248 692c 2053 6b79 5069 6c6f  rep "Hi, SkyPilo
+000269d0: 7420 6865 7265 2122 272c 0a20 2020 2020  t here!"',.     
+000269e0: 2020 205d 2c0a 2020 2020 2020 2020 5f54     ],.        _T
+000269f0: 4541 5244 4f57 4e5f 5345 5256 4943 452e  EARDOWN_SERVICE.
+00026a00: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
+00026a10: 292c 0a20 2020 2020 2020 2074 696d 656f  ),.        timeo
+00026a20: 7574 3d33 3020 2a20 3630 2c0a 2020 2020  ut=30 * 60,.    
+00026a30: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
+00026a40: 7374 2874 6573 7429 0a0a 0a40 7079 7465  st(test)...@pyte
+00026a50: 7374 2e6d 6172 6b2e 7365 7276 650a 4070  st.mark.serve.@p
+00026a60: 7974 6573 742e 6d61 726b 2e70 6172 616d  ytest.mark.param
+00026a70: 6574 7269 7a65 2827 6d6f 6465 272c 205b  etrize('mode', [
+00026a80: 2772 6f6c 6c69 6e67 272c 2027 626c 7565  'rolling', 'blue
+00026a90: 5f67 7265 656e 275d 290a 4070 7974 6573  _green']).@pytes
+00026aa0: 742e 6d61 726b 2e6e 6f5f 6b75 6265 726e  t.mark.no_kubern
+00026ab0: 6574 6573 0a64 6566 2074 6573 745f 736b  etes.def test_sk
+00026ac0: 7973 6572 7665 5f6e 6577 5f61 7574 6f73  yserve_new_autos
+00026ad0: 6361 6c65 725f 7570 6461 7465 286d 6f64  caler_update(mod
+00026ae0: 653a 2073 7472 2c20 6765 6e65 7269 635f  e: str, generic_
+00026af0: 636c 6f75 643a 2073 7472 293a 0a20 2020  cloud: str):.   
+00026b00: 2022 2222 5465 7374 2073 6b79 7365 7276   """Test skyserv
+00026b10: 6520 7769 7468 2075 7064 6174 6520 7468  e with update th
+00026b20: 6174 2063 6861 6e67 6573 2061 7574 6f73  at changes autos
+00026b30: 6361 6c65 7222 2222 0a20 2020 206e 616d  caler""".    nam
+00026b40: 6520 3d20 5f67 6574 5f73 6572 7669 6365  e = _get_service
+00026b50: 5f6e 616d 6528 2920 2b20 6d6f 6465 0a0a  _name() + mode..
+00026b60: 2020 2020 666f 7572 5f73 706f 745f 7570      four_spot_up
+00026b70: 5f63 6d64 203d 205f 6368 6563 6b5f 7265  _cmd = _check_re
+00026b80: 706c 6963 615f 696e 5f73 7461 7475 7328  plica_in_status(
+00026b90: 6e61 6d65 2c20 5b28 342c 2054 7275 652c  name, [(4, True,
+00026ba0: 2027 5245 4144 5927 295d 290a 2020 2020   'READY')]).    
+00026bb0: 7570 6461 7465 5f63 6865 636b 203d 205b  update_check = [
+00026bc0: 6627 756e 7469 6c20 287b 666f 7572 5f73  f'until ({four_s
+00026bd0: 706f 745f 7570 5f63 6d64 7d29 3b20 646f  pot_up_cmd}); do
+00026be0: 2073 6c65 6570 2035 3b20 646f 6e65 3b20   sleep 5; done; 
+00026bf0: 736c 6565 7020 3130 3b27 5d0a 2020 2020  sleep 10;'].    
+00026c00: 6966 206d 6f64 6520 3d3d 2027 726f 6c6c  if mode == 'roll
+00026c10: 696e 6727 3a0a 2020 2020 2020 2020 2320  ing':.        # 
+00026c20: 4368 6563 6b20 726f 6c6c 696e 6720 7570  Check rolling up
+00026c30: 6461 7465 2c20 6974 2077 696c 6c20 7465  date, it will te
+00026c40: 726d 696e 6174 6520 6f6e 6520 6f66 2074  rminate one of t
+00026c50: 6865 206f 6c64 206f 6e2d 6465 6d61 6e64  he old on-demand
+00026c60: 0a20 2020 2020 2020 2023 2069 6e73 7461  .        # insta
+00026c70: 6e63 6573 2c20 6f6e 6365 2074 6865 7265  nces, once there
+00026c80: 2061 7265 2034 2073 706f 7420 696e 7374   are 4 spot inst
+00026c90: 616e 6365 2072 6561 6479 2e0a 2020 2020  ance ready..    
+00026ca0: 2020 2020 7570 6461 7465 5f63 6865 636b      update_check
+00026cb0: 202b 3d20 5b0a 2020 2020 2020 2020 2020   += [.          
+00026cc0: 2020 5f63 6865 636b 5f72 6570 6c69 6361    _check_replica
+00026cd0: 5f69 6e5f 7374 6174 7573 280a 2020 2020  _in_status(.    
+00026ce0: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
+00026cf0: 2c20 5b28 312c 2046 616c 7365 2c20 5f53  , [(1, False, _S
+00026d00: 4552 5649 4345 5f4c 4155 4e43 4849 4e47  ERVICE_LAUNCHING
+00026d10: 5f53 5441 5455 535f 5245 4745 5829 2c0a  _STATUS_REGEX),.
+00026d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026d30: 2020 2020 2020 2028 312c 2046 616c 7365         (1, False
+00026d40: 2c20 2753 4855 5454 494e 475f 444f 574e  , 'SHUTTING_DOWN
+00026d50: 2729 2c20 2831 2c20 4661 6c73 652c 2027  '), (1, False, '
+00026d60: 5245 4144 5927 295d 2920 2b0a 2020 2020  READY')]) +.    
+00026d70: 2020 2020 2020 2020 5f63 6865 636b 5f73          _check_s
+00026d80: 6572 7669 6365 5f76 6572 7369 6f6e 286e  ervice_version(n
+00026d90: 616d 652c 2022 312c 3222 292c 0a20 2020  ame, "1,2"),.   
+00026da0: 2020 2020 205d 0a20 2020 2065 6c73 653a       ].    else:
+00026db0: 0a20 2020 2020 2020 2023 2043 6865 636b  .        # Check
+00026dc0: 2062 6c75 6520 6772 6565 6e20 7570 6461   blue green upda
+00026dd0: 7465 2c20 6974 2077 696c 6c20 6b65 6570  te, it will keep
+00026de0: 2062 6f74 6820 6f6c 6420 6f6e 2d64 656d   both old on-dem
+00026df0: 616e 6420 696e 7374 616e 6365 730a 2020  and instances.  
+00026e00: 2020 2020 2020 2320 7275 6e6e 696e 672c        # running,
+00026e10: 206f 6e63 6520 7468 6572 6520 6172 6520   once there are 
+00026e20: 3420 7370 6f74 2069 6e73 7461 6e63 6520  4 spot instance 
+00026e30: 7265 6164 792e 0a20 2020 2020 2020 2075  ready..        u
+00026e40: 7064 6174 655f 6368 6563 6b20 2b3d 205b  pdate_check += [
+00026e50: 0a20 2020 2020 2020 2020 2020 205f 6368  .            _ch
+00026e60: 6563 6b5f 7265 706c 6963 615f 696e 5f73  eck_replica_in_s
+00026e70: 7461 7475 7328 0a20 2020 2020 2020 2020  tatus(.         
+00026e80: 2020 2020 2020 206e 616d 652c 205b 2831         name, [(1
+00026e90: 2c20 4661 6c73 652c 205f 5345 5256 4943  , False, _SERVIC
+00026ea0: 455f 4c41 554e 4348 494e 475f 5354 4154  E_LAUNCHING_STAT
+00026eb0: 5553 5f52 4547 4558 292c 0a20 2020 2020  US_REGEX),.     
+00026ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026ed0: 2020 2832 2c20 4661 6c73 652c 2027 5245    (2, False, 'RE
+00026ee0: 4144 5927 295d 2920 2b0a 2020 2020 2020  ADY')]) +.      
+00026ef0: 2020 2020 2020 5f63 6865 636b 5f73 6572        _check_ser
+00026f00: 7669 6365 5f76 6572 7369 6f6e 286e 616d  vice_version(nam
+00026f10: 652c 2022 3122 292c 0a20 2020 2020 2020  e, "1"),.       
+00026f20: 205d 0a20 2020 2074 6573 7420 3d20 5465   ].    test = Te
+00026f30: 7374 280a 2020 2020 2020 2020 2774 6573  st(.        'tes
+00026f40: 742d 736b 7973 6572 7665 2d6e 6577 2d61  t-skyserve-new-a
+00026f50: 7574 6f73 6361 6c65 722d 7570 6461 7465  utoscaler-update
+00026f60: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
+00026f70: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
+00026f80: 6572 7665 2075 7020 2d6e 207b 6e61 6d65  erve up -n {name
+00026f90: 7d20 2d2d 636c 6f75 6420 7b67 656e 6572  } --cloud {gener
+00026fa0: 6963 5f63 6c6f 7564 7d20 2d79 2074 6573  ic_cloud} -y tes
+00026fb0: 7473 2f73 6b79 7365 7276 652f 7570 6461  ts/skyserve/upda
+00026fc0: 7465 2f6e 6577 5f61 7574 6f73 6361 6c65  te/new_autoscale
+00026fd0: 725f 6265 666f 7265 2e79 616d 6c27 2c0a  r_before.yaml',.
+00026fe0: 2020 2020 2020 2020 2020 2020 5f53 4552              _SER
+00026ff0: 5645 5f57 4149 545f 554e 5449 4c5f 5245  VE_WAIT_UNTIL_RE
+00027000: 4144 592e 666f 726d 6174 286e 616d 653d  ADY.format(name=
+00027010: 6e61 6d65 2c20 7265 706c 6963 615f 6e75  name, replica_nu
+00027020: 6d3d 3229 202b 0a20 2020 2020 2020 2020  m=2) +.         
+00027030: 2020 205f 6368 6563 6b5f 7365 7276 6963     _check_servic
+00027040: 655f 7665 7273 696f 6e28 6e61 6d65 2c20  e_version(name, 
+00027050: 2231 2229 2c0a 2020 2020 2020 2020 2020  "1"),.          
+00027060: 2020 6627 7b5f 5345 5256 455f 454e 4450    f'{_SERVE_ENDP
+00027070: 4f49 4e54 5f57 4149 542e 666f 726d 6174  OINT_WAIT.format
+00027080: 286e 616d 653d 6e61 6d65 297d 3b20 270a  (name=name)}; '.
+00027090: 2020 2020 2020 2020 2020 2020 2773 3d24              's=$
+000270a0: 2863 7572 6c20 2d4c 2068 7474 703a 2f2f  (curl -L http://
+000270b0: 2465 6e64 706f 696e 7429 3b20 6563 686f  $endpoint); echo
+000270c0: 2022 2473 223b 2065 6368 6f20 2224 7322   "$s"; echo "$s"
+000270d0: 207c 2067 7265 7020 2248 692c 2053 6b79   | grep "Hi, Sky
+000270e0: 5069 6c6f 7420 6865 7265 2227 2c0a 2020  Pilot here"',.  
+000270f0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00027100: 7365 7276 6520 7570 6461 7465 207b 6e61  serve update {na
+00027110: 6d65 7d20 2d2d 636c 6f75 6420 7b67 656e  me} --cloud {gen
+00027120: 6572 6963 5f63 6c6f 7564 7d20 2d2d 6d6f  eric_cloud} --mo
+00027130: 6465 207b 6d6f 6465 7d20 2d79 2074 6573  de {mode} -y tes
+00027140: 7473 2f73 6b79 7365 7276 652f 7570 6461  ts/skyserve/upda
+00027150: 7465 2f6e 6577 5f61 7574 6f73 6361 6c65  te/new_autoscale
+00027160: 725f 6166 7465 722e 7961 6d6c 272c 0a20  r_after.yaml',. 
+00027170: 2020 2020 2020 2020 2020 2023 2057 6169             # Wai
+00027180: 7420 666f 7220 7570 6461 7465 2074 6f20  t for update to 
+00027190: 6265 2072 6567 6973 7465 7265 640a 2020  be registered.  
+000271a0: 2020 2020 2020 2020 2020 6627 736c 6565            f'slee
+000271b0: 7020 3132 3027 2c0a 2020 2020 2020 2020  p 120',.        
+000271c0: 2020 2020 5f63 6865 636b 5f72 6570 6c69      _check_repli
+000271d0: 6361 5f69 6e5f 7374 6174 7573 280a 2020  ca_in_status(.  
+000271e0: 2020 2020 2020 2020 2020 2020 2020 6e61                na
+000271f0: 6d65 2c20 5b28 342c 2054 7275 652c 205f  me, [(4, True, _
+00027200: 5345 5256 4943 455f 4c41 554e 4348 494e  SERVICE_LAUNCHIN
+00027210: 475f 5354 4154 5553 5f52 4547 4558 202b  G_STATUS_REGEX +
+00027220: 2027 5c7c 5245 4144 5927 292c 0a20 2020   '\|READY'),.   
+00027230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027240: 2020 2020 2831 2c20 4661 6c73 652c 205f      (1, False, _
+00027250: 5345 5256 4943 455f 4c41 554e 4348 494e  SERVICE_LAUNCHIN
+00027260: 475f 5354 4154 5553 5f52 4547 4558 292c  G_STATUS_REGEX),
+00027270: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00027280: 2020 2020 2020 2020 2832 2c20 4661 6c73          (2, Fals
+00027290: 652c 2027 5245 4144 5927 295d 292c 0a20  e, 'READY')]),. 
+000272a0: 2020 2020 2020 2020 2020 202a 7570 6461             *upda
+000272b0: 7465 5f63 6865 636b 2c0a 2020 2020 2020  te_check,.      
+000272c0: 2020 2020 2020 5f53 4552 5645 5f57 4149        _SERVE_WAI
+000272d0: 545f 554e 5449 4c5f 5245 4144 592e 666f  T_UNTIL_READY.fo
+000272e0: 726d 6174 286e 616d 653d 6e61 6d65 2c20  rmat(name=name, 
+000272f0: 7265 706c 6963 615f 6e75 6d3d 3529 2c0a  replica_num=5),.
+00027300: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
+00027310: 5345 5256 455f 454e 4450 4f49 4e54 5f57  SERVE_ENDPOINT_W
+00027320: 4149 542e 666f 726d 6174 286e 616d 653d  AIT.format(name=
+00027330: 6e61 6d65 297d 3b20 270a 2020 2020 2020  name)}; '.      
+00027340: 2020 2020 2020 2763 7572 6c20 2d4c 2068        'curl -L h
+00027350: 7474 703a 2f2f 2465 6e64 706f 696e 7420  ttp://$endpoint 
+00027360: 7c20 6772 6570 2022 4869 2c20 536b 7950  | grep "Hi, SkyP
+00027370: 696c 6f74 2068 6572 6522 272c 0a20 2020  ilot here"',.   
+00027380: 2020 2020 2020 2020 205f 6368 6563 6b5f           _check_
+00027390: 7265 706c 6963 615f 696e 5f73 7461 7475  replica_in_statu
+000273a0: 7328 6e61 6d65 2c20 5b28 342c 2054 7275  s(name, [(4, Tru
+000273b0: 652c 2027 5245 4144 5927 292c 0a20 2020  e, 'READY'),.   
+000273c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000273d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000273e0: 2020 2020 2020 2020 2028 312c 2046 616c           (1, Fal
+000273f0: 7365 2c20 2752 4541 4459 2729 5d29 2c0a  se, 'READY')]),.
+00027400: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
+00027410: 2020 205f 5445 4152 444f 574e 5f53 4552     _TEARDOWN_SER
+00027420: 5649 4345 2e66 6f72 6d61 7428 6e61 6d65  VICE.format(name
+00027430: 3d6e 616d 6529 2c0a 2020 2020 2020 2020  =name),.        
+00027440: 7469 6d65 6f75 743d 3230 202a 2036 302c  timeout=20 * 60,
+00027450: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+00027460: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+00027470: 4070 7974 6573 742e 6d61 726b 2e73 6572  @pytest.mark.ser
+00027480: 7665 0a64 6566 2074 6573 745f 736b 7973  ve.def test_skys
+00027490: 6572 7665 5f66 6169 6c75 7265 7328 6765  erve_failures(ge
+000274a0: 6e65 7269 635f 636c 6f75 643a 2073 7472  neric_cloud: str
+000274b0: 293a 0a20 2020 2022 2222 5465 7374 2072  ):.    """Test r
+000274c0: 6570 6c69 6361 2066 6169 6c75 7265 2073  eplica failure s
+000274d0: 7461 7475 7365 7322 2222 0a20 2020 206e  tatuses""".    n
+000274e0: 616d 6520 3d20 5f67 6574 5f73 6572 7669  ame = _get_servi
+000274f0: 6365 5f6e 616d 6528 290a 0a20 2020 2074  ce_name()..    t
+00027500: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+00027510: 2020 2020 2774 6573 742d 736b 7973 6572      'test-skyser
+00027520: 7665 2d66 6169 6c75 7265 7327 2c0a 2020  ve-failures',.  
+00027530: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+00027540: 2020 2020 6627 736b 7920 7365 7276 6520      f'sky serve 
+00027550: 7570 202d 6e20 7b6e 616d 657d 202d 2d63  up -n {name} --c
+00027560: 6c6f 7564 207b 6765 6e65 7269 635f 636c  loud {generic_cl
+00027570: 6f75 647d 202d 7920 7465 7374 732f 736b  oud} -y tests/sk
+00027580: 7973 6572 7665 2f66 6169 6c75 7265 732f  yserve/failures/
+00027590: 696e 6974 6961 6c5f 6465 6c61 792e 7961  initial_delay.ya
+000275a0: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
+000275b0: 2066 2773 3d24 2873 6b79 2073 6572 7665   f's=$(sky serve
+000275c0: 2073 7461 7475 7320 7b6e 616d 657d 293b   status {name});
+000275d0: 2027 0a20 2020 2020 2020 2020 2020 2066   '.            f
+000275e0: 2775 6e74 696c 2065 6368 6f20 2224 7322  'until echo "$s"
+000275f0: 207c 2067 7265 7020 2246 4149 4c45 445f   | grep "FAILED_
+00027600: 494e 4954 4941 4c5f 4445 4c41 5922 3b20  INITIAL_DELAY"; 
+00027610: 646f 2027 0a20 2020 2020 2020 2020 2020  do '.           
+00027620: 2027 6563 686f 2022 5761 6974 696e 6720   'echo "Waiting 
+00027630: 666f 7220 7265 706c 6963 6120 746f 2062  for replica to b
+00027640: 6520 6661 696c 6564 2e2e 2e22 3b20 736c  e failed..."; sl
+00027650: 6565 7020 353b 2027 0a20 2020 2020 2020  eep 5; '.       
+00027660: 2020 2020 2066 2773 3d24 2873 6b79 2073       f's=$(sky s
+00027670: 6572 7665 2073 7461 7475 7320 7b6e 616d  erve status {nam
+00027680: 657d 293b 2065 6368 6f20 2224 7322 3b20  e}); echo "$s"; 
+00027690: 646f 6e65 3b27 2c0a 2020 2020 2020 2020  done;',.        
+000276a0: 2020 2020 2773 6c65 6570 2036 3027 2c0a      'sleep 60',.
+000276b0: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
+000276c0: 5345 5256 455f 5354 4154 5553 5f57 4149  SERVE_STATUS_WAI
+000276d0: 542e 666f 726d 6174 286e 616d 653d 6e61  T.format(name=na
+000276e0: 6d65 297d 3b20 6563 686f 2022 2473 2220  me)}; echo "$s" 
+000276f0: 7c20 6772 6570 2022 7b6e 616d 657d 2220  | grep "{name}" 
+00027700: 7c20 6772 6570 2022 4641 494c 4544 5f49  | grep "FAILED_I
+00027710: 4e49 5449 414c 5f44 454c 4159 2220 7c20  NITIAL_DELAY" | 
+00027720: 7763 202d 6c20 7c20 6772 6570 2032 3b20  wc -l | grep 2; 
+00027730: 270a 2020 2020 2020 2020 2020 2020 2320  '.            # 
+00027740: 4d61 6b65 2073 7572 6520 6e6f 206e 6577  Make sure no new
+00027750: 2072 6570 6c69 6361 7320 6172 6520 7374   replicas are st
+00027760: 6172 7465 6420 666f 7220 6561 726c 7920  arted for early 
+00027770: 6661 696c 7572 652e 0a20 2020 2020 2020  failure..       
+00027780: 2020 2020 2066 2765 6368 6f20 2224 7322       f'echo "$s"
+00027790: 207c 2067 7265 7020 2d41 2031 3030 2022   | grep -A 100 "
+000277a0: 5365 7276 6963 6520 5265 706c 6963 6173  Service Replicas
+000277b0: 2220 7c20 6772 6570 2022 7b6e 616d 657d  " | grep "{name}
+000277c0: 2220 7c20 7763 202d 6c20 7c20 6772 6570  " | wc -l | grep
+000277d0: 2032 3b27 2c0a 2020 2020 2020 2020 2020   2;',.          
+000277e0: 2020 6627 736b 7920 7365 7276 6520 7570    f'sky serve up
+000277f0: 6461 7465 207b 6e61 6d65 7d20 2d2d 636c  date {name} --cl
+00027800: 6f75 6420 7b67 656e 6572 6963 5f63 6c6f  oud {generic_clo
+00027810: 7564 7d20 2d79 2074 6573 7473 2f73 6b79  ud} -y tests/sky
+00027820: 7365 7276 652f 6661 696c 7572 6573 2f70  serve/failures/p
+00027830: 726f 6269 6e67 2e79 616d 6c27 2c0a 2020  robing.yaml',.  
+00027840: 2020 2020 2020 2020 2020 6627 733d 2428            f's=$(
+00027850: 736b 7920 7365 7276 6520 7374 6174 7573  sky serve status
+00027860: 207b 6e61 6d65 7d29 3b20 270a 2020 2020   {name}); '.    
+00027870: 2020 2020 2020 2020 2320 5761 6974 2066          # Wait f
+00027880: 6f72 2072 6570 6c69 6361 2074 6f20 6265  or replica to be
+00027890: 2072 6561 6479 2e0a 2020 2020 2020 2020   ready..        
+000278a0: 2020 2020 6627 756e 7469 6c20 6563 686f      f'until echo
+000278b0: 2022 2473 2220 7c20 6772 6570 2022 5245   "$s" | grep "RE
+000278c0: 4144 5922 3b20 646f 2027 0a20 2020 2020  ADY"; do '.     
+000278d0: 2020 2020 2020 2027 6563 686f 2022 5761         'echo "Wa
+000278e0: 6974 696e 6720 666f 7220 7265 706c 6963  iting for replic
+000278f0: 6120 746f 2062 6520 6661 696c 6564 2e2e  a to be failed..
+00027900: 2e22 3b20 736c 6565 7020 353b 2027 0a20  ."; sleep 5; '. 
+00027910: 2020 2020 2020 2020 2020 2066 2773 3d24             f's=$
+00027920: 2873 6b79 2073 6572 7665 2073 7461 7475  (sky serve statu
+00027930: 7320 7b6e 616d 657d 293b 2065 6368 6f20  s {name}); echo 
+00027940: 2224 7322 3b20 646f 6e65 3b27 2c0a 2020  "$s"; done;',.  
+00027950: 2020 2020 2020 2020 2020 2320 5761 6974            # Wait
+00027960: 2066 6f72 2072 6570 6c69 6361 2074 6f20   for replica to 
+00027970: 6368 616e 6765 2074 6f20 4641 494c 4544  change to FAILED
+00027980: 5f50 524f 4249 4e47 0a20 2020 2020 2020  _PROBING.       
+00027990: 2020 2020 2066 2773 3d24 2873 6b79 2073       f's=$(sky s
+000279a0: 6572 7665 2073 7461 7475 7320 7b6e 616d  erve status {nam
+000279b0: 657d 293b 2027 0a20 2020 2020 2020 2020  e}); '.         
+000279c0: 2020 2066 2775 6e74 696c 2065 6368 6f20     f'until echo 
+000279d0: 2224 7322 207c 2067 7265 7020 2246 4149  "$s" | grep "FAI
+000279e0: 4c45 445f 5052 4f42 494e 4722 3b20 646f  LED_PROBING"; do
+000279f0: 2027 0a20 2020 2020 2020 2020 2020 2027   '.            '
+00027a00: 6563 686f 2022 5761 6974 696e 6720 666f  echo "Waiting fo
+00027a10: 7220 7265 706c 6963 6120 746f 2062 6520  r replica to be 
+00027a20: 6661 696c 6564 2e2e 2e22 3b20 736c 6565  failed..."; slee
+00027a30: 7020 353b 2027 0a20 2020 2020 2020 2020  p 5; '.         
+00027a40: 2020 2066 2773 3d24 2873 6b79 2073 6572     f's=$(sky ser
+00027a50: 7665 2073 7461 7475 7320 7b6e 616d 657d  ve status {name}
+00027a60: 293b 2065 6368 6f20 2224 7322 3b20 646f  ); echo "$s"; do
+00027a70: 6e65 3b27 202b 0a20 2020 2020 2020 2020  ne;' +.         
+00027a80: 2020 205f 6368 6563 6b5f 7265 706c 6963     _check_replic
+00027a90: 615f 696e 5f73 7461 7475 7328 0a20 2020  a_in_status(.   
+00027aa0: 2020 2020 2020 2020 2020 2020 206e 616d               nam
+00027ab0: 652c 205b 2831 2c20 4661 6c73 652c 2027  e, [(1, False, '
+00027ac0: 4641 494c 4544 5f50 524f 4249 4e47 2729  FAILED_PROBING')
+00027ad0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00027ae0: 2020 2020 2020 2020 2028 312c 2046 616c           (1, Fal
+00027af0: 7365 2c20 5f53 4552 5649 4345 5f4c 4155  se, _SERVICE_LAU
+00027b00: 4e43 4849 4e47 5f53 5441 5455 535f 5245  NCHING_STATUS_RE
+00027b10: 4745 5829 5d29 2c0a 2020 2020 2020 2020  GEX)]),.        
+00027b20: 2020 2020 2320 544f 444f 287a 6877 7529      # TODO(zhwu)
+00027b30: 3a20 6164 6420 7465 7374 2066 6f72 2046  : add test for F
+00027b40: 4149 4c45 445f 5052 4f56 4953 494f 4e0a  AILED_PROVISION.
+00027b50: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
+00027b60: 2020 205f 5445 4152 444f 574e 5f53 4552     _TEARDOWN_SER
+00027b70: 5649 4345 2e66 6f72 6d61 7428 6e61 6d65  VICE.format(name
+00027b80: 3d6e 616d 6529 2c0a 2020 2020 2020 2020  =name),.        
+00027b90: 7469 6d65 6f75 743d 3230 202a 2036 302c  timeout=20 * 60,
+00027ba0: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+00027bb0: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+00027bc0: 2320 544f 444f 285a 696d 696e 672c 2054  # TODO(Ziming, T
+00027bd0: 6961 6e29 3a20 4164 6420 7465 7374 7320  ian): Add tests 
+00027be0: 666f 7220 6175 746f 7363 616c 696e 672e  for autoscaling.
+00027bf0: 0a0a 0a23 202d 2d2d 2d2d 2d2d 2054 6573  ...# ------- Tes
+00027c00: 7469 6e67 2075 7365 7220 7261 7920 636c  ting user ray cl
+00027c10: 7573 7465 7220 2d2d 2d2d 2d2d 2d2d 0a64  uster --------.d
+00027c20: 6566 2074 6573 745f 7573 6572 5f72 6179  ef test_user_ray
+00027c30: 5f63 6c75 7374 6572 2867 656e 6572 6963  _cluster(generic
+00027c40: 5f63 6c6f 7564 3a20 7374 7229 3a0a 2020  _cloud: str):.  
+00027c50: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
+00027c60: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
+00027c70: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+00027c80: 2020 2020 2020 2775 7365 722d 7261 792d        'user-ray-
+00027c90: 636c 7573 7465 7227 2c0a 2020 2020 2020  cluster',.      
+00027ca0: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
+00027cb0: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
+00027cc0: 2d63 207b 6e61 6d65 7d20 2d2d 636c 6f75  -c {name} --clou
+00027cd0: 6420 7b67 656e 6572 6963 5f63 6c6f 7564  d {generic_cloud
+00027ce0: 7d20 2272 6179 2073 7461 7274 202d 2d68  } "ray start --h
+00027cf0: 6561 6422 272c 0a20 2020 2020 2020 2020  ead"',.         
+00027d00: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
+00027d10: 616d 657d 2022 6563 686f 2068 6922 272c  ame} "echo hi"',
+00027d20: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00027d30: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
+00027d40: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
+00027d50: 2020 2020 2020 2020 6627 736b 7920 7374          f'sky st
+00027d60: 6174 7573 202d 7220 7b6e 616d 657d 207c  atus -r {name} |
+00027d70: 2067 7265 7020 5550 272c 0a20 2020 2020   grep UP',.     
+00027d80: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
+00027d90: 6320 7b6e 616d 657d 2022 6563 686f 2062  c {name} "echo b
+00027da0: 7965 2227 2c0a 2020 2020 2020 2020 2020  ye"',.          
+00027db0: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+00027dc0: 6d65 7d20 3220 2d2d 7374 6174 7573 272c  me} 2 --status',
+00027dd0: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
+00027de0: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
+00027df0: 7920 7b6e 616d 657d 272c 0a20 2020 2029  y {name}',.    )
+00027e00: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
+00027e10: 7428 7465 7374 290a 0a0a 2320 2d2d 2d2d  t(test)...# ----
+00027e20: 2d2d 2d20 5465 7374 696e 6720 7468 6520  --- Testing the 
+00027e30: 636f 7265 2041 5049 202d 2d2d 2d2d 2d2d  core API -------
+00027e40: 2d0a 2320 4d6f 7374 206f 6620 7468 6520  -.# Most of the 
+00027e50: 636f 7265 2041 5049 7320 6861 7665 2062  core APIs have b
+00027e60: 6565 6e20 7465 7374 6564 2069 6e20 7468  een tested in th
+00027e70: 6520 434c 4920 7465 7374 732e 0a23 2054  e CLI tests..# T
+00027e80: 6865 7365 2074 6573 7473 2061 7265 2066  hese tests are f
+00027e90: 6f72 2074 6573 7469 6e67 2074 6865 2072  or testing the r
+00027ea0: 6574 7572 6e20 7661 6c75 6520 6f66 2074  eturn value of t
+00027eb0: 6865 2041 5049 7320 6e6f 7420 6675 6c6c  he APIs not full
+00027ec0: 7920 7573 6564 2069 6e20 434c 492e 0a0a  y used in CLI...
+00027ed0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6763  .@pytest.mark.gc
+00027ee0: 700a 6465 6620 7465 7374 5f63 6f72 655f  p.def test_core_
+00027ef0: 6170 695f 736b 795f 6c61 756e 6368 5f65  api_sky_launch_e
+00027f00: 7865 6328 293a 0a20 2020 206e 616d 6520  xec():.    name 
+00027f10: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
+00027f20: 616d 6528 290a 2020 2020 7461 736b 203d  ame().    task =
+00027f30: 2073 6b79 2e54 6173 6b28 7275 6e3d 2277   sky.Task(run="w
+00027f40: 686f 616d 6922 290a 2020 2020 7461 736b  hoami").    task
+00027f50: 2e73 6574 5f72 6573 6f75 7263 6573 2873  .set_resources(s
+00027f60: 6b79 2e52 6573 6f75 7263 6573 2863 6c6f  ky.Resources(clo
+00027f70: 7564 3d73 6b79 2e47 4350 2829 2929 0a20  ud=sky.GCP())). 
+00027f80: 2020 206a 6f62 5f69 642c 2068 616e 646c     job_id, handl
+00027f90: 6520 3d20 736b 792e 6c61 756e 6368 2874  e = sky.launch(t
+00027fa0: 6173 6b2c 2063 6c75 7374 6572 5f6e 616d  ask, cluster_nam
+00027fb0: 653d 6e61 6d65 290a 2020 2020 6173 7365  e=name).    asse
+00027fc0: 7274 206a 6f62 5f69 6420 3d3d 2031 0a20  rt job_id == 1. 
+00027fd0: 2020 2061 7373 6572 7420 6861 6e64 6c65     assert handle
+00027fe0: 2069 7320 6e6f 7420 4e6f 6e65 0a20 2020   is not None.   
+00027ff0: 2061 7373 6572 7420 6861 6e64 6c65 2e63   assert handle.c
+00028000: 6c75 7374 6572 5f6e 616d 6520 3d3d 206e  luster_name == n
+00028010: 616d 650a 2020 2020 6173 7365 7274 2068  ame.    assert h
+00028020: 616e 646c 652e 6c61 756e 6368 6564 5f72  andle.launched_r
+00028030: 6573 6f75 7263 6573 2e63 6c6f 7564 2e69  esources.cloud.i
+00028040: 735f 7361 6d65 5f63 6c6f 7564 2873 6b79  s_same_cloud(sky
+00028050: 2e47 4350 2829 290a 2020 2020 6a6f 625f  .GCP()).    job_
+00028060: 6964 5f65 7865 632c 2068 616e 646c 655f  id_exec, handle_
+00028070: 6578 6563 203d 2073 6b79 2e65 7865 6328  exec = sky.exec(
+00028080: 7461 736b 2c20 636c 7573 7465 725f 6e61  task, cluster_na
+00028090: 6d65 3d6e 616d 6529 0a20 2020 2061 7373  me=name).    ass
+000280a0: 6572 7420 6a6f 625f 6964 5f65 7865 6320  ert job_id_exec 
+000280b0: 3d3d 2032 0a20 2020 2061 7373 6572 7420  == 2.    assert 
+000280c0: 6861 6e64 6c65 5f65 7865 6320 6973 206e  handle_exec is n
+000280d0: 6f74 204e 6f6e 650a 2020 2020 6173 7365  ot None.    asse
+000280e0: 7274 2068 616e 646c 655f 6578 6563 2e63  rt handle_exec.c
+000280f0: 6c75 7374 6572 5f6e 616d 6520 3d3d 206e  luster_name == n
+00028100: 616d 650a 2020 2020 6173 7365 7274 2068  ame.    assert h
+00028110: 616e 646c 655f 6578 6563 2e6c 6175 6e63  andle_exec.launc
+00028120: 6865 645f 7265 736f 7572 6365 732e 636c  hed_resources.cl
+00028130: 6f75 642e 6973 5f73 616d 655f 636c 6f75  oud.is_same_clou
+00028140: 6428 736b 792e 4743 5028 2929 0a20 2020  d(sky.GCP()).   
+00028150: 2023 2046 6f72 2064 756d 6d79 2074 6173   # For dummy tas
+00028160: 6b20 2869 2e65 2e20 7461 736b 2e72 756e  k (i.e. task.run
+00028170: 2069 7320 4e6f 6e65 292c 2074 6865 206a   is None), the j
+00028180: 6f62 2077 6f6e 2774 2062 6520 7375 626d  ob won't be subm
+00028190: 6974 7465 642e 0a20 2020 2064 756d 6d79  itted..    dummy
+000281a0: 5f74 6173 6b20 3d20 736b 792e 5461 736b  _task = sky.Task
+000281b0: 2829 0a20 2020 206a 6f62 5f69 645f 6475  ().    job_id_du
+000281c0: 6d6d 792c 205f 203d 2073 6b79 2e65 7865  mmy, _ = sky.exe
+000281d0: 6328 6475 6d6d 795f 7461 736b 2c20 636c  c(dummy_task, cl
+000281e0: 7573 7465 725f 6e61 6d65 3d6e 616d 6529  uster_name=name)
+000281f0: 0a20 2020 2061 7373 6572 7420 6a6f 625f  .    assert job_
+00028200: 6964 5f64 756d 6d79 2069 7320 4e6f 6e65  id_dummy is None
+00028210: 0a20 2020 2073 6b79 2e64 6f77 6e28 6e61  .    sky.down(na
+00028220: 6d65 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d  me)...# --------
+00028230: 2d2d 2054 6573 7469 6e67 2053 746f 7261  -- Testing Stora
+00028240: 6765 202d 2d2d 2d2d 2d2d 2d2d 2d0a 636c  ge ----------.cl
+00028250: 6173 7320 5465 7374 5374 6f72 6167 6557  ass TestStorageW
+00028260: 6974 6843 7265 6465 6e74 6961 6c73 3a0a  ithCredentials:.
+00028270: 2020 2020 2222 2253 746f 7261 6765 2074      """Storage t
+00028280: 6573 7473 2077 6869 6368 2072 6571 7569  ests which requi
+00028290: 7265 2063 7265 6465 6e74 6961 6c73 2061  re credentials a
+000282a0: 6e64 206e 6574 776f 726b 2063 6f6e 6e65  nd network conne
+000282b0: 6374 696f 6e22 2222 0a0a 2020 2020 4157  ction"""..    AW
+000282c0: 535f 494e 5641 4c49 445f 4e41 4d45 5320  S_INVALID_NAMES 
+000282d0: 3d20 5b0a 2020 2020 2020 2020 2761 6227  = [.        'ab'
+000282e0: 2c20 2023 206c 6573 7320 7468 616e 2033  ,  # less than 3
+000282f0: 2063 6861 7261 6374 6572 730a 2020 2020   characters.    
+00028300: 2020 2020 2761 6263 6465 6667 6869 6a6b      'abcdefghijk
+00028310: 6c6d 6e6f 7071 7273 7475 7677 7879 7a61  lmnopqrstuvwxyza
+00028320: 6263 6465 6667 6869 6a6b 6c6d 6e6f 7071  bcdefghijklmnopq
+00028330: 7273 7475 7677 7879 7a61 6263 6465 6667  rstuvwxyzabcdefg
+00028340: 6869 6a6b 6c6d 6e6f 7071 7273 7475 7677  hijklmnopqrstuvw
+00028350: 7879 7a31 272c 0a20 2020 2020 2020 2023  xyz1',.        #
+00028360: 206d 6f72 6520 7468 616e 2036 3320 6368   more than 63 ch
+00028370: 6172 6163 7465 7273 0a20 2020 2020 2020  aracters.       
+00028380: 2027 4162 6364 6566 272c 2020 2320 636f   'Abcdef',  # co
+00028390: 6e74 6169 6e73 2061 6e20 7570 7065 7263  ntains an upperc
+000283a0: 6173 6520 6c65 7474 6572 0a20 2020 2020  ase letter.     
+000283b0: 2020 2027 6162 6320 6465 6627 2c20 2023     'abc def',  #
+000283c0: 2063 6f6e 7461 696e 7320 6120 7370 6163   contains a spac
+000283d0: 650a 2020 2020 2020 2020 2761 6263 2e2e  e.        'abc..
+000283e0: 6465 6627 2c20 2023 2074 776f 2061 646a  def',  # two adj
+000283f0: 6163 656e 7420 7065 7269 6f64 730a 2020  acent periods.  
+00028400: 2020 2020 2020 2731 3932 2e31 3638 2e35        '192.168.5
+00028410: 2e34 272c 2020 2320 666f 726d 6174 7465  .4',  # formatte
+00028420: 6420 6173 2061 6e20 4950 2061 6464 7265  d as an IP addre
+00028430: 7373 0a20 2020 2020 2020 2027 786e 2d2d  ss.        'xn--
+00028440: 6275 636b 6574 272c 2020 2320 7374 6172  bucket',  # star
+00028450: 7473 2077 6974 6820 2778 6e2d 2d27 2070  ts with 'xn--' p
+00028460: 7265 6669 780a 2020 2020 2020 2020 2762  refix.        'b
+00028470: 7563 6b65 742d 7333 616c 6961 7327 2c20  ucket-s3alias', 
+00028480: 2023 2065 6e64 7320 7769 7468 2027 2d73   # ends with '-s
+00028490: 3361 6c69 6173 2720 7375 6666 6978 0a20  3alias' suffix. 
+000284a0: 2020 2020 2020 2027 6275 636b 6574 2d2d         'bucket--
+000284b0: 6f6c 2d73 3327 2c20 2023 2065 6e64 7320  ol-s3',  # ends 
+000284c0: 7769 7468 2027 2d2d 6f6c 2d73 3327 2073  with '--ol-s3' s
+000284d0: 7566 6669 780a 2020 2020 2020 2020 272e  uffix.        '.
+000284e0: 6162 6327 2c20 2023 2073 7461 7274 7320  abc',  # starts 
+000284f0: 7769 7468 2061 2064 6f74 0a20 2020 2020  with a dot.     
+00028500: 2020 2027 6162 632e 272c 2020 2320 656e     'abc.',  # en
+00028510: 6473 2077 6974 6820 6120 646f 740a 2020  ds with a dot.  
+00028520: 2020 2020 2020 272d 6162 6327 2c20 2023        '-abc',  #
+00028530: 2073 7461 7274 7320 7769 7468 2061 2068   starts with a h
+00028540: 7970 6865 6e0a 2020 2020 2020 2020 2761  yphen.        'a
+00028550: 6263 2d27 2c20 2023 2065 6e64 7320 7769  bc-',  # ends wi
+00028560: 7468 2061 2068 7970 6865 6e0a 2020 2020  th a hyphen.    
+00028570: 5d0a 0a20 2020 2047 4353 5f49 4e56 414c  ]..    GCS_INVAL
+00028580: 4944 5f4e 414d 4553 203d 205b 0a20 2020  ID_NAMES = [.   
+00028590: 2020 2020 2027 6162 272c 2020 2320 6c65       'ab',  # le
+000285a0: 7373 2074 6861 6e20 3320 6368 6172 6163  ss than 3 charac
+000285b0: 7465 7273 0a20 2020 2020 2020 2027 6162  ters.        'ab
+000285c0: 6364 6566 6768 696a 6b6c 6d6e 6f70 7172  cdefghijklmnopqr
+000285d0: 7374 7576 7778 797a 6162 6364 6566 6768  stuvwxyzabcdefgh
+000285e0: 696a 6b6c 6d6e 6f70 7172 7374 7576 7778  ijklmnopqrstuvwx
+000285f0: 797a 6162 6364 6566 6768 696a 6b6c 6d6e  yzabcdefghijklmn
+00028600: 6f70 7172 7374 7576 7778 797a 3127 2c0a  opqrstuvwxyz1',.
+00028610: 2020 2020 2020 2020 2320 6d6f 7265 2074          # more t
+00028620: 6861 6e20 3633 2063 6861 7261 6374 6572  han 63 character
+00028630: 7320 2877 6974 686f 7574 2064 6f74 7329  s (without dots)
+00028640: 0a20 2020 2020 2020 2027 4162 6364 6566  .        'Abcdef
+00028650: 272c 2020 2320 636f 6e74 6169 6e73 2061  ',  # contains a
+00028660: 6e20 7570 7065 7263 6173 6520 6c65 7474  n uppercase lett
+00028670: 6572 0a20 2020 2020 2020 2027 6162 6320  er.        'abc 
+00028680: 6465 6627 2c20 2023 2063 6f6e 7461 696e  def',  # contain
+00028690: 7320 6120 7370 6163 650a 2020 2020 2020  s a space.      
+000286a0: 2020 2761 6263 2e2e 6465 6627 2c20 2023    'abc..def',  #
+000286b0: 2074 776f 2061 646a 6163 656e 7420 7065   two adjacent pe
+000286c0: 7269 6f64 730a 2020 2020 2020 2020 2761  riods.        'a
+000286d0: 6263 5f2e 6465 662e 6768 692e 6a6b 6c6d  bc_.def.ghi.jklm
+000286e0: 6e6f 7071 7273 7475 7677 7879 7a61 6263  nopqrstuvwxyzabc
+000286f0: 6465 6667 6869 6a6b 6c6d 6e6f 7071 7273  defghijklmnopqrs
+00028700: 7475 7677 7879 7a61 6263 6465 6667 6869  tuvwxyzabcdefghi
+00028710: 6a6b 6c6d 6e6f 7071 7273 7475 7677 7879  jklmnopqrstuvwxy
+00028720: 7a31 270a 2020 2020 2020 2020 2320 4d6f  z1'.        # Mo
+00028730: 7265 2074 6861 6e20 3633 2063 6861 7261  re than 63 chara
+00028740: 6374 6572 7320 6265 7477 6565 6e20 646f  cters between do
+00028750: 7473 0a20 2020 2020 2020 2027 6162 635f  ts.        'abc_
+00028760: 2e64 6566 2e67 6869 2e6a 6b6c 6d6e 6f70  .def.ghi.jklmnop
+00028770: 7172 7374 7576 7778 797a 6162 6364 6566  qrstuvwxyzabcdef
+00028780: 6768 696a 6b6c 6d6e 6f70 7166 6768 696a  ghijklmnopqfghij
+00028790: 6b6c 6d6e 6f70 7172 7374 7576 7727 202a  klmnopqrstuvw' *
+000287a0: 2035 2c0a 2020 2020 2020 2020 2320 6d6f   5,.        # mo
+000287b0: 7265 2074 6861 6e20 3232 3220 6368 6172  re than 222 char
+000287c0: 6163 7465 7273 2028 7769 7468 2064 6f74  acters (with dot
+000287d0: 7329 0a20 2020 2020 2020 2027 3139 322e  s).        '192.
+000287e0: 3136 382e 352e 3427 2c20 2023 2066 6f72  168.5.4',  # for
+000287f0: 6d61 7474 6564 2061 7320 616e 2049 5020  matted as an IP 
+00028800: 6164 6472 6573 730a 2020 2020 2020 2020  address.        
+00028810: 2767 6f6f 6762 7563 6b65 7427 2c20 2023  'googbucket',  #
+00028820: 2073 7461 7274 7320 7769 7468 2027 676f   starts with 'go
+00028830: 6f67 2720 7072 6566 6978 0a20 2020 2020  og' prefix.     
+00028840: 2020 2027 676f 6f67 6c65 6275 636b 6574     'googlebucket
+00028850: 272c 2020 2320 636f 6e74 6169 6e73 2027  ',  # contains '
+00028860: 676f 6f67 6c65 270a 2020 2020 2020 2020  google'.        
+00028870: 2767 3030 676c 6562 7563 6b65 7427 2c20  'g00glebucket', 
+00028880: 2023 2076 6172 6961 6e74 206f 6620 2767   # variant of 'g
+00028890: 6f6f 676c 6527 0a20 2020 2020 2020 2027  oogle'.        '
+000288a0: 676f 3067 6c65 6275 636b 6574 272c 2020  go0glebucket',  
+000288b0: 2320 7661 7269 616e 7420 6f66 2027 676f  # variant of 'go
+000288c0: 6f67 6c65 270a 2020 2020 2020 2020 2767  ogle'.        'g
+000288d0: 306f 676c 6562 7563 6b65 7427 2c20 2023  0oglebucket',  #
+000288e0: 2076 6172 6961 6e74 206f 6620 2767 6f6f   variant of 'goo
+000288f0: 676c 6527 0a20 2020 2020 2020 2027 2e61  gle'.        '.a
+00028900: 6263 272c 2020 2320 7374 6172 7473 2077  bc',  # starts w
+00028910: 6974 6820 6120 646f 740a 2020 2020 2020  ith a dot.      
+00028920: 2020 2761 6263 2e27 2c20 2023 2065 6e64    'abc.',  # end
+00028930: 7320 7769 7468 2061 2064 6f74 0a20 2020  s with a dot.   
+00028940: 2020 2020 2027 5f61 6263 272c 2020 2320       '_abc',  # 
+00028950: 7374 6172 7473 2077 6974 6820 616e 2075  starts with an u
+00028960: 6e64 6572 7363 6f72 650a 2020 2020 2020  nderscore.      
+00028970: 2020 2761 6263 5f27 2c20 2023 2065 6e64    'abc_',  # end
+00028980: 7320 7769 7468 2061 6e20 756e 6465 7273  s with an unders
+00028990: 636f 7265 0a20 2020 205d 0a0a 2020 2020  core.    ]..    
+000289a0: 4942 4d5f 494e 5641 4c49 445f 4e41 4d45  IBM_INVALID_NAME
+000289b0: 5320 3d20 5b0a 2020 2020 2020 2020 2761  S = [.        'a
+000289c0: 6227 2c20 2023 206c 6573 7320 7468 616e  b',  # less than
+000289d0: 2033 2063 6861 7261 6374 6572 730a 2020   3 characters.  
+000289e0: 2020 2020 2020 2761 6263 6465 6667 6869        'abcdefghi
+000289f0: 6a6b 6c6d 6e6f 7071 7273 7475 7677 7879  jklmnopqrstuvwxy
+00028a00: 7a61 6263 6465 6667 6869 6a6b 6c6d 6e6f  zabcdefghijklmno
+00028a10: 7071 7273 7475 7677 7879 7a61 6263 6465  pqrstuvwxyzabcde
+00028a20: 6667 6869 6a6b 6c6d 6e6f 7071 7273 7475  fghijklmnopqrstu
+00028a30: 7677 7879 7a31 272c 0a20 2020 2020 2020  vwxyz1',.       
+00028a40: 2023 206d 6f72 6520 7468 616e 2036 3320   # more than 63 
+00028a50: 6368 6172 6163 7465 7273 0a20 2020 2020  characters.     
+00028a60: 2020 2027 4162 6364 6566 272c 2020 2320     'Abcdef',  # 
+00028a70: 636f 6e74 6169 6e73 2061 6e20 7570 7065  contains an uppe
+00028a80: 7263 6173 6520 6c65 7474 6572 0a20 2020  rcase letter.   
+00028a90: 2020 2020 2027 6162 6320 6465 6627 2c20       'abc def', 
+00028aa0: 2023 2063 6f6e 7461 696e 7320 6120 7370   # contains a sp
+00028ab0: 6163 650a 2020 2020 2020 2020 2761 6263  ace.        'abc
+00028ac0: 2e2e 6465 6627 2c20 2023 2074 776f 2061  ..def',  # two a
+00028ad0: 646a 6163 656e 7420 7065 7269 6f64 730a  djacent periods.
+00028ae0: 2020 2020 2020 2020 2731 3932 2e31 3638          '192.168
+00028af0: 2e35 2e34 272c 2020 2320 666f 726d 6174  .5.4',  # format
+00028b00: 7465 6420 6173 2061 6e20 4950 2061 6464  ted as an IP add
+00028b10: 7265 7373 0a20 2020 2020 2020 2027 786e  ress.        'xn
+00028b20: 2d2d 6275 636b 6574 272c 2020 2320 7374  --bucket',  # st
+00028b30: 6172 7473 2077 6974 6820 2778 6e2d 2d27  arts with 'xn--'
+00028b40: 2070 7265 6669 780a 2020 2020 2020 2020   prefix.        
+00028b50: 272e 6162 6327 2c20 2023 2073 7461 7274  '.abc',  # start
+00028b60: 7320 7769 7468 2061 2064 6f74 0a20 2020  s with a dot.   
+00028b70: 2020 2020 2027 6162 632e 272c 2020 2320       'abc.',  # 
+00028b80: 656e 6473 2077 6974 6820 6120 646f 740a  ends with a dot.
+00028b90: 2020 2020 2020 2020 272d 6162 6327 2c20          '-abc', 
+00028ba0: 2023 2073 7461 7274 7320 7769 7468 2061   # starts with a
+00028bb0: 2068 7970 6865 6e0a 2020 2020 2020 2020   hyphen.        
+00028bc0: 2761 6263 2d27 2c20 2023 2065 6e64 7320  'abc-',  # ends 
+00028bd0: 7769 7468 2061 2068 7970 6865 6e0a 2020  with a hyphen.  
+00028be0: 2020 2020 2020 2761 2e2d 6263 272c 2020        'a.-bc',  
+00028bf0: 2320 636f 6e74 6169 6e73 2074 6865 2073  # contains the s
+00028c00: 6571 7565 6e63 6520 272e 2d27 0a20 2020  equence '.-'.   
+00028c10: 2020 2020 2027 612d 2e62 6327 2c20 2023       'a-.bc',  #
+00028c20: 2063 6f6e 7461 696e 7320 7468 6520 7365   contains the se
+00028c30: 7175 656e 6365 2027 2d2e 270a 2020 2020  quence '-.'.    
+00028c40: 2020 2020 2761 2662 6327 2020 2320 636f      'a&bc'  # co
+00028c50: 6e74 6169 6e73 2073 7065 6369 616c 2063  ntains special c
+00028c60: 6861 7261 6374 6572 730a 2020 2020 2020  haracters.      
+00028c70: 2020 2761 625e 6327 2020 2320 636f 6e74    'ab^c'  # cont
+00028c80: 6169 6e73 2073 7065 6369 616c 2063 6861  ains special cha
+00028c90: 7261 6374 6572 730a 2020 2020 5d0a 2020  racters.    ].  
+00028ca0: 2020 4749 5449 474e 4f52 455f 5359 4e43    GITIGNORE_SYNC
+00028cb0: 5f54 4553 545f 4449 525f 5354 5255 4354  _TEST_DIR_STRUCT
+00028cc0: 5552 4520 3d20 7b0a 2020 2020 2020 2020  URE = {.        
+00028cd0: 2764 6f75 626c 655f 6173 7465 7269 736b  'double_asterisk
+00028ce0: 273a 207b 0a20 2020 2020 2020 2020 2020  ': {.           
+00028cf0: 2027 646f 7562 6c65 5f61 7374 6572 6973   'double_asteris
+00028d00: 6b5f 6578 636c 7564 6564 273a 204e 6f6e  k_excluded': Non
+00028d10: 652c 0a20 2020 2020 2020 2020 2020 2027  e,.            '
+00028d20: 646f 7562 6c65 5f61 7374 6572 6973 6b5f  double_asterisk_
+00028d30: 6578 636c 7564 6564 5f64 6972 273a 207b  excluded_dir': {
+00028d40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00028d50: 2027 6469 725f 6578 636c 7564 6564 273a   'dir_excluded':
+00028d60: 204e 6f6e 652c 0a20 2020 2020 2020 2020   None,.         
+00028d70: 2020 207d 2c0a 2020 2020 2020 2020 7d2c     },.        },
+00028d80: 0a20 2020 2020 2020 2027 646f 7562 6c65  .        'double
+00028d90: 5f61 7374 6572 6973 6b5f 7061 7265 6e74  _asterisk_parent
+00028da0: 273a 207b 0a20 2020 2020 2020 2020 2020  ': {.           
+00028db0: 2027 7061 7265 6e74 273a 207b 0a20 2020   'parent': {.   
+00028dc0: 2020 2020 2020 2020 2020 2020 2027 616c               'al
+00028dd0: 736f 5f65 7863 6c75 6465 642e 7478 7427  so_excluded.txt'
+00028de0: 3a20 4e6f 6e65 2c0a 2020 2020 2020 2020  : None,.        
+00028df0: 2020 2020 2020 2020 2763 6869 6c64 273a          'child':
+00028e00: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00028e10: 2020 2020 2020 2027 646f 7562 6c65 5f61         'double_a
+00028e20: 7374 6572 6973 6b5f 7061 7265 6e74 5f63  sterisk_parent_c
+00028e30: 6869 6c64 5f65 7863 6c75 6465 642e 7478  hild_excluded.tx
+00028e40: 7427 3a20 4e6f 6e65 2c0a 2020 2020 2020  t': None,.      
+00028e50: 2020 2020 2020 2020 2020 7d2c 0a20 2020            },.   
+00028e60: 2020 2020 2020 2020 2020 2020 2027 646f               'do
+00028e70: 7562 6c65 5f61 7374 6572 6973 6b5f 7061  uble_asterisk_pa
+00028e80: 7265 6e74 5f65 7863 6c75 6465 642e 7478  rent_excluded.tx
+00028e90: 7427 3a20 4e6f 6e65 2c0a 2020 2020 2020  t': None,.      
+00028ea0: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
+00028eb0: 207d 2c0a 2020 2020 2020 2020 2765 7863   },.        'exc
+00028ec0: 6c75 6465 642e 6c6f 6727 3a20 4e6f 6e65  luded.log': None
+00028ed0: 2c0a 2020 2020 2020 2020 2765 7863 6c75  ,.        'exclu
+00028ee0: 6465 645f 6469 7227 3a20 7b0a 2020 2020  ded_dir': {.    
+00028ef0: 2020 2020 2020 2020 2765 7863 6c75 6465          'exclude
+00028f00: 642e 7478 7427 3a20 4e6f 6e65 2c0a 2020  d.txt': None,.  
+00028f10: 2020 2020 2020 2020 2020 276e 6573 7465            'neste
+00028f20: 645f 6578 636c 7564 6564 273a 207b 0a20  d_excluded': {. 
+00028f30: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00028f40: 6578 636c 7564 6564 273a 204e 6f6e 652c  excluded': None,
+00028f50: 0a20 2020 2020 2020 2020 2020 207d 2c0a  .            },.
+00028f60: 2020 2020 2020 2020 7d2c 0a20 2020 2020          },.     
+00028f70: 2020 2027 6578 702d 3127 3a20 7b0a 2020     'exp-1': {.  
+00028f80: 2020 2020 2020 2020 2020 2762 655f 6578            'be_ex
+00028f90: 636c 7564 6564 273a 204e 6f6e 652c 0a20  cluded': None,. 
+00028fa0: 2020 2020 2020 207d 2c0a 2020 2020 2020         },.      
+00028fb0: 2020 2765 7870 2d32 273a 207b 0a20 2020    'exp-2': {.   
+00028fc0: 2020 2020 2020 2020 2027 6265 5f65 7863           'be_exc
+00028fd0: 6c75 6465 6427 3a20 4e6f 6e65 2c0a 2020  luded': None,.  
+00028fe0: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
+00028ff0: 2027 6672 6f6e 745f 736c 6173 685f 6578   'front_slash_ex
+00029000: 636c 7564 6564 273a 204e 6f6e 652c 0a20  cluded': None,. 
+00029010: 2020 2020 2020 2027 696e 636c 7564 6564         'included
+00029020: 2e6c 6f67 273a 204e 6f6e 652c 0a20 2020  .log': None,.   
+00029030: 2020 2020 2027 696e 636c 7564 6564 2e74       'included.t
+00029040: 7874 273a 204e 6f6e 652c 0a20 2020 2020  xt': None,.     
+00029050: 2020 2027 696e 636c 7564 655f 6469 7227     'include_dir'
+00029060: 3a20 7b0a 2020 2020 2020 2020 2020 2020  : {.            
+00029070: 2765 7863 6c75 6465 642e 6c6f 6727 3a20  'excluded.log': 
+00029080: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
+00029090: 2020 2769 6e63 6c75 6465 642e 6c6f 6727    'included.log'
+000290a0: 3a20 4e6f 6e65 2c0a 2020 2020 2020 2020  : None,.        
+000290b0: 7d2c 0a20 2020 2020 2020 2027 6e65 7374  },.        'nest
+000290c0: 6564 5f64 6f75 626c 655f 6173 7465 7269  ed_double_asteri
+000290d0: 736b 273a 207b 0a20 2020 2020 2020 2020  sk': {.         
+000290e0: 2020 2027 6f6e 6527 3a20 7b0a 2020 2020     'one': {.    
+000290f0: 2020 2020 2020 2020 2020 2020 2761 6c73              'als
+00029100: 6f5f 6578 636c 7564 652e 7478 7427 3a20  o_exclude.txt': 
+00029110: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
+00029120: 2020 7d2c 0a20 2020 2020 2020 2020 2020    },.           
+00029130: 2027 7477 6f27 3a20 7b0a 2020 2020 2020   'two': {.      
+00029140: 2020 2020 2020 2020 2020 2761 6c73 6f5f            'also_
+00029150: 6578 636c 7564 652e 7478 7427 3a20 4e6f  exclude.txt': No
+00029160: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
+00029170: 7d2c 0a20 2020 2020 2020 207d 2c0a 2020  },.        },.  
+00029180: 2020 2020 2020 276e 6573 7465 645f 7769        'nested_wi
+00029190: 6c64 6361 7264 5f64 6972 273a 207b 0a20  ldcard_dir': {. 
+000291a0: 2020 2020 2020 2020 2020 2027 6d6f 6e64             'mond
+000291b0: 6179 273a 207b 0a20 2020 2020 2020 2020  ay': {.         
+000291c0: 2020 2020 2020 2027 616c 736f 5f65 7863         'also_exc
+000291d0: 6c75 6465 2e74 7874 273a 204e 6f6e 652c  lude.txt': None,
+000291e0: 0a20 2020 2020 2020 2020 2020 207d 2c0a  .            },.
+000291f0: 2020 2020 2020 2020 2020 2020 2774 7565              'tue
+00029200: 7364 6179 273a 207b 0a20 2020 2020 2020  sday': {.       
+00029210: 2020 2020 2020 2020 2027 616c 736f 5f65           'also_e
+00029220: 7863 6c75 6465 2e74 7874 273a 204e 6f6e  xclude.txt': Non
+00029230: 652c 0a20 2020 2020 2020 2020 2020 207d  e,.            }
+00029240: 2c0a 2020 2020 2020 2020 7d2c 0a20 2020  ,.        },.   
+00029250: 2020 2020 2027 6e6f 5f73 6c61 7368 5f65       'no_slash_e
+00029260: 7863 6c75 6465 6427 3a20 4e6f 6e65 2c0a  xcluded': None,.
+00029270: 2020 2020 2020 2020 276e 6f5f 736c 6173          'no_slas
+00029280: 685f 7465 7374 7327 3a20 7b0a 2020 2020  h_tests': {.    
+00029290: 2020 2020 2020 2020 276e 6f5f 736c 6173          'no_slas
+000292a0: 685f 6578 636c 7564 6564 273a 207b 0a20  h_excluded': {. 
+000292b0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+000292c0: 616c 736f 5f65 7863 6c75 6465 642e 7478  also_excluded.tx
+000292d0: 7427 3a20 4e6f 6e65 2c0a 2020 2020 2020  t': None,.      
+000292e0: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
+000292f0: 207d 2c0a 2020 2020 2020 2020 2771 7565   },.        'que
+00029300: 7374 696f 6e5f 6d61 726b 273a 207b 0a20  stion_mark': {. 
+00029310: 2020 2020 2020 2020 2020 2027 6578 636c             'excl
+00029320: 7564 6564 312e 7478 7427 3a20 4e6f 6e65  uded1.txt': None
+00029330: 2c0a 2020 2020 2020 2020 2020 2020 2765  ,.            'e
+00029340: 7863 6c75 6465 6440 2e74 7874 273a 204e  xcluded@.txt': N
+00029350: 6f6e 652c 0a20 2020 2020 2020 207d 2c0a  one,.        },.
+00029360: 2020 2020 2020 2020 2773 7175 6172 655f          'square_
+00029370: 6272 6163 6b65 7427 3a20 7b0a 2020 2020  bracket': {.    
+00029380: 2020 2020 2020 2020 2765 7863 6c75 6465          'exclude
+00029390: 6431 2e74 7874 273a 204e 6f6e 652c 0a20  d1.txt': None,. 
+000293a0: 2020 2020 2020 207d 2c0a 2020 2020 2020         },.      
+000293b0: 2020 2773 7175 6172 655f 6272 6163 6b65    'square_bracke
+000293c0: 745f 616c 7068 6127 3a20 7b0a 2020 2020  t_alpha': {.    
+000293d0: 2020 2020 2020 2020 2765 7863 6c75 6465          'exclude
+000293e0: 647a 2e74 7874 273a 204e 6f6e 652c 0a20  dz.txt': None,. 
+000293f0: 2020 2020 2020 207d 2c0a 2020 2020 2020         },.      
+00029400: 2020 2773 7175 6172 655f 6272 6163 6b65    'square_bracke
+00029410: 745f 6578 636c 6127 3a20 7b0a 2020 2020  t_excla': {.    
+00029420: 2020 2020 2020 2020 2765 7863 6c75 6465          'exclude
+00029430: 6432 2e74 7874 273a 204e 6f6e 652c 0a20  d2.txt': None,. 
+00029440: 2020 2020 2020 2020 2020 2027 6578 636c             'excl
+00029450: 7564 6564 402e 7478 7427 3a20 4e6f 6e65  uded@.txt': None
+00029460: 2c0a 2020 2020 2020 2020 7d2c 0a20 2020  ,.        },.   
+00029470: 2020 2020 2027 7371 7561 7265 5f62 7261       'square_bra
+00029480: 636b 6574 5f73 696e 676c 6527 3a20 7b0a  cket_single': {.
+00029490: 2020 2020 2020 2020 2020 2020 2765 7863              'exc
+000294a0: 6c75 6465 6430 2e74 7874 273a 204e 6f6e  luded0.txt': Non
+000294b0: 652c 0a20 2020 2020 2020 207d 2c0a 2020  e,.        },.  
+000294c0: 2020 7d0a 0a20 2020 2040 7374 6174 6963    }..    @static
+000294d0: 6d65 7468 6f64 0a20 2020 2064 6566 2063  method.    def c
+000294e0: 7265 6174 655f 6469 725f 7374 7275 6374  reate_dir_struct
+000294f0: 7572 6528 6261 7365 5f70 6174 682c 2073  ure(base_path, s
+00029500: 7472 7563 7475 7265 293a 0a20 2020 2020  tructure):.     
+00029510: 2020 2023 2063 7265 6174 6573 2061 2067     # creates a g
+00029520: 6976 656e 2066 696c 6520 5354 5255 4354  iven file STRUCT
+00029530: 5552 4520 696e 2042 4153 455f 5041 5448  URE in BASE_PATH
+00029540: 0a20 2020 2020 2020 2066 6f72 206e 616d  .        for nam
+00029550: 652c 2073 7562 7374 7275 6374 7572 6520  e, substructure 
+00029560: 696e 2073 7472 7563 7475 7265 2e69 7465  in structure.ite
+00029570: 6d73 2829 3a0a 2020 2020 2020 2020 2020  ms():.          
+00029580: 2020 7061 7468 203d 206f 732e 7061 7468    path = os.path
+00029590: 2e6a 6f69 6e28 6261 7365 5f70 6174 682c  .join(base_path,
+000295a0: 206e 616d 6529 0a20 2020 2020 2020 2020   name).         
+000295b0: 2020 2069 6620 7375 6273 7472 7563 7475     if substructu
+000295c0: 7265 2069 7320 4e6f 6e65 3a0a 2020 2020  re is None:.    
+000295d0: 2020 2020 2020 2020 2020 2020 2320 4372              # Cr
+000295e0: 6561 7465 2061 2066 696c 650a 2020 2020  eate a file.    
+000295f0: 2020 2020 2020 2020 2020 2020 6f70 656e              open
+00029600: 2870 6174 682c 2027 6127 2c20 656e 636f  (path, 'a', enco
+00029610: 6469 6e67 3d27 7574 662d 3827 292e 636c  ding='utf-8').cl
+00029620: 6f73 6528 290a 2020 2020 2020 2020 2020  ose().          
+00029630: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00029640: 2020 2020 2020 2020 2320 4372 6561 7465          # Create
+00029650: 2061 2073 7562 6469 7265 6374 6f72 790a   a subdirectory.
+00029660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029670: 6f73 2e6d 6b64 6972 2870 6174 6829 0a20  os.mkdir(path). 
+00029680: 2020 2020 2020 2020 2020 2020 2020 2054                 T
+00029690: 6573 7453 746f 7261 6765 5769 7468 4372  estStorageWithCr
+000296a0: 6564 656e 7469 616c 732e 6372 6561 7465  edentials.create
+000296b0: 5f64 6972 5f73 7472 7563 7475 7265 280a  _dir_structure(.
+000296c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000296d0: 2020 2020 7061 7468 2c20 7375 6273 7472      path, substr
+000296e0: 7563 7475 7265 290a 0a20 2020 2040 7374  ucture)..    @st
+000296f0: 6174 6963 6d65 7468 6f64 0a20 2020 2064  aticmethod.    d
+00029700: 6566 2063 6c69 5f64 656c 6574 655f 636d  ef cli_delete_cm
+00029710: 6428 7374 6f72 655f 7479 7065 2c20 6275  d(store_type, bu
+00029720: 636b 6574 5f6e 616d 6529 3a0a 2020 2020  cket_name):.    
+00029730: 2020 2020 6966 2073 746f 7265 5f74 7970      if store_typ
+00029740: 6520 3d3d 2073 746f 7261 6765 5f6c 6962  e == storage_lib
+00029750: 2e53 746f 7265 5479 7065 2e53 333a 0a20  .StoreType.S3:. 
+00029760: 2020 2020 2020 2020 2020 2075 726c 203d             url =
+00029770: 2066 2773 333a 2f2f 7b62 7563 6b65 745f   f's3://{bucket_
+00029780: 6e61 6d65 7d27 0a20 2020 2020 2020 2020  name}'.         
+00029790: 2020 2072 6574 7572 6e20 6627 6177 7320     return f'aws 
+000297a0: 7333 2072 6220 7b75 726c 7d20 2d2d 666f  s3 rb {url} --fo
+000297b0: 7263 6527 0a20 2020 2020 2020 2069 6620  rce'.        if 
+000297c0: 7374 6f72 655f 7479 7065 203d 3d20 7374  store_type == st
+000297d0: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
+000297e0: 7970 652e 4743 533a 0a20 2020 2020 2020  ype.GCS:.       
+000297f0: 2020 2020 2075 726c 203d 2066 2767 733a       url = f'gs:
+00029800: 2f2f 7b62 7563 6b65 745f 6e61 6d65 7d27  //{bucket_name}'
+00029810: 0a20 2020 2020 2020 2020 2020 2067 7375  .            gsu
+00029820: 7469 6c5f 616c 6961 732c 2061 6c69 6173  til_alias, alias
+00029830: 5f67 656e 203d 2064 6174 615f 7574 696c  _gen = data_util
+00029840: 732e 6765 745f 6773 7574 696c 5f63 6f6d  s.get_gsutil_com
+00029850: 6d61 6e64 2829 0a20 2020 2020 2020 2020  mand().         
+00029860: 2020 2072 6574 7572 6e20 6627 7b61 6c69     return f'{ali
+00029870: 6173 5f67 656e 7d3b 207b 6773 7574 696c  as_gen}; {gsutil
+00029880: 5f61 6c69 6173 7d20 726d 202d 7220 7b75  _alias} rm -r {u
+00029890: 726c 7d27 0a20 2020 2020 2020 2069 6620  rl}'.        if 
+000298a0: 7374 6f72 655f 7479 7065 203d 3d20 7374  store_type == st
+000298b0: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
+000298c0: 7970 652e 5232 3a0a 2020 2020 2020 2020  ype.R2:.        
+000298d0: 2020 2020 656e 6470 6f69 6e74 5f75 726c      endpoint_url
+000298e0: 203d 2063 6c6f 7564 666c 6172 652e 6372   = cloudflare.cr
+000298f0: 6561 7465 5f65 6e64 706f 696e 7428 290a  eate_endpoint().
+00029900: 2020 2020 2020 2020 2020 2020 7572 6c20              url 
+00029910: 3d20 6627 7333 3a2f 2f7b 6275 636b 6574  = f's3://{bucket
+00029920: 5f6e 616d 657d 270a 2020 2020 2020 2020  _name}'.        
+00029930: 2020 2020 7265 7475 726e 2066 2741 5753      return f'AWS
+00029940: 5f53 4841 5245 445f 4352 4544 454e 5449  _SHARED_CREDENTI
+00029950: 414c 535f 4649 4c45 3d7b 636c 6f75 6466  ALS_FILE={cloudf
+00029960: 6c61 7265 2e52 325f 4352 4544 454e 5449  lare.R2_CREDENTI
+00029970: 414c 535f 5041 5448 7d20 6177 7320 7333  ALS_PATH} aws s3
+00029980: 2072 6220 7b75 726c 7d20 2d2d 666f 7263   rb {url} --forc
+00029990: 6520 2d2d 656e 6470 6f69 6e74 207b 656e  e --endpoint {en
+000299a0: 6470 6f69 6e74 5f75 726c 7d20 2d2d 7072  dpoint_url} --pr
+000299b0: 6f66 696c 653d 7232 270a 2020 2020 2020  ofile=r2'.      
+000299c0: 2020 6966 2073 746f 7265 5f74 7970 6520    if store_type 
+000299d0: 3d3d 2073 746f 7261 6765 5f6c 6962 2e53  == storage_lib.S
+000299e0: 746f 7265 5479 7065 2e49 424d 3a0a 2020  toreType.IBM:.  
+000299f0: 2020 2020 2020 2020 2020 6275 636b 6574            bucket
+00029a00: 5f72 636c 6f6e 655f 7072 6f66 696c 6520  _rclone_profile 
+00029a10: 3d20 5263 6c6f 6e65 2e67 656e 6572 6174  = Rclone.generat
+00029a20: 655f 7263 6c6f 6e65 5f62 7563 6b65 745f  e_rclone_bucket_
+00029a30: 7072 6f66 696c 655f 6e61 6d65 280a 2020  profile_name(.  
+00029a40: 2020 2020 2020 2020 2020 2020 2020 6275                bu
+00029a50: 636b 6574 5f6e 616d 652c 2052 636c 6f6e  cket_name, Rclon
+00029a60: 652e 5263 6c6f 6e65 436c 6f75 6473 2e49  e.RcloneClouds.I
+00029a70: 424d 290a 2020 2020 2020 2020 2020 2020  BM).            
+00029a80: 7265 7475 726e 2066 2772 636c 6f6e 6520  return f'rclone 
+00029a90: 7075 7267 6520 7b62 7563 6b65 745f 7263  purge {bucket_rc
+00029aa0: 6c6f 6e65 5f70 726f 6669 6c65 7d3a 7b62  lone_profile}:{b
+00029ab0: 7563 6b65 745f 6e61 6d65 7d20 2626 2072  ucket_name} && r
+00029ac0: 636c 6f6e 6520 636f 6e66 6967 2064 656c  clone config del
+00029ad0: 6574 6520 7b62 7563 6b65 745f 7263 6c6f  ete {bucket_rclo
+00029ae0: 6e65 5f70 726f 6669 6c65 7d27 0a0a 2020  ne_profile}'..  
+00029af0: 2020 4073 7461 7469 636d 6574 686f 640a    @staticmethod.
+00029b00: 2020 2020 6465 6620 636c 695f 6c73 5f63      def cli_ls_c
+00029b10: 6d64 2873 746f 7265 5f74 7970 652c 2062  md(store_type, b
+00029b20: 7563 6b65 745f 6e61 6d65 2c20 7375 6666  ucket_name, suff
+00029b30: 6978 3d27 2729 3a0a 2020 2020 2020 2020  ix=''):.        
+00029b40: 6966 2073 746f 7265 5f74 7970 6520 3d3d  if store_type ==
+00029b50: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
+00029b60: 7265 5479 7065 2e53 333a 0a20 2020 2020  reType.S3:.     
+00029b70: 2020 2020 2020 2069 6620 7375 6666 6978         if suffix
+00029b80: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00029b90: 2020 7572 6c20 3d20 6627 7333 3a2f 2f7b    url = f's3://{
+00029ba0: 6275 636b 6574 5f6e 616d 657d 2f7b 7375  bucket_name}/{su
+00029bb0: 6666 6978 7d27 0a20 2020 2020 2020 2020  ffix}'.         
+00029bc0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00029bd0: 2020 2020 2020 2020 2075 726c 203d 2066           url = f
+00029be0: 2773 333a 2f2f 7b62 7563 6b65 745f 6e61  's3://{bucket_na
+00029bf0: 6d65 7d27 0a20 2020 2020 2020 2020 2020  me}'.           
+00029c00: 2072 6574 7572 6e20 6627 6177 7320 7333   return f'aws s3
+00029c10: 206c 7320 7b75 726c 7d27 0a20 2020 2020   ls {url}'.     
+00029c20: 2020 2069 6620 7374 6f72 655f 7479 7065     if store_type
+00029c30: 203d 3d20 7374 6f72 6167 655f 6c69 622e   == storage_lib.
+00029c40: 5374 6f72 6554 7970 652e 4743 533a 0a20  StoreType.GCS:. 
+00029c50: 2020 2020 2020 2020 2020 2069 6620 7375             if su
+00029c60: 6666 6978 3a0a 2020 2020 2020 2020 2020  ffix:.          
+00029c70: 2020 2020 2020 7572 6c20 3d20 6627 6773        url = f'gs
+00029c80: 3a2f 2f7b 6275 636b 6574 5f6e 616d 657d  ://{bucket_name}
+00029c90: 2f7b 7375 6666 6978 7d27 0a20 2020 2020  /{suffix}'.     
+00029ca0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00029cb0: 2020 2020 2020 2020 2020 2020 2075 726c               url
+00029cc0: 203d 2066 2767 733a 2f2f 7b62 7563 6b65   = f'gs://{bucke
+00029cd0: 745f 6e61 6d65 7d27 0a20 2020 2020 2020  t_name}'.       
+00029ce0: 2020 2020 2072 6574 7572 6e20 6627 6773       return f'gs
+00029cf0: 7574 696c 206c 7320 7b75 726c 7d27 0a20  util ls {url}'. 
+00029d00: 2020 2020 2020 2069 6620 7374 6f72 655f         if store_
+00029d10: 7479 7065 203d 3d20 7374 6f72 6167 655f  type == storage_
+00029d20: 6c69 622e 5374 6f72 6554 7970 652e 5232  lib.StoreType.R2
+00029d30: 3a0a 2020 2020 2020 2020 2020 2020 656e  :.            en
+00029d40: 6470 6f69 6e74 5f75 726c 203d 2063 6c6f  dpoint_url = clo
+00029d50: 7564 666c 6172 652e 6372 6561 7465 5f65  udflare.create_e
+00029d60: 6e64 706f 696e 7428 290a 2020 2020 2020  ndpoint().      
+00029d70: 2020 2020 2020 6966 2073 7566 6669 783a        if suffix:
+00029d80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00029d90: 2075 726c 203d 2066 2773 333a 2f2f 7b62   url = f's3://{b
+00029da0: 7563 6b65 745f 6e61 6d65 7d2f 7b73 7566  ucket_name}/{suf
+00029db0: 6669 787d 270a 2020 2020 2020 2020 2020  fix}'.          
+00029dc0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00029dd0: 2020 2020 2020 2020 7572 6c20 3d20 6627          url = f'
+00029de0: 7333 3a2f 2f7b 6275 636b 6574 5f6e 616d  s3://{bucket_nam
+00029df0: 657d 270a 2020 2020 2020 2020 2020 2020  e}'.            
+00029e00: 7265 7475 726e 2066 2741 5753 5f53 4841  return f'AWS_SHA
+00029e10: 5245 445f 4352 4544 454e 5449 414c 535f  RED_CREDENTIALS_
+00029e20: 4649 4c45 3d7b 636c 6f75 6466 6c61 7265  FILE={cloudflare
+00029e30: 2e52 325f 4352 4544 454e 5449 414c 535f  .R2_CREDENTIALS_
+00029e40: 5041 5448 7d20 6177 7320 7333 206c 7320  PATH} aws s3 ls 
+00029e50: 7b75 726c 7d20 2d2d 656e 6470 6f69 6e74  {url} --endpoint
+00029e60: 207b 656e 6470 6f69 6e74 5f75 726c 7d20   {endpoint_url} 
+00029e70: 2d2d 7072 6f66 696c 653d 7232 270a 2020  --profile=r2'.  
+00029e80: 2020 2020 2020 6966 2073 746f 7265 5f74        if store_t
+00029e90: 7970 6520 3d3d 2073 746f 7261 6765 5f6c  ype == storage_l
+00029ea0: 6962 2e53 746f 7265 5479 7065 2e49 424d  ib.StoreType.IBM
+00029eb0: 3a0a 2020 2020 2020 2020 2020 2020 6275  :.            bu
+00029ec0: 636b 6574 5f72 636c 6f6e 655f 7072 6f66  cket_rclone_prof
+00029ed0: 696c 6520 3d20 5263 6c6f 6e65 2e67 656e  ile = Rclone.gen
+00029ee0: 6572 6174 655f 7263 6c6f 6e65 5f62 7563  erate_rclone_buc
+00029ef0: 6b65 745f 7072 6f66 696c 655f 6e61 6d65  ket_profile_name
+00029f00: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00029f10: 2020 6275 636b 6574 5f6e 616d 652c 2052    bucket_name, R
+00029f20: 636c 6f6e 652e 5263 6c6f 6e65 436c 6f75  clone.RcloneClou
+00029f30: 6473 2e49 424d 290a 2020 2020 2020 2020  ds.IBM).        
+00029f40: 2020 2020 7265 7475 726e 2066 2772 636c      return f'rcl
+00029f50: 6f6e 6520 6c73 207b 6275 636b 6574 5f72  one ls {bucket_r
+00029f60: 636c 6f6e 655f 7072 6f66 696c 657d 3a7b  clone_profile}:{
+00029f70: 6275 636b 6574 5f6e 616d 657d 2f7b 7375  bucket_name}/{su
+00029f80: 6666 6978 7d27 0a0a 2020 2020 4073 7461  ffix}'..    @sta
+00029f90: 7469 636d 6574 686f 640a 2020 2020 6465  ticmethod.    de
+00029fa0: 6620 636c 695f 7265 6769 6f6e 5f63 6d64  f cli_region_cmd
+00029fb0: 2873 746f 7265 5f74 7970 652c 2062 7563  (store_type, buc
+00029fc0: 6b65 745f 6e61 6d65 293a 0a20 2020 2020  ket_name):.     
+00029fd0: 2020 2069 6620 7374 6f72 655f 7479 7065     if store_type
+00029fe0: 203d 3d20 7374 6f72 6167 655f 6c69 622e   == storage_lib.
+00029ff0: 5374 6f72 6554 7970 652e 5333 3a0a 2020  StoreType.S3:.  
+0002a000: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0002a010: 2028 2761 7773 2073 3361 7069 2067 6574   ('aws s3api get
+0002a020: 2d62 7563 6b65 742d 6c6f 6361 7469 6f6e  -bucket-location
+0002a030: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+0002a040: 2020 2020 2020 2066 272d 2d62 7563 6b65         f'--bucke
+0002a050: 7420 7b62 7563 6b65 745f 6e61 6d65 7d20  t {bucket_name} 
+0002a060: 2d2d 6f75 7470 7574 2074 6578 7427 290a  --output text').
+0002a070: 2020 2020 2020 2020 656c 6966 2073 746f          elif sto
+0002a080: 7265 5f74 7970 6520 3d3d 2073 746f 7261  re_type == stora
+0002a090: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
+0002a0a0: 2e47 4353 3a0a 2020 2020 2020 2020 2020  .GCS:.          
+0002a0b0: 2020 7265 7475 726e 2028 6627 6773 7574    return (f'gsut
+0002a0c0: 696c 206c 7320 2d4c 202d 6220 6773 3a2f  il ls -L -b gs:/
+0002a0d0: 2f7b 6275 636b 6574 5f6e 616d 657d 2f20  /{bucket_name}/ 
+0002a0e0: 7c20 270a 2020 2020 2020 2020 2020 2020  | '.            
+0002a0f0: 2020 2020 2020 2020 2767 7265 7020 224c          'grep "L
+0002a100: 6f63 6174 696f 6e20 636f 6e73 7472 6169  ocation constrai
+0002a110: 6e74 2220 7c20 270a 2020 2020 2020 2020  nt" | '.        
+0002a120: 2020 2020 2020 2020 2020 2020 2761 776b              'awk
+0002a130: 205c 277b 7072 696e 7420 746f 6c6f 7765   \'{print tolowe
+0002a140: 7228 244e 4629 7d5c 2727 290a 2020 2020  r($NF)}\'').    
+0002a150: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0002a160: 2020 2020 2020 7261 6973 6520 4e6f 7449        raise NotI
+0002a170: 6d70 6c65 6d65 6e74 6564 4572 726f 7228  mplementedError(
+0002a180: 6627 5265 6769 6f6e 2063 6f6d 6d61 6e64  f'Region command
+0002a190: 206e 6f74 2069 6d70 6c65 6d65 6e74 6564   not implemented
+0002a1a0: 2066 6f72 2027 0a20 2020 2020 2020 2020   for '.         
+0002a1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a1c0: 2020 2020 2020 2020 2020 2020 2066 277b               f'{
+0002a1d0: 7374 6f72 655f 7479 7065 7d27 290a 0a20  store_type}').. 
+0002a1e0: 2020 2040 7374 6174 6963 6d65 7468 6f64     @staticmethod
+0002a1f0: 0a20 2020 2064 6566 2063 6c69 5f63 6f75  .    def cli_cou
+0002a200: 6e74 5f6e 616d 655f 696e 5f62 7563 6b65  nt_name_in_bucke
+0002a210: 7428 7374 6f72 655f 7479 7065 2c20 6275  t(store_type, bu
+0002a220: 636b 6574 5f6e 616d 652c 2066 696c 655f  cket_name, file_
+0002a230: 6e61 6d65 2c20 7375 6666 6978 3d27 2729  name, suffix='')
+0002a240: 3a0a 2020 2020 2020 2020 6966 2073 746f  :.        if sto
+0002a250: 7265 5f74 7970 6520 3d3d 2073 746f 7261  re_type == stora
+0002a260: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
+0002a270: 2e53 333a 0a20 2020 2020 2020 2020 2020  .S3:.           
+0002a280: 2069 6620 7375 6666 6978 3a0a 2020 2020   if suffix:.    
+0002a290: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0002a2a0: 726e 2066 2761 7773 2073 3361 7069 206c  rn f'aws s3api l
+0002a2b0: 6973 742d 6f62 6a65 6374 7320 2d2d 6275  ist-objects --bu
+0002a2c0: 636b 6574 2022 7b62 7563 6b65 745f 6e61  cket "{bucket_na
+0002a2d0: 6d65 7d22 202d 2d70 7265 6669 7820 7b73  me}" --prefix {s
+0002a2e0: 7566 6669 787d 202d 2d71 7565 7279 2022  uffix} --query "
+0002a2f0: 6c65 6e67 7468 2843 6f6e 7465 6e74 735b  length(Contents[
+0002a300: 3f63 6f6e 7461 696e 7328 4b65 792c 5c27  ?contains(Key,\'
+0002a310: 7b66 696c 655f 6e61 6d65 7d5c 2729 5d2e  {file_name}\')].
+0002a320: 4b65 7929 2227 0a20 2020 2020 2020 2020  Key)"'.         
+0002a330: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0002a340: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0002a350: 6627 6177 7320 7333 6170 6920 6c69 7374  f'aws s3api list
+0002a360: 2d6f 626a 6563 7473 202d 2d62 7563 6b65  -objects --bucke
+0002a370: 7420 227b 6275 636b 6574 5f6e 616d 657d  t "{bucket_name}
+0002a380: 2220 2d2d 7175 6572 7920 226c 656e 6774  " --query "lengt
+0002a390: 6828 436f 6e74 656e 7473 5b3f 636f 6e74  h(Contents[?cont
+0002a3a0: 6169 6e73 284b 6579 2c5c 277b 6669 6c65  ains(Key,\'{file
+0002a3b0: 5f6e 616d 657d 5c27 295d 2e4b 6579 2922  _name}\')].Key)"
+0002a3c0: 270a 2020 2020 2020 2020 656c 6966 2073  '.        elif s
+0002a3d0: 746f 7265 5f74 7970 6520 3d3d 2073 746f  tore_type == sto
+0002a3e0: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
+0002a3f0: 7065 2e47 4353 3a0a 2020 2020 2020 2020  pe.GCS:.        
+0002a400: 2020 2020 6966 2073 7566 6669 783a 0a20      if suffix:. 
+0002a410: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0002a420: 6574 7572 6e20 6627 6773 7574 696c 206c  eturn f'gsutil l
+0002a430: 7320 2d72 2067 733a 2f2f 7b62 7563 6b65  s -r gs://{bucke
+0002a440: 745f 6e61 6d65 7d2f 7b73 7566 6669 787d  t_name}/{suffix}
+0002a450: 207c 2067 7265 7020 227b 6669 6c65 5f6e   | grep "{file_n
+0002a460: 616d 657d 2220 7c20 7763 202d 6c27 0a20  ame}" | wc -l'. 
+0002a470: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+0002a480: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002a490: 2072 6574 7572 6e20 6627 6773 7574 696c   return f'gsutil
+0002a4a0: 206c 7320 2d72 2067 733a 2f2f 7b62 7563   ls -r gs://{buc
+0002a4b0: 6b65 745f 6e61 6d65 7d20 7c20 6772 6570  ket_name} | grep
+0002a4c0: 2022 7b66 696c 655f 6e61 6d65 7d22 207c   "{file_name}" |
+0002a4d0: 2077 6320 2d6c 270a 2020 2020 2020 2020   wc -l'.        
+0002a4e0: 656c 6966 2073 746f 7265 5f74 7970 6520  elif store_type 
+0002a4f0: 3d3d 2073 746f 7261 6765 5f6c 6962 2e53  == storage_lib.S
+0002a500: 746f 7265 5479 7065 2e52 323a 0a20 2020  toreType.R2:.   
+0002a510: 2020 2020 2020 2020 2065 6e64 706f 696e           endpoin
+0002a520: 745f 7572 6c20 3d20 636c 6f75 6466 6c61  t_url = cloudfla
+0002a530: 7265 2e63 7265 6174 655f 656e 6470 6f69  re.create_endpoi
+0002a540: 6e74 2829 0a20 2020 2020 2020 2020 2020  nt().           
+0002a550: 2069 6620 7375 6666 6978 3a0a 2020 2020   if suffix:.    
+0002a560: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0002a570: 726e 2066 2741 5753 5f53 4841 5245 445f  rn f'AWS_SHARED_
+0002a580: 4352 4544 454e 5449 414c 535f 4649 4c45  CREDENTIALS_FILE
+0002a590: 3d7b 636c 6f75 6466 6c61 7265 2e52 325f  ={cloudflare.R2_
+0002a5a0: 4352 4544 454e 5449 414c 535f 5041 5448  CREDENTIALS_PATH
+0002a5b0: 7d20 6177 7320 7333 6170 6920 6c69 7374  } aws s3api list
+0002a5c0: 2d6f 626a 6563 7473 202d 2d62 7563 6b65  -objects --bucke
+0002a5d0: 7420 227b 6275 636b 6574 5f6e 616d 657d  t "{bucket_name}
+0002a5e0: 2220 2d2d 7072 6566 6978 207b 7375 6666  " --prefix {suff
+0002a5f0: 6978 7d20 2d2d 7175 6572 7920 226c 656e  ix} --query "len
+0002a600: 6774 6828 436f 6e74 656e 7473 5b3f 636f  gth(Contents[?co
+0002a610: 6e74 6169 6e73 284b 6579 2c5c 277b 6669  ntains(Key,\'{fi
+0002a620: 6c65 5f6e 616d 657d 5c27 295d 2e4b 6579  le_name}\')].Key
+0002a630: 2922 202d 2d65 6e64 706f 696e 7420 7b65  )" --endpoint {e
+0002a640: 6e64 706f 696e 745f 7572 6c7d 202d 2d70  ndpoint_url} --p
+0002a650: 726f 6669 6c65 3d72 3227 0a20 2020 2020  rofile=r2'.     
+0002a660: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0002a670: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+0002a680: 7572 6e20 6627 4157 535f 5348 4152 4544  urn f'AWS_SHARED
+0002a690: 5f43 5245 4445 4e54 4941 4c53 5f46 494c  _CREDENTIALS_FIL
+0002a6a0: 453d 7b63 6c6f 7564 666c 6172 652e 5232  E={cloudflare.R2
+0002a6b0: 5f43 5245 4445 4e54 4941 4c53 5f50 4154  _CREDENTIALS_PAT
+0002a6c0: 487d 2061 7773 2073 3361 7069 206c 6973  H} aws s3api lis
+0002a6d0: 742d 6f62 6a65 6374 7320 2d2d 6275 636b  t-objects --buck
+0002a6e0: 6574 2022 7b62 7563 6b65 745f 6e61 6d65  et "{bucket_name
+0002a6f0: 7d22 202d 2d71 7565 7279 2022 6c65 6e67  }" --query "leng
+0002a700: 7468 2843 6f6e 7465 6e74 735b 3f63 6f6e  th(Contents[?con
+0002a710: 7461 696e 7328 4b65 792c 5c27 7b66 696c  tains(Key,\'{fil
+0002a720: 655f 6e61 6d65 7d5c 2729 5d2e 4b65 7929  e_name}\')].Key)
+0002a730: 2220 2d2d 656e 6470 6f69 6e74 207b 656e  " --endpoint {en
+0002a740: 6470 6f69 6e74 5f75 726c 7d20 2d2d 7072  dpoint_url} --pr
+0002a750: 6f66 696c 653d 7232 270a 0a20 2020 2040  ofile=r2'..    @
+0002a760: 7374 6174 6963 6d65 7468 6f64 0a20 2020  staticmethod.   
+0002a770: 2064 6566 2063 6c69 5f63 6f75 6e74 5f66   def cli_count_f
+0002a780: 696c 655f 696e 5f62 7563 6b65 7428 7374  ile_in_bucket(st
+0002a790: 6f72 655f 7479 7065 2c20 6275 636b 6574  ore_type, bucket
+0002a7a0: 5f6e 616d 6529 3a0a 2020 2020 2020 2020  _name):.        
+0002a7b0: 6966 2073 746f 7265 5f74 7970 6520 3d3d  if store_type ==
+0002a7c0: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
+0002a7d0: 7265 5479 7065 2e53 333a 0a20 2020 2020  reType.S3:.     
+0002a7e0: 2020 2020 2020 2072 6574 7572 6e20 6627         return f'
+0002a7f0: 6177 7320 7333 206c 7320 7333 3a2f 2f7b  aws s3 ls s3://{
+0002a800: 6275 636b 6574 5f6e 616d 657d 202d 2d72  bucket_name} --r
+0002a810: 6563 7572 7369 7665 207c 2077 6320 2d6c  ecursive | wc -l
+0002a820: 270a 2020 2020 2020 2020 656c 6966 2073  '.        elif s
+0002a830: 746f 7265 5f74 7970 6520 3d3d 2073 746f  tore_type == sto
+0002a840: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
+0002a850: 7065 2e47 4353 3a0a 2020 2020 2020 2020  pe.GCS:.        
+0002a860: 2020 2020 7265 7475 726e 2066 2767 7375      return f'gsu
+0002a870: 7469 6c20 6c73 202d 7220 6773 3a2f 2f7b  til ls -r gs://{
+0002a880: 6275 636b 6574 5f6e 616d 657d 2f2a 2a20  bucket_name}/** 
+0002a890: 7c20 7763 202d 6c27 0a20 2020 2020 2020  | wc -l'.       
+0002a8a0: 2065 6c69 6620 7374 6f72 655f 7479 7065   elif store_type
+0002a8b0: 203d 3d20 7374 6f72 6167 655f 6c69 622e   == storage_lib.
+0002a8c0: 5374 6f72 6554 7970 652e 5232 3a0a 2020  StoreType.R2:.  
+0002a8d0: 2020 2020 2020 2020 2020 656e 6470 6f69            endpoi
+0002a8e0: 6e74 5f75 726c 203d 2063 6c6f 7564 666c  nt_url = cloudfl
+0002a8f0: 6172 652e 6372 6561 7465 5f65 6e64 706f  are.create_endpo
+0002a900: 696e 7428 290a 2020 2020 2020 2020 2020  int().          
+0002a910: 2020 7265 7475 726e 2066 2741 5753 5f53    return f'AWS_S
+0002a920: 4841 5245 445f 4352 4544 454e 5449 414c  HARED_CREDENTIAL
+0002a930: 535f 4649 4c45 3d7b 636c 6f75 6466 6c61  S_FILE={cloudfla
+0002a940: 7265 2e52 325f 4352 4544 454e 5449 414c  re.R2_CREDENTIAL
+0002a950: 535f 5041 5448 7d20 6177 7320 7333 206c  S_PATH} aws s3 l
+0002a960: 7320 7333 3a2f 2f7b 6275 636b 6574 5f6e  s s3://{bucket_n
+0002a970: 616d 657d 202d 2d72 6563 7572 7369 7665  ame} --recursive
+0002a980: 202d 2d65 6e64 706f 696e 7420 7b65 6e64   --endpoint {end
+0002a990: 706f 696e 745f 7572 6c7d 202d 2d70 726f  point_url} --pro
+0002a9a0: 6669 6c65 3d72 3220 7c20 7763 202d 6c27  file=r2 | wc -l'
+0002a9b0: 0a0a 2020 2020 4070 7974 6573 742e 6669  ..    @pytest.fi
+0002a9c0: 7874 7572 650a 2020 2020 6465 6620 746d  xture.    def tm
+0002a9d0: 705f 736f 7572 6365 2873 656c 662c 2074  p_source(self, t
+0002a9e0: 6d70 5f70 6174 6829 3a0a 2020 2020 2020  mp_path):.      
+0002a9f0: 2020 2320 4372 6561 7465 7320 6120 7465    # Creates a te
+0002aa00: 6d70 6f72 6172 7920 6469 7265 6374 6f72  mporary director
+0002aa10: 7920 7769 7468 2061 2066 696c 6520 696e  y with a file in
+0002aa20: 2069 740a 2020 2020 2020 2020 746d 705f   it.        tmp_
+0002aa30: 6469 7220 3d20 746d 705f 7061 7468 202f  dir = tmp_path /
+0002aa40: 2027 746d 702d 736f 7572 6365 270a 2020   'tmp-source'.  
+0002aa50: 2020 2020 2020 746d 705f 6469 722e 6d6b        tmp_dir.mk
+0002aa60: 6469 7228 290a 2020 2020 2020 2020 746d  dir().        tm
+0002aa70: 705f 6669 6c65 203d 2074 6d70 5f64 6972  p_file = tmp_dir
+0002aa80: 202f 2027 746d 702d 6669 6c65 270a 2020   / 'tmp-file'.  
+0002aa90: 2020 2020 2020 746d 705f 6669 6c65 2e77        tmp_file.w
+0002aaa0: 7269 7465 5f74 6578 7428 2774 6573 7427  rite_text('test'
+0002aab0: 290a 2020 2020 2020 2020 6369 7263 6c65  ).        circle
+0002aac0: 5f6c 696e 6b20 3d20 746d 705f 6469 7220  _link = tmp_dir 
+0002aad0: 2f20 2763 6972 636c 652d 6c69 6e6b 270a  / 'circle-link'.
+0002aae0: 2020 2020 2020 2020 6369 7263 6c65 5f6c          circle_l
+0002aaf0: 696e 6b2e 7379 6d6c 696e 6b5f 746f 2874  ink.symlink_to(t
+0002ab00: 6d70 5f64 6972 2c20 7461 7267 6574 5f69  mp_dir, target_i
+0002ab10: 735f 6469 7265 6374 6f72 793d 5472 7565  s_directory=True
+0002ab20: 290a 2020 2020 2020 2020 7969 656c 6420  ).        yield 
+0002ab30: 7374 7228 746d 705f 6469 7229 0a0a 2020  str(tmp_dir)..  
+0002ab40: 2020 4073 7461 7469 636d 6574 686f 640a    @staticmethod.
+0002ab50: 2020 2020 6465 6620 6765 6e65 7261 7465      def generate
+0002ab60: 5f62 7563 6b65 745f 6e61 6d65 2829 3a0a  _bucket_name():.
+0002ab70: 2020 2020 2020 2020 2320 4372 6561 7465          # Create
+0002ab80: 7320 6120 7465 6d70 6f72 6172 7920 6275  s a temporary bu
+0002ab90: 636b 6574 206e 616d 650a 2020 2020 2020  cket name.      
+0002aba0: 2020 2320 7469 6d65 2e74 696d 6528 2920    # time.time() 
+0002abb0: 7265 7475 726e 7320 7661 7279 696e 6720  returns varying 
+0002abc0: 7072 6563 6973 696f 6e20 6f6e 2064 6966  precision on dif
+0002abd0: 6665 7265 6e74 2073 7973 7465 6d73 2c20  ferent systems, 
+0002abe0: 736f 2077 650a 2020 2020 2020 2020 2320  so we.        # 
+0002abf0: 7265 706c 6163 6520 7468 6520 6465 6369  replace the deci
+0002ac00: 6d61 6c20 706f 696e 7420 616e 6420 7573  mal point and us
+0002ac10: 6520 7768 6174 6576 6572 2070 7265 6369  e whatever preci
+0002ac20: 7369 6f6e 2077 6520 6361 6e20 6765 742e  sion we can get.
+0002ac30: 0a20 2020 2020 2020 2074 696d 6573 7461  .        timesta
+0002ac40: 6d70 203d 2073 7472 2874 696d 652e 7469  mp = str(time.ti
+0002ac50: 6d65 2829 292e 7265 706c 6163 6528 272e  me()).replace('.
+0002ac60: 272c 2027 2729 0a20 2020 2020 2020 2072  ', '').        r
+0002ac70: 6574 7572 6e20 6627 736b 792d 7465 7374  eturn f'sky-test
+0002ac80: 2d7b 7469 6d65 7374 616d 707d 270a 0a20  -{timestamp}'.. 
+0002ac90: 2020 2040 7079 7465 7374 2e66 6978 7475     @pytest.fixtu
+0002aca0: 7265 0a20 2020 2064 6566 2074 6d70 5f62  re.    def tmp_b
+0002acb0: 7563 6b65 745f 6e61 6d65 2873 656c 6629  ucket_name(self)
+0002acc0: 3a0a 2020 2020 2020 2020 7969 656c 6420  :.        yield 
+0002acd0: 7365 6c66 2e67 656e 6572 6174 655f 6275  self.generate_bu
+0002ace0: 636b 6574 5f6e 616d 6528 290a 0a20 2020  cket_name()..   
+0002acf0: 2040 7374 6174 6963 6d65 7468 6f64 0a20   @staticmethod. 
+0002ad00: 2020 2064 6566 2079 6965 6c64 5f73 746f     def yield_sto
+0002ad10: 7261 6765 5f6f 626a 6563 7428 0a20 2020  rage_object(.   
+0002ad20: 2020 2020 2020 2020 206e 616d 653a 204f           name: O
+0002ad30: 7074 696f 6e61 6c5b 7374 725d 203d 204e  ptional[str] = N
+0002ad40: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
+0002ad50: 2073 6f75 7263 653a 204f 7074 696f 6e61   source: Optiona
+0002ad60: 6c5b 7374 6f72 6167 655f 6c69 622e 5061  l[storage_lib.Pa
+0002ad70: 7468 5d20 3d20 4e6f 6e65 2c0a 2020 2020  th] = None,.    
+0002ad80: 2020 2020 2020 2020 7374 6f72 6573 3a20          stores: 
+0002ad90: 4f70 7469 6f6e 616c 5b44 6963 745b 7374  Optional[Dict[st
+0002ada0: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
+0002adb0: 7970 652c 0a20 2020 2020 2020 2020 2020  ype,.           
+0002adc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002add0: 2020 2020 2020 2073 746f 7261 6765 5f6c         storage_l
+0002ade0: 6962 2e41 6273 7472 6163 7453 746f 7265  ib.AbstractStore
+0002adf0: 5d5d 203d 204e 6f6e 652c 0a20 2020 2020  ]] = None,.     
+0002ae00: 2020 2020 2020 2070 6572 7369 7374 656e         persisten
+0002ae10: 743a 204f 7074 696f 6e61 6c5b 626f 6f6c  t: Optional[bool
+0002ae20: 5d20 3d20 5472 7565 2c0a 2020 2020 2020  ] = True,.      
+0002ae30: 2020 2020 2020 6d6f 6465 3a20 7374 6f72        mode: stor
+0002ae40: 6167 655f 6c69 622e 5374 6f72 6167 654d  age_lib.StorageM
+0002ae50: 6f64 6520 3d20 7374 6f72 6167 655f 6c69  ode = storage_li
+0002ae60: 622e 5374 6f72 6167 654d 6f64 652e 4d4f  b.StorageMode.MO
+0002ae70: 554e 5429 3a0a 2020 2020 2020 2020 2320  UNT):.        # 
+0002ae80: 4372 6561 7465 7320 6120 7465 6d70 6f72  Creates a tempor
+0002ae90: 6172 7920 7374 6f72 6167 6520 6f62 6a65  ary storage obje
+0002aea0: 6374 2e20 5374 6f72 6573 206d 7573 7420  ct. Stores must 
+0002aeb0: 6265 2061 6464 6564 2069 6e20 7468 6520  be added in the 
+0002aec0: 7465 7374 2e0a 2020 2020 2020 2020 7374  test..        st
+0002aed0: 6f72 6167 655f 6f62 6a20 3d20 7374 6f72  orage_obj = stor
+0002aee0: 6167 655f 6c69 622e 5374 6f72 6167 6528  age_lib.Storage(
+0002aef0: 6e61 6d65 3d6e 616d 652c 0a20 2020 2020  name=name,.     
 0002af00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002af10: 2020 2020 2073 746f 7261 6765 5f6c 6962       storage_lib
-0002af20: 2e41 6273 7472 6163 7453 746f 7265 5d5d  .AbstractStore]]
-0002af30: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
-0002af40: 2020 2020 2070 6572 7369 7374 656e 743a       persistent:
-0002af50: 204f 7074 696f 6e61 6c5b 626f 6f6c 5d20   Optional[bool] 
-0002af60: 3d20 5472 7565 2c0a 2020 2020 2020 2020  = True,.        
-0002af70: 2020 2020 6d6f 6465 3a20 7374 6f72 6167      mode: storag
-0002af80: 655f 6c69 622e 5374 6f72 6167 654d 6f64  e_lib.StorageMod
-0002af90: 6520 3d20 7374 6f72 6167 655f 6c69 622e  e = storage_lib.
-0002afa0: 5374 6f72 6167 654d 6f64 652e 4d4f 554e  StorageMode.MOUN
-0002afb0: 5429 3a0a 2020 2020 2020 2020 2320 4372  T):.        # Cr
-0002afc0: 6561 7465 7320 6120 7465 6d70 6f72 6172  eates a temporar
-0002afd0: 7920 7374 6f72 6167 6520 6f62 6a65 6374  y storage object
-0002afe0: 2e20 5374 6f72 6573 206d 7573 7420 6265  . Stores must be
-0002aff0: 2061 6464 6564 2069 6e20 7468 6520 7465   added in the te
-0002b000: 7374 2e0a 2020 2020 2020 2020 7374 6f72  st..        stor
-0002b010: 6167 655f 6f62 6a20 3d20 7374 6f72 6167  age_obj = storag
-0002b020: 655f 6c69 622e 5374 6f72 6167 6528 6e61  e_lib.Storage(na
-0002b030: 6d65 3d6e 616d 652c 0a20 2020 2020 2020  me=name,.       
-0002b040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b060: 2020 2073 6f75 7263 653d 736f 7572 6365     source=source
-0002b070: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002b080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b090: 2020 2020 2020 2020 2020 2020 7374 6f72              stor
-0002b0a0: 6573 3d73 746f 7265 732c 0a20 2020 2020  es=stores,.     
-0002b0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b0d0: 2020 2020 2070 6572 7369 7374 656e 743d       persistent=
-0002b0e0: 7065 7273 6973 7465 6e74 2c0a 2020 2020  persistent,.    
-0002b0f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b110: 2020 2020 2020 6d6f 6465 3d6d 6f64 6529        mode=mode)
-0002b120: 0a20 2020 2020 2020 2079 6965 6c64 2073  .        yield s
-0002b130: 746f 7261 6765 5f6f 626a 0a20 2020 2020  torage_obj.     
-0002b140: 2020 2068 616e 646c 6520 3d20 676c 6f62     handle = glob
-0002b150: 616c 5f75 7365 725f 7374 6174 652e 6765  al_user_state.ge
-0002b160: 745f 6861 6e64 6c65 5f66 726f 6d5f 7374  t_handle_from_st
-0002b170: 6f72 6167 655f 6e61 6d65 280a 2020 2020  orage_name(.    
-0002b180: 2020 2020 2020 2020 7374 6f72 6167 655f          storage_
-0002b190: 6f62 6a2e 6e61 6d65 290a 2020 2020 2020  obj.name).      
-0002b1a0: 2020 6966 2068 616e 646c 653a 0a20 2020    if handle:.   
-0002b1b0: 2020 2020 2020 2020 2023 2049 6620 6861           # If ha
-0002b1c0: 6e64 6c65 2065 7869 7374 732c 2064 656c  ndle exists, del
-0002b1d0: 6574 6520 6d61 6e75 616c 6c79 0a20 2020  ete manually.   
-0002b1e0: 2020 2020 2020 2020 2023 2054 4f44 4f28           # TODO(
-0002b1f0: 726f 6d69 6c62 293a 2054 6869 7320 6973  romilb): This is
-0002b200: 2070 6f74 656e 7469 616c 6c79 2072 6973   potentially ris
-0002b210: 6b79 202d 2069 6620 7468 6520 6465 6c65  ky - if the dele
-0002b220: 7465 206d 6574 686f 6420 6861 730a 2020  te method has.  
-0002b230: 2020 2020 2020 2020 2020 2320 2020 6275            #   bu
-0002b240: 6773 2c20 7468 6973 2063 616e 2063 6175  gs, this can cau
-0002b250: 7365 2072 6573 6f75 7263 6520 6c65 616b  se resource leak
-0002b260: 732e 2049 6465 616c 6c79 2077 6520 7368  s. Ideally we sh
-0002b270: 6f75 6c64 206d 616e 7561 6c6c 790a 2020  ould manually.  
-0002b280: 2020 2020 2020 2020 2020 2320 2020 656a            #   ej
-0002b290: 6563 7420 7374 6f72 6167 6520 6672 6f6d  ect storage from
-0002b2a0: 2067 6c6f 6261 6c5f 7573 6572 5f73 7461   global_user_sta
-0002b2b0: 7465 2061 6e64 2064 656c 6574 6520 7468  te and delete th
-0002b2c0: 6520 6275 636b 6574 2075 7369 6e67 0a20  e bucket using. 
-0002b2d0: 2020 2020 2020 2020 2020 2023 2020 2062             #   b
-0002b2e0: 6f74 6f33 2064 6972 6563 746c 792e 0a20  oto3 directly.. 
-0002b2f0: 2020 2020 2020 2020 2020 2073 746f 7261             stora
-0002b300: 6765 5f6f 626a 2e64 656c 6574 6528 290a  ge_obj.delete().
-0002b310: 0a20 2020 2040 7079 7465 7374 2e66 6978  .    @pytest.fix
-0002b320: 7475 7265 0a20 2020 2064 6566 2074 6d70  ture.    def tmp
-0002b330: 5f73 6372 6174 6368 5f73 746f 7261 6765  _scratch_storage
-0002b340: 5f6f 626a 2873 656c 662c 2074 6d70 5f62  _obj(self, tmp_b
-0002b350: 7563 6b65 745f 6e61 6d65 293a 0a20 2020  ucket_name):.   
-0002b360: 2020 2020 2023 2043 7265 6174 6573 2061       # Creates a
-0002b370: 2073 746f 7261 6765 206f 626a 6563 7420   storage object 
-0002b380: 7769 7468 206e 6f20 736f 7572 6365 2074  with no source t
-0002b390: 6f20 6372 6561 7465 2061 2073 6372 6174  o create a scrat
-0002b3a0: 6368 2073 746f 7261 6765 2e0a 2020 2020  ch storage..    
-0002b3b0: 2020 2020 2320 5374 6f72 6573 206d 7573      # Stores mus
-0002b3c0: 7420 6265 2061 6464 6564 2069 6e20 7468  t be added in th
-0002b3d0: 6520 7465 7374 2e0a 2020 2020 2020 2020  e test..        
-0002b3e0: 7969 656c 6420 6672 6f6d 2073 656c 662e  yield from self.
-0002b3f0: 7969 656c 645f 7374 6f72 6167 655f 6f62  yield_storage_ob
-0002b400: 6a65 6374 286e 616d 653d 746d 705f 6275  ject(name=tmp_bu
-0002b410: 636b 6574 5f6e 616d 6529 0a0a 2020 2020  cket_name)..    
-0002b420: 4070 7974 6573 742e 6669 7874 7572 650a  @pytest.fixture.
-0002b430: 2020 2020 6465 6620 746d 705f 6d75 6c74      def tmp_mult
-0002b440: 6970 6c65 5f73 6372 6174 6368 5f73 746f  iple_scratch_sto
-0002b450: 7261 6765 5f6f 626a 2873 656c 6629 3a0a  rage_obj(self):.
-0002b460: 2020 2020 2020 2020 2320 4372 6561 7465          # Create
-0002b470: 7320 6120 6c69 7374 206f 6620 3520 7374  s a list of 5 st
-0002b480: 6f72 6167 6520 6f62 6a65 6374 7320 7769  orage objects wi
-0002b490: 7468 206e 6f20 736f 7572 6365 2074 6f20  th no source to 
-0002b4a0: 6372 6561 7465 0a20 2020 2020 2020 2023  create.        #
-0002b4b0: 206d 756c 7469 706c 6520 7363 7261 7463   multiple scratc
-0002b4c0: 6820 7374 6f72 6167 6573 2e0a 2020 2020  h storages..    
-0002b4d0: 2020 2020 2320 5374 6f72 6573 2066 6f72      # Stores for
-0002b4e0: 2065 6163 6820 6f62 6a65 6374 2069 6e20   each object in 
-0002b4f0: 7468 6520 6c69 7374 206d 7573 7420 6265  the list must be
-0002b500: 2061 6464 6564 2069 6e20 7468 6520 7465   added in the te
-0002b510: 7374 2e0a 2020 2020 2020 2020 7374 6f72  st..        stor
-0002b520: 6167 655f 6d75 6c74 5f6f 626a 203d 205b  age_mult_obj = [
-0002b530: 5d0a 2020 2020 2020 2020 666f 7220 5f20  ].        for _ 
-0002b540: 696e 2072 616e 6765 2835 293a 0a20 2020  in range(5):.   
-0002b550: 2020 2020 2020 2020 2074 696d 6573 7461           timesta
-0002b560: 6d70 203d 2073 7472 2874 696d 652e 7469  mp = str(time.ti
-0002b570: 6d65 2829 292e 7265 706c 6163 6528 272e  me()).replace('.
-0002b580: 272c 2027 2729 0a20 2020 2020 2020 2020  ', '').         
-0002b590: 2020 2073 746f 7265 5f6f 626a 203d 2073     store_obj = s
-0002b5a0: 746f 7261 6765 5f6c 6962 2e53 746f 7261  torage_lib.Stora
-0002b5b0: 6765 286e 616d 653d 6627 736b 792d 7465  ge(name=f'sky-te
-0002b5c0: 7374 2d7b 7469 6d65 7374 616d 707d 2729  st-{timestamp}')
-0002b5d0: 0a20 2020 2020 2020 2020 2020 2073 746f  .            sto
-0002b5e0: 7261 6765 5f6d 756c 745f 6f62 6a2e 6170  rage_mult_obj.ap
-0002b5f0: 7065 6e64 2873 746f 7265 5f6f 626a 290a  pend(store_obj).
-0002b600: 2020 2020 2020 2020 7969 656c 6420 7374          yield st
-0002b610: 6f72 6167 655f 6d75 6c74 5f6f 626a 0a20  orage_mult_obj. 
-0002b620: 2020 2020 2020 2066 6f72 2073 746f 7261         for stora
-0002b630: 6765 5f6f 626a 2069 6e20 7374 6f72 6167  ge_obj in storag
-0002b640: 655f 6d75 6c74 5f6f 626a 3a0a 2020 2020  e_mult_obj:.    
-0002b650: 2020 2020 2020 2020 6861 6e64 6c65 203d          handle =
-0002b660: 2067 6c6f 6261 6c5f 7573 6572 5f73 7461   global_user_sta
-0002b670: 7465 2e67 6574 5f68 616e 646c 655f 6672  te.get_handle_fr
-0002b680: 6f6d 5f73 746f 7261 6765 5f6e 616d 6528  om_storage_name(
-0002b690: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002b6a0: 2073 746f 7261 6765 5f6f 626a 2e6e 616d   storage_obj.nam
-0002b6b0: 6529 0a20 2020 2020 2020 2020 2020 2069  e).            i
-0002b6c0: 6620 6861 6e64 6c65 3a0a 2020 2020 2020  f handle:.      
-0002b6d0: 2020 2020 2020 2020 2020 2320 4966 2068            # If h
-0002b6e0: 616e 646c 6520 6578 6973 7473 2c20 6465  andle exists, de
-0002b6f0: 6c65 7465 206d 616e 7561 6c6c 790a 2020  lete manually.  
-0002b700: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0002b710: 544f 444f 2872 6f6d 696c 6229 3a20 5468  TODO(romilb): Th
-0002b720: 6973 2069 7320 706f 7465 6e74 6961 6c6c  is is potentiall
-0002b730: 7920 7269 736b 7920 2d20 6966 2074 6865  y risky - if the
-0002b740: 2064 656c 6574 6520 6d65 7468 6f64 2068   delete method h
-0002b750: 6173 0a20 2020 2020 2020 2020 2020 2020  as.             
-0002b760: 2020 2023 2062 7567 732c 2074 6869 7320     # bugs, this 
-0002b770: 6361 6e20 6361 7573 6520 7265 736f 7572  can cause resour
-0002b780: 6365 206c 6561 6b73 2e20 4964 6561 6c6c  ce leaks. Ideall
-0002b790: 7920 7765 2073 686f 756c 6420 6d61 6e75  y we should manu
-0002b7a0: 616c 6c79 0a20 2020 2020 2020 2020 2020  ally.           
-0002b7b0: 2020 2020 2023 2065 6a65 6374 2073 746f       # eject sto
-0002b7c0: 7261 6765 2066 726f 6d20 676c 6f62 616c  rage from global
-0002b7d0: 5f75 7365 725f 7374 6174 6520 616e 6420  _user_state and 
-0002b7e0: 6465 6c65 7465 2074 6865 2062 7563 6b65  delete the bucke
-0002b7f0: 7420 7573 696e 670a 2020 2020 2020 2020  t using.        
-0002b800: 2020 2020 2020 2020 2320 626f 746f 3320          # boto3 
-0002b810: 6469 7265 6374 6c79 2e0a 2020 2020 2020  directly..      
-0002b820: 2020 2020 2020 2020 2020 7374 6f72 6167            storag
-0002b830: 655f 6f62 6a2e 6465 6c65 7465 2829 0a0a  e_obj.delete()..
-0002b840: 2020 2020 4070 7974 6573 742e 6669 7874      @pytest.fixt
-0002b850: 7572 650a 2020 2020 6465 6620 746d 705f  ure.    def tmp_
-0002b860: 6d75 6c74 6970 6c65 5f63 7573 746f 6d5f  multiple_custom_
-0002b870: 736f 7572 6365 5f73 746f 7261 6765 5f6f  source_storage_o
-0002b880: 626a 2873 656c 6629 3a0a 2020 2020 2020  bj(self):.      
-0002b890: 2020 2320 4372 6561 7465 7320 6120 6c69    # Creates a li
-0002b8a0: 7374 206f 6620 7374 6f72 6167 6520 6f62  st of storage ob
-0002b8b0: 6a65 6374 7320 7769 7468 2063 7573 746f  jects with custo
-0002b8c0: 6d20 736f 7572 6365 206e 616d 6573 2074  m source names t
-0002b8d0: 6f0a 2020 2020 2020 2020 2320 6372 6561  o.        # crea
-0002b8e0: 7465 206d 756c 7469 706c 6520 7363 7261  te multiple scra
-0002b8f0: 7463 6820 7374 6f72 6167 6573 2e0a 2020  tch storages..  
-0002b900: 2020 2020 2020 2320 5374 6f72 6573 2066        # Stores f
-0002b910: 6f72 2065 6163 6820 6f62 6a65 6374 2069  or each object i
-0002b920: 6e20 7468 6520 6c69 7374 206d 7573 7420  n the list must 
-0002b930: 6265 2061 6464 6564 2069 6e20 7468 6520  be added in the 
-0002b940: 7465 7374 2e0a 2020 2020 2020 2020 6375  test..        cu
-0002b950: 7374 6f6d 5f73 6f75 7263 655f 6e61 6d65  stom_source_name
-0002b960: 7320 3d20 5b27 2270 6174 6820 5769 7468  s = ['"path With
-0002b970: 2053 7061 6365 7322 272c 2027 7061 7468   Spaces"', 'path
-0002b980: 2057 6974 6820 5370 6163 6573 275d 0a20   With Spaces']. 
-0002b990: 2020 2020 2020 2073 746f 7261 6765 5f6d         storage_m
-0002b9a0: 756c 745f 6f62 6a20 3d20 5b5d 0a20 2020  ult_obj = [].   
-0002b9b0: 2020 2020 2066 6f72 206e 616d 6520 696e       for name in
-0002b9c0: 2063 7573 746f 6d5f 736f 7572 6365 5f6e   custom_source_n
-0002b9d0: 616d 6573 3a0a 2020 2020 2020 2020 2020  ames:.          
-0002b9e0: 2020 7372 635f 7061 7468 203d 206f 732e    src_path = os.
-0002b9f0: 7061 7468 2e65 7870 616e 6475 7365 7228  path.expanduser(
-0002ba00: 6627 7e2f 7b6e 616d 657d 2729 0a20 2020  f'~/{name}').   
-0002ba10: 2020 2020 2020 2020 2070 6174 686c 6962           pathlib
-0002ba20: 2e50 6174 6828 7372 635f 7061 7468 292e  .Path(src_path).
-0002ba30: 6578 7061 6e64 7573 6572 2829 2e6d 6b64  expanduser().mkd
-0002ba40: 6972 2865 7869 7374 5f6f 6b3d 5472 7565  ir(exist_ok=True
-0002ba50: 290a 2020 2020 2020 2020 2020 2020 7469  ).            ti
-0002ba60: 6d65 7374 616d 7020 3d20 7374 7228 7469  mestamp = str(ti
-0002ba70: 6d65 2e74 696d 6528 2929 2e72 6570 6c61  me.time()).repla
-0002ba80: 6365 2827 2e27 2c20 2727 290a 2020 2020  ce('.', '').    
-0002ba90: 2020 2020 2020 2020 7374 6f72 655f 6f62          store_ob
-0002baa0: 6a20 3d20 7374 6f72 6167 655f 6c69 622e  j = storage_lib.
-0002bab0: 5374 6f72 6167 6528 6e61 6d65 3d66 2773  Storage(name=f's
-0002bac0: 6b79 2d74 6573 742d 7b74 696d 6573 7461  ky-test-{timesta
-0002bad0: 6d70 7d27 2c0a 2020 2020 2020 2020 2020  mp}',.          
-0002bae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002baf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bb00: 2020 736f 7572 6365 3d73 7263 5f70 6174    source=src_pat
-0002bb10: 6829 0a20 2020 2020 2020 2020 2020 2073  h).            s
-0002bb20: 746f 7261 6765 5f6d 756c 745f 6f62 6a2e  torage_mult_obj.
-0002bb30: 6170 7065 6e64 2873 746f 7265 5f6f 626a  append(store_obj
-0002bb40: 290a 2020 2020 2020 2020 7969 656c 6420  ).        yield 
-0002bb50: 7374 6f72 6167 655f 6d75 6c74 5f6f 626a  storage_mult_obj
-0002bb60: 0a20 2020 2020 2020 2066 6f72 2073 746f  .        for sto
-0002bb70: 7261 6765 5f6f 626a 2069 6e20 7374 6f72  rage_obj in stor
-0002bb80: 6167 655f 6d75 6c74 5f6f 626a 3a0a 2020  age_mult_obj:.  
-0002bb90: 2020 2020 2020 2020 2020 6861 6e64 6c65            handle
-0002bba0: 203d 2067 6c6f 6261 6c5f 7573 6572 5f73   = global_user_s
-0002bbb0: 7461 7465 2e67 6574 5f68 616e 646c 655f  tate.get_handle_
-0002bbc0: 6672 6f6d 5f73 746f 7261 6765 5f6e 616d  from_storage_nam
-0002bbd0: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
-0002bbe0: 2020 2073 746f 7261 6765 5f6f 626a 2e6e     storage_obj.n
-0002bbf0: 616d 6529 0a20 2020 2020 2020 2020 2020  ame).           
-0002bc00: 2069 6620 6861 6e64 6c65 3a0a 2020 2020   if handle:.    
-0002bc10: 2020 2020 2020 2020 2020 2020 7374 6f72              stor
-0002bc20: 6167 655f 6f62 6a2e 6465 6c65 7465 2829  age_obj.delete()
-0002bc30: 0a0a 2020 2020 4070 7974 6573 742e 6669  ..    @pytest.fi
-0002bc40: 7874 7572 650a 2020 2020 6465 6620 746d  xture.    def tm
-0002bc50: 705f 6c6f 6361 6c5f 7374 6f72 6167 655f  p_local_storage_
-0002bc60: 6f62 6a28 7365 6c66 2c20 746d 705f 6275  obj(self, tmp_bu
-0002bc70: 636b 6574 5f6e 616d 652c 2074 6d70 5f73  cket_name, tmp_s
-0002bc80: 6f75 7263 6529 3a0a 2020 2020 2020 2020  ource):.        
-0002bc90: 2320 4372 6561 7465 7320 6120 7465 6d70  # Creates a temp
-0002bca0: 6f72 6172 7920 7374 6f72 6167 6520 6f62  orary storage ob
-0002bcb0: 6a65 6374 2e20 5374 6f72 6573 206d 7573  ject. Stores mus
-0002bcc0: 7420 6265 2061 6464 6564 2069 6e20 7468  t be added in th
-0002bcd0: 6520 7465 7374 2e0a 2020 2020 2020 2020  e test..        
-0002bce0: 7969 656c 6420 6672 6f6d 2073 656c 662e  yield from self.
-0002bcf0: 7969 656c 645f 7374 6f72 6167 655f 6f62  yield_storage_ob
-0002bd00: 6a65 6374 286e 616d 653d 746d 705f 6275  ject(name=tmp_bu
-0002bd10: 636b 6574 5f6e 616d 652c 0a20 2020 2020  cket_name,.     
-0002bd20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bd30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bd40: 2020 2020 2020 2020 736f 7572 6365 3d74          source=t
-0002bd50: 6d70 5f73 6f75 7263 6529 0a0a 2020 2020  mp_source)..    
-0002bd60: 4070 7974 6573 742e 6669 7874 7572 650a  @pytest.fixture.
-0002bd70: 2020 2020 6465 6620 746d 705f 6c6f 6361      def tmp_loca
-0002bd80: 6c5f 6c69 7374 5f73 746f 7261 6765 5f6f  l_list_storage_o
-0002bd90: 626a 2873 656c 662c 2074 6d70 5f62 7563  bj(self, tmp_buc
-0002bda0: 6b65 745f 6e61 6d65 2c20 746d 705f 736f  ket_name, tmp_so
-0002bdb0: 7572 6365 293a 0a20 2020 2020 2020 2023  urce):.        #
-0002bdc0: 2043 7265 6174 6573 2061 2074 656d 7020   Creates a temp 
-0002bdd0: 7374 6f72 6167 6520 6f62 6a65 6374 2077  storage object w
-0002bde0: 6869 6368 2075 7365 7320 6120 6c69 7374  hich uses a list
-0002bdf0: 206f 6620 7061 7468 7320 6173 2073 6f75   of paths as sou
-0002be00: 7263 652e 0a20 2020 2020 2020 2023 2053  rce..        # S
-0002be10: 746f 7265 7320 6d75 7374 2062 6520 6164  tores must be ad
-0002be20: 6465 6420 696e 2074 6865 2074 6573 742e  ded in the test.
-0002be30: 2041 6674 6572 2075 706c 6f61 642c 2074   After upload, t
-0002be40: 6865 2062 7563 6b65 7420 7368 6f75 6c64  he bucket should
-0002be50: 0a20 2020 2020 2020 2023 2068 6176 6520  .        # have 
-0002be60: 7477 6f20 6669 6c65 7320 2d20 2f74 6d70  two files - /tmp
-0002be70: 2d66 696c 6520 616e 6420 2f74 6d70 2d73  -file and /tmp-s
-0002be80: 6f75 7263 652f 746d 702d 6669 6c65 0a20  ource/tmp-file. 
-0002be90: 2020 2020 2020 206c 6973 745f 736f 7572         list_sour
-0002bea0: 6365 203d 205b 746d 705f 736f 7572 6365  ce = [tmp_source
-0002beb0: 2c20 746d 705f 736f 7572 6365 202b 2027  , tmp_source + '
-0002bec0: 2f74 6d70 2d66 696c 6527 5d0a 2020 2020  /tmp-file'].    
-0002bed0: 2020 2020 7969 656c 6420 6672 6f6d 2073      yield from s
-0002bee0: 656c 662e 7969 656c 645f 7374 6f72 6167  elf.yield_storag
-0002bef0: 655f 6f62 6a65 6374 286e 616d 653d 746d  e_object(name=tm
-0002bf00: 705f 6275 636b 6574 5f6e 616d 652c 0a20  p_bucket_name,. 
-0002bf10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bf20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bf30: 2020 2020 2020 2020 2020 2020 736f 7572              sour
-0002bf40: 6365 3d6c 6973 745f 736f 7572 6365 290a  ce=list_source).
-0002bf50: 0a20 2020 2040 7079 7465 7374 2e66 6978  .    @pytest.fix
-0002bf60: 7475 7265 0a20 2020 2064 6566 2074 6d70  ture.    def tmp
-0002bf70: 5f62 756c 6b5f 6465 6c5f 7374 6f72 6167  _bulk_del_storag
-0002bf80: 655f 6f62 6a28 7365 6c66 2c20 746d 705f  e_obj(self, tmp_
-0002bf90: 6275 636b 6574 5f6e 616d 6529 3a0a 2020  bucket_name):.  
-0002bfa0: 2020 2020 2020 2320 4372 6561 7465 7320        # Creates 
-0002bfb0: 6120 7465 6d70 6f72 6172 7920 7374 6f72  a temporary stor
-0002bfc0: 6167 6520 6f62 6a65 6374 2066 6f72 2074  age object for t
-0002bfd0: 6573 7469 6e67 2062 756c 6b20 6465 6c65  esting bulk dele
-0002bfe0: 7469 6f6e 2e0a 2020 2020 2020 2020 2320  tion..        # 
-0002bff0: 5374 6f72 6573 206d 7573 7420 6265 2061  Stores must be a
-0002c000: 6464 6564 2069 6e20 7468 6520 7465 7374  dded in the test
-0002c010: 2e0a 2020 2020 2020 2020 7769 7468 2074  ..        with t
-0002c020: 656d 7066 696c 652e 5465 6d70 6f72 6172  empfile.Temporar
-0002c030: 7944 6972 6563 746f 7279 2829 2061 7320  yDirectory() as 
-0002c040: 746d 7064 6972 3a0a 2020 2020 2020 2020  tmpdir:.        
-0002c050: 2020 2020 7375 6270 726f 6365 7373 2e63      subprocess.c
-0002c060: 6865 636b 5f6f 7574 7075 7428 6627 6d6b  heck_output(f'mk
-0002c070: 6469 7220 2d70 207b 746d 7064 6972 7d2f  dir -p {tmpdir}/
-0002c080: 666f 6c64 6572 7b7b 3030 302e 2e32 3535  folder{{000..255
-0002c090: 7d7d 272c 0a20 2020 2020 2020 2020 2020  }}',.           
-0002c0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c0b0: 2020 2020 2020 2020 2073 6865 6c6c 3d54           shell=T
-0002c0c0: 7275 6529 0a20 2020 2020 2020 2020 2020  rue).           
-0002c0d0: 2073 7562 7072 6f63 6573 732e 6368 6563   subprocess.chec
-0002c0e0: 6b5f 6f75 7470 7574 2866 2774 6f75 6368  k_output(f'touch
-0002c0f0: 207b 746d 7064 6972 7d2f 7465 7374 7b7b   {tmpdir}/test{{
-0002c100: 3030 302e 2e32 3535 7d7d 2e74 7874 272c  000..255}}.txt',
-0002c110: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002c120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c130: 2020 2020 2073 6865 6c6c 3d54 7275 6529       shell=True)
-0002c140: 0a20 2020 2020 2020 2020 2020 2073 7562  .            sub
-0002c150: 7072 6f63 6573 732e 6368 6563 6b5f 6f75  process.check_ou
-0002c160: 7470 7574 280a 2020 2020 2020 2020 2020  tput(.          
-0002c170: 2020 2020 2020 6627 746f 7563 6820 7b74        f'touch {t
-0002c180: 6d70 6469 727d 2f66 6f6c 6465 727b 7b30  mpdir}/folder{{0
-0002c190: 3030 2e2e 3235 357d 7d2f 7465 7374 2e74  00..255}}/test.t
-0002c1a0: 7874 272c 2073 6865 6c6c 3d54 7275 6529  xt', shell=True)
-0002c1b0: 0a20 2020 2020 2020 2020 2020 2079 6965  .            yie
-0002c1c0: 6c64 2066 726f 6d20 7365 6c66 2e79 6965  ld from self.yie
-0002c1d0: 6c64 5f73 746f 7261 6765 5f6f 626a 6563  ld_storage_objec
-0002c1e0: 7428 6e61 6d65 3d74 6d70 5f62 7563 6b65  t(name=tmp_bucke
-0002c1f0: 745f 6e61 6d65 2c0a 2020 2020 2020 2020  t_name,.        
-0002c200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c220: 2020 2020 2020 2020 2073 6f75 7263 653d           source=
-0002c230: 746d 7064 6972 290a 0a20 2020 2040 7079  tmpdir)..    @py
-0002c240: 7465 7374 2e66 6978 7475 7265 0a20 2020  test.fixture.   
-0002c250: 2064 6566 2074 6d70 5f63 6f70 795f 6d6e   def tmp_copy_mn
-0002c260: 745f 6578 6973 7469 6e67 5f73 746f 7261  t_existing_stora
-0002c270: 6765 5f6f 626a 2873 656c 662c 2074 6d70  ge_obj(self, tmp
-0002c280: 5f73 6372 6174 6368 5f73 746f 7261 6765  _scratch_storage
-0002c290: 5f6f 626a 293a 0a20 2020 2020 2020 2023  _obj):.        #
-0002c2a0: 2043 7265 6174 6573 2061 2063 6f70 7920   Creates a copy 
-0002c2b0: 6d6f 756e 7420 7374 6f72 6167 6520 7768  mount storage wh
-0002c2c0: 6963 6820 7265 7573 6573 2061 6e20 6578  ich reuses an ex
-0002c2d0: 6973 7469 6e67 2073 746f 7261 6765 206f  isting storage o
-0002c2e0: 626a 6563 742e 0a20 2020 2020 2020 2074  bject..        t
-0002c2f0: 6d70 5f73 6372 6174 6368 5f73 746f 7261  mp_scratch_stora
-0002c300: 6765 5f6f 626a 2e61 6464 5f73 746f 7265  ge_obj.add_store
-0002c310: 2873 746f 7261 6765 5f6c 6962 2e53 746f  (storage_lib.Sto
-0002c320: 7265 5479 7065 2e53 3329 0a20 2020 2020  reType.S3).     
-0002c330: 2020 2073 746f 7261 6765 5f6e 616d 6520     storage_name 
-0002c340: 3d20 746d 705f 7363 7261 7463 685f 7374  = tmp_scratch_st
-0002c350: 6f72 6167 655f 6f62 6a2e 6e61 6d65 0a0a  orage_obj.name..
-0002c360: 2020 2020 2020 2020 2320 5472 7920 746f          # Try to
-0002c370: 2069 6e69 7469 616c 697a 6520 616e 6f74   initialize anot
-0002c380: 6865 7220 7374 6f72 6167 6520 7769 7468  her storage with
-0002c390: 2074 6865 2073 746f 7261 6765 206f 626a   the storage obj
-0002c3a0: 6563 7420 6372 6561 7465 640a 2020 2020  ect created.    
-0002c3b0: 2020 2020 2320 6162 6f76 652c 2062 7574      # above, but
-0002c3c0: 206e 6f77 2069 6e20 434f 5059 206d 6f64   now in COPY mod
-0002c3d0: 652e 2054 6869 7320 7368 6f75 6c64 2073  e. This should s
-0002c3e0: 7563 6365 6564 2e0a 2020 2020 2020 2020  ucceed..        
-0002c3f0: 7969 656c 6420 6672 6f6d 2073 656c 662e  yield from self.
-0002c400: 7969 656c 645f 7374 6f72 6167 655f 6f62  yield_storage_ob
-0002c410: 6a65 6374 286e 616d 653d 7374 6f72 6167  ject(name=storag
-0002c420: 655f 6e61 6d65 2c0a 2020 2020 2020 2020  e_name,.        
-0002c430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c450: 2020 2020 206d 6f64 653d 7374 6f72 6167       mode=storag
-0002c460: 655f 6c69 622e 5374 6f72 6167 654d 6f64  e_lib.StorageMod
-0002c470: 652e 434f 5059 290a 0a20 2020 2040 7079  e.COPY)..    @py
-0002c480: 7465 7374 2e66 6978 7475 7265 0a20 2020  test.fixture.   
-0002c490: 2064 6566 2074 6d70 5f67 6974 6967 6e6f   def tmp_gitigno
-0002c4a0: 7265 5f73 746f 7261 6765 5f6f 626a 2873  re_storage_obj(s
-0002c4b0: 656c 662c 2074 6d70 5f62 7563 6b65 745f  elf, tmp_bucket_
-0002c4c0: 6e61 6d65 2c20 6769 7469 676e 6f72 655f  name, gitignore_
-0002c4d0: 7374 7275 6374 7572 6529 3a0a 2020 2020  structure):.    
-0002c4e0: 2020 2020 2320 4372 6561 7465 7320 6120      # Creates a 
-0002c4f0: 7465 6d70 6f72 6172 7920 7374 6f72 6167  temporary storag
-0002c500: 6520 6f62 6a65 6374 2066 6f72 2074 6573  e object for tes
-0002c510: 7469 6e67 202e 6769 7469 676e 6f72 6520  ting .gitignore 
-0002c520: 6669 6c74 6572 2e0a 2020 2020 2020 2020  filter..        
-0002c530: 2320 4749 5449 4749 4e4f 5245 5f53 5452  # GITIGINORE_STR
-0002c540: 5543 5455 5245 2069 7320 7265 7072 6573  UCTURE is repres
-0002c550: 656e 7469 6e67 2061 2066 696c 6520 7374  enting a file st
-0002c560: 7275 6374 7572 6520 696e 2061 2064 6963  ructure in a dic
-0002c570: 7469 6f6e 6172 790a 2020 2020 2020 2020  tionary.        
-0002c580: 2320 666f 726d 6174 2e20 4372 6561 7465  # format. Create
-0002c590: 6420 7374 6f72 6167 6520 6f62 6a65 6374  d storage object
-0002c5a0: 2077 696c 6c20 636f 6e74 6169 6e20 7468   will contain th
-0002c5b0: 6520 6669 6c65 2073 7472 7563 7475 7265  e file structure
-0002c5c0: 2061 6c6f 6e67 0a20 2020 2020 2020 2023   along.        #
-0002c5d0: 2077 6974 6820 2e67 6974 6967 6e6f 7265   with .gitignore
-0002c5e0: 2061 6e64 202e 6769 742f 696e 666f 2f65   and .git/info/e
-0002c5f0: 7863 6c75 6465 2066 696c 6573 2074 6f20  xclude files to 
-0002c600: 7465 7374 2065 7863 6c75 6465 2066 696c  test exclude fil
-0002c610: 7465 722e 0a20 2020 2020 2020 2023 2053  ter..        # S
-0002c620: 746f 7265 7320 6d75 7374 2062 6520 6164  tores must be ad
-0002c630: 6465 6420 696e 2074 6865 2074 6573 742e  ded in the test.
-0002c640: 0a20 2020 2020 2020 2077 6974 6820 7465  .        with te
-0002c650: 6d70 6669 6c65 2e54 656d 706f 7261 7279  mpfile.Temporary
-0002c660: 4469 7265 6374 6f72 7928 2920 6173 2074  Directory() as t
-0002c670: 6d70 6469 723a 0a20 2020 2020 2020 2020  mpdir:.         
-0002c680: 2020 2023 2043 7265 6174 6573 2066 696c     # Creates fil
-0002c690: 6520 7374 7275 6374 7572 6520 746f 2062  e structure to b
-0002c6a0: 6520 7570 6c6f 6164 6564 2069 6e20 7468  e uploaded in th
-0002c6b0: 6520 5374 6f72 6167 650a 2020 2020 2020  e Storage.      
-0002c6c0: 2020 2020 2020 7365 6c66 2e63 7265 6174        self.creat
-0002c6d0: 655f 6469 725f 7374 7275 6374 7572 6528  e_dir_structure(
-0002c6e0: 746d 7064 6972 2c20 6769 7469 676e 6f72  tmpdir, gitignor
-0002c6f0: 655f 7374 7275 6374 7572 6529 0a0a 2020  e_structure)..  
-0002c700: 2020 2020 2020 2020 2020 2320 4372 6561            # Crea
-0002c710: 7465 202e 6769 7469 676e 6f72 6520 616e  te .gitignore an
-0002c720: 6420 6c69 7374 2066 696c 6573 2f64 6972  d list files/dir
-0002c730: 7320 746f 2062 6520 6578 636c 7564 6564  s to be excluded
-0002c740: 2069 6e20 6974 0a20 2020 2020 2020 2020   in it.         
-0002c750: 2020 2073 6b79 7069 6c6f 745f 7061 7468     skypilot_path
-0002c760: 203d 206f 732e 7061 7468 2e64 6972 6e61   = os.path.dirna
-0002c770: 6d65 286f 732e 7061 7468 2e64 6972 6e61  me(os.path.dirna
-0002c780: 6d65 2873 6b79 2e5f 5f66 696c 655f 5f29  me(sky.__file__)
-0002c790: 290a 2020 2020 2020 2020 2020 2020 7465  ).            te
-0002c7a0: 6d70 5f70 6174 6820 3d20 6627 7b74 6d70  mp_path = f'{tmp
-0002c7b0: 6469 727d 2f2e 6769 7469 676e 6f72 6527  dir}/.gitignore'
-0002c7c0: 0a20 2020 2020 2020 2020 2020 2066 696c  .            fil
-0002c7d0: 655f 7061 7468 203d 206f 732e 7061 7468  e_path = os.path
-0002c7e0: 2e6a 6f69 6e28 736b 7970 696c 6f74 5f70  .join(skypilot_p
-0002c7f0: 6174 682c 2027 7465 7374 732f 6769 7469  ath, 'tests/giti
-0002c800: 676e 6f72 655f 7465 7374 2729 0a20 2020  gnore_test').   
-0002c810: 2020 2020 2020 2020 2073 6875 7469 6c2e           shutil.
-0002c820: 636f 7079 6669 6c65 2866 696c 655f 7061  copyfile(file_pa
-0002c830: 7468 2c20 7465 6d70 5f70 6174 6829 0a0a  th, temp_path)..
-0002c840: 2020 2020 2020 2020 2020 2020 2320 4372              # Cr
-0002c850: 6561 7465 202e 6769 742f 696e 666f 2f65  eate .git/info/e
-0002c860: 7863 6c75 6465 2061 6e64 206c 6973 7420  xclude and list 
-0002c870: 6669 6c65 732f 6469 7273 2074 6f20 6265  files/dirs to be
-0002c880: 2065 7863 6c75 6465 6420 696e 2069 740a   excluded in it.
-0002c890: 2020 2020 2020 2020 2020 2020 7465 6d70              temp
-0002c8a0: 5f70 6174 6820 3d20 6627 7b74 6d70 6469  _path = f'{tmpdi
-0002c8b0: 727d 2f2e 6769 742f 696e 666f 2f27 0a20  r}/.git/info/'. 
-0002c8c0: 2020 2020 2020 2020 2020 206f 732e 6d61             os.ma
-0002c8d0: 6b65 6469 7273 2874 656d 705f 7061 7468  kedirs(temp_path
-0002c8e0: 290a 2020 2020 2020 2020 2020 2020 7465  ).            te
-0002c8f0: 6d70 5f65 7863 6c75 6465 5f70 6174 6820  mp_exclude_path 
-0002c900: 3d20 6f73 2e70 6174 682e 6a6f 696e 2874  = os.path.join(t
-0002c910: 656d 705f 7061 7468 2c20 2765 7863 6c75  emp_path, 'exclu
-0002c920: 6465 2729 0a20 2020 2020 2020 2020 2020  de').           
-0002c930: 2066 696c 655f 7061 7468 203d 206f 732e   file_path = os.
-0002c940: 7061 7468 2e6a 6f69 6e28 736b 7970 696c  path.join(skypil
-0002c950: 6f74 5f70 6174 682c 0a20 2020 2020 2020  ot_path,.       
-0002c960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c970: 2020 2020 2020 2020 2020 2020 2020 2774                't
-0002c980: 6573 7473 2f67 6974 5f69 6e66 6f5f 6578  ests/git_info_ex
-0002c990: 636c 7564 655f 7465 7374 2729 0a20 2020  clude_test').   
-0002c9a0: 2020 2020 2020 2020 2073 6875 7469 6c2e           shutil.
-0002c9b0: 636f 7079 6669 6c65 2866 696c 655f 7061  copyfile(file_pa
-0002c9c0: 7468 2c20 7465 6d70 5f65 7863 6c75 6465  th, temp_exclude
-0002c9d0: 5f70 6174 6829 0a0a 2020 2020 2020 2020  _path)..        
-0002c9e0: 2020 2020 2320 4372 6561 7465 2073 6b79      # Create sky
-0002c9f0: 2053 746f 7261 6765 2077 6974 6820 7468   Storage with th
-0002ca00: 6520 6669 6c65 7320 6372 6561 7465 640a  e files created.
-0002ca10: 2020 2020 2020 2020 2020 2020 7969 656c              yiel
-0002ca20: 6420 6672 6f6d 2073 656c 662e 7969 656c  d from self.yiel
-0002ca30: 645f 7374 6f72 6167 655f 6f62 6a65 6374  d_storage_object
-0002ca40: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0002ca50: 2020 6e61 6d65 3d74 6d70 5f62 7563 6b65    name=tmp_bucke
-0002ca60: 745f 6e61 6d65 2c0a 2020 2020 2020 2020  t_name,.        
-0002ca70: 2020 2020 2020 2020 736f 7572 6365 3d74          source=t
-0002ca80: 6d70 6469 722c 0a20 2020 2020 2020 2020  mpdir,.         
-0002ca90: 2020 2020 2020 206d 6f64 653d 7374 6f72         mode=stor
-0002caa0: 6167 655f 6c69 622e 5374 6f72 6167 654d  age_lib.StorageM
-0002cab0: 6f64 652e 434f 5059 290a 0a20 2020 2040  ode.COPY)..    @
-0002cac0: 7079 7465 7374 2e66 6978 7475 7265 0a20  pytest.fixture. 
-0002cad0: 2020 2064 6566 2074 6d70 5f61 7773 636c     def tmp_awscl
-0002cae0: 695f 6275 636b 6574 2873 656c 662c 2074  i_bucket(self, t
-0002caf0: 6d70 5f62 7563 6b65 745f 6e61 6d65 293a  mp_bucket_name):
-0002cb00: 0a20 2020 2020 2020 2023 2043 7265 6174  .        # Creat
-0002cb10: 6573 2061 2074 656d 706f 7261 7279 2062  es a temporary b
-0002cb20: 7563 6b65 7420 7573 696e 6720 6177 7363  ucket using awsc
-0002cb30: 6c69 0a20 2020 2020 2020 2062 7563 6b65  li.        bucke
-0002cb40: 745f 7572 6920 3d20 6627 7333 3a2f 2f7b  t_uri = f's3://{
-0002cb50: 746d 705f 6275 636b 6574 5f6e 616d 657d  tmp_bucket_name}
-0002cb60: 270a 2020 2020 2020 2020 7375 6270 726f  '.        subpro
-0002cb70: 6365 7373 2e63 6865 636b 5f63 616c 6c28  cess.check_call(
-0002cb80: 5b27 6177 7327 2c20 2773 3327 2c20 276d  ['aws', 's3', 'm
-0002cb90: 6227 2c20 6275 636b 6574 5f75 7269 5d29  b', bucket_uri])
-0002cba0: 0a20 2020 2020 2020 2079 6965 6c64 2074  .        yield t
-0002cbb0: 6d70 5f62 7563 6b65 745f 6e61 6d65 2c20  mp_bucket_name, 
-0002cbc0: 6275 636b 6574 5f75 7269 0a20 2020 2020  bucket_uri.     
-0002cbd0: 2020 2073 7562 7072 6f63 6573 732e 6368     subprocess.ch
-0002cbe0: 6563 6b5f 6361 6c6c 285b 2761 7773 272c  eck_call(['aws',
-0002cbf0: 2027 7333 272c 2027 7262 272c 2062 7563   's3', 'rb', buc
-0002cc00: 6b65 745f 7572 692c 2027 2d2d 666f 7263  ket_uri, '--forc
-0002cc10: 6527 5d29 0a0a 2020 2020 4070 7974 6573  e'])..    @pytes
-0002cc20: 742e 6669 7874 7572 650a 2020 2020 6465  t.fixture.    de
-0002cc30: 6620 746d 705f 6773 7574 696c 5f62 7563  f tmp_gsutil_buc
-0002cc40: 6b65 7428 7365 6c66 2c20 746d 705f 6275  ket(self, tmp_bu
-0002cc50: 636b 6574 5f6e 616d 6529 3a0a 2020 2020  cket_name):.    
-0002cc60: 2020 2020 2320 4372 6561 7465 7320 6120      # Creates a 
-0002cc70: 7465 6d70 6f72 6172 7920 6275 636b 6574  temporary bucket
-0002cc80: 2075 7369 6e67 2067 7375 7469 6c0a 2020   using gsutil.  
-0002cc90: 2020 2020 2020 6275 636b 6574 5f75 7269        bucket_uri
-0002cca0: 203d 2066 2767 733a 2f2f 7b74 6d70 5f62   = f'gs://{tmp_b
-0002ccb0: 7563 6b65 745f 6e61 6d65 7d27 0a20 2020  ucket_name}'.   
-0002ccc0: 2020 2020 2073 7562 7072 6f63 6573 732e       subprocess.
-0002ccd0: 6368 6563 6b5f 6361 6c6c 285b 2767 7375  check_call(['gsu
-0002cce0: 7469 6c27 2c20 276d 6227 2c20 6275 636b  til', 'mb', buck
-0002ccf0: 6574 5f75 7269 5d29 0a20 2020 2020 2020  et_uri]).       
-0002cd00: 2079 6965 6c64 2074 6d70 5f62 7563 6b65   yield tmp_bucke
-0002cd10: 745f 6e61 6d65 2c20 6275 636b 6574 5f75  t_name, bucket_u
-0002cd20: 7269 0a20 2020 2020 2020 2073 7562 7072  ri.        subpr
-0002cd30: 6f63 6573 732e 6368 6563 6b5f 6361 6c6c  ocess.check_call
-0002cd40: 285b 2767 7375 7469 6c27 2c20 2772 6d27  (['gsutil', 'rm'
-0002cd50: 2c20 272d 7227 2c20 6275 636b 6574 5f75  , '-r', bucket_u
-0002cd60: 7269 5d29 0a0a 2020 2020 4070 7974 6573  ri])..    @pytes
-0002cd70: 742e 6669 7874 7572 650a 2020 2020 6465  t.fixture.    de
-0002cd80: 6620 746d 705f 6177 7363 6c69 5f62 7563  f tmp_awscli_buc
-0002cd90: 6b65 745f 7232 2873 656c 662c 2074 6d70  ket_r2(self, tmp
-0002cda0: 5f62 7563 6b65 745f 6e61 6d65 293a 0a20  _bucket_name):. 
-0002cdb0: 2020 2020 2020 2023 2043 7265 6174 6573         # Creates
-0002cdc0: 2061 2074 656d 706f 7261 7279 2062 7563   a temporary buc
-0002cdd0: 6b65 7420 7573 696e 6720 6177 7363 6c69  ket using awscli
-0002cde0: 0a20 2020 2020 2020 2065 6e64 706f 696e  .        endpoin
-0002cdf0: 745f 7572 6c20 3d20 636c 6f75 6466 6c61  t_url = cloudfla
-0002ce00: 7265 2e63 7265 6174 655f 656e 6470 6f69  re.create_endpoi
-0002ce10: 6e74 2829 0a20 2020 2020 2020 2062 7563  nt().        buc
-0002ce20: 6b65 745f 7572 6920 3d20 6627 7333 3a2f  ket_uri = f's3:/
-0002ce30: 2f7b 746d 705f 6275 636b 6574 5f6e 616d  /{tmp_bucket_nam
-0002ce40: 657d 270a 2020 2020 2020 2020 7375 6270  e}'.        subp
-0002ce50: 726f 6365 7373 2e63 6865 636b 5f63 616c  rocess.check_cal
-0002ce60: 6c28 0a20 2020 2020 2020 2020 2020 2066  l(.            f
-0002ce70: 2741 5753 5f53 4841 5245 445f 4352 4544  'AWS_SHARED_CRED
-0002ce80: 454e 5449 414c 535f 4649 4c45 3d7b 636c  ENTIALS_FILE={cl
-0002ce90: 6f75 6466 6c61 7265 2e52 325f 4352 4544  oudflare.R2_CRED
-0002cea0: 454e 5449 414c 535f 5041 5448 7d20 6177  ENTIALS_PATH} aw
-0002ceb0: 7320 7333 206d 6220 7b62 7563 6b65 745f  s s3 mb {bucket_
-0002cec0: 7572 697d 202d 2d65 6e64 706f 696e 7420  uri} --endpoint 
-0002ced0: 7b65 6e64 706f 696e 745f 7572 6c7d 202d  {endpoint_url} -
-0002cee0: 2d70 726f 6669 6c65 3d72 3227 2c0a 2020  -profile=r2',.  
-0002cef0: 2020 2020 2020 2020 2020 7368 656c 6c3d            shell=
-0002cf00: 5472 7565 290a 2020 2020 2020 2020 7969  True).        yi
-0002cf10: 656c 6420 746d 705f 6275 636b 6574 5f6e  eld tmp_bucket_n
-0002cf20: 616d 652c 2062 7563 6b65 745f 7572 690a  ame, bucket_uri.
-0002cf30: 2020 2020 2020 2020 7375 6270 726f 6365          subproce
-0002cf40: 7373 2e63 6865 636b 5f63 616c 6c28 0a20  ss.check_call(. 
-0002cf50: 2020 2020 2020 2020 2020 2066 2741 5753             f'AWS
-0002cf60: 5f53 4841 5245 445f 4352 4544 454e 5449  _SHARED_CREDENTI
-0002cf70: 414c 535f 4649 4c45 3d7b 636c 6f75 6466  ALS_FILE={cloudf
-0002cf80: 6c61 7265 2e52 325f 4352 4544 454e 5449  lare.R2_CREDENTI
-0002cf90: 414c 535f 5041 5448 7d20 6177 7320 7333  ALS_PATH} aws s3
-0002cfa0: 2072 6220 7b62 7563 6b65 745f 7572 697d   rb {bucket_uri}
-0002cfb0: 202d 2d66 6f72 6365 202d 2d65 6e64 706f   --force --endpo
-0002cfc0: 696e 7420 7b65 6e64 706f 696e 745f 7572  int {endpoint_ur
-0002cfd0: 6c7d 202d 2d70 726f 6669 6c65 3d72 3227  l} --profile=r2'
-0002cfe0: 2c0a 2020 2020 2020 2020 2020 2020 7368  ,.            sh
-0002cff0: 656c 6c3d 5472 7565 290a 0a20 2020 2040  ell=True)..    @
-0002d000: 7079 7465 7374 2e66 6978 7475 7265 0a20  pytest.fixture. 
-0002d010: 2020 2064 6566 2074 6d70 5f69 626d 5f63     def tmp_ibm_c
-0002d020: 6f73 5f62 7563 6b65 7428 7365 6c66 2c20  os_bucket(self, 
-0002d030: 746d 705f 6275 636b 6574 5f6e 616d 6529  tmp_bucket_name)
-0002d040: 3a0a 2020 2020 2020 2020 2320 4372 6561  :.        # Crea
-0002d050: 7465 7320 6120 7465 6d70 6f72 6172 7920  tes a temporary 
-0002d060: 6275 636b 6574 2075 7369 6e67 2049 424d  bucket using IBM
-0002d070: 2043 4f53 2041 5049 0a20 2020 2020 2020   COS API.       
-0002d080: 2073 746f 7261 6765 5f6f 626a 203d 2073   storage_obj = s
-0002d090: 746f 7261 6765 5f6c 6962 2e49 424d 436f  torage_lib.IBMCo
-0002d0a0: 7353 746f 7265 2873 6f75 7263 653d 2222  sStore(source=""
-0002d0b0: 2c20 6e61 6d65 3d74 6d70 5f62 7563 6b65  , name=tmp_bucke
-0002d0c0: 745f 6e61 6d65 290a 2020 2020 2020 2020  t_name).        
-0002d0d0: 7969 656c 6420 746d 705f 6275 636b 6574  yield tmp_bucket
-0002d0e0: 5f6e 616d 650a 2020 2020 2020 2020 7374  _name.        st
-0002d0f0: 6f72 6167 655f 6f62 6a2e 6465 6c65 7465  orage_obj.delete
-0002d100: 2829 0a0a 2020 2020 4070 7974 6573 742e  ()..    @pytest.
-0002d110: 6669 7874 7572 650a 2020 2020 6465 6620  fixture.    def 
-0002d120: 746d 705f 7075 626c 6963 5f73 746f 7261  tmp_public_stora
-0002d130: 6765 5f6f 626a 2873 656c 662c 2072 6571  ge_obj(self, req
-0002d140: 7565 7374 293a 0a20 2020 2020 2020 2023  uest):.        #
-0002d150: 2049 6e69 7469 616c 697a 6573 2061 2073   Initializes a s
-0002d160: 746f 7261 6765 206f 626a 6563 7420 7769  torage object wi
-0002d170: 7468 2061 2070 7562 6c69 6320 6275 636b  th a public buck
-0002d180: 6574 0a20 2020 2020 2020 2073 746f 7261  et.        stora
-0002d190: 6765 5f6f 626a 203d 2073 746f 7261 6765  ge_obj = storage
-0002d1a0: 5f6c 6962 2e53 746f 7261 6765 2873 6f75  _lib.Storage(sou
-0002d1b0: 7263 653d 7265 7175 6573 742e 7061 7261  rce=request.para
-0002d1c0: 6d29 0a20 2020 2020 2020 2079 6965 6c64  m).        yield
-0002d1d0: 2073 746f 7261 6765 5f6f 626a 0a20 2020   storage_obj.   
-0002d1e0: 2020 2020 2023 2054 6869 7320 646f 6573       # This does
-0002d1f0: 206e 6f74 2072 6571 7569 7265 2061 6e79   not require any
-0002d200: 2064 656c 6574 696f 6e20 6c6f 6769 6320   deletion logic 
-0002d210: 6265 6361 7573 6520 6974 2069 7320 6120  because it is a 
-0002d220: 7075 626c 6963 2062 7563 6b65 740a 2020  public bucket.  
-0002d230: 2020 2020 2020 2320 616e 6420 7368 6f75        # and shou
-0002d240: 6c64 206e 6f74 2067 6574 2061 6464 6564  ld not get added
-0002d250: 2074 6f20 676c 6f62 616c 5f75 7365 725f   to global_user_
-0002d260: 7374 6174 652e 0a0a 2020 2020 4070 7974  state...    @pyt
-0002d270: 6573 742e 6d61 726b 2e6e 6f5f 666c 7569  est.mark.no_flui
-0002d280: 6473 7461 636b 0a20 2020 2040 7079 7465  dstack.    @pyte
-0002d290: 7374 2e6d 6172 6b2e 7061 7261 6d65 7472  st.mark.parametr
-0002d2a0: 697a 6528 2773 746f 7265 5f74 7970 6527  ize('store_type'
-0002d2b0: 2c20 5b0a 2020 2020 2020 2020 7374 6f72  , [.        stor
-0002d2c0: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
-0002d2d0: 652e 5333 2c20 7374 6f72 6167 655f 6c69  e.S3, storage_li
-0002d2e0: 622e 5374 6f72 6554 7970 652e 4743 532c  b.StoreType.GCS,
-0002d2f0: 0a20 2020 2020 2020 2070 7974 6573 742e  .        pytest.
-0002d300: 7061 7261 6d28 7374 6f72 6167 655f 6c69  param(storage_li
-0002d310: 622e 5374 6f72 6554 7970 652e 4942 4d2c  b.StoreType.IBM,
-0002d320: 206d 6172 6b73 3d70 7974 6573 742e 6d61   marks=pytest.ma
-0002d330: 726b 2e69 626d 292c 0a20 2020 2020 2020  rk.ibm),.       
-0002d340: 2070 7974 6573 742e 7061 7261 6d28 7374   pytest.param(st
-0002d350: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
-0002d360: 7970 652e 5232 2c20 6d61 726b 733d 7079  ype.R2, marks=py
-0002d370: 7465 7374 2e6d 6172 6b2e 636c 6f75 6466  test.mark.cloudf
-0002d380: 6c61 7265 290a 2020 2020 5d29 0a20 2020  lare).    ]).   
-0002d390: 2064 6566 2074 6573 745f 6e65 775f 6275   def test_new_bu
-0002d3a0: 636b 6574 5f63 7265 6174 696f 6e5f 616e  cket_creation_an
-0002d3b0: 645f 6465 6c65 7469 6f6e 2873 656c 662c  d_deletion(self,
-0002d3c0: 2074 6d70 5f6c 6f63 616c 5f73 746f 7261   tmp_local_stora
-0002d3d0: 6765 5f6f 626a 2c0a 2020 2020 2020 2020  ge_obj,.        
-0002d3e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d400: 2020 2020 2020 7374 6f72 655f 7479 7065        store_type
-0002d410: 293a 0a20 2020 2020 2020 2023 2043 7265  ):.        # Cre
-0002d420: 6174 6573 2061 206e 6577 2062 7563 6b65  ates a new bucke
-0002d430: 7420 7769 7468 2061 206c 6f63 616c 2073  t with a local s
-0002d440: 6f75 7263 652c 2075 706c 6f61 6473 2066  ource, uploads f
-0002d450: 696c 6573 2074 6f20 6974 0a20 2020 2020  iles to it.     
-0002d460: 2020 2023 2061 6e64 2064 656c 6574 6573     # and deletes
-0002d470: 2069 742e 0a20 2020 2020 2020 2074 6d70   it..        tmp
-0002d480: 5f6c 6f63 616c 5f73 746f 7261 6765 5f6f  _local_storage_o
-0002d490: 626a 2e61 6464 5f73 746f 7265 2873 746f  bj.add_store(sto
-0002d4a0: 7265 5f74 7970 6529 0a0a 2020 2020 2020  re_type)..      
-0002d4b0: 2020 2320 5275 6e20 736b 7920 7374 6f72    # Run sky stor
-0002d4c0: 6167 6520 6c73 2074 6f20 6368 6563 6b20  age ls to check 
-0002d4d0: 6966 2073 746f 7261 6765 206f 626a 6563  if storage objec
-0002d4e0: 7420 6578 6973 7473 2069 6e20 7468 6520  t exists in the 
-0002d4f0: 6f75 7470 7574 0a20 2020 2020 2020 206f  output.        o
-0002d500: 7574 203d 2073 7562 7072 6f63 6573 732e  ut = subprocess.
-0002d510: 6368 6563 6b5f 6f75 7470 7574 285b 2773  check_output(['s
-0002d520: 6b79 272c 2027 7374 6f72 6167 6527 2c20  ky', 'storage', 
-0002d530: 276c 7327 5d29 0a20 2020 2020 2020 2061  'ls']).        a
-0002d540: 7373 6572 7420 746d 705f 6c6f 6361 6c5f  ssert tmp_local_
-0002d550: 7374 6f72 6167 655f 6f62 6a2e 6e61 6d65  storage_obj.name
-0002d560: 2069 6e20 6f75 742e 6465 636f 6465 2827   in out.decode('
-0002d570: 7574 662d 3827 290a 0a20 2020 2020 2020  utf-8')..       
-0002d580: 2023 2052 756e 2073 6b79 2073 746f 7261   # Run sky stora
-0002d590: 6765 2064 656c 6574 6520 746f 2064 656c  ge delete to del
-0002d5a0: 6574 6520 7468 6520 7374 6f72 6167 6520  ete the storage 
-0002d5b0: 6f62 6a65 6374 0a20 2020 2020 2020 2073  object.        s
-0002d5c0: 7562 7072 6f63 6573 732e 6368 6563 6b5f  ubprocess.check_
-0002d5d0: 6f75 7470 7574 280a 2020 2020 2020 2020  output(.        
-0002d5e0: 2020 2020 5b27 736b 7927 2c20 2773 746f      ['sky', 'sto
-0002d5f0: 7261 6765 272c 2027 6465 6c65 7465 272c  rage', 'delete',
-0002d600: 2074 6d70 5f6c 6f63 616c 5f73 746f 7261   tmp_local_stora
-0002d610: 6765 5f6f 626a 2e6e 616d 652c 2027 2d2d  ge_obj.name, '--
-0002d620: 7965 7327 5d29 0a0a 2020 2020 2020 2020  yes'])..        
-0002d630: 2320 5275 6e20 736b 7920 7374 6f72 6167  # Run sky storag
-0002d640: 6520 6c73 2074 6f20 6368 6563 6b20 6966  e ls to check if
-0002d650: 2073 746f 7261 6765 206f 626a 6563 7420   storage object 
-0002d660: 6973 2064 656c 6574 6564 0a20 2020 2020  is deleted.     
-0002d670: 2020 206f 7574 203d 2073 7562 7072 6f63     out = subproc
-0002d680: 6573 732e 6368 6563 6b5f 6f75 7470 7574  ess.check_output
-0002d690: 285b 2773 6b79 272c 2027 7374 6f72 6167  (['sky', 'storag
-0002d6a0: 6527 2c20 276c 7327 5d29 0a20 2020 2020  e', 'ls']).     
-0002d6b0: 2020 2061 7373 6572 7420 746d 705f 6c6f     assert tmp_lo
-0002d6c0: 6361 6c5f 7374 6f72 6167 655f 6f62 6a2e  cal_storage_obj.
-0002d6d0: 6e61 6d65 206e 6f74 2069 6e20 6f75 742e  name not in out.
-0002d6e0: 6465 636f 6465 2827 7574 662d 3827 290a  decode('utf-8').
-0002d6f0: 0a20 2020 2040 7079 7465 7374 2e6d 6172  .    @pytest.mar
-0002d700: 6b2e 6e6f 5f66 6c75 6964 7374 6163 6b0a  k.no_fluidstack.
-0002d710: 2020 2020 4070 7974 6573 742e 6d61 726b      @pytest.mark
-0002d720: 2e78 6469 7374 5f67 726f 7570 2827 6d75  .xdist_group('mu
-0002d730: 6c74 6970 6c65 5f62 7563 6b65 745f 6465  ltiple_bucket_de
-0002d740: 6c65 7469 6f6e 2729 0a20 2020 2040 7079  letion').    @py
-0002d750: 7465 7374 2e6d 6172 6b2e 7061 7261 6d65  test.mark.parame
-0002d760: 7472 697a 6528 2773 746f 7265 5f74 7970  trize('store_typ
-0002d770: 6527 2c20 5b0a 2020 2020 2020 2020 7374  e', [.        st
-0002d780: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
-0002d790: 7970 652e 5333 2c20 7374 6f72 6167 655f  ype.S3, storage_
-0002d7a0: 6c69 622e 5374 6f72 6554 7970 652e 4743  lib.StoreType.GC
-0002d7b0: 532c 0a20 2020 2020 2020 2070 7974 6573  S,.        pytes
-0002d7c0: 742e 7061 7261 6d28 7374 6f72 6167 655f  t.param(storage_
-0002d7d0: 6c69 622e 5374 6f72 6554 7970 652e 5232  lib.StoreType.R2
-0002d7e0: 2c20 6d61 726b 733d 7079 7465 7374 2e6d  , marks=pytest.m
-0002d7f0: 6172 6b2e 636c 6f75 6466 6c61 7265 292c  ark.cloudflare),
-0002d800: 0a20 2020 2020 2020 2070 7974 6573 742e  .        pytest.
-0002d810: 7061 7261 6d28 7374 6f72 6167 655f 6c69  param(storage_li
-0002d820: 622e 5374 6f72 6554 7970 652e 4942 4d2c  b.StoreType.IBM,
-0002d830: 206d 6172 6b73 3d70 7974 6573 742e 6d61   marks=pytest.ma
-0002d840: 726b 2e69 626d 290a 2020 2020 5d29 0a20  rk.ibm).    ]). 
-0002d850: 2020 2064 6566 2074 6573 745f 6d75 6c74     def test_mult
-0002d860: 6970 6c65 5f62 7563 6b65 7473 5f63 7265  iple_buckets_cre
-0002d870: 6174 696f 6e5f 616e 645f 6465 6c65 7469  ation_and_deleti
-0002d880: 6f6e 280a 2020 2020 2020 2020 2020 2020  on(.            
-0002d890: 7365 6c66 2c20 746d 705f 6d75 6c74 6970  self, tmp_multip
-0002d8a0: 6c65 5f73 6372 6174 6368 5f73 746f 7261  le_scratch_stora
-0002d8b0: 6765 5f6f 626a 2c20 7374 6f72 655f 7479  ge_obj, store_ty
-0002d8c0: 7065 293a 0a20 2020 2020 2020 2023 2043  pe):.        # C
-0002d8d0: 7265 6174 6573 206d 756c 7469 706c 6520  reates multiple 
-0002d8e0: 6e65 7720 6275 636b 6574 7328 3520 6275  new buckets(5 bu
-0002d8f0: 636b 6574 7329 2077 6974 6820 6120 6c6f  ckets) with a lo
-0002d900: 6361 6c20 736f 7572 6365 0a20 2020 2020  cal source.     
-0002d910: 2020 2023 2061 6e64 2064 656c 6574 6573     # and deletes
-0002d920: 2074 6865 6d2e 0a20 2020 2020 2020 2073   them..        s
-0002d930: 746f 7261 6765 5f6f 626a 5f6e 616d 6520  torage_obj_name 
-0002d940: 3d20 5b5d 0a20 2020 2020 2020 2066 6f72  = [].        for
-0002d950: 2073 746f 7265 5f6f 626a 2069 6e20 746d   store_obj in tm
-0002d960: 705f 6d75 6c74 6970 6c65 5f73 6372 6174  p_multiple_scrat
-0002d970: 6368 5f73 746f 7261 6765 5f6f 626a 3a0a  ch_storage_obj:.
-0002d980: 2020 2020 2020 2020 2020 2020 7374 6f72              stor
-0002d990: 655f 6f62 6a2e 6164 645f 7374 6f72 6528  e_obj.add_store(
-0002d9a0: 7374 6f72 655f 7479 7065 290a 2020 2020  store_type).    
-0002d9b0: 2020 2020 2020 2020 7374 6f72 6167 655f          storage_
-0002d9c0: 6f62 6a5f 6e61 6d65 2e61 7070 656e 6428  obj_name.append(
-0002d9d0: 7374 6f72 655f 6f62 6a2e 6e61 6d65 290a  store_obj.name).
-0002d9e0: 0a20 2020 2020 2020 2023 2052 756e 2073  .        # Run s
-0002d9f0: 6b79 2073 746f 7261 6765 206c 7320 746f  ky storage ls to
-0002da00: 2063 6865 636b 2069 6620 616c 6c20 7374   check if all st
-0002da10: 6f72 6167 6520 6f62 6a65 6374 7320 6578  orage objects ex
-0002da20: 6973 7473 2069 6e20 7468 650a 2020 2020  ists in the.    
-0002da30: 2020 2020 2320 6f75 7470 7574 2066 696c      # output fil
-0002da40: 7465 7265 6420 6279 2073 746f 7265 2074  tered by store t
-0002da50: 7970 650a 2020 2020 2020 2020 6f75 745f  ype.        out_
-0002da60: 616c 6c20 3d20 7375 6270 726f 6365 7373  all = subprocess
-0002da70: 2e63 6865 636b 5f6f 7574 7075 7428 5b27  .check_output(['
-0002da80: 736b 7927 2c20 2773 746f 7261 6765 272c  sky', 'storage',
-0002da90: 2027 6c73 275d 290a 2020 2020 2020 2020   'ls']).        
-0002daa0: 6f75 7420 3d20 5b0a 2020 2020 2020 2020  out = [.        
-0002dab0: 2020 2020 6974 656d 2e73 706c 6974 2829      item.split()
-0002dac0: 5b30 5d0a 2020 2020 2020 2020 2020 2020  [0].            
-0002dad0: 666f 7220 6974 656d 2069 6e20 6f75 745f  for item in out_
-0002dae0: 616c 6c2e 6465 636f 6465 2827 7574 662d  all.decode('utf-
-0002daf0: 3827 292e 7370 6c69 746c 696e 6573 2829  8').splitlines()
-0002db00: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0002db10: 7374 6f72 655f 7479 7065 2e76 616c 7565  store_type.value
-0002db20: 2069 6e20 6974 656d 0a20 2020 2020 2020   in item.       
-0002db30: 205d 0a20 2020 2020 2020 2061 7373 6572   ].        asser
-0002db40: 7420 616c 6c28 5b69 7465 6d20 696e 206f  t all([item in o
-0002db50: 7574 2066 6f72 2069 7465 6d20 696e 2073  ut for item in s
-0002db60: 746f 7261 6765 5f6f 626a 5f6e 616d 655d  torage_obj_name]
-0002db70: 290a 0a20 2020 2020 2020 2023 2052 756e  )..        # Run
-0002db80: 2073 6b79 2073 746f 7261 6765 2064 656c   sky storage del
-0002db90: 6574 6520 616c 6c20 746f 2064 656c 6574  ete all to delet
-0002dba0: 6520 616c 6c20 7374 6f72 6167 6520 6f62  e all storage ob
-0002dbb0: 6a65 6374 730a 2020 2020 2020 2020 6465  jects.        de
-0002dbc0: 6c65 7465 5f63 6d64 203d 205b 2773 6b79  lete_cmd = ['sky
-0002dbd0: 272c 2027 7374 6f72 6167 6527 2c20 2764  ', 'storage', 'd
-0002dbe0: 656c 6574 6527 2c20 272d 2d79 6573 275d  elete', '--yes']
-0002dbf0: 0a20 2020 2020 2020 2064 656c 6574 655f  .        delete_
-0002dc00: 636d 6420 2b3d 2073 746f 7261 6765 5f6f  cmd += storage_o
-0002dc10: 626a 5f6e 616d 650a 2020 2020 2020 2020  bj_name.        
-0002dc20: 7375 6270 726f 6365 7373 2e63 6865 636b  subprocess.check
-0002dc30: 5f6f 7574 7075 7428 6465 6c65 7465 5f63  _output(delete_c
-0002dc40: 6d64 290a 0a20 2020 2020 2020 2023 2052  md)..        # R
-0002dc50: 756e 2073 6b79 2073 746f 7261 6765 206c  un sky storage l
-0002dc60: 7320 746f 2063 6865 636b 2069 6620 616c  s to check if al
-0002dc70: 6c20 7374 6f72 6167 6520 6f62 6a65 6374  l storage object
-0002dc80: 7320 6669 6c74 6572 6564 2062 7920 7374  s filtered by st
-0002dc90: 6f72 650a 2020 2020 2020 2020 2320 7479  ore.        # ty
-0002dca0: 7065 2061 7265 2064 656c 6574 6564 0a20  pe are deleted. 
-0002dcb0: 2020 2020 2020 206f 7574 5f61 6c6c 203d         out_all =
-0002dcc0: 2073 7562 7072 6f63 6573 732e 6368 6563   subprocess.chec
-0002dcd0: 6b5f 6f75 7470 7574 285b 2773 6b79 272c  k_output(['sky',
-0002dce0: 2027 7374 6f72 6167 6527 2c20 276c 7327   'storage', 'ls'
-0002dcf0: 5d29 0a20 2020 2020 2020 206f 7574 203d  ]).        out =
-0002dd00: 205b 0a20 2020 2020 2020 2020 2020 2069   [.            i
-0002dd10: 7465 6d2e 7370 6c69 7428 295b 305d 0a20  tem.split()[0]. 
-0002dd20: 2020 2020 2020 2020 2020 2066 6f72 2069             for i
-0002dd30: 7465 6d20 696e 206f 7574 5f61 6c6c 2e64  tem in out_all.d
-0002dd40: 6563 6f64 6528 2775 7466 2d38 2729 2e73  ecode('utf-8').s
-0002dd50: 706c 6974 6c69 6e65 7328 290a 2020 2020  plitlines().    
-0002dd60: 2020 2020 2020 2020 6966 2073 746f 7265          if store
-0002dd70: 5f74 7970 652e 7661 6c75 6520 696e 2069  _type.value in i
-0002dd80: 7465 6d0a 2020 2020 2020 2020 5d0a 2020  tem.        ].  
-0002dd90: 2020 2020 2020 6173 7365 7274 2061 6c6c        assert all
-0002dda0: 285b 6974 656d 206e 6f74 2069 6e20 6f75  ([item not in ou
-0002ddb0: 7420 666f 7220 6974 656d 2069 6e20 7374  t for item in st
-0002ddc0: 6f72 6167 655f 6f62 6a5f 6e61 6d65 5d29  orage_obj_name])
-0002ddd0: 0a0a 2020 2020 4070 7974 6573 742e 6d61  ..    @pytest.ma
-0002dde0: 726b 2e6e 6f5f 666c 7569 6473 7461 636b  rk.no_fluidstack
-0002ddf0: 0a20 2020 2040 7079 7465 7374 2e6d 6172  .    @pytest.mar
-0002de00: 6b2e 7061 7261 6d65 7472 697a 6528 2773  k.parametrize('s
-0002de10: 746f 7265 5f74 7970 6527 2c20 5b0a 2020  tore_type', [.  
-0002de20: 2020 2020 2020 7374 6f72 6167 655f 6c69        storage_li
-0002de30: 622e 5374 6f72 6554 7970 652e 5333 2c20  b.StoreType.S3, 
-0002de40: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
-0002de50: 6554 7970 652e 4743 532c 0a20 2020 2020  eType.GCS,.     
-0002de60: 2020 2070 7974 6573 742e 7061 7261 6d28     pytest.param(
-0002de70: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
-0002de80: 6554 7970 652e 4942 4d2c 206d 6172 6b73  eType.IBM, marks
-0002de90: 3d70 7974 6573 742e 6d61 726b 2e69 626d  =pytest.mark.ibm
-0002dea0: 292c 0a20 2020 2020 2020 2070 7974 6573  ),.        pytes
-0002deb0: 742e 7061 7261 6d28 7374 6f72 6167 655f  t.param(storage_
-0002dec0: 6c69 622e 5374 6f72 6554 7970 652e 5232  lib.StoreType.R2
-0002ded0: 2c20 6d61 726b 733d 7079 7465 7374 2e6d  , marks=pytest.m
-0002dee0: 6172 6b2e 636c 6f75 6466 6c61 7265 290a  ark.cloudflare).
-0002def0: 2020 2020 5d29 0a20 2020 2064 6566 2074      ]).    def t
-0002df00: 6573 745f 7570 6c6f 6164 5f73 6f75 7263  est_upload_sourc
-0002df10: 655f 7769 7468 5f73 7061 6365 7328 7365  e_with_spaces(se
-0002df20: 6c66 2c20 7374 6f72 655f 7479 7065 2c0a  lf, store_type,.
-0002df30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002df40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002df50: 2020 2020 2020 2074 6d70 5f6d 756c 7469         tmp_multi
-0002df60: 706c 655f 6375 7374 6f6d 5f73 6f75 7263  ple_custom_sourc
-0002df70: 655f 7374 6f72 6167 655f 6f62 6a29 3a0a  e_storage_obj):.
-0002df80: 2020 2020 2020 2020 2320 4372 6561 7465          # Create
-0002df90: 7320 7477 6f20 6275 636b 6574 7320 7769  s two buckets wi
-0002dfa0: 7468 2073 7065 6369 6669 6564 206c 6f63  th specified loc
-0002dfb0: 616c 2073 6f75 7263 6573 0a20 2020 2020  al sources.     
-0002dfc0: 2020 2023 2077 6974 6820 7370 6163 6573     # with spaces
-0002dfd0: 2069 6e20 7468 6520 6e61 6d65 0a20 2020   in the name.   
-0002dfe0: 2020 2020 2073 746f 7261 6765 5f6f 626a       storage_obj
-0002dff0: 5f6e 616d 6573 203d 205b 5d0a 2020 2020  _names = [].    
-0002e000: 2020 2020 666f 7220 7374 6f72 6167 655f      for storage_
-0002e010: 6f62 6a20 696e 2074 6d70 5f6d 756c 7469  obj in tmp_multi
-0002e020: 706c 655f 6375 7374 6f6d 5f73 6f75 7263  ple_custom_sourc
-0002e030: 655f 7374 6f72 6167 655f 6f62 6a3a 0a20  e_storage_obj:. 
-0002e040: 2020 2020 2020 2020 2020 2073 746f 7261             stora
-0002e050: 6765 5f6f 626a 2e61 6464 5f73 746f 7265  ge_obj.add_store
-0002e060: 2873 746f 7265 5f74 7970 6529 0a20 2020  (store_type).   
-0002e070: 2020 2020 2020 2020 2073 746f 7261 6765           storage
-0002e080: 5f6f 626a 5f6e 616d 6573 2e61 7070 656e  _obj_names.appen
-0002e090: 6428 7374 6f72 6167 655f 6f62 6a2e 6e61  d(storage_obj.na
-0002e0a0: 6d65 290a 0a20 2020 2020 2020 2023 2052  me)..        # R
-0002e0b0: 756e 2073 6b79 2073 746f 7261 6765 206c  un sky storage l
-0002e0c0: 7320 746f 2063 6865 636b 2069 6620 616c  s to check if al
-0002e0d0: 6c20 7374 6f72 6167 6520 6f62 6a65 6374  l storage object
-0002e0e0: 7320 6578 6973 7473 2069 6e20 7468 650a  s exists in the.
-0002e0f0: 2020 2020 2020 2020 2320 6f75 7470 7574          # output
-0002e100: 2066 696c 7465 7265 6420 6279 2073 746f   filtered by sto
-0002e110: 7265 2074 7970 650a 2020 2020 2020 2020  re type.        
-0002e120: 6f75 745f 616c 6c20 3d20 7375 6270 726f  out_all = subpro
-0002e130: 6365 7373 2e63 6865 636b 5f6f 7574 7075  cess.check_outpu
-0002e140: 7428 5b27 736b 7927 2c20 2773 746f 7261  t(['sky', 'stora
-0002e150: 6765 272c 2027 6c73 275d 290a 2020 2020  ge', 'ls']).    
-0002e160: 2020 2020 6f75 7420 3d20 5b0a 2020 2020      out = [.    
-0002e170: 2020 2020 2020 2020 6974 656d 2e73 706c          item.spl
-0002e180: 6974 2829 5b30 5d0a 2020 2020 2020 2020  it()[0].        
-0002e190: 2020 2020 666f 7220 6974 656d 2069 6e20      for item in 
-0002e1a0: 6f75 745f 616c 6c2e 6465 636f 6465 2827  out_all.decode('
-0002e1b0: 7574 662d 3827 292e 7370 6c69 746c 696e  utf-8').splitlin
-0002e1c0: 6573 2829 0a20 2020 2020 2020 2020 2020  es().           
-0002e1d0: 2069 6620 7374 6f72 655f 7479 7065 2e76   if store_type.v
-0002e1e0: 616c 7565 2069 6e20 6974 656d 0a20 2020  alue in item.   
-0002e1f0: 2020 2020 205d 0a20 2020 2020 2020 2061       ].        a
-0002e200: 7373 6572 7420 616c 6c28 5b69 7465 6d20  ssert all([item 
-0002e210: 696e 206f 7574 2066 6f72 2069 7465 6d20  in out for item 
-0002e220: 696e 2073 746f 7261 6765 5f6f 626a 5f6e  in storage_obj_n
-0002e230: 616d 6573 5d29 0a0a 2020 2020 4070 7974  ames])..    @pyt
-0002e240: 6573 742e 6d61 726b 2e6e 6f5f 666c 7569  est.mark.no_flui
-0002e250: 6473 7461 636b 0a20 2020 2040 7079 7465  dstack.    @pyte
-0002e260: 7374 2e6d 6172 6b2e 7061 7261 6d65 7472  st.mark.parametr
-0002e270: 697a 6528 2773 746f 7265 5f74 7970 6527  ize('store_type'
-0002e280: 2c20 5b0a 2020 2020 2020 2020 7374 6f72  , [.        stor
-0002e290: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
-0002e2a0: 652e 5333 2c20 7374 6f72 6167 655f 6c69  e.S3, storage_li
-0002e2b0: 622e 5374 6f72 6554 7970 652e 4743 532c  b.StoreType.GCS,
-0002e2c0: 0a20 2020 2020 2020 2070 7974 6573 742e  .        pytest.
-0002e2d0: 7061 7261 6d28 7374 6f72 6167 655f 6c69  param(storage_li
-0002e2e0: 622e 5374 6f72 6554 7970 652e 4942 4d2c  b.StoreType.IBM,
-0002e2f0: 206d 6172 6b73 3d70 7974 6573 742e 6d61   marks=pytest.ma
-0002e300: 726b 2e69 626d 292c 0a20 2020 2020 2020  rk.ibm),.       
-0002e310: 2070 7974 6573 742e 7061 7261 6d28 7374   pytest.param(st
-0002e320: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
-0002e330: 7970 652e 5232 2c20 6d61 726b 733d 7079  ype.R2, marks=py
-0002e340: 7465 7374 2e6d 6172 6b2e 636c 6f75 6466  test.mark.cloudf
-0002e350: 6c61 7265 290a 2020 2020 5d29 0a20 2020  lare).    ]).   
-0002e360: 2064 6566 2074 6573 745f 6275 636b 6574   def test_bucket
-0002e370: 5f65 7874 6572 6e61 6c5f 6465 6c65 7469  _external_deleti
-0002e380: 6f6e 2873 656c 662c 2074 6d70 5f73 6372  on(self, tmp_scr
-0002e390: 6174 6368 5f73 746f 7261 6765 5f6f 626a  atch_storage_obj
-0002e3a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002e3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e3c0: 2020 2020 2020 2020 7374 6f72 655f 7479          store_ty
-0002e3d0: 7065 293a 0a20 2020 2020 2020 2023 2043  pe):.        # C
-0002e3e0: 7265 6174 6573 2061 2062 7563 6b65 742c  reates a bucket,
-0002e3f0: 2064 656c 6574 6573 2069 7420 6578 7465   deletes it exte
-0002e400: 726e 616c 6c79 2075 7369 6e67 2063 6c6f  rnally using clo
-0002e410: 7564 2063 6c69 2063 6f6d 6d61 6e64 730a  ud cli commands.
-0002e420: 2020 2020 2020 2020 2320 616e 6420 7468          # and th
-0002e430: 656e 2074 7269 6573 2074 6f20 6465 6c65  en tries to dele
-0002e440: 7465 2069 7420 7573 696e 6720 736b 7920  te it using sky 
-0002e450: 7374 6f72 6167 6520 6465 6c65 7465 2e0a  storage delete..
-0002e460: 2020 2020 2020 2020 746d 705f 7363 7261          tmp_scra
-0002e470: 7463 685f 7374 6f72 6167 655f 6f62 6a2e  tch_storage_obj.
-0002e480: 6164 645f 7374 6f72 6528 7374 6f72 655f  add_store(store_
-0002e490: 7479 7065 290a 0a20 2020 2020 2020 2023  type)..        #
-0002e4a0: 2052 756e 2073 6b79 2073 746f 7261 6765   Run sky storage
-0002e4b0: 206c 7320 746f 2063 6865 636b 2069 6620   ls to check if 
-0002e4c0: 7374 6f72 6167 6520 6f62 6a65 6374 2065  storage object e
-0002e4d0: 7869 7374 7320 696e 2074 6865 206f 7574  xists in the out
-0002e4e0: 7075 740a 2020 2020 2020 2020 6f75 7420  put.        out 
-0002e4f0: 3d20 7375 6270 726f 6365 7373 2e63 6865  = subprocess.che
-0002e500: 636b 5f6f 7574 7075 7428 5b27 736b 7927  ck_output(['sky'
-0002e510: 2c20 2773 746f 7261 6765 272c 2027 6c73  , 'storage', 'ls
-0002e520: 275d 290a 2020 2020 2020 2020 6173 7365  ']).        asse
-0002e530: 7274 2074 6d70 5f73 6372 6174 6368 5f73  rt tmp_scratch_s
-0002e540: 746f 7261 6765 5f6f 626a 2e6e 616d 6520  torage_obj.name 
-0002e550: 696e 206f 7574 2e64 6563 6f64 6528 2775  in out.decode('u
-0002e560: 7466 2d38 2729 0a0a 2020 2020 2020 2020  tf-8')..        
-0002e570: 2320 4465 6c65 7465 2062 7563 6b65 7420  # Delete bucket 
-0002e580: 6578 7465 726e 616c 6c79 0a20 2020 2020  externally.     
-0002e590: 2020 2063 6d64 203d 2073 656c 662e 636c     cmd = self.cl
-0002e5a0: 695f 6465 6c65 7465 5f63 6d64 2873 746f  i_delete_cmd(sto
-0002e5b0: 7265 5f74 7970 652c 2074 6d70 5f73 6372  re_type, tmp_scr
-0002e5c0: 6174 6368 5f73 746f 7261 6765 5f6f 626a  atch_storage_obj
-0002e5d0: 2e6e 616d 6529 0a20 2020 2020 2020 2073  .name).        s
-0002e5e0: 7562 7072 6f63 6573 732e 6368 6563 6b5f  ubprocess.check_
-0002e5f0: 6f75 7470 7574 2863 6d64 2c20 7368 656c  output(cmd, shel
-0002e600: 6c3d 5472 7565 290a 0a20 2020 2020 2020  l=True)..       
-0002e610: 2023 2052 756e 2073 6b79 2073 746f 7261   # Run sky stora
-0002e620: 6765 2064 656c 6574 6520 746f 2064 656c  ge delete to del
-0002e630: 6574 6520 7468 6520 7374 6f72 6167 6520  ete the storage 
-0002e640: 6f62 6a65 6374 0a20 2020 2020 2020 206f  object.        o
-0002e650: 7574 203d 2073 7562 7072 6f63 6573 732e  ut = subprocess.
-0002e660: 6368 6563 6b5f 6f75 7470 7574 280a 2020  check_output(.  
-0002e670: 2020 2020 2020 2020 2020 5b27 736b 7927            ['sky'
-0002e680: 2c20 2773 746f 7261 6765 272c 2027 6465  , 'storage', 'de
-0002e690: 6c65 7465 272c 2074 6d70 5f73 6372 6174  lete', tmp_scrat
-0002e6a0: 6368 5f73 746f 7261 6765 5f6f 626a 2e6e  ch_storage_obj.n
-0002e6b0: 616d 652c 2027 2d2d 7965 7327 5d29 0a20  ame, '--yes']). 
-0002e6c0: 2020 2020 2020 2023 204d 616b 6520 7375         # Make su
-0002e6d0: 7265 2062 7563 6b65 7420 7761 7320 6e6f  re bucket was no
-0002e6e0: 7420 6372 6561 7465 6420 6475 7269 6e67  t created during
-0002e6f0: 2064 656c 6574 696f 6e20 2873 6565 2069   deletion (see i
-0002e700: 7373 7565 2023 3133 3232 290a 2020 2020  ssue #1322).    
-0002e710: 2020 2020 6173 7365 7274 2027 6372 6561      assert 'crea
-0002e720: 7465 6427 206e 6f74 2069 6e20 6f75 742e  ted' not in out.
-0002e730: 6465 636f 6465 2827 7574 662d 3827 292e  decode('utf-8').
-0002e740: 6c6f 7765 7228 290a 0a20 2020 2020 2020  lower()..       
-0002e750: 2023 2052 756e 2073 6b79 2073 746f 7261   # Run sky stora
-0002e760: 6765 206c 7320 746f 2063 6865 636b 2069  ge ls to check i
-0002e770: 6620 7374 6f72 6167 6520 6f62 6a65 6374  f storage object
-0002e780: 2069 7320 6465 6c65 7465 640a 2020 2020   is deleted.    
-0002e790: 2020 2020 6f75 7420 3d20 7375 6270 726f      out = subpro
-0002e7a0: 6365 7373 2e63 6865 636b 5f6f 7574 7075  cess.check_outpu
-0002e7b0: 7428 5b27 736b 7927 2c20 2773 746f 7261  t(['sky', 'stora
-0002e7c0: 6765 272c 2027 6c73 275d 290a 2020 2020  ge', 'ls']).    
-0002e7d0: 2020 2020 6173 7365 7274 2074 6d70 5f73      assert tmp_s
-0002e7e0: 6372 6174 6368 5f73 746f 7261 6765 5f6f  cratch_storage_o
-0002e7f0: 626a 2e6e 616d 6520 6e6f 7420 696e 206f  bj.name not in o
-0002e800: 7574 2e64 6563 6f64 6528 2775 7466 2d38  ut.decode('utf-8
-0002e810: 2729 0a0a 2020 2020 4070 7974 6573 742e  ')..    @pytest.
-0002e820: 6d61 726b 2e6e 6f5f 666c 7569 6473 7461  mark.no_fluidsta
-0002e830: 636b 0a20 2020 2040 7079 7465 7374 2e6d  ck.    @pytest.m
-0002e840: 6172 6b2e 7061 7261 6d65 7472 697a 6528  ark.parametrize(
-0002e850: 2773 746f 7265 5f74 7970 6527 2c20 5b0a  'store_type', [.
-0002e860: 2020 2020 2020 2020 7374 6f72 6167 655f          storage_
-0002e870: 6c69 622e 5374 6f72 6554 7970 652e 5333  lib.StoreType.S3
-0002e880: 2c20 7374 6f72 6167 655f 6c69 622e 5374  , storage_lib.St
-0002e890: 6f72 6554 7970 652e 4743 532c 0a20 2020  oreType.GCS,.   
-0002e8a0: 2020 2020 2070 7974 6573 742e 7061 7261       pytest.para
-0002e8b0: 6d28 7374 6f72 6167 655f 6c69 622e 5374  m(storage_lib.St
-0002e8c0: 6f72 6554 7970 652e 4942 4d2c 206d 6172  oreType.IBM, mar
-0002e8d0: 6b73 3d70 7974 6573 742e 6d61 726b 2e69  ks=pytest.mark.i
-0002e8e0: 626d 292c 0a20 2020 2020 2020 2070 7974  bm),.        pyt
-0002e8f0: 6573 742e 7061 7261 6d28 7374 6f72 6167  est.param(storag
-0002e900: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
-0002e910: 5232 2c20 6d61 726b 733d 7079 7465 7374  R2, marks=pytest
-0002e920: 2e6d 6172 6b2e 636c 6f75 6466 6c61 7265  .mark.cloudflare
-0002e930: 290a 2020 2020 5d29 0a20 2020 2064 6566  ).    ]).    def
-0002e940: 2074 6573 745f 6275 636b 6574 5f62 756c   test_bucket_bul
-0002e950: 6b5f 6465 6c65 7469 6f6e 2873 656c 662c  k_deletion(self,
-0002e960: 2073 746f 7265 5f74 7970 652c 2074 6d70   store_type, tmp
-0002e970: 5f62 756c 6b5f 6465 6c5f 7374 6f72 6167  _bulk_del_storag
-0002e980: 655f 6f62 6a29 3a0a 2020 2020 2020 2020  e_obj):.        
-0002e990: 2320 4372 6561 7465 7320 6120 7465 6d70  # Creates a temp
-0002e9a0: 2066 6f6c 6465 7220 7769 7468 206f 7665   folder with ove
-0002e9b0: 7220 3235 3620 6669 6c65 7320 616e 6420  r 256 files and 
-0002e9c0: 666f 6c64 6572 732c 2075 706c 6f61 640a  folders, upload.
-0002e9d0: 2020 2020 2020 2020 2320 6669 6c65 7320          # files 
-0002e9e0: 616e 6420 666f 6c64 6572 7320 746f 2061  and folders to a
-0002e9f0: 206e 6577 2062 7563 6b65 742c 2074 6865   new bucket, the
-0002ea00: 6e20 6465 6c65 7465 2062 7563 6b65 742e  n delete bucket.
-0002ea10: 0a20 2020 2020 2020 2074 6d70 5f62 756c  .        tmp_bul
-0002ea20: 6b5f 6465 6c5f 7374 6f72 6167 655f 6f62  k_del_storage_ob
-0002ea30: 6a2e 6164 645f 7374 6f72 6528 7374 6f72  j.add_store(stor
-0002ea40: 655f 7479 7065 290a 0a20 2020 2020 2020  e_type)..       
-0002ea50: 2073 7562 7072 6f63 6573 732e 6368 6563   subprocess.chec
-0002ea60: 6b5f 6f75 7470 7574 285b 0a20 2020 2020  k_output([.     
-0002ea70: 2020 2020 2020 2027 736b 7927 2c20 2773         'sky', 's
-0002ea80: 746f 7261 6765 272c 2027 6465 6c65 7465  torage', 'delete
-0002ea90: 272c 2074 6d70 5f62 756c 6b5f 6465 6c5f  ', tmp_bulk_del_
-0002eaa0: 7374 6f72 6167 655f 6f62 6a2e 6e61 6d65  storage_obj.name
-0002eab0: 2c20 272d 2d79 6573 270a 2020 2020 2020  , '--yes'.      
-0002eac0: 2020 5d29 0a0a 2020 2020 2020 2020 6f75    ])..        ou
-0002ead0: 7470 7574 203d 2073 7562 7072 6f63 6573  tput = subproces
-0002eae0: 732e 6368 6563 6b5f 6f75 7470 7574 285b  s.check_output([
-0002eaf0: 2773 6b79 272c 2027 7374 6f72 6167 6527  'sky', 'storage'
-0002eb00: 2c20 276c 7327 5d29 0a20 2020 2020 2020  , 'ls']).       
-0002eb10: 2061 7373 6572 7420 746d 705f 6275 6c6b   assert tmp_bulk
-0002eb20: 5f64 656c 5f73 746f 7261 6765 5f6f 626a  _del_storage_obj
-0002eb30: 2e6e 616d 6520 6e6f 7420 696e 206f 7574  .name not in out
-0002eb40: 7075 742e 6465 636f 6465 2827 7574 662d  put.decode('utf-
-0002eb50: 3827 290a 0a20 2020 2040 7079 7465 7374  8')..    @pytest
-0002eb60: 2e6d 6172 6b2e 6e6f 5f66 6c75 6964 7374  .mark.no_fluidst
-0002eb70: 6163 6b0a 2020 2020 4070 7974 6573 742e  ack.    @pytest.
-0002eb80: 6d61 726b 2e70 6172 616d 6574 7269 7a65  mark.parametrize
-0002eb90: 280a 2020 2020 2020 2020 2774 6d70 5f70  (.        'tmp_p
-0002eba0: 7562 6c69 635f 7374 6f72 6167 655f 6f62  ublic_storage_ob
-0002ebb0: 6a2c 2073 746f 7265 5f74 7970 6527 2c0a  j, store_type',.
-0002ebc0: 2020 2020 2020 2020 5b28 2773 333a 2f2f          [('s3://
-0002ebd0: 7463 6761 2d32 2d6f 7065 6e27 2c20 7374  tcga-2-open', st
-0002ebe0: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
-0002ebf0: 7970 652e 5333 292c 0a20 2020 2020 2020  ype.S3),.       
-0002ec00: 2020 2827 7333 3a2f 2f64 6967 6974 616c    ('s3://digital
-0002ec10: 636f 7270 6f72 6127 2c20 7374 6f72 6167  corpora', storag
-0002ec20: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
-0002ec30: 5333 292c 0a20 2020 2020 2020 2020 2827  S3),.         ('
-0002ec40: 6773 3a2f 2f67 6370 2d70 7562 6c69 632d  gs://gcp-public-
-0002ec50: 6461 7461 2d73 656e 7469 6e65 6c2d 3227  data-sentinel-2'
-0002ec60: 2c20 7374 6f72 6167 655f 6c69 622e 5374  , storage_lib.St
-0002ec70: 6f72 6554 7970 652e 4743 5329 5d2c 0a20  oreType.GCS)],. 
-0002ec80: 2020 2020 2020 2069 6e64 6972 6563 743d         indirect=
-0002ec90: 5b27 746d 705f 7075 626c 6963 5f73 746f  ['tmp_public_sto
-0002eca0: 7261 6765 5f6f 626a 275d 290a 2020 2020  rage_obj']).    
-0002ecb0: 6465 6620 7465 7374 5f70 7562 6c69 635f  def test_public_
-0002ecc0: 6275 636b 6574 2873 656c 662c 2074 6d70  bucket(self, tmp
-0002ecd0: 5f70 7562 6c69 635f 7374 6f72 6167 655f  _public_storage_
-0002ece0: 6f62 6a2c 2073 746f 7265 5f74 7970 6529  obj, store_type)
-0002ecf0: 3a0a 2020 2020 2020 2020 2320 4372 6561  :.        # Crea
-0002ed00: 7465 7320 6120 6e65 7720 6275 636b 6574  tes a new bucket
-0002ed10: 2077 6974 6820 6120 7075 626c 6963 2073   with a public s
-0002ed20: 6f75 7263 6520 616e 6420 7665 7269 6669  ource and verifi
-0002ed30: 6573 2074 6861 7420 6974 2069 7320 6e6f  es that it is no
-0002ed40: 740a 2020 2020 2020 2020 2320 6164 6465  t.        # adde
-0002ed50: 6420 746f 2067 6c6f 6261 6c5f 7573 6572  d to global_user
-0002ed60: 5f73 7461 7465 2e0a 2020 2020 2020 2020  _state..        
-0002ed70: 746d 705f 7075 626c 6963 5f73 746f 7261  tmp_public_stora
-0002ed80: 6765 5f6f 626a 2e61 6464 5f73 746f 7265  ge_obj.add_store
-0002ed90: 2873 746f 7265 5f74 7970 6529 0a0a 2020  (store_type)..  
-0002eda0: 2020 2020 2020 2320 5275 6e20 736b 7920        # Run sky 
-0002edb0: 7374 6f72 6167 6520 6c73 2074 6f20 6368  storage ls to ch
-0002edc0: 6563 6b20 6966 2073 746f 7261 6765 206f  eck if storage o
-0002edd0: 626a 6563 7420 6578 6973 7473 2069 6e20  bject exists in 
-0002ede0: 7468 6520 6f75 7470 7574 0a20 2020 2020  the output.     
-0002edf0: 2020 206f 7574 203d 2073 7562 7072 6f63     out = subproc
-0002ee00: 6573 732e 6368 6563 6b5f 6f75 7470 7574  ess.check_output
-0002ee10: 285b 2773 6b79 272c 2027 7374 6f72 6167  (['sky', 'storag
-0002ee20: 6527 2c20 276c 7327 5d29 0a20 2020 2020  e', 'ls']).     
-0002ee30: 2020 2061 7373 6572 7420 746d 705f 7075     assert tmp_pu
-0002ee40: 626c 6963 5f73 746f 7261 6765 5f6f 626a  blic_storage_obj
-0002ee50: 2e6e 616d 6520 6e6f 7420 696e 206f 7574  .name not in out
-0002ee60: 2e64 6563 6f64 6528 2775 7466 2d38 2729  .decode('utf-8')
-0002ee70: 0a0a 2020 2020 4070 7974 6573 742e 6d61  ..    @pytest.ma
-0002ee80: 726b 2e6e 6f5f 666c 7569 6473 7461 636b  rk.no_fluidstack
-0002ee90: 0a20 2020 2040 7079 7465 7374 2e6d 6172  .    @pytest.mar
-0002eea0: 6b2e 7061 7261 6d65 7472 697a 6528 276e  k.parametrize('n
-0002eeb0: 6f6e 6578 6973 745f 6275 636b 6574 5f75  onexist_bucket_u
-0002eec0: 726c 272c 205b 0a20 2020 2020 2020 2027  rl', [.        '
-0002eed0: 7333 3a2f 2f7b 7261 6e64 6f6d 5f6e 616d  s3://{random_nam
-0002eee0: 657d 272c 2027 6773 3a2f 2f7b 7261 6e64  e}', 'gs://{rand
-0002eef0: 6f6d 5f6e 616d 657d 272c 0a20 2020 2020  om_name}',.     
-0002ef00: 2020 2070 7974 6573 742e 7061 7261 6d28     pytest.param(
-0002ef10: 2763 6f73 3a2f 2f75 732d 6561 7374 2f7b  'cos://us-east/{
-0002ef20: 7261 6e64 6f6d 5f6e 616d 657d 272c 206d  random_name}', m
-0002ef30: 6172 6b73 3d70 7974 6573 742e 6d61 726b  arks=pytest.mark
-0002ef40: 2e69 626d 292c 0a20 2020 2020 2020 2070  .ibm),.        p
-0002ef50: 7974 6573 742e 7061 7261 6d28 2772 323a  ytest.param('r2:
-0002ef60: 2f2f 7b72 616e 646f 6d5f 6e61 6d65 7d27  //{random_name}'
-0002ef70: 2c20 6d61 726b 733d 7079 7465 7374 2e6d  , marks=pytest.m
-0002ef80: 6172 6b2e 636c 6f75 6466 6c61 7265 290a  ark.cloudflare).
-0002ef90: 2020 2020 5d29 0a20 2020 2064 6566 2074      ]).    def t
-0002efa0: 6573 745f 6e6f 6e65 7869 7374 656e 745f  est_nonexistent_
-0002efb0: 6275 636b 6574 2873 656c 662c 206e 6f6e  bucket(self, non
-0002efc0: 6578 6973 745f 6275 636b 6574 5f75 726c  exist_bucket_url
-0002efd0: 293a 0a20 2020 2020 2020 2023 2041 7474  ):.        # Att
-0002efe0: 656d 7074 7320 746f 2063 7265 6174 6520  empts to create 
-0002eff0: 6665 7463 6820 6120 7374 726f 6167 6520  fetch a stroage 
-0002f000: 7769 7468 2061 206e 6f6e 2d65 7869 7374  with a non-exist
-0002f010: 656e 7420 736f 7572 6365 2e0a 2020 2020  ent source..    
-0002f020: 2020 2020 2320 4765 6e65 7261 7465 2061      # Generate a
-0002f030: 2072 616e 646f 6d20 6275 636b 6574 206e   random bucket n
-0002f040: 616d 6520 616e 6420 7665 7269 6679 2069  ame and verify i
-0002f050: 7420 646f 6573 6e27 7420 6578 6973 743a  t doesn't exist:
-0002f060: 0a20 2020 2020 2020 2072 6574 7279 5f63  .        retry_c
-0002f070: 6f75 6e74 203d 2030 0a20 2020 2020 2020  ount = 0.       
-0002f080: 2077 6869 6c65 2054 7275 653a 0a20 2020   while True:.   
-0002f090: 2020 2020 2020 2020 206e 6f6e 6578 6973           nonexis
-0002f0a0: 745f 6275 636b 6574 5f6e 616d 6520 3d20  t_bucket_name = 
-0002f0b0: 7374 7228 7575 6964 2e75 7569 6434 2829  str(uuid.uuid4()
-0002f0c0: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-0002f0d0: 206e 6f6e 6578 6973 745f 6275 636b 6574   nonexist_bucket
-0002f0e0: 5f75 726c 2e73 7461 7274 7377 6974 6828  _url.startswith(
-0002f0f0: 2773 3327 293a 0a20 2020 2020 2020 2020  's3'):.         
-0002f100: 2020 2020 2020 2063 6f6d 6d61 6e64 203d         command =
-0002f110: 2066 2761 7773 2073 3361 7069 2068 6561   f'aws s3api hea
-0002f120: 642d 6275 636b 6574 202d 2d62 7563 6b65  d-bucket --bucke
-0002f130: 7420 7b6e 6f6e 6578 6973 745f 6275 636b  t {nonexist_buck
-0002f140: 6574 5f6e 616d 657d 270a 2020 2020 2020  et_name}'.      
-0002f150: 2020 2020 2020 2020 2020 6578 7065 6374            expect
-0002f160: 6564 5f6f 7574 7075 7420 3d20 2734 3034  ed_output = '404
-0002f170: 270a 2020 2020 2020 2020 2020 2020 656c  '.            el
-0002f180: 6966 206e 6f6e 6578 6973 745f 6275 636b  if nonexist_buck
-0002f190: 6574 5f75 726c 2e73 7461 7274 7377 6974  et_url.startswit
-0002f1a0: 6828 2767 7327 293a 0a20 2020 2020 2020  h('gs'):.       
-0002f1b0: 2020 2020 2020 2020 2063 6f6d 6d61 6e64           command
-0002f1c0: 203d 2066 2767 7375 7469 6c20 6c73 207b   = f'gsutil ls {
-0002f1d0: 6e6f 6e65 7869 7374 5f62 7563 6b65 745f  nonexist_bucket_
-0002f1e0: 7572 6c2e 666f 726d 6174 2872 616e 646f  url.format(rando
-0002f1f0: 6d5f 6e61 6d65 3d6e 6f6e 6578 6973 745f  m_name=nonexist_
-0002f200: 6275 636b 6574 5f6e 616d 6529 7d27 0a20  bucket_name)}'. 
-0002f210: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0002f220: 7870 6563 7465 645f 6f75 7470 7574 203d  xpected_output =
-0002f230: 2027 4275 636b 6574 4e6f 7446 6f75 6e64   'BucketNotFound
-0002f240: 4578 6365 7074 696f 6e27 0a20 2020 2020  Exception'.     
-0002f250: 2020 2020 2020 2065 6c69 6620 6e6f 6e65         elif none
-0002f260: 7869 7374 5f62 7563 6b65 745f 7572 6c2e  xist_bucket_url.
-0002f270: 7374 6172 7473 7769 7468 2827 7232 2729  startswith('r2')
-0002f280: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0002f290: 2020 656e 6470 6f69 6e74 5f75 726c 203d    endpoint_url =
-0002f2a0: 2063 6c6f 7564 666c 6172 652e 6372 6561   cloudflare.crea
-0002f2b0: 7465 5f65 6e64 706f 696e 7428 290a 2020  te_endpoint().  
-0002f2c0: 2020 2020 2020 2020 2020 2020 2020 636f                co
-0002f2d0: 6d6d 616e 6420 3d20 6627 4157 535f 5348  mmand = f'AWS_SH
-0002f2e0: 4152 4544 5f43 5245 4445 4e54 4941 4c53  ARED_CREDENTIALS
-0002f2f0: 5f46 494c 453d 7b63 6c6f 7564 666c 6172  _FILE={cloudflar
-0002f300: 652e 5232 5f43 5245 4445 4e54 4941 4c53  e.R2_CREDENTIALS
-0002f310: 5f50 4154 487d 2061 7773 2073 3361 7069  _PATH} aws s3api
-0002f320: 2068 6561 642d 6275 636b 6574 202d 2d62   head-bucket --b
-0002f330: 7563 6b65 7420 7b6e 6f6e 6578 6973 745f  ucket {nonexist_
-0002f340: 6275 636b 6574 5f6e 616d 657d 202d 2d65  bucket_name} --e
-0002f350: 6e64 706f 696e 7420 7b65 6e64 706f 696e  ndpoint {endpoin
-0002f360: 745f 7572 6c7d 202d 2d70 726f 6669 6c65  t_url} --profile
-0002f370: 3d72 3227 0a20 2020 2020 2020 2020 2020  =r2'.           
-0002f380: 2020 2020 2065 7870 6563 7465 645f 6f75       expected_ou
-0002f390: 7470 7574 203d 2027 3430 3427 0a20 2020  tput = '404'.   
-0002f3a0: 2020 2020 2020 2020 2065 6c69 6620 6e6f           elif no
-0002f3b0: 6e65 7869 7374 5f62 7563 6b65 745f 7572  nexist_bucket_ur
-0002f3c0: 6c2e 7374 6172 7473 7769 7468 2827 636f  l.startswith('co
-0002f3d0: 7327 293a 0a20 2020 2020 2020 2020 2020  s'):.           
-0002f3e0: 2020 2020 2023 2055 7369 6e67 2041 5049       # Using API
-0002f3f0: 2063 616c 6c73 2c20 7369 6e63 6520 7573   calls, since us
-0002f400: 696e 6720 7263 6c6f 6e65 2072 6571 7569  ing rclone requi
-0002f410: 7265 7320 6120 7072 6f66 696c 6527 7320  res a profile's 
-0002f420: 6e61 6d65 0a20 2020 2020 2020 2020 2020  name.           
-0002f430: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-0002f440: 2020 2020 2020 2020 2020 2020 2020 6578                ex
-0002f450: 7065 6374 6564 5f6f 7574 7075 7420 3d20  pected_output = 
-0002f460: 636f 6d6d 616e 6420 3d20 2265 6368 6f22  command = "echo"
-0002f470: 2020 2320 6176 6f69 6420 756e 7265 6c61    # avoid unrela
-0002f480: 7465 6420 6578 6365 7074 696f 6e20 696e  ted exception in
-0002f490: 2063 6173 6520 6f66 2066 6169 6c75 7265   case of failure
-0002f4a0: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0002f4b0: 2020 2020 2020 6275 636b 6574 5f6e 616d        bucket_nam
-0002f4c0: 6520 3d20 7572 6c6c 6962 2e70 6172 7365  e = urllib.parse
-0002f4d0: 2e75 726c 7370 6c69 7428 0a20 2020 2020  .urlsplit(.     
-0002f4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f4f0: 2020 206e 6f6e 6578 6973 745f 6275 636b     nonexist_buck
-0002f500: 6574 5f75 726c 2e66 6f72 6d61 7428 0a20  et_url.format(. 
-0002f510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f520: 2020 2020 2020 2020 2020 2072 616e 646f             rando
-0002f530: 6d5f 6e61 6d65 3d6e 6f6e 6578 6973 745f  m_name=nonexist_
-0002f540: 6275 636b 6574 5f6e 616d 6529 292e 7061  bucket_name)).pa
-0002f550: 7468 2e73 7472 6970 2827 2f27 290a 2020  th.strip('/').  
-0002f560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f570: 2020 636c 6965 6e74 203d 2069 626d 2e67    client = ibm.g
-0002f580: 6574 5f63 6f73 5f63 6c69 656e 7428 2775  et_cos_client('u
-0002f590: 732d 6561 7374 2729 0a20 2020 2020 2020  s-east').       
-0002f5a0: 2020 2020 2020 2020 2020 2020 2063 6c69               cli
-0002f5b0: 656e 742e 6865 6164 5f62 7563 6b65 7428  ent.head_bucket(
-0002f5c0: 4275 636b 6574 3d62 7563 6b65 745f 6e61  Bucket=bucket_na
-0002f5d0: 6d65 290a 2020 2020 2020 2020 2020 2020  me).            
-0002f5e0: 2020 2020 6578 6365 7074 2069 626d 2e69      except ibm.i
-0002f5f0: 626d 5f62 6f74 6f63 6f72 652e 6578 6365  bm_botocore.exce
-0002f600: 7074 696f 6e73 2e43 6c69 656e 7445 7272  ptions.ClientErr
-0002f610: 6f72 2061 7320 653a 0a20 2020 2020 2020  or as e:.       
-0002f620: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0002f630: 652e 7265 7370 6f6e 7365 5b27 4572 726f  e.response['Erro
-0002f640: 7227 5d5b 2743 6f64 6527 5d20 3d3d 2027  r']['Code'] == '
-0002f650: 3430 3427 3a0a 2020 2020 2020 2020 2020  404':.          
-0002f660: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0002f670: 7375 6363 6573 730a 2020 2020 2020 2020  success.        
-0002f680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f690: 7265 7475 726e 0a20 2020 2020 2020 2020  return.         
-0002f6a0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0002f6b0: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
-0002f6c0: 616c 7565 4572 726f 7228 2755 6e73 7570  alueError('Unsup
-0002f6d0: 706f 7274 6564 2062 7563 6b65 7420 7479  ported bucket ty
-0002f6e0: 7065 2027 0a20 2020 2020 2020 2020 2020  pe '.           
-0002f6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f700: 2020 2020 2020 6627 7b6e 6f6e 6578 6973        f'{nonexis
-0002f710: 745f 6275 636b 6574 5f75 726c 7d27 290a  t_bucket_url}').
-0002f720: 0a20 2020 2020 2020 2020 2020 2023 2043  .            # C
-0002f730: 6865 636b 2069 6620 6275 636b 6574 2065  heck if bucket e
-0002f740: 7869 7374 7320 7573 696e 6720 7468 6520  xists using the 
-0002f750: 636c 693a 0a20 2020 2020 2020 2020 2020  cli:.           
-0002f760: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-0002f770: 2020 2020 2020 6f75 7420 3d20 7375 6270        out = subp
-0002f780: 726f 6365 7373 2e63 6865 636b 5f6f 7574  rocess.check_out
-0002f790: 7075 7428 636f 6d6d 616e 642c 0a20 2020  put(command,.   
-0002f7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f7b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f7c0: 2020 2020 2020 2020 2020 2073 7464 6572             stder
-0002f7d0: 723d 7375 6270 726f 6365 7373 2e53 5444  r=subprocess.STD
-0002f7e0: 4f55 542c 0a20 2020 2020 2020 2020 2020  OUT,.           
-0002f7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f810: 2020 2073 6865 6c6c 3d54 7275 6529 0a20     shell=True). 
-0002f820: 2020 2020 2020 2020 2020 2065 7863 6570             excep
-0002f830: 7420 7375 6270 726f 6365 7373 2e43 616c  t subprocess.Cal
-0002f840: 6c65 6450 726f 6365 7373 4572 726f 7220  ledProcessError 
-0002f850: 6173 2065 3a0a 2020 2020 2020 2020 2020  as e:.          
-0002f860: 2020 2020 2020 6f75 7420 3d20 652e 6f75        out = e.ou
-0002f870: 7470 7574 0a20 2020 2020 2020 2020 2020  tput.           
-0002f880: 206f 7574 203d 206f 7574 2e64 6563 6f64   out = out.decod
-0002f890: 6528 2775 7466 2d38 2729 0a20 2020 2020  e('utf-8').     
-0002f8a0: 2020 2020 2020 2069 6620 6578 7065 6374         if expect
-0002f8b0: 6564 5f6f 7574 7075 7420 696e 206f 7574  ed_output in out
-0002f8c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0002f8d0: 2020 6272 6561 6b0a 2020 2020 2020 2020    break.        
-0002f8e0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0002f8f0: 2020 2020 2020 2020 2020 7265 7472 795f            retry_
-0002f900: 636f 756e 7420 2b3d 2031 0a20 2020 2020  count += 1.     
-0002f910: 2020 2020 2020 2020 2020 2069 6620 7265             if re
-0002f920: 7472 795f 636f 756e 7420 3e20 333a 0a20  try_count > 3:. 
-0002f930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f940: 2020 2072 6169 7365 2052 756e 7469 6d65     raise Runtime
-0002f950: 4572 726f 7228 2755 6e61 626c 6520 746f  Error('Unable to
-0002f960: 2066 696e 6420 6120 6e6f 6e65 7869 7374   find a nonexist
-0002f970: 656e 7420 6275 636b 6574 2027 0a20 2020  ent bucket '.   
-0002f980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f9a0: 2020 2020 2774 6f20 7573 652e 2054 6869      'to use. Thi
-0002f9b0: 7320 6973 2068 6967 6c79 2075 6e6c 696b  s is higly unlik
-0002f9c0: 656c 7920 2d20 270a 2020 2020 2020 2020  ely - '.        
-0002f9d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f9e0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-0002f9f0: 6368 6563 6b20 6966 2074 6865 2074 6573  check if the tes
-0002fa00: 7473 2061 7265 2063 6f72 7265 6374 2e27  ts are correct.'
-0002fa10: 290a 0a20 2020 2020 2020 2077 6974 6820  )..        with 
-0002fa20: 7079 7465 7374 2e72 6169 7365 7328 0a20  pytest.raises(. 
-0002fa30: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0002fa40: 6b79 2e65 7863 6570 7469 6f6e 732e 5374  ky.exceptions.St
-0002fa50: 6f72 6167 6542 7563 6b65 7447 6574 4572  orageBucketGetEr
-0002fa60: 726f 722c 0a20 2020 2020 2020 2020 2020  ror,.           
-0002fa70: 2020 2020 206d 6174 6368 3d27 4174 7465       match='Atte
-0002fa80: 6d70 7465 6420 746f 2075 7365 2061 206e  mpted to use a n
-0002fa90: 6f6e 2d65 7869 7374 656e 7420 6275 636b  on-existent buck
-0002faa0: 6574 2061 7320 6120 736f 7572 6365 2729  et as a source')
-0002fab0: 3a0a 2020 2020 2020 2020 2020 2020 7374  :.            st
-0002fac0: 6f72 6167 655f 6f62 6a20 3d20 7374 6f72  orage_obj = stor
-0002fad0: 6167 655f 6c69 622e 5374 6f72 6167 6528  age_lib.Storage(
-0002fae0: 736f 7572 6365 3d6e 6f6e 6578 6973 745f  source=nonexist_
-0002faf0: 6275 636b 6574 5f75 726c 2e66 6f72 6d61  bucket_url.forma
-0002fb00: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
-0002fb10: 2020 2072 616e 646f 6d5f 6e61 6d65 3d6e     random_name=n
-0002fb20: 6f6e 6578 6973 745f 6275 636b 6574 5f6e  onexist_bucket_n
-0002fb30: 616d 6529 290a 0a20 2020 2040 7079 7465  ame))..    @pyte
-0002fb40: 7374 2e6d 6172 6b2e 6e6f 5f66 6c75 6964  st.mark.no_fluid
-0002fb50: 7374 6163 6b0a 2020 2020 4070 7974 6573  stack.    @pytes
-0002fb60: 742e 6d61 726b 2e70 6172 616d 6574 7269  t.mark.parametri
-0002fb70: 7a65 2827 7072 6976 6174 655f 6275 636b  ze('private_buck
-0002fb80: 6574 272c 205b 0a20 2020 2020 2020 2066  et', [.        f
-0002fb90: 2773 333a 2f2f 696d 6167 656e 6574 272c  's3://imagenet',
-0002fba0: 2066 2767 733a 2f2f 696d 6167 656e 6574   f'gs://imagenet
-0002fbb0: 272c 0a20 2020 2020 2020 2070 7974 6573  ',.        pytes
-0002fbc0: 742e 7061 7261 6d28 2763 6f73 3a2f 2f75  t.param('cos://u
-0002fbd0: 732d 6561 7374 2f62 7563 6b65 7431 272c  s-east/bucket1',
-0002fbe0: 206d 6172 6b73 3d70 7974 6573 742e 6d61   marks=pytest.ma
-0002fbf0: 726b 2e69 626d 290a 2020 2020 5d29 0a20  rk.ibm).    ]). 
-0002fc00: 2020 2064 6566 2074 6573 745f 7072 6976     def test_priv
-0002fc10: 6174 655f 6275 636b 6574 2873 656c 662c  ate_bucket(self,
-0002fc20: 2070 7269 7661 7465 5f62 7563 6b65 7429   private_bucket)
-0002fc30: 3a0a 2020 2020 2020 2020 2320 4174 7465  :.        # Atte
-0002fc40: 6d70 7473 2074 6f20 6163 6365 7373 2070  mpts to access p
-0002fc50: 7269 7661 7465 2062 7563 6b65 7473 206e  rivate buckets n
-0002fc60: 6f74 2062 656c 6f6e 6769 6e67 2074 6f20  ot belonging to 
-0002fc70: 7468 6520 7573 6572 2e0a 2020 2020 2020  the user..      
-0002fc80: 2020 2320 5468 6573 6520 6275 636b 6574    # These bucket
-0002fc90: 7320 6172 6520 6b6e 6f77 6e20 746f 2062  s are known to b
-0002fca0: 6520 7072 6976 6174 652c 2062 7574 206d  e private, but m
-0002fcb0: 6179 206e 6565 6420 746f 2062 6520 7570  ay need to be up
-0002fcc0: 6461 7465 6420 6966 0a20 2020 2020 2020  dated if.       
-0002fcd0: 2023 2074 6865 7920 6172 6520 7265 6d6f   # they are remo
-0002fce0: 7665 6420 6279 2074 6865 6972 206f 776e  ved by their own
-0002fcf0: 6572 732e 0a20 2020 2020 2020 2070 7269  ers..        pri
-0002fd00: 7661 7465 5f62 7563 6b65 745f 6e61 6d65  vate_bucket_name
-0002fd10: 203d 2075 726c 6c69 622e 7061 7273 652e   = urllib.parse.
-0002fd20: 7572 6c73 706c 6974 2870 7269 7661 7465  urlsplit(private
-0002fd30: 5f62 7563 6b65 7429 2e6e 6574 6c6f 6320  _bucket).netloc 
-0002fd40: 6966 205c 0a20 2020 2020 2020 2020 2020  if \.           
-0002fd50: 2020 2075 726c 6c69 622e 7061 7273 652e     urllib.parse.
-0002fd60: 7572 6c73 706c 6974 2870 7269 7661 7465  urlsplit(private
-0002fd70: 5f62 7563 6b65 7429 2e73 6368 656d 6520  _bucket).scheme 
-0002fd80: 213d 2027 636f 7327 2065 6c73 6520 5c0a  != 'cos' else \.
-0002fd90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fda0: 2020 7572 6c6c 6962 2e70 6172 7365 2e75    urllib.parse.u
-0002fdb0: 726c 7370 6c69 7428 7072 6976 6174 655f  rlsplit(private_
-0002fdc0: 6275 636b 6574 292e 7061 7468 2e73 7472  bucket).path.str
-0002fdd0: 6970 2827 2f27 290a 2020 2020 2020 2020  ip('/').        
-0002fde0: 7769 7468 2070 7974 6573 742e 7261 6973  with pytest.rais
-0002fdf0: 6573 280a 2020 2020 2020 2020 2020 2020  es(.            
-0002fe00: 2020 2020 736b 792e 6578 6365 7074 696f      sky.exceptio
-0002fe10: 6e73 2e53 746f 7261 6765 4275 636b 6574  ns.StorageBucket
-0002fe20: 4765 7445 7272 6f72 2c0a 2020 2020 2020  GetError,.      
-0002fe30: 2020 2020 2020 2020 2020 6d61 7463 683d            match=
-0002fe40: 7374 6f72 6167 655f 6c69 622e 5f42 5543  storage_lib._BUC
-0002fe50: 4b45 545f 4641 494c 5f54 4f5f 434f 4e4e  KET_FAIL_TO_CONN
-0002fe60: 4543 545f 4d45 5353 4147 452e 666f 726d  ECT_MESSAGE.form
-0002fe70: 6174 280a 2020 2020 2020 2020 2020 2020  at(.            
-0002fe80: 2020 2020 2020 2020 6e61 6d65 3d70 7269          name=pri
-0002fe90: 7661 7465 5f62 7563 6b65 745f 6e61 6d65  vate_bucket_name
-0002fea0: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
-0002feb0: 7374 6f72 6167 655f 6f62 6a20 3d20 7374  storage_obj = st
-0002fec0: 6f72 6167 655f 6c69 622e 5374 6f72 6167  orage_lib.Storag
-0002fed0: 6528 736f 7572 6365 3d70 7269 7661 7465  e(source=private
-0002fee0: 5f62 7563 6b65 7429 0a0a 2020 2020 4070  _bucket)..    @p
-0002fef0: 7974 6573 742e 6d61 726b 2e6e 6f5f 666c  ytest.mark.no_fl
-0002ff00: 7569 6473 7461 636b 0a20 2020 2040 7079  uidstack.    @py
-0002ff10: 7465 7374 2e6d 6172 6b2e 7061 7261 6d65  test.mark.parame
-0002ff20: 7472 697a 6528 2765 7874 5f62 7563 6b65  trize('ext_bucke
-0002ff30: 745f 6669 7874 7572 652c 2073 746f 7265  t_fixture, store
-0002ff40: 5f74 7970 6527 2c0a 2020 2020 2020 2020  _type',.        
-0002ff50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ff60: 2020 2020 205b 2827 746d 705f 6177 7363       [('tmp_awsc
-0002ff70: 6c69 5f62 7563 6b65 7427 2c20 7374 6f72  li_bucket', stor
-0002ff80: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
-0002ff90: 652e 5333 292c 0a20 2020 2020 2020 2020  e.S3),.         
-0002ffa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ffb0: 2020 2020 2028 2774 6d70 5f67 7375 7469       ('tmp_gsuti
-0002ffc0: 6c5f 6275 636b 6574 272c 2073 746f 7261  l_bucket', stora
-0002ffd0: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
-0002ffe0: 2e47 4353 292c 0a20 2020 2020 2020 2020  .GCS),.         
-0002fff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030000: 2020 2020 2070 7974 6573 742e 7061 7261       pytest.para
-00030010: 6d28 2774 6d70 5f69 626d 5f63 6f73 5f62  m('tmp_ibm_cos_b
-00030020: 7563 6b65 7427 2c0a 2020 2020 2020 2020  ucket',.        
-00030030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030050: 2020 2073 746f 7261 6765 5f6c 6962 2e53     storage_lib.S
-00030060: 746f 7265 5479 7065 2e49 424d 2c0a 2020  toreType.IBM,.  
-00030070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030090: 2020 2020 2020 2020 206d 6172 6b73 3d70           marks=p
-000300a0: 7974 6573 742e 6d61 726b 2e69 626d 292c  ytest.mark.ibm),
-000300b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000300c0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-000300d0: 7974 6573 742e 7061 7261 6d28 2774 6d70  ytest.param('tmp
-000300e0: 5f61 7773 636c 695f 6275 636b 6574 5f72  _awscli_bucket_r
-000300f0: 3227 2c0a 2020 2020 2020 2020 2020 2020  2',.            
-00030100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030110: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00030120: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
-00030130: 5479 7065 2e52 322c 0a20 2020 2020 2020  Type.R2,.       
-00030140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030160: 2020 2020 6d61 726b 733d 7079 7465 7374      marks=pytest
-00030170: 2e6d 6172 6b2e 636c 6f75 6466 6c61 7265  .mark.cloudflare
-00030180: 295d 290a 2020 2020 6465 6620 7465 7374  )]).    def test
-00030190: 5f75 706c 6f61 645f 746f 5f65 7869 7374  _upload_to_exist
-000301a0: 696e 675f 6275 636b 6574 2873 656c 662c  ing_bucket(self,
-000301b0: 2065 7874 5f62 7563 6b65 745f 6669 7874   ext_bucket_fixt
-000301c0: 7572 652c 2072 6571 7565 7374 2c0a 2020  ure, request,.  
-000301d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000301e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000301f0: 2020 2020 2074 6d70 5f73 6f75 7263 652c       tmp_source,
-00030200: 2073 746f 7265 5f74 7970 6529 3a0a 2020   store_type):.  
-00030210: 2020 2020 2020 2320 5472 6965 7320 7570        # Tries up
-00030220: 6c6f 6164 696e 6720 6578 6973 7469 6e67  loading existing
-00030230: 2066 696c 6573 2074 6f20 6e65 776c 7920   files to newly 
-00030240: 6372 6561 7465 6420 6275 636b 6574 2028  created bucket (
-00030250: 6f75 7473 6964 6520 6f66 0a20 2020 2020  outside of.     
-00030260: 2020 2023 2073 6b79 2920 616e 6420 7665     # sky) and ve
-00030270: 7269 6669 6573 2074 6861 7420 6669 6c65  rifies that file
-00030280: 7320 6172 6520 7772 6974 7465 6e2e 0a20  s are written.. 
-00030290: 2020 2020 2020 2062 7563 6b65 745f 6e61         bucket_na
-000302a0: 6d65 2c20 5f20 3d20 7265 7175 6573 742e  me, _ = request.
-000302b0: 6765 7466 6978 7475 7265 7661 6c75 6528  getfixturevalue(
-000302c0: 6578 745f 6275 636b 6574 5f66 6978 7475  ext_bucket_fixtu
-000302d0: 7265 290a 2020 2020 2020 2020 7374 6f72  re).        stor
-000302e0: 6167 655f 6f62 6a20 3d20 7374 6f72 6167  age_obj = storag
-000302f0: 655f 6c69 622e 5374 6f72 6167 6528 6e61  e_lib.Storage(na
-00030300: 6d65 3d62 7563 6b65 745f 6e61 6d65 2c20  me=bucket_name, 
-00030310: 736f 7572 6365 3d74 6d70 5f73 6f75 7263  source=tmp_sourc
-00030320: 6529 0a20 2020 2020 2020 2073 746f 7261  e).        stora
-00030330: 6765 5f6f 626a 2e61 6464 5f73 746f 7265  ge_obj.add_store
-00030340: 2873 746f 7265 5f74 7970 6529 0a0a 2020  (store_type)..  
-00030350: 2020 2020 2020 2320 4368 6563 6b20 6966        # Check if
-00030360: 2074 6d70 5f73 6f75 7263 652f 746d 702d   tmp_source/tmp-
-00030370: 6669 6c65 2065 7869 7374 7320 696e 2074  file exists in t
-00030380: 6865 2062 7563 6b65 7420 7573 696e 6720  he bucket using 
-00030390: 6177 7320 636c 690a 2020 2020 2020 2020  aws cli.        
-000303a0: 6f75 7420 3d20 7375 6270 726f 6365 7373  out = subprocess
-000303b0: 2e63 6865 636b 5f6f 7574 7075 7428 7365  .check_output(se
-000303c0: 6c66 2e63 6c69 5f6c 735f 636d 6428 7374  lf.cli_ls_cmd(st
-000303d0: 6f72 655f 7479 7065 2c20 6275 636b 6574  ore_type, bucket
-000303e0: 5f6e 616d 6529 2c0a 2020 2020 2020 2020  _name),.        
-000303f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030400: 2020 2020 2020 2020 2020 2020 2020 7368                sh
-00030410: 656c 6c3d 5472 7565 290a 2020 2020 2020  ell=True).      
-00030420: 2020 6173 7365 7274 2027 746d 702d 6669    assert 'tmp-fi
-00030430: 6c65 2720 696e 206f 7574 2e64 6563 6f64  le' in out.decod
-00030440: 6528 2775 7466 2d38 2729 2c20 5c0a 2020  e('utf-8'), \.  
-00030450: 2020 2020 2020 2020 2020 2746 696c 6520            'File 
-00030460: 6e6f 7420 666f 756e 6420 696e 2062 7563  not found in buc
-00030470: 6b65 7420 2d20 6f75 7470 7574 2077 6173  ket - output was
-00030480: 203a 207b 7d27 2e66 6f72 6d61 7428 6f75   : {}'.format(ou
-00030490: 742e 6465 636f 6465 0a20 2020 2020 2020  t.decode.       
-000304a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000304b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000304c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000304d0: 2020 2020 2020 2020 2028 2775 7466 2d38           ('utf-8
-000304e0: 2729 290a 0a20 2020 2020 2020 2023 2043  '))..        # C
-000304f0: 6865 636b 2073 796d 6c69 6e6b 7320 2d20  heck symlinks - 
-00030500: 7379 6d6c 696e 6b73 2064 6f6e 2774 2067  symlinks don't g
-00030510: 6574 2063 6f70 6965 6420 6279 2073 6b79  et copied by sky
-00030520: 2073 746f 7261 6765 0a20 2020 2020 2020   storage.       
-00030530: 2061 7373 6572 7420 2870 6174 686c 6962   assert (pathlib
-00030540: 2e50 6174 6828 746d 705f 736f 7572 6365  .Path(tmp_source
-00030550: 2920 2f20 2763 6972 636c 652d 6c69 6e6b  ) / 'circle-link
-00030560: 2729 2e69 735f 7379 6d6c 696e 6b28 292c  ').is_symlink(),
-00030570: 2028 0a20 2020 2020 2020 2020 2020 2027   (.            '
-00030580: 6369 7263 6c65 2d6c 696e 6b20 7761 7320  circle-link was 
-00030590: 6e6f 7420 666f 756e 6420 696e 2074 6865  not found in the
-000305a0: 2075 706c 6f61 6420 736f 7572 6365 202d   upload source -
-000305b0: 2027 0a20 2020 2020 2020 2020 2020 2027   '.            '
-000305c0: 6172 6520 7468 6520 7465 7374 2066 6978  are the test fix
-000305d0: 7475 7265 7320 636f 7272 6563 743f 2729  tures correct?')
-000305e0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-000305f0: 2763 6972 636c 652d 6c69 6e6b 2720 6e6f  'circle-link' no
-00030600: 7420 696e 206f 7574 2e64 6563 6f64 6528  t in out.decode(
-00030610: 2775 7466 2d38 2729 2c20 280a 2020 2020  'utf-8'), (.    
-00030620: 2020 2020 2020 2020 2753 796d 6c69 6e6b          'Symlink
-00030630: 2066 6f75 6e64 2069 6e20 6275 636b 6574   found in bucket
-00030640: 202d 206c 7320 6f75 7470 7574 2077 6173   - ls output was
-00030650: 203a 207b 7d27 2e66 6f72 6d61 7428 0a20   : {}'.format(. 
-00030660: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-00030670: 7574 2e64 6563 6f64 6528 2775 7466 2d38  ut.decode('utf-8
-00030680: 2729 2929 0a0a 2020 2020 2020 2020 2320  ')))..        # 
-00030690: 5275 6e20 736b 7920 7374 6f72 6167 6520  Run sky storage 
-000306a0: 6c73 2074 6f20 6368 6563 6b20 6966 2073  ls to check if s
-000306b0: 746f 7261 6765 206f 626a 6563 7420 6578  torage object ex
-000306c0: 6973 7473 2069 6e20 7468 6520 6f75 7470  ists in the outp
-000306d0: 7574 2e0a 2020 2020 2020 2020 2320 4974  ut..        # It
-000306e0: 2073 686f 756c 6420 6e6f 7420 6578 6973   should not exis
-000306f0: 7420 6265 6361 7573 6520 7468 6520 6275  t because the bu
-00030700: 636b 6574 2077 6173 2063 7265 6174 6564  cket was created
-00030710: 2065 7874 6572 6e61 6c6c 792e 0a20 2020   externally..   
-00030720: 2020 2020 206f 7574 203d 2073 7562 7072       out = subpr
-00030730: 6f63 6573 732e 6368 6563 6b5f 6f75 7470  ocess.check_outp
-00030740: 7574 285b 2773 6b79 272c 2027 7374 6f72  ut(['sky', 'stor
-00030750: 6167 6527 2c20 276c 7327 5d29 0a20 2020  age', 'ls']).   
-00030760: 2020 2020 2061 7373 6572 7420 7374 6f72       assert stor
-00030770: 6167 655f 6f62 6a2e 6e61 6d65 206e 6f74  age_obj.name not
-00030780: 2069 6e20 6f75 742e 6465 636f 6465 2827   in out.decode('
-00030790: 7574 662d 3827 290a 0a20 2020 2040 7079  utf-8')..    @py
-000307a0: 7465 7374 2e6d 6172 6b2e 6e6f 5f66 6c75  test.mark.no_flu
-000307b0: 6964 7374 6163 6b0a 2020 2020 6465 6620  idstack.    def 
-000307c0: 7465 7374 5f63 6f70 795f 6d6f 756e 745f  test_copy_mount_
-000307d0: 6578 6973 7469 6e67 5f73 746f 7261 6765  existing_storage
-000307e0: 2873 656c 662c 0a20 2020 2020 2020 2020  (self,.         
-000307f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030810: 746d 705f 636f 7079 5f6d 6e74 5f65 7869  tmp_copy_mnt_exi
-00030820: 7374 696e 675f 7374 6f72 6167 655f 6f62  sting_storage_ob
-00030830: 6a29 3a0a 2020 2020 2020 2020 2320 4372  j):.        # Cr
-00030840: 6561 7465 7320 6120 6275 636b 6574 2077  eates a bucket w
-00030850: 6974 6820 6e6f 2073 6f75 7263 6520 696e  ith no source in
-00030860: 204d 4f55 4e54 206d 6f64 6520 2865 6d70   MOUNT mode (emp
-00030870: 7479 2062 7563 6b65 7429 2c20 616e 640a  ty bucket), and.
-00030880: 2020 2020 2020 2020 2320 7468 656e 2074          # then t
-00030890: 7269 6573 2074 6f20 6c6f 6164 2074 6865  ries to load the
-000308a0: 2073 616d 6520 7374 6f72 6167 6520 696e   same storage in
-000308b0: 2043 4f50 5920 6d6f 6465 2e0a 2020 2020   COPY mode..    
-000308c0: 2020 2020 746d 705f 636f 7079 5f6d 6e74      tmp_copy_mnt
-000308d0: 5f65 7869 7374 696e 675f 7374 6f72 6167  _existing_storag
-000308e0: 655f 6f62 6a2e 6164 645f 7374 6f72 6528  e_obj.add_store(
-000308f0: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
-00030900: 6554 7970 652e 5333 290a 2020 2020 2020  eType.S3).      
-00030910: 2020 7374 6f72 6167 655f 6e61 6d65 203d    storage_name =
-00030920: 2074 6d70 5f63 6f70 795f 6d6e 745f 6578   tmp_copy_mnt_ex
-00030930: 6973 7469 6e67 5f73 746f 7261 6765 5f6f  isting_storage_o
-00030940: 626a 2e6e 616d 650a 0a20 2020 2020 2020  bj.name..       
-00030950: 2023 2043 6865 636b 2060 736b 7920 7374   # Check `sky st
-00030960: 6f72 6167 6520 6c73 6020 746f 2065 6e73  orage ls` to ens
-00030970: 7572 6520 7374 6f72 6167 6520 6f62 6a65  ure storage obje
-00030980: 6374 2065 7869 7374 730a 2020 2020 2020  ct exists.      
-00030990: 2020 6f75 7420 3d20 7375 6270 726f 6365    out = subproce
-000309a0: 7373 2e63 6865 636b 5f6f 7574 7075 7428  ss.check_output(
-000309b0: 5b27 736b 7927 2c20 2773 746f 7261 6765  ['sky', 'storage
-000309c0: 272c 2027 6c73 275d 292e 6465 636f 6465  ', 'ls']).decode
-000309d0: 2827 7574 662d 3827 290a 2020 2020 2020  ('utf-8').      
-000309e0: 2020 6173 7365 7274 2073 746f 7261 6765    assert storage
-000309f0: 5f6e 616d 6520 696e 206f 7574 2c20 6627  _name in out, f'
-00030a00: 5374 6f72 6167 6520 7b73 746f 7261 6765  Storage {storage
-00030a10: 5f6e 616d 657d 206e 6f74 2066 6f75 6e64  _name} not found
-00030a20: 2069 6e20 736b 7920 7374 6f72 6167 6520   in sky storage 
-00030a30: 6c73 2e27 0a0a 2020 2020 4070 7974 6573  ls.'..    @pytes
-00030a40: 742e 6d61 726b 2e6e 6f5f 666c 7569 6473  t.mark.no_fluids
-00030a50: 7461 636b 0a20 2020 2040 7079 7465 7374  tack.    @pytest
-00030a60: 2e6d 6172 6b2e 7061 7261 6d65 7472 697a  .mark.parametriz
-00030a70: 6528 2773 746f 7265 5f74 7970 6527 2c20  e('store_type', 
-00030a80: 5b0a 2020 2020 2020 2020 7374 6f72 6167  [.        storag
-00030a90: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
-00030aa0: 5333 2c20 7374 6f72 6167 655f 6c69 622e  S3, storage_lib.
-00030ab0: 5374 6f72 6554 7970 652e 4743 532c 0a20  StoreType.GCS,. 
-00030ac0: 2020 2020 2020 2070 7974 6573 742e 7061         pytest.pa
-00030ad0: 7261 6d28 7374 6f72 6167 655f 6c69 622e  ram(storage_lib.
-00030ae0: 5374 6f72 6554 7970 652e 4942 4d2c 206d  StoreType.IBM, m
-00030af0: 6172 6b73 3d70 7974 6573 742e 6d61 726b  arks=pytest.mark
-00030b00: 2e69 626d 292c 0a20 2020 2020 2020 2070  .ibm),.        p
-00030b10: 7974 6573 742e 7061 7261 6d28 7374 6f72  ytest.param(stor
-00030b20: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
-00030b30: 652e 5232 2c20 6d61 726b 733d 7079 7465  e.R2, marks=pyte
-00030b40: 7374 2e6d 6172 6b2e 636c 6f75 6466 6c61  st.mark.cloudfla
-00030b50: 7265 290a 2020 2020 5d29 0a20 2020 2064  re).    ]).    d
-00030b60: 6566 2074 6573 745f 6c69 7374 5f73 6f75  ef test_list_sou
-00030b70: 7263 6528 7365 6c66 2c20 746d 705f 6c6f  rce(self, tmp_lo
-00030b80: 6361 6c5f 6c69 7374 5f73 746f 7261 6765  cal_list_storage
-00030b90: 5f6f 626a 2c20 7374 6f72 655f 7479 7065  _obj, store_type
-00030ba0: 293a 0a20 2020 2020 2020 2023 2055 7365  ):.        # Use
-00030bb0: 7320 6120 6c69 7374 2069 6e20 7468 6520  s a list in the 
-00030bc0: 736f 7572 6365 2066 6965 6c64 2074 6f20  source field to 
-00030bd0: 7370 6563 6966 7920 6120 6669 6c65 2061  specify a file a
-00030be0: 6e64 2061 2064 6972 6563 746f 7279 2074  nd a directory t
-00030bf0: 6f0a 2020 2020 2020 2020 2320 6265 2075  o.        # be u
-00030c00: 706c 6f61 6465 6420 746f 2074 6865 2073  ploaded to the s
-00030c10: 746f 7261 6765 206f 626a 6563 742e 0a20  torage object.. 
-00030c20: 2020 2020 2020 2074 6d70 5f6c 6f63 616c         tmp_local
-00030c30: 5f6c 6973 745f 7374 6f72 6167 655f 6f62  _list_storage_ob
-00030c40: 6a2e 6164 645f 7374 6f72 6528 7374 6f72  j.add_store(stor
-00030c50: 655f 7479 7065 290a 0a20 2020 2020 2020  e_type)..       
-00030c60: 2023 2043 6865 636b 2069 6620 746d 702d   # Check if tmp-
-00030c70: 6669 6c65 2065 7869 7374 7320 696e 2074  file exists in t
-00030c80: 6865 2062 7563 6b65 7420 726f 6f74 2075  he bucket root u
-00030c90: 7369 6e67 2063 6c69 0a20 2020 2020 2020  sing cli.       
-00030ca0: 206f 7574 203d 2073 7562 7072 6f63 6573   out = subproces
-00030cb0: 732e 6368 6563 6b5f 6f75 7470 7574 2873  s.check_output(s
-00030cc0: 656c 662e 636c 695f 6c73 5f63 6d64 280a  elf.cli_ls_cmd(.
-00030cd0: 2020 2020 2020 2020 2020 2020 7374 6f72              stor
-00030ce0: 655f 7479 7065 2c20 746d 705f 6c6f 6361  e_type, tmp_loca
-00030cf0: 6c5f 6c69 7374 5f73 746f 7261 6765 5f6f  l_list_storage_o
-00030d00: 626a 2e6e 616d 6529 2c0a 2020 2020 2020  bj.name),.      
-00030d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030d30: 7368 656c 6c3d 5472 7565 290a 2020 2020  shell=True).    
-00030d40: 2020 2020 6173 7365 7274 2027 746d 702d      assert 'tmp-
-00030d50: 6669 6c65 2720 696e 206f 7574 2e64 6563  file' in out.dec
-00030d60: 6f64 6528 2775 7466 2d38 2729 2c20 5c0a  ode('utf-8'), \.
-00030d70: 2020 2020 2020 2020 2020 2020 2746 696c              'Fil
-00030d80: 6520 6e6f 7420 666f 756e 6420 696e 2062  e not found in b
-00030d90: 7563 6b65 7420 2d20 6f75 7470 7574 2077  ucket - output w
-00030da0: 6173 203a 207b 7d27 2e66 6f72 6d61 7428  as : {}'.format(
-00030db0: 6f75 742e 6465 636f 6465 0a20 2020 2020  out.decode.     
-00030dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030df0: 2020 2020 2020 2020 2020 2028 2775 7466             ('utf
-00030e00: 2d38 2729 290a 0a20 2020 2020 2020 2023  -8'))..        #
-00030e10: 2043 6865 636b 2069 6620 746d 702d 6669   Check if tmp-fi
-00030e20: 6c65 2065 7869 7374 7320 696e 2074 6865  le exists in the
-00030e30: 2062 7563 6b65 742f 746d 702d 736f 7572   bucket/tmp-sour
-00030e40: 6365 2075 7369 6e67 2063 6c69 0a20 2020  ce using cli.   
-00030e50: 2020 2020 206f 7574 203d 2073 7562 7072       out = subpr
-00030e60: 6f63 6573 732e 6368 6563 6b5f 6f75 7470  ocess.check_outp
-00030e70: 7574 2873 656c 662e 636c 695f 6c73 5f63  ut(self.cli_ls_c
-00030e80: 6d64 280a 2020 2020 2020 2020 2020 2020  md(.            
-00030e90: 7374 6f72 655f 7479 7065 2c20 746d 705f  store_type, tmp_
-00030ea0: 6c6f 6361 6c5f 6c69 7374 5f73 746f 7261  local_list_stora
-00030eb0: 6765 5f6f 626a 2e6e 616d 652c 2027 746d  ge_obj.name, 'tm
-00030ec0: 702d 736f 7572 6365 2f27 292c 0a20 2020  p-source/'),.   
-00030ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030ef0: 2020 2073 6865 6c6c 3d54 7275 6529 0a20     shell=True). 
-00030f00: 2020 2020 2020 2061 7373 6572 7420 2774         assert 't
-00030f10: 6d70 2d66 696c 6527 2069 6e20 6f75 742e  mp-file' in out.
-00030f20: 6465 636f 6465 2827 7574 662d 3827 292c  decode('utf-8'),
-00030f30: 205c 0a20 2020 2020 2020 2020 2020 2027   \.            '
-00030f40: 4669 6c65 206e 6f74 2066 6f75 6e64 2069  File not found i
-00030f50: 6e20 6275 636b 6574 202d 206f 7574 7075  n bucket - outpu
-00030f60: 7420 7761 7320 3a20 7b7d 272e 666f 726d  t was : {}'.form
-00030f70: 6174 286f 7574 2e64 6563 6f64 650a 2020  at(out.decode.  
-00030f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002af10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002af20: 2020 2020 2073 6f75 7263 653d 736f 7572       source=sour
+0002af30: 6365 2c0a 2020 2020 2020 2020 2020 2020  ce,.            
+0002af40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002af50: 2020 2020 2020 2020 2020 2020 2020 7374                st
+0002af60: 6f72 6573 3d73 746f 7265 732c 0a20 2020  ores=stores,.   
+0002af70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002af80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002af90: 2020 2020 2020 2070 6572 7369 7374 656e         persisten
+0002afa0: 743d 7065 7273 6973 7465 6e74 2c0a 2020  t=persistent,.  
+0002afb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002afc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002afd0: 2020 2020 2020 2020 6d6f 6465 3d6d 6f64          mode=mod
+0002afe0: 6529 0a20 2020 2020 2020 2079 6965 6c64  e).        yield
+0002aff0: 2073 746f 7261 6765 5f6f 626a 0a20 2020   storage_obj.   
+0002b000: 2020 2020 2068 616e 646c 6520 3d20 676c       handle = gl
+0002b010: 6f62 616c 5f75 7365 725f 7374 6174 652e  obal_user_state.
+0002b020: 6765 745f 6861 6e64 6c65 5f66 726f 6d5f  get_handle_from_
+0002b030: 7374 6f72 6167 655f 6e61 6d65 280a 2020  storage_name(.  
+0002b040: 2020 2020 2020 2020 2020 7374 6f72 6167            storag
+0002b050: 655f 6f62 6a2e 6e61 6d65 290a 2020 2020  e_obj.name).    
+0002b060: 2020 2020 6966 2068 616e 646c 653a 0a20      if handle:. 
+0002b070: 2020 2020 2020 2020 2020 2023 2049 6620             # If 
+0002b080: 6861 6e64 6c65 2065 7869 7374 732c 2064  handle exists, d
+0002b090: 656c 6574 6520 6d61 6e75 616c 6c79 0a20  elete manually. 
+0002b0a0: 2020 2020 2020 2020 2020 2023 2054 4f44             # TOD
+0002b0b0: 4f28 726f 6d69 6c62 293a 2054 6869 7320  O(romilb): This 
+0002b0c0: 6973 2070 6f74 656e 7469 616c 6c79 2072  is potentially r
+0002b0d0: 6973 6b79 202d 2069 6620 7468 6520 6465  isky - if the de
+0002b0e0: 6c65 7465 206d 6574 686f 6420 6861 730a  lete method has.
+0002b0f0: 2020 2020 2020 2020 2020 2020 2320 2020              #   
+0002b100: 6275 6773 2c20 7468 6973 2063 616e 2063  bugs, this can c
+0002b110: 6175 7365 2072 6573 6f75 7263 6520 6c65  ause resource le
+0002b120: 616b 732e 2049 6465 616c 6c79 2077 6520  aks. Ideally we 
+0002b130: 7368 6f75 6c64 206d 616e 7561 6c6c 790a  should manually.
+0002b140: 2020 2020 2020 2020 2020 2020 2320 2020              #   
+0002b150: 656a 6563 7420 7374 6f72 6167 6520 6672  eject storage fr
+0002b160: 6f6d 2067 6c6f 6261 6c5f 7573 6572 5f73  om global_user_s
+0002b170: 7461 7465 2061 6e64 2064 656c 6574 6520  tate and delete 
+0002b180: 7468 6520 6275 636b 6574 2075 7369 6e67  the bucket using
+0002b190: 0a20 2020 2020 2020 2020 2020 2023 2020  .            #  
+0002b1a0: 2062 6f74 6f33 2064 6972 6563 746c 792e   boto3 directly.
+0002b1b0: 0a20 2020 2020 2020 2020 2020 2073 746f  .            sto
+0002b1c0: 7261 6765 5f6f 626a 2e64 656c 6574 6528  rage_obj.delete(
+0002b1d0: 290a 0a20 2020 2040 7079 7465 7374 2e66  )..    @pytest.f
+0002b1e0: 6978 7475 7265 0a20 2020 2064 6566 2074  ixture.    def t
+0002b1f0: 6d70 5f73 6372 6174 6368 5f73 746f 7261  mp_scratch_stora
+0002b200: 6765 5f6f 626a 2873 656c 662c 2074 6d70  ge_obj(self, tmp
+0002b210: 5f62 7563 6b65 745f 6e61 6d65 293a 0a20  _bucket_name):. 
+0002b220: 2020 2020 2020 2023 2043 7265 6174 6573         # Creates
+0002b230: 2061 2073 746f 7261 6765 206f 626a 6563   a storage objec
+0002b240: 7420 7769 7468 206e 6f20 736f 7572 6365  t with no source
+0002b250: 2074 6f20 6372 6561 7465 2061 2073 6372   to create a scr
+0002b260: 6174 6368 2073 746f 7261 6765 2e0a 2020  atch storage..  
+0002b270: 2020 2020 2020 2320 5374 6f72 6573 206d        # Stores m
+0002b280: 7573 7420 6265 2061 6464 6564 2069 6e20  ust be added in 
+0002b290: 7468 6520 7465 7374 2e0a 2020 2020 2020  the test..      
+0002b2a0: 2020 7969 656c 6420 6672 6f6d 2073 656c    yield from sel
+0002b2b0: 662e 7969 656c 645f 7374 6f72 6167 655f  f.yield_storage_
+0002b2c0: 6f62 6a65 6374 286e 616d 653d 746d 705f  object(name=tmp_
+0002b2d0: 6275 636b 6574 5f6e 616d 6529 0a0a 2020  bucket_name)..  
+0002b2e0: 2020 4070 7974 6573 742e 6669 7874 7572    @pytest.fixtur
+0002b2f0: 650a 2020 2020 6465 6620 746d 705f 6d75  e.    def tmp_mu
+0002b300: 6c74 6970 6c65 5f73 6372 6174 6368 5f73  ltiple_scratch_s
+0002b310: 746f 7261 6765 5f6f 626a 2873 656c 6629  torage_obj(self)
+0002b320: 3a0a 2020 2020 2020 2020 2320 4372 6561  :.        # Crea
+0002b330: 7465 7320 6120 6c69 7374 206f 6620 3520  tes a list of 5 
+0002b340: 7374 6f72 6167 6520 6f62 6a65 6374 7320  storage objects 
+0002b350: 7769 7468 206e 6f20 736f 7572 6365 2074  with no source t
+0002b360: 6f20 6372 6561 7465 0a20 2020 2020 2020  o create.       
+0002b370: 2023 206d 756c 7469 706c 6520 7363 7261   # multiple scra
+0002b380: 7463 6820 7374 6f72 6167 6573 2e0a 2020  tch storages..  
+0002b390: 2020 2020 2020 2320 5374 6f72 6573 2066        # Stores f
+0002b3a0: 6f72 2065 6163 6820 6f62 6a65 6374 2069  or each object i
+0002b3b0: 6e20 7468 6520 6c69 7374 206d 7573 7420  n the list must 
+0002b3c0: 6265 2061 6464 6564 2069 6e20 7468 6520  be added in the 
+0002b3d0: 7465 7374 2e0a 2020 2020 2020 2020 7374  test..        st
+0002b3e0: 6f72 6167 655f 6d75 6c74 5f6f 626a 203d  orage_mult_obj =
+0002b3f0: 205b 5d0a 2020 2020 2020 2020 666f 7220   [].        for 
+0002b400: 5f20 696e 2072 616e 6765 2835 293a 0a20  _ in range(5):. 
+0002b410: 2020 2020 2020 2020 2020 2074 696d 6573             times
+0002b420: 7461 6d70 203d 2073 7472 2874 696d 652e  tamp = str(time.
+0002b430: 7469 6d65 2829 292e 7265 706c 6163 6528  time()).replace(
+0002b440: 272e 272c 2027 2729 0a20 2020 2020 2020  '.', '').       
+0002b450: 2020 2020 2073 746f 7265 5f6f 626a 203d       store_obj =
+0002b460: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
+0002b470: 7261 6765 286e 616d 653d 6627 736b 792d  rage(name=f'sky-
+0002b480: 7465 7374 2d7b 7469 6d65 7374 616d 707d  test-{timestamp}
+0002b490: 2729 0a20 2020 2020 2020 2020 2020 2073  ').            s
+0002b4a0: 746f 7261 6765 5f6d 756c 745f 6f62 6a2e  torage_mult_obj.
+0002b4b0: 6170 7065 6e64 2873 746f 7265 5f6f 626a  append(store_obj
+0002b4c0: 290a 2020 2020 2020 2020 7969 656c 6420  ).        yield 
+0002b4d0: 7374 6f72 6167 655f 6d75 6c74 5f6f 626a  storage_mult_obj
+0002b4e0: 0a20 2020 2020 2020 2066 6f72 2073 746f  .        for sto
+0002b4f0: 7261 6765 5f6f 626a 2069 6e20 7374 6f72  rage_obj in stor
+0002b500: 6167 655f 6d75 6c74 5f6f 626a 3a0a 2020  age_mult_obj:.  
+0002b510: 2020 2020 2020 2020 2020 6861 6e64 6c65            handle
+0002b520: 203d 2067 6c6f 6261 6c5f 7573 6572 5f73   = global_user_s
+0002b530: 7461 7465 2e67 6574 5f68 616e 646c 655f  tate.get_handle_
+0002b540: 6672 6f6d 5f73 746f 7261 6765 5f6e 616d  from_storage_nam
+0002b550: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
+0002b560: 2020 2073 746f 7261 6765 5f6f 626a 2e6e     storage_obj.n
+0002b570: 616d 6529 0a20 2020 2020 2020 2020 2020  ame).           
+0002b580: 2069 6620 6861 6e64 6c65 3a0a 2020 2020   if handle:.    
+0002b590: 2020 2020 2020 2020 2020 2020 2320 4966              # If
+0002b5a0: 2068 616e 646c 6520 6578 6973 7473 2c20   handle exists, 
+0002b5b0: 6465 6c65 7465 206d 616e 7561 6c6c 790a  delete manually.
+0002b5c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b5d0: 2320 544f 444f 2872 6f6d 696c 6229 3a20  # TODO(romilb): 
+0002b5e0: 5468 6973 2069 7320 706f 7465 6e74 6961  This is potentia
+0002b5f0: 6c6c 7920 7269 736b 7920 2d20 6966 2074  lly risky - if t
+0002b600: 6865 2064 656c 6574 6520 6d65 7468 6f64  he delete method
+0002b610: 2068 6173 0a20 2020 2020 2020 2020 2020   has.           
+0002b620: 2020 2020 2023 2062 7567 732c 2074 6869       # bugs, thi
+0002b630: 7320 6361 6e20 6361 7573 6520 7265 736f  s can cause reso
+0002b640: 7572 6365 206c 6561 6b73 2e20 4964 6561  urce leaks. Idea
+0002b650: 6c6c 7920 7765 2073 686f 756c 6420 6d61  lly we should ma
+0002b660: 6e75 616c 6c79 0a20 2020 2020 2020 2020  nually.         
+0002b670: 2020 2020 2020 2023 2065 6a65 6374 2073         # eject s
+0002b680: 746f 7261 6765 2066 726f 6d20 676c 6f62  torage from glob
+0002b690: 616c 5f75 7365 725f 7374 6174 6520 616e  al_user_state an
+0002b6a0: 6420 6465 6c65 7465 2074 6865 2062 7563  d delete the buc
+0002b6b0: 6b65 7420 7573 696e 670a 2020 2020 2020  ket using.      
+0002b6c0: 2020 2020 2020 2020 2020 2320 626f 746f            # boto
+0002b6d0: 3320 6469 7265 6374 6c79 2e0a 2020 2020  3 directly..    
+0002b6e0: 2020 2020 2020 2020 2020 2020 7374 6f72              stor
+0002b6f0: 6167 655f 6f62 6a2e 6465 6c65 7465 2829  age_obj.delete()
+0002b700: 0a0a 2020 2020 4070 7974 6573 742e 6669  ..    @pytest.fi
+0002b710: 7874 7572 650a 2020 2020 6465 6620 746d  xture.    def tm
+0002b720: 705f 6d75 6c74 6970 6c65 5f63 7573 746f  p_multiple_custo
+0002b730: 6d5f 736f 7572 6365 5f73 746f 7261 6765  m_source_storage
+0002b740: 5f6f 626a 2873 656c 6629 3a0a 2020 2020  _obj(self):.    
+0002b750: 2020 2020 2320 4372 6561 7465 7320 6120      # Creates a 
+0002b760: 6c69 7374 206f 6620 7374 6f72 6167 6520  list of storage 
+0002b770: 6f62 6a65 6374 7320 7769 7468 2063 7573  objects with cus
+0002b780: 746f 6d20 736f 7572 6365 206e 616d 6573  tom source names
+0002b790: 2074 6f0a 2020 2020 2020 2020 2320 6372   to.        # cr
+0002b7a0: 6561 7465 206d 756c 7469 706c 6520 7363  eate multiple sc
+0002b7b0: 7261 7463 6820 7374 6f72 6167 6573 2e0a  ratch storages..
+0002b7c0: 2020 2020 2020 2020 2320 5374 6f72 6573          # Stores
+0002b7d0: 2066 6f72 2065 6163 6820 6f62 6a65 6374   for each object
+0002b7e0: 2069 6e20 7468 6520 6c69 7374 206d 7573   in the list mus
+0002b7f0: 7420 6265 2061 6464 6564 2069 6e20 7468  t be added in th
+0002b800: 6520 7465 7374 2e0a 2020 2020 2020 2020  e test..        
+0002b810: 6375 7374 6f6d 5f73 6f75 7263 655f 6e61  custom_source_na
+0002b820: 6d65 7320 3d20 5b27 2270 6174 6820 5769  mes = ['"path Wi
+0002b830: 7468 2053 7061 6365 7322 272c 2027 7061  th Spaces"', 'pa
+0002b840: 7468 2057 6974 6820 5370 6163 6573 275d  th With Spaces']
+0002b850: 0a20 2020 2020 2020 2073 746f 7261 6765  .        storage
+0002b860: 5f6d 756c 745f 6f62 6a20 3d20 5b5d 0a20  _mult_obj = []. 
+0002b870: 2020 2020 2020 2066 6f72 206e 616d 6520         for name 
+0002b880: 696e 2063 7573 746f 6d5f 736f 7572 6365  in custom_source
+0002b890: 5f6e 616d 6573 3a0a 2020 2020 2020 2020  _names:.        
+0002b8a0: 2020 2020 7372 635f 7061 7468 203d 206f      src_path = o
+0002b8b0: 732e 7061 7468 2e65 7870 616e 6475 7365  s.path.expanduse
+0002b8c0: 7228 6627 7e2f 7b6e 616d 657d 2729 0a20  r(f'~/{name}'). 
+0002b8d0: 2020 2020 2020 2020 2020 2070 6174 686c             pathl
+0002b8e0: 6962 2e50 6174 6828 7372 635f 7061 7468  ib.Path(src_path
+0002b8f0: 292e 6578 7061 6e64 7573 6572 2829 2e6d  ).expanduser().m
+0002b900: 6b64 6972 2865 7869 7374 5f6f 6b3d 5472  kdir(exist_ok=Tr
+0002b910: 7565 290a 2020 2020 2020 2020 2020 2020  ue).            
+0002b920: 7469 6d65 7374 616d 7020 3d20 7374 7228  timestamp = str(
+0002b930: 7469 6d65 2e74 696d 6528 2929 2e72 6570  time.time()).rep
+0002b940: 6c61 6365 2827 2e27 2c20 2727 290a 2020  lace('.', '').  
+0002b950: 2020 2020 2020 2020 2020 7374 6f72 655f            store_
+0002b960: 6f62 6a20 3d20 7374 6f72 6167 655f 6c69  obj = storage_li
+0002b970: 622e 5374 6f72 6167 6528 6e61 6d65 3d66  b.Storage(name=f
+0002b980: 2773 6b79 2d74 6573 742d 7b74 696d 6573  'sky-test-{times
+0002b990: 7461 6d70 7d27 2c0a 2020 2020 2020 2020  tamp}',.        
+0002b9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b9b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b9c0: 2020 2020 736f 7572 6365 3d73 7263 5f70      source=src_p
+0002b9d0: 6174 6829 0a20 2020 2020 2020 2020 2020  ath).           
+0002b9e0: 2073 746f 7261 6765 5f6d 756c 745f 6f62   storage_mult_ob
+0002b9f0: 6a2e 6170 7065 6e64 2873 746f 7265 5f6f  j.append(store_o
+0002ba00: 626a 290a 2020 2020 2020 2020 7969 656c  bj).        yiel
+0002ba10: 6420 7374 6f72 6167 655f 6d75 6c74 5f6f  d storage_mult_o
+0002ba20: 626a 0a20 2020 2020 2020 2066 6f72 2073  bj.        for s
+0002ba30: 746f 7261 6765 5f6f 626a 2069 6e20 7374  torage_obj in st
+0002ba40: 6f72 6167 655f 6d75 6c74 5f6f 626a 3a0a  orage_mult_obj:.
+0002ba50: 2020 2020 2020 2020 2020 2020 6861 6e64              hand
+0002ba60: 6c65 203d 2067 6c6f 6261 6c5f 7573 6572  le = global_user
+0002ba70: 5f73 7461 7465 2e67 6574 5f68 616e 646c  _state.get_handl
+0002ba80: 655f 6672 6f6d 5f73 746f 7261 6765 5f6e  e_from_storage_n
+0002ba90: 616d 6528 0a20 2020 2020 2020 2020 2020  ame(.           
+0002baa0: 2020 2020 2073 746f 7261 6765 5f6f 626a       storage_obj
+0002bab0: 2e6e 616d 6529 0a20 2020 2020 2020 2020  .name).         
+0002bac0: 2020 2069 6620 6861 6e64 6c65 3a0a 2020     if handle:.  
+0002bad0: 2020 2020 2020 2020 2020 2020 2020 7374                st
+0002bae0: 6f72 6167 655f 6f62 6a2e 6465 6c65 7465  orage_obj.delete
+0002baf0: 2829 0a0a 2020 2020 4070 7974 6573 742e  ()..    @pytest.
+0002bb00: 6669 7874 7572 650a 2020 2020 6465 6620  fixture.    def 
+0002bb10: 746d 705f 6c6f 6361 6c5f 7374 6f72 6167  tmp_local_storag
+0002bb20: 655f 6f62 6a28 7365 6c66 2c20 746d 705f  e_obj(self, tmp_
+0002bb30: 6275 636b 6574 5f6e 616d 652c 2074 6d70  bucket_name, tmp
+0002bb40: 5f73 6f75 7263 6529 3a0a 2020 2020 2020  _source):.      
+0002bb50: 2020 2320 4372 6561 7465 7320 6120 7465    # Creates a te
+0002bb60: 6d70 6f72 6172 7920 7374 6f72 6167 6520  mporary storage 
+0002bb70: 6f62 6a65 6374 2e20 5374 6f72 6573 206d  object. Stores m
+0002bb80: 7573 7420 6265 2061 6464 6564 2069 6e20  ust be added in 
+0002bb90: 7468 6520 7465 7374 2e0a 2020 2020 2020  the test..      
+0002bba0: 2020 7969 656c 6420 6672 6f6d 2073 656c    yield from sel
+0002bbb0: 662e 7969 656c 645f 7374 6f72 6167 655f  f.yield_storage_
+0002bbc0: 6f62 6a65 6374 286e 616d 653d 746d 705f  object(name=tmp_
+0002bbd0: 6275 636b 6574 5f6e 616d 652c 0a20 2020  bucket_name,.   
+0002bbe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bbf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bc00: 2020 2020 2020 2020 2020 736f 7572 6365            source
+0002bc10: 3d74 6d70 5f73 6f75 7263 6529 0a0a 2020  =tmp_source)..  
+0002bc20: 2020 4070 7974 6573 742e 6669 7874 7572    @pytest.fixtur
+0002bc30: 650a 2020 2020 6465 6620 746d 705f 6c6f  e.    def tmp_lo
+0002bc40: 6361 6c5f 6c69 7374 5f73 746f 7261 6765  cal_list_storage
+0002bc50: 5f6f 626a 2873 656c 662c 2074 6d70 5f62  _obj(self, tmp_b
+0002bc60: 7563 6b65 745f 6e61 6d65 2c20 746d 705f  ucket_name, tmp_
+0002bc70: 736f 7572 6365 293a 0a20 2020 2020 2020  source):.       
+0002bc80: 2023 2043 7265 6174 6573 2061 2074 656d   # Creates a tem
+0002bc90: 7020 7374 6f72 6167 6520 6f62 6a65 6374  p storage object
+0002bca0: 2077 6869 6368 2075 7365 7320 6120 6c69   which uses a li
+0002bcb0: 7374 206f 6620 7061 7468 7320 6173 2073  st of paths as s
+0002bcc0: 6f75 7263 652e 0a20 2020 2020 2020 2023  ource..        #
+0002bcd0: 2053 746f 7265 7320 6d75 7374 2062 6520   Stores must be 
+0002bce0: 6164 6465 6420 696e 2074 6865 2074 6573  added in the tes
+0002bcf0: 742e 2041 6674 6572 2075 706c 6f61 642c  t. After upload,
+0002bd00: 2074 6865 2062 7563 6b65 7420 7368 6f75   the bucket shou
+0002bd10: 6c64 0a20 2020 2020 2020 2023 2068 6176  ld.        # hav
+0002bd20: 6520 7477 6f20 6669 6c65 7320 2d20 2f74  e two files - /t
+0002bd30: 6d70 2d66 696c 6520 616e 6420 2f74 6d70  mp-file and /tmp
+0002bd40: 2d73 6f75 7263 652f 746d 702d 6669 6c65  -source/tmp-file
+0002bd50: 0a20 2020 2020 2020 206c 6973 745f 736f  .        list_so
+0002bd60: 7572 6365 203d 205b 746d 705f 736f 7572  urce = [tmp_sour
+0002bd70: 6365 2c20 746d 705f 736f 7572 6365 202b  ce, tmp_source +
+0002bd80: 2027 2f74 6d70 2d66 696c 6527 5d0a 2020   '/tmp-file'].  
+0002bd90: 2020 2020 2020 7969 656c 6420 6672 6f6d        yield from
+0002bda0: 2073 656c 662e 7969 656c 645f 7374 6f72   self.yield_stor
+0002bdb0: 6167 655f 6f62 6a65 6374 286e 616d 653d  age_object(name=
+0002bdc0: 746d 705f 6275 636b 6574 5f6e 616d 652c  tmp_bucket_name,
+0002bdd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002bde0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bdf0: 2020 2020 2020 2020 2020 2020 2020 736f                so
+0002be00: 7572 6365 3d6c 6973 745f 736f 7572 6365  urce=list_source
+0002be10: 290a 0a20 2020 2040 7079 7465 7374 2e66  )..    @pytest.f
+0002be20: 6978 7475 7265 0a20 2020 2064 6566 2074  ixture.    def t
+0002be30: 6d70 5f62 756c 6b5f 6465 6c5f 7374 6f72  mp_bulk_del_stor
+0002be40: 6167 655f 6f62 6a28 7365 6c66 2c20 746d  age_obj(self, tm
+0002be50: 705f 6275 636b 6574 5f6e 616d 6529 3a0a  p_bucket_name):.
+0002be60: 2020 2020 2020 2020 2320 4372 6561 7465          # Create
+0002be70: 7320 6120 7465 6d70 6f72 6172 7920 7374  s a temporary st
+0002be80: 6f72 6167 6520 6f62 6a65 6374 2066 6f72  orage object for
+0002be90: 2074 6573 7469 6e67 2062 756c 6b20 6465   testing bulk de
+0002bea0: 6c65 7469 6f6e 2e0a 2020 2020 2020 2020  letion..        
+0002beb0: 2320 5374 6f72 6573 206d 7573 7420 6265  # Stores must be
+0002bec0: 2061 6464 6564 2069 6e20 7468 6520 7465   added in the te
+0002bed0: 7374 2e0a 2020 2020 2020 2020 7769 7468  st..        with
+0002bee0: 2074 656d 7066 696c 652e 5465 6d70 6f72   tempfile.Tempor
+0002bef0: 6172 7944 6972 6563 746f 7279 2829 2061  aryDirectory() a
+0002bf00: 7320 746d 7064 6972 3a0a 2020 2020 2020  s tmpdir:.      
+0002bf10: 2020 2020 2020 7375 6270 726f 6365 7373        subprocess
+0002bf20: 2e63 6865 636b 5f6f 7574 7075 7428 6627  .check_output(f'
+0002bf30: 6d6b 6469 7220 2d70 207b 746d 7064 6972  mkdir -p {tmpdir
+0002bf40: 7d2f 666f 6c64 6572 7b7b 3030 302e 2e32  }/folder{{000..2
+0002bf50: 3535 7d7d 272c 0a20 2020 2020 2020 2020  55}}',.         
+0002bf60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bf70: 2020 2020 2020 2020 2020 2073 6865 6c6c             shell
+0002bf80: 3d54 7275 6529 0a20 2020 2020 2020 2020  =True).         
+0002bf90: 2020 2073 7562 7072 6f63 6573 732e 6368     subprocess.ch
+0002bfa0: 6563 6b5f 6f75 7470 7574 2866 2774 6f75  eck_output(f'tou
+0002bfb0: 6368 207b 746d 7064 6972 7d2f 7465 7374  ch {tmpdir}/test
+0002bfc0: 7b7b 3030 302e 2e32 3535 7d7d 2e74 7874  {{000..255}}.txt
+0002bfd0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+0002bfe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bff0: 2020 2020 2020 2073 6865 6c6c 3d54 7275         shell=Tru
+0002c000: 6529 0a20 2020 2020 2020 2020 2020 2073  e).            s
+0002c010: 7562 7072 6f63 6573 732e 6368 6563 6b5f  ubprocess.check_
+0002c020: 6f75 7470 7574 280a 2020 2020 2020 2020  output(.        
+0002c030: 2020 2020 2020 2020 6627 746f 7563 6820          f'touch 
+0002c040: 7b74 6d70 6469 727d 2f66 6f6c 6465 727b  {tmpdir}/folder{
+0002c050: 7b30 3030 2e2e 3235 357d 7d2f 7465 7374  {000..255}}/test
+0002c060: 2e74 7874 272c 2073 6865 6c6c 3d54 7275  .txt', shell=Tru
+0002c070: 6529 0a20 2020 2020 2020 2020 2020 2079  e).            y
+0002c080: 6965 6c64 2066 726f 6d20 7365 6c66 2e79  ield from self.y
+0002c090: 6965 6c64 5f73 746f 7261 6765 5f6f 626a  ield_storage_obj
+0002c0a0: 6563 7428 6e61 6d65 3d74 6d70 5f62 7563  ect(name=tmp_buc
+0002c0b0: 6b65 745f 6e61 6d65 2c0a 2020 2020 2020  ket_name,.      
+0002c0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c0d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c0e0: 2020 2020 2020 2020 2020 2073 6f75 7263             sourc
+0002c0f0: 653d 746d 7064 6972 290a 0a20 2020 2040  e=tmpdir)..    @
+0002c100: 7079 7465 7374 2e66 6978 7475 7265 0a20  pytest.fixture. 
+0002c110: 2020 2064 6566 2074 6d70 5f63 6f70 795f     def tmp_copy_
+0002c120: 6d6e 745f 6578 6973 7469 6e67 5f73 746f  mnt_existing_sto
+0002c130: 7261 6765 5f6f 626a 2873 656c 662c 2074  rage_obj(self, t
+0002c140: 6d70 5f73 6372 6174 6368 5f73 746f 7261  mp_scratch_stora
+0002c150: 6765 5f6f 626a 293a 0a20 2020 2020 2020  ge_obj):.       
+0002c160: 2023 2043 7265 6174 6573 2061 2063 6f70   # Creates a cop
+0002c170: 7920 6d6f 756e 7420 7374 6f72 6167 6520  y mount storage 
+0002c180: 7768 6963 6820 7265 7573 6573 2061 6e20  which reuses an 
+0002c190: 6578 6973 7469 6e67 2073 746f 7261 6765  existing storage
+0002c1a0: 206f 626a 6563 742e 0a20 2020 2020 2020   object..       
+0002c1b0: 2074 6d70 5f73 6372 6174 6368 5f73 746f   tmp_scratch_sto
+0002c1c0: 7261 6765 5f6f 626a 2e61 6464 5f73 746f  rage_obj.add_sto
+0002c1d0: 7265 2873 746f 7261 6765 5f6c 6962 2e53  re(storage_lib.S
+0002c1e0: 746f 7265 5479 7065 2e53 3329 0a20 2020  toreType.S3).   
+0002c1f0: 2020 2020 2073 746f 7261 6765 5f6e 616d       storage_nam
+0002c200: 6520 3d20 746d 705f 7363 7261 7463 685f  e = tmp_scratch_
+0002c210: 7374 6f72 6167 655f 6f62 6a2e 6e61 6d65  storage_obj.name
+0002c220: 0a0a 2020 2020 2020 2020 2320 5472 7920  ..        # Try 
+0002c230: 746f 2069 6e69 7469 616c 697a 6520 616e  to initialize an
+0002c240: 6f74 6865 7220 7374 6f72 6167 6520 7769  other storage wi
+0002c250: 7468 2074 6865 2073 746f 7261 6765 206f  th the storage o
+0002c260: 626a 6563 7420 6372 6561 7465 640a 2020  bject created.  
+0002c270: 2020 2020 2020 2320 6162 6f76 652c 2062        # above, b
+0002c280: 7574 206e 6f77 2069 6e20 434f 5059 206d  ut now in COPY m
+0002c290: 6f64 652e 2054 6869 7320 7368 6f75 6c64  ode. This should
+0002c2a0: 2073 7563 6365 6564 2e0a 2020 2020 2020   succeed..      
+0002c2b0: 2020 7969 656c 6420 6672 6f6d 2073 656c    yield from sel
+0002c2c0: 662e 7969 656c 645f 7374 6f72 6167 655f  f.yield_storage_
+0002c2d0: 6f62 6a65 6374 286e 616d 653d 7374 6f72  object(name=stor
+0002c2e0: 6167 655f 6e61 6d65 2c0a 2020 2020 2020  age_name,.      
+0002c2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c310: 2020 2020 2020 206d 6f64 653d 7374 6f72         mode=stor
+0002c320: 6167 655f 6c69 622e 5374 6f72 6167 654d  age_lib.StorageM
+0002c330: 6f64 652e 434f 5059 290a 0a20 2020 2040  ode.COPY)..    @
+0002c340: 7079 7465 7374 2e66 6978 7475 7265 0a20  pytest.fixture. 
+0002c350: 2020 2064 6566 2074 6d70 5f67 6974 6967     def tmp_gitig
+0002c360: 6e6f 7265 5f73 746f 7261 6765 5f6f 626a  nore_storage_obj
+0002c370: 2873 656c 662c 2074 6d70 5f62 7563 6b65  (self, tmp_bucke
+0002c380: 745f 6e61 6d65 2c20 6769 7469 676e 6f72  t_name, gitignor
+0002c390: 655f 7374 7275 6374 7572 6529 3a0a 2020  e_structure):.  
+0002c3a0: 2020 2020 2020 2320 4372 6561 7465 7320        # Creates 
+0002c3b0: 6120 7465 6d70 6f72 6172 7920 7374 6f72  a temporary stor
+0002c3c0: 6167 6520 6f62 6a65 6374 2066 6f72 2074  age object for t
+0002c3d0: 6573 7469 6e67 202e 6769 7469 676e 6f72  esting .gitignor
+0002c3e0: 6520 6669 6c74 6572 2e0a 2020 2020 2020  e filter..      
+0002c3f0: 2020 2320 4749 5449 4749 4e4f 5245 5f53    # GITIGINORE_S
+0002c400: 5452 5543 5455 5245 2069 7320 7265 7072  TRUCTURE is repr
+0002c410: 6573 656e 7469 6e67 2061 2066 696c 6520  esenting a file 
+0002c420: 7374 7275 6374 7572 6520 696e 2061 2064  structure in a d
+0002c430: 6963 7469 6f6e 6172 790a 2020 2020 2020  ictionary.      
+0002c440: 2020 2320 666f 726d 6174 2e20 4372 6561    # format. Crea
+0002c450: 7465 6420 7374 6f72 6167 6520 6f62 6a65  ted storage obje
+0002c460: 6374 2077 696c 6c20 636f 6e74 6169 6e20  ct will contain 
+0002c470: 7468 6520 6669 6c65 2073 7472 7563 7475  the file structu
+0002c480: 7265 2061 6c6f 6e67 0a20 2020 2020 2020  re along.       
+0002c490: 2023 2077 6974 6820 2e67 6974 6967 6e6f   # with .gitigno
+0002c4a0: 7265 2061 6e64 202e 6769 742f 696e 666f  re and .git/info
+0002c4b0: 2f65 7863 6c75 6465 2066 696c 6573 2074  /exclude files t
+0002c4c0: 6f20 7465 7374 2065 7863 6c75 6465 2066  o test exclude f
+0002c4d0: 696c 7465 722e 0a20 2020 2020 2020 2023  ilter..        #
+0002c4e0: 2053 746f 7265 7320 6d75 7374 2062 6520   Stores must be 
+0002c4f0: 6164 6465 6420 696e 2074 6865 2074 6573  added in the tes
+0002c500: 742e 0a20 2020 2020 2020 2077 6974 6820  t..        with 
+0002c510: 7465 6d70 6669 6c65 2e54 656d 706f 7261  tempfile.Tempora
+0002c520: 7279 4469 7265 6374 6f72 7928 2920 6173  ryDirectory() as
+0002c530: 2074 6d70 6469 723a 0a20 2020 2020 2020   tmpdir:.       
+0002c540: 2020 2020 2023 2043 7265 6174 6573 2066       # Creates f
+0002c550: 696c 6520 7374 7275 6374 7572 6520 746f  ile structure to
+0002c560: 2062 6520 7570 6c6f 6164 6564 2069 6e20   be uploaded in 
+0002c570: 7468 6520 5374 6f72 6167 650a 2020 2020  the Storage.    
+0002c580: 2020 2020 2020 2020 7365 6c66 2e63 7265          self.cre
+0002c590: 6174 655f 6469 725f 7374 7275 6374 7572  ate_dir_structur
+0002c5a0: 6528 746d 7064 6972 2c20 6769 7469 676e  e(tmpdir, gitign
+0002c5b0: 6f72 655f 7374 7275 6374 7572 6529 0a0a  ore_structure)..
+0002c5c0: 2020 2020 2020 2020 2020 2020 2320 4372              # Cr
+0002c5d0: 6561 7465 202e 6769 7469 676e 6f72 6520  eate .gitignore 
+0002c5e0: 616e 6420 6c69 7374 2066 696c 6573 2f64  and list files/d
+0002c5f0: 6972 7320 746f 2062 6520 6578 636c 7564  irs to be exclud
+0002c600: 6564 2069 6e20 6974 0a20 2020 2020 2020  ed in it.       
+0002c610: 2020 2020 2073 6b79 7069 6c6f 745f 7061       skypilot_pa
+0002c620: 7468 203d 206f 732e 7061 7468 2e64 6972  th = os.path.dir
+0002c630: 6e61 6d65 286f 732e 7061 7468 2e64 6972  name(os.path.dir
+0002c640: 6e61 6d65 2873 6b79 2e5f 5f66 696c 655f  name(sky.__file_
+0002c650: 5f29 290a 2020 2020 2020 2020 2020 2020  _)).            
+0002c660: 7465 6d70 5f70 6174 6820 3d20 6627 7b74  temp_path = f'{t
+0002c670: 6d70 6469 727d 2f2e 6769 7469 676e 6f72  mpdir}/.gitignor
+0002c680: 6527 0a20 2020 2020 2020 2020 2020 2066  e'.            f
+0002c690: 696c 655f 7061 7468 203d 206f 732e 7061  ile_path = os.pa
+0002c6a0: 7468 2e6a 6f69 6e28 736b 7970 696c 6f74  th.join(skypilot
+0002c6b0: 5f70 6174 682c 2027 7465 7374 732f 6769  _path, 'tests/gi
+0002c6c0: 7469 676e 6f72 655f 7465 7374 2729 0a20  tignore_test'). 
+0002c6d0: 2020 2020 2020 2020 2020 2073 6875 7469             shuti
+0002c6e0: 6c2e 636f 7079 6669 6c65 2866 696c 655f  l.copyfile(file_
+0002c6f0: 7061 7468 2c20 7465 6d70 5f70 6174 6829  path, temp_path)
+0002c700: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+0002c710: 4372 6561 7465 202e 6769 742f 696e 666f  Create .git/info
+0002c720: 2f65 7863 6c75 6465 2061 6e64 206c 6973  /exclude and lis
+0002c730: 7420 6669 6c65 732f 6469 7273 2074 6f20  t files/dirs to 
+0002c740: 6265 2065 7863 6c75 6465 6420 696e 2069  be excluded in i
+0002c750: 740a 2020 2020 2020 2020 2020 2020 7465  t.            te
+0002c760: 6d70 5f70 6174 6820 3d20 6627 7b74 6d70  mp_path = f'{tmp
+0002c770: 6469 727d 2f2e 6769 742f 696e 666f 2f27  dir}/.git/info/'
+0002c780: 0a20 2020 2020 2020 2020 2020 206f 732e  .            os.
+0002c790: 6d61 6b65 6469 7273 2874 656d 705f 7061  makedirs(temp_pa
+0002c7a0: 7468 290a 2020 2020 2020 2020 2020 2020  th).            
+0002c7b0: 7465 6d70 5f65 7863 6c75 6465 5f70 6174  temp_exclude_pat
+0002c7c0: 6820 3d20 6f73 2e70 6174 682e 6a6f 696e  h = os.path.join
+0002c7d0: 2874 656d 705f 7061 7468 2c20 2765 7863  (temp_path, 'exc
+0002c7e0: 6c75 6465 2729 0a20 2020 2020 2020 2020  lude').         
+0002c7f0: 2020 2066 696c 655f 7061 7468 203d 206f     file_path = o
+0002c800: 732e 7061 7468 2e6a 6f69 6e28 736b 7970  s.path.join(skyp
+0002c810: 696c 6f74 5f70 6174 682c 0a20 2020 2020  ilot_path,.     
+0002c820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c840: 2774 6573 7473 2f67 6974 5f69 6e66 6f5f  'tests/git_info_
+0002c850: 6578 636c 7564 655f 7465 7374 2729 0a20  exclude_test'). 
+0002c860: 2020 2020 2020 2020 2020 2073 6875 7469             shuti
+0002c870: 6c2e 636f 7079 6669 6c65 2866 696c 655f  l.copyfile(file_
+0002c880: 7061 7468 2c20 7465 6d70 5f65 7863 6c75  path, temp_exclu
+0002c890: 6465 5f70 6174 6829 0a0a 2020 2020 2020  de_path)..      
+0002c8a0: 2020 2020 2020 2320 4372 6561 7465 2073        # Create s
+0002c8b0: 6b79 2053 746f 7261 6765 2077 6974 6820  ky Storage with 
+0002c8c0: 7468 6520 6669 6c65 7320 6372 6561 7465  the files create
+0002c8d0: 640a 2020 2020 2020 2020 2020 2020 7969  d.            yi
+0002c8e0: 656c 6420 6672 6f6d 2073 656c 662e 7969  eld from self.yi
+0002c8f0: 656c 645f 7374 6f72 6167 655f 6f62 6a65  eld_storage_obje
+0002c900: 6374 280a 2020 2020 2020 2020 2020 2020  ct(.            
+0002c910: 2020 2020 6e61 6d65 3d74 6d70 5f62 7563      name=tmp_buc
+0002c920: 6b65 745f 6e61 6d65 2c0a 2020 2020 2020  ket_name,.      
+0002c930: 2020 2020 2020 2020 2020 736f 7572 6365            source
+0002c940: 3d74 6d70 6469 722c 0a20 2020 2020 2020  =tmpdir,.       
+0002c950: 2020 2020 2020 2020 206d 6f64 653d 7374           mode=st
+0002c960: 6f72 6167 655f 6c69 622e 5374 6f72 6167  orage_lib.Storag
+0002c970: 654d 6f64 652e 434f 5059 290a 0a20 2020  eMode.COPY)..   
+0002c980: 2040 7079 7465 7374 2e66 6978 7475 7265   @pytest.fixture
+0002c990: 0a20 2020 2064 6566 2074 6d70 5f61 7773  .    def tmp_aws
+0002c9a0: 636c 695f 6275 636b 6574 2873 656c 662c  cli_bucket(self,
+0002c9b0: 2074 6d70 5f62 7563 6b65 745f 6e61 6d65   tmp_bucket_name
+0002c9c0: 293a 0a20 2020 2020 2020 2023 2043 7265  ):.        # Cre
+0002c9d0: 6174 6573 2061 2074 656d 706f 7261 7279  ates a temporary
+0002c9e0: 2062 7563 6b65 7420 7573 696e 6720 6177   bucket using aw
+0002c9f0: 7363 6c69 0a20 2020 2020 2020 2062 7563  scli.        buc
+0002ca00: 6b65 745f 7572 6920 3d20 6627 7333 3a2f  ket_uri = f's3:/
+0002ca10: 2f7b 746d 705f 6275 636b 6574 5f6e 616d  /{tmp_bucket_nam
+0002ca20: 657d 270a 2020 2020 2020 2020 7375 6270  e}'.        subp
+0002ca30: 726f 6365 7373 2e63 6865 636b 5f63 616c  rocess.check_cal
+0002ca40: 6c28 5b27 6177 7327 2c20 2773 3327 2c20  l(['aws', 's3', 
+0002ca50: 276d 6227 2c20 6275 636b 6574 5f75 7269  'mb', bucket_uri
+0002ca60: 5d29 0a20 2020 2020 2020 2079 6965 6c64  ]).        yield
+0002ca70: 2074 6d70 5f62 7563 6b65 745f 6e61 6d65   tmp_bucket_name
+0002ca80: 2c20 6275 636b 6574 5f75 7269 0a20 2020  , bucket_uri.   
+0002ca90: 2020 2020 2073 7562 7072 6f63 6573 732e       subprocess.
+0002caa0: 6368 6563 6b5f 6361 6c6c 285b 2761 7773  check_call(['aws
+0002cab0: 272c 2027 7333 272c 2027 7262 272c 2062  ', 's3', 'rb', b
+0002cac0: 7563 6b65 745f 7572 692c 2027 2d2d 666f  ucket_uri, '--fo
+0002cad0: 7263 6527 5d29 0a0a 2020 2020 4070 7974  rce'])..    @pyt
+0002cae0: 6573 742e 6669 7874 7572 650a 2020 2020  est.fixture.    
+0002caf0: 6465 6620 746d 705f 6773 7574 696c 5f62  def tmp_gsutil_b
+0002cb00: 7563 6b65 7428 7365 6c66 2c20 746d 705f  ucket(self, tmp_
+0002cb10: 6275 636b 6574 5f6e 616d 6529 3a0a 2020  bucket_name):.  
+0002cb20: 2020 2020 2020 2320 4372 6561 7465 7320        # Creates 
+0002cb30: 6120 7465 6d70 6f72 6172 7920 6275 636b  a temporary buck
+0002cb40: 6574 2075 7369 6e67 2067 7375 7469 6c0a  et using gsutil.
+0002cb50: 2020 2020 2020 2020 6275 636b 6574 5f75          bucket_u
+0002cb60: 7269 203d 2066 2767 733a 2f2f 7b74 6d70  ri = f'gs://{tmp
+0002cb70: 5f62 7563 6b65 745f 6e61 6d65 7d27 0a20  _bucket_name}'. 
+0002cb80: 2020 2020 2020 2073 7562 7072 6f63 6573         subproces
+0002cb90: 732e 6368 6563 6b5f 6361 6c6c 285b 2767  s.check_call(['g
+0002cba0: 7375 7469 6c27 2c20 276d 6227 2c20 6275  sutil', 'mb', bu
+0002cbb0: 636b 6574 5f75 7269 5d29 0a20 2020 2020  cket_uri]).     
+0002cbc0: 2020 2079 6965 6c64 2074 6d70 5f62 7563     yield tmp_buc
+0002cbd0: 6b65 745f 6e61 6d65 2c20 6275 636b 6574  ket_name, bucket
+0002cbe0: 5f75 7269 0a20 2020 2020 2020 2073 7562  _uri.        sub
+0002cbf0: 7072 6f63 6573 732e 6368 6563 6b5f 6361  process.check_ca
+0002cc00: 6c6c 285b 2767 7375 7469 6c27 2c20 2772  ll(['gsutil', 'r
+0002cc10: 6d27 2c20 272d 7227 2c20 6275 636b 6574  m', '-r', bucket
+0002cc20: 5f75 7269 5d29 0a0a 2020 2020 4070 7974  _uri])..    @pyt
+0002cc30: 6573 742e 6669 7874 7572 650a 2020 2020  est.fixture.    
+0002cc40: 6465 6620 746d 705f 6177 7363 6c69 5f62  def tmp_awscli_b
+0002cc50: 7563 6b65 745f 7232 2873 656c 662c 2074  ucket_r2(self, t
+0002cc60: 6d70 5f62 7563 6b65 745f 6e61 6d65 293a  mp_bucket_name):
+0002cc70: 0a20 2020 2020 2020 2023 2043 7265 6174  .        # Creat
+0002cc80: 6573 2061 2074 656d 706f 7261 7279 2062  es a temporary b
+0002cc90: 7563 6b65 7420 7573 696e 6720 6177 7363  ucket using awsc
+0002cca0: 6c69 0a20 2020 2020 2020 2065 6e64 706f  li.        endpo
+0002ccb0: 696e 745f 7572 6c20 3d20 636c 6f75 6466  int_url = cloudf
+0002ccc0: 6c61 7265 2e63 7265 6174 655f 656e 6470  lare.create_endp
+0002ccd0: 6f69 6e74 2829 0a20 2020 2020 2020 2062  oint().        b
+0002cce0: 7563 6b65 745f 7572 6920 3d20 6627 7333  ucket_uri = f's3
+0002ccf0: 3a2f 2f7b 746d 705f 6275 636b 6574 5f6e  ://{tmp_bucket_n
+0002cd00: 616d 657d 270a 2020 2020 2020 2020 7375  ame}'.        su
+0002cd10: 6270 726f 6365 7373 2e63 6865 636b 5f63  bprocess.check_c
+0002cd20: 616c 6c28 0a20 2020 2020 2020 2020 2020  all(.           
+0002cd30: 2066 2741 5753 5f53 4841 5245 445f 4352   f'AWS_SHARED_CR
+0002cd40: 4544 454e 5449 414c 535f 4649 4c45 3d7b  EDENTIALS_FILE={
+0002cd50: 636c 6f75 6466 6c61 7265 2e52 325f 4352  cloudflare.R2_CR
+0002cd60: 4544 454e 5449 414c 535f 5041 5448 7d20  EDENTIALS_PATH} 
+0002cd70: 6177 7320 7333 206d 6220 7b62 7563 6b65  aws s3 mb {bucke
+0002cd80: 745f 7572 697d 202d 2d65 6e64 706f 696e  t_uri} --endpoin
+0002cd90: 7420 7b65 6e64 706f 696e 745f 7572 6c7d  t {endpoint_url}
+0002cda0: 202d 2d70 726f 6669 6c65 3d72 3227 2c0a   --profile=r2',.
+0002cdb0: 2020 2020 2020 2020 2020 2020 7368 656c              shel
+0002cdc0: 6c3d 5472 7565 290a 2020 2020 2020 2020  l=True).        
+0002cdd0: 7969 656c 6420 746d 705f 6275 636b 6574  yield tmp_bucket
+0002cde0: 5f6e 616d 652c 2062 7563 6b65 745f 7572  _name, bucket_ur
+0002cdf0: 690a 2020 2020 2020 2020 7375 6270 726f  i.        subpro
+0002ce00: 6365 7373 2e63 6865 636b 5f63 616c 6c28  cess.check_call(
+0002ce10: 0a20 2020 2020 2020 2020 2020 2066 2741  .            f'A
+0002ce20: 5753 5f53 4841 5245 445f 4352 4544 454e  WS_SHARED_CREDEN
+0002ce30: 5449 414c 535f 4649 4c45 3d7b 636c 6f75  TIALS_FILE={clou
+0002ce40: 6466 6c61 7265 2e52 325f 4352 4544 454e  dflare.R2_CREDEN
+0002ce50: 5449 414c 535f 5041 5448 7d20 6177 7320  TIALS_PATH} aws 
+0002ce60: 7333 2072 6220 7b62 7563 6b65 745f 7572  s3 rb {bucket_ur
+0002ce70: 697d 202d 2d66 6f72 6365 202d 2d65 6e64  i} --force --end
+0002ce80: 706f 696e 7420 7b65 6e64 706f 696e 745f  point {endpoint_
+0002ce90: 7572 6c7d 202d 2d70 726f 6669 6c65 3d72  url} --profile=r
+0002cea0: 3227 2c0a 2020 2020 2020 2020 2020 2020  2',.            
+0002ceb0: 7368 656c 6c3d 5472 7565 290a 0a20 2020  shell=True)..   
+0002cec0: 2040 7079 7465 7374 2e66 6978 7475 7265   @pytest.fixture
+0002ced0: 0a20 2020 2064 6566 2074 6d70 5f69 626d  .    def tmp_ibm
+0002cee0: 5f63 6f73 5f62 7563 6b65 7428 7365 6c66  _cos_bucket(self
+0002cef0: 2c20 746d 705f 6275 636b 6574 5f6e 616d  , tmp_bucket_nam
+0002cf00: 6529 3a0a 2020 2020 2020 2020 2320 4372  e):.        # Cr
+0002cf10: 6561 7465 7320 6120 7465 6d70 6f72 6172  eates a temporar
+0002cf20: 7920 6275 636b 6574 2075 7369 6e67 2049  y bucket using I
+0002cf30: 424d 2043 4f53 2041 5049 0a20 2020 2020  BM COS API.     
+0002cf40: 2020 2073 746f 7261 6765 5f6f 626a 203d     storage_obj =
+0002cf50: 2073 746f 7261 6765 5f6c 6962 2e49 424d   storage_lib.IBM
+0002cf60: 436f 7353 746f 7265 2873 6f75 7263 653d  CosStore(source=
+0002cf70: 2222 2c20 6e61 6d65 3d74 6d70 5f62 7563  "", name=tmp_buc
+0002cf80: 6b65 745f 6e61 6d65 290a 2020 2020 2020  ket_name).      
+0002cf90: 2020 7969 656c 6420 746d 705f 6275 636b    yield tmp_buck
+0002cfa0: 6574 5f6e 616d 650a 2020 2020 2020 2020  et_name.        
+0002cfb0: 7374 6f72 6167 655f 6f62 6a2e 6465 6c65  storage_obj.dele
+0002cfc0: 7465 2829 0a0a 2020 2020 4070 7974 6573  te()..    @pytes
+0002cfd0: 742e 6669 7874 7572 650a 2020 2020 6465  t.fixture.    de
+0002cfe0: 6620 746d 705f 7075 626c 6963 5f73 746f  f tmp_public_sto
+0002cff0: 7261 6765 5f6f 626a 2873 656c 662c 2072  rage_obj(self, r
+0002d000: 6571 7565 7374 293a 0a20 2020 2020 2020  equest):.       
+0002d010: 2023 2049 6e69 7469 616c 697a 6573 2061   # Initializes a
+0002d020: 2073 746f 7261 6765 206f 626a 6563 7420   storage object 
+0002d030: 7769 7468 2061 2070 7562 6c69 6320 6275  with a public bu
+0002d040: 636b 6574 0a20 2020 2020 2020 2073 746f  cket.        sto
+0002d050: 7261 6765 5f6f 626a 203d 2073 746f 7261  rage_obj = stora
+0002d060: 6765 5f6c 6962 2e53 746f 7261 6765 2873  ge_lib.Storage(s
+0002d070: 6f75 7263 653d 7265 7175 6573 742e 7061  ource=request.pa
+0002d080: 7261 6d29 0a20 2020 2020 2020 2079 6965  ram).        yie
+0002d090: 6c64 2073 746f 7261 6765 5f6f 626a 0a20  ld storage_obj. 
+0002d0a0: 2020 2020 2020 2023 2054 6869 7320 646f         # This do
+0002d0b0: 6573 206e 6f74 2072 6571 7569 7265 2061  es not require a
+0002d0c0: 6e79 2064 656c 6574 696f 6e20 6c6f 6769  ny deletion logi
+0002d0d0: 6320 6265 6361 7573 6520 6974 2069 7320  c because it is 
+0002d0e0: 6120 7075 626c 6963 2062 7563 6b65 740a  a public bucket.
+0002d0f0: 2020 2020 2020 2020 2320 616e 6420 7368          # and sh
+0002d100: 6f75 6c64 206e 6f74 2067 6574 2061 6464  ould not get add
+0002d110: 6564 2074 6f20 676c 6f62 616c 5f75 7365  ed to global_use
+0002d120: 725f 7374 6174 652e 0a0a 2020 2020 4070  r_state...    @p
+0002d130: 7974 6573 742e 6d61 726b 2e6e 6f5f 666c  ytest.mark.no_fl
+0002d140: 7569 6473 7461 636b 0a20 2020 2040 7079  uidstack.    @py
+0002d150: 7465 7374 2e6d 6172 6b2e 7061 7261 6d65  test.mark.parame
+0002d160: 7472 697a 6528 2773 746f 7265 5f74 7970  trize('store_typ
+0002d170: 6527 2c20 5b0a 2020 2020 2020 2020 7374  e', [.        st
+0002d180: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
+0002d190: 7970 652e 5333 2c20 7374 6f72 6167 655f  ype.S3, storage_
+0002d1a0: 6c69 622e 5374 6f72 6554 7970 652e 4743  lib.StoreType.GC
+0002d1b0: 532c 0a20 2020 2020 2020 2070 7974 6573  S,.        pytes
+0002d1c0: 742e 7061 7261 6d28 7374 6f72 6167 655f  t.param(storage_
+0002d1d0: 6c69 622e 5374 6f72 6554 7970 652e 4942  lib.StoreType.IB
+0002d1e0: 4d2c 206d 6172 6b73 3d70 7974 6573 742e  M, marks=pytest.
+0002d1f0: 6d61 726b 2e69 626d 292c 0a20 2020 2020  mark.ibm),.     
+0002d200: 2020 2070 7974 6573 742e 7061 7261 6d28     pytest.param(
+0002d210: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
+0002d220: 6554 7970 652e 5232 2c20 6d61 726b 733d  eType.R2, marks=
+0002d230: 7079 7465 7374 2e6d 6172 6b2e 636c 6f75  pytest.mark.clou
+0002d240: 6466 6c61 7265 290a 2020 2020 5d29 0a20  dflare).    ]). 
+0002d250: 2020 2064 6566 2074 6573 745f 6e65 775f     def test_new_
+0002d260: 6275 636b 6574 5f63 7265 6174 696f 6e5f  bucket_creation_
+0002d270: 616e 645f 6465 6c65 7469 6f6e 2873 656c  and_deletion(sel
+0002d280: 662c 2074 6d70 5f6c 6f63 616c 5f73 746f  f, tmp_local_sto
+0002d290: 7261 6765 5f6f 626a 2c0a 2020 2020 2020  rage_obj,.      
+0002d2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d2c0: 2020 2020 2020 2020 7374 6f72 655f 7479          store_ty
+0002d2d0: 7065 293a 0a20 2020 2020 2020 2023 2043  pe):.        # C
+0002d2e0: 7265 6174 6573 2061 206e 6577 2062 7563  reates a new buc
+0002d2f0: 6b65 7420 7769 7468 2061 206c 6f63 616c  ket with a local
+0002d300: 2073 6f75 7263 652c 2075 706c 6f61 6473   source, uploads
+0002d310: 2066 696c 6573 2074 6f20 6974 0a20 2020   files to it.   
+0002d320: 2020 2020 2023 2061 6e64 2064 656c 6574       # and delet
+0002d330: 6573 2069 742e 0a20 2020 2020 2020 2074  es it..        t
+0002d340: 6d70 5f6c 6f63 616c 5f73 746f 7261 6765  mp_local_storage
+0002d350: 5f6f 626a 2e61 6464 5f73 746f 7265 2873  _obj.add_store(s
+0002d360: 746f 7265 5f74 7970 6529 0a0a 2020 2020  tore_type)..    
+0002d370: 2020 2020 2320 5275 6e20 736b 7920 7374      # Run sky st
+0002d380: 6f72 6167 6520 6c73 2074 6f20 6368 6563  orage ls to chec
+0002d390: 6b20 6966 2073 746f 7261 6765 206f 626a  k if storage obj
+0002d3a0: 6563 7420 6578 6973 7473 2069 6e20 7468  ect exists in th
+0002d3b0: 6520 6f75 7470 7574 0a20 2020 2020 2020  e output.       
+0002d3c0: 206f 7574 203d 2073 7562 7072 6f63 6573   out = subproces
+0002d3d0: 732e 6368 6563 6b5f 6f75 7470 7574 285b  s.check_output([
+0002d3e0: 2773 6b79 272c 2027 7374 6f72 6167 6527  'sky', 'storage'
+0002d3f0: 2c20 276c 7327 5d29 0a20 2020 2020 2020  , 'ls']).       
+0002d400: 2061 7373 6572 7420 746d 705f 6c6f 6361   assert tmp_loca
+0002d410: 6c5f 7374 6f72 6167 655f 6f62 6a2e 6e61  l_storage_obj.na
+0002d420: 6d65 2069 6e20 6f75 742e 6465 636f 6465  me in out.decode
+0002d430: 2827 7574 662d 3827 290a 0a20 2020 2020  ('utf-8')..     
+0002d440: 2020 2023 2052 756e 2073 6b79 2073 746f     # Run sky sto
+0002d450: 7261 6765 2064 656c 6574 6520 746f 2064  rage delete to d
+0002d460: 656c 6574 6520 7468 6520 7374 6f72 6167  elete the storag
+0002d470: 6520 6f62 6a65 6374 0a20 2020 2020 2020  e object.       
+0002d480: 2073 7562 7072 6f63 6573 732e 6368 6563   subprocess.chec
+0002d490: 6b5f 6f75 7470 7574 280a 2020 2020 2020  k_output(.      
+0002d4a0: 2020 2020 2020 5b27 736b 7927 2c20 2773        ['sky', 's
+0002d4b0: 746f 7261 6765 272c 2027 6465 6c65 7465  torage', 'delete
+0002d4c0: 272c 2074 6d70 5f6c 6f63 616c 5f73 746f  ', tmp_local_sto
+0002d4d0: 7261 6765 5f6f 626a 2e6e 616d 652c 2027  rage_obj.name, '
+0002d4e0: 2d2d 7965 7327 5d29 0a0a 2020 2020 2020  --yes'])..      
+0002d4f0: 2020 2320 5275 6e20 736b 7920 7374 6f72    # Run sky stor
+0002d500: 6167 6520 6c73 2074 6f20 6368 6563 6b20  age ls to check 
+0002d510: 6966 2073 746f 7261 6765 206f 626a 6563  if storage objec
+0002d520: 7420 6973 2064 656c 6574 6564 0a20 2020  t is deleted.   
+0002d530: 2020 2020 206f 7574 203d 2073 7562 7072       out = subpr
+0002d540: 6f63 6573 732e 6368 6563 6b5f 6f75 7470  ocess.check_outp
+0002d550: 7574 285b 2773 6b79 272c 2027 7374 6f72  ut(['sky', 'stor
+0002d560: 6167 6527 2c20 276c 7327 5d29 0a20 2020  age', 'ls']).   
+0002d570: 2020 2020 2061 7373 6572 7420 746d 705f       assert tmp_
+0002d580: 6c6f 6361 6c5f 7374 6f72 6167 655f 6f62  local_storage_ob
+0002d590: 6a2e 6e61 6d65 206e 6f74 2069 6e20 6f75  j.name not in ou
+0002d5a0: 742e 6465 636f 6465 2827 7574 662d 3827  t.decode('utf-8'
+0002d5b0: 290a 0a20 2020 2040 7079 7465 7374 2e6d  )..    @pytest.m
+0002d5c0: 6172 6b2e 6e6f 5f66 6c75 6964 7374 6163  ark.no_fluidstac
+0002d5d0: 6b0a 2020 2020 4070 7974 6573 742e 6d61  k.    @pytest.ma
+0002d5e0: 726b 2e78 6469 7374 5f67 726f 7570 2827  rk.xdist_group('
+0002d5f0: 6d75 6c74 6970 6c65 5f62 7563 6b65 745f  multiple_bucket_
+0002d600: 6465 6c65 7469 6f6e 2729 0a20 2020 2040  deletion').    @
+0002d610: 7079 7465 7374 2e6d 6172 6b2e 7061 7261  pytest.mark.para
+0002d620: 6d65 7472 697a 6528 2773 746f 7265 5f74  metrize('store_t
+0002d630: 7970 6527 2c20 5b0a 2020 2020 2020 2020  ype', [.        
+0002d640: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
+0002d650: 6554 7970 652e 5333 2c20 7374 6f72 6167  eType.S3, storag
+0002d660: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
+0002d670: 4743 532c 0a20 2020 2020 2020 2070 7974  GCS,.        pyt
+0002d680: 6573 742e 7061 7261 6d28 7374 6f72 6167  est.param(storag
+0002d690: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
+0002d6a0: 5232 2c20 6d61 726b 733d 7079 7465 7374  R2, marks=pytest
+0002d6b0: 2e6d 6172 6b2e 636c 6f75 6466 6c61 7265  .mark.cloudflare
+0002d6c0: 292c 0a20 2020 2020 2020 2070 7974 6573  ),.        pytes
+0002d6d0: 742e 7061 7261 6d28 7374 6f72 6167 655f  t.param(storage_
+0002d6e0: 6c69 622e 5374 6f72 6554 7970 652e 4942  lib.StoreType.IB
+0002d6f0: 4d2c 206d 6172 6b73 3d70 7974 6573 742e  M, marks=pytest.
+0002d700: 6d61 726b 2e69 626d 290a 2020 2020 5d29  mark.ibm).    ])
+0002d710: 0a20 2020 2064 6566 2074 6573 745f 6d75  .    def test_mu
+0002d720: 6c74 6970 6c65 5f62 7563 6b65 7473 5f63  ltiple_buckets_c
+0002d730: 7265 6174 696f 6e5f 616e 645f 6465 6c65  reation_and_dele
+0002d740: 7469 6f6e 280a 2020 2020 2020 2020 2020  tion(.          
+0002d750: 2020 7365 6c66 2c20 746d 705f 6d75 6c74    self, tmp_mult
+0002d760: 6970 6c65 5f73 6372 6174 6368 5f73 746f  iple_scratch_sto
+0002d770: 7261 6765 5f6f 626a 2c20 7374 6f72 655f  rage_obj, store_
+0002d780: 7479 7065 293a 0a20 2020 2020 2020 2023  type):.        #
+0002d790: 2043 7265 6174 6573 206d 756c 7469 706c   Creates multipl
+0002d7a0: 6520 6e65 7720 6275 636b 6574 7328 3520  e new buckets(5 
+0002d7b0: 6275 636b 6574 7329 2077 6974 6820 6120  buckets) with a 
+0002d7c0: 6c6f 6361 6c20 736f 7572 6365 0a20 2020  local source.   
+0002d7d0: 2020 2020 2023 2061 6e64 2064 656c 6574       # and delet
+0002d7e0: 6573 2074 6865 6d2e 0a20 2020 2020 2020  es them..       
+0002d7f0: 2073 746f 7261 6765 5f6f 626a 5f6e 616d   storage_obj_nam
+0002d800: 6520 3d20 5b5d 0a20 2020 2020 2020 2066  e = [].        f
+0002d810: 6f72 2073 746f 7265 5f6f 626a 2069 6e20  or store_obj in 
+0002d820: 746d 705f 6d75 6c74 6970 6c65 5f73 6372  tmp_multiple_scr
+0002d830: 6174 6368 5f73 746f 7261 6765 5f6f 626a  atch_storage_obj
+0002d840: 3a0a 2020 2020 2020 2020 2020 2020 7374  :.            st
+0002d850: 6f72 655f 6f62 6a2e 6164 645f 7374 6f72  ore_obj.add_stor
+0002d860: 6528 7374 6f72 655f 7479 7065 290a 2020  e(store_type).  
+0002d870: 2020 2020 2020 2020 2020 7374 6f72 6167            storag
+0002d880: 655f 6f62 6a5f 6e61 6d65 2e61 7070 656e  e_obj_name.appen
+0002d890: 6428 7374 6f72 655f 6f62 6a2e 6e61 6d65  d(store_obj.name
+0002d8a0: 290a 0a20 2020 2020 2020 2023 2052 756e  )..        # Run
+0002d8b0: 2073 6b79 2073 746f 7261 6765 206c 7320   sky storage ls 
+0002d8c0: 746f 2063 6865 636b 2069 6620 616c 6c20  to check if all 
+0002d8d0: 7374 6f72 6167 6520 6f62 6a65 6374 7320  storage objects 
+0002d8e0: 6578 6973 7473 2069 6e20 7468 650a 2020  exists in the.  
+0002d8f0: 2020 2020 2020 2320 6f75 7470 7574 2066        # output f
+0002d900: 696c 7465 7265 6420 6279 2073 746f 7265  iltered by store
+0002d910: 2074 7970 650a 2020 2020 2020 2020 6f75   type.        ou
+0002d920: 745f 616c 6c20 3d20 7375 6270 726f 6365  t_all = subproce
+0002d930: 7373 2e63 6865 636b 5f6f 7574 7075 7428  ss.check_output(
+0002d940: 5b27 736b 7927 2c20 2773 746f 7261 6765  ['sky', 'storage
+0002d950: 272c 2027 6c73 275d 290a 2020 2020 2020  ', 'ls']).      
+0002d960: 2020 6f75 7420 3d20 5b0a 2020 2020 2020    out = [.      
+0002d970: 2020 2020 2020 6974 656d 2e73 706c 6974        item.split
+0002d980: 2829 5b30 5d0a 2020 2020 2020 2020 2020  ()[0].          
+0002d990: 2020 666f 7220 6974 656d 2069 6e20 6f75    for item in ou
+0002d9a0: 745f 616c 6c2e 6465 636f 6465 2827 7574  t_all.decode('ut
+0002d9b0: 662d 3827 292e 7370 6c69 746c 696e 6573  f-8').splitlines
+0002d9c0: 2829 0a20 2020 2020 2020 2020 2020 2069  ().            i
+0002d9d0: 6620 7374 6f72 655f 7479 7065 2e76 616c  f store_type.val
+0002d9e0: 7565 2069 6e20 6974 656d 0a20 2020 2020  ue in item.     
+0002d9f0: 2020 205d 0a20 2020 2020 2020 2061 7373     ].        ass
+0002da00: 6572 7420 616c 6c28 5b69 7465 6d20 696e  ert all([item in
+0002da10: 206f 7574 2066 6f72 2069 7465 6d20 696e   out for item in
+0002da20: 2073 746f 7261 6765 5f6f 626a 5f6e 616d   storage_obj_nam
+0002da30: 655d 290a 0a20 2020 2020 2020 2023 2052  e])..        # R
+0002da40: 756e 2073 6b79 2073 746f 7261 6765 2064  un sky storage d
+0002da50: 656c 6574 6520 616c 6c20 746f 2064 656c  elete all to del
+0002da60: 6574 6520 616c 6c20 7374 6f72 6167 6520  ete all storage 
+0002da70: 6f62 6a65 6374 730a 2020 2020 2020 2020  objects.        
+0002da80: 6465 6c65 7465 5f63 6d64 203d 205b 2773  delete_cmd = ['s
+0002da90: 6b79 272c 2027 7374 6f72 6167 6527 2c20  ky', 'storage', 
+0002daa0: 2764 656c 6574 6527 2c20 272d 2d79 6573  'delete', '--yes
+0002dab0: 275d 0a20 2020 2020 2020 2064 656c 6574  '].        delet
+0002dac0: 655f 636d 6420 2b3d 2073 746f 7261 6765  e_cmd += storage
+0002dad0: 5f6f 626a 5f6e 616d 650a 2020 2020 2020  _obj_name.      
+0002dae0: 2020 7375 6270 726f 6365 7373 2e63 6865    subprocess.che
+0002daf0: 636b 5f6f 7574 7075 7428 6465 6c65 7465  ck_output(delete
+0002db00: 5f63 6d64 290a 0a20 2020 2020 2020 2023  _cmd)..        #
+0002db10: 2052 756e 2073 6b79 2073 746f 7261 6765   Run sky storage
+0002db20: 206c 7320 746f 2063 6865 636b 2069 6620   ls to check if 
+0002db30: 616c 6c20 7374 6f72 6167 6520 6f62 6a65  all storage obje
+0002db40: 6374 7320 6669 6c74 6572 6564 2062 7920  cts filtered by 
+0002db50: 7374 6f72 650a 2020 2020 2020 2020 2320  store.        # 
+0002db60: 7479 7065 2061 7265 2064 656c 6574 6564  type are deleted
+0002db70: 0a20 2020 2020 2020 206f 7574 5f61 6c6c  .        out_all
+0002db80: 203d 2073 7562 7072 6f63 6573 732e 6368   = subprocess.ch
+0002db90: 6563 6b5f 6f75 7470 7574 285b 2773 6b79  eck_output(['sky
+0002dba0: 272c 2027 7374 6f72 6167 6527 2c20 276c  ', 'storage', 'l
+0002dbb0: 7327 5d29 0a20 2020 2020 2020 206f 7574  s']).        out
+0002dbc0: 203d 205b 0a20 2020 2020 2020 2020 2020   = [.           
+0002dbd0: 2069 7465 6d2e 7370 6c69 7428 295b 305d   item.split()[0]
+0002dbe0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+0002dbf0: 2069 7465 6d20 696e 206f 7574 5f61 6c6c   item in out_all
+0002dc00: 2e64 6563 6f64 6528 2775 7466 2d38 2729  .decode('utf-8')
+0002dc10: 2e73 706c 6974 6c69 6e65 7328 290a 2020  .splitlines().  
+0002dc20: 2020 2020 2020 2020 2020 6966 2073 746f            if sto
+0002dc30: 7265 5f74 7970 652e 7661 6c75 6520 696e  re_type.value in
+0002dc40: 2069 7465 6d0a 2020 2020 2020 2020 5d0a   item.        ].
+0002dc50: 2020 2020 2020 2020 6173 7365 7274 2061          assert a
+0002dc60: 6c6c 285b 6974 656d 206e 6f74 2069 6e20  ll([item not in 
+0002dc70: 6f75 7420 666f 7220 6974 656d 2069 6e20  out for item in 
+0002dc80: 7374 6f72 6167 655f 6f62 6a5f 6e61 6d65  storage_obj_name
+0002dc90: 5d29 0a0a 2020 2020 4070 7974 6573 742e  ])..    @pytest.
+0002dca0: 6d61 726b 2e6e 6f5f 666c 7569 6473 7461  mark.no_fluidsta
+0002dcb0: 636b 0a20 2020 2040 7079 7465 7374 2e6d  ck.    @pytest.m
+0002dcc0: 6172 6b2e 7061 7261 6d65 7472 697a 6528  ark.parametrize(
+0002dcd0: 2773 746f 7265 5f74 7970 6527 2c20 5b0a  'store_type', [.
+0002dce0: 2020 2020 2020 2020 7374 6f72 6167 655f          storage_
+0002dcf0: 6c69 622e 5374 6f72 6554 7970 652e 5333  lib.StoreType.S3
+0002dd00: 2c20 7374 6f72 6167 655f 6c69 622e 5374  , storage_lib.St
+0002dd10: 6f72 6554 7970 652e 4743 532c 0a20 2020  oreType.GCS,.   
+0002dd20: 2020 2020 2070 7974 6573 742e 7061 7261       pytest.para
+0002dd30: 6d28 7374 6f72 6167 655f 6c69 622e 5374  m(storage_lib.St
+0002dd40: 6f72 6554 7970 652e 4942 4d2c 206d 6172  oreType.IBM, mar
+0002dd50: 6b73 3d70 7974 6573 742e 6d61 726b 2e69  ks=pytest.mark.i
+0002dd60: 626d 292c 0a20 2020 2020 2020 2070 7974  bm),.        pyt
+0002dd70: 6573 742e 7061 7261 6d28 7374 6f72 6167  est.param(storag
+0002dd80: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
+0002dd90: 5232 2c20 6d61 726b 733d 7079 7465 7374  R2, marks=pytest
+0002dda0: 2e6d 6172 6b2e 636c 6f75 6466 6c61 7265  .mark.cloudflare
+0002ddb0: 290a 2020 2020 5d29 0a20 2020 2064 6566  ).    ]).    def
+0002ddc0: 2074 6573 745f 7570 6c6f 6164 5f73 6f75   test_upload_sou
+0002ddd0: 7263 655f 7769 7468 5f73 7061 6365 7328  rce_with_spaces(
+0002dde0: 7365 6c66 2c20 7374 6f72 655f 7479 7065  self, store_type
+0002ddf0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002de00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002de10: 2020 2020 2020 2020 2074 6d70 5f6d 756c           tmp_mul
+0002de20: 7469 706c 655f 6375 7374 6f6d 5f73 6f75  tiple_custom_sou
+0002de30: 7263 655f 7374 6f72 6167 655f 6f62 6a29  rce_storage_obj)
+0002de40: 3a0a 2020 2020 2020 2020 2320 4372 6561  :.        # Crea
+0002de50: 7465 7320 7477 6f20 6275 636b 6574 7320  tes two buckets 
+0002de60: 7769 7468 2073 7065 6369 6669 6564 206c  with specified l
+0002de70: 6f63 616c 2073 6f75 7263 6573 0a20 2020  ocal sources.   
+0002de80: 2020 2020 2023 2077 6974 6820 7370 6163       # with spac
+0002de90: 6573 2069 6e20 7468 6520 6e61 6d65 0a20  es in the name. 
+0002dea0: 2020 2020 2020 2073 746f 7261 6765 5f6f         storage_o
+0002deb0: 626a 5f6e 616d 6573 203d 205b 5d0a 2020  bj_names = [].  
+0002dec0: 2020 2020 2020 666f 7220 7374 6f72 6167        for storag
+0002ded0: 655f 6f62 6a20 696e 2074 6d70 5f6d 756c  e_obj in tmp_mul
+0002dee0: 7469 706c 655f 6375 7374 6f6d 5f73 6f75  tiple_custom_sou
+0002def0: 7263 655f 7374 6f72 6167 655f 6f62 6a3a  rce_storage_obj:
+0002df00: 0a20 2020 2020 2020 2020 2020 2073 746f  .            sto
+0002df10: 7261 6765 5f6f 626a 2e61 6464 5f73 746f  rage_obj.add_sto
+0002df20: 7265 2873 746f 7265 5f74 7970 6529 0a20  re(store_type). 
+0002df30: 2020 2020 2020 2020 2020 2073 746f 7261             stora
+0002df40: 6765 5f6f 626a 5f6e 616d 6573 2e61 7070  ge_obj_names.app
+0002df50: 656e 6428 7374 6f72 6167 655f 6f62 6a2e  end(storage_obj.
+0002df60: 6e61 6d65 290a 0a20 2020 2020 2020 2023  name)..        #
+0002df70: 2052 756e 2073 6b79 2073 746f 7261 6765   Run sky storage
+0002df80: 206c 7320 746f 2063 6865 636b 2069 6620   ls to check if 
+0002df90: 616c 6c20 7374 6f72 6167 6520 6f62 6a65  all storage obje
+0002dfa0: 6374 7320 6578 6973 7473 2069 6e20 7468  cts exists in th
+0002dfb0: 650a 2020 2020 2020 2020 2320 6f75 7470  e.        # outp
+0002dfc0: 7574 2066 696c 7465 7265 6420 6279 2073  ut filtered by s
+0002dfd0: 746f 7265 2074 7970 650a 2020 2020 2020  tore type.      
+0002dfe0: 2020 6f75 745f 616c 6c20 3d20 7375 6270    out_all = subp
+0002dff0: 726f 6365 7373 2e63 6865 636b 5f6f 7574  rocess.check_out
+0002e000: 7075 7428 5b27 736b 7927 2c20 2773 746f  put(['sky', 'sto
+0002e010: 7261 6765 272c 2027 6c73 275d 290a 2020  rage', 'ls']).  
+0002e020: 2020 2020 2020 6f75 7420 3d20 5b0a 2020        out = [.  
+0002e030: 2020 2020 2020 2020 2020 6974 656d 2e73            item.s
+0002e040: 706c 6974 2829 5b30 5d0a 2020 2020 2020  plit()[0].      
+0002e050: 2020 2020 2020 666f 7220 6974 656d 2069        for item i
+0002e060: 6e20 6f75 745f 616c 6c2e 6465 636f 6465  n out_all.decode
+0002e070: 2827 7574 662d 3827 292e 7370 6c69 746c  ('utf-8').splitl
+0002e080: 696e 6573 2829 0a20 2020 2020 2020 2020  ines().         
+0002e090: 2020 2069 6620 7374 6f72 655f 7479 7065     if store_type
+0002e0a0: 2e76 616c 7565 2069 6e20 6974 656d 0a20  .value in item. 
+0002e0b0: 2020 2020 2020 205d 0a20 2020 2020 2020         ].       
+0002e0c0: 2061 7373 6572 7420 616c 6c28 5b69 7465   assert all([ite
+0002e0d0: 6d20 696e 206f 7574 2066 6f72 2069 7465  m in out for ite
+0002e0e0: 6d20 696e 2073 746f 7261 6765 5f6f 626a  m in storage_obj
+0002e0f0: 5f6e 616d 6573 5d29 0a0a 2020 2020 4070  _names])..    @p
+0002e100: 7974 6573 742e 6d61 726b 2e6e 6f5f 666c  ytest.mark.no_fl
+0002e110: 7569 6473 7461 636b 0a20 2020 2040 7079  uidstack.    @py
+0002e120: 7465 7374 2e6d 6172 6b2e 7061 7261 6d65  test.mark.parame
+0002e130: 7472 697a 6528 2773 746f 7265 5f74 7970  trize('store_typ
+0002e140: 6527 2c20 5b0a 2020 2020 2020 2020 7374  e', [.        st
+0002e150: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
+0002e160: 7970 652e 5333 2c20 7374 6f72 6167 655f  ype.S3, storage_
+0002e170: 6c69 622e 5374 6f72 6554 7970 652e 4743  lib.StoreType.GC
+0002e180: 532c 0a20 2020 2020 2020 2070 7974 6573  S,.        pytes
+0002e190: 742e 7061 7261 6d28 7374 6f72 6167 655f  t.param(storage_
+0002e1a0: 6c69 622e 5374 6f72 6554 7970 652e 4942  lib.StoreType.IB
+0002e1b0: 4d2c 206d 6172 6b73 3d70 7974 6573 742e  M, marks=pytest.
+0002e1c0: 6d61 726b 2e69 626d 292c 0a20 2020 2020  mark.ibm),.     
+0002e1d0: 2020 2070 7974 6573 742e 7061 7261 6d28     pytest.param(
+0002e1e0: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
+0002e1f0: 6554 7970 652e 5232 2c20 6d61 726b 733d  eType.R2, marks=
+0002e200: 7079 7465 7374 2e6d 6172 6b2e 636c 6f75  pytest.mark.clou
+0002e210: 6466 6c61 7265 290a 2020 2020 5d29 0a20  dflare).    ]). 
+0002e220: 2020 2064 6566 2074 6573 745f 6275 636b     def test_buck
+0002e230: 6574 5f65 7874 6572 6e61 6c5f 6465 6c65  et_external_dele
+0002e240: 7469 6f6e 2873 656c 662c 2074 6d70 5f73  tion(self, tmp_s
+0002e250: 6372 6174 6368 5f73 746f 7261 6765 5f6f  cratch_storage_o
+0002e260: 626a 2c0a 2020 2020 2020 2020 2020 2020  bj,.            
+0002e270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e280: 2020 2020 2020 2020 2020 7374 6f72 655f            store_
+0002e290: 7479 7065 293a 0a20 2020 2020 2020 2023  type):.        #
+0002e2a0: 2043 7265 6174 6573 2061 2062 7563 6b65   Creates a bucke
+0002e2b0: 742c 2064 656c 6574 6573 2069 7420 6578  t, deletes it ex
+0002e2c0: 7465 726e 616c 6c79 2075 7369 6e67 2063  ternally using c
+0002e2d0: 6c6f 7564 2063 6c69 2063 6f6d 6d61 6e64  loud cli command
+0002e2e0: 730a 2020 2020 2020 2020 2320 616e 6420  s.        # and 
+0002e2f0: 7468 656e 2074 7269 6573 2074 6f20 6465  then tries to de
+0002e300: 6c65 7465 2069 7420 7573 696e 6720 736b  lete it using sk
+0002e310: 7920 7374 6f72 6167 6520 6465 6c65 7465  y storage delete
+0002e320: 2e0a 2020 2020 2020 2020 746d 705f 7363  ..        tmp_sc
+0002e330: 7261 7463 685f 7374 6f72 6167 655f 6f62  ratch_storage_ob
+0002e340: 6a2e 6164 645f 7374 6f72 6528 7374 6f72  j.add_store(stor
+0002e350: 655f 7479 7065 290a 0a20 2020 2020 2020  e_type)..       
+0002e360: 2023 2052 756e 2073 6b79 2073 746f 7261   # Run sky stora
+0002e370: 6765 206c 7320 746f 2063 6865 636b 2069  ge ls to check i
+0002e380: 6620 7374 6f72 6167 6520 6f62 6a65 6374  f storage object
+0002e390: 2065 7869 7374 7320 696e 2074 6865 206f   exists in the o
+0002e3a0: 7574 7075 740a 2020 2020 2020 2020 6f75  utput.        ou
+0002e3b0: 7420 3d20 7375 6270 726f 6365 7373 2e63  t = subprocess.c
+0002e3c0: 6865 636b 5f6f 7574 7075 7428 5b27 736b  heck_output(['sk
+0002e3d0: 7927 2c20 2773 746f 7261 6765 272c 2027  y', 'storage', '
+0002e3e0: 6c73 275d 290a 2020 2020 2020 2020 6173  ls']).        as
+0002e3f0: 7365 7274 2074 6d70 5f73 6372 6174 6368  sert tmp_scratch
+0002e400: 5f73 746f 7261 6765 5f6f 626a 2e6e 616d  _storage_obj.nam
+0002e410: 6520 696e 206f 7574 2e64 6563 6f64 6528  e in out.decode(
+0002e420: 2775 7466 2d38 2729 0a0a 2020 2020 2020  'utf-8')..      
+0002e430: 2020 2320 4465 6c65 7465 2062 7563 6b65    # Delete bucke
+0002e440: 7420 6578 7465 726e 616c 6c79 0a20 2020  t externally.   
+0002e450: 2020 2020 2063 6d64 203d 2073 656c 662e       cmd = self.
+0002e460: 636c 695f 6465 6c65 7465 5f63 6d64 2873  cli_delete_cmd(s
+0002e470: 746f 7265 5f74 7970 652c 2074 6d70 5f73  tore_type, tmp_s
+0002e480: 6372 6174 6368 5f73 746f 7261 6765 5f6f  cratch_storage_o
+0002e490: 626a 2e6e 616d 6529 0a20 2020 2020 2020  bj.name).       
+0002e4a0: 2073 7562 7072 6f63 6573 732e 6368 6563   subprocess.chec
+0002e4b0: 6b5f 6f75 7470 7574 2863 6d64 2c20 7368  k_output(cmd, sh
+0002e4c0: 656c 6c3d 5472 7565 290a 0a20 2020 2020  ell=True)..     
+0002e4d0: 2020 2023 2052 756e 2073 6b79 2073 746f     # Run sky sto
+0002e4e0: 7261 6765 2064 656c 6574 6520 746f 2064  rage delete to d
+0002e4f0: 656c 6574 6520 7468 6520 7374 6f72 6167  elete the storag
+0002e500: 6520 6f62 6a65 6374 0a20 2020 2020 2020  e object.       
+0002e510: 206f 7574 203d 2073 7562 7072 6f63 6573   out = subproces
+0002e520: 732e 6368 6563 6b5f 6f75 7470 7574 280a  s.check_output(.
+0002e530: 2020 2020 2020 2020 2020 2020 5b27 736b              ['sk
+0002e540: 7927 2c20 2773 746f 7261 6765 272c 2027  y', 'storage', '
+0002e550: 6465 6c65 7465 272c 2074 6d70 5f73 6372  delete', tmp_scr
+0002e560: 6174 6368 5f73 746f 7261 6765 5f6f 626a  atch_storage_obj
+0002e570: 2e6e 616d 652c 2027 2d2d 7965 7327 5d29  .name, '--yes'])
+0002e580: 0a20 2020 2020 2020 2023 204d 616b 6520  .        # Make 
+0002e590: 7375 7265 2062 7563 6b65 7420 7761 7320  sure bucket was 
+0002e5a0: 6e6f 7420 6372 6561 7465 6420 6475 7269  not created duri
+0002e5b0: 6e67 2064 656c 6574 696f 6e20 2873 6565  ng deletion (see
+0002e5c0: 2069 7373 7565 2023 3133 3232 290a 2020   issue #1322).  
+0002e5d0: 2020 2020 2020 6173 7365 7274 2027 6372        assert 'cr
+0002e5e0: 6561 7465 6427 206e 6f74 2069 6e20 6f75  eated' not in ou
+0002e5f0: 742e 6465 636f 6465 2827 7574 662d 3827  t.decode('utf-8'
+0002e600: 292e 6c6f 7765 7228 290a 0a20 2020 2020  ).lower()..     
+0002e610: 2020 2023 2052 756e 2073 6b79 2073 746f     # Run sky sto
+0002e620: 7261 6765 206c 7320 746f 2063 6865 636b  rage ls to check
+0002e630: 2069 6620 7374 6f72 6167 6520 6f62 6a65   if storage obje
+0002e640: 6374 2069 7320 6465 6c65 7465 640a 2020  ct is deleted.  
+0002e650: 2020 2020 2020 6f75 7420 3d20 7375 6270        out = subp
+0002e660: 726f 6365 7373 2e63 6865 636b 5f6f 7574  rocess.check_out
+0002e670: 7075 7428 5b27 736b 7927 2c20 2773 746f  put(['sky', 'sto
+0002e680: 7261 6765 272c 2027 6c73 275d 290a 2020  rage', 'ls']).  
+0002e690: 2020 2020 2020 6173 7365 7274 2074 6d70        assert tmp
+0002e6a0: 5f73 6372 6174 6368 5f73 746f 7261 6765  _scratch_storage
+0002e6b0: 5f6f 626a 2e6e 616d 6520 6e6f 7420 696e  _obj.name not in
+0002e6c0: 206f 7574 2e64 6563 6f64 6528 2775 7466   out.decode('utf
+0002e6d0: 2d38 2729 0a0a 2020 2020 4070 7974 6573  -8')..    @pytes
+0002e6e0: 742e 6d61 726b 2e6e 6f5f 666c 7569 6473  t.mark.no_fluids
+0002e6f0: 7461 636b 0a20 2020 2040 7079 7465 7374  tack.    @pytest
+0002e700: 2e6d 6172 6b2e 7061 7261 6d65 7472 697a  .mark.parametriz
+0002e710: 6528 2773 746f 7265 5f74 7970 6527 2c20  e('store_type', 
+0002e720: 5b0a 2020 2020 2020 2020 7374 6f72 6167  [.        storag
+0002e730: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
+0002e740: 5333 2c20 7374 6f72 6167 655f 6c69 622e  S3, storage_lib.
+0002e750: 5374 6f72 6554 7970 652e 4743 532c 0a20  StoreType.GCS,. 
+0002e760: 2020 2020 2020 2070 7974 6573 742e 7061         pytest.pa
+0002e770: 7261 6d28 7374 6f72 6167 655f 6c69 622e  ram(storage_lib.
+0002e780: 5374 6f72 6554 7970 652e 4942 4d2c 206d  StoreType.IBM, m
+0002e790: 6172 6b73 3d70 7974 6573 742e 6d61 726b  arks=pytest.mark
+0002e7a0: 2e69 626d 292c 0a20 2020 2020 2020 2070  .ibm),.        p
+0002e7b0: 7974 6573 742e 7061 7261 6d28 7374 6f72  ytest.param(stor
+0002e7c0: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
+0002e7d0: 652e 5232 2c20 6d61 726b 733d 7079 7465  e.R2, marks=pyte
+0002e7e0: 7374 2e6d 6172 6b2e 636c 6f75 6466 6c61  st.mark.cloudfla
+0002e7f0: 7265 290a 2020 2020 5d29 0a20 2020 2064  re).    ]).    d
+0002e800: 6566 2074 6573 745f 6275 636b 6574 5f62  ef test_bucket_b
+0002e810: 756c 6b5f 6465 6c65 7469 6f6e 2873 656c  ulk_deletion(sel
+0002e820: 662c 2073 746f 7265 5f74 7970 652c 2074  f, store_type, t
+0002e830: 6d70 5f62 756c 6b5f 6465 6c5f 7374 6f72  mp_bulk_del_stor
+0002e840: 6167 655f 6f62 6a29 3a0a 2020 2020 2020  age_obj):.      
+0002e850: 2020 2320 4372 6561 7465 7320 6120 7465    # Creates a te
+0002e860: 6d70 2066 6f6c 6465 7220 7769 7468 206f  mp folder with o
+0002e870: 7665 7220 3235 3620 6669 6c65 7320 616e  ver 256 files an
+0002e880: 6420 666f 6c64 6572 732c 2075 706c 6f61  d folders, uploa
+0002e890: 640a 2020 2020 2020 2020 2320 6669 6c65  d.        # file
+0002e8a0: 7320 616e 6420 666f 6c64 6572 7320 746f  s and folders to
+0002e8b0: 2061 206e 6577 2062 7563 6b65 742c 2074   a new bucket, t
+0002e8c0: 6865 6e20 6465 6c65 7465 2062 7563 6b65  hen delete bucke
+0002e8d0: 742e 0a20 2020 2020 2020 2074 6d70 5f62  t..        tmp_b
+0002e8e0: 756c 6b5f 6465 6c5f 7374 6f72 6167 655f  ulk_del_storage_
+0002e8f0: 6f62 6a2e 6164 645f 7374 6f72 6528 7374  obj.add_store(st
+0002e900: 6f72 655f 7479 7065 290a 0a20 2020 2020  ore_type)..     
+0002e910: 2020 2073 7562 7072 6f63 6573 732e 6368     subprocess.ch
+0002e920: 6563 6b5f 6f75 7470 7574 285b 0a20 2020  eck_output([.   
+0002e930: 2020 2020 2020 2020 2027 736b 7927 2c20           'sky', 
+0002e940: 2773 746f 7261 6765 272c 2027 6465 6c65  'storage', 'dele
+0002e950: 7465 272c 2074 6d70 5f62 756c 6b5f 6465  te', tmp_bulk_de
+0002e960: 6c5f 7374 6f72 6167 655f 6f62 6a2e 6e61  l_storage_obj.na
+0002e970: 6d65 2c20 272d 2d79 6573 270a 2020 2020  me, '--yes'.    
+0002e980: 2020 2020 5d29 0a0a 2020 2020 2020 2020      ])..        
+0002e990: 6f75 7470 7574 203d 2073 7562 7072 6f63  output = subproc
+0002e9a0: 6573 732e 6368 6563 6b5f 6f75 7470 7574  ess.check_output
+0002e9b0: 285b 2773 6b79 272c 2027 7374 6f72 6167  (['sky', 'storag
+0002e9c0: 6527 2c20 276c 7327 5d29 0a20 2020 2020  e', 'ls']).     
+0002e9d0: 2020 2061 7373 6572 7420 746d 705f 6275     assert tmp_bu
+0002e9e0: 6c6b 5f64 656c 5f73 746f 7261 6765 5f6f  lk_del_storage_o
+0002e9f0: 626a 2e6e 616d 6520 6e6f 7420 696e 206f  bj.name not in o
+0002ea00: 7574 7075 742e 6465 636f 6465 2827 7574  utput.decode('ut
+0002ea10: 662d 3827 290a 0a20 2020 2040 7079 7465  f-8')..    @pyte
+0002ea20: 7374 2e6d 6172 6b2e 6e6f 5f66 6c75 6964  st.mark.no_fluid
+0002ea30: 7374 6163 6b0a 2020 2020 4070 7974 6573  stack.    @pytes
+0002ea40: 742e 6d61 726b 2e70 6172 616d 6574 7269  t.mark.parametri
+0002ea50: 7a65 280a 2020 2020 2020 2020 2774 6d70  ze(.        'tmp
+0002ea60: 5f70 7562 6c69 635f 7374 6f72 6167 655f  _public_storage_
+0002ea70: 6f62 6a2c 2073 746f 7265 5f74 7970 6527  obj, store_type'
+0002ea80: 2c0a 2020 2020 2020 2020 5b28 2773 333a  ,.        [('s3:
+0002ea90: 2f2f 7463 6761 2d32 2d6f 7065 6e27 2c20  //tcga-2-open', 
+0002eaa0: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
+0002eab0: 6554 7970 652e 5333 292c 0a20 2020 2020  eType.S3),.     
+0002eac0: 2020 2020 2827 7333 3a2f 2f64 6967 6974      ('s3://digit
+0002ead0: 616c 636f 7270 6f72 6127 2c20 7374 6f72  alcorpora', stor
+0002eae0: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
+0002eaf0: 652e 5333 292c 0a20 2020 2020 2020 2020  e.S3),.         
+0002eb00: 2827 6773 3a2f 2f67 6370 2d70 7562 6c69  ('gs://gcp-publi
+0002eb10: 632d 6461 7461 2d73 656e 7469 6e65 6c2d  c-data-sentinel-
+0002eb20: 3227 2c20 7374 6f72 6167 655f 6c69 622e  2', storage_lib.
+0002eb30: 5374 6f72 6554 7970 652e 4743 5329 5d2c  StoreType.GCS)],
+0002eb40: 0a20 2020 2020 2020 2069 6e64 6972 6563  .        indirec
+0002eb50: 743d 5b27 746d 705f 7075 626c 6963 5f73  t=['tmp_public_s
+0002eb60: 746f 7261 6765 5f6f 626a 275d 290a 2020  torage_obj']).  
+0002eb70: 2020 6465 6620 7465 7374 5f70 7562 6c69    def test_publi
+0002eb80: 635f 6275 636b 6574 2873 656c 662c 2074  c_bucket(self, t
+0002eb90: 6d70 5f70 7562 6c69 635f 7374 6f72 6167  mp_public_storag
+0002eba0: 655f 6f62 6a2c 2073 746f 7265 5f74 7970  e_obj, store_typ
+0002ebb0: 6529 3a0a 2020 2020 2020 2020 2320 4372  e):.        # Cr
+0002ebc0: 6561 7465 7320 6120 6e65 7720 6275 636b  eates a new buck
+0002ebd0: 6574 2077 6974 6820 6120 7075 626c 6963  et with a public
+0002ebe0: 2073 6f75 7263 6520 616e 6420 7665 7269   source and veri
+0002ebf0: 6669 6573 2074 6861 7420 6974 2069 7320  fies that it is 
+0002ec00: 6e6f 740a 2020 2020 2020 2020 2320 6164  not.        # ad
+0002ec10: 6465 6420 746f 2067 6c6f 6261 6c5f 7573  ded to global_us
+0002ec20: 6572 5f73 7461 7465 2e0a 2020 2020 2020  er_state..      
+0002ec30: 2020 746d 705f 7075 626c 6963 5f73 746f    tmp_public_sto
+0002ec40: 7261 6765 5f6f 626a 2e61 6464 5f73 746f  rage_obj.add_sto
+0002ec50: 7265 2873 746f 7265 5f74 7970 6529 0a0a  re(store_type)..
+0002ec60: 2020 2020 2020 2020 2320 5275 6e20 736b          # Run sk
+0002ec70: 7920 7374 6f72 6167 6520 6c73 2074 6f20  y storage ls to 
+0002ec80: 6368 6563 6b20 6966 2073 746f 7261 6765  check if storage
+0002ec90: 206f 626a 6563 7420 6578 6973 7473 2069   object exists i
+0002eca0: 6e20 7468 6520 6f75 7470 7574 0a20 2020  n the output.   
+0002ecb0: 2020 2020 206f 7574 203d 2073 7562 7072       out = subpr
+0002ecc0: 6f63 6573 732e 6368 6563 6b5f 6f75 7470  ocess.check_outp
+0002ecd0: 7574 285b 2773 6b79 272c 2027 7374 6f72  ut(['sky', 'stor
+0002ece0: 6167 6527 2c20 276c 7327 5d29 0a20 2020  age', 'ls']).   
+0002ecf0: 2020 2020 2061 7373 6572 7420 746d 705f       assert tmp_
+0002ed00: 7075 626c 6963 5f73 746f 7261 6765 5f6f  public_storage_o
+0002ed10: 626a 2e6e 616d 6520 6e6f 7420 696e 206f  bj.name not in o
+0002ed20: 7574 2e64 6563 6f64 6528 2775 7466 2d38  ut.decode('utf-8
+0002ed30: 2729 0a0a 2020 2020 4070 7974 6573 742e  ')..    @pytest.
+0002ed40: 6d61 726b 2e6e 6f5f 666c 7569 6473 7461  mark.no_fluidsta
+0002ed50: 636b 0a20 2020 2040 7079 7465 7374 2e6d  ck.    @pytest.m
+0002ed60: 6172 6b2e 7061 7261 6d65 7472 697a 6528  ark.parametrize(
+0002ed70: 276e 6f6e 6578 6973 745f 6275 636b 6574  'nonexist_bucket
+0002ed80: 5f75 726c 272c 205b 0a20 2020 2020 2020  _url', [.       
+0002ed90: 2027 7333 3a2f 2f7b 7261 6e64 6f6d 5f6e   's3://{random_n
+0002eda0: 616d 657d 272c 2027 6773 3a2f 2f7b 7261  ame}', 'gs://{ra
+0002edb0: 6e64 6f6d 5f6e 616d 657d 272c 0a20 2020  ndom_name}',.   
+0002edc0: 2020 2020 2070 7974 6573 742e 7061 7261       pytest.para
+0002edd0: 6d28 2763 6f73 3a2f 2f75 732d 6561 7374  m('cos://us-east
+0002ede0: 2f7b 7261 6e64 6f6d 5f6e 616d 657d 272c  /{random_name}',
+0002edf0: 206d 6172 6b73 3d70 7974 6573 742e 6d61   marks=pytest.ma
+0002ee00: 726b 2e69 626d 292c 0a20 2020 2020 2020  rk.ibm),.       
+0002ee10: 2070 7974 6573 742e 7061 7261 6d28 2772   pytest.param('r
+0002ee20: 323a 2f2f 7b72 616e 646f 6d5f 6e61 6d65  2://{random_name
+0002ee30: 7d27 2c20 6d61 726b 733d 7079 7465 7374  }', marks=pytest
+0002ee40: 2e6d 6172 6b2e 636c 6f75 6466 6c61 7265  .mark.cloudflare
+0002ee50: 290a 2020 2020 5d29 0a20 2020 2064 6566  ).    ]).    def
+0002ee60: 2074 6573 745f 6e6f 6e65 7869 7374 656e   test_nonexisten
+0002ee70: 745f 6275 636b 6574 2873 656c 662c 206e  t_bucket(self, n
+0002ee80: 6f6e 6578 6973 745f 6275 636b 6574 5f75  onexist_bucket_u
+0002ee90: 726c 293a 0a20 2020 2020 2020 2023 2041  rl):.        # A
+0002eea0: 7474 656d 7074 7320 746f 2063 7265 6174  ttempts to creat
+0002eeb0: 6520 6665 7463 6820 6120 7374 726f 6167  e fetch a stroag
+0002eec0: 6520 7769 7468 2061 206e 6f6e 2d65 7869  e with a non-exi
+0002eed0: 7374 656e 7420 736f 7572 6365 2e0a 2020  stent source..  
+0002eee0: 2020 2020 2020 2320 4765 6e65 7261 7465        # Generate
+0002eef0: 2061 2072 616e 646f 6d20 6275 636b 6574   a random bucket
+0002ef00: 206e 616d 6520 616e 6420 7665 7269 6679   name and verify
+0002ef10: 2069 7420 646f 6573 6e27 7420 6578 6973   it doesn't exis
+0002ef20: 743a 0a20 2020 2020 2020 2072 6574 7279  t:.        retry
+0002ef30: 5f63 6f75 6e74 203d 2030 0a20 2020 2020  _count = 0.     
+0002ef40: 2020 2077 6869 6c65 2054 7275 653a 0a20     while True:. 
+0002ef50: 2020 2020 2020 2020 2020 206e 6f6e 6578             nonex
+0002ef60: 6973 745f 6275 636b 6574 5f6e 616d 6520  ist_bucket_name 
+0002ef70: 3d20 7374 7228 7575 6964 2e75 7569 6434  = str(uuid.uuid4
+0002ef80: 2829 290a 2020 2020 2020 2020 2020 2020  ()).            
+0002ef90: 6966 206e 6f6e 6578 6973 745f 6275 636b  if nonexist_buck
+0002efa0: 6574 5f75 726c 2e73 7461 7274 7377 6974  et_url.startswit
+0002efb0: 6828 2773 3327 293a 0a20 2020 2020 2020  h('s3'):.       
+0002efc0: 2020 2020 2020 2020 2063 6f6d 6d61 6e64           command
+0002efd0: 203d 2066 2761 7773 2073 3361 7069 2068   = f'aws s3api h
+0002efe0: 6561 642d 6275 636b 6574 202d 2d62 7563  ead-bucket --buc
+0002eff0: 6b65 7420 7b6e 6f6e 6578 6973 745f 6275  ket {nonexist_bu
+0002f000: 636b 6574 5f6e 616d 657d 270a 2020 2020  cket_name}'.    
+0002f010: 2020 2020 2020 2020 2020 2020 6578 7065              expe
+0002f020: 6374 6564 5f6f 7574 7075 7420 3d20 2734  cted_output = '4
+0002f030: 3034 270a 2020 2020 2020 2020 2020 2020  04'.            
+0002f040: 656c 6966 206e 6f6e 6578 6973 745f 6275  elif nonexist_bu
+0002f050: 636b 6574 5f75 726c 2e73 7461 7274 7377  cket_url.startsw
+0002f060: 6974 6828 2767 7327 293a 0a20 2020 2020  ith('gs'):.     
+0002f070: 2020 2020 2020 2020 2020 2063 6f6d 6d61             comma
+0002f080: 6e64 203d 2066 2767 7375 7469 6c20 6c73  nd = f'gsutil ls
+0002f090: 207b 6e6f 6e65 7869 7374 5f62 7563 6b65   {nonexist_bucke
+0002f0a0: 745f 7572 6c2e 666f 726d 6174 2872 616e  t_url.format(ran
+0002f0b0: 646f 6d5f 6e61 6d65 3d6e 6f6e 6578 6973  dom_name=nonexis
+0002f0c0: 745f 6275 636b 6574 5f6e 616d 6529 7d27  t_bucket_name)}'
+0002f0d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002f0e0: 2065 7870 6563 7465 645f 6f75 7470 7574   expected_output
+0002f0f0: 203d 2027 4275 636b 6574 4e6f 7446 6f75   = 'BucketNotFou
+0002f100: 6e64 4578 6365 7074 696f 6e27 0a20 2020  ndException'.   
+0002f110: 2020 2020 2020 2020 2065 6c69 6620 6e6f           elif no
+0002f120: 6e65 7869 7374 5f62 7563 6b65 745f 7572  nexist_bucket_ur
+0002f130: 6c2e 7374 6172 7473 7769 7468 2827 7232  l.startswith('r2
+0002f140: 2729 3a0a 2020 2020 2020 2020 2020 2020  '):.            
+0002f150: 2020 2020 656e 6470 6f69 6e74 5f75 726c      endpoint_url
+0002f160: 203d 2063 6c6f 7564 666c 6172 652e 6372   = cloudflare.cr
+0002f170: 6561 7465 5f65 6e64 706f 696e 7428 290a  eate_endpoint().
+0002f180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f190: 636f 6d6d 616e 6420 3d20 6627 4157 535f  command = f'AWS_
+0002f1a0: 5348 4152 4544 5f43 5245 4445 4e54 4941  SHARED_CREDENTIA
+0002f1b0: 4c53 5f46 494c 453d 7b63 6c6f 7564 666c  LS_FILE={cloudfl
+0002f1c0: 6172 652e 5232 5f43 5245 4445 4e54 4941  are.R2_CREDENTIA
+0002f1d0: 4c53 5f50 4154 487d 2061 7773 2073 3361  LS_PATH} aws s3a
+0002f1e0: 7069 2068 6561 642d 6275 636b 6574 202d  pi head-bucket -
+0002f1f0: 2d62 7563 6b65 7420 7b6e 6f6e 6578 6973  -bucket {nonexis
+0002f200: 745f 6275 636b 6574 5f6e 616d 657d 202d  t_bucket_name} -
+0002f210: 2d65 6e64 706f 696e 7420 7b65 6e64 706f  -endpoint {endpo
+0002f220: 696e 745f 7572 6c7d 202d 2d70 726f 6669  int_url} --profi
+0002f230: 6c65 3d72 3227 0a20 2020 2020 2020 2020  le=r2'.         
+0002f240: 2020 2020 2020 2065 7870 6563 7465 645f         expected_
+0002f250: 6f75 7470 7574 203d 2027 3430 3427 0a20  output = '404'. 
+0002f260: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
+0002f270: 6e6f 6e65 7869 7374 5f62 7563 6b65 745f  nonexist_bucket_
+0002f280: 7572 6c2e 7374 6172 7473 7769 7468 2827  url.startswith('
+0002f290: 636f 7327 293a 0a20 2020 2020 2020 2020  cos'):.         
+0002f2a0: 2020 2020 2020 2023 2055 7369 6e67 2041         # Using A
+0002f2b0: 5049 2063 616c 6c73 2c20 7369 6e63 6520  PI calls, since 
+0002f2c0: 7573 696e 6720 7263 6c6f 6e65 2072 6571  using rclone req
+0002f2d0: 7569 7265 7320 6120 7072 6f66 696c 6527  uires a profile'
+0002f2e0: 7320 6e61 6d65 0a20 2020 2020 2020 2020  s name.         
+0002f2f0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+0002f300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f310: 6578 7065 6374 6564 5f6f 7574 7075 7420  expected_output 
+0002f320: 3d20 636f 6d6d 616e 6420 3d20 2265 6368  = command = "ech
+0002f330: 6f22 2020 2320 6176 6f69 6420 756e 7265  o"  # avoid unre
+0002f340: 6c61 7465 6420 6578 6365 7074 696f 6e20  lated exception 
+0002f350: 696e 2063 6173 6520 6f66 2066 6169 6c75  in case of failu
+0002f360: 7265 2e0a 2020 2020 2020 2020 2020 2020  re..            
+0002f370: 2020 2020 2020 2020 6275 636b 6574 5f6e          bucket_n
+0002f380: 616d 6520 3d20 7572 6c6c 6962 2e70 6172  ame = urllib.par
+0002f390: 7365 2e75 726c 7370 6c69 7428 0a20 2020  se.urlsplit(.   
+0002f3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f3b0: 2020 2020 206e 6f6e 6578 6973 745f 6275       nonexist_bu
+0002f3c0: 636b 6574 5f75 726c 2e66 6f72 6d61 7428  cket_url.format(
+0002f3d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002f3e0: 2020 2020 2020 2020 2020 2020 2072 616e               ran
+0002f3f0: 646f 6d5f 6e61 6d65 3d6e 6f6e 6578 6973  dom_name=nonexis
+0002f400: 745f 6275 636b 6574 5f6e 616d 6529 292e  t_bucket_name)).
+0002f410: 7061 7468 2e73 7472 6970 2827 2f27 290a  path.strip('/').
+0002f420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f430: 2020 2020 636c 6965 6e74 203d 2069 626d      client = ibm
+0002f440: 2e67 6574 5f63 6f73 5f63 6c69 656e 7428  .get_cos_client(
+0002f450: 2775 732d 6561 7374 2729 0a20 2020 2020  'us-east').     
+0002f460: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0002f470: 6c69 656e 742e 6865 6164 5f62 7563 6b65  lient.head_bucke
+0002f480: 7428 4275 636b 6574 3d62 7563 6b65 745f  t(Bucket=bucket_
+0002f490: 6e61 6d65 290a 2020 2020 2020 2020 2020  name).          
+0002f4a0: 2020 2020 2020 6578 6365 7074 2069 626d        except ibm
+0002f4b0: 2e69 626d 5f62 6f74 6f63 6f72 652e 6578  .ibm_botocore.ex
+0002f4c0: 6365 7074 696f 6e73 2e43 6c69 656e 7445  ceptions.ClientE
+0002f4d0: 7272 6f72 2061 7320 653a 0a20 2020 2020  rror as e:.     
+0002f4e0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0002f4f0: 6620 652e 7265 7370 6f6e 7365 5b27 4572  f e.response['Er
+0002f500: 726f 7227 5d5b 2743 6f64 6527 5d20 3d3d  ror']['Code'] ==
+0002f510: 2027 3430 3427 3a0a 2020 2020 2020 2020   '404':.        
+0002f520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f530: 2320 7375 6363 6573 730a 2020 2020 2020  # success.      
+0002f540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f550: 2020 7265 7475 726e 0a20 2020 2020 2020    return.       
+0002f560: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0002f570: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+0002f580: 2056 616c 7565 4572 726f 7228 2755 6e73   ValueError('Uns
+0002f590: 7570 706f 7274 6564 2062 7563 6b65 7420  upported bucket 
+0002f5a0: 7479 7065 2027 0a20 2020 2020 2020 2020  type '.         
+0002f5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f5c0: 2020 2020 2020 2020 6627 7b6e 6f6e 6578          f'{nonex
+0002f5d0: 6973 745f 6275 636b 6574 5f75 726c 7d27  ist_bucket_url}'
+0002f5e0: 290a 0a20 2020 2020 2020 2020 2020 2023  )..            #
+0002f5f0: 2043 6865 636b 2069 6620 6275 636b 6574   Check if bucket
+0002f600: 2065 7869 7374 7320 7573 696e 6720 7468   exists using th
+0002f610: 6520 636c 693a 0a20 2020 2020 2020 2020  e cli:.         
+0002f620: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+0002f630: 2020 2020 2020 2020 6f75 7420 3d20 7375          out = su
+0002f640: 6270 726f 6365 7373 2e63 6865 636b 5f6f  bprocess.check_o
+0002f650: 7574 7075 7428 636f 6d6d 616e 642c 0a20  utput(command,. 
+0002f660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f680: 2020 2020 2020 2020 2020 2020 2073 7464               std
+0002f690: 6572 723d 7375 6270 726f 6365 7373 2e53  err=subprocess.S
+0002f6a0: 5444 4f55 542c 0a20 2020 2020 2020 2020  TDOUT,.         
+0002f6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f6c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f6d0: 2020 2020 2073 6865 6c6c 3d54 7275 6529       shell=True)
+0002f6e0: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
+0002f6f0: 6570 7420 7375 6270 726f 6365 7373 2e43  ept subprocess.C
+0002f700: 616c 6c65 6450 726f 6365 7373 4572 726f  alledProcessErro
+0002f710: 7220 6173 2065 3a0a 2020 2020 2020 2020  r as e:.        
+0002f720: 2020 2020 2020 2020 6f75 7420 3d20 652e          out = e.
+0002f730: 6f75 7470 7574 0a20 2020 2020 2020 2020  output.         
+0002f740: 2020 206f 7574 203d 206f 7574 2e64 6563     out = out.dec
+0002f750: 6f64 6528 2775 7466 2d38 2729 0a20 2020  ode('utf-8').   
+0002f760: 2020 2020 2020 2020 2069 6620 6578 7065           if expe
+0002f770: 6374 6564 5f6f 7574 7075 7420 696e 206f  cted_output in o
+0002f780: 7574 3a0a 2020 2020 2020 2020 2020 2020  ut:.            
+0002f790: 2020 2020 6272 6561 6b0a 2020 2020 2020      break.      
+0002f7a0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0002f7b0: 2020 2020 2020 2020 2020 2020 7265 7472              retr
+0002f7c0: 795f 636f 756e 7420 2b3d 2031 0a20 2020  y_count += 1.   
+0002f7d0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0002f7e0: 7265 7472 795f 636f 756e 7420 3e20 333a  retry_count > 3:
+0002f7f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002f800: 2020 2020 2072 6169 7365 2052 756e 7469       raise Runti
+0002f810: 6d65 4572 726f 7228 2755 6e61 626c 6520  meError('Unable 
+0002f820: 746f 2066 696e 6420 6120 6e6f 6e65 7869  to find a nonexi
+0002f830: 7374 656e 7420 6275 636b 6574 2027 0a20  stent bucket '. 
+0002f840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f860: 2020 2020 2020 2774 6f20 7573 652e 2054        'to use. T
+0002f870: 6869 7320 6973 2068 6967 6c79 2075 6e6c  his is higly unl
+0002f880: 696b 656c 7920 2d20 270a 2020 2020 2020  ikely - '.      
+0002f890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f8b0: 2027 6368 6563 6b20 6966 2074 6865 2074   'check if the t
+0002f8c0: 6573 7473 2061 7265 2063 6f72 7265 6374  ests are correct
+0002f8d0: 2e27 290a 0a20 2020 2020 2020 2077 6974  .')..        wit
+0002f8e0: 6820 7079 7465 7374 2e72 6169 7365 7328  h pytest.raises(
+0002f8f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002f900: 2073 6b79 2e65 7863 6570 7469 6f6e 732e   sky.exceptions.
+0002f910: 5374 6f72 6167 6542 7563 6b65 7447 6574  StorageBucketGet
+0002f920: 4572 726f 722c 0a20 2020 2020 2020 2020  Error,.         
+0002f930: 2020 2020 2020 206d 6174 6368 3d27 4174         match='At
+0002f940: 7465 6d70 7465 6420 746f 2075 7365 2061  tempted to use a
+0002f950: 206e 6f6e 2d65 7869 7374 656e 7420 6275   non-existent bu
+0002f960: 636b 6574 2061 7320 6120 736f 7572 6365  cket as a source
+0002f970: 2729 3a0a 2020 2020 2020 2020 2020 2020  '):.            
+0002f980: 7374 6f72 6167 655f 6f62 6a20 3d20 7374  storage_obj = st
+0002f990: 6f72 6167 655f 6c69 622e 5374 6f72 6167  orage_lib.Storag
+0002f9a0: 6528 736f 7572 6365 3d6e 6f6e 6578 6973  e(source=nonexis
+0002f9b0: 745f 6275 636b 6574 5f75 726c 2e66 6f72  t_bucket_url.for
+0002f9c0: 6d61 7428 0a20 2020 2020 2020 2020 2020  mat(.           
+0002f9d0: 2020 2020 2072 616e 646f 6d5f 6e61 6d65       random_name
+0002f9e0: 3d6e 6f6e 6578 6973 745f 6275 636b 6574  =nonexist_bucket
+0002f9f0: 5f6e 616d 6529 290a 0a20 2020 2040 7079  _name))..    @py
+0002fa00: 7465 7374 2e6d 6172 6b2e 6e6f 5f66 6c75  test.mark.no_flu
+0002fa10: 6964 7374 6163 6b0a 2020 2020 4070 7974  idstack.    @pyt
+0002fa20: 6573 742e 6d61 726b 2e70 6172 616d 6574  est.mark.paramet
+0002fa30: 7269 7a65 2827 7072 6976 6174 655f 6275  rize('private_bu
+0002fa40: 636b 6574 272c 205b 0a20 2020 2020 2020  cket', [.       
+0002fa50: 2066 2773 333a 2f2f 696d 6167 656e 6574   f's3://imagenet
+0002fa60: 272c 2066 2767 733a 2f2f 696d 6167 656e  ', f'gs://imagen
+0002fa70: 6574 272c 0a20 2020 2020 2020 2070 7974  et',.        pyt
+0002fa80: 6573 742e 7061 7261 6d28 2763 6f73 3a2f  est.param('cos:/
+0002fa90: 2f75 732d 6561 7374 2f62 7563 6b65 7431  /us-east/bucket1
+0002faa0: 272c 206d 6172 6b73 3d70 7974 6573 742e  ', marks=pytest.
+0002fab0: 6d61 726b 2e69 626d 290a 2020 2020 5d29  mark.ibm).    ])
+0002fac0: 0a20 2020 2064 6566 2074 6573 745f 7072  .    def test_pr
+0002fad0: 6976 6174 655f 6275 636b 6574 2873 656c  ivate_bucket(sel
+0002fae0: 662c 2070 7269 7661 7465 5f62 7563 6b65  f, private_bucke
+0002faf0: 7429 3a0a 2020 2020 2020 2020 2320 4174  t):.        # At
+0002fb00: 7465 6d70 7473 2074 6f20 6163 6365 7373  tempts to access
+0002fb10: 2070 7269 7661 7465 2062 7563 6b65 7473   private buckets
+0002fb20: 206e 6f74 2062 656c 6f6e 6769 6e67 2074   not belonging t
+0002fb30: 6f20 7468 6520 7573 6572 2e0a 2020 2020  o the user..    
+0002fb40: 2020 2020 2320 5468 6573 6520 6275 636b      # These buck
+0002fb50: 6574 7320 6172 6520 6b6e 6f77 6e20 746f  ets are known to
+0002fb60: 2062 6520 7072 6976 6174 652c 2062 7574   be private, but
+0002fb70: 206d 6179 206e 6565 6420 746f 2062 6520   may need to be 
+0002fb80: 7570 6461 7465 6420 6966 0a20 2020 2020  updated if.     
+0002fb90: 2020 2023 2074 6865 7920 6172 6520 7265     # they are re
+0002fba0: 6d6f 7665 6420 6279 2074 6865 6972 206f  moved by their o
+0002fbb0: 776e 6572 732e 0a20 2020 2020 2020 2070  wners..        p
+0002fbc0: 7269 7661 7465 5f62 7563 6b65 745f 6e61  rivate_bucket_na
+0002fbd0: 6d65 203d 2075 726c 6c69 622e 7061 7273  me = urllib.pars
+0002fbe0: 652e 7572 6c73 706c 6974 2870 7269 7661  e.urlsplit(priva
+0002fbf0: 7465 5f62 7563 6b65 7429 2e6e 6574 6c6f  te_bucket).netlo
+0002fc00: 6320 6966 205c 0a20 2020 2020 2020 2020  c if \.         
+0002fc10: 2020 2020 2075 726c 6c69 622e 7061 7273       urllib.pars
+0002fc20: 652e 7572 6c73 706c 6974 2870 7269 7661  e.urlsplit(priva
+0002fc30: 7465 5f62 7563 6b65 7429 2e73 6368 656d  te_bucket).schem
+0002fc40: 6520 213d 2027 636f 7327 2065 6c73 6520  e != 'cos' else 
+0002fc50: 5c0a 2020 2020 2020 2020 2020 2020 2020  \.              
+0002fc60: 2020 2020 7572 6c6c 6962 2e70 6172 7365      urllib.parse
+0002fc70: 2e75 726c 7370 6c69 7428 7072 6976 6174  .urlsplit(privat
+0002fc80: 655f 6275 636b 6574 292e 7061 7468 2e73  e_bucket).path.s
+0002fc90: 7472 6970 2827 2f27 290a 2020 2020 2020  trip('/').      
+0002fca0: 2020 7769 7468 2070 7974 6573 742e 7261    with pytest.ra
+0002fcb0: 6973 6573 280a 2020 2020 2020 2020 2020  ises(.          
+0002fcc0: 2020 2020 2020 736b 792e 6578 6365 7074        sky.except
+0002fcd0: 696f 6e73 2e53 746f 7261 6765 4275 636b  ions.StorageBuck
+0002fce0: 6574 4765 7445 7272 6f72 2c0a 2020 2020  etGetError,.    
+0002fcf0: 2020 2020 2020 2020 2020 2020 6d61 7463              matc
+0002fd00: 683d 7374 6f72 6167 655f 6c69 622e 5f42  h=storage_lib._B
+0002fd10: 5543 4b45 545f 4641 494c 5f54 4f5f 434f  UCKET_FAIL_TO_CO
+0002fd20: 4e4e 4543 545f 4d45 5353 4147 452e 666f  NNECT_MESSAGE.fo
+0002fd30: 726d 6174 280a 2020 2020 2020 2020 2020  rmat(.          
+0002fd40: 2020 2020 2020 2020 2020 6e61 6d65 3d70            name=p
+0002fd50: 7269 7661 7465 5f62 7563 6b65 745f 6e61  rivate_bucket_na
+0002fd60: 6d65 2929 3a0a 2020 2020 2020 2020 2020  me)):.          
+0002fd70: 2020 7374 6f72 6167 655f 6f62 6a20 3d20    storage_obj = 
+0002fd80: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
+0002fd90: 6167 6528 736f 7572 6365 3d70 7269 7661  age(source=priva
+0002fda0: 7465 5f62 7563 6b65 7429 0a0a 2020 2020  te_bucket)..    
+0002fdb0: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+0002fdc0: 666c 7569 6473 7461 636b 0a20 2020 2040  fluidstack.    @
+0002fdd0: 7079 7465 7374 2e6d 6172 6b2e 7061 7261  pytest.mark.para
+0002fde0: 6d65 7472 697a 6528 2765 7874 5f62 7563  metrize('ext_buc
+0002fdf0: 6b65 745f 6669 7874 7572 652c 2073 746f  ket_fixture, sto
+0002fe00: 7265 5f74 7970 6527 2c0a 2020 2020 2020  re_type',.      
+0002fe10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fe20: 2020 2020 2020 205b 2827 746d 705f 6177         [('tmp_aw
+0002fe30: 7363 6c69 5f62 7563 6b65 7427 2c20 7374  scli_bucket', st
+0002fe40: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
+0002fe50: 7970 652e 5333 292c 0a20 2020 2020 2020  ype.S3),.       
+0002fe60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fe70: 2020 2020 2020 2028 2774 6d70 5f67 7375         ('tmp_gsu
+0002fe80: 7469 6c5f 6275 636b 6574 272c 2073 746f  til_bucket', sto
+0002fe90: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
+0002fea0: 7065 2e47 4353 292c 0a20 2020 2020 2020  pe.GCS),.       
+0002feb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fec0: 2020 2020 2020 2070 7974 6573 742e 7061         pytest.pa
+0002fed0: 7261 6d28 2774 6d70 5f69 626d 5f63 6f73  ram('tmp_ibm_cos
+0002fee0: 5f62 7563 6b65 7427 2c0a 2020 2020 2020  _bucket',.      
+0002fef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ff00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ff10: 2020 2020 2073 746f 7261 6765 5f6c 6962       storage_lib
+0002ff20: 2e53 746f 7265 5479 7065 2e49 424d 2c0a  .StoreType.IBM,.
+0002ff30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ff40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ff50: 2020 2020 2020 2020 2020 206d 6172 6b73             marks
+0002ff60: 3d70 7974 6573 742e 6d61 726b 2e69 626d  =pytest.mark.ibm
+0002ff70: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+0002ff80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ff90: 2070 7974 6573 742e 7061 7261 6d28 2774   pytest.param('t
+0002ffa0: 6d70 5f61 7773 636c 695f 6275 636b 6574  mp_awscli_bucket
+0002ffb0: 5f72 3227 2c0a 2020 2020 2020 2020 2020  _r2',.          
+0002ffc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ffd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ffe0: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
+0002fff0: 7265 5479 7065 2e52 322c 0a20 2020 2020  reType.R2,.     
+00030000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030020: 2020 2020 2020 6d61 726b 733d 7079 7465        marks=pyte
+00030030: 7374 2e6d 6172 6b2e 636c 6f75 6466 6c61  st.mark.cloudfla
+00030040: 7265 295d 290a 2020 2020 6465 6620 7465  re)]).    def te
+00030050: 7374 5f75 706c 6f61 645f 746f 5f65 7869  st_upload_to_exi
+00030060: 7374 696e 675f 6275 636b 6574 2873 656c  sting_bucket(sel
+00030070: 662c 2065 7874 5f62 7563 6b65 745f 6669  f, ext_bucket_fi
+00030080: 7874 7572 652c 2072 6571 7565 7374 2c0a  xture, request,.
+00030090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000300a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000300b0: 2020 2020 2020 2074 6d70 5f73 6f75 7263         tmp_sourc
+000300c0: 652c 2073 746f 7265 5f74 7970 6529 3a0a  e, store_type):.
+000300d0: 2020 2020 2020 2020 2320 5472 6965 7320          # Tries 
+000300e0: 7570 6c6f 6164 696e 6720 6578 6973 7469  uploading existi
+000300f0: 6e67 2066 696c 6573 2074 6f20 6e65 776c  ng files to newl
+00030100: 7920 6372 6561 7465 6420 6275 636b 6574  y created bucket
+00030110: 2028 6f75 7473 6964 6520 6f66 0a20 2020   (outside of.   
+00030120: 2020 2020 2023 2073 6b79 2920 616e 6420       # sky) and 
+00030130: 7665 7269 6669 6573 2074 6861 7420 6669  verifies that fi
+00030140: 6c65 7320 6172 6520 7772 6974 7465 6e2e  les are written.
+00030150: 0a20 2020 2020 2020 2062 7563 6b65 745f  .        bucket_
+00030160: 6e61 6d65 2c20 5f20 3d20 7265 7175 6573  name, _ = reques
+00030170: 742e 6765 7466 6978 7475 7265 7661 6c75  t.getfixturevalu
+00030180: 6528 6578 745f 6275 636b 6574 5f66 6978  e(ext_bucket_fix
+00030190: 7475 7265 290a 2020 2020 2020 2020 7374  ture).        st
+000301a0: 6f72 6167 655f 6f62 6a20 3d20 7374 6f72  orage_obj = stor
+000301b0: 6167 655f 6c69 622e 5374 6f72 6167 6528  age_lib.Storage(
+000301c0: 6e61 6d65 3d62 7563 6b65 745f 6e61 6d65  name=bucket_name
+000301d0: 2c20 736f 7572 6365 3d74 6d70 5f73 6f75  , source=tmp_sou
+000301e0: 7263 6529 0a20 2020 2020 2020 2073 746f  rce).        sto
+000301f0: 7261 6765 5f6f 626a 2e61 6464 5f73 746f  rage_obj.add_sto
+00030200: 7265 2873 746f 7265 5f74 7970 6529 0a0a  re(store_type)..
+00030210: 2020 2020 2020 2020 2320 4368 6563 6b20          # Check 
+00030220: 6966 2074 6d70 5f73 6f75 7263 652f 746d  if tmp_source/tm
+00030230: 702d 6669 6c65 2065 7869 7374 7320 696e  p-file exists in
+00030240: 2074 6865 2062 7563 6b65 7420 7573 696e   the bucket usin
+00030250: 6720 6177 7320 636c 690a 2020 2020 2020  g aws cli.      
+00030260: 2020 6f75 7420 3d20 7375 6270 726f 6365    out = subproce
+00030270: 7373 2e63 6865 636b 5f6f 7574 7075 7428  ss.check_output(
+00030280: 7365 6c66 2e63 6c69 5f6c 735f 636d 6428  self.cli_ls_cmd(
+00030290: 7374 6f72 655f 7479 7065 2c20 6275 636b  store_type, buck
+000302a0: 6574 5f6e 616d 6529 2c0a 2020 2020 2020  et_name),.      
+000302b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000302c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000302d0: 7368 656c 6c3d 5472 7565 290a 2020 2020  shell=True).    
+000302e0: 2020 2020 6173 7365 7274 2027 746d 702d      assert 'tmp-
+000302f0: 6669 6c65 2720 696e 206f 7574 2e64 6563  file' in out.dec
+00030300: 6f64 6528 2775 7466 2d38 2729 2c20 5c0a  ode('utf-8'), \.
+00030310: 2020 2020 2020 2020 2020 2020 2746 696c              'Fil
+00030320: 6520 6e6f 7420 666f 756e 6420 696e 2062  e not found in b
+00030330: 7563 6b65 7420 2d20 6f75 7470 7574 2077  ucket - output w
+00030340: 6173 203a 207b 7d27 2e66 6f72 6d61 7428  as : {}'.format(
+00030350: 6f75 742e 6465 636f 6465 0a20 2020 2020  out.decode.     
+00030360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030390: 2020 2020 2020 2020 2020 2028 2775 7466             ('utf
+000303a0: 2d38 2729 290a 0a20 2020 2020 2020 2023  -8'))..        #
+000303b0: 2043 6865 636b 2073 796d 6c69 6e6b 7320   Check symlinks 
+000303c0: 2d20 7379 6d6c 696e 6b73 2064 6f6e 2774  - symlinks don't
+000303d0: 2067 6574 2063 6f70 6965 6420 6279 2073   get copied by s
+000303e0: 6b79 2073 746f 7261 6765 0a20 2020 2020  ky storage.     
+000303f0: 2020 2061 7373 6572 7420 2870 6174 686c     assert (pathl
+00030400: 6962 2e50 6174 6828 746d 705f 736f 7572  ib.Path(tmp_sour
+00030410: 6365 2920 2f20 2763 6972 636c 652d 6c69  ce) / 'circle-li
+00030420: 6e6b 2729 2e69 735f 7379 6d6c 696e 6b28  nk').is_symlink(
+00030430: 292c 2028 0a20 2020 2020 2020 2020 2020  ), (.           
+00030440: 2027 6369 7263 6c65 2d6c 696e 6b20 7761   'circle-link wa
+00030450: 7320 6e6f 7420 666f 756e 6420 696e 2074  s not found in t
+00030460: 6865 2075 706c 6f61 6420 736f 7572 6365  he upload source
+00030470: 202d 2027 0a20 2020 2020 2020 2020 2020   - '.           
+00030480: 2027 6172 6520 7468 6520 7465 7374 2066   'are the test f
+00030490: 6978 7475 7265 7320 636f 7272 6563 743f  ixtures correct?
+000304a0: 2729 0a20 2020 2020 2020 2061 7373 6572  ').        asser
+000304b0: 7420 2763 6972 636c 652d 6c69 6e6b 2720  t 'circle-link' 
+000304c0: 6e6f 7420 696e 206f 7574 2e64 6563 6f64  not in out.decod
+000304d0: 6528 2775 7466 2d38 2729 2c20 280a 2020  e('utf-8'), (.  
+000304e0: 2020 2020 2020 2020 2020 2753 796d 6c69            'Symli
+000304f0: 6e6b 2066 6f75 6e64 2069 6e20 6275 636b  nk found in buck
+00030500: 6574 202d 206c 7320 6f75 7470 7574 2077  et - ls output w
+00030510: 6173 203a 207b 7d27 2e66 6f72 6d61 7428  as : {}'.format(
+00030520: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00030530: 206f 7574 2e64 6563 6f64 6528 2775 7466   out.decode('utf
+00030540: 2d38 2729 2929 0a0a 2020 2020 2020 2020  -8')))..        
+00030550: 2320 5275 6e20 736b 7920 7374 6f72 6167  # Run sky storag
+00030560: 6520 6c73 2074 6f20 6368 6563 6b20 6966  e ls to check if
+00030570: 2073 746f 7261 6765 206f 626a 6563 7420   storage object 
+00030580: 6578 6973 7473 2069 6e20 7468 6520 6f75  exists in the ou
+00030590: 7470 7574 2e0a 2020 2020 2020 2020 2320  tput..        # 
+000305a0: 4974 2073 686f 756c 6420 6e6f 7420 6578  It should not ex
+000305b0: 6973 7420 6265 6361 7573 6520 7468 6520  ist because the 
+000305c0: 6275 636b 6574 2077 6173 2063 7265 6174  bucket was creat
+000305d0: 6564 2065 7874 6572 6e61 6c6c 792e 0a20  ed externally.. 
+000305e0: 2020 2020 2020 206f 7574 203d 2073 7562         out = sub
+000305f0: 7072 6f63 6573 732e 6368 6563 6b5f 6f75  process.check_ou
+00030600: 7470 7574 285b 2773 6b79 272c 2027 7374  tput(['sky', 'st
+00030610: 6f72 6167 6527 2c20 276c 7327 5d29 0a20  orage', 'ls']). 
+00030620: 2020 2020 2020 2061 7373 6572 7420 7374         assert st
+00030630: 6f72 6167 655f 6f62 6a2e 6e61 6d65 206e  orage_obj.name n
+00030640: 6f74 2069 6e20 6f75 742e 6465 636f 6465  ot in out.decode
+00030650: 2827 7574 662d 3827 290a 0a20 2020 2040  ('utf-8')..    @
+00030660: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f66  pytest.mark.no_f
+00030670: 6c75 6964 7374 6163 6b0a 2020 2020 6465  luidstack.    de
+00030680: 6620 7465 7374 5f63 6f70 795f 6d6f 756e  f test_copy_moun
+00030690: 745f 6578 6973 7469 6e67 5f73 746f 7261  t_existing_stora
+000306a0: 6765 2873 656c 662c 0a20 2020 2020 2020  ge(self,.       
+000306b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000306c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000306d0: 2020 746d 705f 636f 7079 5f6d 6e74 5f65    tmp_copy_mnt_e
+000306e0: 7869 7374 696e 675f 7374 6f72 6167 655f  xisting_storage_
+000306f0: 6f62 6a29 3a0a 2020 2020 2020 2020 2320  obj):.        # 
+00030700: 4372 6561 7465 7320 6120 6275 636b 6574  Creates a bucket
+00030710: 2077 6974 6820 6e6f 2073 6f75 7263 6520   with no source 
+00030720: 696e 204d 4f55 4e54 206d 6f64 6520 2865  in MOUNT mode (e
+00030730: 6d70 7479 2062 7563 6b65 7429 2c20 616e  mpty bucket), an
+00030740: 640a 2020 2020 2020 2020 2320 7468 656e  d.        # then
+00030750: 2074 7269 6573 2074 6f20 6c6f 6164 2074   tries to load t
+00030760: 6865 2073 616d 6520 7374 6f72 6167 6520  he same storage 
+00030770: 696e 2043 4f50 5920 6d6f 6465 2e0a 2020  in COPY mode..  
+00030780: 2020 2020 2020 746d 705f 636f 7079 5f6d        tmp_copy_m
+00030790: 6e74 5f65 7869 7374 696e 675f 7374 6f72  nt_existing_stor
+000307a0: 6167 655f 6f62 6a2e 6164 645f 7374 6f72  age_obj.add_stor
+000307b0: 6528 7374 6f72 6167 655f 6c69 622e 5374  e(storage_lib.St
+000307c0: 6f72 6554 7970 652e 5333 290a 2020 2020  oreType.S3).    
+000307d0: 2020 2020 7374 6f72 6167 655f 6e61 6d65      storage_name
+000307e0: 203d 2074 6d70 5f63 6f70 795f 6d6e 745f   = tmp_copy_mnt_
+000307f0: 6578 6973 7469 6e67 5f73 746f 7261 6765  existing_storage
+00030800: 5f6f 626a 2e6e 616d 650a 0a20 2020 2020  _obj.name..     
+00030810: 2020 2023 2043 6865 636b 2060 736b 7920     # Check `sky 
+00030820: 7374 6f72 6167 6520 6c73 6020 746f 2065  storage ls` to e
+00030830: 6e73 7572 6520 7374 6f72 6167 6520 6f62  nsure storage ob
+00030840: 6a65 6374 2065 7869 7374 730a 2020 2020  ject exists.    
+00030850: 2020 2020 6f75 7420 3d20 7375 6270 726f      out = subpro
+00030860: 6365 7373 2e63 6865 636b 5f6f 7574 7075  cess.check_outpu
+00030870: 7428 5b27 736b 7927 2c20 2773 746f 7261  t(['sky', 'stora
+00030880: 6765 272c 2027 6c73 275d 292e 6465 636f  ge', 'ls']).deco
+00030890: 6465 2827 7574 662d 3827 290a 2020 2020  de('utf-8').    
+000308a0: 2020 2020 6173 7365 7274 2073 746f 7261      assert stora
+000308b0: 6765 5f6e 616d 6520 696e 206f 7574 2c20  ge_name in out, 
+000308c0: 6627 5374 6f72 6167 6520 7b73 746f 7261  f'Storage {stora
+000308d0: 6765 5f6e 616d 657d 206e 6f74 2066 6f75  ge_name} not fou
+000308e0: 6e64 2069 6e20 736b 7920 7374 6f72 6167  nd in sky storag
+000308f0: 6520 6c73 2e27 0a0a 2020 2020 4070 7974  e ls.'..    @pyt
+00030900: 6573 742e 6d61 726b 2e6e 6f5f 666c 7569  est.mark.no_flui
+00030910: 6473 7461 636b 0a20 2020 2040 7079 7465  dstack.    @pyte
+00030920: 7374 2e6d 6172 6b2e 7061 7261 6d65 7472  st.mark.parametr
+00030930: 697a 6528 2773 746f 7265 5f74 7970 6527  ize('store_type'
+00030940: 2c20 5b0a 2020 2020 2020 2020 7374 6f72  , [.        stor
+00030950: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
+00030960: 652e 5333 2c20 7374 6f72 6167 655f 6c69  e.S3, storage_li
+00030970: 622e 5374 6f72 6554 7970 652e 4743 532c  b.StoreType.GCS,
+00030980: 0a20 2020 2020 2020 2070 7974 6573 742e  .        pytest.
+00030990: 7061 7261 6d28 7374 6f72 6167 655f 6c69  param(storage_li
+000309a0: 622e 5374 6f72 6554 7970 652e 4942 4d2c  b.StoreType.IBM,
+000309b0: 206d 6172 6b73 3d70 7974 6573 742e 6d61   marks=pytest.ma
+000309c0: 726b 2e69 626d 292c 0a20 2020 2020 2020  rk.ibm),.       
+000309d0: 2070 7974 6573 742e 7061 7261 6d28 7374   pytest.param(st
+000309e0: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
+000309f0: 7970 652e 5232 2c20 6d61 726b 733d 7079  ype.R2, marks=py
+00030a00: 7465 7374 2e6d 6172 6b2e 636c 6f75 6466  test.mark.cloudf
+00030a10: 6c61 7265 290a 2020 2020 5d29 0a20 2020  lare).    ]).   
+00030a20: 2064 6566 2074 6573 745f 6c69 7374 5f73   def test_list_s
+00030a30: 6f75 7263 6528 7365 6c66 2c20 746d 705f  ource(self, tmp_
+00030a40: 6c6f 6361 6c5f 6c69 7374 5f73 746f 7261  local_list_stora
+00030a50: 6765 5f6f 626a 2c20 7374 6f72 655f 7479  ge_obj, store_ty
+00030a60: 7065 293a 0a20 2020 2020 2020 2023 2055  pe):.        # U
+00030a70: 7365 7320 6120 6c69 7374 2069 6e20 7468  ses a list in th
+00030a80: 6520 736f 7572 6365 2066 6965 6c64 2074  e source field t
+00030a90: 6f20 7370 6563 6966 7920 6120 6669 6c65  o specify a file
+00030aa0: 2061 6e64 2061 2064 6972 6563 746f 7279   and a directory
+00030ab0: 2074 6f0a 2020 2020 2020 2020 2320 6265   to.        # be
+00030ac0: 2075 706c 6f61 6465 6420 746f 2074 6865   uploaded to the
+00030ad0: 2073 746f 7261 6765 206f 626a 6563 742e   storage object.
+00030ae0: 0a20 2020 2020 2020 2074 6d70 5f6c 6f63  .        tmp_loc
+00030af0: 616c 5f6c 6973 745f 7374 6f72 6167 655f  al_list_storage_
+00030b00: 6f62 6a2e 6164 645f 7374 6f72 6528 7374  obj.add_store(st
+00030b10: 6f72 655f 7479 7065 290a 0a20 2020 2020  ore_type)..     
+00030b20: 2020 2023 2043 6865 636b 2069 6620 746d     # Check if tm
+00030b30: 702d 6669 6c65 2065 7869 7374 7320 696e  p-file exists in
+00030b40: 2074 6865 2062 7563 6b65 7420 726f 6f74   the bucket root
+00030b50: 2075 7369 6e67 2063 6c69 0a20 2020 2020   using cli.     
+00030b60: 2020 206f 7574 203d 2073 7562 7072 6f63     out = subproc
+00030b70: 6573 732e 6368 6563 6b5f 6f75 7470 7574  ess.check_output
+00030b80: 2873 656c 662e 636c 695f 6c73 5f63 6d64  (self.cli_ls_cmd
+00030b90: 280a 2020 2020 2020 2020 2020 2020 7374  (.            st
+00030ba0: 6f72 655f 7479 7065 2c20 746d 705f 6c6f  ore_type, tmp_lo
+00030bb0: 6361 6c5f 6c69 7374 5f73 746f 7261 6765  cal_list_storage
+00030bc0: 5f6f 626a 2e6e 616d 6529 2c0a 2020 2020  _obj.name),.    
+00030bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030bf0: 2020 7368 656c 6c3d 5472 7565 290a 2020    shell=True).  
+00030c00: 2020 2020 2020 6173 7365 7274 2027 746d        assert 'tm
+00030c10: 702d 6669 6c65 2720 696e 206f 7574 2e64  p-file' in out.d
+00030c20: 6563 6f64 6528 2775 7466 2d38 2729 2c20  ecode('utf-8'), 
+00030c30: 5c0a 2020 2020 2020 2020 2020 2020 2746  \.            'F
+00030c40: 696c 6520 6e6f 7420 666f 756e 6420 696e  ile not found in
+00030c50: 2062 7563 6b65 7420 2d20 6f75 7470 7574   bucket - output
+00030c60: 2077 6173 203a 207b 7d27 2e66 6f72 6d61   was : {}'.forma
+00030c70: 7428 6f75 742e 6465 636f 6465 0a20 2020  t(out.decode.   
+00030c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030cb0: 2020 2020 2020 2020 2020 2020 2028 2775               ('u
+00030cc0: 7466 2d38 2729 290a 0a20 2020 2020 2020  tf-8'))..       
+00030cd0: 2023 2043 6865 636b 2069 6620 746d 702d   # Check if tmp-
+00030ce0: 6669 6c65 2065 7869 7374 7320 696e 2074  file exists in t
+00030cf0: 6865 2062 7563 6b65 742f 746d 702d 736f  he bucket/tmp-so
+00030d00: 7572 6365 2075 7369 6e67 2063 6c69 0a20  urce using cli. 
+00030d10: 2020 2020 2020 206f 7574 203d 2073 7562         out = sub
+00030d20: 7072 6f63 6573 732e 6368 6563 6b5f 6f75  process.check_ou
+00030d30: 7470 7574 2873 656c 662e 636c 695f 6c73  tput(self.cli_ls
+00030d40: 5f63 6d64 280a 2020 2020 2020 2020 2020  _cmd(.          
+00030d50: 2020 7374 6f72 655f 7479 7065 2c20 746d    store_type, tm
+00030d60: 705f 6c6f 6361 6c5f 6c69 7374 5f73 746f  p_local_list_sto
+00030d70: 7261 6765 5f6f 626a 2e6e 616d 652c 2027  rage_obj.name, '
+00030d80: 746d 702d 736f 7572 6365 2f27 292c 0a20  tmp-source/'),. 
+00030d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030db0: 2020 2020 2073 6865 6c6c 3d54 7275 6529       shell=True)
+00030dc0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+00030dd0: 2774 6d70 2d66 696c 6527 2069 6e20 6f75  'tmp-file' in ou
+00030de0: 742e 6465 636f 6465 2827 7574 662d 3827  t.decode('utf-8'
+00030df0: 292c 205c 0a20 2020 2020 2020 2020 2020  ), \.           
+00030e00: 2027 4669 6c65 206e 6f74 2066 6f75 6e64   'File not found
+00030e10: 2069 6e20 6275 636b 6574 202d 206f 7574   in bucket - out
+00030e20: 7075 7420 7761 7320 3a20 7b7d 272e 666f  put was : {}'.fo
+00030e30: 726d 6174 286f 7574 2e64 6563 6f64 650a  rmat(out.decode.
+00030e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030e80: 2827 7574 662d 3827 2929 0a0a 2020 2020  ('utf-8'))..    
+00030e90: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+00030ea0: 666c 7569 6473 7461 636b 0a20 2020 2040  fluidstack.    @
+00030eb0: 7079 7465 7374 2e6d 6172 6b2e 7061 7261  pytest.mark.para
+00030ec0: 6d65 7472 697a 6528 2769 6e76 616c 6964  metrize('invalid
+00030ed0: 5f6e 616d 655f 6c69 7374 2c20 7374 6f72  _name_list, stor
+00030ee0: 655f 7479 7065 272c 0a20 2020 2020 2020  e_type',.       
+00030ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030f00: 2020 2020 2020 5b28 4157 535f 494e 5641        [(AWS_INVA
+00030f10: 4c49 445f 4e41 4d45 532c 2073 746f 7261  LID_NAMES, stora
+00030f20: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
+00030f30: 2e53 3329 2c0a 2020 2020 2020 2020 2020  .S3),.          
+00030f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030f50: 2020 2020 2847 4353 5f49 4e56 414c 4944      (GCS_INVALID
+00030f60: 5f4e 414d 4553 2c20 7374 6f72 6167 655f  _NAMES, storage_
+00030f70: 6c69 622e 5374 6f72 6554 7970 652e 4743  lib.StoreType.GC
+00030f80: 5329 2c0a 2020 2020 2020 2020 2020 2020  S),.            
 00030f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030fb0: 2020 2020 2020 2020 2020 2020 2020 2827                ('
-00030fc0: 7574 662d 3827 2929 0a0a 2020 2020 4070  utf-8'))..    @p
-00030fd0: 7974 6573 742e 6d61 726b 2e6e 6f5f 666c  ytest.mark.no_fl
-00030fe0: 7569 6473 7461 636b 0a20 2020 2040 7079  uidstack.    @py
-00030ff0: 7465 7374 2e6d 6172 6b2e 7061 7261 6d65  test.mark.parame
-00031000: 7472 697a 6528 2769 6e76 616c 6964 5f6e  trize('invalid_n
-00031010: 616d 655f 6c69 7374 2c20 7374 6f72 655f  ame_list, store_
-00031020: 7479 7065 272c 0a20 2020 2020 2020 2020  type',.         
-00031030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031040: 2020 2020 5b28 4157 535f 494e 5641 4c49      [(AWS_INVALI
-00031050: 445f 4e41 4d45 532c 2073 746f 7261 6765  D_NAMES, storage
-00031060: 5f6c 6962 2e53 746f 7265 5479 7065 2e53  _lib.StoreType.S
-00031070: 3329 2c0a 2020 2020 2020 2020 2020 2020  3),.            
-00031080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031090: 2020 2847 4353 5f49 4e56 414c 4944 5f4e    (GCS_INVALID_N
-000310a0: 414d 4553 2c20 7374 6f72 6167 655f 6c69  AMES, storage_li
-000310b0: 622e 5374 6f72 6554 7970 652e 4743 5329  b.StoreType.GCS)
-000310c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00030fa0: 2020 7079 7465 7374 2e70 6172 616d 2849    pytest.param(I
+00030fb0: 424d 5f49 4e56 414c 4944 5f4e 414d 4553  BM_INVALID_NAMES
+00030fc0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00030fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030fe0: 2020 2020 2020 2020 2020 2020 2073 746f               sto
+00030ff0: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
+00031000: 7065 2e49 424d 2c0a 2020 2020 2020 2020  pe.IBM,.        
+00031010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031030: 2020 206d 6172 6b73 3d70 7974 6573 742e     marks=pytest.
+00031040: 6d61 726b 2e69 626d 292c 0a20 2020 2020  mark.ibm),.     
+00031050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031060: 2020 2020 2020 2020 2070 7974 6573 742e           pytest.
+00031070: 7061 7261 6d28 4157 535f 494e 5641 4c49  param(AWS_INVALI
+00031080: 445f 4e41 4d45 532c 0a20 2020 2020 2020  D_NAMES,.       
+00031090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000310a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000310b0: 2020 2020 7374 6f72 6167 655f 6c69 622e      storage_lib.
+000310c0: 5374 6f72 6554 7970 652e 5232 2c0a 2020  StoreType.R2,.  
 000310d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000310e0: 7079 7465 7374 2e70 6172 616d 2849 424d  pytest.param(IBM
-000310f0: 5f49 4e56 414c 4944 5f4e 414d 4553 2c0a  _INVALID_NAMES,.
-00031100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031120: 2020 2020 2020 2020 2020 2073 746f 7261             stora
-00031130: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
-00031140: 2e49 424d 2c0a 2020 2020 2020 2020 2020  .IBM,.          
-00031150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031170: 206d 6172 6b73 3d70 7974 6573 742e 6d61   marks=pytest.ma
-00031180: 726b 2e69 626d 292c 0a20 2020 2020 2020  rk.ibm),.       
-00031190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000311a0: 2020 2020 2020 2070 7974 6573 742e 7061         pytest.pa
-000311b0: 7261 6d28 4157 535f 494e 5641 4c49 445f  ram(AWS_INVALID_
-000311c0: 4e41 4d45 532c 0a20 2020 2020 2020 2020  NAMES,.         
-000311d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000311e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000311f0: 2020 7374 6f72 6167 655f 6c69 622e 5374    storage_lib.St
-00031200: 6f72 6554 7970 652e 5232 2c0a 2020 2020  oreType.R2,.    
-00031210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031230: 2020 2020 2020 206d 6172 6b73 3d70 7974         marks=pyt
-00031240: 6573 742e 6d61 726b 2e63 6c6f 7564 666c  est.mark.cloudfl
-00031250: 6172 6529 5d29 0a20 2020 2064 6566 2074  are)]).    def t
-00031260: 6573 745f 696e 7661 6c69 645f 6e61 6d65  est_invalid_name
-00031270: 7328 7365 6c66 2c20 696e 7661 6c69 645f  s(self, invalid_
-00031280: 6e61 6d65 5f6c 6973 742c 2073 746f 7265  name_list, store
-00031290: 5f74 7970 6529 3a0a 2020 2020 2020 2020  _type):.        
-000312a0: 2320 5573 6573 2061 206c 6973 7420 696e  # Uses a list in
-000312b0: 2074 6865 2073 6f75 7263 6520 6669 656c   the source fiel
-000312c0: 6420 746f 2073 7065 6369 6679 2061 2066  d to specify a f
-000312d0: 696c 6520 616e 6420 6120 6469 7265 6374  ile and a direct
-000312e0: 6f72 7920 746f 0a20 2020 2020 2020 2023  ory to.        #
-000312f0: 2062 6520 7570 6c6f 6164 6564 2074 6f20   be uploaded to 
-00031300: 7468 6520 7374 6f72 6167 6520 6f62 6a65  the storage obje
-00031310: 6374 2e0a 2020 2020 2020 2020 666f 7220  ct..        for 
-00031320: 6e61 6d65 2069 6e20 696e 7661 6c69 645f  name in invalid_
-00031330: 6e61 6d65 5f6c 6973 743a 0a20 2020 2020  name_list:.     
-00031340: 2020 2020 2020 2077 6974 6820 7079 7465         with pyte
-00031350: 7374 2e72 6169 7365 7328 736b 792e 6578  st.raises(sky.ex
-00031360: 6365 7074 696f 6e73 2e53 746f 7261 6765  ceptions.Storage
-00031370: 4e61 6d65 4572 726f 7229 3a0a 2020 2020  NameError):.    
-00031380: 2020 2020 2020 2020 2020 2020 7374 6f72              stor
-00031390: 6167 655f 6f62 6a20 3d20 7374 6f72 6167  age_obj = storag
-000313a0: 655f 6c69 622e 5374 6f72 6167 6528 6e61  e_lib.Storage(na
-000313b0: 6d65 3d6e 616d 6529 0a20 2020 2020 2020  me=name).       
-000313c0: 2020 2020 2020 2020 2073 746f 7261 6765           storage
-000313d0: 5f6f 626a 2e61 6464 5f73 746f 7265 2873  _obj.add_store(s
-000313e0: 746f 7265 5f74 7970 6529 0a0a 2020 2020  tore_type)..    
-000313f0: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
-00031400: 666c 7569 6473 7461 636b 0a20 2020 2040  fluidstack.    @
-00031410: 7079 7465 7374 2e6d 6172 6b2e 7061 7261  pytest.mark.para
-00031420: 6d65 7472 697a 6528 0a20 2020 2020 2020  metrize(.       
-00031430: 2027 6769 7469 676e 6f72 655f 7374 7275   'gitignore_stru
-00031440: 6374 7572 652c 2073 746f 7265 5f74 7970  cture, store_typ
-00031450: 6527 2c0a 2020 2020 2020 2020 5b28 4749  e',.        [(GI
-00031460: 5449 474e 4f52 455f 5359 4e43 5f54 4553  TIGNORE_SYNC_TES
-00031470: 545f 4449 525f 5354 5255 4354 5552 452c  T_DIR_STRUCTURE,
-00031480: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
-00031490: 7265 5479 7065 2e53 3329 2c0a 2020 2020  reType.S3),.    
-000314a0: 2020 2020 2028 4749 5449 474e 4f52 455f       (GITIGNORE_
-000314b0: 5359 4e43 5f54 4553 545f 4449 525f 5354  SYNC_TEST_DIR_ST
-000314c0: 5255 4354 5552 452c 2073 746f 7261 6765  RUCTURE, storage
-000314d0: 5f6c 6962 2e53 746f 7265 5479 7065 2e47  _lib.StoreType.G
-000314e0: 4353 292c 0a20 2020 2020 2020 2020 7079  CS),.         py
-000314f0: 7465 7374 2e70 6172 616d 2847 4954 4947  test.param(GITIG
-00031500: 4e4f 5245 5f53 594e 435f 5445 5354 5f44  NORE_SYNC_TEST_D
-00031510: 4952 5f53 5452 5543 5455 5245 2c0a 2020  IR_STRUCTURE,.  
-00031520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031530: 2020 2020 7374 6f72 6167 655f 6c69 622e      storage_lib.
-00031540: 5374 6f72 6554 7970 652e 5232 2c0a 2020  StoreType.R2,.  
-00031550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031560: 2020 2020 6d61 726b 733d 7079 7465 7374      marks=pytest
-00031570: 2e6d 6172 6b2e 636c 6f75 6466 6c61 7265  .mark.cloudflare
-00031580: 295d 290a 2020 2020 6465 6620 7465 7374  )]).    def test
-00031590: 5f65 7863 6c75 6465 645f 6669 6c65 5f63  _excluded_file_c
-000315a0: 6c6f 7564 5f73 746f 7261 6765 5f75 706c  loud_storage_upl
-000315b0: 6f61 645f 636f 7079 2873 656c 662c 2067  oad_copy(self, g
-000315c0: 6974 6967 6e6f 7265 5f73 7472 7563 7475  itignore_structu
-000315d0: 7265 2c0a 2020 2020 2020 2020 2020 2020  re,.            
-000315e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000315f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031600: 2020 2020 2020 2020 2073 746f 7265 5f74           store_t
-00031610: 7970 652c 0a20 2020 2020 2020 2020 2020  ype,.           
-00031620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031640: 2020 2020 2020 2020 2020 746d 705f 6769            tmp_gi
-00031650: 7469 676e 6f72 655f 7374 6f72 6167 655f  tignore_storage_
-00031660: 6f62 6a29 3a0a 2020 2020 2020 2020 2320  obj):.        # 
-00031670: 7465 7374 7320 6966 2066 696c 6573 2069  tests if files i
-00031680: 6e63 6c75 6465 6420 696e 202e 6769 7469  ncluded in .giti
-00031690: 676e 6f72 6520 616e 6420 2e67 6974 2f69  gnore and .git/i
-000316a0: 6e66 6f2f 6578 636c 7564 6520 6172 650a  nfo/exclude are.
-000316b0: 2020 2020 2020 2020 2320 6578 636c 7564          # exclud
-000316c0: 6564 2066 726f 6d20 6265 696e 6720 7472  ed from being tr
-000316d0: 616e 7366 6572 7265 6420 746f 2053 746f  ansferred to Sto
-000316e0: 7261 6765 0a0a 2020 2020 2020 2020 746d  rage..        tm
-000316f0: 705f 6769 7469 676e 6f72 655f 7374 6f72  p_gitignore_stor
-00031700: 6167 655f 6f62 6a2e 6164 645f 7374 6f72  age_obj.add_stor
-00031710: 6528 7374 6f72 655f 7479 7065 290a 0a20  e(store_type).. 
-00031720: 2020 2020 2020 2075 706c 6f61 645f 6669         upload_fi
-00031730: 6c65 5f6e 616d 6520 3d20 2769 6e63 6c75  le_name = 'inclu
-00031740: 6465 6427 0a20 2020 2020 2020 2023 2043  ded'.        # C
-00031750: 6f75 6e74 2074 6865 206e 756d 6265 7220  ount the number 
-00031760: 6f66 2066 696c 6573 2077 6974 6820 7468  of files with th
-00031770: 6520 6769 7665 6e20 6669 6c65 206e 616d  e given file nam
-00031780: 650a 2020 2020 2020 2020 7570 5f63 6d64  e.        up_cmd
-00031790: 203d 2073 656c 662e 636c 695f 636f 756e   = self.cli_coun
-000317a0: 745f 6e61 6d65 5f69 6e5f 6275 636b 6574  t_name_in_bucket
-000317b0: 2873 746f 7265 5f74 7970 652c 205c 0a20  (store_type, \. 
-000317c0: 2020 2020 2020 2020 2020 2074 6d70 5f67             tmp_g
-000317d0: 6974 6967 6e6f 7265 5f73 746f 7261 6765  itignore_storage
-000317e0: 5f6f 626a 2e6e 616d 652c 2066 696c 655f  _obj.name, file_
-000317f0: 6e61 6d65 3d75 706c 6f61 645f 6669 6c65  name=upload_file
-00031800: 5f6e 616d 6529 0a20 2020 2020 2020 2067  _name).        g
-00031810: 6974 5f65 7863 6c75 6465 5f63 6d64 203d  it_exclude_cmd =
-00031820: 2073 656c 662e 636c 695f 636f 756e 745f   self.cli_count_
-00031830: 6e61 6d65 5f69 6e5f 6275 636b 6574 2873  name_in_bucket(s
-00031840: 746f 7265 5f74 7970 652c 205c 0a20 2020  tore_type, \.   
-00031850: 2020 2020 2020 2020 2074 6d70 5f67 6974           tmp_git
-00031860: 6967 6e6f 7265 5f73 746f 7261 6765 5f6f  ignore_storage_o
-00031870: 626a 2e6e 616d 652c 2066 696c 655f 6e61  bj.name, file_na
-00031880: 6d65 3d27 2e67 6974 2729 0a20 2020 2020  me='.git').     
-00031890: 2020 2063 6e74 5f6e 756d 5f66 696c 655f     cnt_num_file_
-000318a0: 636d 6420 3d20 7365 6c66 2e63 6c69 5f63  cmd = self.cli_c
-000318b0: 6f75 6e74 5f66 696c 655f 696e 5f62 7563  ount_file_in_buc
-000318c0: 6b65 7428 0a20 2020 2020 2020 2020 2020  ket(.           
-000318d0: 2073 746f 7265 5f74 7970 652c 2074 6d70   store_type, tmp
-000318e0: 5f67 6974 6967 6e6f 7265 5f73 746f 7261  _gitignore_stora
-000318f0: 6765 5f6f 626a 2e6e 616d 6529 0a0a 2020  ge_obj.name)..  
-00031900: 2020 2020 2020 7570 5f6f 7574 7075 7420        up_output 
-00031910: 3d20 7375 6270 726f 6365 7373 2e63 6865  = subprocess.che
-00031920: 636b 5f6f 7574 7075 7428 7570 5f63 6d64  ck_output(up_cmd
-00031930: 2c20 7368 656c 6c3d 5472 7565 290a 2020  , shell=True).  
-00031940: 2020 2020 2020 6769 745f 6578 636c 7564        git_exclud
-00031950: 655f 6f75 7470 7574 203d 2073 7562 7072  e_output = subpr
-00031960: 6f63 6573 732e 6368 6563 6b5f 6f75 7470  ocess.check_outp
-00031970: 7574 2867 6974 5f65 7863 6c75 6465 5f63  ut(git_exclude_c
-00031980: 6d64 2c0a 2020 2020 2020 2020 2020 2020  md,.            
-00031990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000319a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000319b0: 2020 2020 2020 2020 2073 6865 6c6c 3d54           shell=T
-000319c0: 7275 6529 0a20 2020 2020 2020 2063 6e74  rue).        cnt
-000319d0: 5f6f 7574 7075 7420 3d20 7375 6270 726f  _output = subpro
-000319e0: 6365 7373 2e63 6865 636b 5f6f 7574 7075  cess.check_outpu
-000319f0: 7428 636e 745f 6e75 6d5f 6669 6c65 5f63  t(cnt_num_file_c
-00031a00: 6d64 2c20 7368 656c 6c3d 5472 7565 290a  md, shell=True).
-00031a10: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-00031a20: 2733 2720 696e 2075 705f 6f75 7470 7574  '3' in up_output
-00031a30: 2e64 6563 6f64 6528 2775 7466 2d38 2729  .decode('utf-8')
-00031a40: 2c20 5c0a 2020 2020 2020 2020 2020 2020  , \.            
-00031a50: 2020 2020 2746 696c 6573 2074 6f20 6265      'Files to be
-00031a60: 2069 6e63 6c75 6465 6420 6172 6520 6e6f   included are no
-00031a70: 7420 636f 6d70 6c65 7465 6c79 2075 706c  t completely upl
-00031a80: 6f61 6465 642e 270a 2020 2020 2020 2020  oaded.'.        
-00031a90: 2320 3120 6973 2072 6561 6420 6173 202e  # 1 is read as .
-00031aa0: 6769 7469 676e 6f72 6520 6973 2075 706c  gitignore is upl
-00031ab0: 6f61 6465 640a 2020 2020 2020 2020 6173  oaded.        as
-00031ac0: 7365 7274 2027 3127 2069 6e20 6769 745f  sert '1' in git_
-00031ad0: 6578 636c 7564 655f 6f75 7470 7574 2e64  exclude_output.d
-00031ae0: 6563 6f64 6528 2775 7466 2d38 2729 2c20  ecode('utf-8'), 
-00031af0: 5c0a 2020 2020 2020 2020 2020 2020 2020  \.              
-00031b00: 2027 2e67 6974 2064 6972 6563 746f 7279   '.git directory
-00031b10: 2073 686f 756c 6420 6e6f 7420 6265 2075   should not be u
-00031b20: 706c 6f61 6465 642e 270a 2020 2020 2020  ploaded.'.      
-00031b30: 2020 2320 3420 6669 6c65 7320 696e 636c    # 4 files incl
-00031b40: 7564 6520 2e67 6974 6967 6e6f 7265 2c20  ude .gitignore, 
-00031b50: 696e 636c 7564 6564 2e6c 6f67 2c20 696e  included.log, in
-00031b60: 636c 7564 6564 2e74 7874 2c20 696e 636c  cluded.txt, incl
-00031b70: 7564 655f 6469 722f 696e 636c 7564 6564  ude_dir/included
-00031b80: 2e6c 6f67 0a20 2020 2020 2020 2061 7373  .log.        ass
-00031b90: 6572 7420 2734 2720 696e 2063 6e74 5f6f  ert '4' in cnt_o
-00031ba0: 7574 7075 742e 6465 636f 6465 2827 7574  utput.decode('ut
-00031bb0: 662d 3827 292c 205c 0a20 2020 2020 2020  f-8'), \.       
-00031bc0: 2020 2020 2020 2020 2753 6f6d 6520 6974          'Some it
-00031bd0: 656d 7320 6c69 7374 6564 2069 6e20 2e67  ems listed in .g
-00031be0: 6974 6967 6e6f 7265 2061 6e64 202e 6769  itignore and .gi
-00031bf0: 742f 696e 666f 2f65 7863 6c75 6465 2061  t/info/exclude a
-00031c00: 7265 206e 6f74 2065 7863 6c75 6465 642e  re not excluded.
-00031c10: 270a 0a20 2020 2040 7079 7465 7374 2e6d  '..    @pytest.m
-00031c20: 6172 6b2e 7061 7261 6d65 7472 697a 6528  ark.parametrize(
-00031c30: 2765 7874 5f62 7563 6b65 745f 6669 7874  'ext_bucket_fixt
-00031c40: 7572 652c 2073 746f 7265 5f74 7970 6527  ure, store_type'
-00031c50: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00031c60: 2020 2020 2020 2020 2020 2020 2020 205b                 [
-00031c70: 2827 746d 705f 6177 7363 6c69 5f62 7563  ('tmp_awscli_buc
-00031c80: 6b65 7427 2c20 7374 6f72 6167 655f 6c69  ket', storage_li
-00031c90: 622e 5374 6f72 6554 7970 652e 5333 292c  b.StoreType.S3),
-00031ca0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00031cb0: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-00031cc0: 2774 6d70 5f67 7375 7469 6c5f 6275 636b  'tmp_gsutil_buck
-00031cd0: 6574 272c 2073 746f 7261 6765 5f6c 6962  et', storage_lib
-00031ce0: 2e53 746f 7265 5479 7065 2e47 4353 292c  .StoreType.GCS),
-00031cf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00031d00: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00031d10: 7974 6573 742e 7061 7261 6d28 2774 6d70  ytest.param('tmp
-00031d20: 5f61 7773 636c 695f 6275 636b 6574 5f72  _awscli_bucket_r
-00031d30: 3227 2c0a 2020 2020 2020 2020 2020 2020  2',.            
-00031d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031d50: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00031d60: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
-00031d70: 5479 7065 2e52 322c 0a20 2020 2020 2020  Type.R2,.       
-00031d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031da0: 2020 2020 6d61 726b 733d 7079 7465 7374      marks=pytest
-00031db0: 2e6d 6172 6b2e 636c 6f75 6466 6c61 7265  .mark.cloudflare
-00031dc0: 295d 290a 2020 2020 6465 6620 7465 7374  )]).    def test
-00031dd0: 5f65 7874 6572 6e61 6c6c 795f 6372 6561  _externally_crea
-00031de0: 7465 645f 6275 636b 6574 5f6d 6f75 6e74  ted_bucket_mount
-00031df0: 5f77 6974 686f 7574 5f73 6f75 7263 6528  _without_source(
-00031e00: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00031e10: 662c 2065 7874 5f62 7563 6b65 745f 6669  f, ext_bucket_fi
-00031e20: 7874 7572 652c 2072 6571 7565 7374 2c20  xture, request, 
-00031e30: 7374 6f72 655f 7479 7065 293a 0a20 2020  store_type):.   
-00031e40: 2020 2020 2023 204e 6f6e 2d73 6b79 206d       # Non-sky m
-00031e50: 616e 6167 6564 2062 7563 6b65 7473 2862  anaged buckets(b
-00031e60: 7563 6b65 7473 2063 7265 6174 6564 206f  uckets created o
-00031e70: 7574 7369 6465 206f 6620 536b 7970 696c  utside of Skypil
-00031e80: 6f74 2043 4c49 290a 2020 2020 2020 2020  ot CLI).        
-00031e90: 2320 6172 6520 616c 6c6f 7765 6420 746f  # are allowed to
-00031ea0: 2062 6520 4d4f 554e 5465 6420 6279 2073   be MOUNTed by s
-00031eb0: 7065 6369 6679 696e 6720 7468 6520 5552  pecifying the UR
-00031ec0: 4920 6f66 2074 6865 2062 7563 6b65 7420  I of the bucket 
-00031ed0: 746f 0a20 2020 2020 2020 2023 2073 6f75  to.        # sou
-00031ee0: 7263 6520 6669 656c 6420 6f6e 6c79 2e20  rce field only. 
-00031ef0: 5768 656e 2069 7420 6973 2061 7474 656d  When it is attem
-00031f00: 7074 6564 2062 7920 7370 6563 6966 7969  pted by specifyi
-00031f10: 6e67 2074 6865 206e 616d 6520 6f66 0a20  ng the name of. 
-00031f20: 2020 2020 2020 2023 2074 6865 2062 7563         # the buc
-00031f30: 6b65 7420 6f6e 6c79 2c20 6974 2073 686f  ket only, it sho
-00031f40: 756c 6420 6572 726f 7220 6f75 742e 0a20  uld error out.. 
-00031f50: 2020 2020 2020 2023 0a20 2020 2020 2020         #.       
-00031f60: 2023 2054 4f44 4f28 646f 796f 756e 6729   # TODO(doyoung)
-00031f70: 3a20 4164 6420 7465 7374 2066 6f72 2049  : Add test for I
-00031f80: 424d 2043 4f53 2e20 4375 7272 656e 746c  BM COS. Currentl
-00031f90: 792c 2074 6869 7320 6973 2062 6c6f 636b  y, this is block
-00031fa0: 6564 0a20 2020 2020 2020 2023 2061 7320  ed.        # as 
-00031fb0: 7263 6c6f 6e65 2075 7365 6420 746f 2069  rclone used to i
-00031fc0: 6e74 6572 6163 7420 7769 7468 2049 424d  nteract with IBM
-00031fd0: 2043 4f53 2064 6f65 7320 6e6f 7420 7375   COS does not su
-00031fe0: 7070 6f72 7420 6665 6174 7572 6520 746f  pport feature to
-00031ff0: 0a20 2020 2020 2020 2023 2063 7265 6174  .        # creat
-00032000: 6520 6120 6275 636b 6574 2c20 616e 6420  e a bucket, and 
-00032010: 7468 6520 6962 6d63 6c6f 7564 2043 4c49  the ibmcloud CLI
-00032020: 2069 7320 6e6f 7420 7375 7070 6f72 7465   is not supporte
-00032030: 6420 696e 2053 6b79 7069 6c6f 742e 0a20  d in Skypilot.. 
-00032040: 2020 2020 2020 2023 2045 6974 6865 7220         # Either 
-00032050: 6f66 2074 6865 2066 6561 7475 7265 2069  of the feature i
-00032060: 7320 6e65 6365 7373 6172 7920 746f 2073  s necessary to s
-00032070: 696d 756c 6174 6520 616e 2065 7874 6572  imulate an exter
-00032080: 6e61 6c20 6275 636b 6574 0a20 2020 2020  nal bucket.     
-00032090: 2020 2023 2063 7265 6174 696f 6e20 666f     # creation fo
-000320a0: 7220 4942 4d20 434f 532e 0a20 2020 2020  r IBM COS..     
-000320b0: 2020 2023 2068 7474 7073 3a2f 2f67 6974     # https://git
-000320c0: 6875 622e 636f 6d2f 736b 7970 696c 6f74  hub.com/skypilot
-000320d0: 2d6f 7267 2f73 6b79 7069 6c6f 742f 7075  -org/skypilot/pu
-000320e0: 6c6c 2f31 3936 362f 6669 6c65 7323 7231  ll/1966/files#r1
-000320f0: 3235 3334 3339 3833 370a 0a20 2020 2020  253439837..     
-00032100: 2020 2065 7874 5f62 7563 6b65 745f 6e61     ext_bucket_na
-00032110: 6d65 2c20 6578 745f 6275 636b 6574 5f75  me, ext_bucket_u
-00032120: 7269 203d 2072 6571 7565 7374 2e67 6574  ri = request.get
-00032130: 6669 7874 7572 6576 616c 7565 280a 2020  fixturevalue(.  
-00032140: 2020 2020 2020 2020 2020 6578 745f 6275            ext_bu
-00032150: 636b 6574 5f66 6978 7475 7265 290a 2020  cket_fixture).  
-00032160: 2020 2020 2020 2320 696e 7661 6c69 6420        # invalid 
-00032170: 7370 6563 0a20 2020 2020 2020 2077 6974  spec.        wit
-00032180: 6820 7079 7465 7374 2e72 6169 7365 7328  h pytest.raises(
-00032190: 736b 792e 6578 6365 7074 696f 6e73 2e53  sky.exceptions.S
-000321a0: 746f 7261 6765 5370 6563 4572 726f 7229  torageSpecError)
-000321b0: 2061 7320 653a 0a20 2020 2020 2020 2020   as e:.         
-000321c0: 2020 2073 746f 7261 6765 5f6f 626a 203d     storage_obj =
-000321d0: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
-000321e0: 7261 6765 280a 2020 2020 2020 2020 2020  rage(.          
-000321f0: 2020 2020 2020 6e61 6d65 3d65 7874 5f62        name=ext_b
-00032200: 7563 6b65 745f 6e61 6d65 2c20 6d6f 6465  ucket_name, mode
-00032210: 3d73 746f 7261 6765 5f6c 6962 2e53 746f  =storage_lib.Sto
-00032220: 7261 6765 4d6f 6465 2e4d 4f55 4e54 290a  rageMode.MOUNT).
-00032230: 2020 2020 2020 2020 2020 2020 7374 6f72              stor
-00032240: 6167 655f 6f62 6a2e 6164 645f 7374 6f72  age_obj.add_stor
-00032250: 6528 7374 6f72 655f 7479 7065 290a 0a20  e(store_type).. 
-00032260: 2020 2020 2020 2061 7373 6572 7420 2741         assert 'A
-00032270: 7474 656d 7074 6564 2074 6f20 6d6f 756e  ttempted to moun
-00032280: 7420 6120 6e6f 6e2d 736b 7920 6d61 6e61  t a non-sky mana
-00032290: 6765 6420 6275 636b 6574 2720 696e 2073  ged bucket' in s
-000322a0: 7472 2865 290a 0a20 2020 2020 2020 2023  tr(e)..        #
-000322b0: 2076 616c 6964 2073 7065 630a 2020 2020   valid spec.    
-000322c0: 2020 2020 7374 6f72 6167 655f 6f62 6a20      storage_obj 
-000322d0: 3d20 7374 6f72 6167 655f 6c69 622e 5374  = storage_lib.St
-000322e0: 6f72 6167 6528 736f 7572 6365 3d65 7874  orage(source=ext
-000322f0: 5f62 7563 6b65 745f 7572 692c 0a20 2020  _bucket_uri,.   
-00032300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032320: 2020 2020 2020 206d 6f64 653d 7374 6f72         mode=stor
-00032330: 6167 655f 6c69 622e 5374 6f72 6167 654d  age_lib.StorageM
-00032340: 6f64 652e 4d4f 554e 5429 0a20 2020 2020  ode.MOUNT).     
-00032350: 2020 2068 616e 646c 6520 3d20 676c 6f62     handle = glob
-00032360: 616c 5f75 7365 725f 7374 6174 652e 6765  al_user_state.ge
-00032370: 745f 6861 6e64 6c65 5f66 726f 6d5f 7374  t_handle_from_st
-00032380: 6f72 6167 655f 6e61 6d65 280a 2020 2020  orage_name(.    
-00032390: 2020 2020 2020 2020 7374 6f72 6167 655f          storage_
-000323a0: 6f62 6a2e 6e61 6d65 290a 2020 2020 2020  obj.name).      
-000323b0: 2020 6966 2068 616e 646c 653a 0a20 2020    if handle:.   
-000323c0: 2020 2020 2020 2020 2073 746f 7261 6765           storage
-000323d0: 5f6f 626a 2e64 656c 6574 6528 290a 0a20  _obj.delete().. 
-000323e0: 2020 2040 7079 7465 7374 2e6d 6172 6b2e     @pytest.mark.
-000323f0: 6e6f 5f66 6c75 6964 7374 6163 6b0a 2020  no_fluidstack.  
-00032400: 2020 4070 7974 6573 742e 6d61 726b 2e70    @pytest.mark.p
-00032410: 6172 616d 6574 7269 7a65 2827 7265 6769  arametrize('regi
-00032420: 6f6e 272c 205b 0a20 2020 2020 2020 2027  on', [.        '
-00032430: 6170 2d6e 6f72 7468 6561 7374 2d31 272c  ap-northeast-1',
-00032440: 2027 6170 2d6e 6f72 7468 6561 7374 2d32   'ap-northeast-2
-00032450: 272c 2027 6170 2d6e 6f72 7468 6561 7374  ', 'ap-northeast
-00032460: 2d33 272c 2027 6170 2d73 6f75 7468 2d31  -3', 'ap-south-1
-00032470: 272c 0a20 2020 2020 2020 2027 6170 2d73  ',.        'ap-s
-00032480: 6f75 7468 6561 7374 2d31 272c 2027 6170  outheast-1', 'ap
-00032490: 2d73 6f75 7468 6561 7374 2d32 272c 2027  -southeast-2', '
-000324a0: 6575 2d63 656e 7472 616c 2d31 272c 2027  eu-central-1', '
-000324b0: 6575 2d6e 6f72 7468 2d31 272c 0a20 2020  eu-north-1',.   
-000324c0: 2020 2020 2027 6575 2d77 6573 742d 3127       'eu-west-1'
-000324d0: 2c20 2765 752d 7765 7374 2d32 272c 2027  , 'eu-west-2', '
-000324e0: 6575 2d77 6573 742d 3327 2c20 2773 612d  eu-west-3', 'sa-
-000324f0: 6561 7374 2d31 272c 2027 7573 2d65 6173  east-1', 'us-eas
-00032500: 742d 3127 2c0a 2020 2020 2020 2020 2775  t-1',.        'u
-00032510: 732d 6561 7374 2d32 272c 2027 7573 2d77  s-east-2', 'us-w
-00032520: 6573 742d 3127 2c20 2775 732d 7765 7374  est-1', 'us-west
-00032530: 2d32 270a 2020 2020 5d29 0a20 2020 2064  -2'.    ]).    d
-00032540: 6566 2074 6573 745f 6177 735f 7265 6769  ef test_aws_regi
-00032550: 6f6e 7328 7365 6c66 2c20 746d 705f 6c6f  ons(self, tmp_lo
-00032560: 6361 6c5f 7374 6f72 6167 655f 6f62 6a2c  cal_storage_obj,
-00032570: 2072 6567 696f 6e29 3a0a 2020 2020 2020   region):.      
-00032580: 2020 2320 5468 6973 2074 6573 7473 2063    # This tests c
-00032590: 7265 6174 696f 6e20 616e 6420 7570 6c6f  reation and uplo
-000325a0: 6164 2074 6f20 6275 636b 6574 2069 6e20  ad to bucket in 
-000325b0: 616c 6c20 4157 5320 7333 2072 6567 696f  all AWS s3 regio
-000325c0: 6e73 0a20 2020 2020 2020 2023 2054 6f20  ns.        # To 
-000325d0: 7465 7374 2066 756c 6c20 6675 6e63 7469  test full functi
-000325e0: 6f6e 616c 6974 792c 2075 7365 2074 6573  onality, use tes
-000325f0: 745f 7370 6f74 5f73 746f 7261 6765 2061  t_spot_storage a
-00032600: 626f 7665 2e0a 2020 2020 2020 2020 7374  bove..        st
-00032610: 6f72 655f 7479 7065 203d 2073 746f 7261  ore_type = stora
-00032620: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
-00032630: 2e53 330a 2020 2020 2020 2020 746d 705f  .S3.        tmp_
-00032640: 6c6f 6361 6c5f 7374 6f72 6167 655f 6f62  local_storage_ob
-00032650: 6a2e 6164 645f 7374 6f72 6528 7374 6f72  j.add_store(stor
-00032660: 655f 7479 7065 2c20 7265 6769 6f6e 3d72  e_type, region=r
-00032670: 6567 696f 6e29 0a20 2020 2020 2020 2062  egion).        b
-00032680: 7563 6b65 745f 6e61 6d65 203d 2074 6d70  ucket_name = tmp
-00032690: 5f6c 6f63 616c 5f73 746f 7261 6765 5f6f  _local_storage_o
-000326a0: 626a 2e6e 616d 650a 0a20 2020 2020 2020  bj.name..       
-000326b0: 2023 2043 6f6e 6669 726d 2074 6861 7420   # Confirm that 
-000326c0: 7468 6520 6275 636b 6574 2077 6173 2063  the bucket was c
-000326d0: 7265 6174 6564 2069 6e20 7468 6520 636f  reated in the co
-000326e0: 7272 6563 7420 7265 6769 6f6e 0a20 2020  rrect region.   
-000326f0: 2020 2020 2072 6567 696f 6e5f 636d 6420       region_cmd 
-00032700: 3d20 7365 6c66 2e63 6c69 5f72 6567 696f  = self.cli_regio
-00032710: 6e5f 636d 6428 7374 6f72 655f 7479 7065  n_cmd(store_type
-00032720: 2c20 6275 636b 6574 5f6e 616d 6529 0a20  , bucket_name). 
-00032730: 2020 2020 2020 206f 7574 203d 2073 7562         out = sub
-00032740: 7072 6f63 6573 732e 6368 6563 6b5f 6f75  process.check_ou
-00032750: 7470 7574 2872 6567 696f 6e5f 636d 642c  tput(region_cmd,
-00032760: 2073 6865 6c6c 3d54 7275 6529 0a20 2020   shell=True).   
-00032770: 2020 2020 206f 7574 7075 7420 3d20 6f75       output = ou
-00032780: 742e 6465 636f 6465 2827 7574 662d 3827  t.decode('utf-8'
-00032790: 290a 2020 2020 2020 2020 6578 7065 6374  ).        expect
-000327a0: 6564 5f6f 7574 7075 745f 7265 6769 6f6e  ed_output_region
-000327b0: 203d 2072 6567 696f 6e0a 2020 2020 2020   = region.      
-000327c0: 2020 6966 2072 6567 696f 6e20 3d3d 2027    if region == '
-000327d0: 7573 2d65 6173 742d 3127 3a0a 2020 2020  us-east-1':.    
-000327e0: 2020 2020 2020 2020 6578 7065 6374 6564          expected
-000327f0: 5f6f 7574 7075 745f 7265 6769 6f6e 203d  _output_region =
-00032800: 2027 4e6f 6e65 2720 2023 2075 732d 6561   'None'  # us-ea
-00032810: 7374 2d31 2069 7320 7468 6520 6465 6661  st-1 is the defa
-00032820: 756c 7420 7265 6769 6f6e 0a20 2020 2020  ult region.     
-00032830: 2020 2061 7373 6572 7420 6578 7065 6374     assert expect
-00032840: 6564 5f6f 7574 7075 745f 7265 6769 6f6e  ed_output_region
-00032850: 2069 6e20 6f75 742e 6465 636f 6465 2827   in out.decode('
-00032860: 7574 662d 3827 292c 2028 0a20 2020 2020  utf-8'), (.     
-00032870: 2020 2020 2020 2066 2742 7563 6b65 7420         f'Bucket 
-00032880: 7761 7320 6e6f 7420 666f 756e 6420 696e  was not found in
-00032890: 2072 6567 696f 6e20 7b72 6567 696f 6e7d   region {region}
-000328a0: 202d 2027 0a20 2020 2020 2020 2020 2020   - '.           
-000328b0: 2066 276f 7574 7075 7420 6f66 207b 7265   f'output of {re
-000328c0: 6769 6f6e 5f63 6d64 7d20 7761 733a 207b  gion_cmd} was: {
-000328d0: 6f75 7470 7574 7d27 290a 0a20 2020 2020  output}')..     
-000328e0: 2020 2023 2043 6865 636b 2069 6620 746d     # Check if tm
-000328f0: 705f 736f 7572 6365 2f74 6d70 2d66 696c  p_source/tmp-fil
-00032900: 6520 6578 6973 7473 2069 6e20 7468 6520  e exists in the 
-00032910: 6275 636b 6574 2075 7369 6e67 2063 6c69  bucket using cli
-00032920: 0a20 2020 2020 2020 206c 735f 636d 6420  .        ls_cmd 
-00032930: 3d20 7365 6c66 2e63 6c69 5f6c 735f 636d  = self.cli_ls_cm
-00032940: 6428 7374 6f72 655f 7479 7065 2c20 6275  d(store_type, bu
-00032950: 636b 6574 5f6e 616d 6529 0a20 2020 2020  cket_name).     
-00032960: 2020 206f 7574 203d 2073 7562 7072 6f63     out = subproc
-00032970: 6573 732e 6368 6563 6b5f 6f75 7470 7574  ess.check_output
-00032980: 286c 735f 636d 642c 2073 6865 6c6c 3d54  (ls_cmd, shell=T
-00032990: 7275 6529 0a20 2020 2020 2020 206f 7574  rue).        out
-000329a0: 7075 7420 3d20 6f75 742e 6465 636f 6465  put = out.decode
-000329b0: 2827 7574 662d 3827 290a 2020 2020 2020  ('utf-8').      
-000329c0: 2020 6173 7365 7274 2027 746d 702d 6669    assert 'tmp-fi
-000329d0: 6c65 2720 696e 206f 7574 7075 742c 2028  le' in output, (
-000329e0: 0a20 2020 2020 2020 2020 2020 2066 2774  .            f't
-000329f0: 6d70 2d66 696c 6520 6e6f 7420 666f 756e  mp-file not foun
-00032a00: 6420 696e 2062 7563 6b65 7420 2d20 6f75  d in bucket - ou
-00032a10: 7470 7574 206f 6620 7b6c 735f 636d 647d  tput of {ls_cmd}
-00032a20: 2077 6173 3a20 7b6f 7574 7075 747d 2729   was: {output}')
-00032a30: 0a0a 2020 2020 4070 7974 6573 742e 6d61  ..    @pytest.ma
-00032a40: 726b 2e6e 6f5f 666c 7569 6473 7461 636b  rk.no_fluidstack
-00032a50: 0a20 2020 2040 7079 7465 7374 2e6d 6172  .    @pytest.mar
-00032a60: 6b2e 7061 7261 6d65 7472 697a 6528 2772  k.parametrize('r
-00032a70: 6567 696f 6e27 2c20 5b0a 2020 2020 2020  egion', [.      
-00032a80: 2020 276e 6f72 7468 616d 6572 6963 612d    'northamerica-
-00032a90: 6e6f 7274 6865 6173 7431 272c 2027 6e6f  northeast1', 'no
-00032aa0: 7274 6861 6d65 7269 6361 2d6e 6f72 7468  rthamerica-north
-00032ab0: 6561 7374 3227 2c20 2775 732d 6365 6e74  east2', 'us-cent
-00032ac0: 7261 6c31 272c 0a20 2020 2020 2020 2027  ral1',.        '
-00032ad0: 7573 2d65 6173 7431 272c 2027 7573 2d65  us-east1', 'us-e
-00032ae0: 6173 7434 272c 2027 7573 2d65 6173 7435  ast4', 'us-east5
-00032af0: 272c 2027 7573 2d73 6f75 7468 3127 2c20  ', 'us-south1', 
-00032b00: 2775 732d 7765 7374 3127 2c20 2775 732d  'us-west1', 'us-
-00032b10: 7765 7374 3227 2c0a 2020 2020 2020 2020  west2',.        
-00032b20: 2775 732d 7765 7374 3327 2c20 2775 732d  'us-west3', 'us-
-00032b30: 7765 7374 3427 2c20 2773 6f75 7468 616d  west4', 'southam
-00032b40: 6572 6963 612d 6561 7374 3127 2c20 2773  erica-east1', 's
-00032b50: 6f75 7468 616d 6572 6963 612d 7765 7374  outhamerica-west
-00032b60: 3127 2c0a 2020 2020 2020 2020 2765 7572  1',.        'eur
-00032b70: 6f70 652d 6365 6e74 7261 6c32 272c 2027  ope-central2', '
-00032b80: 6575 726f 7065 2d6e 6f72 7468 3127 2c20  europe-north1', 
-00032b90: 2765 7572 6f70 652d 736f 7574 6877 6573  'europe-southwes
-00032ba0: 7431 272c 2027 6575 726f 7065 2d77 6573  t1', 'europe-wes
-00032bb0: 7431 272c 0a20 2020 2020 2020 2027 6575  t1',.        'eu
-00032bc0: 726f 7065 2d77 6573 7432 272c 2027 6575  rope-west2', 'eu
-00032bd0: 726f 7065 2d77 6573 7433 272c 2027 6575  rope-west3', 'eu
-00032be0: 726f 7065 2d77 6573 7434 272c 2027 6575  rope-west4', 'eu
-00032bf0: 726f 7065 2d77 6573 7436 272c 0a20 2020  rope-west6',.   
-00032c00: 2020 2020 2027 6575 726f 7065 2d77 6573       'europe-wes
-00032c10: 7438 272c 2027 6575 726f 7065 2d77 6573  t8', 'europe-wes
-00032c20: 7439 272c 2027 6575 726f 7065 2d77 6573  t9', 'europe-wes
-00032c30: 7431 3027 2c20 2765 7572 6f70 652d 7765  t10', 'europe-we
-00032c40: 7374 3132 272c 0a20 2020 2020 2020 2027  st12',.        '
-00032c50: 6173 6961 2d65 6173 7431 272c 2027 6173  asia-east1', 'as
-00032c60: 6961 2d65 6173 7432 272c 2027 6173 6961  ia-east2', 'asia
-00032c70: 2d6e 6f72 7468 6561 7374 3127 2c20 2761  -northeast1', 'a
-00032c80: 7369 612d 6e6f 7274 6865 6173 7432 272c  sia-northeast2',
-00032c90: 0a20 2020 2020 2020 2027 6173 6961 2d6e  .        'asia-n
-00032ca0: 6f72 7468 6561 7374 3327 2c20 2761 7369  ortheast3', 'asi
-00032cb0: 612d 736f 7574 6865 6173 7431 272c 2027  a-southeast1', '
-00032cc0: 6173 6961 2d73 6f75 7468 3127 2c20 2761  asia-south1', 'a
-00032cd0: 7369 612d 736f 7574 6832 272c 0a20 2020  sia-south2',.   
-00032ce0: 2020 2020 2027 6173 6961 2d73 6f75 7468       'asia-south
-00032cf0: 6561 7374 3227 2c20 276d 652d 6365 6e74  east2', 'me-cent
-00032d00: 7261 6c31 272c 2027 6d65 2d63 656e 7472  ral1', 'me-centr
-00032d10: 616c 3227 2c20 276d 652d 7765 7374 3127  al2', 'me-west1'
-00032d20: 2c0a 2020 2020 2020 2020 2761 7573 7472  ,.        'austr
-00032d30: 616c 6961 2d73 6f75 7468 6561 7374 3127  alia-southeast1'
-00032d40: 2c20 2761 7573 7472 616c 6961 2d73 6f75  , 'australia-sou
-00032d50: 7468 6561 7374 3227 2c20 2761 6672 6963  theast2', 'afric
-00032d60: 612d 736f 7574 6831 270a 2020 2020 5d29  a-south1'.    ])
-00032d70: 0a20 2020 2064 6566 2074 6573 745f 6763  .    def test_gc
-00032d80: 735f 7265 6769 6f6e 7328 7365 6c66 2c20  s_regions(self, 
-00032d90: 746d 705f 6c6f 6361 6c5f 7374 6f72 6167  tmp_local_storag
-00032da0: 655f 6f62 6a2c 2072 6567 696f 6e29 3a0a  e_obj, region):.
-00032db0: 2020 2020 2020 2020 2320 5468 6973 2074          # This t
-00032dc0: 6573 7473 2063 7265 6174 696f 6e20 616e  ests creation an
-00032dd0: 6420 7570 6c6f 6164 2074 6f20 6275 636b  d upload to buck
-00032de0: 6574 2069 6e20 616c 6c20 4743 5320 7265  et in all GCS re
-00032df0: 6769 6f6e 730a 2020 2020 2020 2020 2320  gions.        # 
-00032e00: 546f 2074 6573 7420 6675 6c6c 2066 756e  To test full fun
-00032e10: 6374 696f 6e61 6c69 7479 2c20 7573 6520  ctionality, use 
-00032e20: 7465 7374 5f73 706f 745f 7374 6f72 6167  test_spot_storag
-00032e30: 6520 6162 6f76 652e 0a20 2020 2020 2020  e above..       
-00032e40: 2073 746f 7265 5f74 7970 6520 3d20 7374   store_type = st
-00032e50: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
-00032e60: 7970 652e 4743 530a 2020 2020 2020 2020  ype.GCS.        
-00032e70: 746d 705f 6c6f 6361 6c5f 7374 6f72 6167  tmp_local_storag
-00032e80: 655f 6f62 6a2e 6164 645f 7374 6f72 6528  e_obj.add_store(
-00032e90: 7374 6f72 655f 7479 7065 2c20 7265 6769  store_type, regi
-00032ea0: 6f6e 3d72 6567 696f 6e29 0a20 2020 2020  on=region).     
-00032eb0: 2020 2062 7563 6b65 745f 6e61 6d65 203d     bucket_name =
-00032ec0: 2074 6d70 5f6c 6f63 616c 5f73 746f 7261   tmp_local_stora
-00032ed0: 6765 5f6f 626a 2e6e 616d 650a 0a20 2020  ge_obj.name..   
-00032ee0: 2020 2020 2023 2043 6f6e 6669 726d 2074       # Confirm t
-00032ef0: 6861 7420 7468 6520 6275 636b 6574 2077  hat the bucket w
-00032f00: 6173 2063 7265 6174 6564 2069 6e20 7468  as created in th
-00032f10: 6520 636f 7272 6563 7420 7265 6769 6f6e  e correct region
-00032f20: 0a20 2020 2020 2020 2072 6567 696f 6e5f  .        region_
-00032f30: 636d 6420 3d20 7365 6c66 2e63 6c69 5f72  cmd = self.cli_r
-00032f40: 6567 696f 6e5f 636d 6428 7374 6f72 655f  egion_cmd(store_
-00032f50: 7479 7065 2c20 6275 636b 6574 5f6e 616d  type, bucket_nam
-00032f60: 6529 0a20 2020 2020 2020 206f 7574 203d  e).        out =
-00032f70: 2073 7562 7072 6f63 6573 732e 6368 6563   subprocess.chec
-00032f80: 6b5f 6f75 7470 7574 2872 6567 696f 6e5f  k_output(region_
-00032f90: 636d 642c 2073 6865 6c6c 3d54 7275 6529  cmd, shell=True)
-00032fa0: 0a20 2020 2020 2020 206f 7574 7075 7420  .        output 
-00032fb0: 3d20 6f75 742e 6465 636f 6465 2827 7574  = out.decode('ut
-00032fc0: 662d 3827 290a 2020 2020 2020 2020 6173  f-8').        as
-00032fd0: 7365 7274 2072 6567 696f 6e20 696e 206f  sert region in o
-00032fe0: 7574 2e64 6563 6f64 6528 2775 7466 2d38  ut.decode('utf-8
-00032ff0: 2729 2c20 280a 2020 2020 2020 2020 2020  '), (.          
-00033000: 2020 6627 4275 636b 6574 2077 6173 206e    f'Bucket was n
-00033010: 6f74 2066 6f75 6e64 2069 6e20 7265 6769  ot found in regi
-00033020: 6f6e 207b 7265 6769 6f6e 7d20 2d20 270a  on {region} - '.
-00033030: 2020 2020 2020 2020 2020 2020 6627 6f75              f'ou
-00033040: 7470 7574 206f 6620 7b72 6567 696f 6e5f  tput of {region_
-00033050: 636d 647d 2077 6173 3a20 7b6f 7574 7075  cmd} was: {outpu
-00033060: 747d 2729 0a0a 2020 2020 2020 2020 2320  t}')..        # 
-00033070: 4368 6563 6b20 6966 2074 6d70 5f73 6f75  Check if tmp_sou
-00033080: 7263 652f 746d 702d 6669 6c65 2065 7869  rce/tmp-file exi
-00033090: 7374 7320 696e 2074 6865 2062 7563 6b65  sts in the bucke
-000330a0: 7420 7573 696e 6720 636c 690a 2020 2020  t using cli.    
-000330b0: 2020 2020 6c73 5f63 6d64 203d 2073 656c      ls_cmd = sel
-000330c0: 662e 636c 695f 6c73 5f63 6d64 2873 746f  f.cli_ls_cmd(sto
-000330d0: 7265 5f74 7970 652c 2062 7563 6b65 745f  re_type, bucket_
-000330e0: 6e61 6d65 290a 2020 2020 2020 2020 6f75  name).        ou
-000330f0: 7420 3d20 7375 6270 726f 6365 7373 2e63  t = subprocess.c
-00033100: 6865 636b 5f6f 7574 7075 7428 6c73 5f63  heck_output(ls_c
-00033110: 6d64 2c20 7368 656c 6c3d 5472 7565 290a  md, shell=True).
-00033120: 2020 2020 2020 2020 6f75 7470 7574 203d          output =
-00033130: 206f 7574 2e64 6563 6f64 6528 2775 7466   out.decode('utf
-00033140: 2d38 2729 0a20 2020 2020 2020 2061 7373  -8').        ass
-00033150: 6572 7420 2774 6d70 2d66 696c 6527 2069  ert 'tmp-file' i
-00033160: 6e20 6f75 7470 7574 2c20 280a 2020 2020  n output, (.    
-00033170: 2020 2020 2020 2020 6627 746d 702d 6669          f'tmp-fi
-00033180: 6c65 206e 6f74 2066 6f75 6e64 2069 6e20  le not found in 
-00033190: 6275 636b 6574 202d 206f 7574 7075 7420  bucket - output 
-000331a0: 6f66 207b 6c73 5f63 6d64 7d20 7761 733a  of {ls_cmd} was:
-000331b0: 207b 6f75 7470 7574 7d27 290a 0a0a 2320   {output}')...# 
-000331c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2054 6573 7469  ---------- Testi
-000331d0: 6e67 2059 414d 4c20 5370 6563 7320 2d2d  ng YAML Specs --
-000331e0: 2d2d 2d2d 2d2d 2d2d 0a23 204f 7572 2073  --------.# Our s
-000331f0: 6b79 2073 746f 7261 6765 2072 6571 7569  ky storage requi
-00033200: 7265 7320 6372 6564 656e 7469 616c 7320  res credentials 
-00033210: 746f 2063 6865 636b 2074 6865 2062 7563  to check the buc
-00033220: 6b65 7420 6578 6973 7461 6e63 6520 7768  ket existance wh
-00033230: 656e 0a23 206c 6f61 6469 6e67 2061 2074  en.# loading a t
-00033240: 6173 6b20 6672 6f6d 2074 6865 2079 616d  ask from the yam
-00033250: 6c20 6669 6c65 2c20 736f 2077 6520 6361  l file, so we ca
-00033260: 6e6e 6f74 206d 616b 6520 6974 2061 2075  nnot make it a u
-00033270: 6e69 7420 7465 7374 2e0a 636c 6173 7320  nit test..class 
-00033280: 5465 7374 5961 6d6c 5370 6563 733a 0a20  TestYamlSpecs:. 
-00033290: 2020 2023 2054 4f44 4f28 7a68 7775 293a     # TODO(zhwu):
-000332a0: 2041 6464 2074 6573 7420 666f 7220 6074   Add test for `t
-000332b0: 6f5f 7961 6d6c 5f63 6f6e 6669 6760 2066  o_yaml_config` f
-000332c0: 6f72 2074 6865 2053 746f 7261 6765 206f  or the Storage o
-000332d0: 626a 6563 742e 0a20 2020 2023 2020 5765  bject..    #  We
-000332e0: 2073 686f 756c 6420 6e6f 7420 7573 6520   should not use 
-000332f0: 6065 7861 6d70 6c65 732f 7374 6f72 6167  `examples/storag
-00033300: 655f 6465 6d6f 2e79 616d 6c60 2068 6572  e_demo.yaml` her
-00033310: 652c 2073 696e 6365 2069 7420 7265 7175  e, since it requ
-00033320: 6972 6573 0a20 2020 2023 2020 7573 6572  ires.    #  user
-00033330: 7320 746f 2065 6e73 7572 6520 6275 636b  s to ensure buck
-00033340: 6574 206e 616d 6573 2074 6f20 6e6f 7420  et names to not 
-00033350: 6578 6973 7420 616e 642f 6f72 2062 6520  exist and/or be 
-00033360: 756e 6971 7565 2e0a 2020 2020 5f54 4553  unique..    _TES
-00033370: 545f 5941 4d4c 5f50 4154 4853 203d 205b  T_YAML_PATHS = [
-00033380: 0a20 2020 2020 2020 2027 6578 616d 706c  .        'exampl
-00033390: 6573 2f6d 696e 696d 616c 2e79 616d 6c27  es/minimal.yaml'
-000333a0: 2c20 2765 7861 6d70 6c65 732f 6d61 6e61  , 'examples/mana
-000333b0: 6765 645f 7370 6f74 2e79 616d 6c27 2c0a  ged_spot.yaml',.
-000333c0: 2020 2020 2020 2020 2765 7861 6d70 6c65          'example
-000333d0: 732f 7573 696e 675f 6669 6c65 5f6d 6f75  s/using_file_mou
-000333e0: 6e74 732e 7961 6d6c 272c 2027 6578 616d  nts.yaml', 'exam
-000333f0: 706c 6573 2f72 6573 6e65 745f 6170 702e  ples/resnet_app.
-00033400: 7961 6d6c 272c 0a20 2020 2020 2020 2027  yaml',.        '
-00033410: 6578 616d 706c 6573 2f6d 756c 7469 5f68  examples/multi_h
-00033420: 6f73 746e 616d 652e 7961 6d6c 270a 2020  ostname.yaml'.  
-00033430: 2020 5d0a 0a20 2020 2064 6566 205f 6973    ]..    def _is
-00033440: 5f64 6963 745f 7375 6273 6574 2873 656c  _dict_subset(sel
-00033450: 662c 2064 312c 2064 3229 3a0a 2020 2020  f, d1, d2):.    
-00033460: 2020 2020 2222 2243 6865 636b 2069 6620      """Check if 
-00033470: 6431 2069 7320 7468 6520 7375 6273 6574  d1 is the subset
-00033480: 206f 6620 6432 2e22 2222 0a20 2020 2020   of d2.""".     
-00033490: 2020 2066 6f72 206b 2c20 7620 696e 2064     for k, v in d
-000334a0: 312e 6974 656d 7328 293a 0a20 2020 2020  1.items():.     
-000334b0: 2020 2020 2020 2069 6620 6b20 6e6f 7420         if k not 
-000334c0: 696e 2064 323a 0a20 2020 2020 2020 2020  in d2:.         
-000334d0: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
-000334e0: 616e 6365 2876 2c20 6c69 7374 2920 6f72  ance(v, list) or
-000334f0: 2069 7369 6e73 7461 6e63 6528 762c 2064   isinstance(v, d
-00033500: 6963 7429 3a0a 2020 2020 2020 2020 2020  ict):.          
-00033510: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00033520: 206c 656e 2876 2920 3d3d 2030 2c20 286b   len(v) == 0, (k
-00033530: 2c20 7629 0a20 2020 2020 2020 2020 2020  , v).           
-00033540: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00033550: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00033560: 7373 6572 7420 4661 6c73 652c 2028 6b2c  ssert False, (k,
-00033570: 2076 290a 2020 2020 2020 2020 2020 2020   v).            
-00033580: 656c 6966 2069 7369 6e73 7461 6e63 6528  elif isinstance(
-00033590: 762c 2064 6963 7429 3a0a 2020 2020 2020  v, dict):.      
-000335a0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-000335b0: 2069 7369 6e73 7461 6e63 6528 6432 5b6b   isinstance(d2[k
-000335c0: 5d2c 2064 6963 7429 2c20 286b 2c20 762c  ], dict), (k, v,
-000335d0: 2064 3229 0a20 2020 2020 2020 2020 2020   d2).           
-000335e0: 2020 2020 2073 656c 662e 5f69 735f 6469       self._is_di
-000335f0: 6374 5f73 7562 7365 7428 762c 2064 325b  ct_subset(v, d2[
-00033600: 6b5d 290a 2020 2020 2020 2020 2020 2020  k]).            
-00033610: 656c 6966 2069 7369 6e73 7461 6e63 6528  elif isinstance(
-00033620: 762c 2073 7472 293a 0a20 2020 2020 2020  v, str):.       
-00033630: 2020 2020 2020 2020 2069 6620 6b20 3d3d           if k ==
-00033640: 2027 6163 6365 6c65 7261 746f 7273 273a   'accelerators':
-00033650: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00033660: 2020 2020 2072 6573 6f75 7263 6573 203d       resources =
-00033670: 2073 6b79 2e52 6573 6f75 7263 6573 2829   sky.Resources()
-00033680: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00033690: 2020 2020 2072 6573 6f75 7263 6573 2e5f       resources._
-000336a0: 7365 745f 6163 6365 6c65 7261 746f 7273  set_accelerators
-000336b0: 2876 2c20 4e6f 6e65 290a 2020 2020 2020  (v, None).      
-000336c0: 2020 2020 2020 2020 2020 2020 2020 6173                as
-000336d0: 7365 7274 2072 6573 6f75 7263 6573 2e61  sert resources.a
-000336e0: 6363 656c 6572 6174 6f72 7320 3d3d 2064  ccelerators == d
-000336f0: 325b 6b5d 2c20 286b 2c20 762c 2064 3229  2[k], (k, v, d2)
-00033700: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00033710: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00033720: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00033730: 7420 762e 6c6f 7765 7228 2920 3d3d 2064  t v.lower() == d
-00033740: 325b 6b5d 2e6c 6f77 6572 2829 2c20 286b  2[k].lower(), (k
-00033750: 2c20 762c 2064 325b 6b5d 290a 2020 2020  , v, d2[k]).    
-00033760: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00033770: 2020 2020 2020 2020 2020 2020 2020 6173                as
-00033780: 7365 7274 2076 203d 3d20 6432 5b6b 5d2c  sert v == d2[k],
-00033790: 2028 6b2c 2076 2c20 6432 5b6b 5d29 0a0a   (k, v, d2[k])..
-000337a0: 2020 2020 6465 6620 5f63 6865 636b 5f65      def _check_e
-000337b0: 7175 6976 616c 656e 7428 7365 6c66 2c20  quivalent(self, 
-000337c0: 7961 6d6c 5f70 6174 6829 3a0a 2020 2020  yaml_path):.    
-000337d0: 2020 2020 2222 2243 6865 636b 2069 6620      """Check if 
-000337e0: 7468 6520 7961 6d6c 2069 7320 6571 7569  the yaml is equi
-000337f0: 7661 6c65 6e74 2061 6674 6572 206c 6f61  valent after loa
-00033800: 6420 616e 6420 6475 6d70 2061 6761 696e  d and dump again
-00033810: 2e22 2222 0a20 2020 2020 2020 206f 7269  .""".        ori
-00033820: 6769 6e5f 7461 736b 5f63 6f6e 6669 6720  gin_task_config 
-00033830: 3d20 636f 6d6d 6f6e 5f75 7469 6c73 2e72  = common_utils.r
-00033840: 6561 645f 7961 6d6c 2879 616d 6c5f 7061  ead_yaml(yaml_pa
-00033850: 7468 290a 0a20 2020 2020 2020 2074 6173  th)..        tas
-00033860: 6b20 3d20 736b 792e 5461 736b 2e66 726f  k = sky.Task.fro
-00033870: 6d5f 7961 6d6c 2879 616d 6c5f 7061 7468  m_yaml(yaml_path
-00033880: 290a 2020 2020 2020 2020 6e65 775f 7461  ).        new_ta
-00033890: 736b 5f63 6f6e 6669 6720 3d20 7461 736b  sk_config = task
-000338a0: 2e74 6f5f 7961 6d6c 5f63 6f6e 6669 6728  .to_yaml_config(
-000338b0: 290a 2020 2020 2020 2020 2320 6431 203c  ).        # d1 <
-000338c0: 3d20 6432 0a20 2020 2020 2020 2070 7269  = d2.        pri
-000338d0: 6e74 286f 7269 6769 6e5f 7461 736b 5f63  nt(origin_task_c
-000338e0: 6f6e 6669 672c 206e 6577 5f74 6173 6b5f  onfig, new_task_
-000338f0: 636f 6e66 6967 290a 2020 2020 2020 2020  config).        
-00033900: 7365 6c66 2e5f 6973 5f64 6963 745f 7375  self._is_dict_su
-00033910: 6273 6574 286f 7269 6769 6e5f 7461 736b  bset(origin_task
-00033920: 5f63 6f6e 6669 672c 206e 6577 5f74 6173  _config, new_tas
-00033930: 6b5f 636f 6e66 6967 290a 0a20 2020 2064  k_config)..    d
-00033940: 6566 2074 6573 745f 6c6f 6164 5f64 756d  ef test_load_dum
-00033950: 705f 7961 6d6c 5f63 6f6e 6669 675f 6571  p_yaml_config_eq
-00033960: 7569 7661 6c65 6e74 2873 656c 6629 3a0a  uivalent(self):.
-00033970: 2020 2020 2020 2020 2222 2254 6573 7420          """Test 
-00033980: 6966 2074 6865 2079 616d 6c20 636f 6e66  if the yaml conf
-00033990: 6967 2069 7320 6571 7569 7661 6c65 6e74  ig is equivalent
-000339a0: 2061 6674 6572 206c 6f61 6420 616e 6420   after load and 
-000339b0: 6475 6d70 2061 6761 696e 2e22 2222 0a20  dump again.""". 
-000339c0: 2020 2020 2020 2070 6174 686c 6962 2e50         pathlib.P
-000339d0: 6174 6828 277e 2f64 6174 6173 6574 7327  ath('~/datasets'
-000339e0: 292e 6578 7061 6e64 7573 6572 2829 2e6d  ).expanduser().m
-000339f0: 6b64 6972 2865 7869 7374 5f6f 6b3d 5472  kdir(exist_ok=Tr
-00033a00: 7565 290a 2020 2020 2020 2020 7061 7468  ue).        path
-00033a10: 6c69 622e 5061 7468 2827 7e2f 746d 7066  lib.Path('~/tmpf
-00033a20: 696c 6527 292e 6578 7061 6e64 7573 6572  ile').expanduser
-00033a30: 2829 2e74 6f75 6368 2829 0a20 2020 2020  ().touch().     
-00033a40: 2020 2070 6174 686c 6962 2e50 6174 6828     pathlib.Path(
-00033a50: 277e 2f2e 7373 6827 292e 6578 7061 6e64  '~/.ssh').expand
-00033a60: 7573 6572 2829 2e6d 6b64 6972 2865 7869  user().mkdir(exi
-00033a70: 7374 5f6f 6b3d 5472 7565 290a 2020 2020  st_ok=True).    
-00033a80: 2020 2020 7061 7468 6c69 622e 5061 7468      pathlib.Path
-00033a90: 2827 7e2f 2e73 7368 2f69 645f 7273 612e  ('~/.ssh/id_rsa.
-00033aa0: 7075 6227 292e 6578 7061 6e64 7573 6572  pub').expanduser
-00033ab0: 2829 2e74 6f75 6368 2829 0a20 2020 2020  ().touch().     
-00033ac0: 2020 2070 6174 686c 6962 2e50 6174 6828     pathlib.Path(
-00033ad0: 277e 2f74 6d70 2d77 6f72 6b64 6972 2729  '~/tmp-workdir')
-00033ae0: 2e65 7870 616e 6475 7365 7228 292e 6d6b  .expanduser().mk
-00033af0: 6469 7228 6578 6973 745f 6f6b 3d54 7275  dir(exist_ok=Tru
-00033b00: 6529 0a20 2020 2020 2020 2070 6174 686c  e).        pathl
-00033b10: 6962 2e50 6174 6828 277e 2f44 6f77 6e6c  ib.Path('~/Downl
-00033b20: 6f61 6473 2f74 7075 2729 2e65 7870 616e  oads/tpu').expan
-00033b30: 6475 7365 7228 292e 6d6b 6469 7228 7061  duser().mkdir(pa
-00033b40: 7265 6e74 733d 5472 7565 2c0a 2020 2020  rents=True,.    
-00033b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033b80: 2020 2020 2020 2065 7869 7374 5f6f 6b3d         exist_ok=
-00033b90: 5472 7565 290a 2020 2020 2020 2020 666f  True).        fo
-00033ba0: 7220 7961 6d6c 5f70 6174 6820 696e 2073  r yaml_path in s
-00033bb0: 656c 662e 5f54 4553 545f 5941 4d4c 5f50  elf._TEST_YAML_P
-00033bc0: 4154 4853 3a0a 2020 2020 2020 2020 2020  ATHS:.          
-00033bd0: 2020 7365 6c66 2e5f 6368 6563 6b5f 6571    self._check_eq
-00033be0: 7569 7661 6c65 6e74 2879 616d 6c5f 7061  uivalent(yaml_pa
-00033bf0: 7468 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d  th)...# --------
-00033c00: 2d2d 2054 6573 7469 6e67 204d 756c 7469  -- Testing Multi
-00033c10: 706c 6520 4163 6365 6c65 7261 746f 7273  ple Accelerators
-00033c20: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974   ----------.@pyt
-00033c30: 6573 742e 6d61 726b 2e6e 6f5f 666c 7569  est.mark.no_flui
-00033c40: 6473 7461 636b 2020 2320 466c 7569 6473  dstack  # Fluids
-00033c50: 7461 636b 2064 6f65 7320 6e6f 7420 7375  tack does not su
-00033c60: 7070 6f72 7420 4b38 3020 6770 7573 2066  pport K80 gpus f
-00033c70: 6f72 206e 6f77 0a40 7079 7465 7374 2e6d  or now.@pytest.m
-00033c80: 6172 6b2e 6e6f 5f70 6170 6572 7370 6163  ark.no_paperspac
-00033c90: 6520 2023 2050 6170 6572 7370 6163 6520  e  # Paperspace 
-00033ca0: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
-00033cb0: 204b 3830 2067 7075 730a 6465 6620 7465   K80 gpus.def te
-00033cc0: 7374 5f6d 756c 7469 706c 655f 6163 6365  st_multiple_acce
-00033cd0: 6c65 7261 746f 7273 5f6f 7264 6572 6564  lerators_ordered
-00033ce0: 2829 3a0a 2020 2020 6e61 6d65 203d 205f  ():.    name = _
-00033cf0: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
-00033d00: 2829 0a20 2020 2074 6573 7420 3d20 5465  ().    test = Te
-00033d10: 7374 280a 2020 2020 2020 2020 276d 756c  st(.        'mul
-00033d20: 7469 706c 652d 6163 6365 6c65 7261 746f  tiple-accelerato
-00033d30: 7273 2d6f 7264 6572 6564 272c 0a20 2020  rs-ordered',.   
-00033d40: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
-00033d50: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
-00033d60: 2d79 202d 6320 7b6e 616d 657d 2074 6573  -y -c {name} tes
-00033d70: 7473 2f74 6573 745f 7961 6d6c 732f 7465  ts/test_yamls/te
-00033d80: 7374 5f6d 756c 7469 706c 655f 6163 6365  st_multiple_acce
-00033d90: 6c65 7261 746f 7273 5f6f 7264 6572 6564  lerators_ordered
-00033da0: 2e79 616d 6c20 7c20 6772 6570 2022 5573  .yaml | grep "Us
-00033db0: 696e 6720 7573 6572 2d73 7065 6369 6669  ing user-specifi
-00033dc0: 6564 2061 6363 656c 6572 6174 6f72 7320  ed accelerators 
-00033dd0: 6c69 7374 2227 2c0a 2020 2020 2020 2020  list"',.        
-00033de0: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
-00033df0: 6e61 6d65 7d20 3120 2d2d 7374 6174 7573  name} 1 --status
-00033e00: 272c 2020 2320 456e 7375 7265 2074 6865  ',  # Ensure the
-00033e10: 206a 6f62 2073 7563 6365 6564 6564 2e0a   job succeeded..
-00033e20: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
-00033e30: 2020 2066 2773 6b79 2064 6f77 6e20 2d79     f'sky down -y
-00033e40: 207b 6e61 6d65 7d27 2c0a 2020 2020 2020   {name}',.      
-00033e50: 2020 7469 6d65 6f75 743d 3230 202a 2036    timeout=20 * 6
-00033e60: 302c 0a20 2020 2029 0a20 2020 2072 756e  0,.    ).    run
-00033e70: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
-00033e80: 0a0a 4070 7974 6573 742e 6d61 726b 2e6e  ..@pytest.mark.n
-00033e90: 6f5f 666c 7569 6473 7461 636b 2020 2320  o_fluidstack  # 
-00033ea0: 466c 7569 6473 7461 636b 2068 6173 206c  Fluidstack has l
-00033eb0: 6f77 2061 7661 696c 6162 696c 6974 7920  ow availability 
-00033ec0: 666f 7220 5434 2047 5055 730a 4070 7974  for T4 GPUs.@pyt
-00033ed0: 6573 742e 6d61 726b 2e6e 6f5f 7061 7065  est.mark.no_pape
-00033ee0: 7273 7061 6365 2020 2320 5061 7065 7273  rspace  # Papers
-00033ef0: 7061 6365 2064 6f65 7320 6e6f 7420 7375  pace does not su
-00033f00: 7070 6f72 7420 5434 2047 5055 730a 6465  pport T4 GPUs.de
-00033f10: 6620 7465 7374 5f6d 756c 7469 706c 655f  f test_multiple_
-00033f20: 6163 6365 6c65 7261 746f 7273 5f6f 7264  accelerators_ord
-00033f30: 6572 6564 5f77 6974 685f 6465 6661 756c  ered_with_defaul
-00033f40: 7428 293a 0a20 2020 206e 616d 6520 3d20  t():.    name = 
-00033f50: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
-00033f60: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
-00033f70: 6573 7428 0a20 2020 2020 2020 2027 6d75  est(.        'mu
-00033f80: 6c74 6970 6c65 2d61 6363 656c 6572 6174  ltiple-accelerat
-00033f90: 6f72 732d 6f72 6465 7265 6427 2c0a 2020  ors-ordered',.  
-00033fa0: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
-00033fb0: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
-00033fc0: 202d 7920 2d63 207b 6e61 6d65 7d20 7465   -y -c {name} te
-00033fd0: 7374 732f 7465 7374 5f79 616d 6c73 2f74  sts/test_yamls/t
-00033fe0: 6573 745f 6d75 6c74 6970 6c65 5f61 6363  est_multiple_acc
-00033ff0: 656c 6572 6174 6f72 735f 6f72 6465 7265  elerators_ordere
-00034000: 645f 7769 7468 5f64 6566 6175 6c74 2e79  d_with_default.y
-00034010: 616d 6c20 7c20 6772 6570 2022 5573 696e  aml | grep "Usin
-00034020: 6720 7573 6572 2d73 7065 6369 6669 6564  g user-specified
-00034030: 2061 6363 656c 6572 6174 6f72 7320 6c69   accelerators li
-00034040: 7374 2227 2c0a 2020 2020 2020 2020 2020  st"',.          
-00034050: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
-00034060: 6d65 7d20 3120 2d2d 7374 6174 7573 272c  me} 1 --status',
-00034070: 2020 2320 456e 7375 7265 2074 6865 206a    # Ensure the j
-00034080: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
-00034090: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-000340a0: 7374 6174 7573 207b 6e61 6d65 7d20 7c20  status {name} | 
-000340b0: 6772 6570 2053 706f 7427 2c0a 2020 2020  grep Spot',.    
-000340c0: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
-000340d0: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
-000340e0: 6d65 7d27 2c0a 2020 2020 290a 2020 2020  me}',.    ).    
-000340f0: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-00034100: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
-00034110: 6b2e 6e6f 5f66 6c75 6964 7374 6163 6b20  k.no_fluidstack 
-00034120: 2023 2046 6c75 6964 7374 6163 6b20 6861   # Fluidstack ha
-00034130: 7320 6c6f 7720 6176 6169 6c61 6269 6c69  s low availabili
-00034140: 7479 2066 6f72 2054 3420 4750 5573 0a40  ty for T4 GPUs.@
-00034150: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f70  pytest.mark.no_p
-00034160: 6170 6572 7370 6163 6520 2023 2050 6170  aperspace  # Pap
-00034170: 6572 7370 6163 6520 646f 6573 206e 6f74  erspace does not
-00034180: 2073 7570 706f 7274 2054 3420 4750 5573   support T4 GPUs
-00034190: 0a64 6566 2074 6573 745f 6d75 6c74 6970  .def test_multip
-000341a0: 6c65 5f61 6363 656c 6572 6174 6f72 735f  le_accelerators_
-000341b0: 756e 6f72 6465 7265 6428 293a 0a20 2020  unordered():.   
-000341c0: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
-000341d0: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
-000341e0: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
-000341f0: 2020 2020 2027 6d75 6c74 6970 6c65 2d61       'multiple-a
-00034200: 6363 656c 6572 6174 6f72 732d 756e 6f72  ccelerators-unor
-00034210: 6465 7265 6427 2c0a 2020 2020 2020 2020  dered',.        
-00034220: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
-00034230: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
-00034240: 207b 6e61 6d65 7d20 7465 7374 732f 7465   {name} tests/te
-00034250: 7374 5f79 616d 6c73 2f74 6573 745f 6d75  st_yamls/test_mu
-00034260: 6c74 6970 6c65 5f61 6363 656c 6572 6174  ltiple_accelerat
-00034270: 6f72 735f 756e 6f72 6465 7265 642e 7961  ors_unordered.ya
-00034280: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
-00034290: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
-000342a0: 657d 2031 202d 2d73 7461 7475 7327 2c20  e} 1 --status', 
-000342b0: 2023 2045 6e73 7572 6520 7468 6520 6a6f   # Ensure the jo
-000342c0: 6220 7375 6363 6565 6465 642e 0a20 2020  b succeeded..   
-000342d0: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-000342e0: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
-000342f0: 616d 657d 272c 0a20 2020 2029 0a20 2020  ame}',.    ).   
-00034300: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
-00034310: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
-00034320: 726b 2e6e 6f5f 666c 7569 6473 7461 636b  rk.no_fluidstack
-00034330: 2020 2320 466c 7569 6473 7461 636b 2068    # Fluidstack h
-00034340: 6173 206c 6f77 2061 7661 696c 6162 696c  as low availabil
-00034350: 6974 7920 666f 7220 5434 2047 5055 730a  ity for T4 GPUs.
-00034360: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
-00034370: 7061 7065 7273 7061 6365 2020 2320 5061  paperspace  # Pa
-00034380: 7065 7273 7061 6365 2064 6f65 7320 6e6f  perspace does no
-00034390: 7420 7375 7070 6f72 7420 5434 2047 5055  t support T4 GPU
-000343a0: 730a 6465 6620 7465 7374 5f6d 756c 7469  s.def test_multi
-000343b0: 706c 655f 6163 6365 6c65 7261 746f 7273  ple_accelerators
-000343c0: 5f75 6e6f 7264 6572 6564 5f77 6974 685f  _unordered_with_
-000343d0: 6465 6661 756c 7428 293a 0a20 2020 206e  default():.    n
-000343e0: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
-000343f0: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
-00034400: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
-00034410: 2020 2027 6d75 6c74 6970 6c65 2d61 6363     'multiple-acc
-00034420: 656c 6572 6174 6f72 732d 756e 6f72 6465  elerators-unorde
-00034430: 7265 6427 2c0a 2020 2020 2020 2020 5b0a  red',.        [.
-00034440: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00034450: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
-00034460: 6e61 6d65 7d20 7465 7374 732f 7465 7374  name} tests/test
-00034470: 5f79 616d 6c73 2f74 6573 745f 6d75 6c74  _yamls/test_mult
-00034480: 6970 6c65 5f61 6363 656c 6572 6174 6f72  iple_accelerator
-00034490: 735f 756e 6f72 6465 7265 645f 7769 7468  s_unordered_with
-000344a0: 5f64 6566 6175 6c74 2e79 616d 6c27 2c0a  _default.yaml',.
-000344b0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-000344c0: 7920 6c6f 6773 207b 6e61 6d65 7d20 3120  y logs {name} 1 
-000344d0: 2d2d 7374 6174 7573 272c 2020 2320 456e  --status',  # En
-000344e0: 7375 7265 2074 6865 206a 6f62 2073 7563  sure the job suc
-000344f0: 6365 6564 6564 2e0a 2020 2020 2020 2020  ceeded..        
-00034500: 2020 2020 6627 736b 7920 7374 6174 7573      f'sky status
-00034510: 207b 6e61 6d65 7d20 7c20 6772 6570 2053   {name} | grep S
-00034520: 706f 7427 2c0a 2020 2020 2020 2020 5d2c  pot',.        ],
-00034530: 0a20 2020 2020 2020 2066 2773 6b79 2064  .        f'sky d
-00034540: 6f77 6e20 2d79 207b 6e61 6d65 7d27 2c0a  own -y {name}',.
-00034550: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
-00034560: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
-00034570: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f66  pytest.mark.no_f
-00034580: 6c75 6964 7374 6163 6b20 2023 2052 6571  luidstack  # Req
-00034590: 7569 7265 7320 6f74 6865 7220 636c 6f75  uires other clou
-000345a0: 6473 2074 6f20 6265 2065 6e61 626c 6564  ds to be enabled
-000345b0: 0a64 6566 2074 6573 745f 6d75 6c74 6970  .def test_multip
-000345c0: 6c65 5f72 6573 6f75 7263 6573 2829 3a0a  le_resources():.
-000345d0: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
-000345e0: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
-000345f0: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
-00034600: 2020 2020 2020 2020 276d 756c 7469 706c          'multipl
-00034610: 652d 7265 736f 7572 6365 7327 2c0a 2020  e-resources',.  
-00034620: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
-00034630: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
-00034640: 202d 7920 2d63 207b 6e61 6d65 7d20 7465   -y -c {name} te
-00034650: 7374 732f 7465 7374 5f79 616d 6c73 2f74  sts/test_yamls/t
-00034660: 6573 745f 6d75 6c74 6970 6c65 5f72 6573  est_multiple_res
-00034670: 6f75 7263 6573 2e79 616d 6c27 2c0a 2020  ources.yaml',.  
-00034680: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00034690: 6c6f 6773 207b 6e61 6d65 7d20 3120 2d2d  logs {name} 1 --
-000346a0: 7374 6174 7573 272c 2020 2320 456e 7375  status',  # Ensu
-000346b0: 7265 2074 6865 206a 6f62 2073 7563 6365  re the job succe
-000346c0: 6564 6564 2e0a 2020 2020 2020 2020 5d2c  eded..        ],
-000346d0: 0a20 2020 2020 2020 2066 2773 6b79 2064  .        f'sky d
-000346e0: 6f77 6e20 2d79 207b 6e61 6d65 7d27 2c0a  own -y {name}',.
-000346f0: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
-00034700: 655f 7465 7374 2874 6573 7429 0a0a 0a23  e_test(test)...#
-00034710: 202d 2d2d 2d2d 2d2d 2d2d 2d20 536b 7920   ---------- Sky 
-00034720: 4265 6e63 686d 6172 6b20 2d2d 2d2d 2d2d  Benchmark ------
-00034730: 2d2d 2d2d 0a40 7079 7465 7374 2e6d 6172  ----.@pytest.mar
-00034740: 6b2e 6e6f 5f66 6c75 6964 7374 6163 6b20  k.no_fluidstack 
-00034750: 2023 2052 6571 7569 7265 7320 6f74 6865   # Requires othe
-00034760: 7220 636c 6f75 6473 2074 6f20 6265 2065  r clouds to be e
-00034770: 6e61 626c 6564 0a40 7079 7465 7374 2e6d  nabled.@pytest.m
-00034780: 6172 6b2e 6e6f 5f70 6170 6572 7370 6163  ark.no_paperspac
-00034790: 6520 2023 2052 6571 7569 7265 7320 6f74  e  # Requires ot
-000347a0: 6865 7220 636c 6f75 6473 2074 6f20 6265  her clouds to be
-000347b0: 2065 6e61 626c 6564 0a40 7079 7465 7374   enabled.@pytest
-000347c0: 2e6d 6172 6b2e 6e6f 5f6b 7562 6572 6e65  .mark.no_kuberne
-000347d0: 7465 730a 6465 6620 7465 7374 5f73 6b79  tes.def test_sky
-000347e0: 5f62 656e 6368 2867 656e 6572 6963 5f63  _bench(generic_c
-000347f0: 6c6f 7564 3a20 7374 7229 3a0a 2020 2020  loud: str):.    
-00034800: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
-00034810: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
-00034820: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
-00034830: 2020 2020 2773 6b79 2d62 656e 6368 272c      'sky-bench',
-00034840: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
-00034850: 2020 2020 2020 2066 2773 6b79 2062 656e         f'sky ben
-00034860: 6368 206c 6175 6e63 6820 2d79 202d 6220  ch launch -y -b 
-00034870: 7b6e 616d 657d 202d 2d63 6c6f 7564 207b  {name} --cloud {
-00034880: 6765 6e65 7269 635f 636c 6f75 647d 202d  generic_cloud} -
-00034890: 6930 2074 6573 7473 2f74 6573 745f 7961  i0 tests/test_ya
-000348a0: 6d6c 732f 6d69 6e69 6d61 6c2e 7961 6d6c  mls/minimal.yaml
-000348b0: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
-000348c0: 736c 6565 7020 3132 3027 2c0a 2020 2020  sleep 120',.    
-000348d0: 2020 2020 2020 2020 6627 736b 7920 6265          f'sky be
-000348e0: 6e63 6820 7368 6f77 207b 6e61 6d65 7d20  nch show {name} 
-000348f0: 7c20 6772 6570 2073 6b79 2d62 656e 6368  | grep sky-bench
-00034900: 2d7b 6e61 6d65 7d20 7c20 6772 6570 2046  -{name} | grep F
-00034910: 494e 4953 4845 4427 2c0a 2020 2020 2020  INISHED',.      
-00034920: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
-00034930: 6b79 2062 656e 6368 2064 6f77 6e20 7b6e  ky bench down {n
-00034940: 616d 657d 202d 793b 2073 6b79 2062 656e  ame} -y; sky ben
-00034950: 6368 2064 656c 6574 6520 7b6e 616d 657d  ch delete {name}
-00034960: 202d 7927 2c0a 2020 2020 290a 2020 2020   -y',.    ).    
-00034970: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-00034980: 7429 0a                                  t).
+000310e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000310f0: 2020 2020 2020 2020 206d 6172 6b73 3d70           marks=p
+00031100: 7974 6573 742e 6d61 726b 2e63 6c6f 7564  ytest.mark.cloud
+00031110: 666c 6172 6529 5d29 0a20 2020 2064 6566  flare)]).    def
+00031120: 2074 6573 745f 696e 7661 6c69 645f 6e61   test_invalid_na
+00031130: 6d65 7328 7365 6c66 2c20 696e 7661 6c69  mes(self, invali
+00031140: 645f 6e61 6d65 5f6c 6973 742c 2073 746f  d_name_list, sto
+00031150: 7265 5f74 7970 6529 3a0a 2020 2020 2020  re_type):.      
+00031160: 2020 2320 5573 6573 2061 206c 6973 7420    # Uses a list 
+00031170: 696e 2074 6865 2073 6f75 7263 6520 6669  in the source fi
+00031180: 656c 6420 746f 2073 7065 6369 6679 2061  eld to specify a
+00031190: 2066 696c 6520 616e 6420 6120 6469 7265   file and a dire
+000311a0: 6374 6f72 7920 746f 0a20 2020 2020 2020  ctory to.       
+000311b0: 2023 2062 6520 7570 6c6f 6164 6564 2074   # be uploaded t
+000311c0: 6f20 7468 6520 7374 6f72 6167 6520 6f62  o the storage ob
+000311d0: 6a65 6374 2e0a 2020 2020 2020 2020 666f  ject..        fo
+000311e0: 7220 6e61 6d65 2069 6e20 696e 7661 6c69  r name in invali
+000311f0: 645f 6e61 6d65 5f6c 6973 743a 0a20 2020  d_name_list:.   
+00031200: 2020 2020 2020 2020 2077 6974 6820 7079           with py
+00031210: 7465 7374 2e72 6169 7365 7328 736b 792e  test.raises(sky.
+00031220: 6578 6365 7074 696f 6e73 2e53 746f 7261  exceptions.Stora
+00031230: 6765 4e61 6d65 4572 726f 7229 3a0a 2020  geNameError):.  
+00031240: 2020 2020 2020 2020 2020 2020 2020 7374                st
+00031250: 6f72 6167 655f 6f62 6a20 3d20 7374 6f72  orage_obj = stor
+00031260: 6167 655f 6c69 622e 5374 6f72 6167 6528  age_lib.Storage(
+00031270: 6e61 6d65 3d6e 616d 6529 0a20 2020 2020  name=name).     
+00031280: 2020 2020 2020 2020 2020 2073 746f 7261             stora
+00031290: 6765 5f6f 626a 2e61 6464 5f73 746f 7265  ge_obj.add_store
+000312a0: 2873 746f 7265 5f74 7970 6529 0a0a 2020  (store_type)..  
+000312b0: 2020 4070 7974 6573 742e 6d61 726b 2e6e    @pytest.mark.n
+000312c0: 6f5f 666c 7569 6473 7461 636b 0a20 2020  o_fluidstack.   
+000312d0: 2040 7079 7465 7374 2e6d 6172 6b2e 7061   @pytest.mark.pa
+000312e0: 7261 6d65 7472 697a 6528 0a20 2020 2020  rametrize(.     
+000312f0: 2020 2027 6769 7469 676e 6f72 655f 7374     'gitignore_st
+00031300: 7275 6374 7572 652c 2073 746f 7265 5f74  ructure, store_t
+00031310: 7970 6527 2c0a 2020 2020 2020 2020 5b28  ype',.        [(
+00031320: 4749 5449 474e 4f52 455f 5359 4e43 5f54  GITIGNORE_SYNC_T
+00031330: 4553 545f 4449 525f 5354 5255 4354 5552  EST_DIR_STRUCTUR
+00031340: 452c 2073 746f 7261 6765 5f6c 6962 2e53  E, storage_lib.S
+00031350: 746f 7265 5479 7065 2e53 3329 2c0a 2020  toreType.S3),.  
+00031360: 2020 2020 2020 2028 4749 5449 474e 4f52         (GITIGNOR
+00031370: 455f 5359 4e43 5f54 4553 545f 4449 525f  E_SYNC_TEST_DIR_
+00031380: 5354 5255 4354 5552 452c 2073 746f 7261  STRUCTURE, stora
+00031390: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
+000313a0: 2e47 4353 292c 0a20 2020 2020 2020 2020  .GCS),.         
+000313b0: 7079 7465 7374 2e70 6172 616d 2847 4954  pytest.param(GIT
+000313c0: 4947 4e4f 5245 5f53 594e 435f 5445 5354  IGNORE_SYNC_TEST
+000313d0: 5f44 4952 5f53 5452 5543 5455 5245 2c0a  _DIR_STRUCTURE,.
+000313e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000313f0: 2020 2020 2020 7374 6f72 6167 655f 6c69        storage_li
+00031400: 622e 5374 6f72 6554 7970 652e 5232 2c0a  b.StoreType.R2,.
+00031410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031420: 2020 2020 2020 6d61 726b 733d 7079 7465        marks=pyte
+00031430: 7374 2e6d 6172 6b2e 636c 6f75 6466 6c61  st.mark.cloudfla
+00031440: 7265 295d 290a 2020 2020 6465 6620 7465  re)]).    def te
+00031450: 7374 5f65 7863 6c75 6465 645f 6669 6c65  st_excluded_file
+00031460: 5f63 6c6f 7564 5f73 746f 7261 6765 5f75  _cloud_storage_u
+00031470: 706c 6f61 645f 636f 7079 2873 656c 662c  pload_copy(self,
+00031480: 2067 6974 6967 6e6f 7265 5f73 7472 7563   gitignore_struc
+00031490: 7475 7265 2c0a 2020 2020 2020 2020 2020  ture,.          
+000314a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000314b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000314c0: 2020 2020 2020 2020 2020 2073 746f 7265             store
+000314d0: 5f74 7970 652c 0a20 2020 2020 2020 2020  _type,.         
+000314e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000314f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031500: 2020 2020 2020 2020 2020 2020 746d 705f              tmp_
+00031510: 6769 7469 676e 6f72 655f 7374 6f72 6167  gitignore_storag
+00031520: 655f 6f62 6a29 3a0a 2020 2020 2020 2020  e_obj):.        
+00031530: 2320 7465 7374 7320 6966 2066 696c 6573  # tests if files
+00031540: 2069 6e63 6c75 6465 6420 696e 202e 6769   included in .gi
+00031550: 7469 676e 6f72 6520 616e 6420 2e67 6974  tignore and .git
+00031560: 2f69 6e66 6f2f 6578 636c 7564 6520 6172  /info/exclude ar
+00031570: 650a 2020 2020 2020 2020 2320 6578 636c  e.        # excl
+00031580: 7564 6564 2066 726f 6d20 6265 696e 6720  uded from being 
+00031590: 7472 616e 7366 6572 7265 6420 746f 2053  transferred to S
+000315a0: 746f 7261 6765 0a0a 2020 2020 2020 2020  torage..        
+000315b0: 746d 705f 6769 7469 676e 6f72 655f 7374  tmp_gitignore_st
+000315c0: 6f72 6167 655f 6f62 6a2e 6164 645f 7374  orage_obj.add_st
+000315d0: 6f72 6528 7374 6f72 655f 7479 7065 290a  ore(store_type).
+000315e0: 0a20 2020 2020 2020 2075 706c 6f61 645f  .        upload_
+000315f0: 6669 6c65 5f6e 616d 6520 3d20 2769 6e63  file_name = 'inc
+00031600: 6c75 6465 6427 0a20 2020 2020 2020 2023  luded'.        #
+00031610: 2043 6f75 6e74 2074 6865 206e 756d 6265   Count the numbe
+00031620: 7220 6f66 2066 696c 6573 2077 6974 6820  r of files with 
+00031630: 7468 6520 6769 7665 6e20 6669 6c65 206e  the given file n
+00031640: 616d 650a 2020 2020 2020 2020 7570 5f63  ame.        up_c
+00031650: 6d64 203d 2073 656c 662e 636c 695f 636f  md = self.cli_co
+00031660: 756e 745f 6e61 6d65 5f69 6e5f 6275 636b  unt_name_in_buck
+00031670: 6574 2873 746f 7265 5f74 7970 652c 205c  et(store_type, \
+00031680: 0a20 2020 2020 2020 2020 2020 2074 6d70  .            tmp
+00031690: 5f67 6974 6967 6e6f 7265 5f73 746f 7261  _gitignore_stora
+000316a0: 6765 5f6f 626a 2e6e 616d 652c 2066 696c  ge_obj.name, fil
+000316b0: 655f 6e61 6d65 3d75 706c 6f61 645f 6669  e_name=upload_fi
+000316c0: 6c65 5f6e 616d 6529 0a20 2020 2020 2020  le_name).       
+000316d0: 2067 6974 5f65 7863 6c75 6465 5f63 6d64   git_exclude_cmd
+000316e0: 203d 2073 656c 662e 636c 695f 636f 756e   = self.cli_coun
+000316f0: 745f 6e61 6d65 5f69 6e5f 6275 636b 6574  t_name_in_bucket
+00031700: 2873 746f 7265 5f74 7970 652c 205c 0a20  (store_type, \. 
+00031710: 2020 2020 2020 2020 2020 2074 6d70 5f67             tmp_g
+00031720: 6974 6967 6e6f 7265 5f73 746f 7261 6765  itignore_storage
+00031730: 5f6f 626a 2e6e 616d 652c 2066 696c 655f  _obj.name, file_
+00031740: 6e61 6d65 3d27 2e67 6974 2729 0a20 2020  name='.git').   
+00031750: 2020 2020 2063 6e74 5f6e 756d 5f66 696c       cnt_num_fil
+00031760: 655f 636d 6420 3d20 7365 6c66 2e63 6c69  e_cmd = self.cli
+00031770: 5f63 6f75 6e74 5f66 696c 655f 696e 5f62  _count_file_in_b
+00031780: 7563 6b65 7428 0a20 2020 2020 2020 2020  ucket(.         
+00031790: 2020 2073 746f 7265 5f74 7970 652c 2074     store_type, t
+000317a0: 6d70 5f67 6974 6967 6e6f 7265 5f73 746f  mp_gitignore_sto
+000317b0: 7261 6765 5f6f 626a 2e6e 616d 6529 0a0a  rage_obj.name)..
+000317c0: 2020 2020 2020 2020 7570 5f6f 7574 7075          up_outpu
+000317d0: 7420 3d20 7375 6270 726f 6365 7373 2e63  t = subprocess.c
+000317e0: 6865 636b 5f6f 7574 7075 7428 7570 5f63  heck_output(up_c
+000317f0: 6d64 2c20 7368 656c 6c3d 5472 7565 290a  md, shell=True).
+00031800: 2020 2020 2020 2020 6769 745f 6578 636c          git_excl
+00031810: 7564 655f 6f75 7470 7574 203d 2073 7562  ude_output = sub
+00031820: 7072 6f63 6573 732e 6368 6563 6b5f 6f75  process.check_ou
+00031830: 7470 7574 2867 6974 5f65 7863 6c75 6465  tput(git_exclude
+00031840: 5f63 6d64 2c0a 2020 2020 2020 2020 2020  _cmd,.          
+00031850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031870: 2020 2020 2020 2020 2020 2073 6865 6c6c             shell
+00031880: 3d54 7275 6529 0a20 2020 2020 2020 2063  =True).        c
+00031890: 6e74 5f6f 7574 7075 7420 3d20 7375 6270  nt_output = subp
+000318a0: 726f 6365 7373 2e63 6865 636b 5f6f 7574  rocess.check_out
+000318b0: 7075 7428 636e 745f 6e75 6d5f 6669 6c65  put(cnt_num_file
+000318c0: 5f63 6d64 2c20 7368 656c 6c3d 5472 7565  _cmd, shell=True
+000318d0: 290a 0a20 2020 2020 2020 2061 7373 6572  )..        asser
+000318e0: 7420 2733 2720 696e 2075 705f 6f75 7470  t '3' in up_outp
+000318f0: 7574 2e64 6563 6f64 6528 2775 7466 2d38  ut.decode('utf-8
+00031900: 2729 2c20 5c0a 2020 2020 2020 2020 2020  '), \.          
+00031910: 2020 2020 2020 2746 696c 6573 2074 6f20        'Files to 
+00031920: 6265 2069 6e63 6c75 6465 6420 6172 6520  be included are 
+00031930: 6e6f 7420 636f 6d70 6c65 7465 6c79 2075  not completely u
+00031940: 706c 6f61 6465 642e 270a 2020 2020 2020  ploaded.'.      
+00031950: 2020 2320 3120 6973 2072 6561 6420 6173    # 1 is read as
+00031960: 202e 6769 7469 676e 6f72 6520 6973 2075   .gitignore is u
+00031970: 706c 6f61 6465 640a 2020 2020 2020 2020  ploaded.        
+00031980: 6173 7365 7274 2027 3127 2069 6e20 6769  assert '1' in gi
+00031990: 745f 6578 636c 7564 655f 6f75 7470 7574  t_exclude_output
+000319a0: 2e64 6563 6f64 6528 2775 7466 2d38 2729  .decode('utf-8')
+000319b0: 2c20 5c0a 2020 2020 2020 2020 2020 2020  , \.            
+000319c0: 2020 2027 2e67 6974 2064 6972 6563 746f     '.git directo
+000319d0: 7279 2073 686f 756c 6420 6e6f 7420 6265  ry should not be
+000319e0: 2075 706c 6f61 6465 642e 270a 2020 2020   uploaded.'.    
+000319f0: 2020 2020 2320 3420 6669 6c65 7320 696e      # 4 files in
+00031a00: 636c 7564 6520 2e67 6974 6967 6e6f 7265  clude .gitignore
+00031a10: 2c20 696e 636c 7564 6564 2e6c 6f67 2c20  , included.log, 
+00031a20: 696e 636c 7564 6564 2e74 7874 2c20 696e  included.txt, in
+00031a30: 636c 7564 655f 6469 722f 696e 636c 7564  clude_dir/includ
+00031a40: 6564 2e6c 6f67 0a20 2020 2020 2020 2061  ed.log.        a
+00031a50: 7373 6572 7420 2734 2720 696e 2063 6e74  ssert '4' in cnt
+00031a60: 5f6f 7574 7075 742e 6465 636f 6465 2827  _output.decode('
+00031a70: 7574 662d 3827 292c 205c 0a20 2020 2020  utf-8'), \.     
+00031a80: 2020 2020 2020 2020 2020 2753 6f6d 6520            'Some 
+00031a90: 6974 656d 7320 6c69 7374 6564 2069 6e20  items listed in 
+00031aa0: 2e67 6974 6967 6e6f 7265 2061 6e64 202e  .gitignore and .
+00031ab0: 6769 742f 696e 666f 2f65 7863 6c75 6465  git/info/exclude
+00031ac0: 2061 7265 206e 6f74 2065 7863 6c75 6465   are not exclude
+00031ad0: 642e 270a 0a20 2020 2040 7079 7465 7374  d.'..    @pytest
+00031ae0: 2e6d 6172 6b2e 7061 7261 6d65 7472 697a  .mark.parametriz
+00031af0: 6528 2765 7874 5f62 7563 6b65 745f 6669  e('ext_bucket_fi
+00031b00: 7874 7572 652c 2073 746f 7265 5f74 7970  xture, store_typ
+00031b10: 6527 2c0a 2020 2020 2020 2020 2020 2020  e',.            
+00031b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031b30: 205b 2827 746d 705f 6177 7363 6c69 5f62   [('tmp_awscli_b
+00031b40: 7563 6b65 7427 2c20 7374 6f72 6167 655f  ucket', storage_
+00031b50: 6c69 622e 5374 6f72 6554 7970 652e 5333  lib.StoreType.S3
+00031b60: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00031b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031b80: 2028 2774 6d70 5f67 7375 7469 6c5f 6275   ('tmp_gsutil_bu
+00031b90: 636b 6574 272c 2073 746f 7261 6765 5f6c  cket', storage_l
+00031ba0: 6962 2e53 746f 7265 5479 7065 2e47 4353  ib.StoreType.GCS
+00031bb0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00031bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031bd0: 2070 7974 6573 742e 7061 7261 6d28 2774   pytest.param('t
+00031be0: 6d70 5f61 7773 636c 695f 6275 636b 6574  mp_awscli_bucket
+00031bf0: 5f72 3227 2c0a 2020 2020 2020 2020 2020  _r2',.          
+00031c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031c20: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
+00031c30: 7265 5479 7065 2e52 322c 0a20 2020 2020  reType.R2,.     
+00031c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031c60: 2020 2020 2020 6d61 726b 733d 7079 7465        marks=pyte
+00031c70: 7374 2e6d 6172 6b2e 636c 6f75 6466 6c61  st.mark.cloudfla
+00031c80: 7265 295d 290a 2020 2020 6465 6620 7465  re)]).    def te
+00031c90: 7374 5f65 7874 6572 6e61 6c6c 795f 6372  st_externally_cr
+00031ca0: 6561 7465 645f 6275 636b 6574 5f6d 6f75  eated_bucket_mou
+00031cb0: 6e74 5f77 6974 686f 7574 5f73 6f75 7263  nt_without_sourc
+00031cc0: 6528 0a20 2020 2020 2020 2020 2020 2073  e(.            s
+00031cd0: 656c 662c 2065 7874 5f62 7563 6b65 745f  elf, ext_bucket_
+00031ce0: 6669 7874 7572 652c 2072 6571 7565 7374  fixture, request
+00031cf0: 2c20 7374 6f72 655f 7479 7065 293a 0a20  , store_type):. 
+00031d00: 2020 2020 2020 2023 204e 6f6e 2d73 6b79         # Non-sky
+00031d10: 206d 616e 6167 6564 2062 7563 6b65 7473   managed buckets
+00031d20: 2862 7563 6b65 7473 2063 7265 6174 6564  (buckets created
+00031d30: 206f 7574 7369 6465 206f 6620 536b 7970   outside of Skyp
+00031d40: 696c 6f74 2043 4c49 290a 2020 2020 2020  ilot CLI).      
+00031d50: 2020 2320 6172 6520 616c 6c6f 7765 6420    # are allowed 
+00031d60: 746f 2062 6520 4d4f 554e 5465 6420 6279  to be MOUNTed by
+00031d70: 2073 7065 6369 6679 696e 6720 7468 6520   specifying the 
+00031d80: 5552 4920 6f66 2074 6865 2062 7563 6b65  URI of the bucke
+00031d90: 7420 746f 0a20 2020 2020 2020 2023 2073  t to.        # s
+00031da0: 6f75 7263 6520 6669 656c 6420 6f6e 6c79  ource field only
+00031db0: 2e20 5768 656e 2069 7420 6973 2061 7474  . When it is att
+00031dc0: 656d 7074 6564 2062 7920 7370 6563 6966  empted by specif
+00031dd0: 7969 6e67 2074 6865 206e 616d 6520 6f66  ying the name of
+00031de0: 0a20 2020 2020 2020 2023 2074 6865 2062  .        # the b
+00031df0: 7563 6b65 7420 6f6e 6c79 2c20 6974 2073  ucket only, it s
+00031e00: 686f 756c 6420 6572 726f 7220 6f75 742e  hould error out.
+00031e10: 0a20 2020 2020 2020 2023 0a20 2020 2020  .        #.     
+00031e20: 2020 2023 2054 4f44 4f28 646f 796f 756e     # TODO(doyoun
+00031e30: 6729 3a20 4164 6420 7465 7374 2066 6f72  g): Add test for
+00031e40: 2049 424d 2043 4f53 2e20 4375 7272 656e   IBM COS. Curren
+00031e50: 746c 792c 2074 6869 7320 6973 2062 6c6f  tly, this is blo
+00031e60: 636b 6564 0a20 2020 2020 2020 2023 2061  cked.        # a
+00031e70: 7320 7263 6c6f 6e65 2075 7365 6420 746f  s rclone used to
+00031e80: 2069 6e74 6572 6163 7420 7769 7468 2049   interact with I
+00031e90: 424d 2043 4f53 2064 6f65 7320 6e6f 7420  BM COS does not 
+00031ea0: 7375 7070 6f72 7420 6665 6174 7572 6520  support feature 
+00031eb0: 746f 0a20 2020 2020 2020 2023 2063 7265  to.        # cre
+00031ec0: 6174 6520 6120 6275 636b 6574 2c20 616e  ate a bucket, an
+00031ed0: 6420 7468 6520 6962 6d63 6c6f 7564 2043  d the ibmcloud C
+00031ee0: 4c49 2069 7320 6e6f 7420 7375 7070 6f72  LI is not suppor
+00031ef0: 7465 6420 696e 2053 6b79 7069 6c6f 742e  ted in Skypilot.
+00031f00: 0a20 2020 2020 2020 2023 2045 6974 6865  .        # Eithe
+00031f10: 7220 6f66 2074 6865 2066 6561 7475 7265  r of the feature
+00031f20: 2069 7320 6e65 6365 7373 6172 7920 746f   is necessary to
+00031f30: 2073 696d 756c 6174 6520 616e 2065 7874   simulate an ext
+00031f40: 6572 6e61 6c20 6275 636b 6574 0a20 2020  ernal bucket.   
+00031f50: 2020 2020 2023 2063 7265 6174 696f 6e20       # creation 
+00031f60: 666f 7220 4942 4d20 434f 532e 0a20 2020  for IBM COS..   
+00031f70: 2020 2020 2023 2068 7474 7073 3a2f 2f67       # https://g
+00031f80: 6974 6875 622e 636f 6d2f 736b 7970 696c  ithub.com/skypil
+00031f90: 6f74 2d6f 7267 2f73 6b79 7069 6c6f 742f  ot-org/skypilot/
+00031fa0: 7075 6c6c 2f31 3936 362f 6669 6c65 7323  pull/1966/files#
+00031fb0: 7231 3235 3334 3339 3833 370a 0a20 2020  r1253439837..   
+00031fc0: 2020 2020 2065 7874 5f62 7563 6b65 745f       ext_bucket_
+00031fd0: 6e61 6d65 2c20 6578 745f 6275 636b 6574  name, ext_bucket
+00031fe0: 5f75 7269 203d 2072 6571 7565 7374 2e67  _uri = request.g
+00031ff0: 6574 6669 7874 7572 6576 616c 7565 280a  etfixturevalue(.
+00032000: 2020 2020 2020 2020 2020 2020 6578 745f              ext_
+00032010: 6275 636b 6574 5f66 6978 7475 7265 290a  bucket_fixture).
+00032020: 2020 2020 2020 2020 2320 696e 7661 6c69          # invali
+00032030: 6420 7370 6563 0a20 2020 2020 2020 2077  d spec.        w
+00032040: 6974 6820 7079 7465 7374 2e72 6169 7365  ith pytest.raise
+00032050: 7328 736b 792e 6578 6365 7074 696f 6e73  s(sky.exceptions
+00032060: 2e53 746f 7261 6765 5370 6563 4572 726f  .StorageSpecErro
+00032070: 7229 2061 7320 653a 0a20 2020 2020 2020  r) as e:.       
+00032080: 2020 2020 2073 746f 7261 6765 5f6f 626a       storage_obj
+00032090: 203d 2073 746f 7261 6765 5f6c 6962 2e53   = storage_lib.S
+000320a0: 746f 7261 6765 280a 2020 2020 2020 2020  torage(.        
+000320b0: 2020 2020 2020 2020 6e61 6d65 3d65 7874          name=ext
+000320c0: 5f62 7563 6b65 745f 6e61 6d65 2c20 6d6f  _bucket_name, mo
+000320d0: 6465 3d73 746f 7261 6765 5f6c 6962 2e53  de=storage_lib.S
+000320e0: 746f 7261 6765 4d6f 6465 2e4d 4f55 4e54  torageMode.MOUNT
+000320f0: 290a 2020 2020 2020 2020 2020 2020 7374  ).            st
+00032100: 6f72 6167 655f 6f62 6a2e 6164 645f 7374  orage_obj.add_st
+00032110: 6f72 6528 7374 6f72 655f 7479 7065 290a  ore(store_type).
+00032120: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+00032130: 2741 7474 656d 7074 6564 2074 6f20 6d6f  'Attempted to mo
+00032140: 756e 7420 6120 6e6f 6e2d 736b 7920 6d61  unt a non-sky ma
+00032150: 6e61 6765 6420 6275 636b 6574 2720 696e  naged bucket' in
+00032160: 2073 7472 2865 290a 0a20 2020 2020 2020   str(e)..       
+00032170: 2023 2076 616c 6964 2073 7065 630a 2020   # valid spec.  
+00032180: 2020 2020 2020 7374 6f72 6167 655f 6f62        storage_ob
+00032190: 6a20 3d20 7374 6f72 6167 655f 6c69 622e  j = storage_lib.
+000321a0: 5374 6f72 6167 6528 736f 7572 6365 3d65  Storage(source=e
+000321b0: 7874 5f62 7563 6b65 745f 7572 692c 0a20  xt_bucket_uri,. 
+000321c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000321d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000321e0: 2020 2020 2020 2020 206d 6f64 653d 7374           mode=st
+000321f0: 6f72 6167 655f 6c69 622e 5374 6f72 6167  orage_lib.Storag
+00032200: 654d 6f64 652e 4d4f 554e 5429 0a20 2020  eMode.MOUNT).   
+00032210: 2020 2020 2068 616e 646c 6520 3d20 676c       handle = gl
+00032220: 6f62 616c 5f75 7365 725f 7374 6174 652e  obal_user_state.
+00032230: 6765 745f 6861 6e64 6c65 5f66 726f 6d5f  get_handle_from_
+00032240: 7374 6f72 6167 655f 6e61 6d65 280a 2020  storage_name(.  
+00032250: 2020 2020 2020 2020 2020 7374 6f72 6167            storag
+00032260: 655f 6f62 6a2e 6e61 6d65 290a 2020 2020  e_obj.name).    
+00032270: 2020 2020 6966 2068 616e 646c 653a 0a20      if handle:. 
+00032280: 2020 2020 2020 2020 2020 2073 746f 7261             stora
+00032290: 6765 5f6f 626a 2e64 656c 6574 6528 290a  ge_obj.delete().
+000322a0: 0a20 2020 2040 7079 7465 7374 2e6d 6172  .    @pytest.mar
+000322b0: 6b2e 6e6f 5f66 6c75 6964 7374 6163 6b0a  k.no_fluidstack.
+000322c0: 2020 2020 4070 7974 6573 742e 6d61 726b      @pytest.mark
+000322d0: 2e70 6172 616d 6574 7269 7a65 2827 7265  .parametrize('re
+000322e0: 6769 6f6e 272c 205b 0a20 2020 2020 2020  gion', [.       
+000322f0: 2027 6170 2d6e 6f72 7468 6561 7374 2d31   'ap-northeast-1
+00032300: 272c 2027 6170 2d6e 6f72 7468 6561 7374  ', 'ap-northeast
+00032310: 2d32 272c 2027 6170 2d6e 6f72 7468 6561  -2', 'ap-northea
+00032320: 7374 2d33 272c 2027 6170 2d73 6f75 7468  st-3', 'ap-south
+00032330: 2d31 272c 0a20 2020 2020 2020 2027 6170  -1',.        'ap
+00032340: 2d73 6f75 7468 6561 7374 2d31 272c 2027  -southeast-1', '
+00032350: 6170 2d73 6f75 7468 6561 7374 2d32 272c  ap-southeast-2',
+00032360: 2027 6575 2d63 656e 7472 616c 2d31 272c   'eu-central-1',
+00032370: 2027 6575 2d6e 6f72 7468 2d31 272c 0a20   'eu-north-1',. 
+00032380: 2020 2020 2020 2027 6575 2d77 6573 742d         'eu-west-
+00032390: 3127 2c20 2765 752d 7765 7374 2d32 272c  1', 'eu-west-2',
+000323a0: 2027 6575 2d77 6573 742d 3327 2c20 2773   'eu-west-3', 's
+000323b0: 612d 6561 7374 2d31 272c 2027 7573 2d65  a-east-1', 'us-e
+000323c0: 6173 742d 3127 2c0a 2020 2020 2020 2020  ast-1',.        
+000323d0: 2775 732d 6561 7374 2d32 272c 2027 7573  'us-east-2', 'us
+000323e0: 2d77 6573 742d 3127 2c20 2775 732d 7765  -west-1', 'us-we
+000323f0: 7374 2d32 270a 2020 2020 5d29 0a20 2020  st-2'.    ]).   
+00032400: 2064 6566 2074 6573 745f 6177 735f 7265   def test_aws_re
+00032410: 6769 6f6e 7328 7365 6c66 2c20 746d 705f  gions(self, tmp_
+00032420: 6c6f 6361 6c5f 7374 6f72 6167 655f 6f62  local_storage_ob
+00032430: 6a2c 2072 6567 696f 6e29 3a0a 2020 2020  j, region):.    
+00032440: 2020 2020 2320 5468 6973 2074 6573 7473      # This tests
+00032450: 2063 7265 6174 696f 6e20 616e 6420 7570   creation and up
+00032460: 6c6f 6164 2074 6f20 6275 636b 6574 2069  load to bucket i
+00032470: 6e20 616c 6c20 4157 5320 7333 2072 6567  n all AWS s3 reg
+00032480: 696f 6e73 0a20 2020 2020 2020 2023 2054  ions.        # T
+00032490: 6f20 7465 7374 2066 756c 6c20 6675 6e63  o test full func
+000324a0: 7469 6f6e 616c 6974 792c 2075 7365 2074  tionality, use t
+000324b0: 6573 745f 6d61 6e61 6765 645f 6a6f 6273  est_managed_jobs
+000324c0: 5f73 746f 7261 6765 2061 626f 7665 2e0a  _storage above..
+000324d0: 2020 2020 2020 2020 7374 6f72 655f 7479          store_ty
+000324e0: 7065 203d 2073 746f 7261 6765 5f6c 6962  pe = storage_lib
+000324f0: 2e53 746f 7265 5479 7065 2e53 330a 2020  .StoreType.S3.  
+00032500: 2020 2020 2020 746d 705f 6c6f 6361 6c5f        tmp_local_
+00032510: 7374 6f72 6167 655f 6f62 6a2e 6164 645f  storage_obj.add_
+00032520: 7374 6f72 6528 7374 6f72 655f 7479 7065  store(store_type
+00032530: 2c20 7265 6769 6f6e 3d72 6567 696f 6e29  , region=region)
+00032540: 0a20 2020 2020 2020 2062 7563 6b65 745f  .        bucket_
+00032550: 6e61 6d65 203d 2074 6d70 5f6c 6f63 616c  name = tmp_local
+00032560: 5f73 746f 7261 6765 5f6f 626a 2e6e 616d  _storage_obj.nam
+00032570: 650a 0a20 2020 2020 2020 2023 2043 6f6e  e..        # Con
+00032580: 6669 726d 2074 6861 7420 7468 6520 6275  firm that the bu
+00032590: 636b 6574 2077 6173 2063 7265 6174 6564  cket was created
+000325a0: 2069 6e20 7468 6520 636f 7272 6563 7420   in the correct 
+000325b0: 7265 6769 6f6e 0a20 2020 2020 2020 2072  region.        r
+000325c0: 6567 696f 6e5f 636d 6420 3d20 7365 6c66  egion_cmd = self
+000325d0: 2e63 6c69 5f72 6567 696f 6e5f 636d 6428  .cli_region_cmd(
+000325e0: 7374 6f72 655f 7479 7065 2c20 6275 636b  store_type, buck
+000325f0: 6574 5f6e 616d 6529 0a20 2020 2020 2020  et_name).       
+00032600: 206f 7574 203d 2073 7562 7072 6f63 6573   out = subproces
+00032610: 732e 6368 6563 6b5f 6f75 7470 7574 2872  s.check_output(r
+00032620: 6567 696f 6e5f 636d 642c 2073 6865 6c6c  egion_cmd, shell
+00032630: 3d54 7275 6529 0a20 2020 2020 2020 206f  =True).        o
+00032640: 7574 7075 7420 3d20 6f75 742e 6465 636f  utput = out.deco
+00032650: 6465 2827 7574 662d 3827 290a 2020 2020  de('utf-8').    
+00032660: 2020 2020 6578 7065 6374 6564 5f6f 7574      expected_out
+00032670: 7075 745f 7265 6769 6f6e 203d 2072 6567  put_region = reg
+00032680: 696f 6e0a 2020 2020 2020 2020 6966 2072  ion.        if r
+00032690: 6567 696f 6e20 3d3d 2027 7573 2d65 6173  egion == 'us-eas
+000326a0: 742d 3127 3a0a 2020 2020 2020 2020 2020  t-1':.          
+000326b0: 2020 6578 7065 6374 6564 5f6f 7574 7075    expected_outpu
+000326c0: 745f 7265 6769 6f6e 203d 2027 4e6f 6e65  t_region = 'None
+000326d0: 2720 2023 2075 732d 6561 7374 2d31 2069  '  # us-east-1 i
+000326e0: 7320 7468 6520 6465 6661 756c 7420 7265  s the default re
+000326f0: 6769 6f6e 0a20 2020 2020 2020 2061 7373  gion.        ass
+00032700: 6572 7420 6578 7065 6374 6564 5f6f 7574  ert expected_out
+00032710: 7075 745f 7265 6769 6f6e 2069 6e20 6f75  put_region in ou
+00032720: 742e 6465 636f 6465 2827 7574 662d 3827  t.decode('utf-8'
+00032730: 292c 2028 0a20 2020 2020 2020 2020 2020  ), (.           
+00032740: 2066 2742 7563 6b65 7420 7761 7320 6e6f   f'Bucket was no
+00032750: 7420 666f 756e 6420 696e 2072 6567 696f  t found in regio
+00032760: 6e20 7b72 6567 696f 6e7d 202d 2027 0a20  n {region} - '. 
+00032770: 2020 2020 2020 2020 2020 2066 276f 7574             f'out
+00032780: 7075 7420 6f66 207b 7265 6769 6f6e 5f63  put of {region_c
+00032790: 6d64 7d20 7761 733a 207b 6f75 7470 7574  md} was: {output
+000327a0: 7d27 290a 0a20 2020 2020 2020 2023 2043  }')..        # C
+000327b0: 6865 636b 2069 6620 746d 705f 736f 7572  heck if tmp_sour
+000327c0: 6365 2f74 6d70 2d66 696c 6520 6578 6973  ce/tmp-file exis
+000327d0: 7473 2069 6e20 7468 6520 6275 636b 6574  ts in the bucket
+000327e0: 2075 7369 6e67 2063 6c69 0a20 2020 2020   using cli.     
+000327f0: 2020 206c 735f 636d 6420 3d20 7365 6c66     ls_cmd = self
+00032800: 2e63 6c69 5f6c 735f 636d 6428 7374 6f72  .cli_ls_cmd(stor
+00032810: 655f 7479 7065 2c20 6275 636b 6574 5f6e  e_type, bucket_n
+00032820: 616d 6529 0a20 2020 2020 2020 206f 7574  ame).        out
+00032830: 203d 2073 7562 7072 6f63 6573 732e 6368   = subprocess.ch
+00032840: 6563 6b5f 6f75 7470 7574 286c 735f 636d  eck_output(ls_cm
+00032850: 642c 2073 6865 6c6c 3d54 7275 6529 0a20  d, shell=True). 
+00032860: 2020 2020 2020 206f 7574 7075 7420 3d20         output = 
+00032870: 6f75 742e 6465 636f 6465 2827 7574 662d  out.decode('utf-
+00032880: 3827 290a 2020 2020 2020 2020 6173 7365  8').        asse
+00032890: 7274 2027 746d 702d 6669 6c65 2720 696e  rt 'tmp-file' in
+000328a0: 206f 7574 7075 742c 2028 0a20 2020 2020   output, (.     
+000328b0: 2020 2020 2020 2066 2774 6d70 2d66 696c         f'tmp-fil
+000328c0: 6520 6e6f 7420 666f 756e 6420 696e 2062  e not found in b
+000328d0: 7563 6b65 7420 2d20 6f75 7470 7574 206f  ucket - output o
+000328e0: 6620 7b6c 735f 636d 647d 2077 6173 3a20  f {ls_cmd} was: 
+000328f0: 7b6f 7574 7075 747d 2729 0a0a 2020 2020  {output}')..    
+00032900: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+00032910: 666c 7569 6473 7461 636b 0a20 2020 2040  fluidstack.    @
+00032920: 7079 7465 7374 2e6d 6172 6b2e 7061 7261  pytest.mark.para
+00032930: 6d65 7472 697a 6528 2772 6567 696f 6e27  metrize('region'
+00032940: 2c20 5b0a 2020 2020 2020 2020 276e 6f72  , [.        'nor
+00032950: 7468 616d 6572 6963 612d 6e6f 7274 6865  thamerica-northe
+00032960: 6173 7431 272c 2027 6e6f 7274 6861 6d65  ast1', 'northame
+00032970: 7269 6361 2d6e 6f72 7468 6561 7374 3227  rica-northeast2'
+00032980: 2c20 2775 732d 6365 6e74 7261 6c31 272c  , 'us-central1',
+00032990: 0a20 2020 2020 2020 2027 7573 2d65 6173  .        'us-eas
+000329a0: 7431 272c 2027 7573 2d65 6173 7434 272c  t1', 'us-east4',
+000329b0: 2027 7573 2d65 6173 7435 272c 2027 7573   'us-east5', 'us
+000329c0: 2d73 6f75 7468 3127 2c20 2775 732d 7765  -south1', 'us-we
+000329d0: 7374 3127 2c20 2775 732d 7765 7374 3227  st1', 'us-west2'
+000329e0: 2c0a 2020 2020 2020 2020 2775 732d 7765  ,.        'us-we
+000329f0: 7374 3327 2c20 2775 732d 7765 7374 3427  st3', 'us-west4'
+00032a00: 2c20 2773 6f75 7468 616d 6572 6963 612d  , 'southamerica-
+00032a10: 6561 7374 3127 2c20 2773 6f75 7468 616d  east1', 'southam
+00032a20: 6572 6963 612d 7765 7374 3127 2c0a 2020  erica-west1',.  
+00032a30: 2020 2020 2020 2765 7572 6f70 652d 6365        'europe-ce
+00032a40: 6e74 7261 6c32 272c 2027 6575 726f 7065  ntral2', 'europe
+00032a50: 2d6e 6f72 7468 3127 2c20 2765 7572 6f70  -north1', 'europ
+00032a60: 652d 736f 7574 6877 6573 7431 272c 2027  e-southwest1', '
+00032a70: 6575 726f 7065 2d77 6573 7431 272c 0a20  europe-west1',. 
+00032a80: 2020 2020 2020 2027 6575 726f 7065 2d77         'europe-w
+00032a90: 6573 7432 272c 2027 6575 726f 7065 2d77  est2', 'europe-w
+00032aa0: 6573 7433 272c 2027 6575 726f 7065 2d77  est3', 'europe-w
+00032ab0: 6573 7434 272c 2027 6575 726f 7065 2d77  est4', 'europe-w
+00032ac0: 6573 7436 272c 0a20 2020 2020 2020 2027  est6',.        '
+00032ad0: 6575 726f 7065 2d77 6573 7438 272c 2027  europe-west8', '
+00032ae0: 6575 726f 7065 2d77 6573 7439 272c 2027  europe-west9', '
+00032af0: 6575 726f 7065 2d77 6573 7431 3027 2c20  europe-west10', 
+00032b00: 2765 7572 6f70 652d 7765 7374 3132 272c  'europe-west12',
+00032b10: 0a20 2020 2020 2020 2027 6173 6961 2d65  .        'asia-e
+00032b20: 6173 7431 272c 2027 6173 6961 2d65 6173  ast1', 'asia-eas
+00032b30: 7432 272c 2027 6173 6961 2d6e 6f72 7468  t2', 'asia-north
+00032b40: 6561 7374 3127 2c20 2761 7369 612d 6e6f  east1', 'asia-no
+00032b50: 7274 6865 6173 7432 272c 0a20 2020 2020  rtheast2',.     
+00032b60: 2020 2027 6173 6961 2d6e 6f72 7468 6561     'asia-northea
+00032b70: 7374 3327 2c20 2761 7369 612d 736f 7574  st3', 'asia-sout
+00032b80: 6865 6173 7431 272c 2027 6173 6961 2d73  heast1', 'asia-s
+00032b90: 6f75 7468 3127 2c20 2761 7369 612d 736f  outh1', 'asia-so
+00032ba0: 7574 6832 272c 0a20 2020 2020 2020 2027  uth2',.        '
+00032bb0: 6173 6961 2d73 6f75 7468 6561 7374 3227  asia-southeast2'
+00032bc0: 2c20 276d 652d 6365 6e74 7261 6c31 272c  , 'me-central1',
+00032bd0: 2027 6d65 2d63 656e 7472 616c 3227 2c20   'me-central2', 
+00032be0: 276d 652d 7765 7374 3127 2c0a 2020 2020  'me-west1',.    
+00032bf0: 2020 2020 2761 7573 7472 616c 6961 2d73      'australia-s
+00032c00: 6f75 7468 6561 7374 3127 2c20 2761 7573  outheast1', 'aus
+00032c10: 7472 616c 6961 2d73 6f75 7468 6561 7374  tralia-southeast
+00032c20: 3227 2c20 2761 6672 6963 612d 736f 7574  2', 'africa-sout
+00032c30: 6831 270a 2020 2020 5d29 0a20 2020 2064  h1'.    ]).    d
+00032c40: 6566 2074 6573 745f 6763 735f 7265 6769  ef test_gcs_regi
+00032c50: 6f6e 7328 7365 6c66 2c20 746d 705f 6c6f  ons(self, tmp_lo
+00032c60: 6361 6c5f 7374 6f72 6167 655f 6f62 6a2c  cal_storage_obj,
+00032c70: 2072 6567 696f 6e29 3a0a 2020 2020 2020   region):.      
+00032c80: 2020 2320 5468 6973 2074 6573 7473 2063    # This tests c
+00032c90: 7265 6174 696f 6e20 616e 6420 7570 6c6f  reation and uplo
+00032ca0: 6164 2074 6f20 6275 636b 6574 2069 6e20  ad to bucket in 
+00032cb0: 616c 6c20 4743 5320 7265 6769 6f6e 730a  all GCS regions.
+00032cc0: 2020 2020 2020 2020 2320 546f 2074 6573          # To tes
+00032cd0: 7420 6675 6c6c 2066 756e 6374 696f 6e61  t full functiona
+00032ce0: 6c69 7479 2c20 7573 6520 7465 7374 5f6d  lity, use test_m
+00032cf0: 616e 6167 6564 5f6a 6f62 735f 7374 6f72  anaged_jobs_stor
+00032d00: 6167 6520 6162 6f76 652e 0a20 2020 2020  age above..     
+00032d10: 2020 2073 746f 7265 5f74 7970 6520 3d20     store_type = 
+00032d20: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
+00032d30: 6554 7970 652e 4743 530a 2020 2020 2020  eType.GCS.      
+00032d40: 2020 746d 705f 6c6f 6361 6c5f 7374 6f72    tmp_local_stor
+00032d50: 6167 655f 6f62 6a2e 6164 645f 7374 6f72  age_obj.add_stor
+00032d60: 6528 7374 6f72 655f 7479 7065 2c20 7265  e(store_type, re
+00032d70: 6769 6f6e 3d72 6567 696f 6e29 0a20 2020  gion=region).   
+00032d80: 2020 2020 2062 7563 6b65 745f 6e61 6d65       bucket_name
+00032d90: 203d 2074 6d70 5f6c 6f63 616c 5f73 746f   = tmp_local_sto
+00032da0: 7261 6765 5f6f 626a 2e6e 616d 650a 0a20  rage_obj.name.. 
+00032db0: 2020 2020 2020 2023 2043 6f6e 6669 726d         # Confirm
+00032dc0: 2074 6861 7420 7468 6520 6275 636b 6574   that the bucket
+00032dd0: 2077 6173 2063 7265 6174 6564 2069 6e20   was created in 
+00032de0: 7468 6520 636f 7272 6563 7420 7265 6769  the correct regi
+00032df0: 6f6e 0a20 2020 2020 2020 2072 6567 696f  on.        regio
+00032e00: 6e5f 636d 6420 3d20 7365 6c66 2e63 6c69  n_cmd = self.cli
+00032e10: 5f72 6567 696f 6e5f 636d 6428 7374 6f72  _region_cmd(stor
+00032e20: 655f 7479 7065 2c20 6275 636b 6574 5f6e  e_type, bucket_n
+00032e30: 616d 6529 0a20 2020 2020 2020 206f 7574  ame).        out
+00032e40: 203d 2073 7562 7072 6f63 6573 732e 6368   = subprocess.ch
+00032e50: 6563 6b5f 6f75 7470 7574 2872 6567 696f  eck_output(regio
+00032e60: 6e5f 636d 642c 2073 6865 6c6c 3d54 7275  n_cmd, shell=Tru
+00032e70: 6529 0a20 2020 2020 2020 206f 7574 7075  e).        outpu
+00032e80: 7420 3d20 6f75 742e 6465 636f 6465 2827  t = out.decode('
+00032e90: 7574 662d 3827 290a 2020 2020 2020 2020  utf-8').        
+00032ea0: 6173 7365 7274 2072 6567 696f 6e20 696e  assert region in
+00032eb0: 206f 7574 2e64 6563 6f64 6528 2775 7466   out.decode('utf
+00032ec0: 2d38 2729 2c20 280a 2020 2020 2020 2020  -8'), (.        
+00032ed0: 2020 2020 6627 4275 636b 6574 2077 6173      f'Bucket was
+00032ee0: 206e 6f74 2066 6f75 6e64 2069 6e20 7265   not found in re
+00032ef0: 6769 6f6e 207b 7265 6769 6f6e 7d20 2d20  gion {region} - 
+00032f00: 270a 2020 2020 2020 2020 2020 2020 6627  '.            f'
+00032f10: 6f75 7470 7574 206f 6620 7b72 6567 696f  output of {regio
+00032f20: 6e5f 636d 647d 2077 6173 3a20 7b6f 7574  n_cmd} was: {out
+00032f30: 7075 747d 2729 0a0a 2020 2020 2020 2020  put}')..        
+00032f40: 2320 4368 6563 6b20 6966 2074 6d70 5f73  # Check if tmp_s
+00032f50: 6f75 7263 652f 746d 702d 6669 6c65 2065  ource/tmp-file e
+00032f60: 7869 7374 7320 696e 2074 6865 2062 7563  xists in the buc
+00032f70: 6b65 7420 7573 696e 6720 636c 690a 2020  ket using cli.  
+00032f80: 2020 2020 2020 6c73 5f63 6d64 203d 2073        ls_cmd = s
+00032f90: 656c 662e 636c 695f 6c73 5f63 6d64 2873  elf.cli_ls_cmd(s
+00032fa0: 746f 7265 5f74 7970 652c 2062 7563 6b65  tore_type, bucke
+00032fb0: 745f 6e61 6d65 290a 2020 2020 2020 2020  t_name).        
+00032fc0: 6f75 7420 3d20 7375 6270 726f 6365 7373  out = subprocess
+00032fd0: 2e63 6865 636b 5f6f 7574 7075 7428 6c73  .check_output(ls
+00032fe0: 5f63 6d64 2c20 7368 656c 6c3d 5472 7565  _cmd, shell=True
+00032ff0: 290a 2020 2020 2020 2020 6f75 7470 7574  ).        output
+00033000: 203d 206f 7574 2e64 6563 6f64 6528 2775   = out.decode('u
+00033010: 7466 2d38 2729 0a20 2020 2020 2020 2061  tf-8').        a
+00033020: 7373 6572 7420 2774 6d70 2d66 696c 6527  ssert 'tmp-file'
+00033030: 2069 6e20 6f75 7470 7574 2c20 280a 2020   in output, (.  
+00033040: 2020 2020 2020 2020 2020 6627 746d 702d            f'tmp-
+00033050: 6669 6c65 206e 6f74 2066 6f75 6e64 2069  file not found i
+00033060: 6e20 6275 636b 6574 202d 206f 7574 7075  n bucket - outpu
+00033070: 7420 6f66 207b 6c73 5f63 6d64 7d20 7761  t of {ls_cmd} wa
+00033080: 733a 207b 6f75 7470 7574 7d27 290a 0a0a  s: {output}')...
+00033090: 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054 6573  # ---------- Tes
+000330a0: 7469 6e67 2059 414d 4c20 5370 6563 7320  ting YAML Specs 
+000330b0: 2d2d 2d2d 2d2d 2d2d 2d2d 0a23 204f 7572  ----------.# Our
+000330c0: 2073 6b79 2073 746f 7261 6765 2072 6571   sky storage req
+000330d0: 7569 7265 7320 6372 6564 656e 7469 616c  uires credential
+000330e0: 7320 746f 2063 6865 636b 2074 6865 2062  s to check the b
+000330f0: 7563 6b65 7420 6578 6973 7461 6e63 6520  ucket existance 
+00033100: 7768 656e 0a23 206c 6f61 6469 6e67 2061  when.# loading a
+00033110: 2074 6173 6b20 6672 6f6d 2074 6865 2079   task from the y
+00033120: 616d 6c20 6669 6c65 2c20 736f 2077 6520  aml file, so we 
+00033130: 6361 6e6e 6f74 206d 616b 6520 6974 2061  cannot make it a
+00033140: 2075 6e69 7420 7465 7374 2e0a 636c 6173   unit test..clas
+00033150: 7320 5465 7374 5961 6d6c 5370 6563 733a  s TestYamlSpecs:
+00033160: 0a20 2020 2023 2054 4f44 4f28 7a68 7775  .    # TODO(zhwu
+00033170: 293a 2041 6464 2074 6573 7420 666f 7220  ): Add test for 
+00033180: 6074 6f5f 7961 6d6c 5f63 6f6e 6669 6760  `to_yaml_config`
+00033190: 2066 6f72 2074 6865 2053 746f 7261 6765   for the Storage
+000331a0: 206f 626a 6563 742e 0a20 2020 2023 2020   object..    #  
+000331b0: 5765 2073 686f 756c 6420 6e6f 7420 7573  We should not us
+000331c0: 6520 6065 7861 6d70 6c65 732f 7374 6f72  e `examples/stor
+000331d0: 6167 655f 6465 6d6f 2e79 616d 6c60 2068  age_demo.yaml` h
+000331e0: 6572 652c 2073 696e 6365 2069 7420 7265  ere, since it re
+000331f0: 7175 6972 6573 0a20 2020 2023 2020 7573  quires.    #  us
+00033200: 6572 7320 746f 2065 6e73 7572 6520 6275  ers to ensure bu
+00033210: 636b 6574 206e 616d 6573 2074 6f20 6e6f  cket names to no
+00033220: 7420 6578 6973 7420 616e 642f 6f72 2062  t exist and/or b
+00033230: 6520 756e 6971 7565 2e0a 2020 2020 5f54  e unique..    _T
+00033240: 4553 545f 5941 4d4c 5f50 4154 4853 203d  EST_YAML_PATHS =
+00033250: 205b 0a20 2020 2020 2020 2027 6578 616d   [.        'exam
+00033260: 706c 6573 2f6d 696e 696d 616c 2e79 616d  ples/minimal.yam
+00033270: 6c27 2c20 2765 7861 6d70 6c65 732f 6d61  l', 'examples/ma
+00033280: 6e61 6765 645f 6a6f 622e 7961 6d6c 272c  naged_job.yaml',
+00033290: 0a20 2020 2020 2020 2027 6578 616d 706c  .        'exampl
+000332a0: 6573 2f75 7369 6e67 5f66 696c 655f 6d6f  es/using_file_mo
+000332b0: 756e 7473 2e79 616d 6c27 2c20 2765 7861  unts.yaml', 'exa
+000332c0: 6d70 6c65 732f 7265 736e 6574 5f61 7070  mples/resnet_app
+000332d0: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
+000332e0: 2765 7861 6d70 6c65 732f 6d75 6c74 695f  'examples/multi_
+000332f0: 686f 7374 6e61 6d65 2e79 616d 6c27 0a20  hostname.yaml'. 
+00033300: 2020 205d 0a0a 2020 2020 6465 6620 5f69     ]..    def _i
+00033310: 735f 6469 6374 5f73 7562 7365 7428 7365  s_dict_subset(se
+00033320: 6c66 2c20 6431 2c20 6432 293a 0a20 2020  lf, d1, d2):.   
+00033330: 2020 2020 2022 2222 4368 6563 6b20 6966       """Check if
+00033340: 2064 3120 6973 2074 6865 2073 7562 7365   d1 is the subse
+00033350: 7420 6f66 2064 322e 2222 220a 2020 2020  t of d2.""".    
+00033360: 2020 2020 666f 7220 6b2c 2076 2069 6e20      for k, v in 
+00033370: 6431 2e69 7465 6d73 2829 3a0a 2020 2020  d1.items():.    
+00033380: 2020 2020 2020 2020 6966 206b 206e 6f74          if k not
+00033390: 2069 6e20 6432 3a0a 2020 2020 2020 2020   in d2:.        
+000333a0: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+000333b0: 7461 6e63 6528 762c 206c 6973 7429 206f  tance(v, list) o
+000333c0: 7220 6973 696e 7374 616e 6365 2876 2c20  r isinstance(v, 
+000333d0: 6469 6374 293a 0a20 2020 2020 2020 2020  dict):.         
+000333e0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+000333f0: 7420 6c65 6e28 7629 203d 3d20 302c 2028  t len(v) == 0, (
+00033400: 6b2c 2076 290a 2020 2020 2020 2020 2020  k, v).          
+00033410: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00033420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033430: 6173 7365 7274 2046 616c 7365 2c20 286b  assert False, (k
+00033440: 2c20 7629 0a20 2020 2020 2020 2020 2020  , v).           
+00033450: 2065 6c69 6620 6973 696e 7374 616e 6365   elif isinstance
+00033460: 2876 2c20 6469 6374 293a 0a20 2020 2020  (v, dict):.     
+00033470: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00033480: 7420 6973 696e 7374 616e 6365 2864 325b  t isinstance(d2[
+00033490: 6b5d 2c20 6469 6374 292c 2028 6b2c 2076  k], dict), (k, v
+000334a0: 2c20 6432 290a 2020 2020 2020 2020 2020  , d2).          
+000334b0: 2020 2020 2020 7365 6c66 2e5f 6973 5f64        self._is_d
+000334c0: 6963 745f 7375 6273 6574 2876 2c20 6432  ict_subset(v, d2
+000334d0: 5b6b 5d29 0a20 2020 2020 2020 2020 2020  [k]).           
+000334e0: 2065 6c69 6620 6973 696e 7374 616e 6365   elif isinstance
+000334f0: 2876 2c20 7374 7229 3a0a 2020 2020 2020  (v, str):.      
+00033500: 2020 2020 2020 2020 2020 6966 206b 203d            if k =
+00033510: 3d20 2761 6363 656c 6572 6174 6f72 7327  = 'accelerators'
+00033520: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00033530: 2020 2020 2020 7265 736f 7572 6365 7320        resources 
+00033540: 3d20 736b 792e 5265 736f 7572 6365 7328  = sky.Resources(
+00033550: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00033560: 2020 2020 2020 7265 736f 7572 6365 732e        resources.
+00033570: 5f73 6574 5f61 6363 656c 6572 6174 6f72  _set_accelerator
+00033580: 7328 762c 204e 6f6e 6529 0a20 2020 2020  s(v, None).     
+00033590: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+000335a0: 7373 6572 7420 7265 736f 7572 6365 732e  ssert resources.
+000335b0: 6163 6365 6c65 7261 746f 7273 203d 3d20  accelerators == 
+000335c0: 6432 5b6b 5d2c 2028 6b2c 2076 2c20 6432  d2[k], (k, v, d2
+000335d0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000335e0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+000335f0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00033600: 7274 2076 2e6c 6f77 6572 2829 203d 3d20  rt v.lower() == 
+00033610: 6432 5b6b 5d2e 6c6f 7765 7228 292c 2028  d2[k].lower(), (
+00033620: 6b2c 2076 2c20 6432 5b6b 5d29 0a20 2020  k, v, d2[k]).   
+00033630: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+00033640: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00033650: 7373 6572 7420 7620 3d3d 2064 325b 6b5d  ssert v == d2[k]
+00033660: 2c20 286b 2c20 762c 2064 325b 6b5d 290a  , (k, v, d2[k]).
+00033670: 0a20 2020 2064 6566 205f 6368 6563 6b5f  .    def _check_
+00033680: 6571 7569 7661 6c65 6e74 2873 656c 662c  equivalent(self,
+00033690: 2079 616d 6c5f 7061 7468 293a 0a20 2020   yaml_path):.   
+000336a0: 2020 2020 2022 2222 4368 6563 6b20 6966       """Check if
+000336b0: 2074 6865 2079 616d 6c20 6973 2065 7175   the yaml is equ
+000336c0: 6976 616c 656e 7420 6166 7465 7220 6c6f  ivalent after lo
+000336d0: 6164 2061 6e64 2064 756d 7020 6167 6169  ad and dump agai
+000336e0: 6e2e 2222 220a 2020 2020 2020 2020 6f72  n.""".        or
+000336f0: 6967 696e 5f74 6173 6b5f 636f 6e66 6967  igin_task_config
+00033700: 203d 2063 6f6d 6d6f 6e5f 7574 696c 732e   = common_utils.
+00033710: 7265 6164 5f79 616d 6c28 7961 6d6c 5f70  read_yaml(yaml_p
+00033720: 6174 6829 0a0a 2020 2020 2020 2020 7461  ath)..        ta
+00033730: 736b 203d 2073 6b79 2e54 6173 6b2e 6672  sk = sky.Task.fr
+00033740: 6f6d 5f79 616d 6c28 7961 6d6c 5f70 6174  om_yaml(yaml_pat
+00033750: 6829 0a20 2020 2020 2020 206e 6577 5f74  h).        new_t
+00033760: 6173 6b5f 636f 6e66 6967 203d 2074 6173  ask_config = tas
+00033770: 6b2e 746f 5f79 616d 6c5f 636f 6e66 6967  k.to_yaml_config
+00033780: 2829 0a20 2020 2020 2020 2023 2064 3120  ().        # d1 
+00033790: 3c3d 2064 320a 2020 2020 2020 2020 7072  <= d2.        pr
+000337a0: 696e 7428 6f72 6967 696e 5f74 6173 6b5f  int(origin_task_
+000337b0: 636f 6e66 6967 2c20 6e65 775f 7461 736b  config, new_task
+000337c0: 5f63 6f6e 6669 6729 0a20 2020 2020 2020  _config).       
+000337d0: 2073 656c 662e 5f69 735f 6469 6374 5f73   self._is_dict_s
+000337e0: 7562 7365 7428 6f72 6967 696e 5f74 6173  ubset(origin_tas
+000337f0: 6b5f 636f 6e66 6967 2c20 6e65 775f 7461  k_config, new_ta
+00033800: 736b 5f63 6f6e 6669 6729 0a0a 2020 2020  sk_config)..    
+00033810: 6465 6620 7465 7374 5f6c 6f61 645f 6475  def test_load_du
+00033820: 6d70 5f79 616d 6c5f 636f 6e66 6967 5f65  mp_yaml_config_e
+00033830: 7175 6976 616c 656e 7428 7365 6c66 293a  quivalent(self):
+00033840: 0a20 2020 2020 2020 2022 2222 5465 7374  .        """Test
+00033850: 2069 6620 7468 6520 7961 6d6c 2063 6f6e   if the yaml con
+00033860: 6669 6720 6973 2065 7175 6976 616c 656e  fig is equivalen
+00033870: 7420 6166 7465 7220 6c6f 6164 2061 6e64  t after load and
+00033880: 2064 756d 7020 6167 6169 6e2e 2222 220a   dump again.""".
+00033890: 2020 2020 2020 2020 7061 7468 6c69 622e          pathlib.
+000338a0: 5061 7468 2827 7e2f 6461 7461 7365 7473  Path('~/datasets
+000338b0: 2729 2e65 7870 616e 6475 7365 7228 292e  ').expanduser().
+000338c0: 6d6b 6469 7228 6578 6973 745f 6f6b 3d54  mkdir(exist_ok=T
+000338d0: 7275 6529 0a20 2020 2020 2020 2070 6174  rue).        pat
+000338e0: 686c 6962 2e50 6174 6828 277e 2f74 6d70  hlib.Path('~/tmp
+000338f0: 6669 6c65 2729 2e65 7870 616e 6475 7365  file').expanduse
+00033900: 7228 292e 746f 7563 6828 290a 2020 2020  r().touch().    
+00033910: 2020 2020 7061 7468 6c69 622e 5061 7468      pathlib.Path
+00033920: 2827 7e2f 2e73 7368 2729 2e65 7870 616e  ('~/.ssh').expan
+00033930: 6475 7365 7228 292e 6d6b 6469 7228 6578  duser().mkdir(ex
+00033940: 6973 745f 6f6b 3d54 7275 6529 0a20 2020  ist_ok=True).   
+00033950: 2020 2020 2070 6174 686c 6962 2e50 6174       pathlib.Pat
+00033960: 6828 277e 2f2e 7373 682f 6964 5f72 7361  h('~/.ssh/id_rsa
+00033970: 2e70 7562 2729 2e65 7870 616e 6475 7365  .pub').expanduse
+00033980: 7228 292e 746f 7563 6828 290a 2020 2020  r().touch().    
+00033990: 2020 2020 7061 7468 6c69 622e 5061 7468      pathlib.Path
+000339a0: 2827 7e2f 746d 702d 776f 726b 6469 7227  ('~/tmp-workdir'
+000339b0: 292e 6578 7061 6e64 7573 6572 2829 2e6d  ).expanduser().m
+000339c0: 6b64 6972 2865 7869 7374 5f6f 6b3d 5472  kdir(exist_ok=Tr
+000339d0: 7565 290a 2020 2020 2020 2020 7061 7468  ue).        path
+000339e0: 6c69 622e 5061 7468 2827 7e2f 446f 776e  lib.Path('~/Down
+000339f0: 6c6f 6164 732f 7470 7527 292e 6578 7061  loads/tpu').expa
+00033a00: 6e64 7573 6572 2829 2e6d 6b64 6972 2870  nduser().mkdir(p
+00033a10: 6172 656e 7473 3d54 7275 652c 0a20 2020  arents=True,.   
+00033a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033a50: 2020 2020 2020 2020 6578 6973 745f 6f6b          exist_ok
+00033a60: 3d54 7275 6529 0a20 2020 2020 2020 2066  =True).        f
+00033a70: 6f72 2079 616d 6c5f 7061 7468 2069 6e20  or yaml_path in 
+00033a80: 7365 6c66 2e5f 5445 5354 5f59 414d 4c5f  self._TEST_YAML_
+00033a90: 5041 5448 533a 0a20 2020 2020 2020 2020  PATHS:.         
+00033aa0: 2020 2073 656c 662e 5f63 6865 636b 5f65     self._check_e
+00033ab0: 7175 6976 616c 656e 7428 7961 6d6c 5f70  quivalent(yaml_p
+00033ac0: 6174 6829 0a0a 0a23 202d 2d2d 2d2d 2d2d  ath)...# -------
+00033ad0: 2d2d 2d20 5465 7374 696e 6720 4d75 6c74  --- Testing Mult
+00033ae0: 6970 6c65 2041 6363 656c 6572 6174 6f72  iple Accelerator
+00033af0: 7320 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079  s ----------.@py
+00033b00: 7465 7374 2e6d 6172 6b2e 6e6f 5f66 6c75  test.mark.no_flu
+00033b10: 6964 7374 6163 6b20 2023 2046 6c75 6964  idstack  # Fluid
+00033b20: 7374 6163 6b20 646f 6573 206e 6f74 2073  stack does not s
+00033b30: 7570 706f 7274 204b 3830 2067 7075 7320  upport K80 gpus 
+00033b40: 666f 7220 6e6f 770a 4070 7974 6573 742e  for now.@pytest.
+00033b50: 6d61 726b 2e6e 6f5f 7061 7065 7273 7061  mark.no_paperspa
+00033b60: 6365 2020 2320 5061 7065 7273 7061 6365  ce  # Paperspace
+00033b70: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
+00033b80: 7420 4b38 3020 6770 7573 0a64 6566 2074  t K80 gpus.def t
+00033b90: 6573 745f 6d75 6c74 6970 6c65 5f61 6363  est_multiple_acc
+00033ba0: 656c 6572 6174 6f72 735f 6f72 6465 7265  elerators_ordere
+00033bb0: 6428 293a 0a20 2020 206e 616d 6520 3d20  d():.    name = 
+00033bc0: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
+00033bd0: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
+00033be0: 6573 7428 0a20 2020 2020 2020 2027 6d75  est(.        'mu
+00033bf0: 6c74 6970 6c65 2d61 6363 656c 6572 6174  ltiple-accelerat
+00033c00: 6f72 732d 6f72 6465 7265 6427 2c0a 2020  ors-ordered',.  
+00033c10: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+00033c20: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
+00033c30: 202d 7920 2d63 207b 6e61 6d65 7d20 7465   -y -c {name} te
+00033c40: 7374 732f 7465 7374 5f79 616d 6c73 2f74  sts/test_yamls/t
+00033c50: 6573 745f 6d75 6c74 6970 6c65 5f61 6363  est_multiple_acc
+00033c60: 656c 6572 6174 6f72 735f 6f72 6465 7265  elerators_ordere
+00033c70: 642e 7961 6d6c 207c 2067 7265 7020 2255  d.yaml | grep "U
+00033c80: 7369 6e67 2075 7365 722d 7370 6563 6966  sing user-specif
+00033c90: 6965 6420 6163 6365 6c65 7261 746f 7273  ied accelerators
+00033ca0: 206c 6973 7422 272c 0a20 2020 2020 2020   list"',.       
+00033cb0: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+00033cc0: 7b6e 616d 657d 2031 202d 2d73 7461 7475  {name} 1 --statu
+00033cd0: 7327 2c20 2023 2045 6e73 7572 6520 7468  s',  # Ensure th
+00033ce0: 6520 6a6f 6220 7375 6363 6565 6465 642e  e job succeeded.
+00033cf0: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
+00033d00: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
+00033d10: 7920 7b6e 616d 657d 272c 0a20 2020 2020  y {name}',.     
+00033d20: 2020 2074 696d 656f 7574 3d32 3020 2a20     timeout=20 * 
+00033d30: 3630 2c0a 2020 2020 290a 2020 2020 7275  60,.    ).    ru
+00033d40: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
+00033d50: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
+00033d60: 6e6f 5f66 6c75 6964 7374 6163 6b20 2023  no_fluidstack  #
+00033d70: 2046 6c75 6964 7374 6163 6b20 6861 7320   Fluidstack has 
+00033d80: 6c6f 7720 6176 6169 6c61 6269 6c69 7479  low availability
+00033d90: 2066 6f72 2054 3420 4750 5573 0a40 7079   for T4 GPUs.@py
+00033da0: 7465 7374 2e6d 6172 6b2e 6e6f 5f70 6170  test.mark.no_pap
+00033db0: 6572 7370 6163 6520 2023 2050 6170 6572  erspace  # Paper
+00033dc0: 7370 6163 6520 646f 6573 206e 6f74 2073  space does not s
+00033dd0: 7570 706f 7274 2054 3420 4750 5573 0a64  upport T4 GPUs.d
+00033de0: 6566 2074 6573 745f 6d75 6c74 6970 6c65  ef test_multiple
+00033df0: 5f61 6363 656c 6572 6174 6f72 735f 6f72  _accelerators_or
+00033e00: 6465 7265 645f 7769 7468 5f64 6566 6175  dered_with_defau
+00033e10: 6c74 2829 3a0a 2020 2020 6e61 6d65 203d  lt():.    name =
+00033e20: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
+00033e30: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
+00033e40: 5465 7374 280a 2020 2020 2020 2020 276d  Test(.        'm
+00033e50: 756c 7469 706c 652d 6163 6365 6c65 7261  ultiple-accelera
+00033e60: 746f 7273 2d6f 7264 6572 6564 272c 0a20  tors-ordered',. 
+00033e70: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
+00033e80: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
+00033e90: 6820 2d79 202d 6320 7b6e 616d 657d 2074  h -y -c {name} t
+00033ea0: 6573 7473 2f74 6573 745f 7961 6d6c 732f  ests/test_yamls/
+00033eb0: 7465 7374 5f6d 756c 7469 706c 655f 6163  test_multiple_ac
+00033ec0: 6365 6c65 7261 746f 7273 5f6f 7264 6572  celerators_order
+00033ed0: 6564 5f77 6974 685f 6465 6661 756c 742e  ed_with_default.
+00033ee0: 7961 6d6c 207c 2067 7265 7020 2255 7369  yaml | grep "Usi
+00033ef0: 6e67 2075 7365 722d 7370 6563 6966 6965  ng user-specifie
+00033f00: 6420 6163 6365 6c65 7261 746f 7273 206c  d accelerators l
+00033f10: 6973 7422 272c 0a20 2020 2020 2020 2020  ist"',.         
+00033f20: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+00033f30: 616d 657d 2031 202d 2d73 7461 7475 7327  ame} 1 --status'
+00033f40: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
+00033f50: 6a6f 6220 7375 6363 6565 6465 642e 0a20  job succeeded.. 
+00033f60: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00033f70: 2073 7461 7475 7320 7b6e 616d 657d 207c   status {name} |
+00033f80: 2067 7265 7020 5370 6f74 272c 0a20 2020   grep Spot',.   
+00033f90: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
+00033fa0: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
+00033fb0: 616d 657d 272c 0a20 2020 2029 0a20 2020  ame}',.    ).   
+00033fc0: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
+00033fd0: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
+00033fe0: 726b 2e6e 6f5f 666c 7569 6473 7461 636b  rk.no_fluidstack
+00033ff0: 2020 2320 466c 7569 6473 7461 636b 2068    # Fluidstack h
+00034000: 6173 206c 6f77 2061 7661 696c 6162 696c  as low availabil
+00034010: 6974 7920 666f 7220 5434 2047 5055 730a  ity for T4 GPUs.
+00034020: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+00034030: 7061 7065 7273 7061 6365 2020 2320 5061  paperspace  # Pa
+00034040: 7065 7273 7061 6365 2064 6f65 7320 6e6f  perspace does no
+00034050: 7420 7375 7070 6f72 7420 5434 2047 5055  t support T4 GPU
+00034060: 730a 6465 6620 7465 7374 5f6d 756c 7469  s.def test_multi
+00034070: 706c 655f 6163 6365 6c65 7261 746f 7273  ple_accelerators
+00034080: 5f75 6e6f 7264 6572 6564 2829 3a0a 2020  _unordered():.  
+00034090: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
+000340a0: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
+000340b0: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+000340c0: 2020 2020 2020 276d 756c 7469 706c 652d        'multiple-
+000340d0: 6163 6365 6c65 7261 746f 7273 2d75 6e6f  accelerators-uno
+000340e0: 7264 6572 6564 272c 0a20 2020 2020 2020  rdered',.       
+000340f0: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
+00034100: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
+00034110: 6320 7b6e 616d 657d 2074 6573 7473 2f74  c {name} tests/t
+00034120: 6573 745f 7961 6d6c 732f 7465 7374 5f6d  est_yamls/test_m
+00034130: 756c 7469 706c 655f 6163 6365 6c65 7261  ultiple_accelera
+00034140: 746f 7273 5f75 6e6f 7264 6572 6564 2e79  tors_unordered.y
+00034150: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+00034160: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+00034170: 6d65 7d20 3120 2d2d 7374 6174 7573 272c  me} 1 --status',
+00034180: 2020 2320 456e 7375 7265 2074 6865 206a    # Ensure the j
+00034190: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
+000341a0: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
+000341b0: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
+000341c0: 6e61 6d65 7d27 2c0a 2020 2020 290a 2020  name}',.    ).  
+000341d0: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+000341e0: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
+000341f0: 6172 6b2e 6e6f 5f66 6c75 6964 7374 6163  ark.no_fluidstac
+00034200: 6b20 2023 2046 6c75 6964 7374 6163 6b20  k  # Fluidstack 
+00034210: 6861 7320 6c6f 7720 6176 6169 6c61 6269  has low availabi
+00034220: 6c69 7479 2066 6f72 2054 3420 4750 5573  lity for T4 GPUs
+00034230: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
+00034240: 5f70 6170 6572 7370 6163 6520 2023 2050  _paperspace  # P
+00034250: 6170 6572 7370 6163 6520 646f 6573 206e  aperspace does n
+00034260: 6f74 2073 7570 706f 7274 2054 3420 4750  ot support T4 GP
+00034270: 5573 0a64 6566 2074 6573 745f 6d75 6c74  Us.def test_mult
+00034280: 6970 6c65 5f61 6363 656c 6572 6174 6f72  iple_accelerator
+00034290: 735f 756e 6f72 6465 7265 645f 7769 7468  s_unordered_with
+000342a0: 5f64 6566 6175 6c74 2829 3a0a 2020 2020  _default():.    
+000342b0: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
+000342c0: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
+000342d0: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+000342e0: 2020 2020 276d 756c 7469 706c 652d 6163      'multiple-ac
+000342f0: 6365 6c65 7261 746f 7273 2d75 6e6f 7264  celerators-unord
+00034300: 6572 6564 272c 0a20 2020 2020 2020 205b  ered',.        [
+00034310: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00034320: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
+00034330: 7b6e 616d 657d 2074 6573 7473 2f74 6573  {name} tests/tes
+00034340: 745f 7961 6d6c 732f 7465 7374 5f6d 756c  t_yamls/test_mul
+00034350: 7469 706c 655f 6163 6365 6c65 7261 746f  tiple_accelerato
+00034360: 7273 5f75 6e6f 7264 6572 6564 5f77 6974  rs_unordered_wit
+00034370: 685f 6465 6661 756c 742e 7961 6d6c 272c  h_default.yaml',
+00034380: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00034390: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
+000343a0: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
+000343b0: 6e73 7572 6520 7468 6520 6a6f 6220 7375  nsure the job su
+000343c0: 6363 6565 6465 642e 0a20 2020 2020 2020  cceeded..       
+000343d0: 2020 2020 2066 2773 6b79 2073 7461 7475       f'sky statu
+000343e0: 7320 7b6e 616d 657d 207c 2067 7265 7020  s {name} | grep 
+000343f0: 5370 6f74 272c 0a20 2020 2020 2020 205d  Spot',.        ]
+00034400: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
+00034410: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
+00034420: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+00034430: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+00034440: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+00034450: 666c 7569 6473 7461 636b 2020 2320 5265  fluidstack  # Re
+00034460: 7175 6972 6573 206f 7468 6572 2063 6c6f  quires other clo
+00034470: 7564 7320 746f 2062 6520 656e 6162 6c65  uds to be enable
+00034480: 640a 6465 6620 7465 7374 5f6d 756c 7469  d.def test_multi
+00034490: 706c 655f 7265 736f 7572 6365 7328 293a  ple_resources():
+000344a0: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
+000344b0: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
+000344c0: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
+000344d0: 0a20 2020 2020 2020 2027 6d75 6c74 6970  .        'multip
+000344e0: 6c65 2d72 6573 6f75 7263 6573 272c 0a20  le-resources',. 
+000344f0: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
+00034500: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
+00034510: 6820 2d79 202d 6320 7b6e 616d 657d 2074  h -y -c {name} t
+00034520: 6573 7473 2f74 6573 745f 7961 6d6c 732f  ests/test_yamls/
+00034530: 7465 7374 5f6d 756c 7469 706c 655f 7265  test_multiple_re
+00034540: 736f 7572 6365 732e 7961 6d6c 272c 0a20  sources.yaml',. 
+00034550: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00034560: 206c 6f67 7320 7b6e 616d 657d 2031 202d   logs {name} 1 -
+00034570: 2d73 7461 7475 7327 2c20 2023 2045 6e73  -status',  # Ens
+00034580: 7572 6520 7468 6520 6a6f 6220 7375 6363  ure the job succ
+00034590: 6565 6465 642e 0a20 2020 2020 2020 205d  eeded..        ]
+000345a0: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
+000345b0: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
+000345c0: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+000345d0: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+000345e0: 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2053 6b79  # ---------- Sky
+000345f0: 2042 656e 6368 6d61 726b 202d 2d2d 2d2d   Benchmark -----
+00034600: 2d2d 2d2d 2d0a 4070 7974 6573 742e 6d61  -----.@pytest.ma
+00034610: 726b 2e6e 6f5f 666c 7569 6473 7461 636b  rk.no_fluidstack
+00034620: 2020 2320 5265 7175 6972 6573 206f 7468    # Requires oth
+00034630: 6572 2063 6c6f 7564 7320 746f 2062 6520  er clouds to be 
+00034640: 656e 6162 6c65 640a 4070 7974 6573 742e  enabled.@pytest.
+00034650: 6d61 726b 2e6e 6f5f 7061 7065 7273 7061  mark.no_paperspa
+00034660: 6365 2020 2320 5265 7175 6972 6573 206f  ce  # Requires o
+00034670: 7468 6572 2063 6c6f 7564 7320 746f 2062  ther clouds to b
+00034680: 6520 656e 6162 6c65 640a 4070 7974 6573  e enabled.@pytes
+00034690: 742e 6d61 726b 2e6e 6f5f 6b75 6265 726e  t.mark.no_kubern
+000346a0: 6574 6573 0a64 6566 2074 6573 745f 736b  etes.def test_sk
+000346b0: 795f 6265 6e63 6828 6765 6e65 7269 635f  y_bench(generic_
+000346c0: 636c 6f75 643a 2073 7472 293a 0a20 2020  cloud: str):.   
+000346d0: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
+000346e0: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
+000346f0: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
+00034700: 2020 2020 2027 736b 792d 6265 6e63 6827       'sky-bench'
+00034710: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
+00034720: 2020 2020 2020 2020 6627 736b 7920 6265          f'sky be
+00034730: 6e63 6820 6c61 756e 6368 202d 7920 2d62  nch launch -y -b
+00034740: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
+00034750: 7b67 656e 6572 6963 5f63 6c6f 7564 7d20  {generic_cloud} 
+00034760: 2d69 3020 7465 7374 732f 7465 7374 5f79  -i0 tests/test_y
+00034770: 616d 6c73 2f6d 696e 696d 616c 2e79 616d  amls/minimal.yam
+00034780: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+00034790: 2773 6c65 6570 2031 3230 272c 0a20 2020  'sleep 120',.   
+000347a0: 2020 2020 2020 2020 2066 2773 6b79 2062           f'sky b
+000347b0: 656e 6368 2073 686f 7720 7b6e 616d 657d  ench show {name}
+000347c0: 207c 2067 7265 7020 736b 792d 6265 6e63   | grep sky-benc
+000347d0: 682d 7b6e 616d 657d 207c 2067 7265 7020  h-{name} | grep 
+000347e0: 4649 4e49 5348 4544 272c 0a20 2020 2020  FINISHED',.     
+000347f0: 2020 205d 2c0a 2020 2020 2020 2020 6627     ],.        f'
+00034800: 736b 7920 6265 6e63 6820 646f 776e 207b  sky bench down {
+00034810: 6e61 6d65 7d20 2d79 3b20 736b 7920 6265  name} -y; sky be
+00034820: 6e63 6820 6465 6c65 7465 207b 6e61 6d65  nch delete {name
+00034830: 7d20 2d79 272c 0a20 2020 2029 0a20 2020  } -y',.    ).   
+00034840: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
+00034850: 7374 290a                                st).
```

### Comparing `skypilot_nightly-1.0.0.dev20240504/tests/test_spot_serve.py` & `skypilot_nightly-1.0.0.dev20240505/tests/test_jobs_and_serve.py`

 * *Files 7% similar despite different names*

```diff
@@ -10,28 +10,28 @@
 import pytest
 
 import sky
 from sky import backends
 from sky import cli
 from sky import exceptions
 from sky import global_user_state
+from sky import jobs
 from sky import serve
-from sky import spot
 from sky.utils import common_utils
 from sky.utils import controller_utils
 from sky.utils import db_utils
 
 
-def test_spot_nonexist_strategy():
+def test_job_nonexist_strategy():
     """Test the nonexist recovery strategy."""
     task_yaml = textwrap.dedent("""\
         resources:
             cloud: aws
             use_spot: true
-            spot_recovery: nonexist""")
+            job_recovery: nonexist""")
     with tempfile.NamedTemporaryFile(mode='w') as f:
         f.write(task_yaml)
         f.flush()
         with pytest.raises(
                 ValueError,
                 match='is not supported. The strategy should be among'):
             sky.Task.from_yaml(f.name)
@@ -91,26 +91,26 @@
         'test-cluster3',
         handle,
         requested_resources={handle.launched_resources},
         ready=False)
 
 
 @pytest.fixture
-def _mock_spot_controller(_mock_db_conn):
+def _mock_jobs_controller(_mock_db_conn):
     handle = backends.CloudVmRayResourceHandle(
-        cluster_name=spot.SPOT_CONTROLLER_NAME,
-        cluster_name_on_cloud=spot.SPOT_CONTROLLER_NAME,
-        cluster_yaml='/tmp/spot_controller.yaml',
+        cluster_name=jobs.JOB_CONTROLLER_NAME,
+        cluster_name_on_cloud=jobs.JOB_CONTROLLER_NAME,
+        cluster_yaml='/tmp/jobs_controller.yaml',
         launched_nodes=1,
         launched_resources=sky.Resources(sky.AWS(),
                                          instance_type='m4.2xlarge',
                                          region='us-west-1'),
     )
     global_user_state.add_or_update_cluster(
-        spot.SPOT_CONTROLLER_NAME,
+        jobs.JOB_CONTROLLER_NAME,
         handle,
         requested_resources={handle.launched_resources},
         ready=True)
 
 
 @pytest.fixture
 def _mock_serve_controller(_mock_db_conn):
@@ -127,30 +127,30 @@
         serve.SKY_SERVE_CONTROLLER_NAME,
         handle,
         requested_resources={handle.launched_resources},
         ready=True)
 
 
 def mock_is_controller_accessible(
-    controller_type: controller_utils.Controllers,
+    controller: controller_utils.Controllers,
     stopped_message: str,
     non_existent_message: Optional[str] = None,
     exit_on_error: bool = False,
 ):
     record = global_user_state.get_cluster_from_name(
-        controller_type.value.cluster_name)
+        controller.value.cluster_name)
     return record['handle']
 
 
-class TestSpotOperations:
-    """Test operations for managed spot."""
+class TestJobsOperations:
+    """Test operations for managed jobs."""
 
     @pytest.mark.timeout(60)
-    def test_down_spot_controller(self, _mock_cluster_state,
-                                  _mock_spot_controller, monkeypatch):
+    def test_down_jobs_controller(self, _mock_cluster_state,
+                                  _mock_jobs_controller, monkeypatch):
 
         def mock_get_job_table_no_job(cls, handle, code, require_outputs,
                                       stream_logs,
                                       separate_stderr) -> Tuple[int, str, str]:
             return 0, common_utils.encode_payload([]), ''
 
         def mock_get_job_table_one_job(cls, handle, code, require_outputs,
@@ -164,136 +164,135 @@
                 'submitted_at': time.time(),
                 'run_timestamp': str(time.time()),
                 'start_at': time.time(),
                 'end_at': time.time(),
                 'last_recovered_at': None,
                 'recovery_count': 0,
                 'failure_reason': '',
-                'spot_job_id': '1',
+                'managed_job_id': '1',
                 'task_id': 0,
                 'task_name': 'test_task',
                 'job_duration': 20,
             }]), ''
 
         monkeypatch.setattr(
             'sky.backends.backend_utils.is_controller_accessible',
             mock_is_controller_accessible)
 
         monkeypatch.setattr(
             'sky.backends.cloud_vm_ray_backend.CloudVmRayBackend.run_on_head',
             mock_get_job_table_no_job)
 
         cli_runner = cli_testing.CliRunner()
-        result = cli_runner.invoke(cli.down, [spot.SPOT_CONTROLLER_NAME],
+        result = cli_runner.invoke(cli.down, [jobs.JOB_CONTROLLER_NAME],
                                    input='n')
-        assert 'WARNING: Tearing down the managed spot controller.' in result.output, (
+        assert 'WARNING: Tearing down the managed jobs controller.' in result.output, (
             result.exception, result.output, result.exc_info)
         assert isinstance(result.exception,
                           SystemExit), (result.exception, result.output)
 
         monkeypatch.setattr(
             'sky.backends.cloud_vm_ray_backend.CloudVmRayBackend.run_on_head',
             mock_get_job_table_one_job)
-        result = cli_runner.invoke(cli.down, [spot.SPOT_CONTROLLER_NAME],
+        result = cli_runner.invoke(cli.down, [jobs.JOB_CONTROLLER_NAME],
                                    input='n')
-        assert 'WARNING: Tearing down the managed spot controller.' in result.output, (
+        assert 'WARNING: Tearing down the managed jobs controller.' in result.output, (
             result.exception, result.output, result.exc_info)
         assert isinstance(result.exception, exceptions.NotSupportedError)
 
-        result = cli_runner.invoke(cli.down, ['sky-spot-con*'])
+        result = cli_runner.invoke(cli.down, ['sky-jobs-con*'])
         assert not result.exception
         assert 'Cluster(s) not found' in result.output
 
-        result = cli_runner.invoke(cli.down, ['sky-spot-con*', '-p'])
+        result = cli_runner.invoke(cli.down, ['sky-jobs-con*', '-p'])
         assert not result.exception
         assert 'Cluster(s) not found' in result.output
 
         result = cli_runner.invoke(cli.down, ['-a'], input='n\n')
         assert isinstance(result.exception, SystemExit), result.exception
         assert 'Aborted' in result.output
 
         result = cli_runner.invoke(cli.down, ['-ap'], input='n\n')
         assert isinstance(result.exception, SystemExit)
         assert 'Aborted' in result.output
 
     @pytest.mark.timeout(60)
-    def test_stop_spot_controller(self, _mock_cluster_state,
-                                  _mock_spot_controller):
+    def test_stop_jobs_controller(self, _mock_cluster_state,
+                                  _mock_jobs_controller):
         cli_runner = cli_testing.CliRunner()
-        result = cli_runner.invoke(cli.stop, [spot.SPOT_CONTROLLER_NAME])
+        result = cli_runner.invoke(cli.stop, [jobs.JOB_CONTROLLER_NAME])
         assert result.exit_code == click.UsageError.exit_code
-        assert (f'Stopping controller(s) \'{spot.SPOT_CONTROLLER_NAME}\' is '
+        assert (f'Stopping controller(s) \'{jobs.JOB_CONTROLLER_NAME}\' is '
                 'currently not supported' in result.output)
 
-        result = cli_runner.invoke(cli.stop, ['sky-spot-con*'])
+        result = cli_runner.invoke(cli.stop, ['sky-jobs-con*'])
         assert not result.exception
         assert 'Cluster(s) not found' in result.output
 
         result = cli_runner.invoke(cli.stop, ['-a'], input='n\n')
         assert isinstance(result.exception, SystemExit)
         assert 'Aborted' in result.output
 
     @pytest.mark.timeout(60)
-    def test_autostop_spot_controller(self, _mock_cluster_state,
-                                      _mock_spot_controller):
+    def test_autostop_jobs_controller(self, _mock_cluster_state,
+                                      _mock_jobs_controller):
         cli_runner = cli_testing.CliRunner()
-        result = cli_runner.invoke(cli.autostop, [spot.SPOT_CONTROLLER_NAME])
+        result = cli_runner.invoke(cli.autostop, [jobs.JOB_CONTROLLER_NAME])
         assert result.exit_code == click.UsageError.exit_code
         assert ('Scheduling autostop on controller(s) '
-                f'\'{spot.SPOT_CONTROLLER_NAME}\' is currently not supported'
+                f'\'{jobs.JOB_CONTROLLER_NAME}\' is currently not supported'
                 in result.output)
 
-        result = cli_runner.invoke(cli.autostop, ['sky-spot-con*'])
+        result = cli_runner.invoke(cli.autostop, ['sky-jobs-con*'])
         assert not result.exception
         assert 'Cluster(s) not found' in result.output
 
         result = cli_runner.invoke(cli.autostop, ['-a'], input='n\n')
         assert isinstance(result.exception, SystemExit)
         assert 'Aborted' in result.output
 
-    def test_cancel_on_spot_controller(self, _mock_cluster_state,
-                                       _mock_spot_controller):
+    def test_cancel_on_jobs_controller(self, _mock_cluster_state,
+                                       _mock_jobs_controller):
         cli_runner = cli_testing.CliRunner()
-        result = cli_runner.invoke(cli.cancel,
-                                   [spot.SPOT_CONTROLLER_NAME, '-a'])
+        result = cli_runner.invoke(cli.cancel, [jobs.JOB_CONTROLLER_NAME, '-a'])
         assert result.exit_code == 1
-        assert 'Cancelling the spot controller\'s jobs is not allowed.' in str(
+        assert 'Cancelling the jobs controller\'s jobs is not allowed.' in str(
             result.output)
 
     @pytest.mark.timeout(60)
     def test_cancel(self, _mock_db_conn):
         cli_runner = cli_testing.CliRunner()
-        result = cli_runner.invoke(cli.spot_cancel, ['-a'])
+        result = cli_runner.invoke(cli.jobs_cancel, ['-a'])
         assert result.exit_code == 1
-        assert controller_utils.Controllers.SPOT_CONTROLLER.value.default_hint_if_non_existent in str(
+        assert controller_utils.Controllers.JOBS_CONTROLLER.value.default_hint_if_non_existent in str(
             result.output), (result.exception, result.output, result.exc_info)
 
     @pytest.mark.timeout(60)
     def test_logs(self, _mock_db_conn):
         cli_runner = cli_testing.CliRunner()
-        result = cli_runner.invoke(cli.spot_logs, ['1'])
+        result = cli_runner.invoke(cli.jobs_logs, ['1'])
         assert result.exit_code == 1
-        assert controller_utils.Controllers.SPOT_CONTROLLER.value.default_hint_if_non_existent in str(
+        assert controller_utils.Controllers.JOBS_CONTROLLER.value.default_hint_if_non_existent in str(
             result.output), (result.exception, result.output, result.exc_info)
 
     @pytest.mark.timeout(60)
     def test_queue(self, _mock_db_conn):
         cli_runner = cli_testing.CliRunner()
-        result = cli_runner.invoke(cli.spot_queue)
+        result = cli_runner.invoke(cli.jobs_queue)
         assert result.exit_code == 0
-        assert controller_utils.Controllers.SPOT_CONTROLLER.value.default_hint_if_non_existent in str(
+        assert controller_utils.Controllers.JOBS_CONTROLLER.value.default_hint_if_non_existent in str(
             result.output), (result.exception, result.output, result.exc_info)
 
 
 class TestServeOperations:
     """Test operations for services."""
 
     @pytest.mark.timeout(60)
-    def test_down_spot_controller(self, _mock_cluster_state,
-                                  _mock_serve_controller, monkeypatch):
+    def test_down_serve_controller(self, _mock_cluster_state,
+                                   _mock_serve_controller, monkeypatch):
 
         def mock_get_services_no_service(
                 cls, handle, code, require_outputs, stream_logs,
                 separate_stderr) -> Tuple[int, str, str]:
             return 0, common_utils.encode_payload([]), ''
 
         def mock_get_services_one_service(
```

### Comparing `skypilot_nightly-1.0.0.dev20240504/tests/test_storage.py` & `skypilot_nightly-1.0.0.dev20240505/tests/test_storage.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/tests/test_wheels.py` & `skypilot_nightly-1.0.0.dev20240505/tests/test_wheels.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240504/tests/test_yaml_parser.py` & `skypilot_nightly-1.0.0.dev20240505/tests/test_yaml_parser.py`

 * *Files identical despite different names*

